---
title: laravel 记录
date: 2019-10-16 19:45:15
tags:
---
### Laravel 网站不会被嵌入到其他站点中
```javascript

HTTP 响应头部中，有一个字段，叫做 X-Frame-Options，该字段可以用来指示是否允许自己的网站被嵌入到其他网站的 <iframe> 或者 <object> 标签中。该头部有三个值

DENY - 始终不允许嵌入，即使是同一个域名
SAMEORIGIN - 只能在相同域名中嵌入
ALLOW-FROM uri - 设置允许的域
通常，可以在 HTTP 代理中进行配置，比如 nginx

add_header X-Frame-Options SAMEORIGIN;
Laravel 自带了用来「只允许同域名嵌入」的中间件，我们只需要在 /app/Http/Kernel.php 中添加即可

// /app/Http/Kernel.php
protected $middleware = [
    \Illuminate\Http\Middleware\FrameGuard::class,
];
该中间件的实现如下

<?php

namespace Illuminate\Http\Middleware;

use Closure;

class FrameGuard
{
    /**
     * Handle the given request and get the response.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \Closure  $next
     * @return \Symfony\Component\HttpFoundation\Response
     */
    public function handle($request, Closure $next)
    {
        $response = $next($request);

        $response->headers->set('X-Frame-Options', 'SAMEORIGIN', false);

        return $response;
    }
}
https://learnku.com/articles/35201
https://securityheaders.com/

可以直接扫描特定 URL 是否包含一些安全头信息。类似的头还有 X-Content-Type-Options、 Referrer-Policy、Feature-Policy 等。

```
### Uncaught ReflectionException: Class request does not exist
```javascript
PHP Fatal error:  Uncaught ReflectionException: Class request does not exist in /home/vagrant/learnku/vendor/laravel/framework/src/Illuminate/Container/Container.php:790
Stack trace:
在 App\Exceptions\Handler::report() 方法里，使用：

dd($exception);
```
### Laravel 下 TNTSearch+jieba-PHP 实现中文全文搜索
```javascript
TNTSearch+jieba-php 这套组合可以在不依赖第三方的情况下实现中文全文搜索；
composer require vanry/laravel-scout-tntsearch
'providers' => [
    ...
    /**
     * TNTSearch 全文搜索
     */
    Laravel\Scout\ScoutServiceProvider::class,
    Vanry\Scout\TNTSearchScoutServiceProvider::class,
],
composer require fukuball/jieba-php

php artisan vendor:publish --provider="Laravel\Scout\ScoutServiceProvider"

配置项 config/scout.php 中增加 tntsearch

'tntsearch' => [
    'storage' => storage_path('indexes'), //必须有可写权限
    'fuzziness' => env('TNTSEARCH_FUZZINESS', false),
    'searchBoolean' => env('TNTSEARCH_BOOLEAN', false),
    'asYouType' => false,

    'fuzzy' => [
        'prefix_length' => 2,
        'max_expansions' => 50,
        'distance' => 2,
    ],

    'tokenizer' => [
        'driver' => env('TNTSEARCH_TOKENIZER', 'default'),

        'jieba' => [
            'dict' => 'small',
            //'user_dict' => resource_path('dicts/mydict.txt'), //自定义词典路径
        ],

        'analysis' => [
            'result_type' => 2,
            'unit_word' => true,
            'differ_max' => true,
        ],

        'scws' => [
            'charset' => 'utf-8',
            'dict' => '/usr/local/scws/etc/dict.utf8.xdb',
            'rule' => '/usr/local/scws/etc/rules.utf8.ini',
            'multi' => 1,
            'ignore' => true,
            'duality' => false,
        ],
    ],

    'stopwords' => [
        '的',
        '了',
        '而是',
    ],
],
 env 增加配置项

SCOUT_DRIVER=tntsearch
TNTSEARCH_TOKENIZER=jieba
namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Laravel\Scout\Searchable;

class Article extends Model
{
    use Searchable;

    /**
     * 索引的字段
     *
     * @return array
     */
    public function toSearchableArray()
    {
        return $this->only('id', 'title', 'content');

       // return $this->toArray();
    }
}
生成索引：

php artisan scout:import "App\Model\Article"
https://learnku.com/articles/27617#replies 
```
### 二分查找
```javascript
原理实现：有序集合从中间分为前后2部分，当要查当数值等于中间值，直接返回；当要查询数值大于中间值，则说明要查询的数值在后半部分，那么继续二分后半部分；当要查询数值小于中间数值时，说明要查询的数值在前半部分，那么继续二分前半部分。（过滤掉一半数据查询）

<?php
    /**
     * 递归实现
     * array $arr 有序数组
     * int $search 要查询的数字
     * int firstIndex 数组起始位置
     * int lastIndex 数组结束位置
     * @return 
     */
    function binarySearchRecursion(array $arr, $search, $lastIndex, $firstIndex = 0)
    {
        $len = count($arr);
        if ($len <= 0) {
            return -1;
        }
        $middle = intval(($firstIndex + $lastIndex) / 2);
        if ($search == $arr[$middle]) {//找到直接返回
            return $arr[$middle];
        } elseif ($search > $arr[$middle]) {//去后面查，数组起始位置变为$middle + 1。
            return binarySearchRecursion($arr, $search, $middle + 1, $lastIndex);
        } else {//去前面查，数组结束位置为$middle - 1。
            return binarySearchRecursion($arr, $search, $firstIndex, $middle - 1);
        }
        return -1;
    }

    /**
     * 递归实现
     * array $arr 有序数组
     * int $search 要查询的数字
     * @return 
     */
     function binarySearch($arr, $search)
     {
        $len = count($arr);
        if ($len <= 0 ) {
            return -1;
        }
        $firstIndex = 0;
        $lastIndex = $len - 1;
        while($firstIndex <= $lastIndex) {
            $middle = intval(($firstIndex + $lastIndex) / 2);
            if ($search == $arr[$middle]) {//出口
                return $arr[$middle];
            } elseif ($search > $arr[$middle]) {//去后面查，数组起始位置变为$middle + 1。
                $firstIndex = $middle + 1;
            } else {//去前面查，数组结束位置为$middle - 1。
                $lastIndex = $middle - 1;
            }
        }
        return -1;
     }
     https://learnku.com/articles/35240
```
### 子孙树
```javascript
$arr = [
    ['id'=>1,'parent_id'=>0,'type'=>5],
    ['id'=>2,'parent_id'=>1,'type'=>3],
    ['id'=>3,'parent_id'=>0,'type'=>1],
    ['id'=>4,'parent_id'=>3,'type'=>3],
];
var_dump(getSubTree($arr));

function getSubTree($data, $parent = 'parent_id', $son = 'id', $pid = 0)
    {
        $tmp = [];
        foreach ($data as $key => $value) {
            if ($value[$parent] == $pid) {
                $value['child'] = getSubTree($data, $parent, $son, $value[$son]);
                $tmp[] = $value;
            }
        }
        return $tmp;
    }
    http://www.putyy.com/article/42

```
###  Laravel 的设计哲学
```javascript
class UserController extends Controller
{
    public function index()
    {
        $users = User::all();

        return view('users.index', compact('users'));
    }
}
改为 <?php
   
   namespace App\Repositories;
   
   use App\User;
   
   class DbUserRepository
   {
       public function all(): array
       {
           return User::all()->toArray();
       }
   }
   
   class UserController extends Controller
   {
       private $users;
   
       public function __construct( )
       {
           $this->users = new DbUserRepository;
           // $this->users = new RedisRepository;
       }
   
       public function index()
       {   
           $users = $this->users->all();
           return $users;
       }
   }
   依赖正转的不合理之处在哪里呢？位于高层的控制器依赖于具体的底层数据获取服务，当底层发生变动时，就需要对应的修改高层的内部结构。
   
   我们对依赖关系进一步分析，可知控制器关注的并不是具体如何获取数据，控制器关注的是「数据的可获取性」这一抽象。因此，我们应当将依赖关系进行反转，将对依赖的具体声明职责转移到外部，让控制器仅依赖于抽象层（数据的可获取性）。这种解决方式称之为 控制反转 或 依赖倒置。通过控制反转，高层不再依赖于具体的底层，仅仅是依赖于抽象层，高层和底层实现了解耦。
   用接口来表示「数据的可获取性」这一抽象
   
   <?php
   
   namespace App\Repositories;
   
   interface UserRepositoryInterface
   {
       public function all(): array;
   }
   UserController 依赖的是「数据的可获取性」，不依赖于具体的实现
   
   class UserController extends Controller
   {
       private $users;
   
       public function __construct(UserRepositoryInterface $users)
       {
           $this->users = $users;
       }
   }
   具体的实现交给对应的仓库类即可
   
   class DbUserRepository implements UserRepositoryInterface {}
   class RedisRepository implements UserRepositoryInterface { }
   根据自己的需要注入对应的服务，这样就实现了依赖注入。
   
   $userRepository = new DbUserRepository;
   $userController = new UserController($userRepository)
   总的来说，依赖注入由四部分构成
   
   被使用的服务 - DbUserRepository 或者 RedisRepository 等
   依赖某种服务的客户端 - UserController
   声明客户端如何依赖服务的接口 - UserRepositoryInterface
   依赖注入器，用于决定注入哪项服务给客户端
   
   一个简单的服务容器的实现
   
   namespace App\Services;
   
   use Exception;
   
   class Container 
   {
       protected static $container = [];
   
       /**
        * 绑定服务
        * 
        * @param  服务名称 $name 
        * @param  Callable $resolver
        * @return void
        */
       public static function bind($name, Callable $resolver)
       {   
           static::$container[$name] = $resolver;
       }
   
       /**
        * 解析服务
        * 
        * @param  服务名称 $name
        * @return mix
        */
       public static function make($name)
       {
           if(isset(static::$container[$name])){
               $resolver = static::$container[$name];
               return $resolver();
           }
   
           throw new Exception("不存在该绑定");
      }
   
   }
   绑定服务
   
   App\Services\Container::bind('UserRepository', function(){
       return new App\Repositories\DbUserRepository;
   });
   解析服务
   
   $userRepository = App\Services\Container::make('UserRepository');
   $userController = new UserController($userRepository)
   Laravel 的服务容器的功能则更加的强大，比如，可以将接口与具体的实现进行绑定，通常在 服务提供者 中使用服务容器来进行绑定
   
   public function register()
   {
       $this->app->singleton(UserRepositoryInterface::class, function ($app) {
           return new UserRepository;
       });
   }
   
   
```
### 高并发业务场景下的秒杀解决方案
```javascript

在秒杀前将商品的库存信息加入到 Redis 缓存中。如下格式:
$redis->lpush('商品id',1);
/**
 *
 * 1.接受用户请求
 * 2.验证用户是否已经参与秒杀,商品是否存在
 * 3.根据商品id减少商品队列中的库存数量
 * 4.将用户的秒杀数据写入server层中,并返回秒杀数据对应的唯一key值
 * 5.用户点击下单,根据serve层中的缓存数据,生成订单数据并减少数据库商品的库存数据
 */
$getParams = $_POST;
$userId = $getParams['userId'];
$goodsId = $getParams['goodsId'];

$key = 'goods:miaosha:';
$userResult = $redis->get($key.$userId);
if($userResult){
    $userResult = json_decode($userResult,true);
    echo json_encode(['result'=>$userResult['result'],'key'=>$key.$userId]);// 已经参与过秒杀了
    die();
}else{
    $goodqueue = 'goods:queue:'.$goodsId;
    $result = $redis->lpop($goodqueue);// 删除商品redis队列缓存
    if($result){
        $data = json_encode(['result'=>'OK','userId'=>$userId,'goodsId'=>$goodsId]);
        $redis->set($key.$userId,$data);// 将秒杀信息写入缓存中
        echo json_encode(['result'=>'OK','userId'=>$userId,'goodsId'=>$goodsId,'key'=>$key.$userId]);
        die();
    }else{
        echo json_encode(['result'=>'FAIL','message'=>'商品不存在','goodsId'=>$goodsId]);// 商品库存不存在
        die();
    }
}/**
  * 用户下单界面
  */
 require_once __DIR__.'/redis_connect.php';
 $key = $_GET['key'];
 $data = $redis->get($key);
 /**
  * 生成订单，订单入库
  *
  */https://learnku.com/articles/35141
redis list 可以批量插入数据，不一定每次都只插入一个值.

$numberArr = range(1,100);  
//var_dump($numberArr);
$redis->lPush('goods:queue:5',...$numberArr); // 可变参数  
```
### PHP 开启 Opcache 后如何优雅地部署 PHP 代码
```javascript
提交了代码并且部署了以后，线上代码依然是旧的。所以我执行了下
/etc/init.d/php-fpm reload 就生效了。
opcache_reset (); 但是注意了 这个函数是强制清楚所有 cache 所以 如果并发较高的系统 不能直接这么搞 还有就是 它有两个清除模式，cli 下只能清除 cli 的 cache fpm 的话 必须通过 fpm 请求方式清除才行
https://github.com/gordalina/cachetool
https://learnku.com/laravel/t/35142
```
### 模型::query () 无数据
```javascript
public function getPost()
{
 return Post::query()
}

public function index()
{
   $post = $this->getPost();
    return view('index', [
    'post' => $post
    ]);
}
@foreach($post->where('category_id',2)->get() as xxx){...}
@foreach($post->where('category_id',3)->get() as xxx){...}
改(clone $post)->where(xxxxxxxxx)
https://learnku.com/laravel/t/35341


```
### JSON_encode 小数位丢失
```javascript
$a = '{"orderAmt":500.00}';
$a_json_decode = json_decode($a,true);
[                      
  "orderAmt" => 500.0, 
]                      
$a_json_encode = json_encode($a_json_decode);
"{"orderAmt":500}"
使用字符串类型的 500.00，或使用字符串拼接 JSON 
json_encode($a_json_decode, JSON_PRESERVE_ZERO_FRACTION)
=> "{"orderAmt":500.0}"

https://learnku.com/laravel/t/35311

 从 PHP 5.6.6+ 开始，json_encode 支持使用 JSON_PRESERVE_ZERO_FRACTION 选项以告知引擎确保浮点数始终编码为浮点数，但对于形如 500.00 （值为 500，精确到小数点后两位的浮点数）仅能保证最终输出 500.0
 
 即使临时配置 serialize_precision 为 10，在初始化数组时使用 number_format 函数格式化小数位数，最后在 json_encode 时填入选项 JSON_PRESERVE_ZERO_FRACTION | JSON_NUMERIC_CHECK 也仅能输出 500.0。
 
```
### 支付宝公钥证书 PHP 版本 SDK
```javascript
function getRootCertSN($str)
    {
        // return '687b59193f3f462dd5336e5abf83c5d8_02941eef3187dddf3d3b83462e1dfcf6';
        $arr = preg_split('/(?=-----BEGIN)/', $str, -1, PREG_SPLIT_NO_EMPTY);
        $str = null;
        foreach ($arr as $e) {
            $sn = getCertSN($e, true);
            if (!$sn) {
                continue;
            }
            if ($str === null) {
                $str = $sn;
            } else {
                $str .= "_" . $sn;
            }
        }
        return $str;
    }

    function getCertSN($str, $matchAlgo = false)
    {
        /*
        根据java SDK源码：AntCertificationUtil::getRootCertSN
        对证书链中RSA的项目进行过滤（猜测是gm国密算法java抛错搞不定，故意略去）
        java源码为：

        if(c.getSigAlgOID().startsWith("1.2.840.113549.1.1"))

        根据 https://www.alvestrand.no/objectid/1.2.840.113549.1.1.html
        该OID为RSA算法系。
         */
        if ($matchAlgo) {
            openssl_x509_export($str, $out, false);
            if (!preg_match('/Signature Algorithm:.*?RSA/im', $out, $m)) {
                return;
            }

        }
        $a = openssl_x509_parse($str);
        $issuer = null;
        // 注意：根据java代码输出，需要倒着排列 CN,OU,O
        foreach ($a["issuer"] as $k => $v) {
            if ($issuer === null) {
                $issuer = "$k=$v";
            } else {
                $issuer = "$k=$v," . $issuer;
            }
        }
        #    echo($issuer . $a["serialNumber"] . "\n");
        $serialNumberHex = decimalNotation($a['serialNumberHex']);
        $sn = md5($issuer . $serialNumberHex);
        return $sn;
    }

    function decimalNotation($hex)
    {
        $dec = 0;
        $len = strlen($hex);
        for ($i = 1; $i <= $len; $i++) {
            $dec = bcadd($dec, bcmul(strval(hexdec($hex[$i - 1])), bcpow('16', strval($len - $i))));
        }
        return $dec;
    }
https://learnku.com/articles/35315
```
### 字符串表达式计算
```javascript
$a = 10;
var_dump(eval('return $a > 5;'));

// 输出:
// bool(true)
system('php -r "echo 1 + 2;"');

echo exec('php -r "echo 1 + 2;"');
https://shockerli.net/post/php-expression-string/
```
### 用户登录密码改为 md5
```javascript
新建一个文件 Libraries，在 Libraries 目录下新建一个 MD5.php 文件

namespace App\Libraries; 

use Illuminate\Contracts\Hashing\Hasher; 

class MD5 implements Hasher 
{ 
    /** 
     * Hash the given value. 
     * 
     * @param string $value 
     * 
     * @return array  $options 
     * @return string 
     */ 
    public function make($value, array $options = []) 
    { 
        return md5($value); 
    } 

    /** 
     * Check the given plain value against a hash. 
     * 
     * @param string $value 
     * @param string $hashedValue 
     * @param array $options 
     * 
     * @return bool 
     */ 
    public function check($value, $hashedValue, array $options = []) 
    { 
        if(empty($hashedValue)){ 
            return true; 
        } 
        return $this->make($value) === $hashedValue; 
    } 

    /** 
     * Check if the given hash has been hashed using the given options. 
     * 
     * @param string $hashedValue 
     * @param array $options 
     * 
     * @return bool 
     */ 
    public function needsRehash($hashedValue, array $options = []) 
    { 
        return false; 
    } 
} 
 Providers 文件下面新建一个文件 MD5ServiceProvider.php
 namespace App\Providers; 
 
 use Illuminate\Auth\EloquentUserProvider; 
 class MD5ServiceProvider extends EloquentUserProvider 
 { 
 
     //继承EloquentUserProvider类，调用父类的构造函数 
     public function __construct($hasher, $model) 
     { 
         parent::__construct($hasher, $model); 
     } 
 
     /** 
      * Bootstrap the application services. 
      * 
      * @return void 
      */ 
     public function boot() 
     { 
         // 
     } 
 
     /** 
      * Register the application services. 
      * 
      * @return void 
      */ 
     public function register() 
     { 
         // 
     } 
 } 
  AuthServiceProvider.php 文件里 boot 方法里添加如下代码
 
         Auth::provider('MD5', function ($app) { 
             $model = config('auth.providers.users.model'); 
             return new MD5ServiceProvider(new MD5, $model); 
         }); 
修改 config/auth.php 里的 providers
'providers' => [
        'users' => [
            'driver' => 'MD5',//'driver' => 'eloquent',//eloquent默认加密码方式
            'model' => App\User::class,
        ],
        'admins' => [
            'driver' => 'eloquent',
            'model' => App\Admin::class,
        ],
        修改 app/Http/Controllers/Auth/RegisterController.php 里的 create，修改代码如下
        
            protected function create(array $data)
            {
                return User::create([
                    'name' => $data['name'],
                    'email' => $data['email'],
                    'password' => md5($data['password']),
                ]);
            }
            https://learnku.com/articles/35407
```
### Laravel跨库跨连接的事务操作
```javascript
Laravel 下的跨库事务操作是基于连接的 当执行 DB::beginTransaction(); 的时候 其实是和默认的数据库配置建立了连接 后面的操作 commit 或者 rollback 都是操作的这个默认数据库 如果在这中间操作了其他的数据库 对他是不生效的
同时 commit 和 rollback 都 指定连接
try {
    //开启默认数据库的事务
    DB::beginTransaction();
    //开启test数据库的事务
    DB::connection('test')->beginTransaction();
    //中间各种数据库操作
    Table1::xxxxxx();
    Table2::xxxxxx();
    if (true) {
        //一起提交
        DB::commit();
        DB::connection('test')->commit();
    } else {
        //一起回滚
        DB::rollback();
        DB::connection('test')->rollback();
    }
} catch (\Exception $exception) {
    echo "catch some errors:".$exception->getMessage();
}
https://caihongtengxu.github.io/2018/20181009/index.html
```
### array_splice无法自定义键值
```javascript
function array_insert (&$array, $position, $insert_array) {
            $first_array = array_splice ($array, 0, $position);
            $array = array_merge ($first_array, $insert_array, $array);
        }


        $arr = array(
            'tt' => 1333,
            'cc' => 333,
            'aaz' => 2333,
            'ee' => 78,
        );
        $temp["bb"] = 33;
        array_insert($arr,1,$temp);
>>> $arr
=> [
     "tt" => 1333,
     "bb" => 33,
     "cc" => 333,
     "aaz" => 2333,
     "ee" => 78,
   ]
```
### 数字转度量
```javascript
/**
 * 数字转度量
 *
 * @param int $num 数字
 * @return string|int
 */
function num2metric($num, $precision = 0) {
    $unitList = [
        'P' => 15,
        'T' => 12,
        'G' => 9,
        'M' => 6,
        'W' => 4,
        'K' => 3,
    ];

    $num = (int) $num;

    foreach($unitList as $name => $pow) {
        $size = pow(10, $pow);

        if($num >= $size) {
            return round($num / $size * 100, $precision) / 100 . $name;
        }
    }

    return $num;
}
https://www.hongfs.cn/2018/10/php/php-metric-prefix/
num2metric(1000) // 1K
num2metric('10000') // 1W
num2metric('A') // 0

```
### 获取两个坐标之间距离
```javascript
/**
 * 获取两个坐标之间距离
 *
 * @param int|float $lat1 第一个坐标纬度
 * @param int|float $lon1 第一个坐标经度
 * @param int|float $lat2 第一个坐标纬度
 * @param int|float $lon2 第二个坐标经度
 * @param string $unit 距离单位 M 法定英里 K 公里 N 海里
 * @return int|float
 */
function getDistanceBetweenPoints($lat1, $lon1, $lat2, $lon2, $unit = 'K') {
    if (($lat1 == $lat2) && ($lon1 == $lon2)) {
        return 0;
    }

    $theta = $lon1 - $lon2;
    $dist = sin(deg2rad($lat1)) * sin(deg2rad($lat2)) +  cos(deg2rad($lat1)) * cos(deg2rad($lat2)) * cos(deg2rad($theta));
    $dist = acos($dist);
    $dist = rad2deg($dist);
    $miles = $dist * 60 * 1.1515;
    $unit = strtoupper($unit);

    if ($unit === 'K') {
        return $miles * 1.609344;
    } else if ($unit === 'N') {
        return $miles * 0.8684;
    } else {
        return $miles;
    }
}https://www.hongfs.cn/2019/06/php/php-get-distance-between-points/
getDistanceBetweenPoints(113.276885, 23.090654, 113.320331, 23.096197);
// PHP: 4.8368890520256 公里
// 高德地图: 4491 米
//restapi.amap.com/v3/distance？key-您的key&origins=113.276885，23.090654&destination=113.320331，23.096197&type=e
```
### Laravel 上传图片
```javascript
/**
 * 后缀名验证
 *
 * @param  string  $extension  后缀名
 * @return bool
 */
protected function has_extension(string $extension)
{
    return in_array($extension, ['jpg', 'jpeg', 'png', 'gif', 'bmp']);
}

/**
 * 图片上传
 *
 * @param  \Illuminate\Http\Request  $request
 * @return \Illuminate\Http\Response
 */
public function index(Request $request)
{
    // 获取上传键值
    $name = $request->input('name', 'file');

    if($request->hasFile($name)) {
        // 文件格式上传

        $file = $request->file($name);
        $extension = $file->extension();

        if(!$this->has_extension($extension)) {
            return '格式错误';
        }

        $filename = $file->store();
    } else if(preg_match('/^(data:\s*image\/(\w+);base64,)/', $request->input($name), $matches)) {
        // base64 上传

        $extension = $matches[2];

        if(!$this->has_extension($extension)) {
            return '格式错误';
        }

        $file = $request->input($name);
        $file = preg_replace('/^(data:\s*image\/(\w+);base64,)/', '', $file);
        $file = str_replace(' ', '+', $file);

        // 生成保存文件名
        $filename = str_random(40) . '.' . $extension;
        Storage::put($filename, base64_decode($file));
    } else {
        return '格式错误';
    }
    
    return '上传成功[' . $filename . ']';
}https://www.hongfs.cn/2019/06/php/laravel/laravel-upload-image/

```
### 拼音排序
```javascript
$ composer require "overtrue/pinyin:~4.0"
 /**
     * 地区列表 - 拼音排序
     *
     * @return \Illuminate\Http\Response
     */
    public function list()
    {
        $list_tmp = DB::table('area')
                        ->select('code', 'name')
                        ->orderBy(DB::raw('convert(name using gbk)'))
                        ->get();

        $pinyin = new Pinyin();

        $list = [];

        $list_tmp->map(function($item) use(&$list, $pinyin) {
            // 去除城市名最后面的市字
            // if(substr($item->name, -3) === '市') {
            //     $item->name = substr($item->name, 0, -3);
            // }

            // 获取城市名第一个字
            $name_first = substr($item->name, 0, 3);

            // 获取拼音
            $name_pinyin = $pinyin->convert($name_first)[0];

            // 获取第一个字母并且转换为大写
            $name_pinyin = strtoupper(substr($name_pinyin, 0, 1));

            if(!isset($list[$name_pinyin])) {
                $list[$name_pinyin] = [];
            }

            $list[$name_pinyin][] = (array) $item;
        });
        {
            "code": 1,
            "data": {
                "G": [
                    {
                        "code": 5108,
                        "name": "广元市"
                    },
                    {
                        "code": 4401,
                        "name": "广州市"
                    }
                ],
                "S": [
                    {
                        "code": 4403,
                        "name": "深圳市"
                    }
                ]
            }
        }
https://www.hongfs.cn/2019/09/php/laravel/laravel-area-list-pinyin-sort/
```
### PHP读取微信客户端数据库
```javascript
  class MyDB extends SQLite3
   {
      function __construct()
      {
      //根据sqlite提供的open接口，输入密钥key，
      //$this->open('EnMicroMsg.db',SQLITE3_OPEN_READWRITE,'71ca1d4');
         $this->open('test.db');//test.db存在就链接，不存在就创建
      }
   }
   $db = new MyDB();
   if(!$db){
      echo $db->lastErrorMsg();
   } else {
      echo "Opened database successfully\n";
   }

   $sql =<<<EOF
      SELECT * from COMPANY;
EOF;

   $ret = $db->query($sql);
   while($row = $ret->fetchArray(SQLITE3_ASSOC) ){
      echo "ID = ". $row['ID'] . "\n";
      echo "NAME = ". $row['NAME'] ."\n";
      echo "ADDRESS = ". $row['ADDRESS'] ."\n";
      echo "SALARY =  ".$row['SALARY'] ."\n\n";
   }
   echo "Operation done successfully\n";
   $db->close();
https://learnku.com/laravel/t/35478
```

[附近的店铺](https://learnku.com/laravel/t/35561)

[高性能的定时调度服务Forsun的Laravel组件](https://github.com/snower/forsun-laravel)

[Laravel 查询附近的数据](https://www.hongfs.cn/2019/06/php/laravel/laravel-query-nearby-data/)

[elasticsearch中文发行版](https://github.com/medcl/elasticsearch-rtf)

[多级联动](https://www.hongfs.cn/2018/12/php/laravel/laravel-multi-level-linkage/)

[Laravel 下 Elasticsearch/Algolia 全文搜索](https://learnku.com/articles/30812)

[Phpstorm 开启 Laravel 代码提示](https://learnku.com/articles/35377)

[PHP 最优秀资源的整理汇集](https://github.com/shockerli/php-awesome)

[腾讯地图搜索](https://learnku.com/articles/35348)

[Laravel 框架 5.1 升级到 5.5](https://learnku.com/articles/34959)

[Laravel Authorization：支持 ACL、RBAC、ABAC 等模型的授权库](https://learnku.com/articles/35101)

[PSR-12 编码规范扩充](https://learnku.com/laravel/t/35080)

[Laravel 下 Elasticsearch/Algolia 全文搜索 使用案例](https://learnku.com/articles/30812)

 [轻量级全文检索引擎 TNTSearch 和中文分词](https://learnku.com/articles/6207/lightweight-full-text-retrieval-engine-tntsearch-and-chinese-word-segmentation)

[laravel下TNTSearch+jieba-php实现中文全文搜索](https://baijunyao.com/article/154)

[postman使用记录](http://www.putyy.com/article/32)

[免费开源的在线文档管理插件](https://github.com/jianyan74/rageframe2)

[诗词博客](https://gitee.com/leiyong3/laravel_blog)

[Elasticsearch 国内镜像下载站](https://thans.cn/mirror/elasticsearch.html)

[PHP抖音机器人](https://github.com/ChinaBygones/PHP-DouyinRobot)