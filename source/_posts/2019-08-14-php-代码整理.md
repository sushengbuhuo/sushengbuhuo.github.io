---
title: php 代码整理
date: 2019-08-14 20:41:02
tags:
---
### 不需要递归
```javascript
$items = array(
    1 => array ('id' => 1, 'pid' => 0, 'name' => ' 江西省 '),
    2 => array ('id' => 2, 'pid' => 0, 'name' => ' 黑龙江省 '),
    3 => array ('id' => 3, 'pid' => 1, 'name' => ' 南昌市 '),
    4 => array ('id' => 4, 'pid' => 2, 'name' => ' 哈尔滨市 '),
    5 => array ('id' => 5, 'pid' => 2, 'name' => ' 鸡西市 '),
    6 => array ('id' => 6, 'pid' => 4, 'name' => ' 香坊区 '),
    7 => array ('id' => 7, 'pid' => 4, 'name' => ' 南岗区 '),
    8 => array ('id' => 8, 'pid' => 6, 'name' => ' 和兴路 '),
    9 => array ('id' => 9, 'pid' => 7, 'name' => ' 西大直街 '),
    10 => array ('id' => 10, 'pid' => 8, 'name' => ' 东北林业大学 '),
    11 => array ('id' => 11, 'pid' => 9, 'name' => ' 哈尔滨工业大学 '),
    12 => array ('id' => 12, 'pid' => 8, 'name' => ' 哈尔滨师范大学 '),
    13 => array ('id' => 13, 'pid' => 1, 'name' => ' 赣州市 '),
    14 => array ('id' => 14, 'pid' => 13, 'name' => ' 赣县 '),
    15 => array ('id' => 15, 'pid' => 13, 'name' => ' 于都县 '),
    16 => array ('id' => 16, 'pid' => 14, 'name' => ' 茅店镇 '),
    17 => array ('id' => 17, 'pid' => 14, 'name' => ' 大田乡 '),
    18 => array ('id' => 18, 'pid' => 16, 'name' => ' 义源村 '),
    19 => array ('id' => 19, 'pid' => 16, 'name' => ' 上坝村 '),
);
function genTree($items) {
    $tree = array (); // 格式化好的树
    foreach ($items as $item)
        if (isset($items[$item['pid']]))
            $items[$item['pid']]['son'][] = &$items[$item['id']];
        else
            $tree[] = &$items[$item['id']];
    return $tree;
}

```
### 插入排序算法
```javascript
class Person
{
    public $id;
    public $data;
}
//https://learnku.com/articles/32586
function insertSort(&$data,$n)
{
    for ($i=1;$i<$n;$i++){
        if ($data[$i]->id<$data[$i-1]->id){
            $j = $i-1;
            $x = $data[$i]->id;
            $obj = $data[$i];
            while($j>-1&&$x<@$data[$j]->id){
                $data[$j+1] = $data[$j];
                $j--;

            }
            $data[$j+1] = $obj;
        }
    }
}
(function(){

    $person = new Person();
    $index = ['23'=>'勺颠颠','65'=>'老油条','21'=>'烧包谷','9'=>'烧耳块','4'=>'肥嘟嘟','7'=>'霉戳戳','32'=>'一坨肉','6'=>'老扎哇'];
    $data = [];
    foreach ($index as $k=>$v){
        $obj = clone $person;
        $obj->id = $k;
        $obj->data = $v;
        $data[] = $obj;
    }
    insertSort($data,8);

    print_r($data);

})();

```
### 分表
```javascript
namespace App\Models;

use DB;
use Schema;
use Illuminate\Database\Eloquent\Model;

class Logs extends Model
{
    protected $guarded = ['id'];
    protected $table;

    public function __construct(array $attributes = [])
    {
        parent::__construct($attributes);
        $this->table = 'log_'.date('Y');
        if (!Schema::hasTable($this->table))
        {
            DB::update('create table '.$this->table.' like logs');
        }
    }
}
Logs::where('uid','')->first();

```

### sentry 升级
```javascript
server {
    listen       80;
    server_name  track.example.com;

    set_real_ip_from 127.0.0.1;
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    location / {
        // 添加这两行
        default_type text/html; // 设置 content-type 表示这是一个网页
        return 202; # 返回 202 表示已经接收，但是并不处理
        client_max_body_size    100M;
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header Host-Real-IP  $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-Pcol http;
        proxy_pass http://localhost:10000;
    }
}
使用这两行，就可以保证客户端正常请求了数据，但是我却把它给抛弃了。保证客户端的正常浏览。
cd /data/
cp -r onpremise onpremise2
cd onpremise
docker-compose down
git pull
git diff docker-compose.yml
git checkout docker-compose.yml
git pull
export SENTRY_IMAGE='sentry:9.1.2'
docker-compose build --pull
docker-compose run --rm web upgrade

docker-compose up -d
https://learnku.com/articles/32569

```
### 基于雪花算法的 PHP ID 生成器
```javascript
https://github.com/godruoyi/php-snowflake
$ composer require godruoyi/php-snowflake -vvv
$snowflake = new \Godruoyi\Snowflake\Snowflake;

$snowflake->id();
// 1537200202186752
$snowflake = new \Godruoyi\Snowflake\Snowflake($datacenterId, $workerId);

$snowflake->id();
$snowflake = new \Godruoyi\Snowflake\Snowflake;
$snowflake->setStartTimeStamp(strtotime('2019-09-09')*1000);

$snowflake->id();
集合laravel
// App\Providers\AppServiceProvider

use Godruoyi\Snowflake\Snowflake;
use Godruoyi\Snowflake\LaravelSequenceResolver;

class AppServiceProvider extends ServiceProvider
{
    /**
     * Register any application services.
     *
     * @return void
     */
    public function register()
    {
        $this->app->singleton('snowflake', function () {
            return (new Snowflake())
                ->setStartTimeStamp(strtotime('2019-08-08')*1000)
                ->setSequenceResolver(new LaravelSequenceResolver(
                    $this->app->get('cache')->store()
                ));
        });
    }
}
$snowflake = new \Godruoyi\Snowflake\Snowflake;
$snowflake->setSequenceResolver(function ($currentTime) {
    static $lastTime;
    static $sequence;

    if ($lastTime == $currentTime) {
        ++$sequence;
    }

    $lastTime = $currentTime;

    return $sequence;
})->id();
https://learnku.com/articles/32575
```
### 内置web服务器
```javascript

php -S localhost:8000 -t public/
cd /home/baoguoxiao/www/php/demo
php -S localhost:8000 router.php
router.php 文件的代码

/**
 * 对URL进行解析，并获取请求的文件名
 */
$uri = urldecode(parse_url($_SERVER["REQUEST_URI"], PHP_URL_PATH));

/**
 * 判断是否存在该文件，如果不存在，则直接继续加载入口文件
 */
if ($uri !== "/" && file_exists(__DIR__ . "$uri")) {
    return false;
}

/**
 * 加载入口文件
 */
require_once "./index.php";
vendor/laravel/framework/src/Illuminate/Foundation/Console/ServeCommand.php

/**
 * 执行命令.
 *
 * @return int
 *
 * @throws \Exception
 */
public function handle()
{
    // 切换路径到 public 目录
    chdir(public_path());

    // 在命令台进行输出相关内容
    $this->line("<info>Laravel development server started:</info> <http://{$this->host()}:{$this->port()}>");

    // 执行外部程序，并且 $status 为系统的返回状态
    passthru($this->serverCommand(), $status);

    // $status 为0 表示执行正常, 为其他大于0的数字表示出现了错误，有可能是端口被抢占了，这个时候就会接着判断是否进行再次尝试
    if ($status && $this->canTryAnotherPort()) {
        // 对绑定的端口号加1 默认是8000, 如果失败则重试端口号为8001，再次失败重试端口号为8002，以此类推。
        $this->portOffset += 1;
        // 再次调用此程序
        return $this->handle();
    }
    // 返回状态值
    return $status;
}

/**
 * 获取完整的 server 命令.
 *
 * @return string
 */
protected function serverCommand()
{
    return sprintf('%s -S %s:%s %s',
        
        // 获取PHP可执行命令的路径
        ProcessUtils::escapeArgument((new PhpExecutableFinder)->find(false)),
        
        // 获取需要绑定的host
        $this->host(),

        // 获取需要绑定的端口
        $this->port(),

        // 对需要执行的参数进行转义处理。这里的 server 就是我们之前说的路由文件，它在项目的根路径下
        ProcessUtils::escapeArgument(base_path('server.php'))
    );
}
对上面的命令进行翻译一下，实际上就是执行的

cd ./public
php -S 0.0.0.0:8000 ../server.php
note:

这里我们可以看到一个区别就是之前我自己写的代码，host 都是 localhost, 但是这里写的是 0.0.0.0。这两个有什么区别呢？

其实区别很简单，比如我之前写的 localhost 绑定的ip 是 127.0.0.1, 这个相当于一个回环地址，那么我们就只允许本机的IP进行访问。而 0.0.0.0，则表示我们对ip不进行限制，所有的IP都可以进行访问。
那我们接着再来看看项目根目录下面的server.php:

/**
 * Laravel - A PHP Framework For Web Artisans
 *
 * @package  Laravel
 * @author   Taylor Otwell <taylor@laravel.com>
 */

$uri = urldecode(
    parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH)
);

// 这个文件允许我们从内置 PHP web 服务器中模拟 Apache 的 "mod_rewrite" 功能.
// 这提供了一种测试 Laravel 应用程序的便捷方法,
// 而无需在此安装"真正的" web 服务器软件。
if ($uri !== '/' && file_exists(__DIR__.'/public'.$uri)) {
    return false;
}

require_once __DIR__.'/public/index.php';
https://github.com/mowangjuanzi/blog/blob/master/posts/2019.05.18-php_built_in_web_server.md
```

### 响应宏
```javascript
在任意一个ServiceProvider的boot方法里（ResponseMacroServiceProvider），使用Response Facade注册


Response::macro('success', function ($data = [], $message = 'success') {
    return new JsonResponse([
        'code' => 0,
        'data' => $data,
        'message' => $message
    ], 200);
});

接下来， 你可以再任何地方使用它response()。

//UserController.php

public function users(UserRepository $userRepository)
{
    return response()->success($userRepository->all(), 'success');
}

注意，你只能通过response()这个全局方法或是app('Illuminate\Routing\ResponseFactory')来使用它

response()->success();//OK
app('Illuminate\Routing\ResponseFactory')->success();//OK

//Response Facade
Response::success();//ok

(new \Illuminate\Http\Response)->success();//Error
https://godruoyi.com/posts/laravel-response-macro-principle
```
### Intervention Image 合成图片
```javascript
use Intervention\Image\ImageManager;

$manager = new ImageManager(array('driver' => 'imagick'));
use Intervention\Image\Facades\Image;

//或
$manager = app('image');
// $image = $manager->make($bg);
// $image = Image::make($bg);

$image = app('image')->make($bg);

// 二维码图片
$qrcodeImage = app('image')->make($qrcodeurl)->resize(200, 200);
// 重置 头像 大小
$avatarImage  = app('image')->make($httpClient->request('GET', $avatarurl)->getBody())->resize(200, 200);

$image->text('Nickname', 376, 320, function ($font) {
    $font->file(public_path('fonts/SimHei.ttf'));
    $font->size(40);
    $font->color('#000000');
    $font->align('center');
    $font->valign('top');
});

$image->insert($qrcodeImage, 'bottom', 0, 360);
$image->insert($avatarImage, 'top', 0, 105);
中文字体文件https://github.com/StellarCN/scp_zh/tree/master/fonts
```
### nginx 配置多域名
```javascript
这个是精确匹配问题：

nginx server_name 匹配不到时，默认取第一个 server { } (端口和 ip 一致)

你项目中配置:

1. server_name www.test.com
2. server_name www.mytest.com
访问 test.com/mytest.com 都找不到对应的 server_name (www.test.com != test.com , www.mytest.com != mytest.com)，所以就取第一个 server { } 匹配，所以均输出 test

server_name mytest.com *.mytest.com

https://learnku.com/laravel/t/32300
```
### 插入折半排序
```javascript
class Person
{
    public $id;
    public $data;
}

function insertSort(&$data,$n)
{
    for ($i=1;$i<$n;$i++){
        $low = 0;
        $high = $i-1;
        $temp = $data[$i];
        while ($low<=$high){
            $mid = floor(($low+$high)/2);
            if ($data[$mid]->id>$temp->id){
                $high = $mid-1;
            }else{
                $low = $mid+1;
            }
        }
        for ($j=$i;$j>$low;$j--){
            $data[$j] = $data[$j-1];
        }
        $data[$low] = $temp;
    }
}
(function(){

    $person = new Person();
    $index = ['23'=>'勺颠颠','65'=>'老油条','21'=>'烧包谷','9'=>'烧耳块','4'=>'肥嘟嘟','7'=>'霉戳戳','32'=>'一坨肉','6'=>'老扎哇'];
    $data = [];
    foreach ($index as $k=>$v){
        $obj = clone $person;
        $obj->id = $k;
        $obj->data = $v;
        $data[] = $obj;
    }

    insertSort($data,8);
    print_r($data);

})(); 
https://learnku.com/articles/32691
```
### sql拼接
```javascript
$statusInStr = implode(',', '1,2,3');
字符串
$statusInStr = "'".implode("','", [1,2,3])."'";//'1','2','3'
"select * from table where status in ({$statusInStr})"//select * from table where status in ('1','2','3')
```
[复杂度分享](https://learnku.com/articles/32416)

[Laravel-admin 源码分析系列](https://learnku.com/articles/32025)

[Laravel 如何实现数据的软删除](https://learnku.com/articles/32699)