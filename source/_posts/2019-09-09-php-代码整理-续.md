---
title: php 代码整理(续)
date: 2019-09-09 19:37:31
tags:
---

### Excel 导入导出工具
```javascript
composer require phpoffice/phpspreadsheet
require 'vendor/autoload.php';

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;

$spreadsheet = new Spreadsheet();
$sheet = $spreadsheet->getActiveSheet();
$sheet->setCellValue('A1', 'Hello World !');

$writer = new Xlsx($spreadsheet);
$writer->save('hello world.xlsx');
https://learnku.com/laravel/t/33677
```
### FFmpeg 截取视频中多个图片,然后拼成一张图

```javascript
 //获取文件路径
   fwrite(STDOUT, "哪个视频文件:");
   $video_path = trim(fgets(STDIN));

   fwrite(STDOUT, "多少秒截取1张图:");
   $s = trim(fgets(STDIN));

   //设置输出路径
   fwrite(STDOUT, "输出到哪里:");
   $export_path = trim(fgets(STDIN));

   $command = system('ffmpeg -y -i '.$video_path.' -vf "fps=1/'.$s.',scale=iw/4:-1,tile=2x2" -an '.$export_path.'_%d.png'); 
https://learnku.com/laravel/t/33066
   // fps = 1/2 每2秒截一张图,如果是每秒截一张 参数就是 fps=1
   // scale 截图大小,上面的代码是设置宽为原始的1/4大小,高度自动,也可以设置成固定值如:120:80
   // tile 网格化,自动将100张图合并成一张大图
   截图会输出很多张大图，这不是我想要的，我只想从视频中提取 4 张图片，然后拼接成一张大图怎么操作；
    获得视频总时长然后除以 4 就好了 (如果要 6 张图就除以 6)
    代码如下:
    $duration = system('ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 -i '.$video_path.'');
    $s = $duration/4;
    $command = system('ffmpeg -y -i '.$videopath.' -vf "fps=1/'.$s.',scale=iw/4:-1,tile=2x2" -an 1%d.png');

```
### MySQL 事务最全详解
```javascript
// 我们先查看表中的数据,id为1的age字段是12
mysql root@127.0.0.1:test> select * from user;
+----+------+-----+
| id | name | age |
+----+------+-----+
| 1 | 张三 | 12 |
| 2 | 李四 | 15 |
+----+------+-----+
2 rows in set
Time: 0.013s
// 开启事务
mysql root@127.0.0.1:test> begin;
Query OK, 0 rows affected
Time: 0.001s
// 将id为1的age字段改为10
mysql root@127.0.0.1:test> update user set age=10 where id=1;
Query OK, 1 row affected
Time: 0.001s
// 再次查询数据时,发现数据改为修改后的值
mysql root@127.0.0.1:test> select * from user;
+----+------+-----+
| id | name | age |
+----+------+-----+
| 1 | 张三 | 10 |
| 2 | 李四 | 15 |
+----+------+-----+
2 rows in set
Time: 0.012s
// 此时我们进行回滚操作
mysql root@127.0.0.1:test> rollback;
Query OK, 0 rows affected
Time: 0.001s
// 再次查询发现数据回到最初状态
mysql root@127.0.0.1:test> select * from user;
+----+------+-----+
| id | name | age |
+----+------+-----+
| 1 | 张三 | 12 |
| 2 | 李四 | 15 |
+----+------+-----+
2 rows in set
Time: 0.019s
// 我们再次对数据进行修改
mysql root@127.0.0.1:test> update user set age=15 where id=1;
Query OK, 1 row affected
Time: 0.001s
// 此时将事务进行提交
mysql root@127.0.0.1:test> commit;
Query OK, 0 rows affected
Time: 0.000s
// 发现此时的数据变为我们最终提交的值
mysql root@127.0.0.1:test> select * from user;
+----+------+-----+
| id | name | age |
+----+------+-----+
| 1 | 张三 | 15 |
| 2 | 李四 | 15 |
+----+------+-----+
2 rows in set
Time: 0.012s
// 我们尝试用刚才回滚的方式进行还原数据
mysql root@127.0.0.1:test> rollback;
Query OK, 0 rows affected
Time: 0.000s
// 发现数据无法回退了,仍然是提交后的数据
mysql root@127.0.0.1:test> select * from user;
+----+------+-----+
| id | name | age |
+----+------+-----+
| 1 | 张三 | 15 |
| 2 | 李四 | 15 |
+----+------+-----+
2 rows in set
Time: 0.017s
PHP 实现事务实例代码

<?php
// 连接MySQL
$mysqli = new mysqli('127.0.0.1', 'root', '123456', 'test', 3306);
// 关闭事务自动提交
$mysqli->autocommit(false);
// 1.开启事务
$mysqli->begin_transaction();
// 2.修改数据
$mysqli->query("update user set age=10 where id=1");
// 3.查看数据
$mysqli->query("select * from user");
// 4.事务回滚
$mysqli->rollback();
// 5.查看数据
$mysqli->query("select * from user");
// 7.修改数据
$mysqli->query("update user set age=15 where id=1");
// 8.事务提交
$mysqli->commit();
// 9.事务回滚
$mysqli->rollback();
// 10.查看数据
$mysqli->query("select * from user");
如何设置事务的隔离级别
// 查看当前的事务隔离级别
mysql root@127.0.0.1:test> select @@tx_isolation;
+-----------------+
| @@tx_isolation |
+-----------------+
| REPEATABLE-READ |
+-----------------+
1 row in set
Time: 0.015s
// 设置隔离级别
set session transaction isolation level 隔离级别(上面事务隔离级别中的英文单词);
https://learnku.com/articles/33749

```
### 二进制转图片
```javascript
<?php
/**
 * Created by 独自等待
 * Date: 2014/11/12
 * Time: 10:10
 * Name: decode.php
 * 独自等待博客：https://www.waitalone.cn/11-game.html
 */
 $bin = <<<binary
01001000 00110100 01110011 01001001 01000001 01000011 01001010 01001011 #第1行
#为阅读方便，把第1行和最后1行之间的省略了，大家测试的时候请把二进制代码放到这里
01001010 01000001 01000001 01101111 01000001 01000001 01000001 00111101 #最后1行
binary;
$bin_arr = explode(' ',str_replace("\r\n"," ",$bin));
#print_r($bin_arr);
$dec = '';
foreach ($bin_arr as $bin_code) {
    $dec .= chr(bindec($bin_code));
}
echo $dec;
fwrite(fopen('key.tar.gz','wb'),base64_decode($dec));

chr(bindec('01110011'))//s
import base64
bin = '''
01001000 00110100 01110011 01001001 01000001 01000011 01001010 01001011 #第1行
#为阅读方便，把第1行和最后1行之间的省略了，大家测试的时候请把二进制代码放到这里
01001010 01000001 01000001 01101111 01000001 01000001 01000001 00111101 #最后1行
'''
binTochar = [chr(int(x, 2)) for x in bin.strip().split()]
print ''.join(binTochar)
keyFile = open('key.tar.gz', 'wb')
keyFile.write(base64.b64decode(''.join(binTochar)))
keyFile.close()
```
### windos 安装 Laravel/horizon 
```javascript
composer.json 中增加以下两个字段："platform": { "ext-pcntl": "7.2", "ext-posix": "7.2"}，增加至 config 字段中，再次运行安装命令即可～

```
### 回调函数
```javascript
$array = [1, 2, 3, 4];
$str = array_reduce($array, function ($return_str, $value) {
    $return_str = $return_str . $value;  //层层迭代
    return $return_str;
});
// 一个基本的购物车，包括一些已经添加的商品和每种商品的数量。
// 其中有一个方法用来计算购物车中所有商品的总价格，该方法使
// 用了一个 closure 作为回调函数。
class Cart
{
    const PRICE_BUTTER  = 1.00;
    const PRICE_MILK    = 3.00;
    const PRICE_EGGS    = 6.95;

    protected   $products = array();

    public function add($product, $quantity)
    {
        $this->products[$product] = $quantity;
    }

    public function getQuantity($product)
    {
        return isset($this->products[$product]) ? $this->products[$product] :
               FALSE;
    }

    public function getTotal($tax)
    {
        $total = 0.00;

        $callback =
            function ($quantity, $product) use ($tax, &$total)
            {
                //定义一个回调函数 取出 当前商品的价格
                $pricePerItem = constant(__CLASS__ . "::PRICE_" .
                    strtoupper($product));
                $total += ($pricePerItem * $quantity) * ($tax + 1.0);
            };

        array_walk($this->products, $callback);
        return round($total, 2);;
    }
}

$my_cart = new Cart;

// 往购物车里添加条目
$my_cart->add('butter', 1);
$my_cart->add('milk', 3);
$my_cart->add('eggs', 6);

// 打出出总价格，其中有 5% 的销售税.
print $my_cart->getTotal(0.05) . "\n";
// 最后结果是 54.29
https://learnku.com/articles/33848

```
### 并发问题
```javascript
 //正常写法,获取最后一条数据，新的单据编号+1，有并发问题
        $last = Article::orderByDesc('id')->first();
        $data = [
            'code'    => $last->code + 1,
        ];
        $article = Article::create($data);

        //---------------------------------------------------------------------------------//
        //解决并发问题  测试ab -t 6 -c 20 http://study.local/xxx
        DB::beginTransaction();
        $last = Article::lockForUpdate()->orderByDesc('id')->first();
        $data = [
            'code'    => $last->code + 1,
        ];
        $article = Article::create($data);
        DB::commit();
        https://learnku.com/articles/33809
高性能分布式并发锁, 行为限流https://github.com/zhaocong6/lock
```
### intervention/image慢
```javascript
// 记录开始时间
$startTimestamp = microtime(true);

$url = 'http://wx.qlogo.cn/mmopen/XxT9TiaJ1ibf06TNRCMjQADS4opDHvQLguLZHpqkRlvuJYZicvJW4iaOalPsKIs0kpZ3F6864ZzibyObYiaucUQSrdp4pFTNDyIpxw/0';

$avatar = \Image::make($url);

// 记录结束时间
$endTimestamp = microtime(true);

info($startTimestamp);
info($endTimestamp);
info($endTimestamp - $startTimestamp);

$startTimestamp = microtime(true);

$client = new \GuzzleHttp\Client();

$url = 'http://wx.qlogo.cn/mmopen/XxT9TiaJ1ibf06TNRCMjQADS4opDHvQLguLZHpqkRlvuJYZicvJW4iaOalPsKIs0kpZ3F6864ZzibyObYiaucUQSrdp4pFTNDyIpxw/0';

$avatarResponse = $client->get($url);

$avatar = \Image::make($avatarResponse->getBody()->getContents());

$endTimestamp = microtime(true);

info($startTimestamp);
info($endTimestamp);
info($endTimestamp - $startTimestamp);
 https://tianyong90.com/posts/intervention-image-zhong-de-yi-ge-xiao-keng-ji-qi-po-jie-zhi-fa/
在这里我先使用 GuzzleHttp 获取头像，再使用 Image::make($data) 创建头像
```
### laravel5.5 中读写分离
```javascript
明明刚刚写入了数据，但查询时却报 No query result ，而且只是偶然性出现，没啥规律。 在没有启用 sticky 的时候，使用 write 连接写入数据后立即读取，读取时使用的是 read 连接，这样就有可能出问题。将 sticky 设置为 true 后，在与这个写入操作相同的请求周期内的后续读取操作，仍然使用原来的 write 连接，就不会有这麻烦了。

```
### puppeteer 采集异步加载
```javascript
 composer require spatie/browsershot
 npm i puppeteer --save
 use Spatie\Browsershot\Browsershot;
 
 public function getBodyHtml()
 {
     $newsUrl = 'https://m.toutiao.com/i6546884151050502660/';
 
     $html = Browsershot::url($newsUrl)
         ->windowSize(480, 800)
         ->userAgent('Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Mobile Safari/537.36')
         ->mobile()
         ->touch()
         ->bodyHtml();
 
     \Log::info($html);
 }
 
 use Spatie\Browsershot\Browsershot;
 
 public function getBodyHtml()
 {
     $newsUrl = 'https://m.toutiao.com/i6546884151050502660/';
 
     Browsershot::url($newsUrl)
         ->windowSize(480, 800)
         ->userAgent('Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Mobile Safari/537.36')
         ->mobile()
         ->touch()
         ->setDelay(1000)
         ->save(public_path('images/toutiao.jpg'));
 }https://tianyong90.com/posts/laravel-zhong-shi-yong-puppeteer-cai-ji-yi-bu-jia-zai-de-wang-ye-nei-rong/

```
###  session 与 cookie

```javascript
 cookie运行原理

1. 客户端向服务端发起一个 http 请求.

2. 服务端设置一个创建 cookie 的指令，响应给客户端.

3. 客户端收到服务端响应的指令，根据指令在客户端创建一个 cookie.

4. 挡下一次请求时，客户端携带这个 cookie 向服务端发送请求.
session. 运行原理
       
       1. 客户端向服务端发起请求，建立通信
       
       2. 服务端根据设置的 session 创建指令，在服务端创建一个编号为 sessionid 的文件，里面的值就是 session 具体的值 (组成部分 变量名 | 类型 : 长度：值).
       
       3. 服务端将创建好的 sessionid 编号响应给客户端，客户则将该编号存在 cookie 中 (一般我们在浏览器存储的调试栏中会发现 cookie 中有一个 PHPSESSID 的键，这就是 sessionid，当然这个名称，我可以通过设置服务端是可以改变的).
       
       . 当下一次请求时，客户端将这个 sessionid 携带在请求中，发送给服务端，服务端根据这个 sessionid 来做一些业务判断
       
```
###  PHP-Casbin 的 ABAC 权限控制
```javascript
https://github.com/php-casbin/php-casbin
ABAC 的官方实例如下:

[request_definition]
r = sub, obj, act

[policy_definition]
p = sub, obj, act

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = r.sub == r.obj.owner
这是 r.obj 类的定义:

$data1 = new \stdClass();
$data1->name = 'data1';
$data1->owner = 'alice';

$data2 = new \stdClass();
$data2->name = 'data2';
$data2->owner = 'bob';
然后使用决策器进行决策:

$e->enforce('alice', $data1, 'read');  // true
$e->enforce('alice', $data2, 'read');  // false

$e->enforce('bob', $data1, 'read');  // false
$e->enforce('bob', $data2, 'read');  // true
https://learnku.com/articles/33921
```
[Laravel-snappy 生成 PDF 踩坑记录](https://learnku.com/articles/25922?order_by=vote_count&)

[Laravel Ignition 错误页面功能全解析](https://learnku.com/laravel/t/33857#reply108464)

[PHP 7.4在线运行代码](https://php74-playground.baiguiren.com/?template=1)

[PC 端微信扫码支付全过程](https://learnku.com/articles/25760)

[PHP 高性能 Excel 扩展](https://github.com/viest/php-ext-excel-export)

[crontab 定时任务直观地编辑](https://crontab.guru/)


[接入 paypal PHP-sdk 支付宝支付 / 回调 / 退款全流程](https://learnku.com/articles/26282#replies)














